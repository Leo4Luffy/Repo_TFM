---
title: "Trabajo fin de máster"
author: "Jorge Leonardo López Martínez; Miguel Peréz Enciso"
output: html_document
---

```{r Fragmento general, include = FALSE}

knitr::opts_chunk$set(
  echo = FALSE,
  eval = FALSE,
  message = FALSE,
  warning = FALSE
  )
```

```{r Paquetes usados}

pacman::p_load(tidyverse, here, genio, BEDMatrix, tibble, purrr, pedigreemm, BGLR, lme4GS, scales, glue, patchwork, plotly, ggpubr, AGHmatrix, gt, ggrepel)
```

# 1. A continuación se crean diferentes subconjuntos de datos para cada población de arroz.

```{r Subconjuntos de datos de arroz}

Fenotipos <- read_delim(here('Datos', 'all.phenotypes.csv'), delim = ',')

# Población de arroz ADM ----

dir.create('../Datos/Datos_ADM')

Pob_ADM <- Fenotipos %>%
  filter(SNPsubsp == 'ADM') %>% # Conjunto de datos solo con la especie ADM.
  write_csv(here('Datos', 'Datos_ADM', 'Fen_ADM.csv')) %>%
  select(Variety) %>%
  separate(
    col = Variety,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  ' '
  ) %>%
  unite(
    col = Variety,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  mutate(Columna = Variety) %>%
  write_tsv(here('Datos', 'Datos_ADM', 'Ind_ADM.txt'), col_names = FALSE) # Este conjunto de datos se usara luego para extraer solo los individuos ADM del archivo de genotipos usando plink.

# Población de arroz Aro ----

dir.create('../Datos/Datos_ARO')

Pob_ARO <- Fenotipos %>%
  filter(SNPsubsp == 'ARO') %>% # Conjunto de datos solo con la especie ARO.
  write_csv(here('Datos', 'Datos_ARO', 'Fen_ARO.csv')) %>%
  select(Variety) %>%
  separate(
    col = Variety,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  ' '
  ) %>%
  unite(
    col = Variety,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  mutate(Columna = Variety) %>%
  write_tsv(here('Datos', 'Datos_ARO', 'Ind_ARO.txt'), col_names = FALSE) # Este conjunto de datos se usara luego para extraer solo los individuos ARO del archivo de genotipos usando plink.

# Población de arroz Aus ----

dir.create('../Datos/Datos_AUS')

Pob_AUS <- Fenotipos %>%
  filter(SNPsubsp == 'AUS') %>% # Conjunto de datos solo con la especie AUS.
  write_csv(here('Datos', 'Datos_AUS', 'Fen_AUS.csv')) %>%
  select(Variety) %>%
  separate(
    col = Variety,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  ' '
  ) %>%
  unite(
    col = Variety,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  mutate(Columna = Variety) %>%
  write_tsv(here('Datos', 'Datos_AUS', 'Ind_AUS.txt'), col_names = FALSE) # Este conjunto de datos se usara luego para extraer solo los individuos AUS del archivo de genotipos usando plink.

# Población de arroz Indica ----

dir.create('../Datos/Datos_IND')

Pob_IND <- Fenotipos %>%
  filter(SNPsubsp == 'IND') %>% # Conjunto de datos solo con la especie IND.
  write_csv(here('Datos', 'Datos_IND', 'Fen_IND.csv')) %>%
  select(Variety) %>%
  separate(
    col = Variety,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  ' '
  ) %>%
  unite(
    col = Variety,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  mutate(Columna = Variety) %>%
  write_tsv(here('Datos', 'Datos_IND', 'Ind_IND.txt'), col_names = FALSE) # Este conjunto de datos se usara luego para extraer solo los individuos IND del archivo de genotipos usando plink.

# Población de arroz Japonica ----

dir.create('../Datos/Datos_JAP')

Pob_JAP <- Fenotipos %>%
  filter(SNPsubsp == 'JAP') %>% # Conjunto de datos solo con la especie JAP.
  write_csv(here('Datos', 'Datos_JAP', 'Fen_JAP.csv')) %>%
  select(Variety) %>%
  separate(
    col = Variety,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  ' '
  ) %>%
  unite(
    col = Variety,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  mutate(Columna = Variety) %>%
  write_tsv(here('Datos', 'Datos_JAP', 'Ind_JAP.txt'), col_names = FALSE) # Este conjunto de datos se usara luego para extraer solo los individuos JAP del archivo de genotipos usando plink.
```

# 2. A continuación se edita el conjunto de datos de genotipos usando plink para simular la genealogía a partir del software molcoanc.

```{r Edición de los genotipos con plink}

#### NOTA: todo este fragmento a continuación lo ejecute en un archivo .R denominado Practica_plink dentro de la carpeta "Codigo" ----

#### Población de arroz ADM ----

dir.create('../Datos/Datos_ADM/Soft_Molcoanc')

# Se extrae del archivo de genotipos (snps.bed) solo los individuos que hacen parte de la población ADM ---
plink('--bfile snps --keep Datos_ADM/Ind.txt --make-bed --out Datos_ADM/Soft_Molcoanc/Ind_ADM') # El archivo con genotipo (snps) ya esta en formato binario (.bed), por lo que no fue necesario convertirlo a este formato (se sugiere convertir a formato binario ya que estos archivos de SNPs son muy grandes y su carga puede tomar tiempo, y para ahorrar espacio).

# Nota: Para cargar el archivo binario se uso --bfile en lugar del comando normalmente usado --file. Con --make-bed se indico crear de igual forma un archivo en formato binario llamado Ind_ADM donde se encuentra los archivos resultantes. Aquí se extrajeron solo los individuos indicados en Datos_ADM/Ind.txt, que corresponde a solo los individuos ADM. Con --out  Datos_ADM/Ind_ADM se indico guardar los resultados en la carpeta "Datos_ADM".

# Se filtra el archivo de genotipos anterior (Ind_ADM.bed) para eliminar los SNPs con MAF < 35% ----
plink('--bfile Datos_ADM/Soft_Molcoanc/Ind_ADM --maf 0.35 --make-bed --out Datos_ADM/Soft_Molcoanc/frec_0.35_ADM')

# Se seleccionan al azar 1000 marcadores (o SNPs) del archivo anteriormente creado (frec_0.35_ADM.bed) ----
plink('--bfile Datos_ADM/Soft_Molcoanc/frec_0.35_ADM --thin 0.0466243 --make-bed --out Datos_ADM/Soft_Molcoanc/nSNPs_ADM') # Se indica que el número de SNPs (variantes) ahora es de 1027 (aunque seguramente esto cambiara debido a que no se establecio una semilla como se hace en R) y el número de individuos ADM es de 29.

# Nota: Para seleccionar al azar los 1000 marcadores se uso -- thin y el valor de 0.0466243 se obtuvo mediante regla de tres (1000x100)/21448; 21448 corresponde a las 21448 veriantes que quedaron del paso anterior.

#### Población de arroz ARO ----

dir.create('../Datos/Datos_ARO/Soft_Molcoanc')

# Se extrae del archivo de genotipos (snps.bed) solo los individuos que hacen parte de la población ARO ---
plink('--bfile snps --keep Datos_ARO/Ind_ARO.txt --make-bed --out Datos_ARO/Soft_Molcoanc/Ind_ARO')

# Se filtra el archivo de genotipos anterior (Ind_ARO.bed) para eliminar los SNPs con MAF < 35% ----
plink('--bfile Datos_ARO/Soft_Molcoanc/Ind_ARO --maf 0.35 --make-bed --out Datos_ARO/Soft_Molcoanc/frec_0.35_ARO')

# Se seleccionan al azar 1000 marcadores (o SNPs) del archivo anteriormente creado (frec_0.35_ARO.bed) ----
plink('--bfile Datos_ARO/Soft_Molcoanc/frec_0.35_ARO --thin 0.0568085 --make-bed --out Datos_ARO/Soft_Molcoanc/nSNPs_ARO') # Se indica que el número de SNPs (variantes) ahora es de 1012 (aunque seguramente esto cambiara debido a que no se establecio una semilla como se hace en R) y el número de individuos ADM es de 17.

# Nota: El valor de 0.0568085 se obtuvo mediante regla de tres (1000x100)/17603; 17603 corresponde a las 17603 veriantes que quedaron del paso anterior.

#### Población de arroz AUS ----

dir.create('../Datos/Datos_AUS/Soft_Molcoanc')

# Se extrae del archivo de genotipos (snps.bed) solo los individuos que hacen parte de la población AUS ---
plink('--bfile snps --keep Datos_AUS/Ind_AUS.txt --make-bed --out Datos_AUS/Soft_Molcoanc/Ind_AUS')

# Se filtra el archivo de genotipos anterior (Ind_ARO.bed) para eliminar los SNPs con MAF < 35% ----
plink('--bfile Datos_AUS/Soft_Molcoanc/Ind_AUS --maf 0.35 --make-bed --out Datos_AUS/Soft_Molcoanc/frec_0.35_AUS')

# Se seleccionan al azar 1000 marcadores (o SNPs) del archivo anteriormente creado (frec_0.35_ARO.bed) ----
plink('--bfile Datos_AUS/Soft_Molcoanc/frec_0.35_AUS --thin 0.04989273 --make-bed --out Datos_AUS/Soft_Molcoanc/nSNPs_AUS') # Se indica que el número de SNPs (variantes) ahora es de 954 (aunque seguramente esto cambiara debido a que no se establecio una semilla como se hace en R) y el número de individuos AUS es de 75.

# Nota: El valor de 0.04989273 se obtuvo mediante regla de tres (1000x100)/20043; 20043 corresponde a las 20043 veriantes que quedaron del paso anterior.

#### Población de arroz IND ----

dir.create('../Datos/Datos_IND/Soft_Molcoanc')

# Se extrae del archivo de genotipos (snps.bed) solo los individuos que hacen parte de la población IND ---
plink('--bfile snps --keep Datos_IND/Ind_IND.txt --make-bed --out Datos_IND/Soft_Molcoanc/Ind_IND')

# Se filtra el archivo de genotipos anterior (Ind_IND.bed) para eliminar los SNPs con MAF < 5% ----
plink('--bfile Datos_IND/Soft_Molcoanc/Ind_IND --maf 0.05 --make-bed --out Datos_IND/Soft_Molcoanc/frec_0.05_IND')

# Se seleccionan al azar 1000 marcadores (o SNPs) del archivo anteriormente creado (frec_0.05_IND.bed) ----
plink('--bfile Datos_IND/Soft_Molcoanc/frec_0.05_IND --thin 0.009976953 --make-bed --out Datos_IND/Soft_Molcoanc/nSNPs_IND') # Se indica que el número de SNPs (variantes) ahora es de 1089 (aunque seguramente esto cambiara debido a que no se establecio una semilla como se hace en R) y el número de individuos IND es de 451.

# Nota: El valor de 0.009976953 se obtuvo mediante regla de tres (1000x100)/100231, y luego dividir entre 100; 100231 corresponde a las 100231 veriantes que quedaron del paso anterior.

#### Población de arroz JAP ----

dir.create('../Datos/Datos_JAP/Soft_Molcoanc')

# Se extrae del archivo de genotipos (snps.bed) solo los individuos que hacen parte de la población JAP ---
plink('--bfile snps --keep Datos_JAP/Ind_JAP.txt --make-bed --out Datos_JAP/Soft_Molcoanc/Ind_JAP')

# Se filtra el archivo de genotipos anterior (Ind_JAP.bed) para eliminar los SNPs con MAF < 35% ----
plink('--bfile Datos_JAP/Soft_Molcoanc/Ind_JAP --maf 0.35 --make-bed --out Datos_JAP/Soft_Molcoanc/frec_0.35_JAP')

# Se seleccionan al azar 1000 marcadores (o SNPs) del archivo anteriormente creado (frec_0.35_JAP.bed) ----
plink('--bfile Datos_JAP/Soft_Molcoanc/frec_0.35_JAP --thin 0.08162599 --make-bed --out Datos_JAP/Soft_Molcoanc/nSNPs_JAP') # Se indica que el número de SNPs (variantes) ahora es de 1005 (aunque seguramente esto cambiara debido a que no se establecio una semilla como se hace en R) y el número de individuos JAP es de 166.

# Nota: El valor de 0.08162599 se obtuvo mediante regla de tres (1000x100)/12251; 12251 corresponde a las 12251 veriantes que quedaron del paso anterior.
```

# 3. A continuación se importan los archivos anteriormente creados .bim, .fam y .bed., y se exporta un conjuntos de datos para cada población de arroz para usarse en el software molcoanc.

```{r Conjuntos de datos genotípicos para usar el software molcoanc}

# Nota: Algo muy importante que se debe saber es que para poder leer este tipo de archivos hay que leerlos todos juntos (bed, fam, bim), y una vez importados en R se pueden procesar cada uno por separado, como se quiera.

# Población de arroz ADM ----

bimsnps_ADM <- read_bim(here('Datos', 'Datos_ADM', 'Soft_Molcoanc', 'nSNPs_ADM.bim'))
famsnps_ADM <- read_fam(here('Datos', 'Datos_ADM', 'Soft_Molcoanc', 'nSNPs_ADM.fam'))
bedsnps_ADM <- BEDMatrix(here('Datos', 'Datos_ADM', 'Soft_Molcoanc', 'nSNPs_ADM.bed'), n = length(famsnps_ADM$id), p = length(bimsnps_ADM$id), simple_names = FALSE)
snps_ADM <- as.matrix(bedsnps_ADM)

snps_ADM <- as_tibble(snps_ADM) %>%
  mutate_all(
    funs(case_when(
      . == 0 ~ '1/1',
      . == 1 ~ '1/2',
      . == 2 ~ '2/2'
      ))
  ) %>%
  rowid_to_column(var = 'id') # Se creo una columna de "id".

f_ADM <- function(x) { # Función que separa una columna determinada del conjunto de datos inicial.
  snps_ADM %>%
    select_('id', x) %>%
    separate_(x, paste0(x, c('.1', '.2'))) 
  }

dir.create('../Datos/Datos_ADM/Soft_Molcoanc/Molcoanc')

snps_ADM <- names(snps_ADM)[2:ncol(snps_ADM)] %>% # Se da el indice de las columnas que se desean separar.
  map(f_ADM) %>% # Se aplica la función anterior a cada columna (se crea una lista de conjuntos de datos).
  reduce(left_join, by = 'id') %>% # Se unen los conjuntos de datos de forma iterativa.
  select(-id) %>%
  write_tsv(here('Datos', 'Datos_ADM', 'Soft_Molcoanc', 'Molcoanc', 'ADM.txt'), col_names = FALSE) # Este conjunto de datos se usara para inferir la genealogía de los individuos ADM usando molcoanc.

n_alelos_ADM <- rep.int(x = 2, times = 980) %>%
  t() %>%
  as_tibble() %>%
  write_tsv(here('Datos', 'Datos_ADM', 'Soft_Molcoanc', 'Molcoanc', 'n_alelos_ADM.txt'), col_names = FALSE) # Este sería el número de alelos por locus (2 alelos para los 980 locis).

# Población de arroz ARO ----

bimsnps_ARO <- read_bim(here('Datos', 'Datos_ARO', 'Soft_Molcoanc', 'nSNPs_ARO.bim'))
famsnps_ARO <- read_fam(here('Datos', 'Datos_ARO', 'Soft_Molcoanc', 'nSNPs_ARO.fam'))
bedsnps_ARO <- BEDMatrix(here('Datos', 'Datos_ARO', 'Soft_Molcoanc', 'nSNPs_ARO.bed'), n = length(famsnps_ARO$id), p = length(bimsnps_ARO$id), simple_names = FALSE)
snps_ARO <- as.matrix(bedsnps_ARO)

snps_ARO <- as_tibble(snps_ARO) %>%
  mutate_all(
    funs(case_when(
      . == 0 ~ '1/1',
      . == 1 ~ '1/2',
      . == 2 ~ '2/2'
      ))
  ) %>%
  rowid_to_column(var = 'id') # Se creo una columna de "id".

f_ARO <- function(x) { # Función que separa una columna determinada del conjunto de datos inicial.
  snps_ARO %>%
    select_('id', x) %>%
    separate_(x, paste0(x, c('.1', '.2'))) 
  }

dir.create('../Datos/Datos_ARO/Soft_Molcoanc/Molcoanc')

snps_ARO <- names(snps_ARO)[2:ncol(snps_ARO)] %>% # Se da el indice de las columnas que se desean separar.
  map(f_ARO) %>% # Se aplica la función anterior a cada columna (se crea una lista de conjuntos de datos).
  reduce(left_join, by = 'id') %>% # Se unen los conjuntos de datos de forma iterativa.
  select(-id) %>%
  write_tsv(here('Datos', 'Datos_ARO', 'Soft_Molcoanc', 'Molcoanc', 'ARO.txt'), col_names = FALSE) # Este conjunto de datos se usara para inferir la genealogía de los individuos ADM usando molcoanc.

n_alelos_ARO <- rep.int(x = 2, times = 1012) %>%
  t() %>%
  as_tibble() %>%
  write_tsv(here('Datos', 'Datos_ARO', 'Soft_Molcoanc', 'Molcoanc', 'n_alelos_ARO.txt'), col_names = FALSE) # Este sería el número de alelos por locus (2 alelos para los 1012 locis).

# Población de arroz AUS ----

bimsnps_AUS <- read_bim(here('Datos', 'Datos_AUS', 'Soft_Molcoanc', 'nSNPs_AUS.bim'))
famsnps_AUS <- read_fam(here('Datos', 'Datos_AUS', 'Soft_Molcoanc', 'nSNPs_AUS.fam'))
bedsnps_AUS <- BEDMatrix(here('Datos', 'Datos_AUS', 'Soft_Molcoanc', 'nSNPs_AUS.bed'), n = length(famsnps_AUS$id), p = length(bimsnps_AUS$id), simple_names = FALSE)
snps_AUS <- as.matrix(bedsnps_AUS)

snps_AUS <- as_tibble(snps_AUS) %>%
  mutate_all(
    funs(case_when(
      . == 0 ~ '1/1',
      . == 1 ~ '1/2',
      . == 2 ~ '2/2'
      ))
  ) %>%
  rowid_to_column(var = 'id') # Se creo una columna de "id".

f_AUS <- function(x) { # Función que separa una columna determinada del conjunto de datos inicial.
  snps_AUS %>%
    select_('id', x) %>%
    separate_(x, paste0(x, c('.1', '.2'))) 
  }

dir.create('../Datos/Datos_AUS/Soft_Molcoanc/Molcoanc')

snps_AUS <- names(snps_AUS)[2:ncol(snps_AUS)] %>% # Se da el indice de las columnas que se desean separar.
  map(f_AUS) %>% # Se aplica la función anterior a cada columna (se crea una lista de conjuntos de datos).
  reduce(left_join, by = 'id') %>% # Se unen los conjuntos de datos de forma iterativa.
  select(-id) %>%
  write_tsv(here('Datos', 'Datos_AUS', 'Soft_Molcoanc', 'Molcoanc', 'AUS.txt'), col_names = FALSE) # Este conjunto de datos se usara para inferir la genealogía de los individuos ADM usando molcoanc.

n_alelos_AUS <- rep.int(x = 2, times = 954) %>%
  t() %>%
  as_tibble() %>%
  write_tsv(here('Datos', 'Datos_AUS', 'Soft_Molcoanc', 'Molcoanc', 'n_alelos_AUS.txt'), col_names = FALSE) # Este sería el número de alelos por locus (2 alelos para los 954 locis).

# Población de arroz IND ----

bimsnps_IND <- read_bim(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'frec_0.05_IND.bim'))
famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'frec_0.05_IND.fam'))
bedsnps_IND <- BEDMatrix(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'frec_0.05_IND.bed'), n = length(famsnps_IND$id), p = length(bimsnps_IND$id), simple_names = FALSE)
snps_IND <- as.matrix(bedsnps_IND)

snps_IND <- as_tibble(snps_IND) %>%
  mutate_all(
    funs(case_when(
      . == 0 ~ '1/1',
      . == 1 ~ '1/2',
      . == 2 ~ '2/2'
      ))
  ) %>%
  rowid_to_column(var = 'id') # Se creo una columna de "id".

f_IND <- function(x) { # Función que separa una columna determinada del conjunto de datos inicial.
  snps_IND %>%
    select_('id', x) %>%
    separate_(x, paste0(x, c('.1', '.2'))) 
  }

dir.create('../Datos/Datos_IND/Soft_Molcoanc/Molcoanc')

snps_IND <- names(snps_IND)[2:ncol(snps_IND)] %>% # Se da el indice de las columnas que se desean separar.
  map(f_IND) %>% # Se aplica la función anterior a cada columna (se crea una lista de conjuntos de datos).
  reduce(left_join, by = 'id') %>% # Se unen los conjuntos de datos de forma iterativa.
  select(-id) %>%
  write_tsv(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'Molcoanc', 'IND.txt'), col_names = FALSE) # Este conjunto de datos se usara para inferir la genealogía de los individuos IND usando molcoanc.

# Nota: al cambiar de aproximadamente 1.000 SNPs a 10.000 SNPs, el proceso con la función anterior tomo mucho tiempo. Debido a esto, use el siguiente código para hacer lo mismo en menos tiempo.

snps_IND <- names(snps_IND) %>%
  map(
    function(x)
      snps_IND %>%
      select(x) %>% 
      separate(x, 
               into = paste0(x, c('_SNP1', '_SNP2')), 
               sep = '/')
    ) %>%
  bind_cols() %>%
  select(-c(1:2)) %>%
  write_tsv(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'Molcoanc', 'IND.txt'), col_names = FALSE) # Este conjunto de datos se usara para inferir la genealogía de los individuos IND usando molcoanc.

n_alelos_IND <- rep.int(x = 2, times = 100231) %>%
  t() %>%
  as_tibble() %>%
    write_tsv(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'Molcoanc', 'n_alelos_IND.txt'), col_names = FALSE) # Este sería el número de alelos por locus (2 alelos para los 10021 locis).

# Población de arroz JAP ----

bimsnps_JAP <- read_bim(here('Datos', 'Datos_JAP', 'Soft_Molcoanc', 'nSNPs_JAP.bim'))
famsnps_JAP <- read_fam(here('Datos', 'Datos_JAP', 'Soft_Molcoanc', 'nSNPs_JAP.fam'))
bedsnps_JAP <- BEDMatrix(here('Datos', 'Datos_JAP', 'Soft_Molcoanc', 'nSNPs_JAP.bed'), n = length(famsnps_JAP$id), p = length(bimsnps_JAP$id), simple_names = FALSE)
snps_JAP <- as.matrix(bedsnps_JAP)

snps_JAP <- as_tibble(snps_JAP) %>%
  mutate_all(
    funs(case_when(
      . == 0 ~ '1/1',
      . == 1 ~ '1/2',
      . == 2 ~ '2/2'
      ))
  ) %>%
  rowid_to_column(var = 'id') # Se creo una columna de "id".

f_JAP <- function(x) { # Función que separa una columna determinada del conjunto de datos inicial.
  snps_JAP %>%
    select_('id', x) %>%
    separate_(x, paste0(x, c('.1', '.2'))) 
  }

dir.create('../Datos/Datos_JAP/Soft_Molcoanc/Molcoanc')

snps_JAP <- names(snps_JAP)[2:ncol(snps_JAP)] %>% # Se da el indice de las columnas que se desean separar.
  map(f_JAP) %>% # Se aplica la función anterior a cada columna (se crea una lista de conjuntos de datos).
  reduce(left_join, by = 'id') %>% # Se unen los conjuntos de datos de forma iterativa.
  select(-id) %>%
  write_tsv(here('Datos', 'Datos_JAP', 'Soft_Molcoanc', 'Molcoanc', 'JAP.txt'), col_names = FALSE) # Este conjunto de datos se usara para inferir la genealogía de los individuos ADM usando molcoanc.

n_alelos_JAP <- rep.int(x = 2, times = 1005) %>%
  t() %>%
  as_tibble() %>%
  write_tsv(here('Datos', 'Datos_JAP', 'Soft_Molcoanc', 'Molcoanc', 'n_alelos_JAP.txt'), col_names = FALSE) # Este sería el número de alelos por locus (2 alelos para los 1005 locis).
```

# 4. A continuación se crean los dos conjuntos de datos que se usaran como población de validación cruzada (los individuos mejorados) y de entrenamiento (los individuos sin mejorar).

```{r Subpoblaciones de individuos genotipados}

# 1. Se importan las bases de datos de fenotipo y de linea mejorada.

Fenotipos <- read_delim(here('Datos', 'all.phenotypes.csv'), delim = ',')
lin_mej <- read_delim(here('Datos', 'iris_pedigree.csv'), delim = ',')

Fenotipos %>%
  count(SNPsubsp) # Se ve que son en total cinco subespecies: ADM, ARO, AUS, IND y JAP. Luego nos quedamos con las tres de mayor número de individuos (IND con 451, JAP con 166 y AUS con 75).

#### Población de arroz IND (100.000 SNPs) ----

dir.create('../Datos/Datos_IND/Den_100.000') # Se crea una carpeta donde se guardaran los resultados considerando una densidas de 100.000 SNPs.

dir.create('../Datos/Datos_IND/Den_100.000/mG') # Se crea una carpeta que contendra las subpoblaciones de individuos genotipados que se crearan.

# 2. Se crea un conjunto de datos que contiene solo los individuos mejorados.

Pob_mej <- lin_mej %>%
  filter(Status_with_Pedigree.plus.knowledge == 'I') %>% # Conjunto de datos solo con los individuos mejorados (los que se clasificaron como "I").
  select(X3K_DNA_IRIS_UNIQUE_ID) %>%
  rename(Variety = X3K_DNA_IRIS_UNIQUE_ID)

Pob_IND <- Fenotipos %>%
  filter(SNPsubsp == 'IND') %>% # Conjunto de datos solo con la especie IND.
  mutate(Variety_2 = Variety) %>%
  separate(
    col = Variety,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  ' '
  ) %>%
  unite(
    col = Variety,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  separate(
    col = Variety,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  '-'
  ) %>%
  unite(
    col = Variety,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  separate(
    col = Variety_2,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  ' '
  ) %>%
  unite(
    col = Variety_2,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  inner_join(y = Pob_mej, by = 'Variety') %>%
  select(Variety_2) %>% # Se creo el conjunto de datos con los individuos mejorados de la población indica.
  rename(Variety = Variety_2)

# 3. Se crea un conjunto de datos que no contiene los individuos mejorados.

Pob_IND_2 <- Fenotipos %>%
  filter(SNPsubsp == 'IND') %>% # Conjunto de datos solo con la especie IND.
  mutate(Variety_2 = Variety) %>%
  separate(
    col = Variety,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  ' '
  ) %>%
  unite(
    col = Variety,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  separate(
    col = Variety,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  '-'
  ) %>%
  unite(
    col = Variety,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  separate(
    col = Variety_2,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  ' '
  ) %>%
  unite(
    col = Variety_2,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  anti_join(Pob_mej, by = 'Variety') %>%
  select(Variety_2) %>% # Se creo el conjunto de datos con los individuos no mejorados de la población indica.
  rename(Variety = Variety_2)

# 4. Del conjunto de datos con los individuos no mejorados, se extrae de forma aleatoria diferentes subconjuntos de datos con diferentes cantidades de individuos genotipados.

n_muestras <- c(50, 100, 150, 200, 250, 300, 350, 403) # Se generan 8 muestras con distintas cantidades de individuos genotipados.

subpob_IND <- lapply(X = n_muestras, FUN = function(x) sample_n(tbl = Pob_IND_2, size = x, replace = FALSE)) # Usando la función lapply se aplica el vector "n_muestras" sobre los datos de los individuos no mejorados (Pob_IND_2), indicando la cantidad de muestras deseadas; luego se crea una lista de tibbles que contiene los individuos genotipados de la población indica no mejorada en diferentes cantidades.

dir.create('../Datos/Datos_IND/Den_100.000/mG/mG_1') # Se crea una carpeta que contendra los 50 primeros individuos genotipados.

subpob_IND %>%
  pluck(1) %>% # Se extae el primer elemento de la lista "subpob_IND", que correponde a los 50 individuos genotipados.
  bind_rows(Pob_IND) %>% # Se unen los 50 individuos genotipados no mejorados con los 48 indiviuos genotipados mejorados.
  mutate(Columna = Variety) %>%
  write_tsv(here('Datos', 'Datos_IND', 'Den_100.000', 'mG', 'mG_1', 'subpob_IND.txt'), col_names = FALSE) # Este conjunto de datos contiene 50 + 48 = 98 individuos de los 451 individuos genotipados.

dir.create('../Datos/Datos_IND/Den_100.000/mG/mG_2')

subpob_IND %>%
  pluck(2) %>%
  bind_rows(Pob_IND) %>% # Se unen los 100 individuos genotipados no mejorados con los 48 indiviuos genotipados mejorados.
  mutate(Columna = Variety) %>%
  write_tsv(here('Datos', 'Datos_IND', 'Den_100.000', 'mG', 'mG_2', 'subpob_IND.txt'), col_names = FALSE) # Este conjunto de datos contiene 100 + 48 = 148 individuos de los 451 individuos genotipados.

dir.create('../Datos/Datos_IND/Den_100.000/mG/mG_3')

subpob_IND %>%
  pluck(3) %>%
  bind_rows(Pob_IND) %>% # Se unen los 150 individuos genotipados no mejorados con los 48 indiviuos genotipados mejorados.
  mutate(Columna = Variety) %>%
  write_tsv(here('Datos', 'Datos_IND', 'Den_100.000', 'mG', 'mG_3', 'subpob_IND.txt'), col_names = FALSE) # Este conjunto de datos contiene 150 + 48 = 198 individuos de los 451 individuos genotipados.

dir.create('../Datos/Datos_IND/Den_100.000/mG/mG_4')

subpob_IND %>%
  pluck(4) %>%
  bind_rows(Pob_IND) %>% # Se unen los 200 individuos genotipados no mejorados con los 48 indiviuos genotipados mejorados.
  mutate(Columna = Variety) %>%
  write_tsv(here('Datos', 'Datos_IND', 'Den_100.000', 'mG', 'mG_4', 'subpob_IND.txt'), col_names = FALSE) # Este conjunto de datos contiene 200 + 48 = 248 individuos de los 451 individuos genotipados.

dir.create('../Datos/Datos_IND/Den_100.000/mG/mG_5')

subpob_IND %>%
  pluck(5) %>%
  bind_rows(Pob_IND) %>% # Se unen los 250 individuos genotipados no mejorados con los 48 indiviuos genotipados mejorados.
  mutate(Columna = Variety) %>%
  write_tsv(here('Datos', 'Datos_IND', 'Den_100.000', 'mG', 'mG_5', 'subpob_IND.txt'), col_names = FALSE) # Este conjunto de datos contiene 250 + 48 = 298 individuos de los 451 individuos genotipados.

dir.create('../Datos/Datos_IND/Den_100.000/mG/mG_6')

subpob_IND %>%
  pluck(6) %>%
  bind_rows(Pob_IND) %>% # Se unen los 300 individuos genotipados no mejorados con los 48 indiviuos genotipados mejorados.
  mutate(Columna = Variety) %>%
  write_tsv(here('Datos', 'Datos_IND', 'Den_100.000', 'mG', 'mG_6', 'subpob_IND.txt'), col_names = FALSE) # Este conjunto de datos contiene 300 + 48 = 348 individuos de los 451 individuos genotipados.

dir.create('../Datos/Datos_IND/Den_100.000/mG/mG_7')

subpob_IND %>%
  pluck(7) %>%
  bind_rows(Pob_IND) %>% # Se unen los 350 individuos genotipados no mejorados con los 48 indiviuos genotipados mejorados.
  mutate(Columna = Variety) %>%
  write_tsv(here('Datos', 'Datos_IND', 'Den_100.000', 'mG', 'mG_7', 'subpob_IND.txt'), col_names = FALSE) # Este conjunto de datos contiene 350 + 48 = 398 individuos de los 451 individuos genotipados.

dir.create('../Datos/Datos_IND/Den_100.000/mG/mG_8')

subpob_IND %>%
  pluck(8) %>%
  bind_rows(Pob_IND) %>% # Se unen los 403 individuos genotipados no mejorados con los 48 indiviuos genotipados mejorados.
  mutate(Columna = Variety) %>%
  write_tsv(here('Datos', 'Datos_IND', 'Den_100.000', 'mG', 'mG_8', 'subpob_IND.txt'), col_names = FALSE) # Este conjunto de datos contiene 403 + 48 = 451 de los 451 individuos genotipados.

#### Población de arroz JAP ----

dir.create('../Datos/Datos_JAP/mG') # Se crea una carpeta que contendra las subpoblaciones de individuos genotipados que se crearan.

# 2. Se crea un conjunto de datos que contiene solo los individuos mejorados.

Pob_mej <- lin_mej %>%
  filter(Status_with_Pedigree.plus.knowledge == 'I') %>% # Conjunto de datos solo con los individuos mejorados (los que se clasificaron como "I").
  select(X3K_DNA_IRIS_UNIQUE_ID) %>%
  rename(Variety = X3K_DNA_IRIS_UNIQUE_ID)

Pob_JAP <- Fenotipos %>%
  filter(SNPsubsp == 'JAP') %>% # Conjunto de datos solo con la especie JAP.
  mutate(Variety_2 = Variety) %>%
  separate(
    col = Variety,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  ' '
  ) %>%
  unite(
    col = Variety,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  separate(
    col = Variety,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  '-'
  ) %>%
  unite(
    col = Variety,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  separate(
    col = Variety_2,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  ' '
  ) %>%
  unite(
    col = Variety_2,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  inner_join(y = Pob_mej, by = 'Variety') %>%
  select(Variety_2) %>% # Se creo el conjunto de datos con los individuos mejorados de la población japonica.
  rename(Variety = Variety_2)

# 3. Se crea un conjunto de datos que no contiene los individuos mejorados.

Pob_JAP_2 <- Fenotipos %>%
  filter(SNPsubsp == 'JAP') %>% # Conjunto de datos solo con la especie JAP.
  mutate(Variety_2 = Variety) %>%
  separate(
    col = Variety,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  ' '
  ) %>%
  unite(
    col = Variety,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  separate(
    col = Variety,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  '-'
  ) %>%
  unite(
    col = Variety,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  separate(
    col = Variety_2,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  ' '
  ) %>%
  unite(
    col = Variety_2,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  anti_join(Pob_mej, by = 'Variety') %>%
  select(Variety_2) %>% # Se creo el conjunto de datos con los individuos no mejorados de la población japonica.
  rename(Variety = Variety_2)

# 4. Del conjunto de datos con los individuos no mejorados, se extrae de forma aleatoria diferentes subconjuntos de datos con diferentes cantidades de individuos genotipados.

n_muestras <- c(17, 34, 51, 68, 85, 102, 119, 142) # Se generan 8 muestras con distintas cantidades de individuos genotipados.

subpob_JAP <- lapply(X = n_muestras, FUN = function(x) sample_n(tbl = Pob_JAP_2, size = x, replace = FALSE))

dir.create('../Datos/Datos_JAP/mG/mG_1')

subpob_JAP %>%
  pluck(1) %>% # Se extae el primer elemento de la lista "subpob_JAP", que correponde a los 17 individuos genotipados.
  bind_rows(Pob_JAP) %>% # Se unen los 17 individuos genotipados no mejorados con los 24 indiviuos genotipados mejorados.
  mutate(Columna = Variety) %>%
  write_tsv(here('Datos', 'Datos_JAP', 'mG', 'mG_1', 'subpob_JAP.txt'), col_names = FALSE) # Este conjunto de datos contiene 17 + 24 = 41 individuos de los 166 individuos genotipados.

dir.create('../Datos/Datos_JAP/mG/mG_2')

subpob_JAP %>%
  pluck(2) %>%
  bind_rows(Pob_JAP) %>% # Se unen los 34 individuos genotipados no mejorados con los 24 indiviuos genotipados mejorados.
  mutate(Columna = Variety) %>%
  write_tsv(here('Datos', 'Datos_JAP', 'mG', 'mG_2', 'subpob_JAP.txt'), col_names = FALSE) # Este conjunto de datos contiene 34 + 24 = 58 individuos de los 166 individuos genotipados.

dir.create('../Datos/Datos_JAP/mG/mG_3')

subpob_JAP %>%
  pluck(3) %>%
  bind_rows(Pob_JAP) %>% # Se unen los 51 individuos genotipados no mejorados con los 24 indiviuos genotipados mejorados.
  mutate(Columna = Variety) %>%
  write_tsv(here('Datos', 'Datos_JAP', 'mG', 'mG_3', 'subpob_JAP.txt'), col_names = FALSE) # Este conjunto de datos contiene 51 + 24 = 75 individuos de los 166 individuos genotipados.

dir.create('../Datos/Datos_JAP/mG/mG_4')

subpob_JAP %>%
  pluck(4) %>%
  bind_rows(Pob_JAP) %>% # Se unen los 68 individuos genotipados no mejorados con los 24 indiviuos genotipados mejorados.
  mutate(Columna = Variety) %>%
  write_tsv(here('Datos', 'Datos_JAP', 'mG', 'mG_4', 'subpob_JAP.txt'), col_names = FALSE) # Este conjunto de datos contiene 68 + 24 = 92 individuos de los 166 individuos genotipados.

dir.create('../Datos/Datos_JAP/mG/mG_5')

subpob_JAP %>%
  pluck(5) %>%
  bind_rows(Pob_JAP) %>% # Se unen los 85 individuos genotipados no mejorados con los 24 indiviuos genotipados mejorados.
  mutate(Columna = Variety) %>%
  write_tsv(here('Datos', 'Datos_JAP', 'mG', 'mG_5', 'subpob_JAP.txt'), col_names = FALSE) # Este conjunto de datos contiene 85 + 24 = 109 individuos de los 166 individuos genotipados.

dir.create('../Datos/Datos_JAP/mG/mG_6')

subpob_JAP %>%
  pluck(6) %>%
  bind_rows(Pob_JAP) %>% # Se unen los 102 individuos genotipados no mejorados con los 24 indiviuos genotipados mejorados.
  mutate(Columna = Variety) %>%
  write_tsv(here('Datos', 'Datos_JAP', 'mG', 'mG_6', 'subpob_JAP.txt'), col_names = FALSE) # Este conjunto de datos contiene 102 + 24 = 126 individuos de los 166 individuos genotipados.

dir.create('../Datos/Datos_JAP/mG/mG_7')

subpob_JAP %>%
  pluck(7) %>%
  bind_rows(Pob_JAP) %>% # Se unen los 119 individuos genotipados no mejorados con los 24 indiviuos genotipados mejorados.
  mutate(Columna = Variety) %>%
  write_tsv(here('Datos', 'Datos_JAP', 'mG', 'mG_7', 'subpob_JAP.txt'), col_names = FALSE) # Este conjunto de datos contiene 119 + 24 = 143 individuos de los 166 individuos genotipados.

dir.create('../Datos/Datos_JAP/mG/mG_8')

subpob_JAP %>%
  pluck(8) %>%
  bind_rows(Pob_JAP) %>% # Se unen los 142 individuos genotipados no mejorados con los 24 indiviuos genotipados mejorados.
  mutate(Columna = Variety) %>%
  write_tsv(here('Datos', 'Datos_JAP', 'mG', 'mG_8', 'subpob_JAP.txt'), col_names = FALSE) # Este conjunto de datos contiene 142 + 24 = 166 individuos de los 166 individuos genotipados.

#### Población de arroz AUS ----

dir.create('../Datos/Datos_AUS/mG') # Se crea una carpeta que contendra las subpoblaciones de individuos genotipados que se crearan.

# 2. Se crea un conjunto de datos que contiene solo los individuos mejorados.

Pob_mej <- lin_mej %>%
  filter(Status_with_Pedigree.plus.knowledge == 'I') %>% # Conjunto de datos solo con los individuos mejorados (los que se clasificaron como "I").
  select(X3K_DNA_IRIS_UNIQUE_ID) %>%
  rename(Variety = X3K_DNA_IRIS_UNIQUE_ID)

Pob_AUS <- Fenotipos %>%
  filter(SNPsubsp == 'AUS') %>% # Conjunto de datos solo con la especie AUS.
  mutate(Variety_2 = Variety) %>%
  separate(
    col = Variety,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  ' '
  ) %>%
  unite(
    col = Variety,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  separate(
    col = Variety,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  '-'
  ) %>%
  unite(
    col = Variety,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  separate(
    col = Variety_2,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  ' '
  ) %>%
  unite(
    col = Variety_2,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  inner_join(y = Pob_mej, by = 'Variety') %>%
  select(Variety_2) %>% # Se creo el conjunto de datos con los individuos mejorados de la población AUS.
  rename(Variety = Variety_2)

# 3. Se crea un conjunto de datos que no contiene los individuos mejorados.

Pob_AUS_2 <- Fenotipos %>%
  filter(SNPsubsp == 'AUS') %>% # Conjunto de datos solo con la especie AUS.
  mutate(Variety_2 = Variety) %>%
  separate(
    col = Variety,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  ' '
  ) %>%
  unite(
    col = Variety,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  separate(
    col = Variety,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  '-'
  ) %>%
  unite(
    col = Variety,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  separate(
    col = Variety_2,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  ' '
  ) %>%
  unite(
    col = Variety_2,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  anti_join(Pob_mej, by = 'Variety') %>%
  select(Variety_2) %>% # Se creo el conjunto de datos con los individuos no mejorados de la población AUS.
  rename(Variety = Variety_2)

# 4. Del conjunto de datos con los individuos no mejorados, se extrae de forma aleatoria diferentes subconjuntos de datos con diferentes cantidades de individuos genotipados.

n_muestras <- c(9, 18, 27, 36, 45, 54, 63, 74) # Se generan 8 muestras con distintas cantidades de individuos genotipados.

subpob_AUS <- lapply(X = n_muestras, FUN = function(x) sample_n(tbl = Pob_AUS_2, size = x, replace = FALSE))

dir.create('../Datos/Datos_AUS/mG/mG_1')

subpob_AUS %>%
  pluck(1) %>% # Se extae el primer elemento de la lista "subpob_AUS", que correponde a los 9 individuos genotipados.
  bind_rows(Pob_AUS) %>% # Se unen los 9 individuos genotipados no mejorados con el 1 indiviuo genotipado mejorado.
  mutate(Columna = Variety) %>%
  write_tsv(here('Datos', 'Datos_AUS', 'mG', 'mG_1', 'subpob_AUS.txt'), col_names = FALSE) # Este conjunto de datos contiene 9 + 1 = 10 individuos de los 75 individuos genotipados.

dir.create('../Datos/Datos_AUS/mG/mG_2')

subpob_AUS %>%
  pluck(2) %>% # Se extae el primer elemento de la lista "subpob_AUS", que correponde a los 18 individuos genotipados.
  bind_rows(Pob_AUS) %>% # Se unen los 18 individuos genotipados no mejorados con el 1 indiviuo genotipado mejorado.
  mutate(Columna = Variety) %>%
  write_tsv(here('Datos', 'Datos_AUS', 'mG', 'mG_2', 'subpob_AUS.txt'), col_names = FALSE) # Este conjunto de datos contiene 18 + 1 = 19 individuos de los 75 individuos genotipados.

dir.create('../Datos/Datos_AUS/mG/mG_3')

subpob_AUS %>%
  pluck(3) %>% # Se extae el primer elemento de la lista "subpob_AUS", que correponde a los 27 individuos genotipados.
  bind_rows(Pob_AUS) %>% # Se unen los 27 individuos genotipados no mejorados con el 1 indiviuo genotipado mejorado.
  mutate(Columna = Variety) %>%
  write_tsv(here('Datos', 'Datos_AUS', 'mG', 'mG_3', 'subpob_AUS.txt'), col_names = FALSE) # Este conjunto de datos contiene 27 + 1 = 28 individuos de los 75 individuos genotipados.

dir.create('../Datos/Datos_AUS/mG/mG_4')

subpob_AUS %>%
  pluck(4) %>% # Se extae el primer elemento de la lista "subpob_AUS", que correponde a los 36 individuos genotipados.
  bind_rows(Pob_AUS) %>% # Se unen los 36 individuos genotipados no mejorados con el 1 indiviuo genotipado mejorado.
  mutate(Columna = Variety) %>%
  write_tsv(here('Datos', 'Datos_AUS', 'mG', 'mG_4', 'subpob_AUS.txt'), col_names = FALSE) # Este conjunto de datos contiene 36 + 1 = 37 individuos de los 75 individuos genotipados.

dir.create('../Datos/Datos_AUS/mG/mG_5')

subpob_AUS %>%
  pluck(5) %>% # Se extae el primer elemento de la lista "subpob_AUS", que correponde a los 45 individuos genotipados.
  bind_rows(Pob_AUS) %>% # Se unen los 45 individuos genotipados no mejorados con el 1 indiviuo genotipado mejorado.
  mutate(Columna = Variety) %>%
  write_tsv(here('Datos', 'Datos_AUS', 'mG', 'mG_5', 'subpob_AUS.txt'), col_names = FALSE) # Este conjunto de datos contiene 45 + 1 = 46 individuos de los 75 individuos genotipados.

dir.create('../Datos/Datos_AUS/mG/mG_6')

subpob_AUS %>%
  pluck(6) %>% # Se extae el primer elemento de la lista "subpob_AUS", que correponde a los 54 individuos genotipados.
  bind_rows(Pob_AUS) %>% # Se unen los 54 individuos genotipados no mejorados con el 1 indiviuo genotipado mejorado.
  mutate(Columna = Variety) %>%
  write_tsv(here('Datos', 'Datos_AUS', 'mG', 'mG_6', 'subpob_AUS.txt'), col_names = FALSE) # Este conjunto de datos contiene 54 + 1 = 55 individuos de los 75 individuos genotipados.

dir.create('../Datos/Datos_AUS/mG/mG_7')

subpob_AUS %>%
  pluck(7) %>% # Se extae el primer elemento de la lista "subpob_AUS", que correponde a los 63 individuos genotipados.
  bind_rows(Pob_AUS) %>% # Se unen los 63 individuos genotipados no mejorados con el 1 indiviuo genotipado mejorado.
  mutate(Columna = Variety) %>%
  write_tsv(here('Datos', 'Datos_AUS', 'mG', 'mG_7', 'subpob_AUS.txt'), col_names = FALSE) # Este conjunto de datos contiene 63 + 1 = 64 individuos de los 75 individuos genotipados.

dir.create('../Datos/Datos_AUS/mG/mG_8')

subpob_AUS %>%
  pluck(8) %>% # Se extae el primer elemento de la lista "subpob_AUS", que correponde a los 74 individuos genotipados.
  bind_rows(Pob_AUS) %>% # Se unen los 74 individuos genotipados no mejorados con el 1 indiviuo genotipado mejorado.
  mutate(Columna = Variety) %>%
  write_tsv(here('Datos', 'Datos_AUS', 'mG', 'mG_8', 'subpob_AUS.txt'), col_names = FALSE) # Este conjunto de datos contiene 74 + 1 = 75 individuos de los 75 individuos genotipados.
```

# 5. A continuación usando plink se editan las subpoblaciones anteriores

```{r Edición de las subpoblaciones usando plink}

#### Población de arroz IND ----

## 1. Subpoblación con 98 individuos genotipados

# Se extrae del archivo de genotipos (snps.bed) solo los 98 individuos genotipados que hacen parte de la población IND ---
plink('--bfile snps --keep Datos_IND/Den_100.000/mG/mG_1/subpob_IND.txt --make-bed --out Datos_IND/Den_100.000/mG/mG_1/Ind_IND')

# Se filtra el archivo de genotipos anterior (Ind_IND.bed) para eliminar los SNPs con MAF < 5% ----
plink('--bfile Datos_IND/Den_100.000/mG/mG_1/Ind_IND --maf 0.05 --make-bed --out Datos_IND/Den_100.000/mG/mG_1/frec_0.05_IND') # De este procedimiento, quedan 102836 variantes (o SNPs) de 98 individuos.

## 2. Subpoblación con 148 individuos genotipados

# Se extrae del archivo de genotipos (snps.bed) solo los 148 individuos genotipados que hacen parte de la población IND ---
plink('--bfile snps --keep Datos_IND/Den_100.000/mG/mG_2/subpob_IND.txt --make-bed --out Datos_IND/Den_100.000/mG/mG_2/Ind_IND')

# Se filtra el archivo de genotipos anterior (Ind_IND.bed) para eliminar los SNPs con MAF < 5% ----
plink('--bfile Datos_IND/Den_100.000/mG/mG_2/Ind_IND --maf 0.05 --make-bed --out Datos_IND/Den_100.000/mG/mG_2/frec_0.05_IND') # De este procedimiento, quedan 100662 variantes (o SNPs) de 148 individuos.

## 3. Subpoblación con 198 individuos genotipados

# Se extrae del archivo de genotipos (snps.bed) solo los 198 individuos genotipados que hacen parte de la población IND ---
plink('--bfile snps --keep Datos_IND/Den_100.000/mG/mG_3/subpob_IND.txt --make-bed --out Datos_IND/Den_100.000/mG/mG_3/Ind_IND')

# Se filtra el archivo de genotipos anterior (Ind_IND.bed) para eliminar los SNPs con MAF < 5% ----
plink('--bfile Datos_IND/Den_100.000/mG/mG_3/Ind_IND --maf 0.05 --make-bed --out Datos_IND/Den_100.000/mG/mG_3/frec_0.05_IND') # De este procedimiento, quedan 101997 variantes (o SNPs) de 198 individuos.

## 4. Subpoblación con 248 individuos genotipados

# Se extrae del archivo de genotipos (snps.bed) solo los 248 individuos genotipados que hacen parte de la población IND ---
plink('--bfile snps --keep Datos_IND/Den_100.000/mG/mG_4/subpob_IND.txt --make-bed --out Datos_IND/Den_100.000/mG/mG_4/Ind_IND')

# Se filtra el archivo de genotipos anterior (Ind_IND.bed) para eliminar los SNPs con MAF < 5% ----
plink('--bfile Datos_IND/Den_100.000/mG/mG_4/Ind_IND --maf 0.05 --make-bed --out Datos_IND/Den_100.000/mG/mG_4/frec_0.05_IND') # De este procedimiento, quedan 100620 variantes (o SNPs) de 248 individuos.

## 5. Subpoblación con 298 individuos genotipados

# Se extrae del archivo de genotipos (snps.bed) solo los 298 individuos genotipados que hacen parte de la población IND ---
plink('--bfile snps --keep Datos_IND/Den_100.000/mG/mG_5/subpob_IND.txt --make-bed --out Datos_IND/Den_100.000/mG/mG_5/Ind_IND')

# Se filtra el archivo de genotipos anterior (Ind_IND.bed) para eliminar los SNPs con MAF < 5% ----
plink('--bfile Datos_IND/Den_100.000/mG/mG_5/Ind_IND --maf 0.05 --make-bed --out Datos_IND/Den_100.000/mG/mG_5/frec_0.05_IND') # De este procedimiento, quedan 101394 variantes (o SNPs) de 298 individuos.

## 6. Subpoblación con 348 individuos genotipados

# Se extrae del archivo de genotipos (snps.bed) solo los 348 individuos genotipados que hacen parte de la población IND ---
plink('--bfile snps --keep Datos_IND/Den_100.000/mG/mG_6/subpob_IND.txt --make-bed --out Datos_IND/Den_100.000/mG/mG_6/Ind_IND')

# Se filtra el archivo de genotipos anterior (Ind_IND.bed) para eliminar los SNPs con MAF < 5% ----
plink('--bfile Datos_IND/Den_100.000/mG/mG_6/Ind_IND --maf 0.05 --make-bed --out Datos_IND/Den_100.000/mG/mG_6/frec_0.05_IND') # De este procedimiento, quedan 100955 variantes (o SNPs) de 348 individuos.

## 7. Subpoblación con 398 individuos genotipados

# Se extrae del archivo de genotipos (snps.bed) solo los 398 individuos genotipados que hacen parte de la población IND ---
plink('--bfile snps --keep Datos_IND/Den_100.000/mG/mG_7/subpob_IND.txt --make-bed --out Datos_IND/Den_100.000/mG/mG_7/Ind_IND')

# Se filtra el archivo de genotipos anterior (Ind_IND.bed) para eliminar los SNPs con MAF < 5% ----
plink('--bfile Datos_IND/Den_100.000/mG/mG_7/Ind_IND --maf 0.05 --make-bed --out Datos_IND/Den_100.000/mG/mG_7/frec_0.05_IND') # De este procedimiento, quedan 101176 variantes (o SNPs) de 398 individuos.

## 8. Subpoblación con 451 individuos genotipados

# Se extrae del archivo de genotipos (snps.bed) solo los 451 individuos genotipados que hacen parte de la población IND ---
plink('--bfile snps --keep Datos_IND/Den_100.000/mG/mG_8/subpob_IND.txt --make-bed --out Datos_IND/Den_100.000/mG/mG_8/Ind_IND')

# Se filtra el archivo de genotipos anterior (Ind_IND.bed) para eliminar los SNPs con MAF < 5% ----
plink('--bfile Datos_IND/Den_100.000/mG/mG_8/Ind_IND --maf 0.05 --make-bed --out Datos_IND/Den_100.000/mG/mG_8/frec_0.05_IND') # De este procedimiento, quedan 100231 variantes (o SNPs) de 451 individuos.

#### Población de arroz JAP ----

## 1. Subpoblación con 41 individuos genotipados

# Se extrae del archivo de genotipos (snps.bed) solo los 41 individuos genotipados que hacen parte de la población JAP ---
plink('--bfile snps --keep Datos_JAP/mG/mG_1/subpob_JAP.txt --make-bed --out Datos_JAP/mG/mG_1/Ind_JAP')

# Se filtra el archivo de genotipos anterior (Ind_JAP.bed) para eliminar los SNPs con MAF < 5% ----
plink('--bfile Datos_JAP/mG/mG_1/Ind_JAP --maf 0.05 --make-bed --out Datos_JAP/mG/mG_1/frec_0.05_JAP') # De este procedimiento, quedan 67397 variantes (o SNPs) de 41 individuos.

## 2. Subpoblación con 58 individuos genotipados

# Se extrae del archivo de genotipos (snps.bed) solo los 58 individuos genotipados que hacen parte de la población JAP ---
plink('--bfile snps --keep Datos_JAP/mG/mG_2/subpob_JAP.txt --make-bed --out Datos_JAP/mG/mG_2/Ind_JAP')

# Se filtra el archivo de genotipos anterior (Ind_JAP.bed) para eliminar los SNPs con MAF < 5% ----
plink('--bfile Datos_JAP/mG/mG_2/Ind_JAP --maf 0.05 --make-bed --out Datos_JAP/mG/mG_2/frec_0.05_JAP') # De este procedimiento, quedan 76085 variantes (o SNPs) de 58 individuos.

## 3. Subpoblación con 75 individuos genotipados

# Se extrae del archivo de genotipos (snps.bed) solo los 75 individuos genotipados que hacen parte de la población JAP ---
plink('--bfile snps --keep Datos_JAP/mG/mG_3/subpob_JAP.txt --make-bed --out Datos_JAP/mG/mG_3/Ind_JAP')

# Se filtra el archivo de genotipos anterior (Ind_JAP.bed) para eliminar los SNPs con MAF < 5% ----
plink('--bfile Datos_JAP/mG/mG_3/Ind_JAP --maf 0.05 --make-bed --out Datos_JAP/mG/mG_3/frec_0.05_JAP') # De este procedimiento, quedan 77844 variantes (o SNPs) de 75 individuos.

## 4. Subpoblación con 92 individuos genotipados

# Se extrae del archivo de genotipos (snps.bed) solo los individuos 92 individuos genotipados que hacen parte de la población JAP ---
plink('--bfile snps --keep Datos_JAP/mG/mG_4/subpob_JAP.txt --make-bed --out Datos_JAP/mG/mG_4/Ind_JAP')

# Se filtra el archivo de genotipos anterior (Ind_JAP.bed) para eliminar los SNPs con MAF < 5% ----
plink('--bfile Datos_JAP/mG/mG_4/Ind_JAP --maf 0.05 --make-bed --out Datos_JAP/mG/mG_4/frec_0.05_JAP') # De este procedimiento, quedan 77270 variantes (o SNPs) de 92 individuos.

## 5. Subpoblación con 109 individuos genotipados

# Se extrae del archivo de genotipos (snps.bed) solo los individuos 109 individuos genotipados que hacen parte de la población JAP ---
plink('--bfile snps --keep Datos_JAP/mG/mG_5/subpob_JAP.txt --make-bed --out Datos_JAP/mG/mG_5/Ind_JAP')

# Se filtra el archivo de genotipos anterior (Ind_JAP.bed) para eliminar los SNPs con MAF < 5% ----
plink('--bfile Datos_JAP/mG/mG_5/Ind_JAP --maf 0.05 --make-bed --out Datos_JAP/mG/mG_5/frec_0.05_JAP') # De este procedimiento, quedan 77279 variantes (o SNPs) de 109 individuos.

## 6. Subpoblación con 126 individuos genotipados

# Se extrae del archivo de genotipos (snps.bed) solo los individuos 126 individuos genotipados que hacen parte de la población JAP ---
plink('--bfile snps --keep Datos_JAP/mG/mG_6/subpob_JAP.txt --make-bed --out Datos_JAP/mG/mG_6/Ind_JAP')

# Se filtra el archivo de genotipos anterior (Ind_JAP.bed) para eliminar los SNPs con MAF < 5% ----
plink('--bfile Datos_JAP/mG/mG_6/Ind_JAP --maf 0.05 --make-bed --out Datos_JAP/mG/mG_6/frec_0.05_JAP') # De este procedimiento, quedan 76705 variantes (o SNPs) de 126 individuos.

## 7. Subpoblación con 143 individuos genotipados

# Se extrae del archivo de genotipos (snps.bed) solo los individuos 143 individuos genotipados que hacen parte de la población JAP ---
plink('--bfile snps --keep Datos_JAP/mG/mG_7/subpob_JAP.txt --make-bed --out Datos_JAP/mG/mG_7/Ind_JAP')

# Se filtra el archivo de genotipos anterior (Ind_JAP.bed) para eliminar los SNPs con MAF < 5% ----
plink('--bfile Datos_JAP/mG/mG_7/Ind_JAP --maf 0.05 --make-bed --out Datos_JAP/mG/mG_7/frec_0.05_JAP') # De este procedimiento, quedan 75802 variantes (o SNPs) de 143 individuos.

## 8. Subpoblación con 166 individuos genotipados

# Se extrae del archivo de genotipos (snps.bed) solo los individuos 166 individuos genotipados que hacen parte de la población JAP ---
plink('--bfile snps --keep Datos_JAP/mG/mG_8/subpob_JAP.txt --make-bed --out Datos_JAP/mG/mG_8/Ind_JAP')

# Se filtra el archivo de genotipos anterior (Ind_JAP.bed) para eliminar los SNPs con MAF < 5% ----
plink('--bfile Datos_JAP/mG/mG_8/Ind_JAP --maf 0.05 --make-bed --out Datos_JAP/mG/mG_8/frec_0.05_JAP') # De este procedimiento, quedan 78857 variantes (o SNPs) de 166 individuos.

#### Población de arroz AUS ----

## 1. Subpoblación con 10 individuos genotipados

# Se extrae del archivo de genotipos (snps.bed) solo los 10 individuos genotipados que hacen parte de la población AUS ---
plink('--bfile snps --keep Datos_AUS/mG/mG_1/subpob_AUS.txt --make-bed --out Datos_AUS/mG/mG_1/Ind_AUS')

# Se filtra el archivo de genotipos anterior (Ind_AUS.bed) para eliminar los SNPs con MAF < 5% ----
plink('--bfile Datos_AUS/mG/mG_1/Ind_AUS --maf 0.05 --make-bed --out Datos_AUS/mG/mG_1/frec_0.05_AUS') # De este procedimiento, quedan 86184 variantes (o SNPs) de 10 individuos.

## 2. Subpoblación con 19 individuos genotipados

# Se extrae del archivo de genotipos (snps.bed) solo los 19 individuos genotipados que hacen parte de la población AUS ---
plink('--bfile snps --keep Datos_AUS/mG/mG_2/subpob_AUS.txt --make-bed --out Datos_AUS/mG/mG_2/Ind_AUS')

# Se filtra el archivo de genotipos anterior (Ind_AUS.bed) para eliminar los SNPs con MAF < 5% ----
plink('--bfile Datos_AUS/mG/mG_2/Ind_AUS --maf 0.05 --make-bed --out Datos_AUS/mG/mG_2/frec_0.05_AUS') # De este procedimiento, quedan 94790 variantes (o SNPs) de 19 individuos.

## 3. Subpoblación con 28 individuos genotipados

# Se extrae del archivo de genotipos (snps.bed) solo los 28 individuos genotipados que hacen parte de la población AUS ---
plink('--bfile snps --keep Datos_AUS/mG/mG_3/subpob_AUS.txt --make-bed --out Datos_AUS/mG/mG_3/Ind_AUS')

# Se filtra el archivo de genotipos anterior (Ind_AUS.bed) para eliminar los SNPs con MAF < 5% ----
plink('--bfile Datos_AUS/mG/mG_3/Ind_AUS --maf 0.05 --make-bed --out Datos_AUS/mG/mG_3/frec_0.05_AUS') # De este procedimiento, quedan 82740 variantes (o SNPs) de 28 individuos.

## 4. Subpoblación con 37 individuos genotipados

# Se extrae del archivo de genotipos (snps.bed) solo los 37 individuos genotipados que hacen parte de la población AUS ---
plink('--bfile snps --keep Datos_AUS/mG/mG_4/subpob_AUS.txt --make-bed --out Datos_AUS/mG/mG_4/Ind_AUS')

# Se filtra el archivo de genotipos anterior (Ind_AUS.bed) para eliminar los SNPs con MAF < 5% ----
plink('--bfile Datos_AUS/mG/mG_4/Ind_AUS --maf 0.05 --make-bed --out Datos_AUS/mG/mG_4/frec_0.05_AUS') # De este procedimiento, quedan 90542 variantes (o SNPs) de 37 individuos.

## 5. Subpoblación con 46 individuos genotipados

# Se extrae del archivo de genotipos (snps.bed) solo los 46 individuos genotipados que hacen parte de la población AUS ---
plink('--bfile snps --keep Datos_AUS/mG/mG_5/subpob_AUS.txt --make-bed --out Datos_AUS/mG/mG_5/Ind_AUS')

# Se filtra el archivo de genotipos anterior (Ind_AUS.bed) para eliminar los SNPs con MAF < 5% ----
plink('--bfile Datos_AUS/mG/mG_5/Ind_AUS --maf 0.05 --make-bed --out Datos_AUS/mG/mG_5/frec_0.05_AUS') # De este procedimiento, quedan 86520 variantes (o SNPs) de 46 individuos.

## 6. Subpoblación con 55 individuos genotipados

# Se extrae del archivo de genotipos (snps.bed) solo los 55 individuos genotipados que hacen parte de la población AUS ---
plink('--bfile snps --keep Datos_AUS/mG/mG_6/subpob_AUS.txt --make-bed --out Datos_AUS/mG/mG_6/Ind_AUS')

# Se filtra el archivo de genotipos anterior (Ind_AUS.bed) para eliminar los SNPs con MAF < 5% ----
plink('--bfile Datos_AUS/mG/mG_6/Ind_AUS --maf 0.05 --make-bed --out Datos_AUS/mG/mG_6/frec_0.05_AUS') # De este procedimiento, quedan 87809 variantes (o SNPs) de 55 individuos.

## 7. Subpoblación con 64 individuos genotipados

# Se extrae del archivo de genotipos (snps.bed) solo los 64 individuos genotipados que hacen parte de la población AUS ---
plink('--bfile snps --keep Datos_AUS/mG/mG_7/subpob_AUS.txt --make-bed --out Datos_AUS/mG/mG_7/Ind_AUS')

# Se filtra el archivo de genotipos anterior (Ind_AUS.bed) para eliminar los SNPs con MAF < 5% ----
plink('--bfile Datos_AUS/mG/mG_7/Ind_AUS --maf 0.05 --make-bed --out Datos_AUS/mG/mG_7/frec_0.05_AUS') # De este procedimiento, quedan 89115 variantes (o SNPs) de 64 individuos.

## 8. Subpoblación con 75 individuos genotipados

# Se extrae del archivo de genotipos (snps.bed) solo los 75 individuos genotipados que hacen parte de la población AUS ---
plink('--bfile snps --keep Datos_AUS/mG/mG_8/subpob_AUS.txt --make-bed --out Datos_AUS/mG/mG_8/Ind_AUS')

# Se filtra el archivo de genotipos anterior (Ind_AUS.bed) para eliminar los SNPs con MAF < 5% ----
plink('--bfile Datos_AUS/mG/mG_8/Ind_AUS --maf 0.05 --make-bed --out Datos_AUS/mG/mG_8/frec_0.05_AUS') # De este procedimiento, quedan 89227 variantes (o SNPs) de 75 individuos.
```

# 6. A continuación se calcula la matriz de relaciones genómica de cada una de las subpoblaciones anteriores. Para esto, se cargan los datos de los genotipos previamente editados usando plink y escalados; esto debido a que no fue posible escalar en RStudio, por lo que este proceso se escribio como un bash (SNPs_escalados.r) y se ejecuto en la terminal de linux.

```{r Conjuntos de datos genotípicos para calcular la matriz de relaciones genómicas}

#### Población de arroz IND ----

## 1. Subpoblación con 98 individuos genotipados

mG_1_esc <- readRDS(here('Datos', 'Datos_IND', 'Den_100.000', 'mG', 'mG_1', 'mG_1_esc.RDS')) # Se carga la matriz de SPNs escalada de los 98 individuos genotipados de la población IND. 

m_G_IND_1 <- tcrossprod(mG_1_esc)/ncol(mG_1_esc) # Se cálculo la matriz de relaciones genómicas como ...
diag(m_G_IND_1) = diag(m_G_IND_1) + 0.05 # Fue necesario sumarle 0.05 a la diagonal de la matriz de relaciones genómica debido a...

## 2. Subpoblación con 148 individuos genotipados

mG_2_esc <- readRDS(here('Datos', 'Datos_IND', 'Den_100.000', 'mG', 'mG_2', 'mG_2_esc.RDS')) # Se carga la matriz de SPNs escalada de los 148 individuos genotipados de la población IND. 

m_G_IND_2 <- tcrossprod(mG_2_esc)/ncol(mG_2_esc)
diag(m_G_IND_2) = diag(m_G_IND_2) + 0.05

## 3. Subpoblación con 198 individuos genotipados

mG_3_esc <- readRDS(here('Datos', 'Datos_IND', 'Den_100.000', 'mG', 'mG_3', 'mG_3_esc.RDS')) # Se carga la matriz de SPNs escalada de los 198 individuos genotipados de la población IND. 

m_G_IND_3 <- tcrossprod(mG_3_esc)/ncol(mG_3_esc)
diag(m_G_IND_3) = diag(m_G_IND_3) + 0.05

## 4. Subpoblación con 248 individuos genotipados

mG_4_esc <- readRDS(here('Datos', 'Datos_IND', 'Den_100.000', 'mG', 'mG_4', 'mG_4_esc.RDS')) # Se carga la matriz de SPNs escalada de los 248 individuos genotipados de la población IND. 

m_G_IND_4 <- tcrossprod(mG_4_esc)/ncol(mG_4_esc)
diag(m_G_IND_4) = diag(m_G_IND_4) + 0.05

## 5. Subpoblación con 298 individuos genotipados

mG_5_esc <- readRDS(here('Datos', 'Datos_IND', 'Den_100.000', 'mG', 'mG_5', 'mG_5_esc.RDS')) # Se carga la matriz de SPNs escalada de los 298 individuos genotipados de la población IND. 

m_G_IND_5 <- tcrossprod(mG_5_esc)/ncol(mG_5_esc)
diag(m_G_IND_5) = diag(m_G_IND_5) + 0.05

## 6. Subpoblación con 348 individuos genotipados

mG_6_esc <- readRDS(here('Datos', 'Datos_IND', 'Den_100.000', 'mG', 'mG_6', 'mG_6_esc.RDS')) # Se carga la matriz de SPNs escalada de los 348 individuos genotipados de la población IND. 

m_G_IND_6 <- tcrossprod(mG_6_esc)/ncol(mG_6_esc)
diag(m_G_IND_6) = diag(m_G_IND_6) + 0.05

## 7. Subpoblación con 398 individuos genotipados

mG_7_esc <- readRDS(here('Datos', 'Datos_IND', 'Den_100.000', 'mG', 'mG_7', 'mG_7_esc.RDS')) # Se carga la matriz de SPNs escalada de los 398 individuos genotipados de la población IND. 

m_G_IND_7 <- tcrossprod(mG_7_esc)/ncol(mG_7_esc)
diag(m_G_IND_7) = diag(m_G_IND_7) + 0.05

## 8. Subpoblación con 451 individuos genotipados

mG_8_esc <- readRDS(here('Datos', 'Datos_IND', 'Den_100.000', 'mG', 'mG_8', 'mG_8_esc.RDS')) # Se carga la matriz de SPNs escalada de los 451 individuos genotipados de la población IND. 

m_G_IND_8 <- tcrossprod(mG_8_esc)/ncol(mG_8_esc)
diag(m_G_IND_8) = diag(m_G_IND_8) + 0.05

#### Población JAP ----

## 1. Subpoblación con 41 individuos genotipados

mG_1_esc <- readRDS(here('Datos', 'Datos_JAP', 'mG', 'mG_1', 'mG_1_esc.RDS')) # Se carga la matriz de SPNs escalada de los 41 individuos genotipados de la población JAP. 

m_G_JAP_1 <- tcrossprod(mG_1_esc)/ncol(mG_1_esc)
diag(m_G_JAP_1) = diag(m_G_JAP_1) + 0.05

## 2. Subpoblación con 58 individuos genotipados

mG_2_esc <- readRDS(here('Datos', 'Datos_JAP', 'mG', 'mG_2', 'mG_2_esc.RDS')) # Se carga la matriz de SPNs escalada de los 58 individuos genotipados de la población JAP. 

m_G_JAP_2 <- tcrossprod(mG_2_esc)/ncol(mG_2_esc)
diag(m_G_JAP_2) = diag(m_G_JAP_2) + 0.05

## 3. Subpoblación con 75 individuos genotipados

mG_3_esc <- readRDS(here('Datos', 'Datos_JAP', 'mG', 'mG_3', 'mG_3_esc.RDS')) # Se carga la matriz de SPNs escalada de los 75 individuos genotipados de la población JAP. 

m_G_JAP_3 <- tcrossprod(mG_3_esc)/ncol(mG_3_esc)
diag(m_G_JAP_3) = diag(m_G_JAP_3) + 0.05

## 4. Subpoblación con 92 individuos genotipados

mG_4_esc <- readRDS(here('Datos', 'Datos_JAP', 'mG', 'mG_4', 'mG_4_esc.RDS')) # Se carga la matriz de SPNs escalada de los 92 individuos genotipados de la población JAP. 

m_G_JAP_4 <- tcrossprod(mG_4_esc)/ncol(mG_4_esc)
diag(m_G_JAP_4) = diag(m_G_JAP_4) + 0.05

## 5. Subpoblación con 109 individuos genotipados

mG_5_esc <- readRDS(here('Datos', 'Datos_JAP', 'mG', 'mG_5', 'mG_5_esc.RDS')) # Se carga la matriz de SPNs escalada de los 109 individuos genotipados de la población JAP. 

m_G_JAP_5 <- tcrossprod(mG_5_esc)/ncol(mG_5_esc)
diag(m_G_JAP_5) = diag(m_G_JAP_5) + 0.05

## 6. Subpoblación con 126 individuos genotipados

mG_6_esc <- readRDS(here('Datos', 'Datos_JAP', 'mG', 'mG_6', 'mG_6_esc.RDS')) # Se carga la matriz de SPNs escalada de los 126 individuos genotipados de la población JAP. 

m_G_JAP_6 <- tcrossprod(mG_6_esc)/ncol(mG_6_esc)
diag(m_G_JAP_6) = diag(m_G_JAP_6) + 0.05

## 7. Subpoblación con 143 individuos genotipados

mG_7_esc <- readRDS(here('Datos', 'Datos_JAP', 'mG', 'mG_7', 'mG_7_esc.RDS')) # Se carga la matriz de SPNs escalada de los 143 individuos genotipados de la población JAP. 

m_G_JAP_7 <- tcrossprod(mG_7_esc)/ncol(mG_7_esc)
diag(m_G_JAP_7) = diag(m_G_JAP_7) + 0.05

## 8. Subpoblación con 166 individuos genotipados

mG_8_esc <- readRDS(here('Datos', 'Datos_JAP', 'mG', 'mG_8', 'mG_8_esc.RDS')) # Se carga la matriz de SPNs escalada de los 166 individuos genotipados de la población JAP. 

m_G_JAP_8 <- tcrossprod(mG_8_esc)/ncol(mG_8_esc)
diag(m_G_JAP_8) = diag(m_G_JAP_8) + 0.05

#### Población AUS ----

## 1. Subpoblación con 10 individuos genotipados

mG_1_esc <- readRDS(here('Datos', 'Datos_AUS', 'mG', 'mG_1', 'mG_1_esc.RDS')) # Se carga la matriz de SPNs escalada de los 10 individuos genotipados de la población AUS. 

na_mG_1_esc <- apply(mG_1_esc, 1, function(x){any(is.na(x))}) # Aquí podemos ver que los 10 individuos tienen valores NA en una de sus columnas (SNPs). Por tanto, se procede a eliminar esos NA debido a que no permitia el calculo posterior de la matriz G (m_G_AUS_1)

mG_1_esc <- mG_1_esc %>%
  as.tibble() %>%
  select(
    where(
      ~!all(is.na(.x))
      )
    ) %>% # Aquí se quitan las columnas con NAs.
  as.matrix()

m_G_AUS_1 <- tcrossprod(mG_1_esc)/ncol(mG_1_esc)
diag(m_G_AUS_1) = diag(m_G_AUS_1) + 0.05

## 2. Subpoblación con 19 individuos genotipados

mG_2_esc <- readRDS(here('Datos', 'Datos_AUS', 'mG', 'mG_2', 'mG_2_esc.RDS')) # Se carga la matriz de SPNs escalada de los 19 individuos genotipados de la población AUS. 

mG_2_esc <- mG_2_esc %>%
  as.tibble() %>%
  select(
    where(
      ~!all(is.na(.x))
      )
    ) %>% # Aquí se quitan las columnas con NAs.
  as.matrix()

m_G_AUS_2 <- tcrossprod(mG_2_esc)/ncol(mG_2_esc)
diag(m_G_AUS_2) = diag(m_G_AUS_2) + 0.05

## 3. Subpoblación con 28 individuos genotipados

mG_3_esc <- readRDS(here('Datos', 'Datos_AUS', 'mG', 'mG_3', 'mG_3_esc.RDS')) # Se carga la matriz de SPNs escalada de los 28 individuos genotipados de la población AUS. 

mG_3_esc <- mG_3_esc %>%
  as.tibble() %>%
  select(
    where(
      ~!all(is.na(.x))
      )
    ) %>% # Aquí se quitan las columnas con NAs.
  as.matrix()

m_G_AUS_3 <- tcrossprod(mG_3_esc)/ncol(mG_3_esc)
diag(m_G_AUS_3) = diag(m_G_AUS_3) + 0.05

## 4. Subpoblación con 37 individuos genotipados

mG_4_esc <- readRDS(here('Datos', 'Datos_AUS', 'mG', 'mG_4', 'mG_4_esc.RDS')) # Se carga la matriz de SPNs escalada de los 37 individuos genotipados de la población AUS. 

m_G_AUS_4 <- tcrossprod(mG_4_esc)/ncol(mG_4_esc)
diag(m_G_AUS_4) = diag(m_G_AUS_4) + 0.05

## 5. Subpoblación con 46 individuos genotipados

mG_5_esc <- readRDS(here('Datos', 'Datos_AUS', 'mG', 'mG_5', 'mG_5_esc.RDS')) # Se carga la matriz de SPNs escalada de los 46 individuos genotipados de la población AUS. 

m_G_AUS_5 <- tcrossprod(mG_5_esc)/ncol(mG_5_esc)
diag(m_G_AUS_5) = diag(m_G_AUS_5) + 0.05

## 6. Subpoblación con 55 individuos genotipados

mG_6_esc <- readRDS(here('Datos', 'Datos_AUS', 'mG', 'mG_6', 'mG_6_esc.RDS')) # Se carga la matriz de SPNs escalada de los 55 individuos genotipados de la población AUS. 

m_G_AUS_6 <- tcrossprod(mG_6_esc)/ncol(mG_6_esc)
diag(m_G_AUS_6) = diag(m_G_AUS_6) + 0.05

## 7. Subpoblación con 64 individuos genotipados

mG_7_esc <- readRDS(here('Datos', 'Datos_AUS', 'mG', 'mG_7', 'mG_7_esc.RDS')) # Se carga la matriz de SPNs escalada de los 64 individuos genotipados de la población AUS. 

m_G_AUS_7 <- tcrossprod(mG_7_esc)/ncol(mG_7_esc)
diag(m_G_AUS_7) = diag(m_G_AUS_7) + 0.05

## 8. Subpoblación con 75 individuos genotipados

mG_8_esc <- readRDS(here('Datos', 'Datos_AUS', 'mG', 'mG_8', 'mG_8_esc.RDS')) # Se carga la matriz de SPNs escalada de los 75 individuos genotipados de la población AUS. 

m_G_AUS_8 <- tcrossprod(mG_8_esc)/ncol(mG_8_esc)
diag(m_G_AUS_8) = diag(m_G_AUS_8) + 0.05
```

# 7. A continuación con base en la función creada, a partir del código de Austin Putz (http://rstudio-pubs-static.s3.amazonaws.com/378595_edda8cfe948a4786ae6dd74962cf6e94.html), se calcula la matriz H.

```{r Cálculo de la matriz H}

fn.mH <- function(ped, mG) { # Esta función recibe como argumentos los datos con estructura (id | sire | dam | Gen (TRUE/FALSE)) y la matriz de relaciones genómicas.
  
  # 1. Se calcula la matriz de relaciones aditivas con base en el pedigrí (A)
  
  ped_edit <- editPed( # Esta función ordena el pedigrí.
    sire = ped$sire,
    dam = ped$dam,
    label = ped$id
    )
  pedi <- pedigree( # Aquí se usa la salida anterior (ya ordenado) y se crea un objeto de clase pedigree.
    sire = ped_edit$sire,
    dam = ped_edit$dam,
    label = ped_edit$label
  )
  Matrix_A <- getA(ped = pedi) # Esto dara la matriz de relaciones aditivas A.
 
  # 2. De lo anterior (Matriz_A) se extraen las partes correspondientes a individuos no genotipados (1) y genotipados (2)
  
  # Individuos no genotipados:
  A_11 <- Matrix_A[ped$Genotiped != 1, ped$Genotiped != 1]
  # Individuos genotipados:
  A_22 <- Matrix_A[ped$Genotiped == 1, ped$Genotiped == 1]
  # Individuos no genotipados (en filas) y genotipados (en columnas):
  A_12 <- Matrix_A[ped$Genotiped != 1, ped$Genotiped == 1]
  # Transpuesta de la anterior (individuos no genotipados en columnas y genotipados en filas):
  A_21 <- t(A_12)
  
  # 3. Se coloca el nombre de las filas y y de las columnas de la matriz G según los individuos genotipados
  
  rownames(mG) <- ped$id[ped$Genotiped == 1]
  colnames(mG) <- ped$id[ped$Genotiped == 1]
  
  # 4. Teniendo todos los componentes de la matriz H, se procede a su construcción y a calcular su inversa
  
  H_11 <- A_11 - 
    (A_12 %*% solve(A_22) %*% A_21) + 
    (A_12 %*% solve(A_22) %*% mG %*% solve(A_22) %*% A_21)
  H_12 <- A_12 %*% solve(A_22) %*% mG
  H_21 <- t(H_12)
  H_22 <- mG
  
  H_11_H_12 <- cbind(H_11, H_12)
  H_21_H_22 <- cbind(H_21, H_22)
  mH <- rbind(H_11_H_12, H_21_H_22)
  
  mH <- mH[order(as.numeric(rownames(mH))), order(as.numeric(colnames(mH)))]
  mH <- Matrix(mH)
  
  # 5. Finalmente se indica retornar la inversa de la matriz H (mH_1)
  
  return(mH)
  }

#### Población de arroz IND ----

dir.create('../Datos/Datos_IND/Den_100.000/mH') # Se crea el directorio donde se guardara la matriz H para cada una de las subpoblaciones de individuos genotipados.

## 1. Subpoblación con 98 individuos genotipados

dir.create('../Datos/Datos_IND/Den_100.000/mH/mH_1') # Se crea el directorio donde se guardara la matriz H para la subpoblación de 98 individuos genotipados.

# Pedigrí ----

famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'nSNPs_IND.fam')) %>% # Se importa el archivo .fam obtenido usando plink y que posteriomente se uso para crear la hoja de parámetros para ejecutar el software molcoanc.
  select(fam) %>%
  mutate(id = 501:951)

ped_IND_98 <- read_delim(here('Datos', 'Datos_IND', 'Den_100.000', 'mG', 'mG_1', 'subpob_IND.txt'), delim = '\t', col_names = FALSE) %>% # Se importa el conjunto de datos donde esta la identificación de los 98 individuos genotipados.
  select(X1) %>%
  rename(fam = X1) %>%
  right_join(x = famsnps_IND, by = 'fam') %>%
  mutate(Genotiped = TRUE) %>% # Se indica con TRUE que estos individuos estan genotipados.
  select(-fam)

ped_IND <- read_delim(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'Molcoanc_10', 'geneal_IND.csv'), delim = ' ') %>% # Se importa el pedigrí creado son el software molcoanc.
  na_if(0) %>% # Para usar la función para calcular la matriz A y su inversa, todos los padres y madres faltantes (en este caso 0), deben estar como NA.
  full_join(y = ped_IND_98, by = 'id') %>%
  mutate(Genotiped = replace_na(Genotiped, FALSE)) # Se especifican los individuos no genotipados (NA) como FALSE.

# Matriz G ----

m_G_IND_1 <- Matrix(m_G_IND_1)

# Cálculo de la matriz H ----

mH_IND_1 <- fn.mH(ped = ped_IND, mG = m_G_IND_1) %>%
  saveRDS(here('Datos', 'Datos_IND', 'Den_100.000', 'mH', 'mH_1', 'mH_1.RDS'))

mH_IND_1[1:10, 1:10]
mH_IND_1[490:500, 490:500]
mH_IND_1[501:511, 501:511]
diag(mH_IND_1)

## 2. Subpoblación con 148 individuos genotipados

dir.create('../Datos/Datos_IND/Den_100.000/mH/mH_2') # Se crea el directorio donde se guardara la matriz H para la subpoblación de 148 individuos genotipados.

# Pedigrí ----

famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'nSNPs_IND.fam')) %>% # Se importa el archivo .fam obtenido usando plink y que posteriomente se uso para crear la hoja de parámetros para ejecutar el software molcoanc.
  as_tibble() %>%
  select(fam) %>%
  mutate(id = 501:951)

ped_IND_148 <- read_delim(here('Datos', 'Datos_IND', 'Den_100.000', 'mG', 'mG_2', 'subpob_IND.txt'), delim = '\t', col_names = FALSE) %>% # Se importa el conjunto de datos donde esta la identificación de los 148 individuos genotipados.
  as_tibble() %>%
  select(X1) %>%
  rename(fam = X1) %>%
  right_join(x = famsnps_IND, by = 'fam') %>%
  mutate(Genotiped = TRUE) %>% # Se indica con TRUE que estos individuos estan genotipados.
  select(-fam)

ped_IND <- read_delim(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'Molcoanc_10', 'geneal_IND.csv'), delim = ' ') %>% # Se importa el pedigrí creado son el software molcoanc.
  na_if(0) %>% # Para usar la función para calcular la matriz A y su inversa, todos los padres y madres faltantes (en este caso 0), deben estar como NA.
  full_join(y = ped_IND_148, by = 'id') %>%
  mutate(Genotiped = replace_na(Genotiped, FALSE)) # Se especifican los individuos no genotipados (NA) como FALSE.

# Matriz G ----

m_G_IND_2 <- Matrix(m_G_IND_2)

# Cálculo de la matriz H ----

mH_IND_2 <- fn.mH(ped = ped_IND, mG = m_G_IND_2) %>%
  saveRDS(here('Datos', 'Datos_IND', 'Den_100.000', 'mH', 'mH_2', 'mH_2.RDS'))

mH_IND_2[1:10, 1:10]
mH_IND_2[490:500, 490:500]
mH_IND_2[501:511, 501:511]
diag(mH_IND_2)

## 3. Subpoblación con 198 individuos genotipados

dir.create('../Datos/Datos_IND/Den_100.000/mH/mH_3') # Se crea el directorio donde se guardara la matriz H para la subpoblación de 198 individuos genotipados.

# Pedigrí ----

famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'nSNPs_IND.fam')) %>% # Se importa el archivo .fam obtenido usando plink y que posteriomente se uso para crear la hoja de parámetros para ejecutar el software molcoanc.
  as_tibble() %>%
  select(fam) %>%
  mutate(id = 501:951)

ped_IND_198 <- read_delim(here('Datos', 'Datos_IND', 'Den_100.000', 'mG', 'mG_3', 'subpob_IND.txt'), delim = '\t', col_names = FALSE) %>% # Se importa el conjunto de datos donde esta la identificación de los 198 individuos genotipados.
  as_tibble() %>%
  select(X1) %>%
  rename(fam = X1) %>%
  right_join(x = famsnps_IND, by = 'fam') %>%
  mutate(Genotiped = TRUE) %>% # Se indica con TRUE que estos individuos estan genotipados.
  select(-fam)

ped_IND <- read_delim(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'Molcoanc_10', 'geneal_IND.csv'), delim = ' ') %>% # Se importa el pedigrí creado son el software molcoanc.
  na_if(0) %>% # Para usar la función para calcular la matriz A y su inversa, todos los padres y madres faltantes (en este caso 0), deben estar como NA.
  full_join(y = ped_IND_198, by = 'id') %>%
  mutate(Genotiped = replace_na(Genotiped, FALSE)) # Se especifican los individuos no genotipados (NA) como FALSE.

# Matriz G ----

m_G_IND_3 <- Matrix(m_G_IND_3)

# Cálculo de la matriz H ----

mH_IND_3 <- fn.mH(ped = ped_IND, mG = m_G_IND_3) %>%
  saveRDS(here('Datos', 'Datos_IND', 'Den_100.000', 'mH', 'mH_3', 'mH_3.RDS'))

mH_IND_3[1:10, 1:10]
mH_IND_3[490:500, 490:500]
mH_IND_3[501:511, 501:511]
diag(mH_IND_3)

## 4. Subpoblación con 248 individuos genotipados

dir.create('../Datos/Datos_IND/Den_100.000/mH/mH_4') # Se crea el directorio donde se guardara la matriz H para la subpoblación de 248 individuos genotipados.

# Pedigrí ----

famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'nSNPs_IND.fam')) %>% # Se importa el archivo .fam obtenido usando plink y que posteriomente se uso para crear la hoja de parámetros para ejecutar el software molcoanc.
  as_tibble() %>%
  select(fam) %>%
  mutate(id = 501:951)

ped_IND_248 <- read_delim(here('Datos', 'Datos_IND', 'Den_100.000', 'mG', 'mG_4', 'subpob_IND.txt'), delim = '\t', col_names = FALSE) %>% # Se importa el conjunto de datos donde esta la identificación de los 248 individuos genotipados.
  as_tibble() %>%
  select(X1) %>%
  rename(fam = X1) %>%
  right_join(x = famsnps_IND, by = 'fam') %>%
  mutate(Genotiped = TRUE) %>% # Se indica con TRUE que estos individuos estan genotipados.
  select(-fam)

ped_IND <- read_delim(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'Molcoanc_10', 'geneal_IND.csv'), delim = ' ') %>% # Se importa el pedigrí creado son el software molcoanc.
  na_if(0) %>% # Para usar la función para calcular la matriz A y su inversa, todos los padres y madres faltantes (en este caso 0), deben estar como NA.
  full_join(y = ped_IND_248, by = 'id') %>%
  mutate(Genotiped = replace_na(Genotiped, FALSE)) # Se especifican los individuos no genotipados (NA) como FALSE.

# Matriz G ----

m_G_IND_4 <- Matrix(m_G_IND_4)

# Cálculo de la matriz H ----

mH_IND_4 <- fn.mH(ped = ped_IND, mG = m_G_IND_4) %>%
  saveRDS(here('Datos', 'Datos_IND', 'Den_100.000', 'mH', 'mH_4', 'mH_4.RDS'))

mH_IND_4[1:10, 1:10]
mH_IND_4[490:500, 490:500]
mH_IND_4[501:511, 501:511]
diag(mH_IND_4)

## 5. Subpoblación con 298 individuos genotipados

dir.create('../Datos/Datos_IND/Den_100.000/mH/mH_5') # Se crea el directorio donde se guardara la matriz H para la subpoblación de 298 individuos genotipados.

# Pedigrí ----

famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'nSNPs_IND.fam')) %>% # Se importa el archivo .fam obtenido usando plink y que posteriomente se uso para crear la hoja de parámetros para ejecutar el software molcoanc.
  as_tibble() %>%
  select(fam) %>%
  mutate(id = 501:951)

ped_IND_298 <- read_delim(here('Datos', 'Datos_IND', 'Den_100.000', 'mG', 'mG_5', 'subpob_IND.txt'), delim = '\t', col_names = FALSE) %>% # Se importa el conjunto de datos donde esta la identificación de los 298 individuos genotipados.
  as_tibble() %>%
  select(X1) %>%
  rename(fam = X1) %>%
  right_join(x = famsnps_IND, by = 'fam') %>%
  mutate(Genotiped = TRUE) %>% # Se indica con TRUE que estos individuos estan genotipados.
  select(-fam)

ped_IND <- read_delim(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'Molcoanc_10', 'geneal_IND.csv'), delim = ' ') %>% # Se importa el pedigrí creado son el software molcoanc.
  na_if(0) %>% # Para usar la función para calcular la matriz A y su inversa, todos los padres y madres faltantes (en este caso 0), deben estar como NA.
  full_join(y = ped_IND_298, by = 'id') %>%
  mutate(Genotiped = replace_na(Genotiped, FALSE)) # Se especifican los individuos no genotipados (NA) como FALSE.

# Matriz G ----

m_G_IND_5 <- Matrix(m_G_IND_5)

# Cálculo de la matriz H ----

mH_IND_5 <- fn.mH(ped = ped_IND, mG = m_G_IND_5) %>%
  saveRDS(here('Datos', 'Datos_IND', 'Den_100.000', 'mH', 'mH_5', 'mH_5.RDS'))

mH_IND_5[1:10, 1:10]
mH_IND_5[490:500, 490:500]
mH_IND_5[501:511, 501:511]
diag(mH_IND_5)

## 6. Subpoblación con 348 individuos genotipados

dir.create('../Datos/Datos_IND/Den_100.000/mH/mH_6') # Se crea el directorio donde se guardara la matriz H para la subpoblación de 348 individuos genotipados.

# Pedigrí ----

famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'nSNPs_IND.fam')) %>% # Se importa el archivo .fam obtenido usando plink y que posteriomente se uso para crear la hoja de parámetros para ejecutar el software molcoanc.
  as_tibble() %>%
  select(fam) %>%
  mutate(id = 501:951)

ped_IND_348 <- read_delim(here('Datos', 'Datos_IND', 'Den_100.000', 'mG', 'mG_6', 'subpob_IND.txt'), delim = '\t', col_names = FALSE) %>% # Se importa el conjunto de datos donde esta la identificación de los 348 individuos genotipados.
  as_tibble() %>%
  select(X1) %>%
  rename(fam = X1) %>%
  right_join(x = famsnps_IND, by = 'fam') %>%
  mutate(Genotiped = TRUE) %>% # Se indica con TRUE que estos individuos estan genotipados.
  select(-fam)

ped_IND <- read_delim(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'Molcoanc_10', 'geneal_IND.csv'), delim = ' ') %>% # Se importa el pedigrí creado son el software molcoanc.
  na_if(0) %>% # Para usar la función para calcular la matriz A y su inversa, todos los padres y madres faltantes (en este caso 0), deben estar como NA.
  full_join(y = ped_IND_348, by = 'id') %>%
  mutate(Genotiped = replace_na(Genotiped, FALSE)) # Se especifican los individuos no genotipados (NA) como FALSE.

# Matriz G ----

m_G_IND_6 <- Matrix(m_G_IND_6)

# Cálculo de la matriz H ----

mH_IND_6 <- fn.mH(ped = ped_IND, mG = m_G_IND_6) %>%
  saveRDS(here('Datos', 'Datos_IND', 'Den_100.000', 'mH', 'mH_6', 'mH_6.RDS'))

mH_IND_6[1:10, 1:10]
mH_IND_6[490:500, 490:500]
mH_IND_6[501:511, 501:511]
diag(mH_IND_6)

## 7. Subpoblación con 398 individuos genotipados

dir.create('../Datos/Datos_IND/Den_100.000/mH/mH_7') # Se crea el directorio donde se guardara la matriz H para la subpoblación de 398 individuos genotipados.

# Pedigrí ----

famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'nSNPs_IND.fam')) %>% # Se importa el archivo .fam obtenido usando plink y que posteriomente se uso para crear la hoja de parámetros para ejecutar el software molcoanc.
  as_tibble() %>%
  select(fam) %>%
  mutate(id = 501:951)

ped_IND_398 <- read_delim(here('Datos', 'Datos_IND', 'Den_100.000', 'mG', 'mG_7', 'subpob_IND.txt'), delim = '\t', col_names = FALSE) %>% # Se importa el conjunto de datos donde esta la identificación de los 398 individuos genotipados.
  as_tibble() %>%
  select(X1) %>%
  rename(fam = X1) %>%
  right_join(x = famsnps_IND, by = 'fam') %>%
  mutate(Genotiped = TRUE) %>% # Se indica con TRUE que estos individuos estan genotipados.
  select(-fam)

ped_IND <- read_delim(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'Molcoanc_10', 'geneal_IND.csv'), delim = ' ') %>% # Se importa el pedigrí creado son el software molcoanc.
  na_if(0) %>% # Para usar la función para calcular la matriz A y su inversa, todos los padres y madres faltantes (en este caso 0), deben estar como NA.
  full_join(y = ped_IND_398, by = 'id') %>%
  mutate(Genotiped = replace_na(Genotiped, FALSE)) # Se especifican los individuos no genotipados (NA) como FALSE.

# Matriz G ----

m_G_IND_7 <- Matrix(m_G_IND_7)

# Cálculo de la matriz H ----

mH_IND_7 <- fn.mH(ped = ped_IND, mG = m_G_IND_7) %>%
  saveRDS(here('Datos', 'Datos_IND', 'Den_100.000', 'mH', 'mH_7', 'mH_7.RDS'))

mH_IND_7[1:10, 1:10]
mH_IND_7[490:500, 490:500]
mH_IND_7[501:511, 501:511]
diag(mH_IND_7)

## 8. Subpoblación con 451 individuos genotipados

dir.create('../Datos/Datos_IND/Den_100.000/mH/mH_8') # Se crea el directorio donde se guardara la matriz H para la subpoblación de 451 individuos genotipados.

# Pedigrí ----

famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'nSNPs_IND.fam')) %>% # Se importa el archivo .fam obtenido usando plink y que posteriomente se uso para crear la hoja de parámetros para ejecutar el software molcoanc.
  as_tibble() %>%
  select(fam) %>%
  mutate(id = 501:951)

ped_IND_451 <- read_delim(here('Datos', 'Datos_IND', 'Den_100.000', 'mG', 'mG_8', 'subpob_IND.txt'), delim = '\t', col_names = FALSE) %>% # Se importa el conjunto de datos donde esta la identificación de los 451 individuos genotipados.
  as_tibble() %>%
  select(X1) %>%
  rename(fam = X1) %>%
  right_join(x = famsnps_IND, by = 'fam') %>%
  mutate(Genotiped = TRUE) %>% # Se indica con TRUE que estos individuos estan genotipados.
  select(-fam)

ped_IND <- read_delim(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'Molcoanc_10', 'geneal_IND.csv'), delim = ' ') %>% # Se importa el pedigrí creado son el software molcoanc.
  na_if(0) %>% # Para usar la función para calcular la matriz A y su inversa, todos los padres y madres faltantes (en este caso 0), deben estar como NA.
  full_join(y = ped_IND_451, by = 'id') %>%
  mutate(Genotiped = replace_na(Genotiped, FALSE)) # Se especifican los individuos no genotipados (NA) como FALSE.

# Matriz G ----

m_G_IND_8 <- Matrix(m_G_IND_8)

# Cálculo de la matriz H ----

mH_IND_8 <- fn.mH(ped = ped_IND, mG = m_G_IND_8) %>%
  saveRDS(here('Datos', 'Datos_IND', 'Den_100.000', 'mH', 'mH_8', 'mH_8.RDS'))

mH_IND_8[1:10, 1:10]
mH_IND_8[490:500, 490:500]
mH_IND_8[501:511, 501:511]
diag(mH_IND_8)

#### Población de arroz JAP ----

dir.create('../Datos/Datos_JAP/mHI') # Se crea el directorio donde se guardara la matriz H invertida para cada una de las subpoblaciones de individuos genotipados.

## 1. Subpoblación con 17 individuos genotipados

dir.create('../Datos/Datos_JAP/mHI/mHI_1') # Se crea el directorio donde se guardara la matriz H invertida para la subpoblación de 17 individuos genotipados.

# Pedigrí ----

famsnps_JAP <- read_fam(here('Datos', 'Datos_JAP', 'Soft_Molcoanc', 'nSNPs_JAP.fam')) %>% # Se importa el archivo .fam obtenido usando plink y que posteriomente se uso para crear la hoja de parámetros para ejecutar el software molcoanc.
  select(fam) %>%
  mutate(id = 251:416)

ped_JAP_41 <- read_delim(here('Datos', 'Datos_JAP', 'mG', 'mG_1', 'subpob_JAP.txt'), delim = '\t', col_names = FALSE) %>% # Se importa el conjunto de datos donde esta la identificación de los 41 individuos genotipados.
  select(X1) %>%
  rename(fam = X1) %>%
  right_join(x = famsnps_JAP, by = 'fam') %>%
  mutate(Genotiped = TRUE) %>% # Se indica con TRUE que estos individuos estan genotipados.
  select(-fam)

ped_JAP <- read_delim(here('Datos', 'Datos_JAP', 'Soft_Molcoanc', 'Molcoanc_2', 'geneal_JAP.csv'), delim = ' ') %>% # Se importa el pedigrí creado son el software molcoanc.
  na_if(0) %>% # Para usar la función para calcular la matriz A y su inversa, todos los padres y madres faltantes (en este caso 0), deben estar como NA.
  full_join(y = ped_JAP_41, by = 'id') %>%
  mutate(Genotiped = replace_na(Genotiped, FALSE)) # Se especifican los individuos no genotipados (NA) como FALSE.

# Matriz G ----

m_G_JAP_1 <- Matrix(m_G_JAP_1)

# Cálculo de la matriz H invertida ----

mH_I_JAP_1 <- fn.mH(ped = ped_JAP, mG = m_G_JAP_1) %>%
  saveRDS(here('Datos', 'Datos_JAP', 'mHI', 'mHI_1', 'mHI_1.RDS'))

mH_I_JAP_1[1:10, 1:10]
mH_I_JAP_1[240:250, 240:250]
mH_I_JAP_1[251:261, 251:261]
diag(mH_I_JAP_1)

## 2. Subpoblación con 34 individuos genotipados

dir.create('../Datos/Datos_JAP/mHI/mHI_2') # Se crea el directorio donde se guardara la matriz H invertida para la subpoblación de 34 individuos genotipados.

# Pedigrí ----

famsnps_JAP <- read_fam(here('Datos', 'Datos_JAP', 'Soft_Molcoanc', 'nSNPs_JAP.fam')) %>% # Se importa el archivo .fam obtenido usando plink y que posteriomente se uso para crear la hoja de parámetros para ejecutar el software molcoanc.
  select(fam) %>%
  mutate(id = 251:416)

ped_JAP_58 <- read_delim(here('Datos', 'Datos_JAP', 'mG', 'mG_2', 'subpob_JAP.txt'), delim = '\t', col_names = FALSE) %>% # Se importa el conjunto de datos donde esta la identificación de los 58 individuos genotipados.
  select(X1) %>%
  rename(fam = X1) %>%
  right_join(x = famsnps_JAP, by = 'fam') %>%
  mutate(Genotiped = TRUE) %>% # Se indica con TRUE que estos individuos estan genotipados.
  select(-fam)

ped_JAP <- read_delim(here('Datos', 'Datos_JAP', 'Soft_Molcoanc', 'Molcoanc_2', 'geneal_JAP.csv'), delim = ' ') %>% # Se importa el pedigrí creado son el software molcoanc.
  na_if(0) %>% # Para usar la función para calcular la matriz A y su inversa, todos los padres y madres faltantes (en este caso 0), deben estar como NA.
  full_join(y = ped_JAP_58, by = 'id') %>%
  mutate(Genotiped = replace_na(Genotiped, FALSE)) # Se especifican los individuos no genotipados (NA) como FALSE.

# Matriz G ----

m_G_JAP_2 <- Matrix(m_G_JAP_2)

# Cálculo de la matriz H invertida ----

mH_I_JAP_2 <- fn.mH(ped = ped_JAP, mG = m_G_JAP_2) %>%
  saveRDS(here('Datos', 'Datos_JAP', 'mHI', 'mHI_2', 'mHI_2.RDS'))

mH_I_JAP_2[1:10, 1:10]
mH_I_JAP_2[240:250, 240:250]
mH_I_JAP_2[251:261, 251:261]
diag(mH_I_JAP_2)

## 3. Subpoblación con 75 individuos genotipados

dir.create('../Datos/Datos_JAP/mHI/mHI_3') # Se crea el directorio donde se guardara la matriz H invertida para la subpoblación de 51 individuos genotipados.

# Pedigrí ----

famsnps_JAP <- read_fam(here('Datos', 'Datos_JAP', 'Soft_Molcoanc', 'nSNPs_JAP.fam')) %>% # Se importa el archivo .fam obtenido usando plink y que posteriomente se uso para crear la hoja de parámetros para ejecutar el software molcoanc.
  select(fam) %>%
  mutate(id = 251:416)

ped_JAP_75 <- read_delim(here('Datos', 'Datos_JAP', 'mG', 'mG_3', 'subpob_JAP.txt'), delim = '\t', col_names = FALSE) %>% # Se importa el conjunto de datos donde esta la identificación de los 75 individuos genotipados.
  select(X1) %>%
  rename(fam = X1) %>%
  right_join(x = famsnps_JAP, by = 'fam') %>%
  mutate(Genotiped = TRUE) %>% # Se indica con TRUE que estos individuos estan genotipados.
  select(-fam)

ped_JAP <- read_delim(here('Datos', 'Datos_JAP', 'Soft_Molcoanc', 'Molcoanc_2', 'geneal_JAP.csv'), delim = ' ') %>% # Se importa el pedigrí creado son el software molcoanc.
  na_if(0) %>% # Para usar la función para calcular la matriz A y su inversa, todos los padres y madres faltantes (en este caso 0), deben estar como NA.
  full_join(y = ped_JAP_75, by = 'id') %>%
  mutate(Genotiped = replace_na(Genotiped, FALSE)) # Se especifican los individuos no genotipados (NA) como FALSE.

# Matriz G ----

m_G_JAP_3 <- Matrix(m_G_JAP_3)

# Cálculo de la matriz H invertida ----

mH_I_JAP_3 <- fn.mH(ped = ped_JAP, mG = m_G_JAP_3) %>%
  saveRDS(here('Datos', 'Datos_JAP', 'mHI', 'mHI_3', 'mHI_3.RDS'))

mH_I_JAP_3[1:10, 1:10]
mH_I_JAP_3[240:250, 240:250]
mH_I_JAP_3[251:261, 251:261]
diag(mH_I_JAP_3)

## 4. Subpoblación con 92 individuos genotipados

dir.create('../Datos/Datos_JAP/mHI/mHI_4') # Se crea el directorio donde se guardara la matriz H invertida para la subpoblación de 68 individuos genotipados.

# Pedigrí ----

famsnps_JAP <- read_fam(here('Datos', 'Datos_JAP', 'Soft_Molcoanc', 'nSNPs_JAP.fam')) %>% # Se importa el archivo .fam obtenido usando plink y que posteriomente se uso para crear la hoja de parámetros para ejecutar el software molcoanc.
  select(fam) %>%
  mutate(id = 251:416)

ped_JAP_92 <- read_delim(here('Datos', 'Datos_JAP', 'mG', 'mG_4', 'subpob_JAP.txt'), delim = '\t', col_names = FALSE) %>% # Se importa el conjunto de datos donde esta la identificación de los 92 individuos genotipados.
  select(X1) %>%
  rename(fam = X1) %>%
  right_join(x = famsnps_JAP, by = 'fam') %>%
  mutate(Genotiped = TRUE) %>% # Se indica con TRUE que estos individuos estan genotipados.
  select(-fam)

ped_JAP <- read_delim(here('Datos', 'Datos_JAP', 'Soft_Molcoanc', 'Molcoanc_2', 'geneal_JAP.csv'), delim = ' ') %>% # Se importa el pedigrí creado son el software molcoanc.
  na_if(0) %>% # Para usar la función para calcular la matriz A y su inversa, todos los padres y madres faltantes (en este caso 0), deben estar como NA.
  full_join(y = ped_JAP_92, by = 'id') %>%
  mutate(Genotiped = replace_na(Genotiped, FALSE)) # Se especifican los individuos no genotipados (NA) como FALSE.

# Matriz G ----

m_G_JAP_4 <- Matrix(m_G_JAP_4)

# Cálculo de la matriz H invertida ----

mH_I_JAP_4 <- fn.mH(ped = ped_JAP, mG = m_G_JAP_4) %>%
  saveRDS(here('Datos', 'Datos_JAP', 'mHI', 'mHI_4', 'mHI_4.RDS'))

mH_I_JAP_4[1:10, 1:10]
mH_I_JAP_4[240:250, 240:250]
mH_I_JAP_4[251:261, 251:261]
diag(mH_I_JAP_4)

## 5. Subpoblación con 109 individuos genotipados

dir.create('../Datos/Datos_JAP/mHI/mHI_5') # Se crea el directorio donde se guardara la matriz H invertida para la subpoblación de 109 individuos genotipados.

# Pedigrí ----

famsnps_JAP <- read_fam(here('Datos', 'Datos_JAP', 'Soft_Molcoanc', 'nSNPs_JAP.fam')) %>% # Se importa el archivo .fam obtenido usando plink y que posteriomente se uso para crear la hoja de parámetros para ejecutar el software molcoanc.
  select(fam) %>%
  mutate(id = 251:416)

ped_JAP_109 <- read_delim(here('Datos', 'Datos_JAP', 'mG', 'mG_5', 'subpob_JAP.txt'), delim = '\t', col_names = FALSE) %>% # Se importa el conjunto de datos donde esta la identificación de los 109 individuos genotipados.
  select(X1) %>%
  rename(fam = X1) %>%
  right_join(x = famsnps_JAP, by = 'fam') %>%
  mutate(Genotiped = TRUE) %>% # Se indica con TRUE que estos individuos estan genotipados.
  select(-fam)

ped_JAP <- read_delim(here('Datos', 'Datos_JAP', 'Soft_Molcoanc', 'Molcoanc_2', 'geneal_JAP.csv'), delim = ' ') %>% # Se importa el pedigrí creado son el software molcoanc.
  na_if(0) %>% # Para usar la función para calcular la matriz A y su inversa, todos los padres y madres faltantes (en este caso 0), deben estar como NA.
  full_join(y = ped_JAP_109, by = 'id') %>%
  mutate(Genotiped = replace_na(Genotiped, FALSE)) # Se especifican los individuos no genotipados (NA) como FALSE.

# Matriz G ----

m_G_JAP_5 <- Matrix(m_G_JAP_5)

# Cálculo de la matriz H invertida ----

mH_I_JAP_5 <- fn.mH(ped = ped_JAP, mG = m_G_JAP_5) %>%
  saveRDS(here('Datos', 'Datos_JAP', 'mHI', 'mHI_5', 'mHI_5.RDS'))

mH_I_JAP_5[1:10, 1:10]
mH_I_JAP_5[240:250, 240:250]
mH_I_JAP_5[251:261, 251:261]
diag(mH_I_JAP_5)

## 6. Subpoblación con 126 individuos genotipados

dir.create('../Datos/Datos_JAP/mHI/mHI_6') # Se crea el directorio donde se guardara la matriz H invertida para la subpoblación de 126 individuos genotipados.

# Pedigrí ----

famsnps_JAP <- read_fam(here('Datos', 'Datos_JAP', 'Soft_Molcoanc', 'nSNPs_JAP.fam')) %>% # Se importa el archivo .fam obtenido usando plink y que posteriomente se uso para crear la hoja de parámetros para ejecutar el software molcoanc.
  select(fam) %>%
  mutate(id = 251:416)

ped_JAP_126 <- read_delim(here('Datos', 'Datos_JAP', 'mG', 'mG_6', 'subpob_JAP.txt'), delim = '\t', col_names = FALSE) %>% # Se importa el conjunto de datos donde esta la identificación de los 126 individuos genotipados.
  select(X1) %>%
  rename(fam = X1) %>%
  right_join(x = famsnps_JAP, by = 'fam') %>%
  mutate(Genotiped = TRUE) %>% # Se indica con TRUE que estos individuos estan genotipados.
  select(-fam)

ped_JAP <- read_delim(here('Datos', 'Datos_JAP', 'Soft_Molcoanc', 'Molcoanc_2', 'geneal_JAP.csv'), delim = ' ') %>% # Se importa el pedigrí creado son el software molcoanc.
  na_if(0) %>% # Para usar la función para calcular la matriz A y su inversa, todos los padres y madres faltantes (en este caso 0), deben estar como NA.
  full_join(y = ped_JAP_126, by = 'id') %>%
  mutate(Genotiped = replace_na(Genotiped, FALSE)) # Se especifican los individuos no genotipados (NA) como FALSE.

# Matriz G ----

m_G_JAP_6 <- Matrix(m_G_JAP_6)

# Cálculo de la matriz H invertida ----

mH_I_JAP_6 <- fn.mH(ped = ped_JAP, mG = m_G_JAP_6) %>%
  saveRDS(here('Datos', 'Datos_JAP', 'mHI', 'mHI_6', 'mHI_6.RDS'))

mH_I_JAP_6[1:10, 1:10]
mH_I_JAP_6[240:250, 240:250]
mH_I_JAP_6[251:261, 251:261]
diag(mH_I_JAP_6)

## 7. Subpoblación con 143 individuos genotipados

dir.create('../Datos/Datos_JAP/mHI/mHI_7') # Se crea el directorio donde se guardara la matriz H invertida para la subpoblación de 143 individuos genotipados.

# Pedigrí ----

famsnps_JAP <- read_fam(here('Datos', 'Datos_JAP', 'Soft_Molcoanc', 'nSNPs_JAP.fam')) %>% # Se importa el archivo .fam obtenido usando plink y que posteriomente se uso para crear la hoja de parámetros para ejecutar el software molcoanc.
  select(fam) %>%
  mutate(id = 251:416)

ped_JAP_143 <- read_delim(here('Datos', 'Datos_JAP', 'mG', 'mG_7', 'subpob_JAP.txt'), delim = '\t', col_names = FALSE) %>% # Se importa el conjunto de datos donde esta la identificación de los 143 individuos genotipados.
  select(X1) %>%
  rename(fam = X1) %>%
  right_join(x = famsnps_JAP, by = 'fam') %>%
  mutate(Genotiped = TRUE) %>% # Se indica con TRUE que estos individuos estan genotipados.
  select(-fam)

ped_JAP <- read_delim(here('Datos', 'Datos_JAP', 'Soft_Molcoanc', 'Molcoanc_2', 'geneal_JAP.csv'), delim = ' ') %>% # Se importa el pedigrí creado son el software molcoanc.
  na_if(0) %>% # Para usar la función para calcular la matriz A y su inversa, todos los padres y madres faltantes (en este caso 0), deben estar como NA.
  full_join(y = ped_JAP_143, by = 'id') %>%
  mutate(Genotiped = replace_na(Genotiped, FALSE)) # Se especifican los individuos no genotipados (NA) como FALSE.

# Matriz G ----

m_G_JAP_7 <- Matrix(m_G_JAP_7)

# Cálculo de la matriz H invertida ----

mH_I_JAP_7 <- fn.mH(ped = ped_JAP, mG = m_G_JAP_7) %>%
  saveRDS(here('Datos', 'Datos_JAP', 'mHI', 'mHI_7', 'mHI_7.RDS'))

mH_I_JAP_7[1:10, 1:10]
mH_I_JAP_7[240:250, 240:250]
mH_I_JAP_7[251:261, 251:261]
diag(mH_I_JAP_7)

## 8. Subpoblación con 166 individuos genotipados

dir.create('../Datos/Datos_JAP/mHI/mHI_8') # Se crea el directorio donde se guardara la matriz H invertida para la subpoblación de 166 individuos genotipados.

# Pedigrí ----

famsnps_JAP <- read_fam(here('Datos', 'Datos_JAP', 'Soft_Molcoanc', 'nSNPs_JAP.fam')) %>% # Se importa el archivo .fam obtenido usando plink y que posteriomente se uso para crear la hoja de parámetros para ejecutar el software molcoanc.
  select(fam) %>%
  mutate(id = 251:416)

ped_JAP_166 <- read_delim(here('Datos', 'Datos_JAP', 'mG', 'mG_8', 'subpob_JAP.txt'), delim = '\t', col_names = FALSE) %>% # Se importa el conjunto de datos donde esta la identificación de los 166 individuos genotipados.
  select(X1) %>%
  rename(fam = X1) %>%
  right_join(x = famsnps_JAP, by = 'fam') %>%
  mutate(Genotiped = TRUE) %>% # Se indica con TRUE que estos individuos estan genotipados.
  select(-fam)

ped_JAP <- read_delim(here('Datos', 'Datos_JAP', 'Soft_Molcoanc', 'Molcoanc_2', 'geneal_JAP.csv'), delim = ' ') %>% # Se importa el pedigrí creado son el software molcoanc.
  na_if(0) %>% # Para usar la función para calcular la matriz A y su inversa, todos los padres y madres faltantes (en este caso 0), deben estar como NA.
  full_join(y = ped_JAP_166, by = 'id') %>%
  mutate(Genotiped = replace_na(Genotiped, FALSE)) # Se especifican los individuos no genotipados (NA) como FALSE.

# Matriz G ----

m_G_JAP_8 <- Matrix(m_G_JAP_8)

# Cálculo de la matriz H invertida ----

mH_I_JAP_8 <- fn.mH(ped = ped_JAP, mG = m_G_JAP_8) %>%
  saveRDS(here('Datos', 'Datos_JAP', 'mHI', 'mHI_8', 'mHI_8.RDS'))

mH_I_JAP_8[1:10, 1:10]
mH_I_JAP_8[240:250, 240:250]
mH_I_JAP_8[251:261, 251:261]
diag(mH_I_JAP_8)

#### Población de arroz AUS ----

dir.create('../Datos/Datos_AUS/mHI') # Se crea el directorio donde se guardara la matriz H invertida para cada una de las subpoblaciones de individuos genotipados.

## 1. Subpoblación con 10 individuos genotipados

dir.create('../Datos/Datos_AUS/mHI/mHI_1') # Se crea el directorio donde se guardara la matriz H invertida para la subpoblación de 10 individuos genotipados.

# Pedigrí ----

famsnps_AUS <- read_fam(here('Datos', 'Datos_AUS', 'Soft_Molcoanc', 'nSNPs_AUS.fam')) %>% # Se importa el archivo .fam obtenido usando plink y que posteriomente se uso para crear la hoja de parámetros para ejecutar el software molcoanc.
  select(fam) %>%
  mutate(id = 126:200)

ped_AUS_10 <- read_delim(here('Datos', 'Datos_AUS', 'mG', 'mG_1', 'subpob_AUS.txt'), delim = '\t', col_names = FALSE) %>% # Se importa el conjunto de datos donde esta la identificación de los 10 individuos genotipados.
  select(X1) %>%
  rename(fam = X1) %>%
  right_join(x = famsnps_AUS, by = 'fam') %>%
  mutate(Genotiped = TRUE) %>% # Se indica con TRUE que estos individuos estan genotipados.
  select(-fam)

ped_AUS <- read_delim(here('Datos', 'Datos_AUS', 'Soft_Molcoanc', 'Molcoanc_2', 'geneal_AUS.csv'), delim = ' ') %>% # Se importa el pedigrí creado son el software molcoanc.
  na_if(0) %>% # Para usar la función para calcular la matriz A y su inversa, todos los padres y madres faltantes (en este caso 0), deben estar como NA.
  full_join(y = ped_AUS_10, by = 'id') %>%
  mutate(Genotiped = replace_na(Genotiped, FALSE)) # Se especifican los individuos no genotipados (NA) como FALSE.

# Matriz G ----

m_G_AUS_1 <- Matrix(m_G_AUS_1)

# Cálculo de la matriz H invertida ----

mH_I_AUS_1 <- fn.mH(ped = ped_AUS, mG = m_G_AUS_1) %>%
  saveRDS(here('Datos', 'Datos_AUS', 'mHI', 'mHI_1', 'mHI_1.RDS'))

mH_I_AUS_1[1:10, 1:10]
mH_I_AUS_1[190:200, 190:200]
mH_I_AUS_1[126:136, 126:136]
diag(mH_I_AUS_1)

## 2. Subpoblación con 19 individuos genotipados

dir.create('../Datos/Datos_AUS/mHI/mHI_2') # Se crea el directorio donde se guardara la matriz H invertida para la subpoblación de 19 individuos genotipados.

# Pedigrí ----

famsnps_AUS <- read_fam(here('Datos', 'Datos_AUS', 'Soft_Molcoanc', 'nSNPs_AUS.fam')) %>% # Se importa el archivo .fam obtenido usando plink y que posteriomente se uso para crear la hoja de parámetros para ejecutar el software molcoanc.
  select(fam) %>%
  mutate(id = 126:200)

ped_AUS_19 <- read_delim(here('Datos', 'Datos_AUS', 'mG', 'mG_2', 'subpob_AUS.txt'), delim = '\t', col_names = FALSE) %>% # Se importa el conjunto de datos donde esta la identificación de los 19 individuos genotipados.
  select(X1) %>%
  rename(fam = X1) %>%
  right_join(x = famsnps_AUS, by = 'fam') %>%
  mutate(Genotiped = TRUE) %>% # Se indica con TRUE que estos individuos estan genotipados.
  select(-fam)

ped_AUS <- read_delim(here('Datos', 'Datos_AUS', 'Soft_Molcoanc', 'Molcoanc_2', 'geneal_AUS.csv'), delim = ' ') %>% # Se importa el pedigrí creado son el software molcoanc.
  na_if(0) %>% # Para usar la función para calcular la matriz A y su inversa, todos los padres y madres faltantes (en este caso 0), deben estar como NA.
  full_join(y = ped_AUS_19, by = 'id') %>%
  mutate(Genotiped = replace_na(Genotiped, FALSE)) # Se especifican los individuos no genotipados (NA) como FALSE.

# Matriz G ----

m_G_AUS_2 <- Matrix(m_G_AUS_2)

# Cálculo de la matriz H invertida ----

mH_I_AUS_2 <- fn.mH(ped = ped_AUS, mG = m_G_AUS_2) %>%
  saveRDS(here('Datos', 'Datos_AUS', 'mHI', 'mHI_2', 'mHI_2.RDS'))

mH_I_AUS_2[1:10, 1:10]
mH_I_AUS_2[190:200, 190:200]
mH_I_AUS_2[126:136, 126:136]
diag(mH_I_AUS_2)

## 3. Subpoblación con 28 individuos genotipados

dir.create('../Datos/Datos_AUS/mHI/mHI_3') # Se crea el directorio donde se guardara la matriz H invertida para la subpoblación de 28 individuos genotipados.

# Pedigrí ----

famsnps_AUS <- read_fam(here('Datos', 'Datos_AUS', 'Soft_Molcoanc', 'nSNPs_AUS.fam')) %>% # Se importa el archivo .fam obtenido usando plink y que posteriomente se uso para crear la hoja de parámetros para ejecutar el software molcoanc.
  select(fam) %>%
  mutate(id = 126:200)

ped_AUS_28 <- read_delim(here('Datos', 'Datos_AUS', 'mG', 'mG_3', 'subpob_AUS.txt'), delim = '\t', col_names = FALSE) %>% # Se importa el conjunto de datos donde esta la identificación de los 28 individuos genotipados.
  select(X1) %>%
  rename(fam = X1) %>%
  right_join(x = famsnps_AUS, by = 'fam') %>%
  mutate(Genotiped = TRUE) %>% # Se indica con TRUE que estos individuos estan genotipados.
  select(-fam)

ped_AUS <- read_delim(here('Datos', 'Datos_AUS', 'Soft_Molcoanc', 'Molcoanc_2', 'geneal_AUS.csv'), delim = ' ') %>% # Se importa el pedigrí creado son el software molcoanc.
  na_if(0) %>% # Para usar la función para calcular la matriz A y su inversa, todos los padres y madres faltantes (en este caso 0), deben estar como NA.
  full_join(y = ped_AUS_28, by = 'id') %>%
  mutate(Genotiped = replace_na(Genotiped, FALSE)) # Se especifican los individuos no genotipados (NA) como FALSE.

# Matriz G ----

m_G_AUS_3 <- Matrix(m_G_AUS_3)

# Cálculo de la matriz H invertida ----

mH_I_AUS_3 <- fn.mH(ped = ped_AUS, mG = m_G_AUS_3) %>%
  saveRDS(here('Datos', 'Datos_AUS', 'mHI', 'mHI_3', 'mHI_3.RDS'))

mH_I_AUS_3[1:10, 1:10]
mH_I_AUS_3[190:200, 190:200]
mH_I_AUS_3[126:136, 126:136]
diag(mH_I_AUS_3)

## 4. Subpoblación con 37 individuos genotipados

dir.create('../Datos/Datos_AUS/mHI/mHI_4') # Se crea el directorio donde se guardara la matriz H invertida para la subpoblación de 37 individuos genotipados.

# Pedigrí ----

famsnps_AUS <- read_fam(here('Datos', 'Datos_AUS', 'Soft_Molcoanc', 'nSNPs_AUS.fam')) %>% # Se importa el archivo .fam obtenido usando plink y que posteriomente se uso para crear la hoja de parámetros para ejecutar el software molcoanc.
  select(fam) %>%
  mutate(id = 126:200)

ped_AUS_37 <- read_delim(here('Datos', 'Datos_AUS', 'mG', 'mG_4', 'subpob_AUS.txt'), delim = '\t', col_names = FALSE) %>% # Se importa el conjunto de datos donde esta la identificación de los 37 individuos genotipados.
  select(X1) %>%
  rename(fam = X1) %>%
  right_join(x = famsnps_AUS, by = 'fam') %>%
  mutate(Genotiped = TRUE) %>% # Se indica con TRUE que estos individuos estan genotipados.
  select(-fam)

ped_AUS <- read_delim(here('Datos', 'Datos_AUS', 'Soft_Molcoanc', 'Molcoanc_2', 'geneal_AUS.csv'), delim = ' ') %>% # Se importa el pedigrí creado son el software molcoanc.
  na_if(0) %>% # Para usar la función para calcular la matriz A y su inversa, todos los padres y madres faltantes (en este caso 0), deben estar como NA.
  full_join(y = ped_AUS_37, by = 'id') %>%
  mutate(Genotiped = replace_na(Genotiped, FALSE)) # Se especifican los individuos no genotipados (NA) como FALSE.

# Matriz G ----

m_G_AUS_4 <- Matrix(m_G_AUS_4)

# Cálculo de la matriz H invertida ----

mH_I_AUS_4 <- fn.mH(ped = ped_AUS, mG = m_G_AUS_4) %>%
  saveRDS(here('Datos', 'Datos_AUS', 'mHI', 'mHI_4', 'mHI_4.RDS'))

mH_I_AUS_4[1:10, 1:10]
mH_I_AUS_4[190:200, 190:200]
mH_I_AUS_4[126:136, 126:136]
diag(mH_I_AUS_4)

## 5. Subpoblación con 46 individuos genotipados

dir.create('../Datos/Datos_AUS/mHI/mHI_5') # Se crea el directorio donde se guardara la matriz H invertida para la subpoblación de 46 individuos genotipados.

# Pedigrí ----

famsnps_AUS <- read_fam(here('Datos', 'Datos_AUS', 'Soft_Molcoanc', 'nSNPs_AUS.fam')) %>% # Se importa el archivo .fam obtenido usando plink y que posteriomente se uso para crear la hoja de parámetros para ejecutar el software molcoanc.
  select(fam) %>%
  mutate(id = 126:200)

ped_AUS_46 <- read_delim(here('Datos', 'Datos_AUS', 'mG', 'mG_5', 'subpob_AUS.txt'), delim = '\t', col_names = FALSE) %>% # Se importa el conjunto de datos donde esta la identificación de los 46 individuos genotipados.
  select(X1) %>%
  rename(fam = X1) %>%
  right_join(x = famsnps_AUS, by = 'fam') %>%
  mutate(Genotiped = TRUE) %>% # Se indica con TRUE que estos individuos estan genotipados.
  select(-fam)

ped_AUS <- read_delim(here('Datos', 'Datos_AUS', 'Soft_Molcoanc', 'Molcoanc_2', 'geneal_AUS.csv'), delim = ' ') %>% # Se importa el pedigrí creado son el software molcoanc.
  na_if(0) %>% # Para usar la función para calcular la matriz A y su inversa, todos los padres y madres faltantes (en este caso 0), deben estar como NA.
  full_join(y = ped_AUS_46, by = 'id') %>%
  mutate(Genotiped = replace_na(Genotiped, FALSE)) # Se especifican los individuos no genotipados (NA) como FALSE.

# Matriz G ----

m_G_AUS_5 <- Matrix(m_G_AUS_5)

# Cálculo de la matriz H invertida ----

mH_I_AUS_5 <- fn.mH(ped = ped_AUS, mG = m_G_AUS_5) %>%
  saveRDS(here('Datos', 'Datos_AUS', 'mHI', 'mHI_5', 'mHI_5.RDS'))

mH_I_AUS_5[1:10, 1:10]
mH_I_AUS_5[190:200, 190:200]
mH_I_AUS_5[126:136, 126:136]
diag(mH_I_AUS_5)

## 6. Subpoblación con 55 individuos genotipados

dir.create('../Datos/Datos_AUS/mHI/mHI_6') # Se crea el directorio donde se guardara la matriz H invertida para la subpoblación de 55 individuos genotipados.

# Pedigrí ----

famsnps_AUS <- read_fam(here('Datos', 'Datos_AUS', 'Soft_Molcoanc', 'nSNPs_AUS.fam')) %>% # Se importa el archivo .fam obtenido usando plink y que posteriomente se uso para crear la hoja de parámetros para ejecutar el software molcoanc.
  select(fam) %>%
  mutate(id = 126:200)

ped_AUS_55 <- read_delim(here('Datos', 'Datos_AUS', 'mG', 'mG_6', 'subpob_AUS.txt'), delim = '\t', col_names = FALSE) %>% # Se importa el conjunto de datos donde esta la identificación de los 55 individuos genotipados.
  select(X1) %>%
  rename(fam = X1) %>%
  right_join(x = famsnps_AUS, by = 'fam') %>%
  mutate(Genotiped = TRUE) %>% # Se indica con TRUE que estos individuos estan genotipados.
  select(-fam)

ped_AUS <- read_delim(here('Datos', 'Datos_AUS', 'Soft_Molcoanc', 'Molcoanc_2', 'geneal_AUS.csv'), delim = ' ') %>% # Se importa el pedigrí creado son el software molcoanc.
  na_if(0) %>% # Para usar la función para calcular la matriz A y su inversa, todos los padres y madres faltantes (en este caso 0), deben estar como NA.
  full_join(y = ped_AUS_55, by = 'id') %>%
  mutate(Genotiped = replace_na(Genotiped, FALSE)) # Se especifican los individuos no genotipados (NA) como FALSE.

# Matriz G ----

m_G_AUS_6 <- Matrix(m_G_AUS_6)

# Cálculo de la matriz H invertida ----

mH_I_AUS_6 <- fn.mH(ped = ped_AUS, mG = m_G_AUS_6) %>%
  saveRDS(here('Datos', 'Datos_AUS', 'mHI', 'mHI_6', 'mHI_6.RDS'))

mH_I_AUS_6[1:10, 1:10]
mH_I_AUS_6[190:200, 190:200]
mH_I_AUS_6[126:136, 126:136]
diag(mH_I_AUS_6)

## 7. Subpoblación con 64 individuos genotipados

dir.create('../Datos/Datos_AUS/mHI/mHI_7') # Se crea el directorio donde se guardara la matriz H invertida para la subpoblación de 64 individuos genotipados.

# Pedigrí ----

famsnps_AUS <- read_fam(here('Datos', 'Datos_AUS', 'Soft_Molcoanc', 'nSNPs_AUS.fam')) %>% # Se importa el archivo .fam obtenido usando plink y que posteriomente se uso para crear la hoja de parámetros para ejecutar el software molcoanc.
  select(fam) %>%
  mutate(id = 126:200)

ped_AUS_64 <- read_delim(here('Datos', 'Datos_AUS', 'mG', 'mG_7', 'subpob_AUS.txt'), delim = '\t', col_names = FALSE) %>% # Se importa el conjunto de datos donde esta la identificación de los 64 individuos genotipados.
  select(X1) %>%
  rename(fam = X1) %>%
  right_join(x = famsnps_AUS, by = 'fam') %>%
  mutate(Genotiped = TRUE) %>% # Se indica con TRUE que estos individuos estan genotipados.
  select(-fam)

ped_AUS <- read_delim(here('Datos', 'Datos_AUS', 'Soft_Molcoanc', 'Molcoanc_2', 'geneal_AUS.csv'), delim = ' ') %>% # Se importa el pedigrí creado son el software molcoanc.
  na_if(0) %>% # Para usar la función para calcular la matriz A y su inversa, todos los padres y madres faltantes (en este caso 0), deben estar como NA.
  full_join(y = ped_AUS_64, by = 'id') %>%
  mutate(Genotiped = replace_na(Genotiped, FALSE)) # Se especifican los individuos no genotipados (NA) como FALSE.

# Matriz G ----

m_G_AUS_7 <- Matrix(m_G_AUS_7)

# Cálculo de la matriz H invertida ----

mH_I_AUS_7 <- fn.mH(ped = ped_AUS, mG = m_G_AUS_7) %>%
  saveRDS(here('Datos', 'Datos_AUS', 'mHI', 'mHI_7', 'mHI_7.RDS'))

mH_I_AUS_7[1:10, 1:10]
mH_I_AUS_7[190:200, 190:200]
mH_I_AUS_7[126:136, 126:136]
diag(mH_I_AUS_7)

## 8. Subpoblación con 75 individuos genotipados

dir.create('../Datos/Datos_AUS/mHI/mHI_8') # Se crea el directorio donde se guardara la matriz H invertida para la subpoblación de 75 individuos genotipados.

# Pedigrí ----

famsnps_AUS <- read_fam(here('Datos', 'Datos_AUS', 'Soft_Molcoanc', 'nSNPs_AUS.fam')) %>% # Se importa el archivo .fam obtenido usando plink y que posteriomente se uso para crear la hoja de parámetros para ejecutar el software molcoanc.
  select(fam) %>%
  mutate(id = 126:200)

ped_AUS_75 <- read_delim(here('Datos', 'Datos_AUS', 'mG', 'mG_8', 'subpob_AUS.txt'), delim = '\t', col_names = FALSE) %>% # Se importa el conjunto de datos donde esta la identificación de los 75 individuos genotipados.
  select(X1) %>%
  rename(fam = X1) %>%
  right_join(x = famsnps_AUS, by = 'fam') %>%
  mutate(Genotiped = TRUE) %>% # Se indica con TRUE que estos individuos estan genotipados.
  select(-fam)

ped_AUS <- read_delim(here('Datos', 'Datos_AUS', 'Soft_Molcoanc', 'Molcoanc_2', 'geneal_AUS.csv'), delim = ' ') %>% # Se importa el pedigrí creado son el software molcoanc.
  na_if(0) %>% # Para usar la función para calcular la matriz A y su inversa, todos los padres y madres faltantes (en este caso 0), deben estar como NA.
  full_join(y = ped_AUS_75, by = 'id') %>%
  mutate(Genotiped = replace_na(Genotiped, FALSE)) # Se especifican los individuos no genotipados (NA) como FALSE.

# Matriz G ----

m_G_AUS_8 <- Matrix(m_G_AUS_8)

# Cálculo de la matriz H invertida ----

mH_I_AUS_8 <- fn.mH(ped = ped_AUS, mG = m_G_AUS_8) %>%
  saveRDS(here('Datos', 'Datos_AUS', 'mHI', 'mHI_8', 'mHI_8.RDS'))

mH_I_AUS_8[1:10, 1:10]
mH_I_AUS_8[190:200, 190:200]
mH_I_AUS_8[126:136, 126:136]
diag(mH_I_AUS_8)
```

# 8. A continuación se ajustan los modelos usando el paquete BGLR.

```{r Ajuste de modelos con BGLR}

# 1. Se importan las bases de datos de fenotipo y de linea mejorada.

Fenotipos <- read_delim(here('Datos', 'all.phenotypes.csv'), delim = ',')
lin_mej <- read_delim(here('Datos', 'iris_pedigree.csv'), delim = ',')

#### Población de arroz IND ----

# 2. Se crea un conjunto de datos que contiene solo los individuos mejorados.

Pob_mej <- lin_mej %>%
  filter(Status_with_Pedigree.plus.knowledge == 'I') %>% # Conjunto de datos solo con los individuos mejorados (los que se clasificaron como "I").
  select(X3K_DNA_IRIS_UNIQUE_ID) %>%
  rename(Variety = X3K_DNA_IRIS_UNIQUE_ID)

escalado <- function(x) { # Función usada para escalar el fenotipo.
  (x - mean(x, na.rm = TRUE)) / sd(x, na.rm = TRUE)
  }

Pob_IND <- Fenotipos %>%
  filter(SNPsubsp == 'IND') %>% # Conjunto de datos solo con la especie IND.
  mutate(
    Variety_2 = Variety,
    Fen_escalado = escalado(Time.to.flowering..from.sowing)
    ) %>%
  separate(
    col = Variety,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  ' '
  ) %>%
  unite(
    col = Variety,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  separate(
    col = Variety,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  '-'
  ) %>%
  unite(
    col = Variety,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  separate(
    col = Variety_2,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  ' '
  ) %>%
  unite(
    col = Variety_2,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  inner_join(y = Pob_mej, by = 'Variety') %>%
  select(Variety_2, Fen_escalado) %>% # Se creo el conjunto de datos con los individuos mejorados de la población indica.
  mutate(Fen_escalado = NA) %>% # Los fenotipos de estos individuos se deben colocar como NAs al formar parte de la población de validación cruzada, y al ser los individuos que se quieren predecir.
  rename(Variety = Variety_2)

# 3. Se crea un conjunto de datos que no contiene los individuos mejorados.

Pob_IND_2 <- Fenotipos %>%
  filter(SNPsubsp == 'IND') %>% # Conjunto de datos solo con la especie IND.
  mutate(
    Variety_2 = Variety,
    Fen_escalado = escalado(Time.to.flowering..from.sowing)
    ) %>%
  separate(
    col = Variety,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  ' '
  ) %>%
  unite(
    col = Variety,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  separate(
    col = Variety,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  '-'
  ) %>%
  unite(
    col = Variety,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  separate(
    col = Variety_2,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  ' '
  ) %>%
  unite(
    col = Variety_2,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  anti_join(Pob_mej, by = 'Variety') %>%
  select(Variety_2, Fen_escalado) %>% # Se creo el conjunto de datos con los individuos no mejorados de la población indica.
  rename(Variety = Variety_2)

# 4. Se importa el archivo .fam obtenido usando plink y que posteriomente se uso para crear la hoja de parámetros para ejecutar el software molcoanc.

famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'nSNPs_IND.fam')) %>% 
  select(fam) %>%
  mutate(id = 501:951) %>%
  rename(Variety = fam)

# 5. Se unen en un solo conjuntos de datos los individuos mejorados y no mejorados.

Pob_IND_3 <- Pob_IND_2 %>%
  left_join(y = famsnps_IND, by = 'Variety') # Se unen al conjunto de datos anterior (famsnps_IND) debido a que aquí esta la identificación numérica como esta en el pedigrí.

Pob_IND_4 <- Pob_IND %>%
  left_join(y = famsnps_IND, by = 'Variety') %>% # Se unen al conjunto de datos famsnps_IND debido a que aquí esta la identificación numérica como esta en el pedigrí.
  bind_rows(Pob_IND_3) %>% # Se une por filas al conjunto de datos de individuos no mejorados anterior Pob_IND_3.
  select(-Variety) %>%
  relocate(
    Fen_escalado,
    .after = id
    )

# 6. Se crea un conjunto de datos donde estaran los fenotipos de los individuos con pedigrí simulado mediante el software molcoanc, y se une posteriormente con el conjunto de datos anterior.

Pob_IND_5 <- tibble(
  id = seq(from = 1, to = 500, by = 1),
  Fen_escalado = rep(x = NA, times = 500)
  ) %>%
  bind_rows(Pob_IND_4) %>%
  arrange(id)

######################
# Uso del paquete BGLR
######################

dir.create('../Datos/Datos_IND/Den_100.000/mod_BGLR') # Se crea una carpeta donde se guardaran los resultados de los modelos que se ajustaran para las distintas subpoblaciones de individuos genotipados.

## 1. Subpoblación con 98 individuos genotipados

# a) Se preparan los datos de entrada ----

mH_IND_1 <- readRDS(here('Datos', 'Datos_IND', 'Den_100.000', 'mH', 'mH_1', 'mH_1.RDS')) # Se carga la matriz H de los 98 individuos genotipados de la población IND.

Fen_IND <- Pob_IND_5 %>%
  pull(Fen_escalado) # Se extrae del conjunto de datos de fenotipos el fenotipo de interes en forma de vector.

# b) Se configura el predictor lineal ----

ETA = list(list(K = mH_IND_1, model = 'RKHS'))

# c) Se ajusta el modelo ----

dir.create('../Datos/Datos_IND/Den_100.000/mod_BGLR/mod_BGLR_1/') # Se crea una carpeta para guardar los resultados del modelo anteriormente ajustado para 98 indiviuos genotipados.

mod_IND_1 <- BGLR(y = Fen_IND, ETA = ETA, nIter = 50000, burnIn = 10000, saveAt = '../Repo_TFM/Datos/Datos_IND/Den_100.000/mod_BGLR/mod_BGLR_1/ssgblup_')

save(mod_IND_1, file = '../Repo_TFM/Datos/Datos_IND/Den_100.000/mod_BGLR/mod_BGLR_1/mod_BGLR_1.RData')

## 2. Subpoblación con 148 individuos genotipados

# a) Se preparan los datos de entrada ----

mH_IND_2 <- readRDS(here('Datos', 'Datos_IND', 'Den_100.000', 'mH', 'mH_2', 'mH_2.RDS')) # Se carga la matriz H de los 148 individuos genotipados de la población IND.

Fen_IND <- Pob_IND_5 %>%
  pull(Fen_escalado) # Se extrae del conjunto de datos de fenotipos el fenotipo de interes en forma de vector.

# b) Se configura el predictor lineal ----

ETA = list(list(K = mH_IND_2, model = 'RKHS'))

# c) Se ajusta el modelo ----

dir.create('../Datos/Datos_IND/Den_100.000/mod_BGLR/mod_BGLR_2/') # Se crea una carpeta para guardar los resultados del modelo anteriormente ajustado para 148 indiviuos genotipados.

mod_IND_2 <- BGLR(y = Fen_IND, ETA = ETA, nIter = 50000, burnIn = 10000, saveAt = '../Repo_TFM/Datos/Datos_IND/Den_100.000/mod_BGLR/mod_BGLR_2/ssgblup_')

save(mod_IND_2, file = '../Repo_TFM/Datos/Datos_IND/Den_100.000/mod_BGLR/mod_BGLR_2/mod_BGLR_2.RData')

## 3. Subpoblación con 198 individuos genotipados

# a) Se preparan los datos de entrada ----

mH_IND_3 <- readRDS(here('Datos', 'Datos_IND', 'Den_100.000', 'mH', 'mH_3', 'mH_3.RDS')) # Se carga la matriz H de los 198 individuos genotipados de la población IND.

Fen_IND <- Pob_IND_5 %>%
  pull(Fen_escalado) # Se extrae del conjunto de datos de fenotipos el fenotipo de interes en forma de vector.

# b) Se configura el predictor lineal ----

ETA = list(list(K = mH_IND_3, model = 'RKHS'))

# c) Se ajusta el modelo ----

dir.create('../Datos/Datos_IND/Den_100.000/mod_BGLR/mod_BGLR_3/') # Se crea una carpeta para guardar los resultados del modelo anteriormente ajustado para 198 indiviuos genotipados.

mod_IND_3 <- BGLR(y = Fen_IND, ETA = ETA, nIter = 50000, burnIn = 10000, saveAt = '../Repo_TFM/Datos/Datos_IND/Den_100.000/mod_BGLR/mod_BGLR_3/ssgblup_')

save(mod_IND_3, file = '../Repo_TFM/Datos/Datos_IND/Den_100.000/mod_BGLR/mod_BGLR_3/mod_BGLR_3.RData')

## 4. Subpoblación con 248 individuos genotipados

# a) Se preparan los datos de entrada ----

mH_IND_4 <- readRDS(here('Datos', 'Datos_IND', 'Den_100.000', 'mH', 'mH_4', 'mH_4.RDS')) # Se carga la matriz H de los 248 individuos genotipados de la población IND.

Fen_IND <- Pob_IND_5 %>%
  pull(Fen_escalado) # Se extrae del conjunto de datos de fenotipos el fenotipo de interes en forma de vector.

# b) Se configura el predictor lineal ----

ETA = list(list(K = mH_IND_4, model = 'RKHS'))

# c) Se ajusta el modelo ----

dir.create('../Datos/Datos_IND/Den_100.000/mod_BGLR/mod_BGLR_4/') # Se crea una carpeta para guardar los resultados del modelo anteriormente ajustado para 248 indiviuos genotipados.

mod_IND_4 <- BGLR(y = Fen_IND, ETA = ETA, nIter = 50000, burnIn = 10000, saveAt = '../Repo_TFM/Datos/Datos_IND/Den_100.000/mod_BGLR/mod_BGLR_4/ssgblup_')

save(mod_IND_4, file = '../Repo_TFM/Datos/Datos_IND/Den_100.000/mod_BGLR/mod_BGLR_4/mod_BGLR_4.RData')

## 5. Subpoblación con 298 individuos genotipados

# a) Se preparan los datos de entrada ----

mH_IND_5 <- readRDS(here('Datos', 'Datos_IND', 'Den_100.000', 'mH', 'mH_5', 'mH_5.RDS')) # Se carga la matriz H de los 298 individuos genotipados de la población IND.

Fen_IND <- Pob_IND_5 %>%
  pull(Fen_escalado) # Se extrae del conjunto de datos de fenotipos el fenotipo de interes en forma de vector.

# b) Se configura el predictor lineal ----

ETA = list(list(K = mH_IND_5, model = 'RKHS'))

# c) Se ajusta el modelo ----

dir.create('../Datos/Datos_IND/Den_100.000/mod_BGLR/mod_BGLR_5/') # Se crea una carpeta para guardar los resultados del modelo anteriormente ajustado para 298 indiviuos genotipados.

mod_IND_5 <- BGLR(y = Fen_IND, ETA = ETA, nIter = 50000, burnIn = 10000, saveAt = '../Repo_TFM/Datos/Datos_IND/Den_100.000/mod_BGLR/mod_BGLR_5/ssgblup_')

save(mod_IND_5, file = '../Repo_TFM/Datos/Datos_IND/Den_100.000/mod_BGLR/mod_BGLR_5/mod_BGLR_5.RData')

## 6. Subpoblación con 348 individuos genotipados

# a) Se preparan los datos de entrada ----

mH_IND_6 <- readRDS(here('Datos', 'Datos_IND', 'Den_100.000', 'mH', 'mH_6', 'mH_6.RDS')) # Se carga la matriz H de los 348 individuos genotipados de la población IND.

Fen_IND <- Pob_IND_5 %>%
  pull(Fen_escalado) # Se extrae del conjunto de datos de fenotipos el fenotipo de interes en forma de vector.

# b) Se configura el predictor lineal ----

ETA = list(list(K = mH_IND_6, model = 'RKHS'))

# c) Se ajusta el modelo ----

dir.create('../Datos/Datos_IND/Den_100.000/mod_BGLR/mod_BGLR_6/') # Se crea una carpeta para guardar los resultados del modelo anteriormente ajustado para 348 indiviuos genotipados.

mod_IND_6 <- BGLR(y = Fen_IND, ETA = ETA, nIter = 50000, burnIn = 10000, saveAt = '../Repo_TFM/Datos/Datos_IND/Den_100.000/mod_BGLR/mod_BGLR_6/ssgblup_')

save(mod_IND_6, file = '../Repo_TFM/Datos/Datos_IND/Den_100.000/mod_BGLR/mod_BGLR_6/mod_BGLR_6.RData')

## 7. Subpoblación con 398 individuos genotipados

# a) Se preparan los datos de entrada ----

mH_IND_7 <- readRDS(here('Datos', 'Datos_IND', 'Den_100.000', 'mH', 'mH_7', 'mH_7.RDS')) # Se carga la matriz H de los 398 individuos genotipados de la población IND.

Fen_IND <- Pob_IND_5 %>%
  pull(Fen_escalado) # Se extrae del conjunto de datos de fenotipos el fenotipo de interes en forma de vector.

# b) Se configura el predictor lineal ----

ETA = list(list(K = mH_IND_7, model = 'RKHS'))

# c) Se ajusta el modelo ----

dir.create('../Datos/Datos_IND/Den_100.000/mod_BGLR/mod_BGLR_7/') # Se crea una carpeta para guardar los resultados del modelo anteriormente ajustado para 398 indiviuos genotipados.

mod_IND_7 <- BGLR(y = Fen_IND, ETA = ETA, nIter = 50000, burnIn = 10000, saveAt = '../Repo_TFM/Datos/Datos_IND/Den_100.000/mod_BGLR/mod_BGLR_7/ssgblup_')

save(mod_IND_7, file = '../Repo_TFM/Datos/Datos_IND/Den_100.000/mod_BGLR/mod_BGLR_7/mod_BGLR_7.RData')

## 8. Subpoblación con 451 individuos genotipados

# a) Se preparan los datos de entrada ----

mH_IND_8 <- readRDS(here('Datos', 'Datos_IND', 'Den_100.000', 'mH', 'mH_8', 'mH_8.RDS')) # Se carga la matriz H de los 451 individuos genotipados de la población IND.

Fen_IND <- Pob_IND_5 %>%
  pull(Fen_escalado) # Se extrae del conjunto de datos de fenotipos el fenotipo de interes en forma de vector.

# b) Se configura el predictor lineal ----

ETA = list(list(K = mH_IND_8, model = 'RKHS'))

# c) Se ajusta el modelo ----

dir.create('../Datos/Datos_IND/Den_100.000/mod_BGLR/mod_BGLR_8/') # Se crea una carpeta para guardar los resultados del modelo anteriormente ajustado para 451 indiviuos genotipados.

mod_IND_8 <- BGLR(y = Fen_IND, ETA = ETA, nIter = 50000, burnIn = 10000, saveAt = '../Repo_TFM/Datos/Datos_IND/Den_100.000/mod_BGLR/mod_BGLR_8/ssgblup_')

save(mod_IND_8, file = '../Repo_TFM/Datos/Datos_IND/Den_100.000/mod_BGLR/mod_BGLR_8/mod_BGLR_8.RData')
```

# 9. A continuación se analizan los resultados obtenidos al correr los datos con el paquete de R BGLR.

```{r Resultados con el paquete BGLR}

# 1. Se importan las bases de datos de feotipos y de linea mejorada.

lin_mej <- read_delim(here('Datos', 'iris_pedigree.csv'), delim = ',')
Fenotipos <- read_delim(here('Datos', 'all.phenotypes.csv'), delim = ',')

#### Población de arroz IND ----

dir.create('../Datos/Datos_IND/Resultados') # Se crea una carpeta donde se guardaran los resultados.

# 2. Se importa el archivo .fam obtenido usando plink y que posteriomente se uso para crear la hoja de parámetros para ejecutar el software molcoanc.

famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'nSNPs_IND.fam')) %>% 
  select(fam) %>%
  mutate(id = 501:951) %>%
  rename(Variety = fam)

# 3. Se crea un conjunto de datos que contiene solo los individuos mejorados.

Pob_mej <- lin_mej %>%
  filter(Status_with_Pedigree.plus.knowledge == 'I') %>% # Conjunto de datos solo con los individuos mejorados (los que se clasificaron como "I").
  select(X3K_DNA_IRIS_UNIQUE_ID) %>%
  rename(Variety = X3K_DNA_IRIS_UNIQUE_ID)

escalado <- function(x) { # Función usada para escalar el fenotipo.
  (x - mean(x, na.rm = TRUE)) / sd(x, na.rm = TRUE)
  }

Pob_IND <- Fenotipos %>%
  filter(SNPsubsp == 'IND') %>% # Conjunto de datos solo con la especie IND.
  mutate(
    Variety_2 = Variety,
    Fen_escalado = escalado(Time.to.flowering..from.sowing)
    ) %>%
  separate(
    col = Variety,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  ' '
  ) %>%
  unite(
    col = Variety,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  separate(
    col = Variety,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  '-'
  ) %>%
  unite(
    col = Variety,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  separate(
    col = Variety_2,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  ' '
  ) %>%
  unite(
    col = Variety_2,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  inner_join(y = Pob_mej, by = 'Variety') %>%
  select(Variety_2, Fen_escalado) %>% # Se creo el conjunto de datos con los individuos mejorados de la población indica.
  rename(Variety = Variety_2)

Pob_IND_2 <- Pob_IND %>%
  left_join(y = famsnps_IND, by = 'Variety') # Se unen al conjunto de datos famsnps_IND debido a que aquí esta la identificación numérica como esta en el pedigrí.

## Subpoblación con 98 individuos genotipados ----

load(here('Datos', 'Datos_IND', 'Den_100.000', 'mod_BGLR', 'mod_BGLR_1', 'mod_BGLR_1.RData'))

Pred_IND_1 <- mod_IND_1$yHat %>%
  as_tibble() %>%
  mutate(Subpoblación = '98') %>%
  rowid_to_column(var = 'id') %>%
  right_join(y = Pob_IND_2, by = 'id')  %>%
  rename(
    'Fenotipo_predicho' = value,
    'Fenotipo_observado' = Fen_escalado
    )

Pred_IND_1 %>%
  drop_na() %>%
  summarise(cor(Fenotipo_observado, Fenotipo_predicho)) # Dio una correlación de 0.587

varE <- scan(here('Datos', 'Datos_IND', 'Den_100.000', 'mod_BGLR', 'mod_BGLR_1', 'ssgblup_varE.dat'))
varU <- scan(here('Datos', 'Datos_IND', 'Den_100.000', 'mod_BGLR', 'mod_BGLR_1', 'ssgblup_ETA_1_varU.dat'))
h2_IND_1 <- varU/(varU + varE) %>%
  as_tibble() %>%
  summarise(
    h2 = mean(value)
    ) %>%
  rename('98' = h2)

## Subpoblación con 148 individuos genotipados ----

load(here('Datos', 'Datos_IND', 'Den_100.000', 'mod_BGLR', 'mod_BGLR_2', 'mod_BGLR_2.RData'))

Pred_IND_2 <- mod_IND_2$yHat %>%
  as_tibble() %>%
  mutate(Subpoblación = '148') %>%
  rowid_to_column(var = 'id') %>%
  right_join(y = Pob_IND_2, by = 'id')  %>%
  rename(
    'Fenotipo_predicho' = value,
    'Fenotipo_observado' = Fen_escalado
    )

Pred_IND_2 %>%
  drop_na() %>%
  summarise(cor(Fenotipo_observado, Fenotipo_predicho)) # Dio una correlación de 0.532

varE <- scan(here('Datos', 'Datos_IND', 'Den_100.000', 'mod_BGLR', 'mod_BGLR_2', 'ssgblup_varE.dat'))
varU <- scan(here('Datos', 'Datos_IND', 'Den_100.000', 'mod_BGLR', 'mod_BGLR_2', 'ssgblup_ETA_1_varU.dat'))
h2_IND_2 <- varU/(varU + varE) %>%
  as_tibble() %>%
  summarise(
    h2 = mean(value)
    ) %>%
  rename('148' = h2)

## Subpoblación con 198 individuos genotipados ----

load(here('Datos', 'Datos_IND', 'Den_100.000', 'mod_BGLR', 'mod_BGLR_3', 'mod_BGLR_3.RData'))

Pred_IND_3 <- mod_IND_3$yHat %>%
  as_tibble() %>%
  mutate(Subpoblación = '198') %>%
  rowid_to_column(var = 'id') %>%
  right_join(y = Pob_IND_2, by = 'id')  %>%
  rename(
    'Fenotipo_predicho' = value,
    'Fenotipo_observado' = Fen_escalado
    )

Pred_IND_3 %>%
  drop_na() %>%
  summarise(cor(Fenotipo_observado, Fenotipo_predicho)) # Dio una correlación de 0.595

varE <- scan(here('Datos', 'Datos_IND', 'Den_100.000', 'mod_BGLR', 'mod_BGLR_3', 'ssgblup_varE.dat'))
varU <- scan(here('Datos', 'Datos_IND', 'Den_100.000', 'mod_BGLR', 'mod_BGLR_3', 'ssgblup_ETA_1_varU.dat'))
h2_IND_3 <- varU/(varU + varE) %>%
  as_tibble() %>%
  summarise(
    h2 = mean(value)
    ) %>%
  rename('198' = h2)

## Subpoblación con 248 individuos genotipados ----

load(here('Datos', 'Datos_IND', 'Den_100.000', 'mod_BGLR', 'mod_BGLR_4', 'mod_BGLR_4.RData'))

Pred_IND_4 <- mod_IND_4$yHat %>%
  as_tibble() %>%
  mutate(Subpoblación = '248') %>%
  rowid_to_column(var = 'id') %>%
  right_join(y = Pob_IND_2, by = 'id')  %>%
  rename(
    'Fenotipo_predicho' = value,
    'Fenotipo_observado' = Fen_escalado
    )

Pred_IND_4 %>%
  drop_na() %>%
  summarise(cor(Fenotipo_observado, Fenotipo_predicho)) # Dio una correlación de 0.555

varE <- scan(here('Datos', 'Datos_IND', 'Den_100.000', 'mod_BGLR', 'mod_BGLR_4', 'ssgblup_varE.dat'))
varU <- scan(here('Datos', 'Datos_IND', 'Den_100.000', 'mod_BGLR', 'mod_BGLR_4', 'ssgblup_ETA_1_varU.dat'))
h2_IND_4 <- varU/(varU + varE) %>%
  as_tibble() %>%
  summarise(
    h2 = mean(value)
    ) %>%
  rename('248' = h2)

## Subpoblación con 298 individuos genotipados ----

load(here('Datos', 'Datos_IND', 'Den_100.000', 'mod_BGLR', 'mod_BGLR_5', 'mod_BGLR_5.RData'))

Pred_IND_5 <- mod_IND_5$yHat %>%
  as_tibble() %>%
  mutate(Subpoblación = '298') %>%
  rowid_to_column(var = 'id') %>%
  right_join(y = Pob_IND_2, by = 'id')  %>%
  rename(
    'Fenotipo_predicho' = value,
    'Fenotipo_observado' = Fen_escalado
    )

Pred_IND_5 %>%
  drop_na() %>%
  summarise(cor(Fenotipo_observado, Fenotipo_predicho)) # Dio una correlación de 0.542

varE <- scan(here('Datos', 'Datos_IND', 'Den_100.000', 'mod_BGLR', 'mod_BGLR_5', 'ssgblup_varE.dat'))
varU <- scan(here('Datos', 'Datos_IND', 'Den_100.000', 'mod_BGLR', 'mod_BGLR_5', 'ssgblup_ETA_1_varU.dat'))
h2_IND_5 <- varU/(varU + varE) %>%
  as_tibble() %>%
  summarise(
    h2 = mean(value)
    ) %>%
  rename('298' = h2)

## Subpoblación con 348 individuos genotipados ----

load(here('Datos', 'Datos_IND', 'Den_100.000', 'mod_BGLR', 'mod_BGLR_6', 'mod_BGLR_6.RData'))

Pred_IND_6 <- mod_IND_6$yHat %>%
  as_tibble() %>%
  mutate(Subpoblación = '348') %>%
  rowid_to_column(var = 'id') %>%
  right_join(y = Pob_IND_2, by = 'id')  %>%
  rename(
    'Fenotipo_predicho' = value,
    'Fenotipo_observado' = Fen_escalado
    )

Pred_IND_6 %>%
  drop_na() %>%
  summarise(cor(Fenotipo_observado, Fenotipo_predicho)) # Dio una correlación de 0.579

varE <- scan(here('Datos', 'Datos_IND', 'Den_100.000', 'mod_BGLR', 'mod_BGLR_6', 'ssgblup_varE.dat'))
varU <- scan(here('Datos', 'Datos_IND', 'Den_100.000', 'mod_BGLR', 'mod_BGLR_6', 'ssgblup_ETA_1_varU.dat'))
h2_IND_6 <- varU/(varU + varE) %>%
  as_tibble() %>%
  summarise(
    h2 = mean(value)
    ) %>%
  rename('348' = h2)

## Subpoblación con 398 individuos genotipados ----

load(here('Datos', 'Datos_IND', 'Den_100.000', 'mod_BGLR', 'mod_BGLR_7', 'mod_BGLR_7.RData'))

Pred_IND_7 <- mod_IND_7$yHat %>%
  as_tibble() %>%
  mutate(Subpoblación = '398') %>%
  rowid_to_column(var = 'id') %>%
  right_join(y = Pob_IND_2, by = 'id')  %>%
  rename(
    'Fenotipo_predicho' = value,
    'Fenotipo_observado' = Fen_escalado
    )

Pred_IND_7 %>%
  drop_na() %>%
  summarise(cor(Fenotipo_observado, Fenotipo_predicho)) # Dio una correlación de 0.565

varE <- scan(here('Datos', 'Datos_IND', 'Den_100.000', 'mod_BGLR', 'mod_BGLR_7', 'ssgblup_varE.dat'))
varU <- scan(here('Datos', 'Datos_IND', 'Den_100.000', 'mod_BGLR', 'mod_BGLR_7', 'ssgblup_ETA_1_varU.dat'))
h2_IND_7 <- varU/(varU + varE) %>%
  as_tibble() %>%
  summarise(
    h2 = mean(value)
    ) %>%
  rename('398' = h2)

## Subpoblación con 451 individuos genotipados ----

load(here('Datos', 'Datos_IND', 'Den_100.000', 'mod_BGLR', 'mod_BGLR_8', 'mod_BGLR_8.RData'))

Pred_IND_8 <- mod_IND_8$yHat %>%
  as_tibble() %>%
  mutate(Subpoblación = '451') %>%
  rowid_to_column(var = 'id') %>%
  right_join(y = Pob_IND_2, by = 'id')  %>%
  rename(
    'Fenotipo_predicho' = value,
    'Fenotipo_observado' = Fen_escalado
    )

Pred_IND_8 %>%
  drop_na() %>%
  summarise(cor(Fenotipo_observado, Fenotipo_predicho)) # Dio una correlación de 0.579

varE <- scan(here('Datos', 'Datos_IND', 'Den_100.000', 'mod_BGLR', 'mod_BGLR_8', 'ssgblup_varE.dat'))
varU <- scan(here('Datos', 'Datos_IND', 'Den_100.000', 'mod_BGLR', 'mod_BGLR_8', 'ssgblup_ETA_1_varU.dat'))
h2_IND_8 <- varU/(varU + varE) %>%
  as_tibble() %>%
  summarise(
    h2 = mean(value)
    ) %>%
  rename('451' = h2)

# 4. Se unen todos los datos anteriores de las distintas subpoblaciones de individuos. genotipados en un solo conjunto de datos

Pred_IND <- bind_rows(Pred_IND_1, Pred_IND_2, Pred_IND_3, Pred_IND_4, Pred_IND_5, Pred_IND_6, Pred_IND_7, Pred_IND_8) %>%
  arrange(id) %>%
  relocate(
    Variety,
    .after = id
  ) %>%
  relocate(
    Fenotipo_predicho,
    .after = Fenotipo_observado
  )

her_IND <- bind_cols(h2_IND_1, h2_IND_2, h2_IND_3, h2_IND_4, h2_IND_5, h2_IND_6, h2_IND_7, h2_IND_8) %>%
  pivot_longer(
    cols = 1:8,
    names_to = 'Individuos genotipados',
    values_to = 'Heredabilidad'
  ) %>%
  gt() %>%
  tab_header(
    title = 'Valores de heredabilidad para la población IND',
    )

#######################
# Gráfico de dispersión
#######################

Graf_disp_IND <- function(Subpoblación) { # La función la saque de esta dirección web: https://cmdlinetips.com/2021/05/functions-to-make-plots-with-ggplot2-in-r/
  Pred_IND %>%
    filter(.data$Subpoblación == .env$Subpoblación) %>%
    ggplot() +
    aes(x = Fenotipo_observado, y = Fenotipo_predicho) +
    geom_point(size = 3.4, colour = 'yellow', alpha = 0.6) +
    geom_smooth(color = 'black', fill = 'black', method = 'lm', se = FALSE) +
    stat_cor(p.accuracy = 0.001, r.accuracy = 0.01, colour = 'gray34', label.x = -2.00) +
    geom_rug(colour = 'gray') +
    scale_x_continuous(labels = label_number(accuracy = 0.01)) +
    scale_y_continuous(labels = label_number(accuracy = 0.01)) +
    ggtitle(glue('Individuos genotipados: {Subpoblación}')) +
    labs(x = 'Fenotipo observado', y = 'Fenotipo predicho') +
    theme_bw() +
    theme(
      axis.text = element_text(size = 9),
      axis.title = element_text(size = 10, face = 'bold'),
      plot.title = element_text(size = 8, face = 'bold'),
      legend.position = 'none'
      )
  }

Subpoblación <- c('98', '148', '198', '248', '298', '348', '398', '451')
Graf <- map(Subpoblación, Graf_disp_IND)
(Graf[[1]] | Graf[[2]] | Graf[[3]] | Graf[[4]]) / (Graf[[5]] | Graf[[6]] | Graf[[7]] | Graf[[8]])

Subpoblación_2 <- '348'
Graf_2 <- map(Subpoblación_2, Graf_disp_IND)
Graf_2 <- Graf_2[[1]] 
ggplotly(Graf_2)
```

# 10. A continuación se realiza un análisis de prueba sin información molecular (matiz A) y con información molecular (matriz G).

```{r Análisis de prueba}

# 1. Se importan las bases de datos de fenotipos y de linea mejorada.

lin_mej <- read_delim(here('Datos', 'iris_pedigree.csv'), delim = ',')
Fenotipos <- read_delim(here('Datos', 'all.phenotypes.csv'), delim = ',')

# 2. Se crea un conjunto de datos que contiene solo los individuos mejorados.

Pob_mej <- lin_mej %>%
  filter(Status_with_Pedigree.plus.knowledge == 'I') %>% # Conjunto de datos solo con los individuos mejorados (los que se clasificaron como "I").
  select(X3K_DNA_IRIS_UNIQUE_ID) %>%
  rename(Variety = X3K_DNA_IRIS_UNIQUE_ID)

Pob_IND <- Fenotipos %>%
  filter(SNPsubsp == 'IND') %>% # Conjunto de datos solo con la especie IND.
  mutate(
    Variety_2 = Variety,
    Fen_escalado = scale(Time.to.flowering..from.sowing)
    ) %>%
  separate(
    col = Variety,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  ' '
  ) %>%
  unite(
    col = Variety,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  separate(
    col = Variety,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  '-'
  ) %>%
  unite(
    col = Variety,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  separate(
    col = Variety_2,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  ' '
  ) %>%
  unite(
    col = Variety_2,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  inner_join(y = Pob_mej, by = 'Variety') %>%
  select(Variety_2, Fen_escalado) %>% # Se creo el conjunto de datos con los individuos mejorados de la población indica.
  mutate(Fen_escalado = NA) %>% # Los fenotipos de estos individuos se deben colocar como NAs al formar parte de la población de validación cruzada, y al ser los individuos que se quieren predecir.
  rename(Variety = Variety_2)

# 3. Se crea un conjunto de datos que no contiene los individuos mejorados.

Pob_IND_2 <- Fenotipos %>%
  filter(SNPsubsp == 'IND') %>% # Conjunto de datos solo con la especie IND.
  mutate(
    Variety_2 = Variety,
    Fen_escalado = scale(Time.to.flowering..from.sowing)
    ) %>%
  separate(
    col = Variety,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  ' '
  ) %>%
  unite(
    col = Variety,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  separate(
    col = Variety,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  '-'
  ) %>%
  unite(
    col = Variety,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  separate(
    col = Variety_2,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  ' '
  ) %>%
  unite(
    col = Variety_2,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  anti_join(Pob_mej, by = 'Variety') %>%
  select(Variety_2, Fen_escalado) %>% # Se creo el conjunto de datos con los individuos no mejorados de la población indica.
  rename(Variety = Variety_2)

# 4. Se importa el archivo .fam obtenido usando plink y que posteriomente se uso para crear la hoja de parámetros para ejecutar el software molcoanc.

famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'nSNPs_IND.fam')) %>% 
  select(fam) %>%
  mutate(id = 501:951) %>%
  rename(Variety = fam)

# 5. Se unen en un solo conjuntos de datos los individuos mejorados y no mejorados.

Pob_IND_3 <- Pob_IND_2 %>%
  left_join(y = famsnps_IND, by = 'Variety') # Se unen al conjunto de datos anterior (famsnps_IND) debido a que aquí esta la identificación numérica como esta en el pedigrí.

Pob_IND_4 <- Pob_IND %>%
  left_join(y = famsnps_IND, by = 'Variety') %>% # Se unen al conjunto de datos famsnps_IND debido a que aquí esta la identificación numérica como esta en el pedigrí.
  bind_rows(Pob_IND_3) %>% # Se une por filas al conjunto de datos de individuos no mejorados anterior Pob_IND_3.
  select(-Variety) %>%
  relocate(
    Fen_escalado,
    .after = id
    )

# 6. Se crea un conjunto de datos donde estaran los fenotipos de los individuos con pedigrí simulado mediante el software molcoanc, y se une posteriormente con el conjunto de datos anterior.

Pob_IND_5 <- tibble(
  id = seq(from = 1, to = 500, by = 1),
  Fen_escalado = rep(x = NA, times = 500)
  ) %>%
  bind_rows(Pob_IND_4) %>%
  arrange(id)

# 8. Se extrae la columna de fenotipos en forma de vector.

Fen_IND <- Pob_IND_5 %>%
  pull(Fen_escalado) %>%
  saveRDS(here('Datos', 'Datos_IND', 'Den_100.000', 'mod_BGLR', 'mod_prueba', 'Fenotipo_IND.RDS'))

dir.create('../Datos/Datos_IND/Den_100.000/mod_BGLR/mod_prueba/') # Se crean dos carpetas donde se guardaran los resultados de las pruebas a continuación.
dir.create('../Datos/Datos_IND/Den_100.000/mod_BGLR/mod_prueba/Resultados')

###########################
# Sin información molecular
###########################

# 9. Se importa la base de datos del pedigrí resultante de la simulación con el software molcoanc.

ped_IND <- read_delim(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'Molcoanc_10', 'geneal_IND.csv'), delim = ' ') %>%
  na_if(0) # Para usar la función para calcular la matriz A y su inversa, todos los padres y madres faltantes (en este caso 0), deben estar como NA.

# 10. Se calcula la matriz de relación basada en el pedigrí (A).

ped_edit_IND <- editPed( # Esta función ordena el pedigrí.
  sire = ped_IND$sire,
  dam = ped_IND$dam,
  label = ped_IND$id
  )

pedi_IND <- pedigree( # Aquí se usa la salida anterior (ya ordenado) y se crea un objeto de clase pedigree.
  sire = ped_edit_IND$sire,
  dam = ped_edit_IND$dam,
  label = ped_edit_IND$label
  )

Matrix_A <- getA(ped = pedi_IND) # Esto dara la matriz de relaciones aditivas A.

# 11. Se usa el paquete BGLR para hacer la predicción.

# a) Se preparan los datos de entrada:

mA_IND <- Matrix_A %>%
  as.matrix() %>%
  saveRDS(here('Datos', 'Datos_IND', 'Den_100.000', 'mod_BGLR', 'mod_prueba', 'mA_IND.RDS'))

mA_IND <- readRDS(here('Datos', 'Datos_IND', 'Den_100.000', 'mod_BGLR', 'mod_prueba', 'mA_IND.RDS'))

Fenotipo_IND <- readRDS(here('Datos', 'Datos_IND', 'Den_100.000', 'mod_BGLR', 'mod_prueba', 'Fenotipo_IND.RDS'))

# b) Se configura el predictor lineal:

ETA = list(list(K = mA_IND, model = 'RKHS'))

# c) Se ajusta el modelo:

mod_prueba_IND_1 <- BGLR(y = Fen_IND, ETA = ETA, nIter = 50000, burnIn = 10000, saveAt = '../Datos/Datos_IND/Den_100.000/mod_BGLR/mod_prueba/ablup_')

save(mod_prueba_IND_1, file = '../Datos/Datos_IND/Den_100.000/mod_BGLR/mod_prueba/mod_prueba_1.RData')

# 12. Se analizan los resultados.

load(here('Datos', 'Datos_IND', 'Den_100.000', 'mod_BGLR', 'mod_prueba', 'mod_prueba_1.RData')) # Se carga el conjunto de datos con los resultados de la modelación.

Pob_IND_6 <- Fenotipos %>%
  filter(SNPsubsp == 'IND') %>%
  mutate(
    Variety_2 = Variety,
    Fen_escalado = scale(Time.to.flowering..from.sowing)
    ) %>%
  separate(
    col = Variety,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  ' '
  ) %>%
  unite(
    col = Variety,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  separate(
    col = Variety,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  '-'
  ) %>%
  unite(
    col = Variety,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  separate(
    col = Variety_2,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  ' '
  ) %>%
  unite(
    col = Variety_2,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  inner_join(y = Pob_mej, by = 'Variety') %>%
  select(Variety_2, Fen_escalado) %>%
  rename(Variety = Variety_2) %>%
  left_join(y = famsnps_IND, by = 'Variety')
  
Pred_IND_prueba_1 <- mod_prueba_IND_1$yHat %>%
  as_tibble() %>%
  mutate(Matriz = 'Matriz_A') %>%
  rowid_to_column(var = 'id') %>%
  right_join(y = Pob_IND_6, by = 'id')  %>%
  rename(
    'Fenotipo_predicho' = value,
    'Fenotipo_observado' = Fen_escalado
    )

Pred_IND_prueba_1 %>%
  drop_na() %>%
  summarise(Correlacion = cor(Fenotipo_observado, Fenotipo_predicho)) # Dio una correlación de 0.545

varE <- scan(here('Datos', 'Datos_IND', 'Den_100.000', 'mod_BGLR', 'mod_prueba', 'ablup_varE.dat'))
varU <- scan(here('Datos', 'Datos_IND', 'Den_100.000', 'mod_BGLR', 'mod_prueba', 'ablup_ETA_1_varU.dat'))
h2_IND_prueba_1 <- varU/(varU + varE) %>%
  as_tibble() %>%
  summarise(
    h2 = mean(value)
    ) %>%
  rename('A' = h2)

###########################
# Con información molecular
###########################

# 9. Se importan las base de datos resultantes al editar la información con plink.

bimsnps_IND <- read_bim(here('Datos', 'Datos_IND', 'Den_100.000', 'mG', 'mG_8', 'frec_0.05_IND.bim'))
famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Den_100.000', 'mG', 'mG_8', 'frec_0.05_IND.fam'))
bedsnps_IND <- BEDMatrix(here('Datos', 'Datos_IND', 'Den_100.000', 'mG', 'mG_8', 'frec_0.05_IND.bed'), n = length(famsnps_IND$id), p = length(bimsnps_IND$id), simple_names = FALSE)
snps_IND <- as.matrix(bedsnps_IND)

# 10. Se calcula la matriz de relación basada en la información molecular (G-1).

Matrix_G <- Gmatrix(SNPmatrix = snps_IND, method = 'VanRaden') # Aquí se calculo la matriz de parentesco genómico a partir de lo propuesto por VanRaden (2008).

mG_IND <- Matrix_G %>%
  as.matrix() %>%
  saveRDS(here('Datos', 'Datos_IND', 'Den_100.000', 'mod_BGLR', 'mod_prueba', 'mG_IND.RDS'))

# 11. Se usa el paquete BGLR para hacer la predicción.

# a) Se preparan los datos de entrada:

mG_IND <- readRDS(here('Datos', 'Datos_IND', 'Den_100.000', 'mod_BGLR', 'mod_prueba', 'mG_IND.RDS'))

Fen_IND <- Fen_IND %>%
  as_tibble() %>%
  slice(501:951) %>%
  pull(V1)

# b) Se configura el predictor lineal:

ETA = list(list(K = mG_IND, model = 'RKHS'))

# c) Se ajusta el modelo:

mod_prueba_IND_2 <- BGLR(y = Fen_IND, ETA = ETA, nIter = 50000, burnIn = 10000, saveAt = '../Datos/Datos_IND/Den_100.000/mod_BGLR/mod_prueba/gblup_')

save(mod_prueba_IND_2, file = '../Datos/Datos_IND/Den_100.000/mod_BGLR/mod_prueba/mod_prueba_2.RData')

# 12. Se analizan los resultados.

load(here('Datos', 'Datos_IND', 'Den_100.000', 'mod_BGLR', 'mod_prueba', 'mod_prueba_2.RData')) # Se carga el conjunto de datos con los resultados de la modelación.

Pred_IND_prueba_2 <- mod_prueba_IND_2$yHat %>%
  as_tibble() %>%
  mutate(Matriz = 'Matriz_G') %>%
  mutate(id = 501:951) %>%
  right_join(y = Pob_IND_6, by = 'id')  %>%
  rename(
    'Fenotipo_predicho' = value,
    'Fenotipo_observado' = Fen_escalado
    ) %>%
  relocate(
    id,
    .before = Fenotipo_predicho
    )

Pred_IND_prueba_2 %>%
  drop_na() %>%
  summarise(Correlacion = cor(Fenotipo_observado, Fenotipo_predicho)) # Dio una correlación de 0.588

varE <- scan(here('Datos', 'Datos_IND', 'Den_100.000', 'mod_BGLR', 'mod_prueba', 'gblup_varE.dat'))
varU <- scan(here('Datos', 'Datos_IND', 'Den_100.000', 'mod_BGLR', 'mod_prueba', 'gblup_ETA_1_varU.dat'))
h2_IND_prueba_2 <- varU/(varU + varE) %>%
  as_tibble() %>%
  summarise(
    h2 = mean(value)
    ) %>%
  rename('G' = h2)

#######################
# Gráfico de dispersión
#######################

Pred_IND_prueba <- bind_rows(Pred_IND_prueba_1, Pred_IND_prueba_2) %>%
  arrange(id) %>%
  relocate(
    Variety,
    .after = id
  ) %>%
  relocate(
    Fenotipo_predicho,
    .after = Fenotipo_observado
  )

Graf_disp_IND <- function(Matriz) { # La función la saque de esta dirección web: https://cmdlinetips.com/2021/05/functions-to-make-plots-with-ggplot2-in-r/
  Pred_IND_prueba %>%
    filter(.data$Matriz == .env$Matriz) %>%
    ggplot() +
    aes(x = Fenotipo_observado, y = Fenotipo_predicho) +
    geom_point(size = 3.4, colour = 'yellow', alpha = 0.6) +
    geom_smooth(color = 'black', fill = 'black', method = 'lm', se = FALSE) +
    stat_cor(p.accuracy = 0.001, r.accuracy = 0.01, colour = 'gray34', label.x = -2.0) +
    geom_rug(colour = 'gray') +
    scale_x_continuous(labels = label_number(accuracy = 0.01)) +
    scale_y_continuous(labels = label_number(accuracy = 0.01)) +
    ggtitle(glue('Matriz: {Matriz}')) +
    labs(x = 'Fenotipo observado', y = 'Fenotipo predicho') +
    theme_bw() +
    theme(
      axis.text = element_text(size = 9),
      axis.title = element_text(size = 10, face = 'bold'),
      plot.title = element_text(size = 8, face = 'bold'),
      legend.position = 'none'
      )
  }

Matriz <- c('Matriz_A', 'Matriz_G')
Graf <- map(Matriz, Graf_disp_IND)
(Graf[[1]] | Graf[[2]] )

################
# Heredablidades
################

bind_cols(h2_IND_prueba_1, h2_IND_prueba_2) %>%
  pivot_longer(
    cols = 1:2,
    names_to = 'Tipo de matriz',
    values_to = 'Heredabilidad'
  ) %>%
  gt() %>%
  tab_header(
    title = 'Valores de heredabilidad',
    )
```

# 11. A continuación se calcula la matriz H de las distintas subpoblaciones de individuos genotipados y la matriz A en caso de ningún individuo genotipado, para distintos pedigríes.

```{r Calculo de la matriz H con distintos pedigrís}

fn.mH <- function(ped, mG) { # Esta función recibe como argumentos los datos con estructura (id | sire | dam | Gen (TRUE/FALSE)) y la matriz de relaciones genómicas.
  
  # 1. Se calcula la matriz de relaciones aditivas con base en el pedigrí (A)
  
  ped_edit <- editPed( # Esta función ordena el pedigrí.
    sire = ped$sire,
    dam = ped$dam,
    label = ped$id
    )
  pedi <- pedigree( # Aquí se usa la salida anterior (ya ordenado) y se crea un objeto de clase pedigree.
    sire = ped_edit$sire,
    dam = ped_edit$dam,
    label = ped_edit$label
  )
  Matrix_A <- getA(ped = pedi) # Esto dara la matriz de relaciones aditivas A.
 
  # 2. De lo anterior (Matriz_A) se extraen las partes correspondientes a individuos no genotipados (1) y genotipados (2)
  
  # Individuos no genotipados:
  A_11 <- Matrix_A[ped$Genotiped != 1, ped$Genotiped != 1]
  # Individuos genotipados:
  A_22 <- Matrix_A[ped$Genotiped == 1, ped$Genotiped == 1]
  # Individuos no genotipados (en filas) y genotipados (en columnas):
  A_12 <- Matrix_A[ped$Genotiped != 1, ped$Genotiped == 1]
  # Transpuesta de la anterior (individuos no genotipados en columnas y genotipados en filas):
  A_21 <- t(A_12)
  
  # 3. Se coloca el nombre de las filas y y de las columnas de la matriz G según los individuos genotipados
  
  rownames(mG) <- ped$id[ped$Genotiped == 1]
  colnames(mG) <- ped$id[ped$Genotiped == 1]
  
  # 4. Teniendo todos los componentes de la matriz H, se procede a su construcción y a calcular su inversa
  
  H_11 <- A_11 - 
    (A_12 %*% solve(A_22) %*% A_21) + 
    (A_12 %*% solve(A_22) %*% mG %*% solve(A_22) %*% A_21)
  H_12 <- A_12 %*% solve(A_22) %*% mG
  H_21 <- t(H_12)
  H_22 <- mG
  
  H_11_H_12 <- cbind(H_11, H_12)
  H_21_H_22 <- cbind(H_21, H_22)
  mH <- rbind(H_11_H_12, H_21_H_22)
  
  mH <- mH[order(as.numeric(rownames(mH))), order(as.numeric(colnames(mH)))]
  mH <- Matrix(mH)
  
  # 5. Finalmente se indica retornar la inversa de la matriz H (mH_1)
  
  return(mH)
  }

#### Población de arroz IND ----

dir.create('../Datos/Datos_IND/Den_100.000_b') # Se crea una carpeta donde se guardaran los resultados considerando una densidad de 100.000 SNPs, esta vez con cinco pedigríes distintos.

dir.create('../Datos/Datos_IND/Den_100.000_b/mH') # Se crea el directorio donde se guardara la matriz H para cada una de las subpoblaciones de individuos genotipados con distintos pedigrís.

#########################################################
# Pedigrí 1: 2000 individuos simulados en 10 generaciones
#########################################################

dir.create('../Datos/Datos_IND/Den_100.000_b/mH/Ped_1') # Se crea el directorio donde se guardara la matriz H para las subpoblaciones del pedigrí 1.

## 1. Subpoblación con 148 individuos genotipados

dir.create('../Datos/Datos_IND/Den_100.000_b/mH/Ped_1/mH_1') # Se crea el directorio donde se guardara la matriz H para la subpoblación con 148 individuos genotipados

# Pedigrí ----

famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'nSNPs_IND.fam')) %>% # Se importa el archivo .fam obtenido usando plink y que posteriomente se uso para crear la hoja de parámetros para ejecutar el software molcoanc.
  as_tibble() %>%
  select(fam) %>%
  mutate(id = 2001:2451)

ped_IND_148 <- read_delim(here('Datos', 'Datos_IND', 'Den_100.000', 'mG', 'mG_2', 'subpob_IND.txt'), delim = '\t', col_names = FALSE) %>% # Se importa el conjunto de datos donde esta la identificación de los 148 individuos genotipados.
  as_tibble() %>%
  select(X1) %>%
  rename(fam = X1) %>%
  right_join(x = famsnps_IND, by = 'fam') %>%
  mutate(Genotiped = TRUE) %>% # Se indica con TRUE que estos individuos estan genotipados.
  select(-fam)

ped_IND <- read_delim(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'Molcoanc_12', 'geneal_IND.csv'), delim = '\t') %>% # Se importa el pedigrí creado son el software molcoanc.
  na_if(0) %>% # Para usar la función para calcular la matriz A y su inversa, todos los padres y madres faltantes (en este caso 0), deben estar como NA.
  full_join(y = ped_IND_148, by = 'id') %>%
  mutate(Genotiped = replace_na(Genotiped, FALSE)) # Se especifican los individuos no genotipados (NA) como FALSE.

# Matriz G ----

mG_2_esc <- readRDS(here('Datos', 'Datos_IND', 'Den_100.000', 'mG', 'mG_2', 'mG_2_esc.RDS')) # Se carga la matriz de SPNs escalada de los 148 individuos genotipados de la población IND. 

m_G_IND_2 <- tcrossprod(mG_2_esc)/ncol(mG_2_esc)
diag(m_G_IND_2) = diag(m_G_IND_2) + 0.05

m_G_IND_2 <- Matrix(m_G_IND_2)

# Cálculo de la matriz H ----

mH_IND_2 <- fn.mH(ped = ped_IND, mG = m_G_IND_2) %>%
  saveRDS(here('Datos', 'Datos_IND', 'Den_100.000_b', 'mH', 'Ped_1', 'mH_1', 'mH_1.RDS'))

mH_IND_2[1:10, 1:10]
mH_IND_2[1990:2000, 1990:2000]
mH_IND_2[2001:2011, 2001:2011]
diag(mH_IND_2)

## 2. Subpoblación con 298 individuos genotipados

dir.create('../Datos/Datos_IND/Den_100.000_b/mH/Ped_1/mH_2') # Se crea el directorio donde se guardara la matriz H para la subpoblación de 298 individuos genotipados.

# Pedigrí ----

famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'nSNPs_IND.fam')) %>% # Se importa el archivo .fam obtenido usando plink y que posteriomente se uso para crear la hoja de parámetros para ejecutar el software molcoanc.
  as_tibble() %>%
  select(fam) %>%
  mutate(id = 2001:2451)

ped_IND_298 <- read_delim(here('Datos', 'Datos_IND', 'Den_100.000', 'mG', 'mG_5', 'subpob_IND.txt'), delim = '\t', col_names = FALSE) %>% # Se importa el conjunto de datos donde esta la identificación de los 298 individuos genotipados.
  as_tibble() %>%
  select(X1) %>%
  rename(fam = X1) %>%
  right_join(x = famsnps_IND, by = 'fam') %>%
  mutate(Genotiped = TRUE) %>% # Se indica con TRUE que estos individuos estan genotipados.
  select(-fam)

ped_IND <- read_delim(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'Molcoanc_12', 'geneal_IND.csv'), delim = '\t') %>% # Se importa el pedigrí creado son el software molcoanc.
  na_if(0) %>% # Para usar la función para calcular la matriz A y su inversa, todos los padres y madres faltantes (en este caso 0), deben estar como NA.
  full_join(y = ped_IND_298, by = 'id') %>%
  mutate(Genotiped = replace_na(Genotiped, FALSE)) # Se especifican los individuos no genotipados (NA) como FALSE.

# Matriz G ----

mG_5_esc <- readRDS(here('Datos', 'Datos_IND', 'Den_100.000', 'mG', 'mG_5', 'mG_5_esc.RDS')) # Se carga la matriz de SPNs escalada de los 298 individuos genotipados de la población IND. 

m_G_IND_5 <- tcrossprod(mG_5_esc)/ncol(mG_5_esc)
diag(m_G_IND_5) = diag(m_G_IND_5) + 0.05

m_G_IND_5 <- Matrix(m_G_IND_5)

# Cálculo de la matriz H ----

mH_IND_5 <- fn.mH(ped = ped_IND, mG = m_G_IND_5) %>%
  saveRDS(here('Datos', 'Datos_IND', 'Den_100.000_b', 'mH', 'Ped_1', 'mH_2', 'mH_2.RDS'))

mH_IND_5[1:10, 1:10]
mH_IND_5[1990:2000, 1990:2000]
mH_IND_5[2001:2011, 2001:2011]
diag(mH_IND_5)

## 3. Subpoblación con 451 individuos genotipados

dir.create('../Datos/Datos_IND/Den_100.000_b/mH/Ped_1/mH_3') # Se crea el directorio donde se guardara la matriz H para la subpoblación de 451 individuos genotipados.

# Pedigrí ----

famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'nSNPs_IND.fam')) %>% # Se importa el archivo .fam obtenido usando plink y que posteriomente se uso para crear la hoja de parámetros para ejecutar el software molcoanc.
  as_tibble() %>%
  select(fam) %>%
  mutate(id = 2001:2451)

ped_IND_451 <- read_delim(here('Datos', 'Datos_IND', 'Den_100.000', 'mG', 'mG_8', 'subpob_IND.txt'), delim = '\t', col_names = FALSE) %>% # Se importa el conjunto de datos donde esta la identificación de los 451 individuos genotipados.
  as_tibble() %>%
  select(X1) %>%
  rename(fam = X1) %>%
  right_join(x = famsnps_IND, by = 'fam') %>%
  mutate(Genotiped = TRUE) %>% # Se indica con TRUE que estos individuos estan genotipados.
  select(-fam)

ped_IND <- read_delim(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'Molcoanc_12', 'geneal_IND.csv'), delim = '\t') %>% # Se importa el pedigrí creado son el software molcoanc.
  na_if(0) %>% # Para usar la función para calcular la matriz A y su inversa, todos los padres y madres faltantes (en este caso 0), deben estar como NA.
  full_join(y = ped_IND_451, by = 'id') %>%
  mutate(Genotiped = replace_na(Genotiped, FALSE)) # Se especifican los individuos no genotipados (NA) como FALSE.

# Matriz G ----

mG_8_esc <- readRDS(here('Datos', 'Datos_IND', 'Den_100.000', 'mG', 'mG_8', 'mG_8_esc.RDS')) # Se carga la matriz de SPNs escalada de los 451 individuos genotipados de la población IND. 

m_G_IND_8 <- tcrossprod(mG_8_esc)/ncol(mG_8_esc)
diag(m_G_IND_8) = diag(m_G_IND_8) + 0.05

m_G_IND_8 <- Matrix(m_G_IND_8)

# Cálculo de la matriz H ----

mH_IND_8 <- fn.mH(ped = ped_IND, mG = m_G_IND_8) %>%
  saveRDS(here('Datos', 'Datos_IND', 'Den_100.000_b', 'mH', 'Ped_1', 'mH_3', 'mH_3.RDS'))

mH_IND_8[1:10, 1:10]
mH_IND_8[1990:2000, 1990:2000]
mH_IND_8[2001:2011, 2001:2011]
diag(mH_IND_8)

## 4. Subpoblación con ningún individuo genotipado

dir.create('../Datos/Datos_IND/Den_100.000_b/mH/Ped_1/mA') # Se crea el directorio donde se guardara la matriz H para la subpoblación con ningún individuo genotipado.

# Cálculo de la matriz A ----

ped_IND <- read_delim(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'Molcoanc_12', 'geneal_IND.csv'), delim = '\t') %>% # Se importa el pedigrí creado son el software molcoanc.
  na_if(0) # Para usar la función para calcular la matriz A y su inversa, todos los padres y madres faltantes (en este caso 0), deben estar como NA.

ped_edit_IND <- editPed( # Esta función ordena el pedigrí.
  sire = ped_IND$sire,
  dam = ped_IND$dam,
  label = ped_IND$id
  )

pedi_IND <- pedigree( # Aquí se usa la salida anterior (ya ordenado) y se crea un objeto de clase pedigree.
  sire = ped_edit_IND$sire,
  dam = ped_edit_IND$dam,
  label = ped_edit_IND$label
  )

mA_IND <- getA(ped = pedi_IND) %>% # Esto dara la matriz de relaciones aditivas A.
  saveRDS(here('Datos', 'Datos_IND', 'Den_100.000_b', 'mH', 'Ped_1', 'mA', 'mA.RDS'))

mA_IND[1:10, 1:10]
mA_IND[1990:2000, 1990:2000]
mA_IND[2001:2011, 2001:2011]
diag(mA_IND)

#######################################################
# Pedigrí 2: 520 individuos simulados en 4 generaciones
#######################################################

dir.create('../Datos/Datos_IND/Den_100.000_b/mH/Ped_2') # Se crea el directorio donde se guardara la matriz H para las subpoblaciones del pedigrí 2.

## 1. Subpoblación con 148 individuos genotipados

dir.create('../Datos/Datos_IND/Den_100.000_b/mH/Ped_2/mH_1') # Se crea el directorio donde se guardara la matriz H para la subpoblación con 148 individuos genotipados

# Pedigrí ----

famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'nSNPs_IND.fam')) %>% # Se importa el archivo .fam obtenido usando plink y que posteriomente se uso para crear la hoja de parámetros para ejecutar el software molcoanc.
  as_tibble() %>%
  select(fam) %>%
  mutate(id = 521:971)

ped_IND_148 <- read_delim(here('Datos', 'Datos_IND', 'Den_100.000', 'mG', 'mG_2', 'subpob_IND.txt'), delim = '\t', col_names = FALSE) %>% # Se importa el conjunto de datos donde esta la identificación de los 148 individuos genotipados.
  as_tibble() %>%
  select(X1) %>%
  rename(fam = X1) %>%
  right_join(x = famsnps_IND, by = 'fam') %>%
  mutate(Genotiped = TRUE) %>% # Se indica con TRUE que estos individuos estan genotipados.
  select(-fam)

ped_IND <- read_delim(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'Molcoanc_13', 'geneal_IND.csv'), delim = ' ') %>% # Se importa el pedigrí creado son el software molcoanc.
  na_if(0) %>% # Para usar la función para calcular la matriz A y su inversa, todos los padres y madres faltantes (en este caso 0), deben estar como NA.
  full_join(y = ped_IND_148, by = 'id') %>%
  mutate(Genotiped = replace_na(Genotiped, FALSE)) # Se especifican los individuos no genotipados (NA) como FALSE.

# Matriz G ----

mG_2_esc <- readRDS(here('Datos', 'Datos_IND', 'Den_100.000', 'mG', 'mG_2', 'mG_2_esc.RDS')) # Se carga la matriz de SPNs escalada de los 148 individuos genotipados de la población IND. 

m_G_IND_2 <- tcrossprod(mG_2_esc)/ncol(mG_2_esc)
diag(m_G_IND_2) = diag(m_G_IND_2) + 0.05

m_G_IND_2 <- Matrix(m_G_IND_2)

# Cálculo de la matriz H ----

mH_IND_2 <- fn.mH(ped = ped_IND, mG = m_G_IND_2) %>%
  saveRDS(here('Datos', 'Datos_IND', 'Den_100.000_b', 'mH', 'Ped_2', 'mH_1', 'mH_1.RDS'))

mH_IND_2[1:10, 1:10]
mH_IND_2[510:520, 510:520]
mH_IND_2[521:531, 521:531]
diag(mH_IND_2)

## 2. Subpoblación con 298 individuos genotipados

dir.create('../Datos/Datos_IND/Den_100.000_b/mH/Ped_2/mH_2') # Se crea el directorio donde se guardara la matriz H para la subpoblación de 298 individuos genotipados.

# Pedigrí ----

famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'nSNPs_IND.fam')) %>% # Se importa el archivo .fam obtenido usando plink y que posteriomente se uso para crear la hoja de parámetros para ejecutar el software molcoanc.
  as_tibble() %>%
  select(fam) %>%
  mutate(id = 521:971)

ped_IND_298 <- read_delim(here('Datos', 'Datos_IND', 'Den_100.000', 'mG', 'mG_5', 'subpob_IND.txt'), delim = '\t', col_names = FALSE) %>% # Se importa el conjunto de datos donde esta la identificación de los 298 individuos genotipados.
  as_tibble() %>%
  select(X1) %>%
  rename(fam = X1) %>%
  right_join(x = famsnps_IND, by = 'fam') %>%
  mutate(Genotiped = TRUE) %>% # Se indica con TRUE que estos individuos estan genotipados.
  select(-fam)

ped_IND <- read_delim(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'Molcoanc_13', 'geneal_IND.csv'), delim = ' ') %>% # Se importa el pedigrí creado son el software molcoanc.
  na_if(0) %>% # Para usar la función para calcular la matriz A y su inversa, todos los padres y madres faltantes (en este caso 0), deben estar como NA.
  full_join(y = ped_IND_298, by = 'id') %>%
  mutate(Genotiped = replace_na(Genotiped, FALSE)) # Se especifican los individuos no genotipados (NA) como FALSE.

# Matriz G ----

mG_5_esc <- readRDS(here('Datos', 'Datos_IND', 'Den_100.000', 'mG', 'mG_5', 'mG_5_esc.RDS')) # Se carga la matriz de SPNs escalada de los 298 individuos genotipados de la población IND. 

m_G_IND_5 <- tcrossprod(mG_5_esc)/ncol(mG_5_esc)
diag(m_G_IND_5) = diag(m_G_IND_5) + 0.05

m_G_IND_5 <- Matrix(m_G_IND_5)

# Cálculo de la matriz H ----

mH_IND_5 <- fn.mH(ped = ped_IND, mG = m_G_IND_5) %>%
  saveRDS(here('Datos', 'Datos_IND', 'Den_100.000_b', 'mH', 'Ped_2', 'mH_2', 'mH_2.RDS'))

mH_IND_5[1:10, 1:10]
mH_IND_5[510:520, 510:520]
mH_IND_5[521:531, 521:531]
diag(mH_IND_5)

## 3. Subpoblación con 451 individuos genotipados

dir.create('../Datos/Datos_IND/Den_100.000_b/mH/Ped_2/mH_3') # Se crea el directorio donde se guardara la matriz H para la subpoblación de 451 individuos genotipados.

# Pedigrí ----

famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'nSNPs_IND.fam')) %>% # Se importa el archivo .fam obtenido usando plink y que posteriomente se uso para crear la hoja de parámetros para ejecutar el software molcoanc.
  as_tibble() %>%
  select(fam) %>%
  mutate(id = 521:971)

ped_IND_451 <- read_delim(here('Datos', 'Datos_IND', 'Den_100.000', 'mG', 'mG_8', 'subpob_IND.txt'), delim = '\t', col_names = FALSE) %>% # Se importa el conjunto de datos donde esta la identificación de los 451 individuos genotipados.
  as_tibble() %>%
  select(X1) %>%
  rename(fam = X1) %>%
  right_join(x = famsnps_IND, by = 'fam') %>%
  mutate(Genotiped = TRUE) %>% # Se indica con TRUE que estos individuos estan genotipados.
  select(-fam)

ped_IND <- read_delim(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'Molcoanc_13', 'geneal_IND.csv'), delim = ' ') %>% # Se importa el pedigrí creado son el software molcoanc.
  na_if(0) %>% # Para usar la función para calcular la matriz A y su inversa, todos los padres y madres faltantes (en este caso 0), deben estar como NA.
  full_join(y = ped_IND_451, by = 'id') %>%
  mutate(Genotiped = replace_na(Genotiped, FALSE)) # Se especifican los individuos no genotipados (NA) como FALSE.

# Matriz G ----

mG_8_esc <- readRDS(here('Datos', 'Datos_IND', 'Den_100.000', 'mG', 'mG_8', 'mG_8_esc.RDS')) # Se carga la matriz de SPNs escalada de los 451 individuos genotipados de la población IND. 

m_G_IND_8 <- tcrossprod(mG_8_esc)/ncol(mG_8_esc)
diag(m_G_IND_8) = diag(m_G_IND_8) + 0.05

m_G_IND_8 <- Matrix(m_G_IND_8)

# Cálculo de la matriz H ----

mH_IND_8 <- fn.mH(ped = ped_IND, mG = m_G_IND_8) %>%
  saveRDS(here('Datos', 'Datos_IND', 'Den_100.000_b', 'mH', 'Ped_2', 'mH_3', 'mH_3.RDS'))

mH_IND_8[1:10, 1:10]
mH_IND_8[510:520, 510:520]
mH_IND_8[521:531, 521:531]
diag(mH_IND_8)

## 4. Subpoblación con ningún individuo genotipado

dir.create('../Datos/Datos_IND/Den_100.000_b/mH/Ped_2/mA') # Se crea el directorio donde se guardara la matriz H para la subpoblación con ningún individuo genotipado.

ped_edit_IND <- editPed( # Esta función ordena el pedigrí.
  sire = ped_IND$sire,
  dam = ped_IND$dam,
  label = ped_IND$id
  )

pedi_IND <- pedigree( # Aquí se usa la salida anterior (ya ordenado) y se crea un objeto de clase pedigree.
  sire = ped_edit_IND$sire,
  dam = ped_edit_IND$dam,
  label = ped_edit_IND$label
  )

mA_IND <- getA(ped = pedi_IND) %>% # Esto dara la matriz de relaciones aditivas A.
  saveRDS(here('Datos', 'Datos_IND', 'Den_100.000_b', 'mH', 'Ped_2', 'mA', 'mA.RDS'))

mA_IND[1:10, 1:10]
mA_IND[510:520, 510:520]
mA_IND[521:531, 521:531]
diag(mA_IND)

########################################################
# Pedigrí 3: 1210 individuos simulados en 7 generaciones
########################################################

dir.create('../Datos/Datos_IND/Den_100.000_b/mH/Ped_3') # Se crea el directorio donde se guardara la matriz H para las subpoblaciones del pedigrí 3.

## 1. Subpoblación con 148 individuos genotipados

dir.create('../Datos/Datos_IND/Den_100.000_b/mH/Ped_3/mH_1') # Se crea el directorio donde se guardara la matriz H para la subpoblación con 148 individuos genotipados

# Pedigrí ----

famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'nSNPs_IND.fam')) %>% # Se importa el archivo .fam obtenido usando plink y que posteriomente se uso para crear la hoja de parámetros para ejecutar el software molcoanc.
  as_tibble() %>%
  select(fam) %>%
  mutate(id = 1211:1661)

ped_IND_148 <- read_delim(here('Datos', 'Datos_IND', 'Den_100.000', 'mG', 'mG_2', 'subpob_IND.txt'), delim = '\t', col_names = FALSE) %>% # Se importa el conjunto de datos donde esta la identificación de los 148 individuos genotipados.
  as_tibble() %>%
  select(X1) %>%
  rename(fam = X1) %>%
  right_join(x = famsnps_IND, by = 'fam') %>%
  mutate(Genotiped = TRUE) %>% # Se indica con TRUE que estos individuos estan genotipados.
  select(-fam)

ped_IND <- read_delim(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'Molcoanc_14', 'geneal_IND.csv'), delim = ' ') %>% # Se importa el pedigrí creado son el software molcoanc.
  na_if(0) %>% # Para usar la función para calcular la matriz A y su inversa, todos los padres y madres faltantes (en este caso 0), deben estar como NA.
  full_join(y = ped_IND_148, by = 'id') %>%
  mutate(Genotiped = replace_na(Genotiped, FALSE)) # Se especifican los individuos no genotipados (NA) como FALSE.

# Matriz G ----

mG_2_esc <- readRDS(here('Datos', 'Datos_IND', 'Den_100.000', 'mG', 'mG_2', 'mG_2_esc.RDS')) # Se carga la matriz de SPNs escalada de los 148 individuos genotipados de la población IND. 

m_G_IND_2 <- tcrossprod(mG_2_esc)/ncol(mG_2_esc)
diag(m_G_IND_2) = diag(m_G_IND_2) + 0.05

m_G_IND_2 <- Matrix(m_G_IND_2)

# Cálculo de la matriz H ----

mH_IND_2 <- fn.mH(ped = ped_IND, mG = m_G_IND_2) %>%
  saveRDS(here('Datos', 'Datos_IND', 'Den_100.000_b', 'mH', 'Ped_3', 'mH_1', 'mH_1.RDS'))

mH_IND_2[1:10, 1:10]
mH_IND_2[1200:1210, 1200:1210]
mH_IND_2[1211:1220, 1211:1220]
diag(mH_IND_2)

## 2. Subpoblación con 298 individuos genotipados

dir.create('../Datos/Datos_IND/Den_100.000_b/mH/Ped_3/mH_2') # Se crea el directorio donde se guardara la matriz H para la subpoblación de 298 individuos genotipados.

# Pedigrí ----

famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'nSNPs_IND.fam')) %>% # Se importa el archivo .fam obtenido usando plink y que posteriomente se uso para crear la hoja de parámetros para ejecutar el software molcoanc.
  as_tibble() %>%
  select(fam) %>%
  mutate(id = 1211:1661)

ped_IND_298 <- read_delim(here('Datos', 'Datos_IND', 'Den_100.000', 'mG', 'mG_5', 'subpob_IND.txt'), delim = '\t', col_names = FALSE) %>% # Se importa el conjunto de datos donde esta la identificación de los 298 individuos genotipados.
  as_tibble() %>%
  select(X1) %>%
  rename(fam = X1) %>%
  right_join(x = famsnps_IND, by = 'fam') %>%
  mutate(Genotiped = TRUE) %>% # Se indica con TRUE que estos individuos estan genotipados.
  select(-fam)

ped_IND <- read_delim(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'Molcoanc_14', 'geneal_IND.csv'), delim = ' ') %>% # Se importa el pedigrí creado son el software molcoanc.
  na_if(0) %>% # Para usar la función para calcular la matriz A y su inversa, todos los padres y madres faltantes (en este caso 0), deben estar como NA.
  full_join(y = ped_IND_298, by = 'id') %>%
  mutate(Genotiped = replace_na(Genotiped, FALSE)) # Se especifican los individuos no genotipados (NA) como FALSE.

# Matriz G ----

mG_5_esc <- readRDS(here('Datos', 'Datos_IND', 'Den_100.000', 'mG', 'mG_5', 'mG_5_esc.RDS')) # Se carga la matriz de SPNs escalada de los 298 individuos genotipados de la población IND. 

m_G_IND_5 <- tcrossprod(mG_5_esc)/ncol(mG_5_esc)
diag(m_G_IND_5) = diag(m_G_IND_5) + 0.05

m_G_IND_5 <- Matrix(m_G_IND_5)

# Cálculo de la matriz H ----

mH_IND_5 <- fn.mH(ped = ped_IND, mG = m_G_IND_5) %>%
  saveRDS(here('Datos', 'Datos_IND', 'Den_100.000_b', 'mH', 'Ped_3', 'mH_2', 'mH_2.RDS'))

mH_IND_5[1:10, 1:10]
mH_IND_5[1200:1210, 1200:1210]
mH_IND_5[1211:1220, 1211:1220]
diag(mH_IND_5)

## 3. Subpoblación con 451 individuos genotipados

dir.create('../Datos/Datos_IND/Den_100.000_b/mH/Ped_3/mH_3') # Se crea el directorio donde se guardara la matriz H para la subpoblación de 451 individuos genotipados.

# Pedigrí ----

famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'nSNPs_IND.fam')) %>% # Se importa el archivo .fam obtenido usando plink y que posteriomente se uso para crear la hoja de parámetros para ejecutar el software molcoanc.
  as_tibble() %>%
  select(fam) %>%
  mutate(id = 1211:1661)

ped_IND_451 <- read_delim(here('Datos', 'Datos_IND', 'Den_100.000', 'mG', 'mG_8', 'subpob_IND.txt'), delim = '\t', col_names = FALSE) %>% # Se importa el conjunto de datos donde esta la identificación de los 451 individuos genotipados.
  as_tibble() %>%
  select(X1) %>%
  rename(fam = X1) %>%
  right_join(x = famsnps_IND, by = 'fam') %>%
  mutate(Genotiped = TRUE) %>% # Se indica con TRUE que estos individuos estan genotipados.
  select(-fam)

ped_IND <- read_delim(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'Molcoanc_14', 'geneal_IND.csv'), delim = ' ') %>% # Se importa el pedigrí creado son el software molcoanc.
  na_if(0) %>% # Para usar la función para calcular la matriz A y su inversa, todos los padres y madres faltantes (en este caso 0), deben estar como NA.
  full_join(y = ped_IND_451, by = 'id') %>%
  mutate(Genotiped = replace_na(Genotiped, FALSE)) # Se especifican los individuos no genotipados (NA) como FALSE.

# Matriz G ----

mG_8_esc <- readRDS(here('Datos', 'Datos_IND', 'Den_100.000', 'mG', 'mG_8', 'mG_8_esc.RDS')) # Se carga la matriz de SPNs escalada de los 451 individuos genotipados de la población IND. 

m_G_IND_8 <- tcrossprod(mG_8_esc)/ncol(mG_8_esc)
diag(m_G_IND_8) = diag(m_G_IND_8) + 0.05

m_G_IND_8 <- Matrix(m_G_IND_8)

# Cálculo de la matriz H ----

mH_IND_8 <- fn.mH(ped = ped_IND, mG = m_G_IND_8) %>%
  saveRDS(here('Datos', 'Datos_IND', 'Den_100.000_b', 'mH', 'Ped_3', 'mH_3', 'mH_3.RDS'))

mH_IND_8[1:10, 1:10]
mH_IND_8[1200:1210, 1200:1210]
mH_IND_8[1211:1220, 1211:1220]
diag(mH_IND_8)

## 4. Subpoblación con ningún individuo genotipado

dir.create('../Datos/Datos_IND/Den_100.000_b/mH/Ped_3/mA') # Se crea el directorio donde se guardara la matriz H para la subpoblación con ningún individuo genotipado.

ped_edit_IND <- editPed( # Esta función ordena el pedigrí.
  sire = ped_IND$sire,
  dam = ped_IND$dam,
  label = ped_IND$id
  )

pedi_IND <- pedigree( # Aquí se usa la salida anterior (ya ordenado) y se crea un objeto de clase pedigree.
  sire = ped_edit_IND$sire,
  dam = ped_edit_IND$dam,
  label = ped_edit_IND$label
  )

mA_IND <- getA(ped = pedi_IND) %>% # Esto dara la matriz de relaciones aditivas A.
  saveRDS(here('Datos', 'Datos_IND', 'Den_100.000_b', 'mH', 'Ped_3', 'mA', 'mA.RDS'))

mA_IND[1:10, 1:10]
mA_IND[1200:1210, 1200:1210]
mA_IND[1211:1220, 1211:1220]
diag(mA_IND)

#######################################################
# Pedigrí 4: 300 individuos simulados en 3 generaciones
#######################################################

dir.create('../Datos/Datos_IND/Den_100.000_b/mH/Ped_4') # Se crea el directorio donde se guardara la matriz H para las subpoblaciones del pedigrí 4.

## 1. Subpoblación con 148 individuos genotipados

dir.create('../Datos/Datos_IND/Den_100.000_b/mH/Ped_4/mH_1') # Se crea el directorio donde se guardara la matriz H para la subpoblación con 148 individuos genotipados

# Pedigrí ----

famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'nSNPs_IND.fam')) %>% # Se importa el archivo .fam obtenido usando plink y que posteriomente se uso para crear la hoja de parámetros para ejecutar el software molcoanc.
  as_tibble() %>%
  select(fam) %>%
  mutate(id = 301:751)

ped_IND_148 <- read_delim(here('Datos', 'Datos_IND', 'Den_100.000', 'mG', 'mG_2', 'subpob_IND.txt'), delim = '\t', col_names = FALSE) %>% # Se importa el conjunto de datos donde esta la identificación de los 148 individuos genotipados.
  as_tibble() %>%
  select(X1) %>%
  rename(fam = X1) %>%
  right_join(x = famsnps_IND, by = 'fam') %>%
  mutate(Genotiped = TRUE) %>% # Se indica con TRUE que estos individuos estan genotipados.
  select(-fam)

ped_IND <- read_delim(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'Molcoanc_15', 'geneal_IND.csv'), delim = ' ') %>% # Se importa el pedigrí creado son el software molcoanc.
  na_if(0) %>% # Para usar la función para calcular la matriz A y su inversa, todos los padres y madres faltantes (en este caso 0), deben estar como NA.
  full_join(y = ped_IND_148, by = 'id') %>%
  mutate(Genotiped = replace_na(Genotiped, FALSE)) # Se especifican los individuos no genotipados (NA) como FALSE.

# Matriz G ----

mG_2_esc <- readRDS(here('Datos', 'Datos_IND', 'Den_100.000', 'mG', 'mG_2', 'mG_2_esc.RDS')) # Se carga la matriz de SPNs escalada de los 148 individuos genotipados de la población IND. 

m_G_IND_2 <- tcrossprod(mG_2_esc)/ncol(mG_2_esc)
diag(m_G_IND_2) = diag(m_G_IND_2) + 0.05

m_G_IND_2 <- Matrix(m_G_IND_2)

# Cálculo de la matriz H ----

mH_IND_2 <- fn.mH(ped = ped_IND, mG = m_G_IND_2) %>%
  saveRDS(here('Datos', 'Datos_IND', 'Den_100.000_b', 'mH', 'Ped_4', 'mH_1', 'mH_1.RDS'))

mH_IND_2[1:10, 1:10]
mH_IND_2[300:310, 300:310]
mH_IND_2[311:320, 311:320]
diag(mH_IND_2)

## 2. Subpoblación con 298 individuos genotipados

dir.create('../Datos/Datos_IND/Den_100.000_b/mH/Ped_4/mH_2') # Se crea el directorio donde se guardara la matriz H para la subpoblación de 298 individuos genotipados.

# Pedigrí ----

famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'nSNPs_IND.fam')) %>% # Se importa el archivo .fam obtenido usando plink y que posteriomente se uso para crear la hoja de parámetros para ejecutar el software molcoanc.
  as_tibble() %>%
  select(fam) %>%
  mutate(id = 301:751)

ped_IND_298 <- read_delim(here('Datos', 'Datos_IND', 'Den_100.000', 'mG', 'mG_5', 'subpob_IND.txt'), delim = '\t', col_names = FALSE) %>% # Se importa el conjunto de datos donde esta la identificación de los 298 individuos genotipados.
  as_tibble() %>%
  select(X1) %>%
  rename(fam = X1) %>%
  right_join(x = famsnps_IND, by = 'fam') %>%
  mutate(Genotiped = TRUE) %>% # Se indica con TRUE que estos individuos estan genotipados.
  select(-fam)

ped_IND <- read_delim(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'Molcoanc_15', 'geneal_IND.csv'), delim = ' ') %>% # Se importa el pedigrí creado son el software molcoanc.
  na_if(0) %>% # Para usar la función para calcular la matriz A y su inversa, todos los padres y madres faltantes (en este caso 0), deben estar como NA.
  full_join(y = ped_IND_298, by = 'id') %>%
  mutate(Genotiped = replace_na(Genotiped, FALSE)) # Se especifican los individuos no genotipados (NA) como FALSE.

# Matriz G ----

mG_5_esc <- readRDS(here('Datos', 'Datos_IND', 'Den_100.000', 'mG', 'mG_5', 'mG_5_esc.RDS')) # Se carga la matriz de SPNs escalada de los 298 individuos genotipados de la población IND. 

m_G_IND_5 <- tcrossprod(mG_5_esc)/ncol(mG_5_esc)
diag(m_G_IND_5) = diag(m_G_IND_5) + 0.05

m_G_IND_5 <- Matrix(m_G_IND_5)

# Cálculo de la matriz H ----

mH_IND_5 <- fn.mH(ped = ped_IND, mG = m_G_IND_5) %>%
  saveRDS(here('Datos', 'Datos_IND', 'Den_100.000_b', 'mH', 'Ped_4', 'mH_2', 'mH_2.RDS'))

mH_IND_5[1:10, 1:10]
mH_IND_5[300:310, 300:310]
mH_IND_5[311:320, 311:320]
diag(mH_IND_5)

## 3. Subpoblación con 451 individuos genotipados

dir.create('../Datos/Datos_IND/Den_100.000_b/mH/Ped_4/mH_3') # Se crea el directorio donde se guardara la matriz H para la subpoblación de 451 individuos genotipados.

# Pedigrí ----

famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'nSNPs_IND.fam')) %>% # Se importa el archivo .fam obtenido usando plink y que posteriomente se uso para crear la hoja de parámetros para ejecutar el software molcoanc.
  as_tibble() %>%
  select(fam) %>%
  mutate(id = 301:751)

ped_IND_451 <- read_delim(here('Datos', 'Datos_IND', 'Den_100.000', 'mG', 'mG_8', 'subpob_IND.txt'), delim = '\t', col_names = FALSE) %>% # Se importa el conjunto de datos donde esta la identificación de los 451 individuos genotipados.
  as_tibble() %>%
  select(X1) %>%
  rename(fam = X1) %>%
  right_join(x = famsnps_IND, by = 'fam') %>%
  mutate(Genotiped = TRUE) %>% # Se indica con TRUE que estos individuos estan genotipados.
  select(-fam)

ped_IND <- read_delim(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'Molcoanc_15', 'geneal_IND.csv'), delim = ' ') %>% # Se importa el pedigrí creado son el software molcoanc.
  na_if(0) %>% # Para usar la función para calcular la matriz A y su inversa, todos los padres y madres faltantes (en este caso 0), deben estar como NA.
  full_join(y = ped_IND_451, by = 'id') %>%
  mutate(Genotiped = replace_na(Genotiped, FALSE)) # Se especifican los individuos no genotipados (NA) como FALSE.

# Matriz G ----

mG_8_esc <- readRDS(here('Datos', 'Datos_IND', 'Den_100.000', 'mG', 'mG_8', 'mG_8_esc.RDS')) # Se carga la matriz de SPNs escalada de los 451 individuos genotipados de la población IND. 

m_G_IND_8 <- tcrossprod(mG_8_esc)/ncol(mG_8_esc)
diag(m_G_IND_8) = diag(m_G_IND_8) + 0.05

m_G_IND_8 <- Matrix(m_G_IND_8)

# Cálculo de la matriz H ----

mH_IND_8 <- fn.mH(ped = ped_IND, mG = m_G_IND_8) %>%
  saveRDS(here('Datos', 'Datos_IND', 'Den_100.000_b', 'mH', 'Ped_4', 'mH_3', 'mH_3.RDS'))

mH_IND_8[1:10, 1:10]
mH_IND_8[300:310, 300:310]
mH_IND_8[311:320, 311:320]
diag(mH_IND_8)

## 4. Subpoblación con ningún individuo genotipado

dir.create('../Datos/Datos_IND/Den_100.000_b/mH/Ped_4/mA') # Se crea el directorio donde se guardara la matriz H para la subpoblación con ningún individuo genotipado.

ped_edit_IND <- editPed( # Esta función ordena el pedigrí.
  sire = ped_IND$sire,
  dam = ped_IND$dam,
  label = ped_IND$id
  )

pedi_IND <- pedigree( # Aquí se usa la salida anterior (ya ordenado) y se crea un objeto de clase pedigree.
  sire = ped_edit_IND$sire,
  dam = ped_edit_IND$dam,
  label = ped_edit_IND$label
  )

mA_IND <- getA(ped = pedi_IND) %>% # Esto dara la matriz de relaciones aditivas A.
  saveRDS(here('Datos', 'Datos_IND', 'Den_100.000_b', 'mH', 'Ped_4', 'mA', 'mA.RDS'))

mA_IND[1:10, 1:10]
mA_IND[289:299, 289:299]
mA_IND[300:310, 300:310]
diag(mA_IND)

########################################################
# Pedigrí 5: 1530 individuos simulados en 9 generaciones
########################################################

dir.create('../Datos/Datos_IND/Den_100.000_b/mH/Ped_5') # Se crea el directorio donde se guardara la matriz H para las subpoblaciones del pedigrí 4.

## 1. Subpoblación con 148 individuos genotipados

dir.create('../Datos/Datos_IND/Den_100.000_b/mH/Ped_5/mH_1') # Se crea el directorio donde se guardara la matriz H para la subpoblación con 148 individuos genotipados

# Pedigrí ----

famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'nSNPs_IND.fam')) %>% # Se importa el archivo .fam obtenido usando plink y que posteriomente se uso para crear la hoja de parámetros para ejecutar el software molcoanc.
  as_tibble() %>%
  select(fam) %>%
  mutate(id = 1531:1981)

ped_IND_148 <- read_delim(here('Datos', 'Datos_IND', 'Den_100.000', 'mG', 'mG_2', 'subpob_IND.txt'), delim = '\t', col_names = FALSE) %>% # Se importa el conjunto de datos donde esta la identificación de los 148 individuos genotipados.
  as_tibble() %>%
  select(X1) %>%
  rename(fam = X1) %>%
  right_join(x = famsnps_IND, by = 'fam') %>%
  mutate(Genotiped = TRUE) %>% # Se indica con TRUE que estos individuos estan genotipados.
  select(-fam)

ped_IND <- read_delim(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'Molcoanc_16', 'geneal_IND.csv'), delim = ' ') %>% # Se importa el pedigrí creado son el software molcoanc.
  na_if(0) %>% # Para usar la función para calcular la matriz A y su inversa, todos los padres y madres faltantes (en este caso 0), deben estar como NA.
  full_join(y = ped_IND_148, by = 'id') %>%
  mutate(Genotiped = replace_na(Genotiped, FALSE)) # Se especifican los individuos no genotipados (NA) como FALSE.

# Matriz G ----

mG_2_esc <- readRDS(here('Datos', 'Datos_IND', 'Den_100.000', 'mG', 'mG_2', 'mG_2_esc.RDS')) # Se carga la matriz de SPNs escalada de los 148 individuos genotipados de la población IND. 

m_G_IND_2 <- tcrossprod(mG_2_esc)/ncol(mG_2_esc)
diag(m_G_IND_2) = diag(m_G_IND_2) + 0.05

m_G_IND_2 <- Matrix(m_G_IND_2)

# Cálculo de la matriz H ----

mH_IND_2 <- fn.mH(ped = ped_IND, mG = m_G_IND_2) %>%
  saveRDS(here('Datos', 'Datos_IND', 'Den_100.000_b', 'mH', 'Ped_5', 'mH_1', 'mH_1.RDS'))

mH_IND_2[1:10, 1:10]
mH_IND_2[1520:1530, 1520:1530]
mH_IND_2[1531:1541, 1531:1541]
diag(mH_IND_2)

## 2. Subpoblación con 298 individuos genotipados

dir.create('../Datos/Datos_IND/Den_100.000_b/mH/Ped_5/mH_2') # Se crea el directorio donde se guardara la matriz H para la subpoblación de 298 individuos genotipados.

# Pedigrí ----

famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'nSNPs_IND.fam')) %>% # Se importa el archivo .fam obtenido usando plink y que posteriomente se uso para crear la hoja de parámetros para ejecutar el software molcoanc.
  as_tibble() %>%
  select(fam) %>%
  mutate(id = 1531:1981)

ped_IND_298 <- read_delim(here('Datos', 'Datos_IND', 'Den_100.000', 'mG', 'mG_5', 'subpob_IND.txt'), delim = '\t', col_names = FALSE) %>% # Se importa el conjunto de datos donde esta la identificación de los 298 individuos genotipados.
  as_tibble() %>%
  select(X1) %>%
  rename(fam = X1) %>%
  right_join(x = famsnps_IND, by = 'fam') %>%
  mutate(Genotiped = TRUE) %>% # Se indica con TRUE que estos individuos estan genotipados.
  select(-fam)

ped_IND <- read_delim(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'Molcoanc_16', 'geneal_IND.csv'), delim = ' ') %>% # Se importa el pedigrí creado son el software molcoanc.
  na_if(0) %>% # Para usar la función para calcular la matriz A y su inversa, todos los padres y madres faltantes (en este caso 0), deben estar como NA.
  full_join(y = ped_IND_298, by = 'id') %>%
  mutate(Genotiped = replace_na(Genotiped, FALSE)) # Se especifican los individuos no genotipados (NA) como FALSE.

# Matriz G ----

mG_5_esc <- readRDS(here('Datos', 'Datos_IND', 'Den_100.000', 'mG', 'mG_5', 'mG_5_esc.RDS')) # Se carga la matriz de SPNs escalada de los 298 individuos genotipados de la población IND. 

m_G_IND_5 <- tcrossprod(mG_5_esc)/ncol(mG_5_esc)
diag(m_G_IND_5) = diag(m_G_IND_5) + 0.05

m_G_IND_5 <- Matrix(m_G_IND_5)

# Cálculo de la matriz H ----

mH_IND_5 <- fn.mH(ped = ped_IND, mG = m_G_IND_5) %>%
  saveRDS(here('Datos', 'Datos_IND', 'Den_100.000_b', 'mH', 'Ped_5', 'mH_2', 'mH_2.RDS'))

mH_IND_5[1:10, 1:10]
mH_IND_5[1520:1530, 1520:1530]
mH_IND_5[1531:1541, 1531:1541]
diag(mH_IND_5)

## 3. Subpoblación con 451 individuos genotipados

dir.create('../Datos/Datos_IND/Den_100.000_b/mH/Ped_5/mH_3') # Se crea el directorio donde se guardara la matriz H para la subpoblación de 451 individuos genotipados.

# Pedigrí ----

famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'nSNPs_IND.fam')) %>% # Se importa el archivo .fam obtenido usando plink y que posteriomente se uso para crear la hoja de parámetros para ejecutar el software molcoanc.
  as_tibble() %>%
  select(fam) %>%
  mutate(id = 1531:1981)

ped_IND_451 <- read_delim(here('Datos', 'Datos_IND', 'Den_100.000', 'mG', 'mG_8', 'subpob_IND.txt'), delim = '\t', col_names = FALSE) %>% # Se importa el conjunto de datos donde esta la identificación de los 451 individuos genotipados.
  as_tibble() %>%
  select(X1) %>%
  rename(fam = X1) %>%
  right_join(x = famsnps_IND, by = 'fam') %>%
  mutate(Genotiped = TRUE) %>% # Se indica con TRUE que estos individuos estan genotipados.
  select(-fam)

ped_IND <- read_delim(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'Molcoanc_16', 'geneal_IND.csv'), delim = ' ') %>% # Se importa el pedigrí creado son el software molcoanc.
  na_if(0) %>% # Para usar la función para calcular la matriz A y su inversa, todos los padres y madres faltantes (en este caso 0), deben estar como NA.
  full_join(y = ped_IND_451, by = 'id') %>%
  mutate(Genotiped = replace_na(Genotiped, FALSE)) # Se especifican los individuos no genotipados (NA) como FALSE.

# Matriz G ----

mG_8_esc <- readRDS(here('Datos', 'Datos_IND', 'Den_100.000', 'mG', 'mG_8', 'mG_8_esc.RDS')) # Se carga la matriz de SPNs escalada de los 451 individuos genotipados de la población IND. 

m_G_IND_8 <- tcrossprod(mG_8_esc)/ncol(mG_8_esc)
diag(m_G_IND_8) = diag(m_G_IND_8) + 0.05

m_G_IND_8 <- Matrix(m_G_IND_8)

# Cálculo de la matriz H ----

mH_IND_8 <- fn.mH(ped = ped_IND, mG = m_G_IND_8) %>%
  saveRDS(here('Datos', 'Datos_IND', 'Den_100.000_b', 'mH', 'Ped_5', 'mH_3', 'mH_3.RDS'))

mH_IND_8[1:10, 1:10]
mH_IND_8[1520:1530, 1520:1530]
mH_IND_8[1531:1541, 1531:1541]
diag(mH_IND_8)

## 4. Subpoblación con ningún individuo genotipado

dir.create('../Datos/Datos_IND/Den_100.000_b/mH/Ped_5/mA') # Se crea el directorio donde se guardara la matriz H para la subpoblación con ningún individuo genotipado.

ped_edit_IND <- editPed( # Esta función ordena el pedigrí.
  sire = ped_IND$sire,
  dam = ped_IND$dam,
  label = ped_IND$id
  )

pedi_IND <- pedigree( # Aquí se usa la salida anterior (ya ordenado) y se crea un objeto de clase pedigree.
  sire = ped_edit_IND$sire,
  dam = ped_edit_IND$dam,
  label = ped_edit_IND$label
  )

mA_IND <- getA(ped = pedi_IND) mA_IND%>% # Esto dara la matriz de relaciones aditivas A.
  saveRDS(here('Datos', 'Datos_IND', 'Den_100.000_b', 'mH', 'Ped_5', 'mA', 'mA.RDS'))

mA_IND[1:10, 1:10]
mH_IND_8[1520:1530, 1520:1530]
mH_IND_8[1531:1541, 1531:1541]
diag(mA_IND)
```

# 12. A continuación se realiza la predicción usando el BGLR para distintos pedigríes.

```{r Ajuste de modelos con BGLR para distintos pedigríes}

dir.create('../Datos/Datos_IND/Den_100.000_b/mod_BGLR') # Se crea una carpeta donde se guardaran los resultados de los modelos que se ajustaran para las distintas subpoblaciones de individuos genotipados con distintos pedigríes.

# 1. Se importan las bases de datos de fenotipos y de linea mejorada.

lin_mej <- read_delim(here('Datos', 'iris_pedigree.csv'), delim = ',')
Fenotipos <- read_delim(here('Datos', 'all.phenotypes.csv'), delim = ',')

#### Población de arroz IND ----

# 2. Se crea un conjunto de datos que contiene solo los individuos mejorados.

Pob_mej <- lin_mej %>%
  filter(Status_with_Pedigree.plus.knowledge == 'I') %>% # Conjunto de datos solo con los individuos mejorados (los que se clasificaron como "I").
  select(X3K_DNA_IRIS_UNIQUE_ID) %>%
  rename(Variety = X3K_DNA_IRIS_UNIQUE_ID)

escalado <- function(x) { # Función usada para escalar el fenotipo.
  (x - mean(x, na.rm = TRUE)) / sd(x, na.rm = TRUE)
  }

Pob_IND <- Fenotipos %>%
  filter(SNPsubsp == 'IND') %>% # Conjunto de datos solo con la especie IND.
  mutate(
    Variety_2 = Variety,
    Fen_escalado = escalado(Time.to.flowering..from.sowing)
    ) %>%
  separate(
    col = Variety,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  ' '
  ) %>%
  unite(
    col = Variety,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  separate(
    col = Variety,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  '-'
  ) %>%
  unite(
    col = Variety,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  separate(
    col = Variety_2,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  ' '
  ) %>%
  unite(
    col = Variety_2,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  inner_join(y = Pob_mej, by = 'Variety') %>%
  select(Variety_2, Fen_escalado) %>% # Se creo el conjunto de datos con los individuos mejorados de la población indica.
  mutate(Fen_escalado = NA) %>% # Los fenotipos de estos individuos se deben colocar como NAs al formar parte de la población de validación cruzada, y al ser los individuos que se quieren predecir.
  rename(Variety = Variety_2)

# 3. Se crea un conjunto de datos que no contiene los individuos mejorados.

Pob_IND_2 <- Fenotipos %>%
  filter(SNPsubsp == 'IND') %>% # Conjunto de datos solo con la especie IND.
  mutate(
    Variety_2 = Variety,
    Fen_escalado = escalado(Time.to.flowering..from.sowing)
    ) %>%
  separate(
    col = Variety,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  ' '
  ) %>%
  unite(
    col = Variety,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  separate(
    col = Variety,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  '-'
  ) %>%
  unite(
    col = Variety,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  separate(
    col = Variety_2,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  ' '
  ) %>%
  unite(
    col = Variety_2,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  anti_join(Pob_mej, by = 'Variety') %>%
  select(Variety_2, Fen_escalado) %>% # Se creo el conjunto de datos con los individuos no mejorados de la población indica.
  rename(Variety = Variety_2)

#########################################################
# Pedigrí 1: 2000 individuos simulados en 10 generaciones
#########################################################

# 4. Se importa el archivo .fam obtenido usando plink y que posteriomente se uso para crear la hoja de parámetros para ejecutar el software molcoanc.

famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'nSNPs_IND.fam')) %>% 
  select(fam) %>%
  mutate(id = 2001:2451) %>%
  rename(Variety = fam)

# 5. Se unen en un solo conjuntos de datos los individuos mejorados y no mejorados.

Pob_IND_3 <- Pob_IND_2 %>%
  left_join(y = famsnps_IND, by = 'Variety') # Se unen al conjunto de datos anterior (famsnps_IND) debido a que aquí esta la identificación numérica como esta en el pedigrí.

Pob_IND_4 <- Pob_IND %>%
  left_join(y = famsnps_IND, by = 'Variety') %>% # Se unen al conjunto de datos famsnps_IND debido a que aquí esta la identificación numérica como esta en el pedigrí.
  bind_rows(Pob_IND_3) %>% # Se une por filas al conjunto de datos de individuos no mejorados anterior Pob_IND_3.
  select(-Variety) %>%
  relocate(
    Fen_escalado,
    .after = id
    )

# 6. Se crea un conjunto de datos donde estaran los fenotipos de los individuos con pedigrí simulado mediante el software molcoanc, y se une posteriormente con el conjunto de datos anterior.

Pob_IND_5 <- tibble(
  id = seq(from = 1, to = 2000, by = 1),
  Fen_escalado = rep(x = NA, times = 2000)
  ) %>%
  bind_rows(Pob_IND_4) %>%
  arrange(id)

########################################
# Uso del paquete BGLR para el pedigrí 1
########################################

dir.create('../Datos/Datos_IND/Den_100.000_b/mod_BGLR/Ped_1') # Se crea una carpeta donde se guardaran los resultados del pedigríe 1.

## 1. Subpoblación con 148 individuos genotipados

# a) Se preparan los datos de entrada ----

mH_IND_1 <- readRDS(here('Datos', 'Datos_IND', 'Den_100.000_b', 'mH', 'Ped_1', 'mH_1', 'mH_1.RDS')) # Se carga la matriz H de los 148 individuos genotipados de la población IND.

Fen_IND <- Pob_IND_5 %>%
  pull(Fen_escalado) # Se extrae del conjunto de datos de fenotipos el fenotipo de interes en forma de vector.

# b) Se configura el predictor lineal ----

ETA = list(list(K = mH_IND_1, model = 'RKHS'))

# c) Se ajusta el modelo ----

dir.create('../Datos/Datos_IND/Den_100.000_b/mod_BGLR/Ped_1/mod_BGLR_1/') # Se crea una carpeta para guardar los resultados del modelo anteriormente ajustado para 148 indiviuos genotipados.

mod_IND_1 <- BGLR(y = Fen_IND, ETA = ETA, nIter = 50000, burnIn = 10000, saveAt = '../Repo_TFM/Datos/Datos_IND/Den_100.000_b/mod_BGLR/Ped_1/mod_BGLR_1/ssgblup_')

save(mod_IND_1, file = '../Repo_TFM/Datos/Datos_IND/Den_100.000_b/mod_BGLR/Ped_1/mod_BGLR_1/mod_BGLR_1.RData')

## 2. Subpoblación con 298 individuos genotipados

# a) Se preparan los datos de entrada ----

mH_IND_2 <- readRDS(here('Datos', 'Datos_IND', 'Den_100.000_b', 'mH', 'Ped_1', 'mH_2', 'mH_2.RDS')) # Se carga la matriz H de los 298 individuos genotipados de la población IND.

Fen_IND <- Pob_IND_5 %>%
  pull(Fen_escalado) # Se extrae del conjunto de datos de fenotipos el fenotipo de interes en forma de vector.

# b) Se configura el predictor lineal ----

ETA = list(list(K = mH_IND_2, model = 'RKHS'))

# c) Se ajusta el modelo ----

dir.create('../Datos/Datos_IND/Den_100.000_b/mod_BGLR/Ped_1/mod_BGLR_2/') # Se crea una carpeta para guardar los resultados del modelo anteriormente ajustado para 298 indiviuos genotipados.

mod_IND_2 <- BGLR(y = Fen_IND, ETA = ETA, nIter = 50000, burnIn = 10000, saveAt = '../Repo_TFM/Datos/Datos_IND/Den_100.000_b/mod_BGLR/Ped_1/mod_BGLR_2/ssgblup_')

save(mod_IND_2, file = '../Repo_TFM/Datos/Datos_IND/Den_100.000_b/mod_BGLR/Ped_1/mod_BGLR_2/mod_BGLR_2.RData')

## 3. Subpoblación con 451 individuos genotipados

# a) Se preparan los datos de entrada ----

mH_IND_3 <- readRDS(here('Datos', 'Datos_IND', 'Den_100.000_b', 'mH', 'Ped_1', 'mH_3', 'mH_3.RDS')) # Se carga la matriz H de los 451 individuos genotipados de la población IND.

Fen_IND <- Pob_IND_5 %>%
  pull(Fen_escalado) # Se extrae del conjunto de datos de fenotipos el fenotipo de interes en forma de vector.

# b) Se configura el predictor lineal ----

ETA = list(list(K = mH_IND_3, model = 'RKHS'))

# c) Se ajusta el modelo ----

dir.create('../Datos/Datos_IND/Den_100.000_b/mod_BGLR/Ped_1/mod_BGLR_3/') # Se crea una carpeta para guardar los resultados del modelo anteriormente ajustado para 298 indiviuos genotipados.

mod_IND_3 <- BGLR(y = Fen_IND, ETA = ETA, nIter = 50000, burnIn = 10000, saveAt = '../Repo_TFM/Datos/Datos_IND/Den_100.000_b/mod_BGLR/Ped_1/mod_BGLR_3/ssgblup_')

save(mod_IND_3, file = '../Repo_TFM/Datos/Datos_IND/Den_100.000_b/mod_BGLR/Ped_1/mod_BGLR_3/mod_BGLR_3.RData')

## 4. Subpoblación con ningún individuo genotipado

# a) Se preparan los datos de entrada ----

mA_IND <- readRDS(here('Datos', 'Datos_IND', 'Den_100.000_b', 'mH', 'Ped_1', 'mA', 'mA.RDS')) # Se carga la matriz A de los individuos de la población IND.

Fen_IND <- Pob_IND_5 %>%
  pull(Fen_escalado) # Se extrae del conjunto de datos de fenotipos el fenotipo de interes en forma de vector.

# b) Se configura el predictor lineal ----

ETA = list(list(K = mA_IND, model = 'RKHS'))

# c) Se ajusta el modelo ----

dir.create('../Datos/Datos_IND/Den_100.000_b/mod_BGLR/Ped_1/mod_BGLR_4/') # Se crea una carpeta para guardar los resultados del modelo anteriormente ajustado para ningún indiviuo genotipado.

mod_IND_4 <- BGLR(y = Fen_IND, ETA = ETA, nIter = 50000, burnIn = 10000, saveAt = '../Repo_TFM/Datos/Datos_IND/Den_100.000_b/mod_BGLR/Ped_1/mod_BGLR_4/ablup_')

save(mod_IND_4, file = '../Repo_TFM/Datos/Datos_IND/Den_100.000_b/mod_BGLR/Ped_1/mod_BGLR_4/mod_BGLR_4.RData')

#######################################################
# Pedigrí 2: 520 individuos simulados en 4 generaciones
#######################################################

# 4. Se importa el archivo .fam obtenido usando plink y que posteriomente se uso para crear la hoja de parámetros para ejecutar el software molcoanc.

famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'nSNPs_IND.fam')) %>% 
  select(fam) %>%
  mutate(id = 521:971) %>%
  rename(Variety = fam)

# 5. Se unen en un solo conjuntos de datos los individuos mejorados y no mejorados.

Pob_IND_3 <- Pob_IND_2 %>%
  left_join(y = famsnps_IND, by = 'Variety') # Se unen al conjunto de datos anterior (famsnps_IND) debido a que aquí esta la identificación numérica como esta en el pedigrí.

Pob_IND_4 <- Pob_IND %>%
  left_join(y = famsnps_IND, by = 'Variety') %>% # Se unen al conjunto de datos famsnps_IND debido a que aquí esta la identificación numérica como esta en el pedigrí.
  bind_rows(Pob_IND_3) %>% # Se une por filas al conjunto de datos de individuos no mejorados anterior Pob_IND_3.
  select(-Variety) %>%
  relocate(
    Fen_escalado,
    .after = id
    )

# 6. Se crea un conjunto de datos donde estaran los fenotipos de los individuos con pedigrí simulado mediante el software molcoanc, y se une posteriormente con el conjunto de datos anterior.

Pob_IND_5 <- tibble(
  id = seq(from = 1, to = 520, by = 1),
  Fen_escalado = rep(x = NA, times = 520)
  ) %>%
  bind_rows(Pob_IND_4) %>%
  arrange(id)

########################################
# Uso del paquete BGLR para el pedigrí 2
########################################

dir.create('../Datos/Datos_IND/Den_100.000_b/mod_BGLR/Ped_2') # Se crea una carpeta donde se guardaran los resultados del pedigríe 2.

## 1. Subpoblación con 148 individuos genotipados

# a) Se preparan los datos de entrada ----

mH_IND_1 <- readRDS(here('Datos', 'Datos_IND', 'Den_100.000_b', 'mH', 'Ped_2', 'mH_1', 'mH_1.RDS')) # Se carga la matriz H de los 148 individuos genotipados de la población IND.

Fen_IND <- Pob_IND_5 %>%
  pull(Fen_escalado) # Se extrae del conjunto de datos de fenotipos el fenotipo de interes en forma de vector.

# b) Se configura el predictor lineal ----

ETA = list(list(K = mH_IND_1, model = 'RKHS'))

# c) Se ajusta el modelo ----

dir.create('../Datos/Datos_IND/Den_100.000_b/mod_BGLR/Ped_2/mod_BGLR_1/') # Se crea una carpeta para guardar los resultados del modelo anteriormente ajustado para 148 indiviuos genotipados.

mod_IND_1 <- BGLR(y = Fen_IND, ETA = ETA, nIter = 50000, burnIn = 10000, saveAt = '../Repo_TFM/Datos/Datos_IND/Den_100.000_b/mod_BGLR/Ped_2/mod_BGLR_1/ssgblup_')

save(mod_IND_1, file = '../Repo_TFM/Datos/Datos_IND/Den_100.000_b/mod_BGLR/Ped_2/mod_BGLR_1/mod_BGLR_1.RData')

## 2. Subpoblación con 298 individuos genotipados

# a) Se preparan los datos de entrada ----

mH_IND_2 <- readRDS(here('Datos', 'Datos_IND', 'Den_100.000_b', 'mH', 'Ped_2', 'mH_2', 'mH_2.RDS')) # Se carga la matriz H de los 298 individuos genotipados de la población IND.

Fen_IND <- Pob_IND_5 %>%
  pull(Fen_escalado) # Se extrae del conjunto de datos de fenotipos el fenotipo de interes en forma de vector.

# b) Se configura el predictor lineal ----

ETA = list(list(K = mH_IND_2, model = 'RKHS'))

# c) Se ajusta el modelo ----

dir.create('../Datos/Datos_IND/Den_100.000_b/mod_BGLR/Ped_2/mod_BGLR_2/') # Se crea una carpeta para guardar los resultados del modelo anteriormente ajustado para 298 indiviuos genotipados.

mod_IND_2 <- BGLR(y = Fen_IND, ETA = ETA, nIter = 50000, burnIn = 10000, saveAt = '../Repo_TFM/Datos/Datos_IND/Den_100.000_b/mod_BGLR/Ped_2/mod_BGLR_2/ssgblup_')

save(mod_IND_2, file = '../Repo_TFM/Datos/Datos_IND/Den_100.000_b/mod_BGLR/Ped_2/mod_BGLR_2/mod_BGLR_2.RData')

## 3. Subpoblación con 451 individuos genotipados

# a) Se preparan los datos de entrada ----

mH_IND_3 <- readRDS(here('Datos', 'Datos_IND', 'Den_100.000_b', 'mH', 'Ped_2', 'mH_3', 'mH_3.RDS')) # Se carga la matriz H de los 451 individuos genotipados de la población IND.

Fen_IND <- Pob_IND_5 %>%
  pull(Fen_escalado) # Se extrae del conjunto de datos de fenotipos el fenotipo de interes en forma de vector.

# b) Se configura el predictor lineal ----

ETA = list(list(K = mH_IND_3, model = 'RKHS'))

# c) Se ajusta el modelo ----

dir.create('../Datos/Datos_IND/Den_100.000_b/mod_BGLR/Ped_2/mod_BGLR_3/') # Se crea una carpeta para guardar los resultados del modelo anteriormente ajustado para 298 indiviuos genotipados.

mod_IND_3 <- BGLR(y = Fen_IND, ETA = ETA, nIter = 50000, burnIn = 10000, saveAt = '../Repo_TFM/Datos/Datos_IND/Den_100.000_b/mod_BGLR/Ped_2/mod_BGLR_3/ssgblup_')

save(mod_IND_3, file = '../Repo_TFM/Datos/Datos_IND/Den_100.000_b/mod_BGLR/Ped_2/mod_BGLR_3/mod_BGLR_3.RData')

## 4. Subpoblación con ningún individuo genotipado

# a) Se preparan los datos de entrada ----

mA_IND <- readRDS(here('Datos', 'Datos_IND', 'Den_100.000_b', 'mH', 'Ped_2', 'mA', 'mA.RDS')) # Se carga la matriz A de los individuos de la población IND.

Fen_IND <- Pob_IND_5 %>%
  pull(Fen_escalado) # Se extrae del conjunto de datos de fenotipos el fenotipo de interes en forma de vector.

# b) Se configura el predictor lineal ----

ETA = list(list(K = mA_IND, model = 'RKHS'))

# c) Se ajusta el modelo ----

dir.create('../Datos/Datos_IND/Den_100.000_b/mod_BGLR/Ped_2/mod_BGLR_4/') # Se crea una carpeta para guardar los resultados del modelo anteriormente ajustado para ningún indiviuo genotipado.

mod_IND_4 <- BGLR(y = Fen_IND, ETA = ETA, nIter = 50000, burnIn = 10000, saveAt = '../Repo_TFM/Datos/Datos_IND/Den_100.000_b/mod_BGLR/Ped_2/mod_BGLR_4/ablup_')

save(mod_IND_4, file = '../Repo_TFM/Datos/Datos_IND/Den_100.000_b/mod_BGLR/Ped_2/mod_BGLR_4/mod_BGLR_4.RData')

########################################################
# Pedigrí 3: 1210 individuos simulados en 7 generaciones
########################################################

# 4. Se importa el archivo .fam obtenido usando plink y que posteriomente se uso para crear la hoja de parámetros para ejecutar el software molcoanc.

famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'nSNPs_IND.fam')) %>% 
  select(fam) %>%
  mutate(id = 1211:1661) %>%
  rename(Variety = fam)

# 5. Se unen en un solo conjuntos de datos los individuos mejorados y no mejorados.

Pob_IND_3 <- Pob_IND_2 %>%
  left_join(y = famsnps_IND, by = 'Variety') # Se unen al conjunto de datos anterior (famsnps_IND) debido a que aquí esta la identificación numérica como esta en el pedigrí.

Pob_IND_4 <- Pob_IND %>%
  left_join(y = famsnps_IND, by = 'Variety') %>% # Se unen al conjunto de datos famsnps_IND debido a que aquí esta la identificación numérica como esta en el pedigrí.
  bind_rows(Pob_IND_3) %>% # Se une por filas al conjunto de datos de individuos no mejorados anterior Pob_IND_3.
  select(-Variety) %>%
  relocate(
    Fen_escalado,
    .after = id
    )

# 6. Se crea un conjunto de datos donde estaran los fenotipos de los individuos con pedigrí simulado mediante el software molcoanc, y se une posteriormente con el conjunto de datos anterior.

Pob_IND_5 <- tibble(
  id = seq(from = 1, to = 1210, by = 1),
  Fen_escalado = rep(x = NA, times = 1210)
  ) %>%
  bind_rows(Pob_IND_4) %>%
  arrange(id)

########################################
# Uso del paquete BGLR para el pedigrí 3
########################################

dir.create('../Datos/Datos_IND/Den_100.000_b/mod_BGLR/Ped_3') # Se crea una carpeta donde se guardaran los resultados del pedigríe 3.

## 1. Subpoblación con 148 individuos genotipados

# a) Se preparan los datos de entrada ----

mH_IND_1 <- readRDS(here('Datos', 'Datos_IND', 'Den_100.000_b', 'mH', 'Ped_3', 'mH_1', 'mH_1.RDS')) # Se carga la matriz H de los 148 individuos genotipados de la población IND.

Fen_IND <- Pob_IND_5 %>%
  pull(Fen_escalado) # Se extrae del conjunto de datos de fenotipos el fenotipo de interes en forma de vector.

# b) Se configura el predictor lineal ----

ETA = list(list(K = mH_IND_1, model = 'RKHS'))

# c) Se ajusta el modelo ----

dir.create('../Datos/Datos_IND/Den_100.000_b/mod_BGLR/Ped_3/mod_BGLR_1/') # Se crea una carpeta para guardar los resultados del modelo anteriormente ajustado para 148 indiviuos genotipados.

mod_IND_1 <- BGLR(y = Fen_IND, ETA = ETA, nIter = 50000, burnIn = 10000, saveAt = '../Repo_TFM/Datos/Datos_IND/Den_100.000_b/mod_BGLR/Ped_3/mod_BGLR_1/ssgblup_')

save(mod_IND_1, file = '../Repo_TFM/Datos/Datos_IND/Den_100.000_b/mod_BGLR/Ped_3/mod_BGLR_1/mod_BGLR_1.RData')

## 2. Subpoblación con 298 individuos genotipados

# a) Se preparan los datos de entrada ----

mH_IND_2 <- readRDS(here('Datos', 'Datos_IND', 'Den_100.000_b', 'mH', 'Ped_3', 'mH_2', 'mH_2.RDS')) # Se carga la matriz H de los 298 individuos genotipados de la población IND.

Fen_IND <- Pob_IND_5 %>%
  pull(Fen_escalado) # Se extrae del conjunto de datos de fenotipos el fenotipo de interes en forma de vector.

# b) Se configura el predictor lineal ----

ETA = list(list(K = mH_IND_2, model = 'RKHS'))

# c) Se ajusta el modelo ----

dir.create('../Datos/Datos_IND/Den_100.000_b/mod_BGLR/Ped_3/mod_BGLR_2/') # Se crea una carpeta para guardar los resultados del modelo anteriormente ajustado para 298 indiviuos genotipados.

mod_IND_2 <- BGLR(y = Fen_IND, ETA = ETA, nIter = 50000, burnIn = 10000, saveAt = '../Repo_TFM/Datos/Datos_IND/Den_100.000_b/mod_BGLR/Ped_3/mod_BGLR_2/ssgblup_')

save(mod_IND_2, file = '../Repo_TFM/Datos/Datos_IND/Den_100.000_b/mod_BGLR/Ped_3/mod_BGLR_2/mod_BGLR_2.RData')

## 3. Subpoblación con 451 individuos genotipados

# a) Se preparan los datos de entrada ----

mH_IND_3 <- readRDS(here('Datos', 'Datos_IND', 'Den_100.000_b', 'mH', 'Ped_3', 'mH_3', 'mH_3.RDS')) # Se carga la matriz H de los 451 individuos genotipados de la población IND.

Fen_IND <- Pob_IND_5 %>%
  pull(Fen_escalado) # Se extrae del conjunto de datos de fenotipos el fenotipo de interes en forma de vector.

# b) Se configura el predictor lineal ----

ETA = list(list(K = mH_IND_3, model = 'RKHS'))

# c) Se ajusta el modelo ----

dir.create('../Datos/Datos_IND/Den_100.000_b/mod_BGLR/Ped_3/mod_BGLR_3/') # Se crea una carpeta para guardar los resultados del modelo anteriormente ajustado para 298 indiviuos genotipados.

mod_IND_3 <- BGLR(y = Fen_IND, ETA = ETA, nIter = 50000, burnIn = 10000, saveAt = '../Repo_TFM/Datos/Datos_IND/Den_100.000_b/mod_BGLR/Ped_3/mod_BGLR_3/ssgblup_')

save(mod_IND_3, file = '../Repo_TFM/Datos/Datos_IND/Den_100.000_b/mod_BGLR/Ped_3/mod_BGLR_3/mod_BGLR_3.RData')

## 4. Subpoblación con ningún individuo genotipado

# a) Se preparan los datos de entrada ----

mA_IND <- readRDS(here('Datos', 'Datos_IND', 'Den_100.000_b', 'mH', 'Ped_3', 'mA', 'mA.RDS')) # Se carga la matriz A de los individuos de la población IND.

Fen_IND <- Pob_IND_5 %>%
  pull(Fen_escalado) # Se extrae del conjunto de datos de fenotipos el fenotipo de interes en forma de vector.

# b) Se configura el predictor lineal ----

ETA = list(list(K = mA_IND, model = 'RKHS'))

# c) Se ajusta el modelo ----

dir.create('../Datos/Datos_IND/Den_100.000_b/mod_BGLR/Ped_3/mod_BGLR_4/') # Se crea una carpeta para guardar los resultados del modelo anteriormente ajustado para ningún indiviuo genotipado.

mod_IND_4 <- BGLR(y = Fen_IND, ETA = ETA, nIter = 50000, burnIn = 10000, saveAt = '../Repo_TFM/Datos/Datos_IND/Den_100.000_b/mod_BGLR/Ped_3/mod_BGLR_4/ablup_')

save(mod_IND_4, file = '../Repo_TFM/Datos/Datos_IND/Den_100.000_b/mod_BGLR/Ped_3/mod_BGLR_4/mod_BGLR_4.RData')

#######################################################
# Pedigrí 4: 300 individuos simulados en 3 generaciones
#######################################################

# 4. Se importa el archivo .fam obtenido usando plink y que posteriomente se uso para crear la hoja de parámetros para ejecutar el software molcoanc.

famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'nSNPs_IND.fam')) %>% 
  select(fam) %>%
  mutate(id = 301:751) %>%
  rename(Variety = fam)

# 5. Se unen en un solo conjuntos de datos los individuos mejorados y no mejorados.

Pob_IND_3 <- Pob_IND_2 %>%
  left_join(y = famsnps_IND, by = 'Variety') # Se unen al conjunto de datos anterior (famsnps_IND) debido a que aquí esta la identificación numérica como esta en el pedigrí.

Pob_IND_4 <- Pob_IND %>%
  left_join(y = famsnps_IND, by = 'Variety') %>% # Se unen al conjunto de datos famsnps_IND debido a que aquí esta la identificación numérica como esta en el pedigrí.
  bind_rows(Pob_IND_3) %>% # Se une por filas al conjunto de datos de individuos no mejorados anterior Pob_IND_3.
  select(-Variety) %>%
  relocate(
    Fen_escalado,
    .after = id
    )

# 6. Se crea un conjunto de datos donde estaran los fenotipos de los individuos con pedigrí simulado mediante el software molcoanc, y se une posteriormente con el conjunto de datos anterior.

Pob_IND_5 <- tibble(
  id = seq(from = 1, to = 300, by = 1),
  Fen_escalado = rep(x = NA, times = 300)
  ) %>%
  bind_rows(Pob_IND_4) %>%
  arrange(id)

########################################
# Uso del paquete BGLR para el pedigrí 4
########################################

dir.create('../Datos/Datos_IND/Den_100.000_b/mod_BGLR/Ped_4') # Se crea una carpeta donde se guardaran los resultados del pedigríe 4.

## 1. Subpoblación con 148 individuos genotipados

# a) Se preparan los datos de entrada ----

mH_IND_1 <- readRDS(here('Datos', 'Datos_IND', 'Den_100.000_b', 'mH', 'Ped_4', 'mH_1', 'mH_1.RDS')) # Se carga la matriz H de los 148 individuos genotipados de la población IND.

Fen_IND <- Pob_IND_5 %>%
  pull(Fen_escalado) # Se extrae del conjunto de datos de fenotipos el fenotipo de interes en forma de vector.

# b) Se configura el predictor lineal ----

ETA = list(list(K = mH_IND_1, model = 'RKHS'))

# c) Se ajusta el modelo ----

dir.create('../Datos/Datos_IND/Den_100.000_b/mod_BGLR/Ped_4/mod_BGLR_1/') # Se crea una carpeta para guardar los resultados del modelo anteriormente ajustado para 148 indiviuos genotipados.

mod_IND_1 <- BGLR(y = Fen_IND, ETA = ETA, nIter = 50000, burnIn = 10000, saveAt = '../Repo_TFM/Datos/Datos_IND/Den_100.000_b/mod_BGLR/Ped_4/mod_BGLR_1/ssgblup_')

save(mod_IND_1, file = '../Repo_TFM/Datos/Datos_IND/Den_100.000_b/mod_BGLR/Ped_4/mod_BGLR_1/mod_BGLR_1.RData')

## 2. Subpoblación con 298 individuos genotipados

# a) Se preparan los datos de entrada ----

mH_IND_2 <- readRDS(here('Datos', 'Datos_IND', 'Den_100.000_b', 'mH', 'Ped_4', 'mH_2', 'mH_2.RDS')) # Se carga la matriz H de los 298 individuos genotipados de la población IND.

Fen_IND <- Pob_IND_5 %>%
  pull(Fen_escalado) # Se extrae del conjunto de datos de fenotipos el fenotipo de interes en forma de vector.

# b) Se configura el predictor lineal ----

ETA = list(list(K = mH_IND_2, model = 'RKHS'))

# c) Se ajusta el modelo ----

dir.create('../Datos/Datos_IND/Den_100.000_b/mod_BGLR/Ped_4/mod_BGLR_2/') # Se crea una carpeta para guardar los resultados del modelo anteriormente ajustado para 298 indiviuos genotipados.

mod_IND_2 <- BGLR(y = Fen_IND, ETA = ETA, nIter = 50000, burnIn = 10000, saveAt = '../Repo_TFM/Datos/Datos_IND/Den_100.000_b/mod_BGLR/Ped_4/mod_BGLR_2/ssgblup_')

save(mod_IND_2, file = '../Repo_TFM/Datos/Datos_IND/Den_100.000_b/mod_BGLR/Ped_4/mod_BGLR_2/mod_BGLR_2.RData')

## 3. Subpoblación con 451 individuos genotipados

# a) Se preparan los datos de entrada ----

mH_IND_3 <- readRDS(here('Datos', 'Datos_IND', 'Den_100.000_b', 'mH', 'Ped_4', 'mH_3', 'mH_3.RDS')) # Se carga la matriz H de los 451 individuos genotipados de la población IND.

Fen_IND <- Pob_IND_5 %>%
  pull(Fen_escalado) # Se extrae del conjunto de datos de fenotipos el fenotipo de interes en forma de vector.

# b) Se configura el predictor lineal ----

ETA = list(list(K = mH_IND_3, model = 'RKHS'))

# c) Se ajusta el modelo ----

dir.create('../Datos/Datos_IND/Den_100.000_b/mod_BGLR/Ped_4/mod_BGLR_3/') # Se crea una carpeta para guardar los resultados del modelo anteriormente ajustado para 298 indiviuos genotipados.

mod_IND_3 <- BGLR(y = Fen_IND, ETA = ETA, nIter = 50000, burnIn = 10000, saveAt = '../Repo_TFM/Datos/Datos_IND/Den_100.000_b/mod_BGLR/Ped_4/mod_BGLR_3/ssgblup_')

save(mod_IND_3, file = '../Repo_TFM/Datos/Datos_IND/Den_100.000_b/mod_BGLR/Ped_4/mod_BGLR_3/mod_BGLR_3.RData')

## 4. Subpoblación con ningún individuo genotipado

# a) Se preparan los datos de entrada ----

mA_IND <- readRDS(here('Datos', 'Datos_IND', 'Den_100.000_b', 'mH', 'Ped_4', 'mA', 'mA.RDS')) # Se carga la matriz A de los individuos de la población IND.

Fen_IND <- Pob_IND_5 %>%
  pull(Fen_escalado) # Se extrae del conjunto de datos de fenotipos el fenotipo de interes en forma de vector.

# b) Se configura el predictor lineal ----

ETA = list(list(K = mA_IND, model = 'RKHS'))

# c) Se ajusta el modelo ----

dir.create('../Datos/Datos_IND/Den_100.000_b/mod_BGLR/Ped_4/mod_BGLR_4/') # Se crea una carpeta para guardar los resultados del modelo anteriormente ajustado para ningún indiviuo genotipado.

mod_IND_4 <- BGLR(y = Fen_IND, ETA = ETA, nIter = 50000, burnIn = 10000, saveAt = '../Repo_TFM/Datos/Datos_IND/Den_100.000_b/mod_BGLR/Ped_4/mod_BGLR_4/ablup_')

save(mod_IND_4, file = '../Repo_TFM/Datos/Datos_IND/Den_100.000_b/mod_BGLR/Ped_4/mod_BGLR_4/mod_BGLR_4.RData')

########################################################
# Pedigrí 5: 1530 individuos simulados en 9 generaciones
########################################################

# 4. Se importa el archivo .fam obtenido usando plink y que posteriomente se uso para crear la hoja de parámetros para ejecutar el software molcoanc.

famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'nSNPs_IND.fam')) %>% 
  select(fam) %>%
  mutate(id = 1531:1981) %>%
  rename(Variety = fam)

# 5. Se unen en un solo conjuntos de datos los individuos mejorados y no mejorados.

Pob_IND_3 <- Pob_IND_2 %>%
  left_join(y = famsnps_IND, by = 'Variety') # Se unen al conjunto de datos anterior (famsnps_IND) debido a que aquí esta la identificación numérica como esta en el pedigrí.

Pob_IND_4 <- Pob_IND %>%
  left_join(y = famsnps_IND, by = 'Variety') %>% # Se unen al conjunto de datos famsnps_IND debido a que aquí esta la identificación numérica como esta en el pedigrí.
  bind_rows(Pob_IND_3) %>% # Se une por filas al conjunto de datos de individuos no mejorados anterior Pob_IND_3.
  select(-Variety) %>%
  relocate(
    Fen_escalado,
    .after = id
    )

# 6. Se crea un conjunto de datos donde estaran los fenotipos de los individuos con pedigrí simulado mediante el software molcoanc, y se une posteriormente con el conjunto de datos anterior.

Pob_IND_5 <- tibble(
  id = seq(from = 1, to = 1530, by = 1),
  Fen_escalado = rep(x = NA, times = 1530)
  ) %>%
  bind_rows(Pob_IND_4) %>%
  arrange(id)

########################################
# Uso del paquete BGLR para el pedigrí 5
########################################

dir.create('../Datos/Datos_IND/Den_100.000_b/mod_BGLR/Ped_5') # Se crea una carpeta donde se guardaran los resultados del pedigríe 4.

## 1. Subpoblación con 148 individuos genotipados

# a) Se preparan los datos de entrada ----

mH_IND_1 <- readRDS(here('Datos', 'Datos_IND', 'Den_100.000_b', 'mH', 'Ped_5', 'mH_1', 'mH_1.RDS')) # Se carga la matriz H de los 148 individuos genotipados de la población IND.

Fen_IND <- Pob_IND_5 %>%
  pull(Fen_escalado) # Se extrae del conjunto de datos de fenotipos el fenotipo de interes en forma de vector.

# b) Se configura el predictor lineal ----

ETA = list(list(K = mH_IND_1, model = 'RKHS'))

# c) Se ajusta el modelo ----

dir.create('../Datos/Datos_IND/Den_100.000_b/mod_BGLR/Ped_5/mod_BGLR_1/') # Se crea una carpeta para guardar los resultados del modelo anteriormente ajustado para 148 indiviuos genotipados.

mod_IND_1 <- BGLR(y = Fen_IND, ETA = ETA, nIter = 50000, burnIn = 10000, saveAt = '../Repo_TFM/Datos/Datos_IND/Den_100.000_b/mod_BGLR/Ped_5/mod_BGLR_1/ssgblup_')

save(mod_IND_1, file = '../Repo_TFM/Datos/Datos_IND/Den_100.000_b/mod_BGLR/Ped_5/mod_BGLR_1/mod_BGLR_1.RData')

## 2. Subpoblación con 298 individuos genotipados

# a) Se preparan los datos de entrada ----

mH_IND_2 <- readRDS(here('Datos', 'Datos_IND', 'Den_100.000_b', 'mH', 'Ped_5', 'mH_2', 'mH_2.RDS')) # Se carga la matriz H de los 298 individuos genotipados de la población IND.

Fen_IND <- Pob_IND_5 %>%
  pull(Fen_escalado) # Se extrae del conjunto de datos de fenotipos el fenotipo de interes en forma de vector.

# b) Se configura el predictor lineal ----

ETA = list(list(K = mH_IND_2, model = 'RKHS'))

# c) Se ajusta el modelo ----

dir.create('../Datos/Datos_IND/Den_100.000_b/mod_BGLR/Ped_5/mod_BGLR_2/') # Se crea una carpeta para guardar los resultados del modelo anteriormente ajustado para 298 indiviuos genotipados.

mod_IND_2 <- BGLR(y = Fen_IND, ETA = ETA, nIter = 50000, burnIn = 10000, saveAt = '../Repo_TFM/Datos/Datos_IND/Den_100.000_b/mod_BGLR/Ped_5/mod_BGLR_2/ssgblup_')

save(mod_IND_2, file = '../Repo_TFM/Datos/Datos_IND/Den_100.000_b/mod_BGLR/Ped_5/mod_BGLR_2/mod_BGLR_2.RData')

## 3. Subpoblación con 451 individuos genotipados

# a) Se preparan los datos de entrada ----

mH_IND_3 <- readRDS(here('Datos', 'Datos_IND', 'Den_100.000_b', 'mH', 'Ped_5', 'mH_3', 'mH_3.RDS')) # Se carga la matriz H de los 451 individuos genotipados de la población IND.

Fen_IND <- Pob_IND_5 %>%
  pull(Fen_escalado) # Se extrae del conjunto de datos de fenotipos el fenotipo de interes en forma de vector.

# b) Se configura el predictor lineal ----

ETA = list(list(K = mH_IND_3, model = 'RKHS'))

# c) Se ajusta el modelo ----

dir.create('../Datos/Datos_IND/Den_100.000_b/mod_BGLR/Ped_5/mod_BGLR_3/') # Se crea una carpeta para guardar los resultados del modelo anteriormente ajustado para 298 indiviuos genotipados.

mod_IND_3 <- BGLR(y = Fen_IND, ETA = ETA, nIter = 50000, burnIn = 10000, saveAt = '../Repo_TFM/Datos/Datos_IND/Den_100.000_b/mod_BGLR/Ped_5/mod_BGLR_3/ssgblup_')

save(mod_IND_3, file = '../Repo_TFM/Datos/Datos_IND/Den_100.000_b/mod_BGLR/Ped_5/mod_BGLR_3/mod_BGLR_3.RData')

## 4. Subpoblación con ningún individuo genotipado

# a) Se preparan los datos de entrada ----

mA_IND <- readRDS(here('Datos', 'Datos_IND', 'Den_100.000_b', 'mH', 'Ped_5', 'mA', 'mA.RDS')) # Se carga la matriz A de los individuos de la población IND.

Fen_IND <- Pob_IND_5 %>%
  pull(Fen_escalado) # Se extrae del conjunto de datos de fenotipos el fenotipo de interes en forma de vector.

# b) Se configura el predictor lineal ----

ETA = list(list(K = mA_IND, model = 'RKHS'))

# c) Se ajusta el modelo ----

dir.create('../Datos/Datos_IND/Den_100.000_b/mod_BGLR/Ped_5/mod_BGLR_4/') # Se crea una carpeta para guardar los resultados del modelo anteriormente ajustado para ningún indiviuo genotipado.

mod_IND_4 <- BGLR(y = Fen_IND, ETA = ETA, nIter = 50000, burnIn = 10000, saveAt = '../Repo_TFM/Datos/Datos_IND/Den_100.000_b/mod_BGLR/Ped_5/mod_BGLR_4/ablup_')

save(mod_IND_4, file = '../Repo_TFM/Datos/Datos_IND/Den_100.000_b/mod_BGLR/Ped_5/mod_BGLR_4/mod_BGLR_4.RData')
```

# 13. A continuación se analizan los resultados obtenidos al correr los datos con el paquete de R BGLR, para los distintos pedigríes.

```{r Resultados con el paquete BGLR para los distintos pedigríes}

# 1. Se importan las bases de datos de feotipos y de linea mejorada.

lin_mej <- read_delim(here('Datos', 'iris_pedigree.csv'), delim = ',')
Fenotipos <- read_delim(here('Datos', 'all.phenotypes.csv'), delim = ',')

#### Población de arroz IND ----

#########################################################
# Pedigrí 1: 2000 individuos simulados en 10 generaciones
#########################################################

# 2. Se importa el archivo .fam obtenido usando plink y que posteriomente se uso para crear la hoja de parámetros para ejecutar el software molcoanc.

famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'nSNPs_IND.fam')) %>% 
  select(fam) %>%
  mutate(id = 2001:2451) %>%
  rename(Variety = fam)

# 3. Se crea un conjunto de datos que contiene solo los individuos mejorados.

Pob_mej <- lin_mej %>%
  filter(Status_with_Pedigree.plus.knowledge == 'I') %>% # Conjunto de datos solo con los individuos mejorados (los que se clasificaron como "I").
  select(X3K_DNA_IRIS_UNIQUE_ID) %>%
  rename(Variety = X3K_DNA_IRIS_UNIQUE_ID)

escalado <- function(x) { # Función usada para escalar el fenotipo.
  (x - mean(x, na.rm = TRUE)) / sd(x, na.rm = TRUE)
  }

Pob_IND <- Fenotipos %>%
  filter(SNPsubsp == 'IND') %>% # Conjunto de datos solo con la especie IND.
  mutate(
    Variety_2 = Variety,
    Fen_escalado = escalado(Time.to.flowering..from.sowing)
    ) %>%
  separate(
    col = Variety,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  ' '
  ) %>%
  unite(
    col = Variety,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  separate(
    col = Variety,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  '-'
  ) %>%
  unite(
    col = Variety,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  separate(
    col = Variety_2,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  ' '
  ) %>%
  unite(
    col = Variety_2,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  inner_join(y = Pob_mej, by = 'Variety') %>%
  select(Variety_2, Fen_escalado) %>% # Se creo el conjunto de datos con los individuos mejorados de la población indica.
  rename(Variety = Variety_2)

Pob_IND_2 <- Pob_IND %>%
  left_join(y = famsnps_IND, by = 'Variety') # Se unen al conjunto de datos famsnps_IND debido a que aquí esta la identificación numérica como esta en el pedigrí.

## 1. Subpoblación con 148 individuos genotipados

load(here('Datos', 'Datos_IND', 'Den_100.000_b', 'mod_BGLR', 'Ped_1', 'mod_BGLR_1', 'mod_BGLR_1.RData'))

Pred_IND_1 <- mod_IND_1$yHat %>%
  as_tibble() %>%
  mutate(Subpoblación = '148') %>%
  rowid_to_column(var = 'id') %>%
  right_join(y = Pob_IND_2, by = 'id')  %>%
  rename(
    'Fenotipo_predicho' = value,
    'Fenotipo_observado' = Fen_escalado
    )

## 2. Subpoblación con 298 individuos genotipados

load(here('Datos', 'Datos_IND', 'Den_100.000_b', 'mod_BGLR', 'Ped_1', 'mod_BGLR_2', 'mod_BGLR_2.RData'))

Pred_IND_2 <- mod_IND_2$yHat %>%
  as_tibble() %>%
  mutate(Subpoblación = '298') %>%
  rowid_to_column(var = 'id') %>%
  right_join(y = Pob_IND_2, by = 'id')  %>%
  rename(
    'Fenotipo_predicho' = value,
    'Fenotipo_observado' = Fen_escalado
    )

## 3. Subpoblación con 451 individuos genotipados

load(here('Datos', 'Datos_IND', 'Den_100.000_b', 'mod_BGLR', 'Ped_1', 'mod_BGLR_3', 'mod_BGLR_3.RData'))

Pred_IND_3 <- mod_IND_3$yHat %>%
  as_tibble() %>%
  mutate(Subpoblación = '451') %>%
  rowid_to_column(var = 'id') %>%
  right_join(y = Pob_IND_2, by = 'id')  %>%
  rename(
    'Fenotipo_predicho' = value,
    'Fenotipo_observado' = Fen_escalado
    )

## 4. Subpoblación con ningún individuo genotipado

load(here('Datos', 'Datos_IND', 'Den_100.000_b', 'mod_BGLR', 'Ped_1', 'mod_BGLR_4', 'mod_BGLR_4.RData'))

Pred_IND_4 <- mod_IND_4$yHat %>%
  as_tibble() %>%
  mutate(Subpoblación = '0') %>%
  rowid_to_column(var = 'id') %>%
  right_join(y = Pob_IND_2, by = 'id')  %>%
  rename(
    'Fenotipo_predicho' = value,
    'Fenotipo_observado' = Fen_escalado
    )

varE <- scan(here('Datos', 'Datos_IND', 'Den_100.000_b', 'mod_BGLR', 'Ped_1', 'mod_BGLR_4', 'ablup_varE.dat')) %>%
  as_tibble()
varU <- scan(here('Datos', 'Datos_IND', 'Den_100.000_b', 'mod_BGLR', 'Ped_1', 'mod_BGLR_4', 'ablup_ETA_1_varU.dat')) %>%
  as_tibble()
h2_IND_1 <- varU/(varU + varE) %>%
  as_tibble() #%>%
  #summarise(
    #h2 = mean(value)
    #) # La heredabilidad fue igual a 0.49.

varU_1 <- ggplot(data = varU, aes(x = value)) +
  geom_density(color = 'yellow', fill = 'yellow', alpha = 0.4) +
  labs(title = 'Pedigrí 3 - Var(a)', x = 'Valor estimado', y = ' ') +
  theme_bw() +
  theme(
    axis.text.x = element_text(size = 12, face = 'bold'),
    axis.title.x = element_text(size = 13, face = 'bold'),
    axis.text.y = element_blank(),
    axis.ticks.y = element_blank(),
    plot.title = element_text(size = 10, face = 'bold')
    )

varE_1 <- ggplot(data = varE, aes(x = value)) +
  geom_density(color = 'cyan', fill = 'cyan', alpha = 0.4) +
  labs(title = 'Pedigrí 3 - Var(e)', x = 'Valor estimado', y = ' ') +
  theme_bw() +
  theme(
    axis.text.x = element_text(size = 12, face = 'bold'),
    axis.title.x = element_text(size = 13, face = 'bold'),
    axis.text.y = element_blank(),
    axis.ticks.y = element_blank(),
    plot.title = element_text(size = 10, face = 'bold')
    )

h2_1 <- ggplot(data = h2_IND_1, aes(x = value)) +
  geom_density(color = 'red', fill = 'red', alpha = 0.4) +
  labs(title = 'Pedigrí 3 - h2', x = 'Valor estimado', y = ' ') +
  theme_bw() +
  theme(
    axis.text.x = element_text(size = 12, face = 'bold'),
    axis.title.x = element_text(size = 13, face = 'bold'),
    axis.text.y = element_blank(),
    axis.ticks.y = element_blank(),
    plot.title = element_text(size = 10, face = 'bold')
    )

# 4. Se unen todos los datos anteriores de las distintas subpoblaciones de individuos. genotipados en un solo conjunto de datos

Pred_IND_a <- bind_rows(Pred_IND_1, Pred_IND_2, Pred_IND_3, Pred_IND_4) %>%
  arrange(id) %>%
  relocate(
    Variety,
    .after = id
    ) %>%
  relocate(
    Fenotipo_predicho,
    .after = Fenotipo_observado
    ) %>%
  mutate(Pedigrí = '5')

#######################################################
# Gráfico de dispersión de los resultados del pedigrí 1
#######################################################

Graf_disp_IND <- function(Subpoblación) { # La función la saque de esta dirección web: https://cmdlinetips.com/2021/05/functions-to-make-plots-with-ggplot2-in-r/
  Pred_IND_a %>%
    filter(.data$Subpoblación == .env$Subpoblación) %>%
    ggplot() +
    aes(x = Fenotipo_observado, y = Fenotipo_predicho) +
    geom_point(size = 4.4, colour = 'yellow', alpha = 0.6) +
    geom_smooth(color = 'yellow', fill = 'yellow', method = 'lm', se = TRUE) +
    stat_cor(p.accuracy = 0.001, colour = 'gray34', label.x = -1.5, label.y = -1.5) +
    geom_rug(colour = 'gray') +
    scale_x_continuous(labels = label_number(accuracy = 0.01)) +
    scale_y_continuous(labels = label_number(accuracy = 0.01)) +
    ggtitle(glue('Individuos genotipados: {Subpoblación}')) +
    labs(x = 'Fenotipo observado', y = 'Fenotipo predicho') +
    theme_bw() +
    theme(
      axis.text = element_text(size = 14),
      axis.title = element_text(size = 15, face = 'bold'),
      plot.title = element_text(size = 11, face = 'bold'),
      legend.position = 'none'
      )
  }

Subpoblación <- c('0', '148', '298', '451')
Graf <- map(Subpoblación, Graf_disp_IND)
(Graf[[1]] | Graf[[2]] | Graf[[3]] | Graf[[4]]) #+
  #plot_annotation(title = 'Pedigrí tres') # Aquí se coloco pedigrí tres pero en realidad es el pedigrí cinco.

#######################################################
# Pedigrí 2: 520 individuos simulados en 4 generaciones
#######################################################

# 2. Se importa el archivo .fam obtenido usando plink y que posteriomente se uso para crear la hoja de parámetros para ejecutar el software molcoanc.

famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'nSNPs_IND.fam')) %>% 
  select(fam) %>%
  mutate(id = 521:971) %>%
  rename(Variety = fam)

# 3. Se crea un conjunto de datos que contiene solo los individuos mejorados.

Pob_mej <- lin_mej %>%
  filter(Status_with_Pedigree.plus.knowledge == 'I') %>% # Conjunto de datos solo con los individuos mejorados (los que se clasificaron como "I").
  select(X3K_DNA_IRIS_UNIQUE_ID) %>%
  rename(Variety = X3K_DNA_IRIS_UNIQUE_ID)

escalado <- function(x) { # Función usada para escalar el fenotipo.
  (x - mean(x, na.rm = TRUE)) / sd(x, na.rm = TRUE)
  }

Pob_IND <- Fenotipos %>%
  filter(SNPsubsp == 'IND') %>% # Conjunto de datos solo con la especie IND.
  mutate(
    Variety_2 = Variety,
    Fen_escalado = escalado(Time.to.flowering..from.sowing)
    ) %>%
  separate(
    col = Variety,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  ' '
  ) %>%
  unite(
    col = Variety,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  separate(
    col = Variety,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  '-'
  ) %>%
  unite(
    col = Variety,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  separate(
    col = Variety_2,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  ' '
  ) %>%
  unite(
    col = Variety_2,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  inner_join(y = Pob_mej, by = 'Variety') %>%
  select(Variety_2, Fen_escalado) %>% # Se creo el conjunto de datos con los individuos mejorados de la población indica.
  rename(Variety = Variety_2)

Pob_IND_2 <- Pob_IND %>%
  left_join(y = famsnps_IND, by = 'Variety') # Se unen al conjunto de datos famsnps_IND debido a que aquí esta la identificación numérica como esta en el pedigrí.

## 1. Subpoblación con 148 individuos genotipados

load(here('Datos', 'Datos_IND', 'Den_100.000_b', 'mod_BGLR', 'Ped_2', 'mod_BGLR_1', 'mod_BGLR_1.RData'))

Pred_IND_5 <- mod_IND_1$yHat %>%
  as_tibble() %>%
  mutate(Subpoblación = '148') %>%
  rowid_to_column(var = 'id') %>%
  right_join(y = Pob_IND_2, by = 'id')  %>%
  rename(
    'Fenotipo_predicho' = value,
    'Fenotipo_observado' = Fen_escalado
    )

## 2. Subpoblación con 298 individuos genotipados

load(here('Datos', 'Datos_IND', 'Den_100.000_b', 'mod_BGLR', 'Ped_2', 'mod_BGLR_2', 'mod_BGLR_2.RData'))

Pred_IND_6 <- mod_IND_2$yHat %>%
  as_tibble() %>%
  mutate(Subpoblación = '298') %>%
  rowid_to_column(var = 'id') %>%
  right_join(y = Pob_IND_2, by = 'id')  %>%
  rename(
    'Fenotipo_predicho' = value,
    'Fenotipo_observado' = Fen_escalado
    )

## 3. Subpoblación con 451 individuos genotipados

load(here('Datos', 'Datos_IND', 'Den_100.000_b', 'mod_BGLR', 'Ped_2', 'mod_BGLR_3', 'mod_BGLR_3.RData'))

Pred_IND_7 <- mod_IND_3$yHat %>%
  as_tibble() %>%
  mutate(Subpoblación = '451') %>%
  rowid_to_column(var = 'id') %>%
  right_join(y = Pob_IND_2, by = 'id')  %>%
  rename(
    'Fenotipo_predicho' = value,
    'Fenotipo_observado' = Fen_escalado
    )

## 4. Subpoblación con ningún individuo genotipado

load(here('Datos', 'Datos_IND', 'Den_100.000_b', 'mod_BGLR', 'Ped_2', 'mod_BGLR_4', 'mod_BGLR_4.RData'))

Pred_IND_8 <- mod_IND_4$yHat %>%
  as_tibble() %>%
  mutate(Subpoblación = '0') %>%
  rowid_to_column(var = 'id') %>%
  right_join(y = Pob_IND_2, by = 'id')  %>%
  rename(
    'Fenotipo_predicho' = value,
    'Fenotipo_observado' = Fen_escalado
    )

# 4. Se unen todos los datos anteriores de las distintas subpoblaciones de individuos. genotipados en un solo conjunto de datos

Pred_IND_b <- bind_rows(Pred_IND_5, Pred_IND_6, Pred_IND_7, Pred_IND_8) %>%
  arrange(id) %>%
  relocate(
    Variety,
    .after = id
  ) %>%
  relocate(
    Fenotipo_predicho,
    .after = Fenotipo_observado
  ) %>%
  mutate(Pedigrí = '2')

#######################################################
# Gráfico de dispersión de los resultados del pedigrí 2
#######################################################

Graf_disp_IND <- function(Subpoblación) {
  Pred_IND_b %>%
    filter(.data$Subpoblación == .env$Subpoblación) %>%
    ggplot() +
    aes(x = Fenotipo_observado, y = Fenotipo_predicho) +
    geom_point(size = 4.4, colour = 'yellow', alpha = 0.6) +
    geom_smooth(color = 'yellow', fill = 'yellow', method = 'lm', se = TRUE) +
    stat_cor(p.accuracy = 0.001, colour = 'gray34', label.x = -1.5, label.y = -1.5) +
    geom_rug(colour = 'gray') +
    scale_x_continuous(labels = label_number(accuracy = 0.01)) +
    scale_y_continuous(labels = label_number(accuracy = 0.01)) +
    ggtitle(glue('Individuos genotipados: {Subpoblación}')) +
    labs(x = 'Fenotipo observado', y = 'Fenotipo predicho') +
    theme_bw() +
    theme(
      axis.text = element_text(size = 14),
      axis.title = element_text(size = 15, face = 'bold'),
      plot.title = element_text(size = 11, face = 'bold'),
      legend.position = 'none'
      )
  }

Subpoblación <- c('0', '148', '298', '451')
Graf <- map(Subpoblación, Graf_disp_IND)
(Graf[[1]] | Graf[[2]] | Graf[[3]] | Graf[[4]]) +
  plot_annotation(title = 'Pedigrí dos')

########################################################
# Pedigrí 3: 1210 individuos simulados en 7 generaciones
########################################################

# 2. Se importa el archivo .fam obtenido usando plink y que posteriomente se uso para crear la hoja de parámetros para ejecutar el software molcoanc.

famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'nSNPs_IND.fam')) %>% 
  select(fam) %>%
  mutate(id = 1211:1661) %>%
  rename(Variety = fam)

# 3. Se crea un conjunto de datos que contiene solo los individuos mejorados.

Pob_mej <- lin_mej %>%
  filter(Status_with_Pedigree.plus.knowledge == 'I') %>% # Conjunto de datos solo con los individuos mejorados (los que se clasificaron como "I").
  select(X3K_DNA_IRIS_UNIQUE_ID) %>%
  rename(Variety = X3K_DNA_IRIS_UNIQUE_ID)

escalado <- function(x) { # Función usada para escalar el fenotipo.
  (x - mean(x, na.rm = TRUE)) / sd(x, na.rm = TRUE)
  }

Pob_IND <- Fenotipos %>%
  filter(SNPsubsp == 'IND') %>% # Conjunto de datos solo con la especie IND.
  mutate(
    Variety_2 = Variety,
    Fen_escalado = escalado(Time.to.flowering..from.sowing)
    ) %>%
  separate(
    col = Variety,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  ' '
  ) %>%
  unite(
    col = Variety,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  separate(
    col = Variety,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  '-'
  ) %>%
  unite(
    col = Variety,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  separate(
    col = Variety_2,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  ' '
  ) %>%
  unite(
    col = Variety_2,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  inner_join(y = Pob_mej, by = 'Variety') %>%
  select(Variety_2, Fen_escalado) %>% # Se creo el conjunto de datos con los individuos mejorados de la población indica.
  rename(Variety = Variety_2)

Pob_IND_2 <- Pob_IND %>%
  left_join(y = famsnps_IND, by = 'Variety') # Se unen al conjunto de datos famsnps_IND debido a que aquí esta la identificación numérica como esta en el pedigrí.

## 1. Subpoblación con 148 individuos genotipados

load(here('Datos', 'Datos_IND', 'Den_100.000_b', 'mod_BGLR', 'Ped_3', 'mod_BGLR_1', 'mod_BGLR_1.RData'))

Pred_IND_9 <- mod_IND_1$yHat %>%
  as_tibble() %>%
  mutate(Subpoblación = '148') %>%
  rowid_to_column(var = 'id') %>%
  right_join(y = Pob_IND_2, by = 'id')  %>%
  rename(
    'Fenotipo_predicho' = value,
    'Fenotipo_observado' = Fen_escalado
    )

## 2. Subpoblación con 298 individuos genotipados

load(here('Datos', 'Datos_IND', 'Den_100.000_b', 'mod_BGLR', 'Ped_3', 'mod_BGLR_2', 'mod_BGLR_2.RData'))

Pred_IND_10 <- mod_IND_2$yHat %>%
  as_tibble() %>%
  mutate(Subpoblación = '298') %>%
  rowid_to_column(var = 'id') %>%
  right_join(y = Pob_IND_2, by = 'id')  %>%
  rename(
    'Fenotipo_predicho' = value,
    'Fenotipo_observado' = Fen_escalado
    )

## 3. Subpoblación con 451 individuos genotipados

load(here('Datos', 'Datos_IND', 'Den_100.000_b', 'mod_BGLR', 'Ped_3', 'mod_BGLR_3', 'mod_BGLR_3.RData'))

Pred_IND_11 <- mod_IND_3$yHat %>%
  as_tibble() %>%
  mutate(Subpoblación = '451') %>%
  rowid_to_column(var = 'id') %>%
  right_join(y = Pob_IND_2, by = 'id')  %>%
  rename(
    'Fenotipo_predicho' = value,
    'Fenotipo_observado' = Fen_escalado
    )

## 4. Subpoblación con ningún individuo genotipado

load(here('Datos', 'Datos_IND', 'Den_100.000_b', 'mod_BGLR', 'Ped_3', 'mod_BGLR_4', 'mod_BGLR_4.RData'))

Pred_IND_12 <- mod_IND_4$yHat %>%
  as_tibble() %>%
  mutate(Subpoblación = '0') %>%
  rowid_to_column(var = 'id') %>%
  right_join(y = Pob_IND_2, by = 'id')  %>%
  rename(
    'Fenotipo_predicho' = value,
    'Fenotipo_observado' = Fen_escalado
    )

varE <- scan(here('Datos', 'Datos_IND', 'Den_100.000_b', 'mod_BGLR', 'Ped_3', 'mod_BGLR_4', 'ablup_varE.dat')) %>%
  as_tibble()
varU <- scan(here('Datos', 'Datos_IND', 'Den_100.000_b', 'mod_BGLR', 'Ped_3', 'mod_BGLR_4', 'ablup_ETA_1_varU.dat')) %>%
  as_tibble()
h2_IND_1 <- varU/(varU + varE) %>%
  as_tibble() #%>%
  #summarise(
    #h2 = mean(value)
    #) # La heredabilidad fue igual a 0.60.

varU_2 <- ggplot(data = varU, aes(x = value)) +
  geom_density(color = 'yellow', fill = 'yellow', alpha = 0.4) +
  labs(title = 'Pedigrí 2 - Var(a)', x = 'Valor estimado', y = ' ') +
  theme_bw() +
  theme(
    axis.text.x = element_text(size = 12, face = 'bold'),
    axis.title.x = element_text(size = 13, face = 'bold'),
    axis.text.y = element_blank(),
    axis.ticks.y = element_blank(),
    plot.title = element_text(size = 10, face = 'bold')
    )

varE_2 <- ggplot(data = varE, aes(x = value)) +
  geom_density(color = 'cyan', fill = 'cyan', alpha = 0.4) +
  labs(title = 'Pedigrí 2 - Var(e)', x = 'Valor estimado', y = ' ') +
  theme_bw() +
  theme(
    axis.text.x = element_text(size = 12, face = 'bold'),
    axis.title.x = element_text(size = 13, face = 'bold'),
    axis.text.y = element_blank(),
    axis.ticks.y = element_blank(),
    plot.title = element_text(size = 10, face = 'bold')
    )

h2_2 <- ggplot(data = h2_IND_1, aes(x = value)) +
  geom_density(color = 'red', fill = 'red', alpha = 0.4) +
  labs(title = 'Pedigrí 2 - h2', x = 'Valor estimado', y = ' ') +
  theme_bw() +
  theme(
    axis.text.x = element_text(size = 12, face = 'bold'),
    axis.title.x = element_text(size = 13, face = 'bold'),
    axis.text.y = element_blank(),
    axis.ticks.y = element_blank(),
    plot.title = element_text(size = 10, face = 'bold')
    )

# 4. Se unen todos los datos anteriores de las distintas subpoblaciones de individuos. genotipados en un solo conjunto de datos

Pred_IND_c <- bind_rows(Pred_IND_9, Pred_IND_10, Pred_IND_11, Pred_IND_12) %>%
  arrange(id) %>%
  relocate(
    Variety,
    .after = id
  ) %>%
  relocate(
    Fenotipo_predicho,
    .after = Fenotipo_observado
  ) %>%
  mutate(Pedigrí = '3')

#######################################################
# Gráfico de dispersión de los resultados del pedigrí 3
#######################################################

Graf_disp_IND <- function(Subpoblación) { # La función la saque de esta dirección web: https://cmdlinetips.com/2021/05/functions-to-make-plots-with-ggplot2-in-r/
  Pred_IND_c %>%
    filter(.data$Subpoblación == .env$Subpoblación) %>%
    ggplot() +
    aes(x = Fenotipo_observado, y = Fenotipo_predicho) +
    geom_point(size = 4.4, colour = 'yellow', alpha = 0.6) +
    geom_smooth(color = 'yellow', fill = 'yellow', method = 'lm', se = TRUE) +
    stat_cor(p.accuracy = 0.001, colour = 'gray34', label.x = -1.5, label.y = -1.5) +
    geom_rug(colour = 'gray') +
    scale_x_continuous(labels = label_number(accuracy = 0.01)) +
    scale_y_continuous(labels = label_number(accuracy = 0.01)) +
    ggtitle(glue('Individuos genotipados: {Subpoblación}')) +
    labs(x = 'Fenotipo observado', y = 'Fenotipo predicho') +
    theme_bw() +
    theme(
      axis.text = element_text(size = 14),
      axis.title = element_text(size = 15, face = 'bold'),
      plot.title = element_text(size = 11, face = 'bold'),
      legend.position = 'none'
      )
  }

Subpoblación <- c('0', '148', '298', '451')
Graf <- map(Subpoblación, Graf_disp_IND)
(Graf[[1]] | Graf[[2]] | Graf[[3]] | Graf[[4]]) +
  plot_annotation(title = 'Pedigrí dos') # Aquí se coloco pedigrí dos pero en realidad es el pedigrí tres.

#######################################################
# Pedigrí 4: 300 individuos simulados en 3 generaciones
#######################################################

# 2. Se importa el archivo .fam obtenido usando plink y que posteriomente se uso para crear la hoja de parámetros para ejecutar el software molcoanc.

famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'nSNPs_IND.fam')) %>% 
  select(fam) %>%
  mutate(id = 301:751) %>%
  rename(Variety = fam)

# 3. Se crea un conjunto de datos que contiene solo los individuos mejorados.

Pob_mej <- lin_mej %>%
  filter(Status_with_Pedigree.plus.knowledge == 'I') %>% # Conjunto de datos solo con los individuos mejorados (los que se clasificaron como "I").
  select(X3K_DNA_IRIS_UNIQUE_ID) %>%
  rename(Variety = X3K_DNA_IRIS_UNIQUE_ID)

escalado <- function(x) { # Función usada para escalar el fenotipo.
  (x - mean(x, na.rm = TRUE)) / sd(x, na.rm = TRUE)
  }

Pob_IND <- Fenotipos %>%
  filter(SNPsubsp == 'IND') %>% # Conjunto de datos solo con la especie IND.
  mutate(
    Variety_2 = Variety,
    Fen_escalado = escalado(Time.to.flowering..from.sowing)
    ) %>%
  separate(
    col = Variety,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  ' '
  ) %>%
  unite(
    col = Variety,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  separate(
    col = Variety,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  '-'
  ) %>%
  unite(
    col = Variety,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  separate(
    col = Variety_2,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  ' '
  ) %>%
  unite(
    col = Variety_2,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  inner_join(y = Pob_mej, by = 'Variety') %>%
  select(Variety_2, Fen_escalado) %>% # Se creo el conjunto de datos con los individuos mejorados de la población indica.
  rename(Variety = Variety_2)

Pob_IND_2 <- Pob_IND %>%
  left_join(y = famsnps_IND, by = 'Variety') # Se unen al conjunto de datos famsnps_IND debido a que aquí esta la identificación numérica como esta en el pedigrí.

## 1. Subpoblación con 148 individuos genotipados

load(here('Datos', 'Datos_IND', 'Den_100.000_b', 'mod_BGLR', 'Ped_4', 'mod_BGLR_1', 'mod_BGLR_1.RData'))

Pred_IND_13 <- mod_IND_1$yHat %>%
  as_tibble() %>%
  mutate(Subpoblación = '148') %>%
  rowid_to_column(var = 'id') %>%
  right_join(y = Pob_IND_2, by = 'id')  %>%
  rename(
    'Fenotipo_predicho' = value,
    'Fenotipo_observado' = Fen_escalado
    )

## 2. Subpoblación con 298 individuos genotipados

load(here('Datos', 'Datos_IND', 'Den_100.000_b', 'mod_BGLR', 'Ped_4', 'mod_BGLR_2', 'mod_BGLR_2.RData'))

Pred_IND_14 <- mod_IND_2$yHat %>%
  as_tibble() %>%
  mutate(Subpoblación = '298') %>%
  rowid_to_column(var = 'id') %>%
  right_join(y = Pob_IND_2, by = 'id')  %>%
  rename(
    'Fenotipo_predicho' = value,
    'Fenotipo_observado' = Fen_escalado
    )

## 3. Subpoblación con 451 individuos genotipados

load(here('Datos', 'Datos_IND', 'Den_100.000_b', 'mod_BGLR', 'Ped_4', 'mod_BGLR_3', 'mod_BGLR_3.RData'))

Pred_IND_15 <- mod_IND_3$yHat %>%
  as_tibble() %>%
  mutate(Subpoblación = '451') %>%
  rowid_to_column(var = 'id') %>%
  right_join(y = Pob_IND_2, by = 'id')  %>%
  rename(
    'Fenotipo_predicho' = value,
    'Fenotipo_observado' = Fen_escalado
    )

## 4. Subpoblación con ningún individuo genotipado

load(here('Datos', 'Datos_IND', 'Den_100.000_b', 'mod_BGLR', 'Ped_4', 'mod_BGLR_4', 'mod_BGLR_4.RData'))

Pred_IND_16 <- mod_IND_4$yHat %>%
  as_tibble() %>%
  mutate(Subpoblación = '0') %>%
  rowid_to_column(var = 'id') %>%
  right_join(y = Pob_IND_2, by = 'id')  %>%
  rename(
    'Fenotipo_predicho' = value,
    'Fenotipo_observado' = Fen_escalado
    )

varE <- scan(here('Datos', 'Datos_IND', 'Den_100.000_b', 'mod_BGLR', 'Ped_4', 'mod_BGLR_4', 'ablup_varE.dat')) %>%
  as_tibble()
varU <- scan(here('Datos', 'Datos_IND', 'Den_100.000_b', 'mod_BGLR', 'Ped_4', 'mod_BGLR_4', 'ablup_ETA_1_varU.dat')) %>%
  as_tibble()
h2_IND_1 <- varU/(varU + varE) %>%
  as_tibble() #%>%
  #summarise(
    #h2 = mean(value)
    #) # La heredabilidad fue igual a 0.72.

varU_3 <- ggplot(data = varU, aes(x = value)) +
  geom_density(color = 'yellow', fill = 'yellow', alpha = 0.4) +
  labs(title = 'Pedigrí 1 - Var(a)', x = 'Valor estimado', y = ' ') +
  theme_bw() +
  theme(
    axis.text.x = element_text(size = 12, face = 'bold'),
    axis.title.x = element_text(size = 13, face = 'bold'),
    axis.text.y = element_blank(),
    axis.ticks.y = element_blank(),
    plot.title = element_text(size = 10, face = 'bold')
    )

varE_3 <- ggplot(data = varE, aes(x = value)) +
  geom_density(color = 'cyan', fill = 'cyan', alpha = 0.4) +
  labs(title = 'Pedigrí 1 - Var(e)', x = 'Valor estimado', y = ' ') +
  theme_bw() +
  theme(
    axis.text.x = element_text(size = 12, face = 'bold'),
    axis.title.x = element_text(size = 13, face = 'bold'),
    axis.text.y = element_blank(),
    axis.ticks.y = element_blank(),
    plot.title = element_text(size = 10, face = 'bold')
    )

h2_3 <- ggplot(data = h2_IND_1, aes(x = value)) +
  geom_density(color = 'red', fill = 'red', alpha = 0.4) +
  labs(title = 'Pedigrí 1 - h2', x = 'Valor estimado', y = ' ') +
  theme_bw() +
  theme(
    axis.text.x = element_text(size = 12, face = 'bold'),
    axis.title.x = element_text(size = 13, face = 'bold'),
    axis.text.y = element_blank(),
    axis.ticks.y = element_blank(),
    plot.title = element_text(size = 10, face = 'bold')
    )

# 4. Se unen todos los datos anteriores de las distintas subpoblaciones de individuos. genotipados en un solo conjunto de datos

Pred_IND_d <- bind_rows(Pred_IND_13, Pred_IND_14, Pred_IND_15, Pred_IND_16) %>%
  arrange(id) %>%
  relocate(
    Variety,
    .after = id
  ) %>%
  relocate(
    Fenotipo_predicho,
    .after = Fenotipo_observado
  ) %>%
  mutate(Pedigrí = '1')

#######################################################
# Gráfico de dispersión de los resultados del pedigrí 4
#######################################################

Graf_disp_IND <- function(Subpoblación) {
  Pred_IND_d %>%
    filter(.data$Subpoblación == .env$Subpoblación) %>%
    ggplot() +
    aes(x = Fenotipo_observado, y = Fenotipo_predicho) +
    geom_point(size = 4.4, colour = 'yellow', alpha = 0.6) +
    geom_smooth(color = 'yellow', fill = 'yellow', method = 'lm', se = TRUE) +
    stat_cor(p.accuracy = 0.001, colour = 'gray34', label.x = -1.5, label.y = -1.5) +
    geom_rug(colour = 'gray') +
    scale_x_continuous(labels = label_number(accuracy = 0.01)) +
    scale_y_continuous(labels = label_number(accuracy = 0.01)) +
    ggtitle(glue('Individuos genotipados: {Subpoblación}')) +
    labs(x = 'Fenotipo observado', y = 'Fenotipo predicho') +
    theme_bw() +
    theme(
      axis.text = element_text(size = 14),
      axis.title = element_text(size = 15, face = 'bold'),
      plot.title = element_text(size = 11, face = 'bold'),
      legend.position = 'none'
      )
  }

Subpoblación <- c('0', '148', '298', '451')
Graf <- map(Subpoblación, Graf_disp_IND)
(Graf[[1]] | Graf[[2]] | Graf[[3]] | Graf[[4]]) +
  plot_annotation(title = 'Pedigrí uno')

########################################################
# Pedigrí 5: 1530 individuos simulados en 9 generaciones
########################################################

# 2. Se importa el archivo .fam obtenido usando plink y que posteriomente se uso para crear la hoja de parámetros para ejecutar el software molcoanc.

famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'nSNPs_IND.fam')) %>% 
  select(fam) %>%
  mutate(id = 1531:1981) %>%
  rename(Variety = fam)

# 3. Se crea un conjunto de datos que contiene solo los individuos mejorados.

Pob_mej <- lin_mej %>%
  filter(Status_with_Pedigree.plus.knowledge == 'I') %>% # Conjunto de datos solo con los individuos mejorados (los que se clasificaron como "I").
  select(X3K_DNA_IRIS_UNIQUE_ID) %>%
  rename(Variety = X3K_DNA_IRIS_UNIQUE_ID)

escalado <- function(x) { # Función usada para escalar el fenotipo.
  (x - mean(x, na.rm = TRUE)) / sd(x, na.rm = TRUE)
}

Pob_IND <- Fenotipos %>%
  filter(SNPsubsp == 'IND') %>% # Conjunto de datos solo con la especie IND.
  mutate(
    Variety_2 = Variety,
    Fen_escalado = escalado(Time.to.flowering..from.sowing)
    ) %>%
  separate(
    col = Variety,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  ' '
  ) %>%
  unite(
    col = Variety,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  separate(
    col = Variety,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  '-'
  ) %>%
  unite(
    col = Variety,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  separate(
    col = Variety_2,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  ' '
  ) %>%
  unite(
    col = Variety_2,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  inner_join(y = Pob_mej, by = 'Variety') %>%
  select(Variety_2, Fen_escalado) %>% # Se creo el conjunto de datos con los individuos mejorados de la población indica.
  rename(Variety = Variety_2)

Pob_IND_2 <- Pob_IND %>%
  left_join(y = famsnps_IND, by = 'Variety') # Se unen al conjunto de datos famsnps_IND debido a que aquí esta la identificación numérica como esta en el pedigrí.

## 1. Subpoblación con 148 individuos genotipados

load(here('Datos', 'Datos_IND', 'Den_100.000_b', 'mod_BGLR', 'Ped_5', 'mod_BGLR_1', 'mod_BGLR_1.RData'))

Pred_IND_17 <- mod_IND_1$yHat %>%
  as_tibble() %>%
  mutate(Subpoblación = '148') %>%
  rowid_to_column(var = 'id') %>%
  right_join(y = Pob_IND_2, by = 'id')  %>%
  rename(
    'Fenotipo_predicho' = value,
    'Fenotipo_observado' = Fen_escalado
    )

## 2. Subpoblación con 298 individuos genotipados

load(here('Datos', 'Datos_IND', 'Den_100.000_b', 'mod_BGLR', 'Ped_5', 'mod_BGLR_2', 'mod_BGLR_2.RData'))

Pred_IND_18 <- mod_IND_2$yHat %>%
  as_tibble() %>%
  mutate(Subpoblación = '298') %>%
  rowid_to_column(var = 'id') %>%
  right_join(y = Pob_IND_2, by = 'id')  %>%
  rename(
    'Fenotipo_predicho' = value,
    'Fenotipo_observado' = Fen_escalado
    )

## 3. Subpoblación con 451 individuos genotipados

load(here('Datos', 'Datos_IND', 'Den_100.000_b', 'mod_BGLR', 'Ped_5', 'mod_BGLR_3', 'mod_BGLR_3.RData'))

Pred_IND_19 <- mod_IND_3$yHat %>%
  as_tibble() %>%
  mutate(Subpoblación = '451') %>%
  rowid_to_column(var = 'id') %>%
  right_join(y = Pob_IND_2, by = 'id')  %>%
  rename(
    'Fenotipo_predicho' = value,
    'Fenotipo_observado' = Fen_escalado
    )

## 4. Subpoblación con ningún individuo genotipado

load(here('Datos', 'Datos_IND', 'Den_100.000_b', 'mod_BGLR', 'Ped_5', 'mod_BGLR_4', 'mod_BGLR_4.RData'))

Pred_IND_20 <- mod_IND_4$yHat %>%
  as_tibble() %>%
  mutate(Subpoblación = '0') %>%
  rowid_to_column(var = 'id') %>%
  right_join(y = Pob_IND_2, by = 'id')  %>%
  rename(
    'Fenotipo_predicho' = value,
    'Fenotipo_observado' = Fen_escalado
    )
  
# 4. Se unen todos los datos anteriores de las distintas subpoblaciones de individuos. genotipados en un solo conjunto de datos

Pred_IND_e <- bind_rows(Pred_IND_17, Pred_IND_18, Pred_IND_19, Pred_IND_20) %>%
  arrange(id) %>%
  relocate(
    Variety,
    .after = id
  ) %>%
  relocate(
    Fenotipo_predicho,
    .after = Fenotipo_observado
  ) %>%
  mutate(Pedigrí = '4')

#######################################################
# Gráfico de dispersión de los resultados del pedigrí 5
#######################################################

Graf_disp_IND <- function(Subpoblación) {
  Pred_IND_e %>%
    filter(.data$Subpoblación == .env$Subpoblación) %>%
    ggplot() +
    aes(x = Fenotipo_observado, y = Fenotipo_predicho) +
    geom_point(size = 4.4, colour = 'yellow', alpha = 0.6) +
    geom_smooth(color = 'yellow', fill = 'yellow', method = 'lm', se = TRUE) +
    stat_cor(p.accuracy = 0.001, colour = 'gray34', label.x = -1.5, label.y = -1.5) +
    geom_rug(colour = 'gray') +
    scale_x_continuous(labels = label_number(accuracy = 0.01)) +
    scale_y_continuous(labels = label_number(accuracy = 0.01)) +
    ggtitle(glue('Individuos genotipados: {Subpoblación}')) +
    labs(x = 'Fenotipo observado', y = 'Fenotipo predicho') +
    theme_bw() +
    theme(
      axis.text = element_text(size = 14),
      axis.title = element_text(size = 15, face = 'bold'),
      plot.title = element_text(size = 11, face = 'bold'),
      legend.position = 'none'
      )
  }

Subpoblación <- c('0', '148', '298', '451')
Graf <- map(Subpoblación, Graf_disp_IND)
(Graf[[1]] | Graf[[2]] | Graf[[3]] | Graf[[4]]) +
  plot_annotation(title = 'Pedigrí cuatro')
```

# 14. A continuación se realiza el gráfico para los distintos Pedigríes simulados.

```{r Se gráfican los distintos pedigríes}

# Población IND ----

#########################################################
# Pedigrí 1: 2000 individuos simulados en 10 generaciones
#########################################################

ped_1_IND <- read_delim(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'Molcoanc_12', 'geneal_IND.csv'), delim = '\t') %>% # Se importa el pedigrí creado son el software molcoanc.
  #write_delim(here('Datos', 'Ped_prueba.txt'), delim = '\t') %>%
  na_if(0)

ped_plot <- editPed(
  sire = ped_1_IND$sire,
  dam = ped_1_IND$dam,
  label = ped_1_IND$id
  )

# Se gráfica el pedigrí según el tutorial de https://sejohnston.com/2014/10/10/step-by-step-a-stylised-pedigree-using-reshape-and-ggplot2/ ----

ped_plot_2 <- ped_plot %>%
  pivot_longer(
    cols = c('sire', 'dam'),
    names_to = 'variable',
    values_to = 'value', # La columna value indica la identificación principal relativa a variable.
    values_drop_na = TRUE # En este primer paso se eliminaron los valores (value) que aparecian como NA.
  ) %>%
  select(-gene) %>% # Tampoco se tuvo en cuenta la variable de generación (gene).
  dplyr::rename(Parent.ID = value) %>%
  rowid_to_column(var = 'Group') %>% # Identificador de grupo (Group) para crear las líneas entre un individuo y su madre o padre.
  select(label, variable, Parent.ID, Group) %>%
  pivot_longer(
    cols = c('label', 'Parent.ID'),
    names_to = 'variable_2',
    values_to = 'value_2'
    ) %>%
  select(-variable) %>%
  dplyr::rename(
    label = value_2,
    variable = variable_2
    ) %>%
  left_join(y = ped_plot, by = 'label')

generateXcoord <- function(size){
  if(size %% 2 != 0 & size != 1){
    newsize <- size - 1
    interval <- 1/newsize
    x <- seq(0, 1, interval)
    }
  if(size %% 2 == 0){
    interval <- 1/size
    x <- seq(0, 1, interval)[-size-1] + diff(seq(0, 1, interval))/2   
    }
  if(size == 1) x <- 0.5
  x
  }

xcoords <- NULL

for(i in unique(ped_plot_2$gene)){
  ids  <- unique(ped_plot_2$label[which(ped_plot_2$gene == i)])
  newx <- generateXcoord(length(ids))
  
  xcoords <- rbind(xcoords,
                   data.frame(label = ids,
                              x = sample(newx, size = length(newx), replace = FALSE))
                   )
  rm(ids, newx)
  }

ped3 <- ped_plot_2 %>%
  left_join(y = xcoords, by = 'label') %>%
  ggplot(data = ., aes(x = x, y = gene)) +
  geom_line(aes(group = Group), alpha = 0.1) +
  geom_point(size = 1.8, colour = 'black', fill = 'black', alpha = 0.2) +
  scale_y_reverse(breaks = c(0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10)) +
  labs(x = '', y = '', title = 'Pedigrí tres.') + # En realidad es el pedigrí cinco pero como me quede con tres pedigríes este sería el tres.
  theme_bw() +
  theme(
    legend.position  = 'none',
    axis.text.x      = element_blank(),
    axis.text.y      = element_text(colour = 'black'),
    axis.ticks.y     = element_blank(),
    axis.ticks.x     = element_blank(),
    axis.text = element_text(face = 'bold', size = 14),
    title = element_text(face = 'bold', size = 13)
    ) +
  theme(plot.margin = unit(c(1.5, 1.5, 1.5, 1.5), units = 'cm'))

#######################################################
# Pedigrí 2: 520 individuos simulados en 4 generaciones
#######################################################

ped_2_IND <- read_delim(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'Molcoanc_13', 'geneal_IND.csv'), delim = ' ') %>% # Se importa el pedigrí creado son el software molcoanc.
  #write_delim(here('Datos', 'Ped_prueba.txt'), delim = '\t') %>%
  na_if(0)

ped_plot <- editPed(
  sire = ped_2_IND$sire,
  dam = ped_2_IND$dam,
  label = ped_2_IND$id
  )

ped_plot_2 <- ped_plot %>%
  pivot_longer(
    cols = c('sire', 'dam'),
    names_to = 'variable',
    values_to = 'value', # La columna value indica la identificación principal relativa a variable.
    values_drop_na = TRUE # En este primer paso se eliminaron los valores (value) que aparecian como NA.
  ) %>%
  select(-gene) %>% # Tampoco se tuvo en cuenta la variable de generación (gene).
  dplyr::rename(Parent.ID = value) %>%
  rowid_to_column(var = 'Group') %>% # Identificador de grupo (Group) para crear las líneas entre un individuo y su madre o padre.
  select(label, variable, Parent.ID, Group) %>%
  pivot_longer(
    cols = c('label', 'Parent.ID'),
    names_to = 'variable_2',
    values_to = 'value_2'
    ) %>%
  select(-variable) %>%
  dplyr::rename(
    label = value_2,
    variable = variable_2
    ) %>%
  left_join(y = ped_plot, by = 'label')

generateXcoord <- function(size){
  if(size %% 2 != 0 & size != 1){
    newsize <- size - 1
    interval <- 1/newsize
    x <- seq(0, 1, interval)
    }
  if(size %% 2 == 0){
    interval <- 1/size
    x <- seq(0, 1, interval)[-size-1] + diff(seq(0, 1, interval))/2   
    }
  if(size == 1) x <- 0.5
  x
  }

xcoords <- NULL

for(i in unique(ped_plot_2$gene)){
  ids  <- unique(ped_plot_2$label[which(ped_plot_2$gene == i)])
  newx <- generateXcoord(length(ids))
  
  xcoords <- rbind(xcoords,
                   data.frame(label = ids,
                              x = sample(newx, size = length(newx), replace = FALSE))
                   )
  rm(ids, newx)
  }

ped_plot_2 %>%
  left_join(y = xcoords, by = 'label') %>%
  ggplot(data = ., aes(x = x, y = gene)) +
  geom_line(aes(group = Group), alpha = 0.1) +
  geom_point(colour = 'black', fill = 'black', alpha = 0.2) +
  scale_y_reverse(breaks = c(0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10)) +
  labs(x = '', y = '', title = 'Pedigrí dos.') +
  theme_bw() +
  theme(
    legend.position  = 'none',
    axis.text.x      = element_blank(),
    axis.text.y      = element_text(colour = 'black'),
    axis.ticks.y     = element_blank(),
    axis.ticks.x     = element_blank(),
    axis.text = element_text(face = 'bold', size = 9),
    title = element_text(face = 'bold', size = 10)
    ) +
  theme(plot.margin = unit(c(1.5, 1.5, 1.5, 1.5), units = 'cm'))

########################################################
# Pedigrí 3: 1210 individuos simulados en 7 generaciones
########################################################

ped_3_IND <- read_delim(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'Molcoanc_14', 'geneal_IND.csv'), delim = ' ') %>% # Se importa el pedigrí creado son el software molcoanc.
  #write_delim(here('Datos', 'Ped_prueba.txt'), delim = '\t') %>%
  na_if(0)

ped_plot <- editPed(
  sire = ped_3_IND$sire,
  dam = ped_3_IND$dam,
  label = ped_3_IND$id
  )

ped_plot_2 <- ped_plot %>%
  pivot_longer(
    cols = c('sire', 'dam'),
    names_to = 'variable',
    values_to = 'value', # La columna value indica la identificación principal relativa a variable.
    values_drop_na = TRUE # En este primer paso se eliminaron los valores (value) que aparecian como NA.
  ) %>%
  select(-gene) %>% # Tampoco se tuvo en cuenta la variable de generación (gene).
  dplyr::rename(Parent.ID = value) %>%
  rowid_to_column(var = 'Group') %>% # Identificador de grupo (Group) para crear las líneas entre un individuo y su madre o padre.
  select(label, variable, Parent.ID, Group) %>%
  pivot_longer(
    cols = c('label', 'Parent.ID'),
    names_to = 'variable_2',
    values_to = 'value_2'
    ) %>%
  select(-variable) %>%
  dplyr::rename(
    label = value_2,
    variable = variable_2
    ) %>%
  left_join(y = ped_plot, by = 'label')

generateXcoord <- function(size){
  if(size %% 2 != 0 & size != 1){
    newsize <- size - 1
    interval <- 1/newsize
    x <- seq(0, 1, interval)
    }
  if(size %% 2 == 0){
    interval <- 1/size
    x <- seq(0, 1, interval)[-size-1] + diff(seq(0, 1, interval))/2   
    }
  if(size == 1) x <- 0.5
  x
  }

xcoords <- NULL

for(i in unique(ped_plot_2$gene)){
  ids  <- unique(ped_plot_2$label[which(ped_plot_2$gene == i)])
  newx <- generateXcoord(length(ids))
  
  xcoords <- rbind(xcoords,
                   data.frame(label = ids,
                              x = sample(newx, size = length(newx), replace = FALSE))
                   )
  rm(ids, newx)
  }

ped2 <- ped_plot_2 %>%
  left_join(y = xcoords, by = 'label') %>%
  ggplot(data = ., aes(x = x, y = gene)) +
  geom_line(aes(group = Group), alpha = 0.1) +
  geom_point(size = 1.8, colour = 'black', fill = 'black', alpha = 0.2) +
  scale_y_reverse(breaks = c(0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10)) +
  labs(x = '', y = '', title = 'Pedigrí dos.') +  # En realidad es el pedigrí tres pero como me quede con tres pedigríes este sería el dos.
  theme_bw() +
  theme(
    legend.position  = 'none',
    axis.text.x      = element_blank(),
    axis.text.y      = element_text(colour = 'black'),
    axis.ticks.y     = element_blank(),
    axis.ticks.x     = element_blank(),
    axis.text = element_text(face = 'bold', size = 14),
    title = element_text(face = 'bold', size = 13)
    ) +
  theme(plot.margin = unit(c(1.5, 1.5, 1.5, 1.5), units = 'cm'))

#######################################################
# Pedigrí 4: 300 individuos simulados en 3 generaciones
#######################################################

ped_4_IND <- read_delim(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'Molcoanc_15', 'geneal_IND.csv'), delim = ' ') %>% # Se importa el pedigrí creado son el software molcoanc.
  #write_delim(here('Datos', 'Ped_prueba.txt'), delim = '\t') %>%
  na_if(0)

ped_plot <- editPed(
  sire = ped_4_IND$sire,
  dam = ped_4_IND$dam,
  label = ped_4_IND$id
  )

ped_plot_2 <- ped_plot %>%
  pivot_longer(
    cols = c('sire', 'dam'),
    names_to = 'variable',
    values_to = 'value', # La columna value indica la identificación principal relativa a variable.
    values_drop_na = TRUE # En este primer paso se eliminaron los valores (value) que aparecian como NA.
  ) %>%
  select(-gene) %>% # Tampoco se tuvo en cuenta la variable de generación (gene).
  dplyr::rename(Parent.ID = value) %>%
  rowid_to_column(var = 'Group') %>% # Identificador de grupo (Group) para crear las líneas entre un individuo y su madre o padre.
  select(label, variable, Parent.ID, Group) %>%
  pivot_longer(
    cols = c('label', 'Parent.ID'),
    names_to = 'variable_2',
    values_to = 'value_2'
    ) %>%
  select(-variable) %>%
  dplyr::rename(
    label = value_2,
    variable = variable_2
    ) %>%
  left_join(y = ped_plot, by = 'label')

generateXcoord <- function(size){
  if(size %% 2 != 0 & size != 1){
    newsize <- size - 1
    interval <- 1/newsize
    x <- seq(0, 1, interval)
    }
  if(size %% 2 == 0){
    interval <- 1/size
    x <- seq(0, 1, interval)[-size-1] + diff(seq(0, 1, interval))/2   
    }
  if(size == 1) x <- 0.5
  x
  }

xcoords <- NULL

for(i in unique(ped_plot_2$gene)){
  ids  <- unique(ped_plot_2$label[which(ped_plot_2$gene == i)])
  newx <- generateXcoord(length(ids))
  
  xcoords <- rbind(xcoords,
                   data.frame(label = ids,
                              x = sample(newx, size = length(newx), replace = FALSE))
                   )
  rm(ids, newx)
  }

ped1 <- ped_plot_2 %>%
  left_join(y = xcoords, by = 'label') %>%
  ggplot(data = ., aes(x = x, y = gene)) +
  geom_line(aes(group = Group), alpha = 0.1) +
  geom_point(size = 1.8, colour = 'black', fill = 'black', alpha = 0.2) +
  scale_y_reverse(breaks = c(0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10)) +
  labs(x = '', y = '', title = 'Pedigrí uno.') +
  theme_bw() +
  theme(
    legend.position  = 'none',
    axis.text.x      = element_blank(),
    axis.text.y      = element_text(colour = 'black'),
    axis.ticks.y     = element_blank(),
    axis.ticks.x     = element_blank(),
    axis.text = element_text(face = 'bold', size = 14),
    title = element_text(face = 'bold', size = 13)
    ) +
  theme(plot.margin = unit(c(1.5, 1.5, 1.5, 1.5), units = 'cm'))

########################################################
# Pedigrí 5: 1530 individuos simulados en 9 generaciones
########################################################

ped_5_IND <- read_delim(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'Molcoanc_16', 'geneal_IND.csv'), delim = ' ') %>% # Se importa el pedigrí creado son el software molcoanc.
  #write_delim(here('Datos', 'Ped_prueba.txt'), delim = '\t') %>%
  na_if(0)

ped_plot <- editPed(
  sire = ped_5_IND$sire,
  dam = ped_5_IND$dam,
  label = ped_5_IND$id
  )

ped_plot_2 <- ped_plot %>%
  pivot_longer(
    cols = c('sire', 'dam'),
    names_to = 'variable',
    values_to = 'value', # La columna value indica la identificación principal relativa a variable.
    values_drop_na = TRUE # En este primer paso se eliminaron los valores (value) que aparecian como NA.
  ) %>%
  select(-gene) %>% # Tampoco se tuvo en cuenta la variable de generación (gene).
  dplyr::rename(Parent.ID = value) %>%
  rowid_to_column(var = 'Group') %>% # Identificador de grupo (Group) para crear las líneas entre un individuo y su madre o padre.
  select(label, variable, Parent.ID, Group) %>%
  pivot_longer(
    cols = c('label', 'Parent.ID'),
    names_to = 'variable_2',
    values_to = 'value_2'
    ) %>%
  select(-variable) %>%
  dplyr::rename(
    label = value_2,
    variable = variable_2
    ) %>%
  left_join(y = ped_plot, by = 'label')

generateXcoord <- function(size){
  if(size %% 2 != 0 & size != 1){
    newsize <- size - 1
    interval <- 1/newsize
    x <- seq(0, 1, interval)
    }
  if(size %% 2 == 0){
    interval <- 1/size
    x <- seq(0, 1, interval)[-size-1] + diff(seq(0, 1, interval))/2   
    }
  if(size == 1) x <- 0.5
  x
  }

xcoords <- NULL

for(i in unique(ped_plot_2$gene)){
  ids  <- unique(ped_plot_2$label[which(ped_plot_2$gene == i)])
  newx <- generateXcoord(length(ids))
  
  xcoords <- rbind(xcoords,
                   data.frame(label = ids,
                              x = sample(newx, size = length(newx), replace = FALSE))
                   )
  rm(ids, newx)
  }

ped_plot_2 %>%
  left_join(y = xcoords, by = 'label') %>%
  ggplot(data = ., aes(x = x, y = gene)) +
  geom_line(aes(group = Group), alpha = 0.1) +
  geom_point(colour = 'black', fill = 'black', alpha = 0.2) +
  scale_y_reverse(breaks = c(0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10)) +
  labs(x = '', y = '', title = 'Pedigrí cuatro.') +
  theme_bw() +
  theme(
    legend.position  = 'none',
    axis.text.x      = element_blank(),
    axis.text.y      = element_text(colour = 'black'),
    axis.ticks.y     = element_blank(),
    axis.ticks.x     = element_blank(),
    axis.text = element_text(face = 'bold', size = 9),
    title = element_text(face = 'bold', size = 10)
    ) +
  theme(plot.margin = unit(c(1.5, 1.5, 1.5, 1.5), units = 'cm'))
```

# 15. A continuación se realiza un análisis de componentes principales para determinar estructura poblacional.

```{r Estructura poblacional mediante PCA}

# Aquí https://medium.com/swlh/a-gentle-introduction-into-the-application-of-principal-component-analysis-pca-in-genomics-269026453295 explican muy bien sobre que trata esta metodología.

dir.create('../Datos/Datos_IND/PCA') 

#### PCA de todas las variedades de arroz (el proceso se siguio como indican aquí https://genomicsbootcamp.github.io/book/principal-component-analysis-pca.html) ----

# 1. Se calcula la distancia entre individuos usando plink (se realizo en el archivo .R denominado Practica_plink dentro de la carpeta "Codigo").

plink('--bfile snps --distance-matrix --make-bed --out Datos_IND/PCA/PCA_IND') # De este procedimiento, se obtiene una matriz 738 x 738 individuos con las distancias individuales entre cada uno de ellos.

# 2. Se importan los archivos de datos resultante del proceso anterior, y el archivo de fenotipos.

m_dist <- read_table(here('Datos', 'Datos_IND', 'PCA', 'PCA_IND.mdist'), col_names = FALSE) %>%
  select(-X739)

ind <- tibble(id = read_table(here('Datos', 'Datos_IND', 'PCA', 'PCA_IND.mdist.id'), col_names = FALSE)[, 2]) # Se extrajo el nombre de los individuos.

esp <- read_delim(here('Datos', 'all.phenotypes.csv'), delim = ',') %>%
  select(SNPsubsp) # Se extrajo el nombre de las especies (ADM, ARO, AUS, IND y JAP).

# 3. Se calculan los componentes principales en función del escalado multidimensional.

mds_poblacion <- cmdscale(d = m_dist, eig = TRUE, k = 5)

# 4. Se extraen los vectores propios.

vec_propios <- cbind(esp, ind, mds_poblacion$points)

# 5. Se calcula la proporción de la variación explicada por cada valor propio (por los dos primeros componentes principales).

porc_propio <- round(((mds_poblacion$eig) / sum(mds_poblacion$eig)) * 100, digits = 2)

porc_propio_2 <- porc_propio %>%
  as.tibble() %>%
  slice(1:12) %>%
  rowid_to_column(var = 'componente') %>%
  mutate(componente = as.factor(componente))

# 6. Se visualizan los resultados mediante componentes principales.

graf_bar <- ggplot(data = porc_propio_2, aes(x = componente, y = value)) +
  geom_bar(stat = 'identity', color = 'gray34', fill = 'gray34', alpha = 0.4) +
  theme_transparent() +
  labs(
   x = 'Componente principal',
   y = 'Variación acumulada (%)'
   ) +
  theme(
    axis.text.x = element_text(face = 'bold', size = 7),
    axis.text.y = element_text(face = 'bold', size = 7, angle = 90),
    axis.title = element_text(face = 'bold', size = 8)
    )

ggplot(data = vec_propios, mapping = aes(x = `1`, y = `2`, color = SNPsubsp, fill = SNPsubsp)) +
  geom_point(alpha = 0.4, size = 4.4) +
  stat_ellipse(aes(color = SNPsubsp), type = 't') +
  geom_hline(yintercept = 0, linetype = 'dotted') +
  geom_vline(xintercept = 0, linetype = 'dotted') +
  scale_color_manual(values = c('yellow', 'black', 'red', 'cyan', 'green')) +
  scale_fill_manual(values = c('yellow', 'black', 'red', 'cyan', 'green')) +
  labs(
   x = paste0('Primer componente (',porc_propio[1],' %)'),
   y = paste0('Segundo componente (',porc_propio[2], '%)'),
   col = 'Variedades de arroz', fill = 'Variedades de arroz'
   ) +
  theme_bw() +
  theme(
    legend.background = element_rect(color = 'gray34', fill = 'white', size = 0.4, linetype = 'dashed'),
    legend.position = c(0.18, 0.24),
    legend.text = element_text(size = 12.5),
    legend.title = element_text(face = 'bold', size = 13.5),
    axis.text = element_text(face = 'bold', size = 14),
    axis.title = element_text(face = 'bold', size = 15)
    ) #+
  #annotation_custom(
    #ggplotGrob(x = graf_bar), 
    #xmin = -0.10, xmax = -0.02, 
    #ymin = -0.08, ymax = -0.17
    #)

#### PCA solo de la población de arroz IND ----

# 1. Se importan los archivos de datos resultante al usar plink, y los archivo de fenotipos y de variedades mejoradas.

m_dist <- read_table(here('Datos', 'Datos_IND', 'PCA', 'PCA_IND.mdist'), col_names = FALSE) %>%
  select(-X739)

ind <- tibble(id = read_table(here('Datos', 'Datos_IND', 'PCA', 'PCA_IND.mdist.id'), col_names = FALSE)[, 2]) # Se extrajo el nombre de los individuos.

esp <- read_delim(here('Datos', 'all.phenotypes.csv'), delim = ',') %>%
  separate(
    col = Variety,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  ' '
  ) %>%
  unite(
    col = Variety,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  separate(
    col = Variety,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  '-'
  ) %>%
  unite(
    col = Variety,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  select(Variety, SNPsubsp)

lin_mej <- read_delim(here('Datos', 'iris_pedigree.csv'), delim = ',') %>%
  select(X3K_DNA_IRIS_UNIQUE_ID, Status_with_Pedigree.plus.knowledge) %>%
  rename(Variety = X3K_DNA_IRIS_UNIQUE_ID) %>%
  inner_join(y = esp, by = 'Variety') %>%
  mutate(
    Status_with_Pedigree.plus.knowledge = replace_na(Status_with_Pedigree.plus.knowledge, 'A'),
    Variedad = case_when(
      Status_with_Pedigree.plus.knowledge == 'I' & SNPsubsp == 'IND' ~ 'Variedad mejorada',
      Status_with_Pedigree.plus.knowledge != 'I' & SNPsubsp == 'IND' ~ 'Variedad no mejorada',
      TRUE ~ 'Otras variedades'
      )
    ) %>%
  select(Variedad)

# 3. Se calculan los componentes principales en función del escalado multidimensional.

mds_poblacion <- cmdscale(d = m_dist, eig = TRUE, k = 5)

# 4. Se extraen los vectores propios.

vec_propios <- cbind(lin_mej, ind, mds_poblacion$points)

# 5. Se calcula la proporción de la variación explicada por cada valor propio (por los dos primeros componentes principales).

porc_propio <- round(((mds_poblacion$eig) / sum(mds_poblacion$eig)) * 100, digits = 2)

# 6. Se visualizan los resultados mediante componentes principales.

ggplot(data = vec_propios, mapping = aes(x = `1`, y = `2`, color = Variedad, fill = Variedad)) +
  geom_point(alpha = 0.4, size = 4.4) +
  #stat_ellipse(aes(color = Variedad), type = 't') +
  geom_hline(yintercept = 0, linetype = 'dotted') +
  geom_vline(xintercept = 0, linetype = 'dotted') +
  scale_color_manual(values = c('gray84', 'red', 'cyan')) +
  scale_fill_manual(values = c('gray84', 'red', 'cyan')) +
  labs(
   x = paste0('Primer componente (',porc_propio[1],' %)'),
   y = paste0('Segundo componente (',porc_propio[2], '%)'),
   col = 'Variedades de arroz', fill = 'Variedades de arroz'
   ) +
  theme_bw() +
  theme(
    legend.background = element_rect(color = 'gray34', fill = 'white', size = 0.4, linetype = 'dashed'),
    legend.position = c(0.18, 0.24),
    legend.text = element_text(size = 12.5),
    legend.title = element_text(face = 'bold', size = 13.5),
    axis.text = element_text(face = 'bold', size = 14),
    axis.title = element_text(face = 'bold', size = 15)
    )
```

# 16. A continuación se realiza un gráfico de los fenotipos de arroz.

```{r Conjuntos de datos fenotípicos}

Fenotipos <- read_delim(here('Datos', 'all.phenotypes.csv'), delim = ',')

# Trillabilidad de la panícula (término descriptivo para la facilidad con la que se extrae el grano de la panícula durante la trilla) ----

Rasgo_1 <- Fenotipos %>%
  mutate(panicle.threshability = as.factor(panicle.threshability)) %>%
  na.omit() %>%
  ggplot(data =., aes(x = panicle.threshability)) +
  geom_bar(color = 'yellow', fill = 'yellow', alpha = 0.4) +
  labs(x = 'Trillabilidad de la panícula', y = 'Número de observaciones') +
  theme_bw() +
  theme(
    axis.text = element_text(size = 12, face = 'bold'),
    axis.title.x = element_text(size = 8, face = 'bold'),
    axis.title.y = element_text(size = 11, face = 'bold')
    )

# Tiempo de floración ----

Rasgo_2 <- Fenotipos %>%
  na.omit() %>%
  ggplot(data = ., aes(x = Time.to.flowering..from.sowing)) +
  geom_density(color = 'black', fill = 'black', alpha = 0.4) +
  labs(x = 'Tiempo de floración', y = 'Densidad') +
  theme_bw() +
  theme(
    axis.text = element_text(size = 12, face = 'bold'),
    axis.title.x = element_text(size = 10, face = 'bold'),
    axis.title.y = element_text(size = 13, face = 'bold')
    )

# Daño de la sal ----

Rasgo_3 <- Fenotipos %>%
  mutate(Salt.injury.at.EC12 = as.factor(Salt.injury.at.EC12)) %>%
  na.omit() %>%
  ggplot(data =., aes(x = Salt.injury.at.EC12)) +
  geom_bar(color = 'green', fill = 'green', alpha = 0.4) +
  labs(x = 'Daño de la sal', y = 'Número de observaciones') +
  theme_bw() +
  theme(
    axis.text = element_text(size = 12, face = 'bold'),
    axis.title.x = element_text(size = 12, face = 'bold'),
    axis.title.y = element_text(size = 11, face = 'bold')
    )

# Longitud de la hoja ----

Rasgo_4 <- Fenotipos %>%
  mutate(leaf.length = as.factor(leaf.length)) %>%
  na.omit() %>%
  ggplot(data =., aes(x = leaf.length)) +
  geom_bar(color = 'red', fill = 'red', alpha = 0.4) +
  labs(x = 'Longitud de la hoja', y = 'Número de observaciones') +
  theme_bw() +
  theme(
    axis.text = element_text(size = 12, face = 'bold'),
    axis.title.x = element_text(size = 11, face = 'bold'),
    axis.title.y = element_text(size = 11, face = 'bold')
    )

# Fuerza del culmo ----

Rasgo_5 <- Fenotipos %>%
  mutate(culm.strength = as.factor(culm.strength)) %>%
  na.omit() %>%
  ggplot(data =., aes(x = culm.strength)) +
  geom_bar(color = 'cyan', fill = 'cyan', alpha = 0.4) +
  labs(x = 'Fuerza del culmo', y = 'Número de observaciones') +
  theme_bw() +
  theme(
    axis.text = element_text(size = 12, face = 'bold'),
    axis.title.x = element_text(size = 11.5, face = 'bold'),
    axis.title.y = element_text(size = 11, face = 'bold')
    )

# Senescencia de la hoja ----

Rasgo_6 <- Fenotipos %>%
  mutate(leaf.senescence = as.factor(leaf.senescence)) %>%
  na.omit() %>%
  ggplot(data =., aes(x = leaf.senescence)) +
  geom_bar(color = 'cyan', fill = 'cyan', alpha = 0.4) +
  labs(x = 'Senescencia de la hoja', y = 'Número de observaciones') +
  theme_bw() +
  theme(
    axis.text = element_text(size = 12, face = 'bold'),
    axis.title.x = element_text(size = 9, face = 'bold'),
    axis.title.y = element_text(size = 11, face = 'bold')
    )

# Ángulo de la hoja bandera ----

Rasgo_7 <- Fenotipos %>%
  mutate(flag.leaf.angle = as.factor(flag.leaf.angle)) %>%
  na.omit() %>%
  ggplot(data =., aes(x = flag.leaf.angle)) +
  geom_bar(color = 'red', fill = 'red', alpha = 0.4) +
  labs(x = 'Ángulo de la hoja bandera', y = 'Número de observaciones') +
  theme_bw() +
  theme(
    axis.text = element_text(size = 12, face = 'bold'),
    axis.title.x = element_text(size = 7, face = 'bold'),
    axis.title.y = element_text(size = 11, face = 'bold')
    )

# Longitud del grano ----

Rasgo_8 <- Fenotipos %>%
  na.omit() %>%
  ggplot(data =., aes(x = grain.length)) +
  geom_density(color = 'green', fill = 'green', alpha = 0.4) +
  scale_x_continuous(labels = label_number(accuracy = 0.1)) +
  labs(x = 'Longitud del grano', y = 'Densidad') +
  theme_bw() +
  theme(
    axis.text = element_text(size = 12, face = 'bold'),
    axis.title.x = element_text(size = 11.5, face = 'bold'),
    axis.title.y = element_text(size = 13, face = 'bold')
    )

# Ancho del grano ----

Rasgo_9 <- Fenotipos %>%
  na.omit() %>%
  ggplot(data =., aes(x = grain.width)) +
  geom_density(color = 'black', fill = 'black', alpha = 0.4) +
  labs(x = 'Ancho del grano', y = 'Densidad') +
  theme_bw() +
  theme(
    axis.text = element_text(size = 12, face = 'bold'),
    axis.title.x = element_text(size = 12, face = 'bold'),
    axis.title.y = element_text(size = 13, face = 'bold')
    )

# Peso del grano ----

Rasgo_10 <- Fenotipos %>%
  na.omit() %>%
  ggplot(data =., aes(x = Grain.weight)) +
  geom_density(color = 'yellow', fill = 'yellow', alpha = 0.4) +
  scale_x_continuous(labels = label_number(accuracy = 0.1)) +
  labs(x = 'Peso del grano', y = 'Densidad') +
  theme_bw() +
  theme(
    axis.text = element_text(size = 12, face = 'bold'),
    axis.title.x = element_text(size = 13, face = 'bold'),
    axis.title.y = element_text(size = 13, face = 'bold')
    )

(Rasgo_1 | Rasgo_2 | Rasgo_3 | Rasgo_4 | Rasgo_5) / (Rasgo_6 | Rasgo_7 | Rasgo_8 | Rasgo_9 | Rasgo_10)
```

# 17. A continuación se calcula la matriz G para diferentes densidades de SNPs.

```{r Calculo de la matriz G para diferentes densidades de SNPs}

#### Población de arroz IND (10.000 SNPs) ----

dir.create('../Datos/Datos_IND/Den_10.000') # Se crea una carpeta donde se guardaran los resultados considerando una densidas de 10.000 SNPs.

dir.create('../Datos/Datos_IND/Den_10.000/mG') # Se crea una carpeta que contendra el análisis en el calculo de la matriz G para la pobación IND considerando una densidad de genotipado de 10.000 SNPs.

## Subpoblación con 148 individuos genotipados ----

dir.create('../Datos/Datos_IND/Den_10.000/mG/mG_1') # Se crea una carpeta que contendra los 148 individuos genotipados.

# 1. Se usa el plink para seleccionar al azar 10.000 SNPs y filtrar con MAF menor al 5%.

# Se extrae del archivo de genotipos (snps.bed) los 148 individuos genotipados que hacen parte de la población IND ---
plink('--bfile snps --keep Datos_IND/Den_100.000/mG/mG_2/subpob_IND.txt --make-bed --out Datos_IND/Den_10.000/mG/mG_1/Ind_IND')

# Se filtra el archivo de genotipos anterior (Ind_IND.bed) para eliminar los SNPs con MAF < 5% ----
plink('--bfile Datos_IND/Den_10.000/mG/mG_1/Ind_IND --maf 0.05 --make-bed --out Datos_IND/Den_10.000/mG/mG_1/frec_0.05_IND') # Se indica que el número de SNPs es de 100.662.

# Se seleccionan al azar 10.000 SNPs del archivo anteriormente creado (frec_0.05_IND.bed) ----
plink('--bfile Datos_IND/Den_10.000/mG/mG_1/frec_0.05_IND --thin 0.09934235 --make-bed --out Datos_IND/Den_10.000/mG/mG_1/nSNPs_IND') # Se indica que el número de SNPs ahora es de 9.809.

## 2. Se escala la matriz de SNPs.

bimsnps_IND <- read_bim(here('Datos', 'Datos_IND', 'Den_10.000', 'mG', 'mG_1', 'nSNPs_IND.bim'))
famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Den_10.000', 'mG', 'mG_1', 'nSNPs_IND.fam'))
bedsnps_IND <- BEDMatrix(here('Datos', 'Datos_IND', 'Den_10.000', 'mG', 'mG_1', 'nSNPs_IND.bed'), n = length(famsnps_IND$id), p = length(bimsnps_IND$id), simple_names = FALSE)
snps_IND <- as.matrix(bedsnps_IND)

mG_1_esc <- scale(snps_IND) %>%
	saveRDS(here('Datos', 'Datos_IND', 'Den_10.000', 'mG', 'mG_1', 'mG_1_esc.RDS'))

## 3. Se calcula la matriz de relación genómica.

mG_1_esc <- readRDS(here('Datos', 'Datos_IND', 'Den_10.000', 'mG', 'mG_1', 'mG_1_esc.RDS')) # Se carga la matriz de SPNs escalada de los 148 individuos genotipados de la población IND. 

mG_1_IND <- tcrossprod(mG_1_esc)/ncol(mG_1_esc)
diag(mG_1_IND) = diag(mG_1_IND) + 0.05

mG_1_IND %>%
  saveRDS(here('Datos', 'Datos_IND', 'Den_10.000', 'mG', 'mG_1', 'mG_1.RDS'))

## Subpoblación con 298 individuos genotipados ----

dir.create('../Datos/Datos_IND/Den_10.000/mG/mG_2') # Se crea una carpeta que contendra los 298 individuos genotipados.

# 1. Se usa el plink para seleccionar al azar 10.000 SNPs y filtrar con MAF menor al 5%.

# Se extrae del archivo de genotipos (snps.bed) los 298 individuos genotipados que hacen parte de la población IND ---
plink('--bfile snps --keep Datos_IND/Den_100.000/mG/mG_5/subpob_IND.txt --make-bed --out Datos_IND/Den_10.000/mG/mG_2/Ind_IND')

# Se filtra el archivo de genotipos anterior (Ind_IND.bed) para eliminar los SNPs con MAF < 5% ----
plink('--bfile Datos_IND/Den_10.000/mG/mG_2/Ind_IND --maf 0.05 --make-bed --out Datos_IND/Den_10.000/mG/mG_2/frec_0.05_IND') # Se indica que el número de SNPs es de 101.394.

# Se seleccionan al azar 10.000 SNPs del archivo anteriormente creado (frec_0.05_IND.bed) ----
plink('--bfile Datos_IND/Den_10.000/mG/mG_2/frec_0.05_IND --thin 0.09862517 --make-bed --out Datos_IND/Den_10.000/mG/mG_2/nSNPs_IND') # Se indica que el número de SNPs ahora es de 9.946.

## 2. Se escala la matriz de SNPs.

bimsnps_IND <- read_bim(here('Datos', 'Datos_IND', 'Den_10.000', 'mG', 'mG_2', 'nSNPs_IND.bim'))
famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Den_10.000', 'mG', 'mG_2', 'nSNPs_IND.fam'))
bedsnps_IND <- BEDMatrix(here('Datos', 'Datos_IND', 'Den_10.000', 'mG', 'mG_2', 'nSNPs_IND.bed'), n = length(famsnps_IND$id), p = length(bimsnps_IND$id), simple_names = FALSE)
snps_IND <- as.matrix(bedsnps_IND)

mG_2_esc <- scale(snps_IND) %>%
	saveRDS(here('Datos', 'Datos_IND', 'Den_10.000', 'mG', 'mG_2', 'mG_2_esc.RDS'))

## 3. Calculo de la matriz de relación genómica.

mG_2_esc <- readRDS(here('Datos', 'Datos_IND', 'Den_10.000', 'mG', 'mG_2', 'mG_2_esc.RDS')) # Se carga la matriz de SPNs escalada de los 298 individuos genotipados de la población IND. 

mG_2_IND <- tcrossprod(mG_2_esc)/ncol(mG_2_esc)
diag(mG_2_IND) = diag(mG_2_IND) + 0.05

mG_2_IND %>%
  saveRDS(here('Datos', 'Datos_IND', 'Den_10.000', 'mG', 'mG_2', 'mG_2.RDS'))

## Subpoblación con 451 individuos genotipados ----

dir.create('../Datos/Datos_IND/Den_10.000/mG/mG_3') # Se crea una carpeta que contendra los 451 individuos genotipados.

# 1. Se usa el plink para seleccionar al azar 10.000 SNPs y filtrar con MAF menor al 5%.

# Se extrae del archivo de genotipos (snps.bed) los 298 individuos genotipados que hacen parte de la población IND ---
plink('--bfile snps --keep Datos_IND/Den_100.000/mG/mG_8/subpob_IND.txt --make-bed --out Datos_IND/Den_10.000/mG/mG_3/Ind_IND')

# Se filtra el archivo de genotipos anterior (Ind_IND.bed) para eliminar los SNPs con MAF < 5% ----
plink('--bfile Datos_IND/Den_10.000/mG/mG_3/Ind_IND --maf 0.05 --make-bed --out Datos_IND/Den_10.000/mG/mG_3/frec_0.05_IND') # Se indica que el número de SNPs es de 100.231.

# Se seleccionan al azar 10.000 SNPs del archivo anteriormente creado (frec_0.05_IND.bed) ----
plink('--bfile Datos_IND/Den_10.000/mG/mG_3/frec_0.05_IND --thin 0.09976953 --make-bed --out Datos_IND/Den_10.000/mG/mG_3/nSNPs_IND') # Se indica que el número de SNPs ahora es de 9.843.

## 2. Se escala la matriz de SNPs.

bimsnps_IND <- read_bim(here('Datos', 'Datos_IND', 'Den_10.000', 'mG', 'mG_3', 'nSNPs_IND.bim'))
famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Den_10.000', 'mG', 'mG_3', 'nSNPs_IND.fam'))
bedsnps_IND <- BEDMatrix(here('Datos', 'Datos_IND', 'Den_10.000', 'mG', 'mG_3', 'nSNPs_IND.bed'), n = length(famsnps_IND$id), p = length(bimsnps_IND$id), simple_names = FALSE)
snps_IND <- as.matrix(bedsnps_IND)

mG_3_esc <- scale(snps_IND) %>%
	saveRDS(here('Datos', 'Datos_IND', 'Den_10.000', 'mG', 'mG_3', 'mG_3_esc.RDS'))

## 3. Calculo de la matriz de relación genómica.

mG_3_esc <- readRDS(here('Datos', 'Datos_IND', 'Den_10.000', 'mG', 'mG_3', 'mG_3_esc.RDS')) # Se carga la matriz de SPNs escalada de los 451 individuos genotipados de la población IND. 

mG_3_IND <- tcrossprod(mG_3_esc)/ncol(mG_3_esc)
diag(mG_3_IND) = diag(mG_3_IND) + 0.05

mG_3_IND %>%
  saveRDS(here('Datos', 'Datos_IND', 'Den_10.000', 'mG', 'mG_3', 'mG_3.RDS'))

#### Población de arroz IND (1.000 SNPs) ----

dir.create('../Datos/Datos_IND/Den_1.000') # Se crea una carpeta donde se guardaran los resultados considerando una densidas de 1.000 SNPs.

dir.create('../Datos/Datos_IND/Den_1.000/mG') # Se crea una carpeta que contendra el análisis en el calculo de la matriz G para la pobación IND considerando una densidad de genotipado de 1.000 SNPs.

## Subpoblación con 148 individuos genotipados ----

dir.create('../Datos/Datos_IND/Den_1.000/mG/mG_1') # Se crea una carpeta que contendra los 148 individuos genotipados.

# 1. Se usa el plink para seleccionar al azar 1.000 SNPs y filtrar con MAF menor al 5%.

# Se extrae del archivo de genotipos (snps.bed) los 148 individuos genotipados que hacen parte de la población IND ---
plink('--bfile snps --keep Datos_IND/Den_100.000/mG/mG_2/subpob_IND.txt --make-bed --out Datos_IND/Den_1.000/mG/mG_1/Ind_IND')

# Se filtra el archivo de genotipos anterior (Ind_IND.bed) para eliminar los SNPs con MAF < 5% ----
plink('--bfile Datos_IND/Den_1.000/mG/mG_1/Ind_IND --maf 0.05 --make-bed --out Datos_IND/Den_1.000/mG/mG_1/frec_0.05_IND') # Se indica que el número de SNPs es de 100.662.

# Se seleccionan al azar 1.000 SNPs del archivo anteriormente creado (frec_0.05_IND.bed) ----
plink('--bfile Datos_IND/Den_1.000/mG/mG_1/frec_0.05_IND --thin 0.009934235 --make-bed --out Datos_IND/Den_1.000/mG/mG_1/nSNPs_IND') # Se indica que el número de SNPs ahora es de 1.037.

## 2. Se escala la matriz de SNPs.

bimsnps_IND <- read_bim(here('Datos', 'Datos_IND', 'Den_1.000', 'mG', 'mG_1', 'nSNPs_IND.bim'))
famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Den_1.000', 'mG', 'mG_1', 'nSNPs_IND.fam'))
bedsnps_IND <- BEDMatrix(here('Datos', 'Datos_IND', 'Den_1.000', 'mG', 'mG_1', 'nSNPs_IND.bed'), n = length(famsnps_IND$id), p = length(bimsnps_IND$id), simple_names = FALSE)
snps_IND <- as.matrix(bedsnps_IND)

mG_1_esc <- scale(snps_IND) %>%
	saveRDS(here('Datos', 'Datos_IND', 'Den_1.000', 'mG', 'mG_1', 'mG_1_esc.RDS'))

## 3. Se calcula la matriz de relación genómica.

mG_1_esc <- readRDS(here('Datos', 'Datos_IND', 'Den_1.000', 'mG', 'mG_1', 'mG_1_esc.RDS')) # Se carga la matriz de SPNs escalada de los 148 individuos genotipados de la población IND. 

mG_1_IND <- tcrossprod(mG_1_esc)/ncol(mG_1_esc)
diag(mG_1_IND) = diag(mG_1_IND) + 0.05

mG_1_IND %>%
  saveRDS(here('Datos', 'Datos_IND', 'Den_1.000', 'mG', 'mG_1', 'mG_1.RDS'))

## Subpoblación con 298 individuos genotipados ----

dir.create('../Datos/Datos_IND/Den_1.000/mG/mG_2') # Se crea una carpeta que contendra los 298 individuos genotipados.

# 1. Se usa el plink para seleccionar al azar 1.000 SNPs y filtrar con MAF menor al 5%.

# Se extrae del archivo de genotipos (snps.bed) los 298 individuos genotipados que hacen parte de la población IND ---
plink('--bfile snps --keep Datos_IND/Den_100.000/mG/mG_5/subpob_IND.txt --make-bed --out Datos_IND/Den_1.000/mG/mG_2/Ind_IND')

# Se filtra el archivo de genotipos anterior (Ind_IND.bed) para eliminar los SNPs con MAF < 5% ----
plink('--bfile Datos_IND/Den_1.000/mG/mG_2/Ind_IND --maf 0.05 --make-bed --out Datos_IND/Den_1.000/mG/mG_2/frec_0.05_IND') # Se indica que el número de SNPs es de 101.394.

# Se seleccionan al azar 1.000 SNPs del archivo anteriormente creado (frec_0.05_IND.bed) ----
plink('--bfile Datos_IND/Den_1.000/mG/mG_2/frec_0.05_IND --thin 0.009862517 --make-bed --out Datos_IND/Den_1.000/mG/mG_2/nSNPs_IND') # Se indica que el número de SNPs ahora es de 986.

## 2. Se escala la matriz de SNPs.

bimsnps_IND <- read_bim(here('Datos', 'Datos_IND', 'Den_1.000', 'mG', 'mG_2', 'nSNPs_IND.bim'))
famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Den_1.000', 'mG', 'mG_2', 'nSNPs_IND.fam'))
bedsnps_IND <- BEDMatrix(here('Datos', 'Datos_IND', 'Den_1.000', 'mG', 'mG_2', 'nSNPs_IND.bed'), n = length(famsnps_IND$id), p = length(bimsnps_IND$id), simple_names = FALSE)
snps_IND <- as.matrix(bedsnps_IND)

mG_2_esc <- scale(snps_IND) %>%
	saveRDS(here('Datos', 'Datos_IND', 'Den_1.000', 'mG', 'mG_2', 'mG_2_esc.RDS'))

## 3. Calculo de la matriz de relación genómica.

mG_2_esc <- readRDS(here('Datos', 'Datos_IND', 'Den_1.000', 'mG', 'mG_2', 'mG_2_esc.RDS')) # Se carga la matriz de SPNs escalada de los 298 individuos genotipados de la población IND. 

mG_2_IND <- tcrossprod(mG_2_esc)/ncol(mG_2_esc)
diag(mG_2_IND) = diag(mG_2_IND) + 0.05

mG_2_IND %>%
  saveRDS(here('Datos', 'Datos_IND', 'Den_1.000', 'mG', 'mG_2', 'mG_2.RDS'))

## Subpoblación con 451 individuos genotipados ----

dir.create('../Datos/Datos_IND/Den_1.000/mG/mG_3') # Se crea una carpeta que contendra los 451 individuos genotipados.

# 1. Se usa el plink para seleccionar al azar 1.000 SNPs y filtrar con MAF menor al 5%.

# Se extrae del archivo de genotipos (snps.bed) los 298 individuos genotipados que hacen parte de la población IND ---
plink('--bfile snps --keep Datos_IND/Den_100.000/mG/mG_8/subpob_IND.txt --make-bed --out Datos_IND/Den_1.000/mG/mG_3/Ind_IND')

# Se filtra el archivo de genotipos anterior (Ind_IND.bed) para eliminar los SNPs con MAF < 5% ----
plink('--bfile Datos_IND/Den_1.000/mG/mG_3/Ind_IND --maf 0.05 --make-bed --out Datos_IND/Den_1.000/mG/mG_3/frec_0.05_IND') # Se indica que el número de SNPs es de 100.231.

# Se seleccionan al azar 1.000 SNPs del archivo anteriormente creado (frec_0.05_IND.bed) ----
plink('--bfile Datos_IND/Den_1.000/mG/mG_3/frec_0.05_IND --thin 0.009976953 --make-bed --out Datos_IND/Den_1.000/mG/mG_3/nSNPs_IND') # Se indica que el número de SNPs ahora es de 960.

## 2. Se escala la matriz de SNPs.

bimsnps_IND <- read_bim(here('Datos', 'Datos_IND', 'Den_1.000', 'mG', 'mG_3', 'nSNPs_IND.bim'))
famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Den_1.000', 'mG', 'mG_3', 'nSNPs_IND.fam'))
bedsnps_IND <- BEDMatrix(here('Datos', 'Datos_IND', 'Den_1.000', 'mG', 'mG_3', 'nSNPs_IND.bed'), n = length(famsnps_IND$id), p = length(bimsnps_IND$id), simple_names = FALSE)
snps_IND <- as.matrix(bedsnps_IND)

mG_3_esc <- scale(snps_IND) %>%
	saveRDS(here('Datos', 'Datos_IND', 'Den_1.000', 'mG', 'mG_3', 'mG_3_esc.RDS'))

## 3. Calculo de la matriz de relación genómica.

mG_3_esc <- readRDS(here('Datos', 'Datos_IND', 'Den_1.000', 'mG', 'mG_3', 'mG_3_esc.RDS')) # Se carga la matriz de SPNs escalada de los 451 individuos genotipados de la población IND. 

mG_3_IND <- tcrossprod(mG_3_esc)/ncol(mG_3_esc)
diag(mG_3_IND) = diag(mG_3_IND) + 0.05

mG_3_IND %>%
  saveRDS(here('Datos', 'Datos_IND', 'Den_1.000', 'mG', 'mG_3', 'mG_3.RDS'))
```

# 18. A continuación se calcula la matriz H para diferentes densidades de SNPs.

```{r Calculo de la matriz H para diferentes densidades de SNPs}

fn.mH <- function(ped, mG) { # Esta función recibe como argumentos los datos con estructura (id | sire | dam | Gen (TRUE/FALSE)) y la matriz de relaciones genómicas.
  
  # 1. Se calcula la matriz de relaciones aditivas con base en el pedigrí (A)
  
  ped_edit <- editPed( # Esta función ordena el pedigrí.
    sire = ped$sire,
    dam = ped$dam,
    label = ped$id
    )
  pedi <- pedigree( # Aquí se usa la salida anterior (ya ordenado) y se crea un objeto de clase pedigree.
    sire = ped_edit$sire,
    dam = ped_edit$dam,
    label = ped_edit$label
  )
  Matrix_A <- getA(ped = pedi) # Esto dara la matriz de relaciones aditivas A.
 
  # 2. De lo anterior (Matriz_A) se extraen las partes correspondientes a individuos no genotipados (1) y genotipados (2)
  
  # Individuos no genotipados:
  A_11 <- Matrix_A[ped$Genotiped != 1, ped$Genotiped != 1]
  # Individuos genotipados:
  A_22 <- Matrix_A[ped$Genotiped == 1, ped$Genotiped == 1]
  # Individuos no genotipados (en filas) y genotipados (en columnas):
  A_12 <- Matrix_A[ped$Genotiped != 1, ped$Genotiped == 1]
  # Transpuesta de la anterior (individuos no genotipados en columnas y genotipados en filas):
  A_21 <- t(A_12)
  
  # 3. Se coloca el nombre de las filas y y de las columnas de la matriz G según los individuos genotipados
  
  rownames(mG) <- ped$id[ped$Genotiped == 1]
  colnames(mG) <- ped$id[ped$Genotiped == 1]
  
  # 4. Teniendo todos los componentes de la matriz H, se procede a su construcción y a calcular su inversa
  
  H_11 <- A_11 - 
    (A_12 %*% solve(A_22) %*% A_21) + 
    (A_12 %*% solve(A_22) %*% mG %*% solve(A_22) %*% A_21)
  H_12 <- A_12 %*% solve(A_22) %*% mG
  H_21 <- t(H_12)
  H_22 <- mG
  
  H_11_H_12 <- cbind(H_11, H_12)
  H_21_H_22 <- cbind(H_21, H_22)
  mH <- rbind(H_11_H_12, H_21_H_22)
  
  mH <- mH[order(as.numeric(rownames(mH))), order(as.numeric(colnames(mH)))]
  mH <- Matrix(mH)
  
  # 5. Finalmente se indica retornar la inversa de la matriz H (mH_1)
  
  return(mH)
  }

#### Población de arroz IND (10.000 SNPs) ----

dir.create('../Datos/Datos_IND/Den_10.000/mH') # Se crea el directorio donde se guardara la matriz H para la pobación IND considerando una densidad de genotipado de 10.000 SNPs.

#########################################################
# Pedigrí 1: 2000 individuos simulados en 10 generaciones
#########################################################

dir.create('../Datos/Datos_IND/Den_10.000/mH/Ped_1') # Se crea el directorio donde se guardara la matriz H para las subpoblaciones del pedigrí 1.

## 1. Subpoblación con 148 individuos genotipados

dir.create('../Datos/Datos_IND/Den_10.000/mH/Ped_1/mH_1') # Se crea el directorio donde se guardara la matriz H para la subpoblación con 148 individuos genotipados.

# Pedigrí ----

famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'nSNPs_IND.fam')) %>% # Se importa el archivo .fam obtenido usando plink y que posteriomente se uso para crear la hoja de parámetros para ejecutar el software molcoanc.
  as_tibble() %>%
  select(fam) %>%
  mutate(id = 2001:2451)

ped_IND_148 <- read_delim(here('Datos', 'Datos_IND', 'Den_100.000', 'mG', 'mG_2', 'subpob_IND.txt'), delim = '\t', col_names = FALSE) %>% # Se importa el conjunto de datos donde esta la identificación de los 148 individuos genotipados.
  as_tibble() %>%
  select(X1) %>%
  rename(fam = X1) %>%
  right_join(x = famsnps_IND, by = 'fam') %>%
  mutate(Genotiped = TRUE) %>% # Se indica con TRUE que estos individuos estan genotipados.
  select(-fam)

ped_IND <- read_delim(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'Molcoanc_12', 'geneal_IND.csv'), delim = '\t') %>% # Se importa el pedigrí creado son el software molcoanc.
  na_if(0) %>% # Para usar la función para calcular la matriz A y su inversa, todos los padres y madres faltantes (en este caso 0), deben estar como NA.
  full_join(y = ped_IND_148, by = 'id') %>%
  mutate(Genotiped = replace_na(Genotiped, FALSE)) # Se especifican los individuos no genotipados (NA) como FALSE.

# Matriz G ----

mG_1_IND <- readRDS(here('Datos', 'Datos_IND', 'Den_10.000', 'mG', 'mG_1', 'mG_1.RDS')) # Se carga la matriz G de los 148 individuos genotipados de la población IND. 

# Cálculo de la matriz H ----

mH_1_IND <- fn.mH(ped = ped_IND, mG = mG_1_IND) %>%
  saveRDS(here('Datos', 'Datos_IND', 'Den_10.000', 'mH', 'Ped_1', 'mH_1', 'mH_1.RDS'))

mH_1_IND[1:10, 1:10]
mH_1_IND[1990:2000, 1990:2000]
mH_1_IND[2001:2011, 2001:2011]
diag(mH_1_IND)

## 2. Subpoblación con 298 individuos genotipados

dir.create('../Datos/Datos_IND/Den_10.000/mH/Ped_1/mH_2') # Se crea el directorio donde se guardara la matriz H para la subpoblación con 298 individuos genotipados.

# Pedigrí ----

famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'nSNPs_IND.fam')) %>% # Se importa el archivo .fam obtenido usando plink y que posteriomente se uso para crear la hoja de parámetros para ejecutar el software molcoanc.
  as_tibble() %>%
  select(fam) %>%
  mutate(id = 2001:2451)

ped_IND_298 <- read_delim(here('Datos', 'Datos_IND', 'Den_100.000', 'mG', 'mG_5', 'subpob_IND.txt'), delim = '\t', col_names = FALSE) %>% # Se importa el conjunto de datos donde esta la identificación de los 298 individuos genotipados.
  as_tibble() %>%
  select(X1) %>%
  rename(fam = X1) %>%
  right_join(x = famsnps_IND, by = 'fam') %>%
  mutate(Genotiped = TRUE) %>% # Se indica con TRUE que estos individuos estan genotipados.
  select(-fam)

ped_IND <- read_delim(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'Molcoanc_12', 'geneal_IND.csv'), delim = '\t') %>% # Se importa el pedigrí creado son el software molcoanc.
  na_if(0) %>% # Para usar la función para calcular la matriz A y su inversa, todos los padres y madres faltantes (en este caso 0), deben estar como NA.
  full_join(y = ped_IND_298, by = 'id') %>%
  mutate(Genotiped = replace_na(Genotiped, FALSE)) # Se especifican los individuos no genotipados (NA) como FALSE.

# Matriz G ----

mG_2_IND <- readRDS(here('Datos', 'Datos_IND', 'Den_10.000', 'mG', 'mG_2', 'mG_2.RDS')) # Se carga la matriz G de los 298 individuos genotipados de la población IND. 

# Cálculo de la matriz H ----

mH_2_IND <- fn.mH(ped = ped_IND, mG = mG_2_IND) %>%
  saveRDS(here('Datos', 'Datos_IND', 'Den_10.000', 'mH', 'Ped_1', 'mH_2', 'mH_2.RDS'))

mH_2_IND[1:10, 1:10]
mH_2_IND[1990:2000, 1990:2000]
mH_2_IND[2001:2011, 2001:2011]
diag(mH_2_IND)

## 3. Subpoblación con 451 individuos genotipados

dir.create('../Datos/Datos_IND/Den_10.000/mH/Ped_1/mH_3') # Se crea el directorio donde se guardara la matriz H para la subpoblación con 451 individuos genotipados.

# Pedigrí ----

famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'nSNPs_IND.fam')) %>% # Se importa el archivo .fam obtenido usando plink y que posteriomente se uso para crear la hoja de parámetros para ejecutar el software molcoanc.
  as_tibble() %>%
  select(fam) %>%
  mutate(id = 2001:2451)

ped_IND_451 <- read_delim(here('Datos', 'Datos_IND', 'Den_100.000', 'mG', 'mG_8', 'subpob_IND.txt'), delim = '\t', col_names = FALSE) %>% # Se importa el conjunto de datos donde esta la identificación de los 451 individuos genotipados.
  as_tibble() %>%
  select(X1) %>%
  rename(fam = X1) %>%
  right_join(x = famsnps_IND, by = 'fam') %>%
  mutate(Genotiped = TRUE) %>% # Se indica con TRUE que estos individuos estan genotipados.
  select(-fam)

ped_IND <- read_delim(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'Molcoanc_12', 'geneal_IND.csv'), delim = '\t') %>% # Se importa el pedigrí creado son el software molcoanc.
  na_if(0) %>% # Para usar la función para calcular la matriz A y su inversa, todos los padres y madres faltantes (en este caso 0), deben estar como NA.
  full_join(y = ped_IND_451, by = 'id') %>%
  mutate(Genotiped = replace_na(Genotiped, FALSE)) # Se especifican los individuos no genotipados (NA) como FALSE.

# Matriz G ----

mG_3_IND <- readRDS(here('Datos', 'Datos_IND', 'Den_10.000', 'mG', 'mG_3', 'mG_3.RDS')) # Se carga la matriz G de los 451 individuos genotipados de la población IND. 

# Cálculo de la matriz H ----

mH_3_IND <- fn.mH(ped = ped_IND, mG = mG_3_IND) %>%
  saveRDS(here('Datos', 'Datos_IND', 'Den_10.000', 'mH', 'Ped_1', 'mH_3', 'mH_3.RDS'))

mH_3_IND[1:10, 1:10]
mH_3_IND[1990:2000, 1990:2000]
mH_3_IND[2001:2011, 2001:2011]
diag(mH_3_IND)

#######################################################
# Pedigrí 2: 520 individuos simulados en 4 generaciones
#######################################################

dir.create('../Datos/Datos_IND/Den_10.000/mH/Ped_2') # Se crea el directorio donde se guardara la matriz H para las subpoblaciones del pedigrí 2.

## 1. Subpoblación con 148 individuos genotipados

dir.create('../Datos/Datos_IND/Den_10.000/mH/Ped_2/mH_1') # Se crea el directorio donde se guardara la matriz H para la subpoblación con 148 individuos genotipados.

# Pedigrí ----

famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'nSNPs_IND.fam')) %>% # Se importa el archivo .fam obtenido usando plink y que posteriomente se uso para crear la hoja de parámetros para ejecutar el software molcoanc.
  as_tibble() %>%
  select(fam) %>%
  mutate(id = 521:971)

ped_IND_148 <- read_delim(here('Datos', 'Datos_IND', 'Den_100.000', 'mG', 'mG_2', 'subpob_IND.txt'), delim = '\t', col_names = FALSE) %>% # Se importa el conjunto de datos donde esta la identificación de los 148 individuos genotipados.
  as_tibble() %>%
  select(X1) %>%
  rename(fam = X1) %>%
  right_join(x = famsnps_IND, by = 'fam') %>%
  mutate(Genotiped = TRUE) %>% # Se indica con TRUE que estos individuos estan genotipados.
  select(-fam)

ped_IND <- read_delim(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'Molcoanc_13', 'geneal_IND.csv'), delim = ' ') %>% # Se importa el pedigrí creado son el software molcoanc.
  na_if(0) %>% # Para usar la función para calcular la matriz A y su inversa, todos los padres y madres faltantes (en este caso 0), deben estar como NA.
  full_join(y = ped_IND_148, by = 'id') %>%
  mutate(Genotiped = replace_na(Genotiped, FALSE)) # Se especifican los individuos no genotipados (NA) como FALSE.

# Matriz G ----

mG_1_IND <- readRDS(here('Datos', 'Datos_IND', 'Den_10.000', 'mG', 'mG_1', 'mG_1.RDS')) # Se carga la matriz G de los 148 individuos genotipados de la población IND. 

# Cálculo de la matriz H ----

mH_1_IND <- fn.mH(ped = ped_IND, mG = mG_1_IND) %>%
  saveRDS(here('Datos', 'Datos_IND', 'Den_10.000', 'mH', 'Ped_2', 'mH_1', 'mH_1.RDS'))

mH_1_IND[1:10, 1:10]
mH_1_IND[510:520, 510:520]
mH_1_IND[521:531, 521:531]
diag(mH_1_IND)

## 2. Subpoblación con 298 individuos genotipados

dir.create('../Datos/Datos_IND/Den_10.000/mH/Ped_2/mH_2') # Se crea el directorio donde se guardara la matriz H para la subpoblación con 298 individuos genotipados.

# Pedigrí ----

famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'nSNPs_IND.fam')) %>% # Se importa el archivo .fam obtenido usando plink y que posteriomente se uso para crear la hoja de parámetros para ejecutar el software molcoanc.
  as_tibble() %>%
  select(fam) %>%
  mutate(id = 521:971)

ped_IND_298 <- read_delim(here('Datos', 'Datos_IND', 'Den_100.000', 'mG', 'mG_5', 'subpob_IND.txt'), delim = '\t', col_names = FALSE) %>% # Se importa el conjunto de datos donde esta la identificación de los 298 individuos genotipados.
  as_tibble() %>%
  select(X1) %>%
  rename(fam = X1) %>%
  right_join(x = famsnps_IND, by = 'fam') %>%
  mutate(Genotiped = TRUE) %>% # Se indica con TRUE que estos individuos estan genotipados.
  select(-fam)

ped_IND <- read_delim(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'Molcoanc_13', 'geneal_IND.csv'), delim = ' ') %>% # Se importa el pedigrí creado son el software molcoanc.
  na_if(0) %>% # Para usar la función para calcular la matriz A y su inversa, todos los padres y madres faltantes (en este caso 0), deben estar como NA.
  full_join(y = ped_IND_298, by = 'id') %>%
  mutate(Genotiped = replace_na(Genotiped, FALSE)) # Se especifican los individuos no genotipados (NA) como FALSE.

# Matriz G ----

mG_2_IND <- readRDS(here('Datos', 'Datos_IND', 'Den_10.000', 'mG', 'mG_2', 'mG_2.RDS')) # Se carga la matriz G de los 298 individuos genotipados de la población IND. 

# Cálculo de la matriz H ----

mH_2_IND <- fn.mH(ped = ped_IND, mG = mG_2_IND) %>%
  saveRDS(here('Datos', 'Datos_IND', 'Den_10.000', 'mH', 'Ped_2', 'mH_2', 'mH_2.RDS'))

mH_2_IND[1:10, 1:10]
mH_2_IND[510:520, 510:520]
mH_2_IND[521:531, 521:531]
diag(mH_2_IND)

## 3. Subpoblación con 451 individuos genotipados

dir.create('../Datos/Datos_IND/Den_10.000/mH/Ped_2/mH_3') # Se crea el directorio donde se guardara la matriz H para la subpoblación con 451 individuos genotipados.

# Pedigrí ----

famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'nSNPs_IND.fam')) %>% # Se importa el archivo .fam obtenido usando plink y que posteriomente se uso para crear la hoja de parámetros para ejecutar el software molcoanc.
  as_tibble() %>%
  select(fam) %>%
  mutate(id = 521:971)

ped_IND_451 <- read_delim(here('Datos', 'Datos_IND', 'Den_100.000', 'mG', 'mG_8', 'subpob_IND.txt'), delim = '\t', col_names = FALSE) %>% # Se importa el conjunto de datos donde esta la identificación de los 451 individuos genotipados.
  as_tibble() %>%
  select(X1) %>%
  rename(fam = X1) %>%
  right_join(x = famsnps_IND, by = 'fam') %>%
  mutate(Genotiped = TRUE) %>% # Se indica con TRUE que estos individuos estan genotipados.
  select(-fam)

ped_IND <- read_delim(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'Molcoanc_13', 'geneal_IND.csv'), delim = ' ') %>% # Se importa el pedigrí creado son el software molcoanc.
  na_if(0) %>% # Para usar la función para calcular la matriz A y su inversa, todos los padres y madres faltantes (en este caso 0), deben estar como NA.
  full_join(y = ped_IND_451, by = 'id') %>%
  mutate(Genotiped = replace_na(Genotiped, FALSE)) # Se especifican los individuos no genotipados (NA) como FALSE.

# Matriz G ----

mG_3_IND <- readRDS(here('Datos', 'Datos_IND', 'Den_10.000', 'mG', 'mG_3', 'mG_3.RDS')) # Se carga la matriz G de los 451 individuos genotipados de la población IND. 

# Cálculo de la matriz H ----

mH_3_IND <- fn.mH(ped = ped_IND, mG = mG_3_IND) mH_3_IND%>%
  saveRDS(here('Datos', 'Datos_IND', 'Den_10.000', 'mH', 'Ped_2', 'mH_3', 'mH_3.RDS'))

mH_3_IND[1:10, 1:10]
mH_3_IND[510:520, 510:520]
mH_3_IND[521:531, 521:531]
diag(mH_3_IND)

########################################################
# Pedigrí 3: 1210 individuos simulados en 7 generaciones
########################################################

dir.create('../Datos/Datos_IND/Den_10.000/mH/Ped_3') # Se crea el directorio donde se guardara la matriz H para las subpoblaciones del pedigrí 3.

## 1. Subpoblación con 148 individuos genotipados

dir.create('../Datos/Datos_IND/Den_10.000/mH/Ped_3/mH_1') # Se crea el directorio donde se guardara la matriz H para la subpoblación con 148 individuos genotipados.

# Pedigrí ----

famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'nSNPs_IND.fam')) %>% # Se importa el archivo .fam obtenido usando plink y que posteriomente se uso para crear la hoja de parámetros para ejecutar el software molcoanc.
  as_tibble() %>%
  select(fam) %>%
  mutate(id = 1211:1661)

ped_IND_148 <- read_delim(here('Datos', 'Datos_IND', 'Den_100.000', 'mG', 'mG_2', 'subpob_IND.txt'), delim = '\t', col_names = FALSE) %>% # Se importa el conjunto de datos donde esta la identificación de los 148 individuos genotipados.
  as_tibble() %>%
  select(X1) %>%
  rename(fam = X1) %>%
  right_join(x = famsnps_IND, by = 'fam') %>%
  mutate(Genotiped = TRUE) %>% # Se indica con TRUE que estos individuos estan genotipados.
  select(-fam)

ped_IND <- read_delim(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'Molcoanc_14', 'geneal_IND.csv'), delim = ' ') %>% # Se importa el pedigrí creado son el software molcoanc.
  na_if(0) %>% # Para usar la función para calcular la matriz A y su inversa, todos los padres y madres faltantes (en este caso 0), deben estar como NA.
  full_join(y = ped_IND_148, by = 'id') %>%
  mutate(Genotiped = replace_na(Genotiped, FALSE)) # Se especifican los individuos no genotipados (NA) como FALSE.

# Matriz G ----

mG_1_IND <- readRDS(here('Datos', 'Datos_IND', 'Den_10.000', 'mG', 'mG_1', 'mG_1.RDS')) # Se carga la matriz G de los 148 individuos genotipados de la población IND. 

# Cálculo de la matriz H ----

mH_1_IND <- fn.mH(ped = ped_IND, mG = mG_1_IND) %>%
  saveRDS(here('Datos', 'Datos_IND', 'Den_10.000', 'mH', 'Ped_3', 'mH_1', 'mH_1.RDS'))

mH_1_IND[1:10, 1:10]
mH_1_IND[1200:1210, 1200:1210]
mH_1_IND[1211:1221, 1211:1221]
diag(mH_1_IND)

## 2. Subpoblación con 298 individuos genotipados

dir.create('../Datos/Datos_IND/Den_10.000/mH/Ped_3/mH_2') # Se crea el directorio donde se guardara la matriz H para la subpoblación con 298 individuos genotipados.

# Pedigrí ----

famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'nSNPs_IND.fam')) %>% # Se importa el archivo .fam obtenido usando plink y que posteriomente se uso para crear la hoja de parámetros para ejecutar el software molcoanc.
  as_tibble() %>%
  select(fam) %>%
  mutate(id = 1211:1661)

ped_IND_298 <- read_delim(here('Datos', 'Datos_IND', 'Den_100.000', 'mG', 'mG_5', 'subpob_IND.txt'), delim = '\t', col_names = FALSE) %>% # Se importa el conjunto de datos donde esta la identificación de los 298 individuos genotipados.
  as_tibble() %>%
  select(X1) %>%
  rename(fam = X1) %>%
  right_join(x = famsnps_IND, by = 'fam') %>%
  mutate(Genotiped = TRUE) %>% # Se indica con TRUE que estos individuos estan genotipados.
  select(-fam)

ped_IND <- read_delim(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'Molcoanc_14', 'geneal_IND.csv'), delim = ' ') %>% # Se importa el pedigrí creado son el software molcoanc.
  na_if(0) %>% # Para usar la función para calcular la matriz A y su inversa, todos los padres y madres faltantes (en este caso 0), deben estar como NA.
  full_join(y = ped_IND_298, by = 'id') %>%
  mutate(Genotiped = replace_na(Genotiped, FALSE)) # Se especifican los individuos no genotipados (NA) como FALSE.

# Matriz G ----

mG_2_IND <- readRDS(here('Datos', 'Datos_IND', 'Den_10.000', 'mG', 'mG_2', 'mG_2.RDS')) # Se carga la matriz G de los 298 individuos genotipados de la población IND. 

# Cálculo de la matriz H ----

mH_2_IND <- fn.mH(ped = ped_IND, mG = mG_2_IND) %>%
  saveRDS(here('Datos', 'Datos_IND', 'Den_10.000', 'mH', 'Ped_3', 'mH_2', 'mH_2.RDS'))

mH_2_IND[1:10, 1:10]
mH_2_IND[1200:1210, 1200:1210]
mH_2_IND[1211:1221, 1211:1221]
diag(mH_2_IND)

## 3. Subpoblación con 451 individuos genotipados

dir.create('../Datos/Datos_IND/Den_10.000/mH/Ped_3/mH_3') # Se crea el directorio donde se guardara la matriz H para la subpoblación con 451 individuos genotipados.

# Pedigrí ----

famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'nSNPs_IND.fam')) %>% # Se importa el archivo .fam obtenido usando plink y que posteriomente se uso para crear la hoja de parámetros para ejecutar el software molcoanc.
  as_tibble() %>%
  select(fam) %>%
  mutate(id = 1211:1661)

ped_IND_451 <- read_delim(here('Datos', 'Datos_IND', 'Den_100.000', 'mG', 'mG_8', 'subpob_IND.txt'), delim = '\t', col_names = FALSE) %>% # Se importa el conjunto de datos donde esta la identificación de los 451 individuos genotipados.
  as_tibble() %>%
  select(X1) %>%
  rename(fam = X1) %>%
  right_join(x = famsnps_IND, by = 'fam') %>%
  mutate(Genotiped = TRUE) %>% # Se indica con TRUE que estos individuos estan genotipados.
  select(-fam)

ped_IND <- read_delim(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'Molcoanc_14', 'geneal_IND.csv'), delim = ' ') %>% # Se importa el pedigrí creado son el software molcoanc.
  na_if(0) %>% # Para usar la función para calcular la matriz A y su inversa, todos los padres y madres faltantes (en este caso 0), deben estar como NA.
  full_join(y = ped_IND_451, by = 'id') %>%
  mutate(Genotiped = replace_na(Genotiped, FALSE)) # Se especifican los individuos no genotipados (NA) como FALSE.

# Matriz G ----

mG_3_IND <- readRDS(here('Datos', 'Datos_IND', 'Den_10.000', 'mG', 'mG_3', 'mG_3.RDS')) # Se carga la matriz G de los 451 individuos genotipados de la población IND. 

# Cálculo de la matriz H ----

mH_3_IND <- fn.mH(ped = ped_IND, mG = mG_3_IND) %>%
  saveRDS(here('Datos', 'Datos_IND', 'Den_10.000', 'mH', 'Ped_3', 'mH_3', 'mH_3.RDS'))

mH_3_IND[1:10, 1:10]
mH_3_IND[1200:1210, 1200:1210]
mH_3_IND[1211:1221, 1211:1221]
diag(mH_3_IND)

#######################################################
# Pedigrí 4: 300 individuos simulados en 3 generaciones
#######################################################

dir.create('../Datos/Datos_IND/Den_10.000/mH/Ped_4') # Se crea el directorio donde se guardara la matriz H para las subpoblaciones del pedigrí 4.

## 1. Subpoblación con 148 individuos genotipados

dir.create('../Datos/Datos_IND/Den_10.000/mH/Ped_4/mH_1') # Se crea el directorio donde se guardara la matriz H para la subpoblación con 148 individuos genotipados.

# Pedigrí ----

famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'nSNPs_IND.fam')) %>% # Se importa el archivo .fam obtenido usando plink y que posteriomente se uso para crear la hoja de parámetros para ejecutar el software molcoanc.
  as_tibble() %>%
  select(fam) %>%
  mutate(id = 301:751)

ped_IND_148 <- read_delim(here('Datos', 'Datos_IND', 'Den_100.000', 'mG', 'mG_2', 'subpob_IND.txt'), delim = '\t', col_names = FALSE) %>% # Se importa el conjunto de datos donde esta la identificación de los 148 individuos genotipados.
  as_tibble() %>%
  select(X1) %>%
  rename(fam = X1) %>%
  right_join(x = famsnps_IND, by = 'fam') %>%
  mutate(Genotiped = TRUE) %>% # Se indica con TRUE que estos individuos estan genotipados.
  select(-fam)

ped_IND <- read_delim(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'Molcoanc_15', 'geneal_IND.csv'), delim = ' ') %>% # Se importa el pedigrí creado son el software molcoanc.
  na_if(0) %>% # Para usar la función para calcular la matriz A y su inversa, todos los padres y madres faltantes (en este caso 0), deben estar como NA.
  full_join(y = ped_IND_148, by = 'id') %>%
  mutate(Genotiped = replace_na(Genotiped, FALSE)) # Se especifican los individuos no genotipados (NA) como FALSE.

# Matriz G ----

mG_1_IND <- readRDS(here('Datos', 'Datos_IND', 'Den_10.000', 'mG', 'mG_1', 'mG_1.RDS')) # Se carga la matriz G de los 148 individuos genotipados de la población IND. 

# Cálculo de la matriz H ----

mH_1_IND <- fn.mH(ped = ped_IND, mG = mG_1_IND) %>%
  saveRDS(here('Datos', 'Datos_IND', 'Den_10.000', 'mH', 'Ped_4', 'mH_1', 'mH_1.RDS'))

mH_1_IND[1:10, 1:10]
mH_1_IND[300:310, 300:310]
mH_1_IND[301:311, 301:311]
diag(mH_1_IND)

## 2. Subpoblación con 298 individuos genotipados

dir.create('../Datos/Datos_IND/Den_10.000/mH/Ped_4/mH_2') # Se crea el directorio donde se guardara la matriz H para la subpoblación con 298 individuos genotipados.

# Pedigrí ----

famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'nSNPs_IND.fam')) %>% # Se importa el archivo .fam obtenido usando plink y que posteriomente se uso para crear la hoja de parámetros para ejecutar el software molcoanc.
  as_tibble() %>%
  select(fam) %>%
  mutate(id = 301:751)

ped_IND_298 <- read_delim(here('Datos', 'Datos_IND', 'Den_100.000', 'mG', 'mG_5', 'subpob_IND.txt'), delim = '\t', col_names = FALSE) %>% # Se importa el conjunto de datos donde esta la identificación de los 298 individuos genotipados.
  as_tibble() %>%
  select(X1) %>%
  rename(fam = X1) %>%
  right_join(x = famsnps_IND, by = 'fam') %>%
  mutate(Genotiped = TRUE) %>% # Se indica con TRUE que estos individuos estan genotipados.
  select(-fam)

ped_IND <- read_delim(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'Molcoanc_15', 'geneal_IND.csv'), delim = ' ') %>% # Se importa el pedigrí creado son el software molcoanc.
  na_if(0) %>% # Para usar la función para calcular la matriz A y su inversa, todos los padres y madres faltantes (en este caso 0), deben estar como NA.
  full_join(y = ped_IND_298, by = 'id') %>%
  mutate(Genotiped = replace_na(Genotiped, FALSE)) # Se especifican los individuos no genotipados (NA) como FALSE.

# Matriz G ----

mG_2_IND <- readRDS(here('Datos', 'Datos_IND', 'Den_10.000', 'mG', 'mG_2', 'mG_2.RDS')) # Se carga la matriz G de los 298 individuos genotipados de la población IND. 

# Cálculo de la matriz H ----

mH_2_IND <- fn.mH(ped = ped_IND, mG = mG_2_IND) %>%
  saveRDS(here('Datos', 'Datos_IND', 'Den_10.000', 'mH', 'Ped_4', 'mH_2', 'mH_2.RDS'))

mH_2_IND[1:10, 1:10]
mH_2_IND[300:310, 300:310]
mH_2_IND[301:311, 301:311]
diag(mH_2_IND)

## 3. Subpoblación con 451 individuos genotipados

dir.create('../Datos/Datos_IND/Den_10.000/mH/Ped_4/mH_3') # Se crea el directorio donde se guardara la matriz H para la subpoblación con 451 individuos genotipados.

# Pedigrí ----

famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'nSNPs_IND.fam')) %>% # Se importa el archivo .fam obtenido usando plink y que posteriomente se uso para crear la hoja de parámetros para ejecutar el software molcoanc.
  as_tibble() %>%
  select(fam) %>%
  mutate(id = 301:751)

ped_IND_451 <- read_delim(here('Datos', 'Datos_IND', 'Den_100.000', 'mG', 'mG_8', 'subpob_IND.txt'), delim = '\t', col_names = FALSE) %>% # Se importa el conjunto de datos donde esta la identificación de los 451 individuos genotipados.
  as_tibble() %>%
  select(X1) %>%
  rename(fam = X1) %>%
  right_join(x = famsnps_IND, by = 'fam') %>%
  mutate(Genotiped = TRUE) %>% # Se indica con TRUE que estos individuos estan genotipados.
  select(-fam)

ped_IND <- read_delim(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'Molcoanc_15', 'geneal_IND.csv'), delim = ' ') %>% # Se importa el pedigrí creado son el software molcoanc.
  na_if(0) %>% # Para usar la función para calcular la matriz A y su inversa, todos los padres y madres faltantes (en este caso 0), deben estar como NA.
  full_join(y = ped_IND_451, by = 'id') %>%
  mutate(Genotiped = replace_na(Genotiped, FALSE)) # Se especifican los individuos no genotipados (NA) como FALSE.

# Matriz G ----

mG_3_IND <- readRDS(here('Datos', 'Datos_IND', 'Den_10.000', 'mG', 'mG_3', 'mG_3.RDS')) # Se carga la matriz G de los 451 individuos genotipados de la población IND. 

# Cálculo de la matriz H ----

mH_3_IND <- fn.mH(ped = ped_IND, mG = mG_3_IND) %>%
  saveRDS(here('Datos', 'Datos_IND', 'Den_10.000', 'mH', 'Ped_4', 'mH_3', 'mH_3.RDS'))

mH_3_IND[1:10, 1:10]
mH_3_IND[300:310, 300:310]
mH_3_IND[301:311, 301:311]
diag(mH_2_IND)

########################################################
# Pedigrí 5: 1530 individuos simulados en 9 generaciones
########################################################

dir.create('../Datos/Datos_IND/Den_10.000/mH/Ped_5') # Se crea el directorio donde se guardara la matriz H para las subpoblaciones del pedigrí 5.

## 1. Subpoblación con 148 individuos genotipados

dir.create('../Datos/Datos_IND/Den_10.000/mH/Ped_5/mH_1') # Se crea el directorio donde se guardara la matriz H para la subpoblación con 148 individuos genotipados.

# Pedigrí ----

famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'nSNPs_IND.fam')) %>% # Se importa el archivo .fam obtenido usando plink y que posteriomente se uso para crear la hoja de parámetros para ejecutar el software molcoanc.
  as_tibble() %>%
  select(fam) %>%
  mutate(id = 1531:1981)

ped_IND_148 <- read_delim(here('Datos', 'Datos_IND', 'Den_100.000', 'mG', 'mG_2', 'subpob_IND.txt'), delim = '\t', col_names = FALSE) %>% # Se importa el conjunto de datos donde esta la identificación de los 148 individuos genotipados.
  select(X1) %>%
  rename(fam = X1) %>%
  right_join(x = famsnps_IND, by = 'fam') %>%
  mutate(Genotiped = TRUE) %>% # Se indica con TRUE que estos individuos estan genotipados.
  select(-fam)

ped_IND <- read_delim(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'Molcoanc_16', 'geneal_IND.csv'), delim = ' ') %>% # Se importa el pedigrí creado son el software molcoanc.
  na_if(0) %>% # Para usar la función para calcular la matriz A y su inversa, todos los padres y madres faltantes (en este caso 0), deben estar como NA.
  full_join(y = ped_IND_148, by = 'id') %>%
  mutate(Genotiped = replace_na(Genotiped, FALSE)) # Se especifican los individuos no genotipados (NA) como FALSE.

# Matriz G ----

mG_1_IND <- readRDS(here('Datos', 'Datos_IND', 'Den_10.000', 'mG', 'mG_1', 'mG_1.RDS')) # Se carga la matriz G de los 148 individuos genotipados de la población IND. 

# Cálculo de la matriz H ----

mH_1_IND <- fn.mH(ped = ped_IND, mG = mG_1_IND) %>%
  saveRDS(here('Datos', 'Datos_IND', 'Den_10.000', 'mH', 'Ped_5', 'mH_1', 'mH_1.RDS'))

mH_1_IND[1:10, 1:10]
mH_1_IND[1520:1530, 1520:1530]
mH_1_IND[1531:1541, 1531:1541]
diag(mH_1_IND)

## 2. Subpoblación con 298 individuos genotipados

dir.create('../Datos/Datos_IND/Den_10.000/mH/Ped_5/mH_2') # Se crea el directorio donde se guardara la matriz H para la subpoblación con 298 individuos genotipados.

# Pedigrí ----

famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'nSNPs_IND.fam')) %>% # Se importa el archivo .fam obtenido usando plink y que posteriomente se uso para crear la hoja de parámetros para ejecutar el software molcoanc.
  as_tibble() %>%
  select(fam) %>%
  mutate(id = 1531:1981)

ped_IND_298 <- read_delim(here('Datos', 'Datos_IND', 'Den_100.000', 'mG', 'mG_5', 'subpob_IND.txt'), delim = '\t', col_names = FALSE) %>% # Se importa el conjunto de datos donde esta la identificación de los 298 individuos genotipados.
  select(X1) %>%
  rename(fam = X1) %>%
  right_join(x = famsnps_IND, by = 'fam') %>%
  mutate(Genotiped = TRUE) %>% # Se indica con TRUE que estos individuos estan genotipados.
  select(-fam)

ped_IND <- read_delim(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'Molcoanc_16', 'geneal_IND.csv'), delim = ' ') %>% # Se importa el pedigrí creado son el software molcoanc.
  na_if(0) %>% # Para usar la función para calcular la matriz A y su inversa, todos los padres y madres faltantes (en este caso 0), deben estar como NA.
  full_join(y = ped_IND_298, by = 'id') %>%
  mutate(Genotiped = replace_na(Genotiped, FALSE)) # Se especifican los individuos no genotipados (NA) como FALSE.

# Matriz G ----

mG_2_IND <- readRDS(here('Datos', 'Datos_IND', 'Den_10.000', 'mG', 'mG_2', 'mG_2.RDS')) # Se carga la matriz G de los 298 individuos genotipados de la población IND. 

# Cálculo de la matriz H ----

mH_2_IND <- fn.mH(ped = ped_IND, mG = mG_2_IND) %>%
  saveRDS(here('Datos', 'Datos_IND', 'Den_10.000', 'mH', 'Ped_5', 'mH_2', 'mH_2.RDS'))

mH_2_IND[1:10, 1:10]
mH_2_IND[1520:1530, 1520:1530]
mH_2_IND[1531:1541, 1531:1541]
diag(mH_2_IND)

## 3. Subpoblación con 451 individuos genotipados

dir.create('../Datos/Datos_IND/Den_10.000/mH/Ped_5/mH_3') # Se crea el directorio donde se guardara la matriz H para la subpoblación con 451 individuos genotipados.

# Pedigrí ----

famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'nSNPs_IND.fam')) %>% # Se importa el archivo .fam obtenido usando plink y que posteriomente se uso para crear la hoja de parámetros para ejecutar el software molcoanc.
  as_tibble() %>%
  select(fam) %>%
  mutate(id = 1531:1981)

ped_IND_451 <- read_delim(here('Datos', 'Datos_IND', 'Den_100.000', 'mG', 'mG_8', 'subpob_IND.txt'), delim = '\t', col_names = FALSE) %>% # Se importa el conjunto de datos donde esta la identificación de los 451 individuos genotipados.
  select(X1) %>%
  rename(fam = X1) %>%
  right_join(x = famsnps_IND, by = 'fam') %>%
  mutate(Genotiped = TRUE) %>% # Se indica con TRUE que estos individuos estan genotipados.
  select(-fam)

ped_IND <- read_delim(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'Molcoanc_16', 'geneal_IND.csv'), delim = ' ') %>% # Se importa el pedigrí creado son el software molcoanc.
  na_if(0) %>% # Para usar la función para calcular la matriz A y su inversa, todos los padres y madres faltantes (en este caso 0), deben estar como NA.
  full_join(y = ped_IND_451, by = 'id') %>%
  mutate(Genotiped = replace_na(Genotiped, FALSE)) # Se especifican los individuos no genotipados (NA) como FALSE.

# Matriz G ----

mG_3_IND <- readRDS(here('Datos', 'Datos_IND', 'Den_10.000', 'mG', 'mG_3', 'mG_3.RDS')) # Se carga la matriz G de los 451 individuos genotipados de la población IND. 

# Cálculo de la matriz H ----

mH_3_IND <- fn.mH(ped = ped_IND, mG = mG_3_IND) %>%
  saveRDS(here('Datos', 'Datos_IND', 'Den_10.000', 'mH', 'Ped_5', 'mH_3', 'mH_3.RDS'))

mH_3_IND[1:10, 1:10]
mH_3_IND[1520:1530, 1520:1530]
mH_3_IND[1531:1541, 1531:1541]
diag(mH_3_IND)

#### Población de arroz IND (1.000 SNPs) ----

dir.create('../Datos/Datos_IND/Den_1.000/mH') # Se crea el directorio donde se guardara la matriz H para la pobación IND considerando una densidad de genotipado de 1.000 SNPs.

#########################################################
# Pedigrí 1: 2000 individuos simulados en 10 generaciones
#########################################################

dir.create('../Datos/Datos_IND/Den_1.000/mH/Ped_1') # Se crea el directorio donde se guardara la matriz H para las subpoblaciones del pedigrí 1.

## 1. Subpoblación con 148 individuos genotipados

dir.create('../Datos/Datos_IND/Den_1.000/mH/Ped_1/mH_1') # Se crea el directorio donde se guardara la matriz H para la subpoblación con 148 individuos genotipados.

# Pedigrí ----

famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'nSNPs_IND.fam')) %>% # Se importa el archivo .fam obtenido usando plink y que posteriomente se uso para crear la hoja de parámetros para ejecutar el software molcoanc.
  as_tibble() %>%
  select(fam) %>%
  mutate(id = 2001:2451)

ped_IND_148 <- read_delim(here('Datos', 'Datos_IND', 'Den_100.000', 'mG', 'mG_2', 'subpob_IND.txt'), delim = '\t', col_names = FALSE) %>% # Se importa el conjunto de datos donde esta la identificación de los 148 individuos genotipados.
  as_tibble() %>%
  select(X1) %>%
  rename(fam = X1) %>%
  right_join(x = famsnps_IND, by = 'fam') %>%
  mutate(Genotiped = TRUE) %>% # Se indica con TRUE que estos individuos estan genotipados.
  select(-fam)

ped_IND <- read_delim(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'Molcoanc_12', 'geneal_IND.csv'), delim = '\t') %>% # Se importa el pedigrí creado son el software molcoanc.
  na_if(0) %>% # Para usar la función para calcular la matriz A y su inversa, todos los padres y madres faltantes (en este caso 0), deben estar como NA.
  full_join(y = ped_IND_148, by = 'id') %>%
  mutate(Genotiped = replace_na(Genotiped, FALSE)) # Se especifican los individuos no genotipados (NA) como FALSE.

# Matriz G ----

mG_1_IND <- readRDS(here('Datos', 'Datos_IND', 'Den_1.000', 'mG', 'mG_1', 'mG_1.RDS')) # Se carga la matriz G de los 148 individuos genotipados de la población IND. 

# Cálculo de la matriz H ----

mH_1_IND <- fn.mH(ped = ped_IND, mG = mG_1_IND) %>%
  saveRDS(here('Datos', 'Datos_IND', 'Den_1.000', 'mH', 'Ped_1', 'mH_1', 'mH_1.RDS'))

mH_1_IND[1:10, 1:10]
mH_1_IND[1990:2000, 1990:2000]
mH_1_IND[2001:2011, 2001:2011]
diag(mH_1_IND)

## 2. Subpoblación con 298 individuos genotipados

dir.create('../Datos/Datos_IND/Den_1.000/mH/Ped_1/mH_2') # Se crea el directorio donde se guardara la matriz H para la subpoblación con 298 individuos genotipados.

# Pedigrí ----

famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'nSNPs_IND.fam')) %>% # Se importa el archivo .fam obtenido usando plink y que posteriomente se uso para crear la hoja de parámetros para ejecutar el software molcoanc.
  as_tibble() %>%
  select(fam) %>%
  mutate(id = 2001:2451)

ped_IND_298 <- read_delim(here('Datos', 'Datos_IND', 'Den_100.000', 'mG', 'mG_5', 'subpob_IND.txt'), delim = '\t', col_names = FALSE) %>% # Se importa el conjunto de datos donde esta la identificación de los 298 individuos genotipados.
  as_tibble() %>%
  select(X1) %>%
  rename(fam = X1) %>%
  right_join(x = famsnps_IND, by = 'fam') %>%
  mutate(Genotiped = TRUE) %>% # Se indica con TRUE que estos individuos estan genotipados.
  select(-fam)

ped_IND <- read_delim(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'Molcoanc_12', 'geneal_IND.csv'), delim = '\t') %>% # Se importa el pedigrí creado son el software molcoanc.
  na_if(0) %>% # Para usar la función para calcular la matriz A y su inversa, todos los padres y madres faltantes (en este caso 0), deben estar como NA.
  full_join(y = ped_IND_298, by = 'id') %>%
  mutate(Genotiped = replace_na(Genotiped, FALSE)) # Se especifican los individuos no genotipados (NA) como FALSE.

# Matriz G ----

mG_2_IND <- readRDS(here('Datos', 'Datos_IND', 'Den_1.000', 'mG', 'mG_2', 'mG_2.RDS')) # Se carga la matriz G de los 298 individuos genotipados de la población IND. 

# Cálculo de la matriz H ----

mH_2_IND <- fn.mH(ped = ped_IND, mG = mG_2_IND) %>%
  saveRDS(here('Datos', 'Datos_IND', 'Den_1.000', 'mH', 'Ped_1', 'mH_2', 'mH_2.RDS'))

mH_2_IND[1:10, 1:10]
mH_2_IND[1990:2000, 1990:2000]
mH_2_IND[2001:2011, 2001:2011]
diag(mH_2_IND)

## 3. Subpoblación con 451 individuos genotipados

dir.create('../Datos/Datos_IND/Den_1.000/mH/Ped_1/mH_3') # Se crea el directorio donde se guardara la matriz H para la subpoblación con 451 individuos genotipados.

# Pedigrí ----

famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'nSNPs_IND.fam')) %>% # Se importa el archivo .fam obtenido usando plink y que posteriomente se uso para crear la hoja de parámetros para ejecutar el software molcoanc.
  as_tibble() %>%
  select(fam) %>%
  mutate(id = 2001:2451)

ped_IND_451 <- read_delim(here('Datos', 'Datos_IND', 'Den_100.000', 'mG', 'mG_8', 'subpob_IND.txt'), delim = '\t', col_names = FALSE) %>% # Se importa el conjunto de datos donde esta la identificación de los 451 individuos genotipados.
  as_tibble() %>%
  select(X1) %>%
  rename(fam = X1) %>%
  right_join(x = famsnps_IND, by = 'fam') %>%
  mutate(Genotiped = TRUE) %>% # Se indica con TRUE que estos individuos estan genotipados.
  select(-fam)

ped_IND <- read_delim(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'Molcoanc_12', 'geneal_IND.csv'), delim = '\t') %>% # Se importa el pedigrí creado son el software molcoanc.
  na_if(0) %>% # Para usar la función para calcular la matriz A y su inversa, todos los padres y madres faltantes (en este caso 0), deben estar como NA.
  full_join(y = ped_IND_451, by = 'id') %>%
  mutate(Genotiped = replace_na(Genotiped, FALSE)) # Se especifican los individuos no genotipados (NA) como FALSE.

# Matriz G ----

mG_3_IND <- readRDS(here('Datos', 'Datos_IND', 'Den_1.000', 'mG', 'mG_3', 'mG_3.RDS')) # Se carga la matriz G de los 451 individuos genotipados de la población IND. 

# Cálculo de la matriz H ----

mH_3_IND <- fn.mH(ped = ped_IND, mG = mG_3_IND) %>%
  saveRDS(here('Datos', 'Datos_IND', 'Den_1.000', 'mH', 'Ped_1', 'mH_3', 'mH_3.RDS'))

mH_3_IND[1:10, 1:10]
mH_3_IND[1990:2000, 1990:2000]
mH_3_IND[2001:2011, 2001:2011]
diag(mH_3_IND)

#######################################################
# Pedigrí 2: 520 individuos simulados en 4 generaciones
#######################################################

dir.create('../Datos/Datos_IND/Den_1.000/mH/Ped_2') # Se crea el directorio donde se guardara la matriz H para las subpoblaciones del pedigrí 2.

## 1. Subpoblación con 148 individuos genotipados

dir.create('../Datos/Datos_IND/Den_1.000/mH/Ped_2/mH_1') # Se crea el directorio donde se guardara la matriz H para la subpoblación con 148 individuos genotipados.

# Pedigrí ----

famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'nSNPs_IND.fam')) %>% # Se importa el archivo .fam obtenido usando plink y que posteriomente se uso para crear la hoja de parámetros para ejecutar el software molcoanc.
  as_tibble() %>%
  select(fam) %>%
  mutate(id = 521:971)

ped_IND_148 <- read_delim(here('Datos', 'Datos_IND', 'Den_100.000', 'mG', 'mG_2', 'subpob_IND.txt'), delim = '\t', col_names = FALSE) %>% # Se importa el conjunto de datos donde esta la identificación de los 148 individuos genotipados.
  as_tibble() %>%
  select(X1) %>%
  rename(fam = X1) %>%
  right_join(x = famsnps_IND, by = 'fam') %>%
  mutate(Genotiped = TRUE) %>% # Se indica con TRUE que estos individuos estan genotipados.
  select(-fam)

ped_IND <- read_delim(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'Molcoanc_13', 'geneal_IND.csv'), delim = ' ') %>% # Se importa el pedigrí creado son el software molcoanc.
  na_if(0) %>% # Para usar la función para calcular la matriz A y su inversa, todos los padres y madres faltantes (en este caso 0), deben estar como NA.
  full_join(y = ped_IND_148, by = 'id') %>%
  mutate(Genotiped = replace_na(Genotiped, FALSE)) # Se especifican los individuos no genotipados (NA) como FALSE.

# Matriz G ----

mG_1_IND <- readRDS(here('Datos', 'Datos_IND', 'Den_1.000', 'mG', 'mG_1', 'mG_1.RDS')) # Se carga la matriz G de los 148 individuos genotipados de la población IND. 

# Cálculo de la matriz H ----

mH_1_IND <- fn.mH(ped = ped_IND, mG = mG_1_IND) %>%
  saveRDS(here('Datos', 'Datos_IND', 'Den_1.000', 'mH', 'Ped_2', 'mH_1', 'mH_1.RDS'))

mH_1_IND[1:10, 1:10]
mH_1_IND[510:520, 510:520]
mH_1_IND[521:531, 521:531]
diag(mH_1_IND)

## 2. Subpoblación con 298 individuos genotipados

dir.create('../Datos/Datos_IND/Den_1.000/mH/Ped_2/mH_2') # Se crea el directorio donde se guardara la matriz H para la subpoblación con 298 individuos genotipados.

# Pedigrí ----

famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'nSNPs_IND.fam')) %>% # Se importa el archivo .fam obtenido usando plink y que posteriomente se uso para crear la hoja de parámetros para ejecutar el software molcoanc.
  as_tibble() %>%
  select(fam) %>%
  mutate(id = 521:971)

ped_IND_298 <- read_delim(here('Datos', 'Datos_IND', 'Den_100.000', 'mG', 'mG_5', 'subpob_IND.txt'), delim = '\t', col_names = FALSE) %>% # Se importa el conjunto de datos donde esta la identificación de los 298 individuos genotipados.
  as_tibble() %>%
  select(X1) %>%
  rename(fam = X1) %>%
  right_join(x = famsnps_IND, by = 'fam') %>%
  mutate(Genotiped = TRUE) %>% # Se indica con TRUE que estos individuos estan genotipados.
  select(-fam)

ped_IND <- read_delim(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'Molcoanc_13', 'geneal_IND.csv'), delim = ' ') %>% # Se importa el pedigrí creado son el software molcoanc.
  na_if(0) %>% # Para usar la función para calcular la matriz A y su inversa, todos los padres y madres faltantes (en este caso 0), deben estar como NA.
  full_join(y = ped_IND_298, by = 'id') %>%
  mutate(Genotiped = replace_na(Genotiped, FALSE)) # Se especifican los individuos no genotipados (NA) como FALSE.

# Matriz G ----

mG_2_IND <- readRDS(here('Datos', 'Datos_IND', 'Den_1.000', 'mG', 'mG_2', 'mG_2.RDS')) # Se carga la matriz G de los 298 individuos genotipados de la población IND. 

# Cálculo de la matriz H ----

mH_2_IND <- fn.mH(ped = ped_IND, mG = mG_2_IND) %>%
  saveRDS(here('Datos', 'Datos_IND', 'Den_1.000', 'mH', 'Ped_2', 'mH_2', 'mH_2.RDS'))

mH_2_IND[1:10, 1:10]
mH_2_IND[510:520, 510:520]
mH_2_IND[521:531, 521:531]
diag(mH_2_IND)

## 3. Subpoblación con 451 individuos genotipados

dir.create('../Datos/Datos_IND/Den_1.000/mH/Ped_2/mH_3') # Se crea el directorio donde se guardara la matriz H para la subpoblación con 451 individuos genotipados.

# Pedigrí ----

famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'nSNPs_IND.fam')) %>% # Se importa el archivo .fam obtenido usando plink y que posteriomente se uso para crear la hoja de parámetros para ejecutar el software molcoanc.
  as_tibble() %>%
  select(fam) %>%
  mutate(id = 521:971)

ped_IND_451 <- read_delim(here('Datos', 'Datos_IND', 'Den_100.000', 'mG', 'mG_8', 'subpob_IND.txt'), delim = '\t', col_names = FALSE) %>% # Se importa el conjunto de datos donde esta la identificación de los 451 individuos genotipados.
  as_tibble() %>%
  select(X1) %>%
  rename(fam = X1) %>%
  right_join(x = famsnps_IND, by = 'fam') %>%
  mutate(Genotiped = TRUE) %>% # Se indica con TRUE que estos individuos estan genotipados.
  select(-fam)

ped_IND <- read_delim(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'Molcoanc_13', 'geneal_IND.csv'), delim = ' ') %>% # Se importa el pedigrí creado son el software molcoanc.
  na_if(0) %>% # Para usar la función para calcular la matriz A y su inversa, todos los padres y madres faltantes (en este caso 0), deben estar como NA.
  full_join(y = ped_IND_451, by = 'id') %>%
  mutate(Genotiped = replace_na(Genotiped, FALSE)) # Se especifican los individuos no genotipados (NA) como FALSE.

# Matriz G ----

mG_3_IND <- readRDS(here('Datos', 'Datos_IND', 'Den_1.000', 'mG', 'mG_3', 'mG_3.RDS')) # Se carga la matriz G de los 451 individuos genotipados de la población IND. 

# Cálculo de la matriz H ----

mH_3_IND <- fn.mH(ped = ped_IND, mG = mG_3_IND) %>%
  saveRDS(here('Datos', 'Datos_IND', 'Den_1.000', 'mH', 'Ped_2', 'mH_3', 'mH_3.RDS'))

mH_3_IND[1:10, 1:10]
mH_3_IND[510:520, 510:520]
mH_3_IND[521:531, 521:531]
diag(mH_3_IND)

########################################################
# Pedigrí 3: 1210 individuos simulados en 7 generaciones
########################################################

dir.create('../Datos/Datos_IND/Den_1.000/mH/Ped_3') # Se crea el directorio donde se guardara la matriz H para las subpoblaciones del pedigrí 3.

## 1. Subpoblación con 148 individuos genotipados

dir.create('../Datos/Datos_IND/Den_1.000/mH/Ped_3/mH_1') # Se crea el directorio donde se guardara la matriz H para la subpoblación con 148 individuos genotipados.

# Pedigrí ----

famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'nSNPs_IND.fam')) %>% # Se importa el archivo .fam obtenido usando plink y que posteriomente se uso para crear la hoja de parámetros para ejecutar el software molcoanc.
  as_tibble() %>%
  select(fam) %>%
  mutate(id = 1211:1661)

ped_IND_148 <- read_delim(here('Datos', 'Datos_IND', 'Den_100.000', 'mG', 'mG_2', 'subpob_IND.txt'), delim = '\t', col_names = FALSE) %>% # Se importa el conjunto de datos donde esta la identificación de los 148 individuos genotipados.
  as_tibble() %>%
  select(X1) %>%
  rename(fam = X1) %>%
  right_join(x = famsnps_IND, by = 'fam') %>%
  mutate(Genotiped = TRUE) %>% # Se indica con TRUE que estos individuos estan genotipados.
  select(-fam)

ped_IND <- read_delim(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'Molcoanc_14', 'geneal_IND.csv'), delim = ' ') %>% # Se importa el pedigrí creado son el software molcoanc.
  na_if(0) %>% # Para usar la función para calcular la matriz A y su inversa, todos los padres y madres faltantes (en este caso 0), deben estar como NA.
  full_join(y = ped_IND_148, by = 'id') %>%
  mutate(Genotiped = replace_na(Genotiped, FALSE)) # Se especifican los individuos no genotipados (NA) como FALSE.

# Matriz G ----

mG_1_IND <- readRDS(here('Datos', 'Datos_IND', 'Den_1.000', 'mG', 'mG_1', 'mG_1.RDS')) # Se carga la matriz G de los 148 individuos genotipados de la población IND. 

# Cálculo de la matriz H ----

mH_1_IND <- fn.mH(ped = ped_IND, mG = mG_1_IND) %>%
  saveRDS(here('Datos', 'Datos_IND', 'Den_1.000', 'mH', 'Ped_3', 'mH_1', 'mH_1.RDS'))

mH_1_IND[1:10, 1:10]
mH_1_IND[1200:1210, 1200:1210]
mH_1_IND[1211:1221, 1211:1221]
diag(mH_1_IND)

## 2. Subpoblación con 298 individuos genotipados

dir.create('../Datos/Datos_IND/Den_1.000/mH/Ped_3/mH_2') # Se crea el directorio donde se guardara la matriz H para la subpoblación con 298 individuos genotipados.

# Pedigrí ----

famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'nSNPs_IND.fam')) %>% # Se importa el archivo .fam obtenido usando plink y que posteriomente se uso para crear la hoja de parámetros para ejecutar el software molcoanc.
  as_tibble() %>%
  select(fam) %>%
  mutate(id = 1211:1661)

ped_IND_298 <- read_delim(here('Datos', 'Datos_IND', 'Den_100.000', 'mG', 'mG_5', 'subpob_IND.txt'), delim = '\t', col_names = FALSE) %>% # Se importa el conjunto de datos donde esta la identificación de los 298 individuos genotipados.
  as_tibble() %>%
  select(X1) %>%
  rename(fam = X1) %>%
  right_join(x = famsnps_IND, by = 'fam') %>%
  mutate(Genotiped = TRUE) %>% # Se indica con TRUE que estos individuos estan genotipados.
  select(-fam)

ped_IND <- read_delim(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'Molcoanc_14', 'geneal_IND.csv'), delim = ' ') %>% # Se importa el pedigrí creado son el software molcoanc.
  na_if(0) %>% # Para usar la función para calcular la matriz A y su inversa, todos los padres y madres faltantes (en este caso 0), deben estar como NA.
  full_join(y = ped_IND_298, by = 'id') %>%
  mutate(Genotiped = replace_na(Genotiped, FALSE)) # Se especifican los individuos no genotipados (NA) como FALSE.

# Matriz G ----

mG_2_IND <- readRDS(here('Datos', 'Datos_IND', 'Den_1.000', 'mG', 'mG_2', 'mG_2.RDS')) # Se carga la matriz G de los 298 individuos genotipados de la población IND. 

# Cálculo de la matriz H ----

mH_2_IND <- fn.mH(ped = ped_IND, mG = mG_2_IND) %>%
  saveRDS(here('Datos', 'Datos_IND', 'Den_1.000', 'mH', 'Ped_3', 'mH_2', 'mH_2.RDS'))

mH_2_IND[1:10, 1:10]
mH_2_IND[1200:1210, 1200:1210]
mH_2_IND[1211:1221, 1211:1221]
diag(mH_2_IND)

## 3. Subpoblación con 451 individuos genotipados

dir.create('../Datos/Datos_IND/Den_1.000/mH/Ped_3/mH_3') # Se crea el directorio donde se guardara la matriz H para la subpoblación con 451 individuos genotipados.

# Pedigrí ----

famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'nSNPs_IND.fam')) %>% # Se importa el archivo .fam obtenido usando plink y que posteriomente se uso para crear la hoja de parámetros para ejecutar el software molcoanc.
  as_tibble() %>%
  select(fam) %>%
  mutate(id = 1211:1661)

ped_IND_451 <- read_delim(here('Datos', 'Datos_IND', 'Den_100.000', 'mG', 'mG_8', 'subpob_IND.txt'), delim = '\t', col_names = FALSE) %>% # Se importa el conjunto de datos donde esta la identificación de los 451 individuos genotipados.
  as_tibble() %>%
  select(X1) %>%
  rename(fam = X1) %>%
  right_join(x = famsnps_IND, by = 'fam') %>%
  mutate(Genotiped = TRUE) %>% # Se indica con TRUE que estos individuos estan genotipados.
  select(-fam)

ped_IND <- read_delim(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'Molcoanc_14', 'geneal_IND.csv'), delim = ' ') %>% # Se importa el pedigrí creado son el software molcoanc.
  na_if(0) %>% # Para usar la función para calcular la matriz A y su inversa, todos los padres y madres faltantes (en este caso 0), deben estar como NA.
  full_join(y = ped_IND_451, by = 'id') %>%
  mutate(Genotiped = replace_na(Genotiped, FALSE)) # Se especifican los individuos no genotipados (NA) como FALSE.

# Matriz G ----

mG_3_IND <- readRDS(here('Datos', 'Datos_IND', 'Den_1.000', 'mG', 'mG_3', 'mG_3.RDS')) # Se carga la matriz G de los 451 individuos genotipados de la población IND. 

# Cálculo de la matriz H ----

mH_3_IND <- fn.mH(ped = ped_IND, mG = mG_3_IND) %>%
  saveRDS(here('Datos', 'Datos_IND', 'Den_1.000', 'mH', 'Ped_3', 'mH_3', 'mH_3.RDS'))

mH_3_IND[1:10, 1:10]
mH_3_IND[1200:1210, 1200:1210]
mH_3_IND[1211:1221, 1211:1221]
diag(mH_3_IND)

#######################################################
# Pedigrí 4: 300 individuos simulados en 3 generaciones
#######################################################

dir.create('../Datos/Datos_IND/Den_1.000/mH/Ped_4') # Se crea el directorio donde se guardara la matriz H para las subpoblaciones del pedigrí 4.

## 1. Subpoblación con 148 individuos genotipados

dir.create('../Datos/Datos_IND/Den_1.000/mH/Ped_4/mH_1') # Se crea el directorio donde se guardara la matriz H para la subpoblación con 148 individuos genotipados.

# Pedigrí ----

famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'nSNPs_IND.fam')) %>% # Se importa el archivo .fam obtenido usando plink y que posteriomente se uso para crear la hoja de parámetros para ejecutar el software molcoanc.
  as_tibble() %>%
  select(fam) %>%
  mutate(id = 301:751)

ped_IND_148 <- read_delim(here('Datos', 'Datos_IND', 'Den_100.000', 'mG', 'mG_2', 'subpob_IND.txt'), delim = '\t', col_names = FALSE) %>% # Se importa el conjunto de datos donde esta la identificación de los 148 individuos genotipados.
  as_tibble() %>%
  select(X1) %>%
  rename(fam = X1) %>%
  right_join(x = famsnps_IND, by = 'fam') %>%
  mutate(Genotiped = TRUE) %>% # Se indica con TRUE que estos individuos estan genotipados.
  select(-fam)

ped_IND <- read_delim(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'Molcoanc_15', 'geneal_IND.csv'), delim = ' ') %>% # Se importa el pedigrí creado son el software molcoanc.
  na_if(0) %>% # Para usar la función para calcular la matriz A y su inversa, todos los padres y madres faltantes (en este caso 0), deben estar como NA.
  full_join(y = ped_IND_148, by = 'id') %>%
  mutate(Genotiped = replace_na(Genotiped, FALSE)) # Se especifican los individuos no genotipados (NA) como FALSE.

# Matriz G ----

mG_1_IND <- readRDS(here('Datos', 'Datos_IND', 'Den_1.000', 'mG', 'mG_1', 'mG_1.RDS')) # Se carga la matriz G de los 148 individuos genotipados de la población IND. 

# Cálculo de la matriz H ----

mH_1_IND <- fn.mH(ped = ped_IND, mG = mG_1_IND) %>%
  saveRDS(here('Datos', 'Datos_IND', 'Den_1.000', 'mH', 'Ped_4', 'mH_1', 'mH_1.RDS'))

mH_1_IND[1:10, 1:10]
mH_1_IND[300:310, 300:310]
mH_1_IND[301:311, 301:311]
diag(mH_1_IND)

## 2. Subpoblación con 298 individuos genotipados

dir.create('../Datos/Datos_IND/Den_1.000/mH/Ped_4/mH_2') # Se crea el directorio donde se guardara la matriz H para la subpoblación con 298 individuos genotipados.

# Pedigrí ----

famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'nSNPs_IND.fam')) %>% # Se importa el archivo .fam obtenido usando plink y que posteriomente se uso para crear la hoja de parámetros para ejecutar el software molcoanc.
  as_tibble() %>%
  select(fam) %>%
  mutate(id = 301:751)

ped_IND_298 <- read_delim(here('Datos', 'Datos_IND', 'Den_100.000', 'mG', 'mG_5', 'subpob_IND.txt'), delim = '\t', col_names = FALSE) %>% # Se importa el conjunto de datos donde esta la identificación de los 298 individuos genotipados.
  as_tibble() %>%
  select(X1) %>%
  rename(fam = X1) %>%
  right_join(x = famsnps_IND, by = 'fam') %>%
  mutate(Genotiped = TRUE) %>% # Se indica con TRUE que estos individuos estan genotipados.
  select(-fam)

ped_IND <- read_delim(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'Molcoanc_15', 'geneal_IND.csv'), delim = ' ') %>% # Se importa el pedigrí creado son el software molcoanc.
  na_if(0) %>% # Para usar la función para calcular la matriz A y su inversa, todos los padres y madres faltantes (en este caso 0), deben estar como NA.
  full_join(y = ped_IND_298, by = 'id') %>%
  mutate(Genotiped = replace_na(Genotiped, FALSE)) # Se especifican los individuos no genotipados (NA) como FALSE.

# Matriz G ----

mG_2_IND <- readRDS(here('Datos', 'Datos_IND', 'Den_1.000', 'mG', 'mG_2', 'mG_2.RDS')) # Se carga la matriz G de los 298 individuos genotipados de la población IND. 

# Cálculo de la matriz H ----

mH_2_IND <- fn.mH(ped = ped_IND, mG = mG_2_IND) %>%
  saveRDS(here('Datos', 'Datos_IND', 'Den_1.000', 'mH', 'Ped_4', 'mH_2', 'mH_2.RDS'))

mH_2_IND[1:10, 1:10]
mH_2_IND[300:310, 300:310]
mH_2_IND[301:311, 301:311]
diag(mH_2_IND)

## 3. Subpoblación con 451 individuos genotipados

dir.create('../Datos/Datos_IND/Den_1.000/mH/Ped_4/mH_3') # Se crea el directorio donde se guardara la matriz H para la subpoblación con 451 individuos genotipados.

# Pedigrí ----

famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'nSNPs_IND.fam')) %>% # Se importa el archivo .fam obtenido usando plink y que posteriomente se uso para crear la hoja de parámetros para ejecutar el software molcoanc.
  as_tibble() %>%
  select(fam) %>%
  mutate(id = 301:751)

ped_IND_451 <- read_delim(here('Datos', 'Datos_IND', 'Den_100.000', 'mG', 'mG_8', 'subpob_IND.txt'), delim = '\t', col_names = FALSE) %>% # Se importa el conjunto de datos donde esta la identificación de los 451 individuos genotipados.
  as_tibble() %>%
  select(X1) %>%
  rename(fam = X1) %>%
  right_join(x = famsnps_IND, by = 'fam') %>%
  mutate(Genotiped = TRUE) %>% # Se indica con TRUE que estos individuos estan genotipados.
  select(-fam)

ped_IND <- read_delim(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'Molcoanc_15', 'geneal_IND.csv'), delim = ' ') %>% # Se importa el pedigrí creado son el software molcoanc.
  na_if(0) %>% # Para usar la función para calcular la matriz A y su inversa, todos los padres y madres faltantes (en este caso 0), deben estar como NA.
  full_join(y = ped_IND_451, by = 'id') %>%
  mutate(Genotiped = replace_na(Genotiped, FALSE)) # Se especifican los individuos no genotipados (NA) como FALSE.

# Matriz G ----

mG_3_IND <- readRDS(here('Datos', 'Datos_IND', 'Den_1.000', 'mG', 'mG_3', 'mG_3.RDS')) # Se carga la matriz G de los 451 individuos genotipados de la población IND. 

# Cálculo de la matriz H ----

mH_3_IND <- fn.mH(ped = ped_IND, mG = mG_3_IND) %>%
  saveRDS(here('Datos', 'Datos_IND', 'Den_1.000', 'mH', 'Ped_4', 'mH_3', 'mH_3.RDS'))

mH_3_IND[1:10, 1:10]
mH_3_IND[300:310, 300:310]
mH_3_IND[301:311, 301:311]
diag(mH_2_IND)

########################################################
# Pedigrí 5: 1530 individuos simulados en 9 generaciones
########################################################

dir.create('../Datos/Datos_IND/Den_1.000/mH/Ped_5') # Se crea el directorio donde se guardara la matriz H para las subpoblaciones del pedigrí 5.

## 1. Subpoblación con 148 individuos genotipados

dir.create('../Datos/Datos_IND/Den_1.000/mH/Ped_5/mH_1') # Se crea el directorio donde se guardara la matriz H para la subpoblación con 148 individuos genotipados.

# Pedigrí ----

famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'nSNPs_IND.fam')) %>% # Se importa el archivo .fam obtenido usando plink y que posteriomente se uso para crear la hoja de parámetros para ejecutar el software molcoanc.
  as_tibble() %>%
  select(fam) %>%
  mutate(id = 1531:1981)

ped_IND_148 <- read_delim(here('Datos', 'Datos_IND', 'Den_100.000', 'mG', 'mG_2', 'subpob_IND.txt'), delim = '\t', col_names = FALSE) %>% # Se importa el conjunto de datos donde esta la identificación de los 148 individuos genotipados.
  select(X1) %>%
  rename(fam = X1) %>%
  right_join(x = famsnps_IND, by = 'fam') %>%
  mutate(Genotiped = TRUE) %>% # Se indica con TRUE que estos individuos estan genotipados.
  select(-fam)

ped_IND <- read_delim(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'Molcoanc_16', 'geneal_IND.csv'), delim = ' ') %>% # Se importa el pedigrí creado son el software molcoanc.
  na_if(0) %>% # Para usar la función para calcular la matriz A y su inversa, todos los padres y madres faltantes (en este caso 0), deben estar como NA.
  full_join(y = ped_IND_148, by = 'id') %>%
  mutate(Genotiped = replace_na(Genotiped, FALSE)) # Se especifican los individuos no genotipados (NA) como FALSE.

# Matriz G ----

mG_1_IND <- readRDS(here('Datos', 'Datos_IND', 'Den_1.000', 'mG', 'mG_1', 'mG_1.RDS')) # Se carga la matriz G de los 148 individuos genotipados de la población IND. 

# Cálculo de la matriz H ----

mH_1_IND <- fn.mH(ped = ped_IND, mG = mG_1_IND) %>%
  saveRDS(here('Datos', 'Datos_IND', 'Den_1.000', 'mH', 'Ped_5', 'mH_1', 'mH_1.RDS'))

mH_1_IND[1:10, 1:10]
mH_1_IND[1520:1530, 1520:1530]
mH_1_IND[1531:1541, 1531:1541]
diag(mH_1_IND)

## 2. Subpoblación con 298 individuos genotipados

dir.create('../Datos/Datos_IND/Den_1.000/mH/Ped_5/mH_2') # Se crea el directorio donde se guardara la matriz H para la subpoblación con 298 individuos genotipados.

# Pedigrí ----

famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'nSNPs_IND.fam')) %>% # Se importa el archivo .fam obtenido usando plink y que posteriomente se uso para crear la hoja de parámetros para ejecutar el software molcoanc.
  as_tibble() %>%
  select(fam) %>%
  mutate(id = 1531:1981)

ped_IND_298 <- read_delim(here('Datos', 'Datos_IND', 'Den_100.000', 'mG', 'mG_5', 'subpob_IND.txt'), delim = '\t', col_names = FALSE) %>% # Se importa el conjunto de datos donde esta la identificación de los 298 individuos genotipados.
  select(X1) %>%
  rename(fam = X1) %>%
  right_join(x = famsnps_IND, by = 'fam') %>%
  mutate(Genotiped = TRUE) %>% # Se indica con TRUE que estos individuos estan genotipados.
  select(-fam)

ped_IND <- read_delim(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'Molcoanc_16', 'geneal_IND.csv'), delim = ' ') %>% # Se importa el pedigrí creado son el software molcoanc.
  na_if(0) %>% # Para usar la función para calcular la matriz A y su inversa, todos los padres y madres faltantes (en este caso 0), deben estar como NA.
  full_join(y = ped_IND_298, by = 'id') %>%
  mutate(Genotiped = replace_na(Genotiped, FALSE)) # Se especifican los individuos no genotipados (NA) como FALSE.

# Matriz G ----

mG_2_IND <- readRDS(here('Datos', 'Datos_IND', 'Den_1.000', 'mG', 'mG_2', 'mG_2.RDS')) # Se carga la matriz G de los 298 individuos genotipados de la población IND. 

# Cálculo de la matriz H ----

mH_2_IND <- fn.mH(ped = ped_IND, mG = mG_2_IND) %>%
  saveRDS(here('Datos', 'Datos_IND', 'Den_1.000', 'mH', 'Ped_5', 'mH_2', 'mH_2.RDS'))

mH_2_IND[1:10, 1:10]
mH_2_IND[1520:1530, 1520:1530]
mH_2_IND[1531:1541, 1531:1541]
diag(mH_2_IND)

## 3. Subpoblación con 451 individuos genotipados

dir.create('../Datos/Datos_IND/Den_1.000/mH/Ped_5/mH_3') # Se crea el directorio donde se guardara la matriz H para la subpoblación con 451 individuos genotipados.

# Pedigrí ----

famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'nSNPs_IND.fam')) %>% # Se importa el archivo .fam obtenido usando plink y que posteriomente se uso para crear la hoja de parámetros para ejecutar el software molcoanc.
  as_tibble() %>%
  select(fam) %>%
  mutate(id = 1531:1981)

ped_IND_451 <- read_delim(here('Datos', 'Datos_IND', 'Den_100.000', 'mG', 'mG_8', 'subpob_IND.txt'), delim = '\t', col_names = FALSE) %>% # Se importa el conjunto de datos donde esta la identificación de los 451 individuos genotipados.
  select(X1) %>%
  rename(fam = X1) %>%
  right_join(x = famsnps_IND, by = 'fam') %>%
  mutate(Genotiped = TRUE) %>% # Se indica con TRUE que estos individuos estan genotipados.
  select(-fam)

ped_IND <- read_delim(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'Molcoanc_16', 'geneal_IND.csv'), delim = ' ') %>% # Se importa el pedigrí creado son el software molcoanc.
  na_if(0) %>% # Para usar la función para calcular la matriz A y su inversa, todos los padres y madres faltantes (en este caso 0), deben estar como NA.
  full_join(y = ped_IND_451, by = 'id') %>%
  mutate(Genotiped = replace_na(Genotiped, FALSE)) # Se especifican los individuos no genotipados (NA) como FALSE.

# Matriz G ----

mG_3_IND <- readRDS(here('Datos', 'Datos_IND', 'Den_1.000', 'mG', 'mG_3', 'mG_3.RDS')) # Se carga la matriz G de los 451 individuos genotipados de la población IND. 

# Cálculo de la matriz H ----

mH_3_IND <- fn.mH(ped = ped_IND, mG = mG_3_IND) %>%
  saveRDS(here('Datos', 'Datos_IND', 'Den_1.000', 'mH', 'Ped_5', 'mH_3', 'mH_3.RDS'))

mH_3_IND[1:10, 1:10]
mH_3_IND[1520:1530, 1520:1530]
mH_3_IND[1531:1541, 1531:1541]
diag(mH_3_IND)
```

# 19. A continuación se realiza la predicción usando el BGLR para distintos pedigríes y diferentes densidades de SNPs.

```{r Ajuste de modelos con BGLR para distintos pedigríes y diferentes densidades de SNPs}

#### Población de arroz IND (10.000 SNPs) ----

dir.create('../Datos/Datos_IND/Den_10.000/mod_BGLR') # Se crea una carpeta donde se guardaran los resultados de los modelos que se ajustaran para las distintas subpoblaciones de individuos genotipados con distintos pedigríes, con una desnidad de SNPs de 10.000.

# 1. Se importan las bases de datos de fenotipos y de linea mejorada.

lin_mej <- read_delim(here('Datos', 'iris_pedigree.csv'), delim = ',')
Fenotipos <- read_delim(here('Datos', 'all.phenotypes.csv'), delim = ',')

#### Población de arroz IND ----

# 2. Se crea un conjunto de datos que contiene solo los individuos mejorados.

Pob_mej <- lin_mej %>%
  filter(Status_with_Pedigree.plus.knowledge == 'I') %>% # Conjunto de datos solo con los individuos mejorados (los que se clasificaron como "I").
  select(X3K_DNA_IRIS_UNIQUE_ID) %>%
  rename(Variety = X3K_DNA_IRIS_UNIQUE_ID)

escalado <- function(x) { # Función usada para escalar el fenotipo.
  (x - mean(x, na.rm = TRUE)) / sd(x, na.rm = TRUE)
  }

Pob_IND <- Fenotipos %>%
  filter(SNPsubsp == 'IND') %>% # Conjunto de datos solo con la especie IND.
  mutate(
    Variety_2 = Variety,
    Fen_escalado = escalado(Time.to.flowering..from.sowing)
    ) %>%
  separate(
    col = Variety,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  ' '
  ) %>%
  unite(
    col = Variety,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  separate(
    col = Variety,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  '-'
  ) %>%
  unite(
    col = Variety,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  separate(
    col = Variety_2,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  ' '
  ) %>%
  unite(
    col = Variety_2,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  inner_join(y = Pob_mej, by = 'Variety') %>%
  select(Variety_2, Fen_escalado) %>% # Se creo el conjunto de datos con los individuos mejorados de la población indica.
  mutate(Fen_escalado = NA) %>% # Los fenotipos de estos individuos se deben colocar como NAs al formar parte de la población de validación cruzada, y al ser los individuos que se quieren predecir.
  rename(Variety = Variety_2)

# 3. Se crea un conjunto de datos que no contiene los individuos mejorados.

Pob_IND_2 <- Fenotipos %>%
  filter(SNPsubsp == 'IND') %>% # Conjunto de datos solo con la especie IND.
  mutate(
    Variety_2 = Variety,
    Fen_escalado = escalado(Time.to.flowering..from.sowing)
    ) %>%
  separate(
    col = Variety,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  ' '
  ) %>%
  unite(
    col = Variety,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  separate(
    col = Variety,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  '-'
  ) %>%
  unite(
    col = Variety,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  separate(
    col = Variety_2,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  ' '
  ) %>%
  unite(
    col = Variety_2,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  anti_join(Pob_mej, by = 'Variety') %>%
  select(Variety_2, Fen_escalado) %>% # Se creo el conjunto de datos con los individuos no mejorados de la población indica.
  rename(Variety = Variety_2)

#########################################################
# Pedigrí 1: 2000 individuos simulados en 10 generaciones
#########################################################

# 4. Se importa el archivo .fam obtenido usando plink y que posteriomente se uso para crear la hoja de parámetros para ejecutar el software molcoanc.

famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'nSNPs_IND.fam')) %>% 
  select(fam) %>%
  mutate(id = 2001:2451) %>%
  rename(Variety = fam)

# 5. Se unen en un solo conjuntos de datos los individuos mejorados y no mejorados.

Pob_IND_3 <- Pob_IND_2 %>%
  left_join(y = famsnps_IND, by = 'Variety') # Se unen al conjunto de datos anterior (famsnps_IND) debido a que aquí esta la identificación numérica como esta en el pedigrí.

Pob_IND_4 <- Pob_IND %>%
  left_join(y = famsnps_IND, by = 'Variety') %>% # Se unen al conjunto de datos famsnps_IND debido a que aquí esta la identificación numérica como esta en el pedigrí.
  bind_rows(Pob_IND_3) %>% # Se une por filas al conjunto de datos de individuos no mejorados anterior Pob_IND_3.
  select(-Variety) %>%
  relocate(
    Fen_escalado,
    .after = id
    )

# 6. Se crea un conjunto de datos donde estaran los fenotipos de los individuos con pedigrí simulado mediante el software molcoanc, y se une posteriormente con el conjunto de datos anterior.

Pob_IND_5 <- tibble(
  id = seq(from = 1, to = 2000, by = 1),
  Fen_escalado = rep(x = NA, times = 2000)
  ) %>%
  bind_rows(Pob_IND_4) %>%
  arrange(id)

########################################
# Uso del paquete BGLR para el pedigrí 1
########################################

dir.create('../Datos/Datos_IND/Den_10.000/mod_BGLR/Ped_1') # Se crea una carpeta donde se guardaran los resultados del pedigríe 1.

## 1. Subpoblación con 148 individuos genotipados

# a) Se preparan los datos de entrada ----

mH_IND_1 <- readRDS(here('Datos', 'Datos_IND', 'Den_10.000', 'mH', 'Ped_1', 'mH_1', 'mH_1.RDS')) # Se carga la matriz H de los 148 individuos genotipados de la población IND.

Fen_IND <- Pob_IND_5 %>%
  pull(Fen_escalado) # Se extrae del conjunto de datos de fenotipos el fenotipo de interes en forma de vector.

# b) Se configura el predictor lineal ----

ETA = list(list(K = mH_IND_1, model = 'RKHS'))

# c) Se ajusta el modelo ----

dir.create('../Datos/Datos_IND/Den_10.000/mod_BGLR/Ped_1/mod_BGLR_1/') # Se crea una carpeta para guardar los resultados del modelo anteriormente ajustado para 148 indiviuos genotipados.

mod_IND_1 <- BGLR(y = Fen_IND, ETA = ETA, nIter = 50000, burnIn = 10000, saveAt = '../Repo_TFM/Datos/Datos_IND/Den_10.000/mod_BGLR/Ped_1/mod_BGLR_1/ssgblup_')

save(mod_IND_1, file = '../Repo_TFM/Datos/Datos_IND/Den_10.000/mod_BGLR/Ped_1/mod_BGLR_1/mod_BGLR_1.RData')

## 2. Subpoblación con 298 individuos genotipados

# a) Se preparan los datos de entrada ----

mH_IND_2 <- readRDS(here('Datos', 'Datos_IND', 'Den_10.000', 'mH', 'Ped_1', 'mH_2', 'mH_2.RDS')) # Se carga la matriz H de los 298 individuos genotipados de la población IND.

Fen_IND <- Pob_IND_5 %>%
  pull(Fen_escalado) # Se extrae del conjunto de datos de fenotipos el fenotipo de interes en forma de vector.

# b) Se configura el predictor lineal ----

ETA = list(list(K = mH_IND_2, model = 'RKHS'))

# c) Se ajusta el modelo ----

dir.create('../Datos/Datos_IND/Den_10.000/mod_BGLR/Ped_1/mod_BGLR_2/') # Se crea una carpeta para guardar los resultados del modelo anteriormente ajustado para 298 indiviuos genotipados.

mod_IND_2 <- BGLR(y = Fen_IND, ETA = ETA, nIter = 50000, burnIn = 10000, saveAt = '../Repo_TFM/Datos/Datos_IND/Den_10.000/mod_BGLR/Ped_1/mod_BGLR_2/ssgblup_')

save(mod_IND_2, file = '../Repo_TFM/Datos/Datos_IND/Den_10.000/mod_BGLR/Ped_1/mod_BGLR_2/mod_BGLR_2.RData')

## 3. Subpoblación con 451 individuos genotipados

# a) Se preparan los datos de entrada ----

mH_IND_3 <- readRDS(here('Datos', 'Datos_IND', 'Den_10.000', 'mH', 'Ped_1', 'mH_3', 'mH_3.RDS')) # Se carga la matriz H de los 451 individuos genotipados de la población IND.

Fen_IND <- Pob_IND_5 %>%
  pull(Fen_escalado) # Se extrae del conjunto de datos de fenotipos el fenotipo de interes en forma de vector.

# b) Se configura el predictor lineal ----

ETA = list(list(K = mH_IND_3, model = 'RKHS'))

# c) Se ajusta el modelo ----

dir.create('../Datos/Datos_IND/Den_10.000/mod_BGLR/Ped_1/mod_BGLR_3/') # Se crea una carpeta para guardar los resultados del modelo anteriormente ajustado para 298 indiviuos genotipados.

mod_IND_3 <- BGLR(y = Fen_IND, ETA = ETA, nIter = 50000, burnIn = 10000, saveAt = '../Repo_TFM/Datos/Datos_IND/Den_10.000/mod_BGLR/Ped_1/mod_BGLR_3/ssgblup_')

save(mod_IND_3, file = '../Repo_TFM/Datos/Datos_IND/Den_10.000/mod_BGLR/Ped_1/mod_BGLR_3/mod_BGLR_3.RData')

#######################################################
# Pedigrí 2: 520 individuos simulados en 4 generaciones
#######################################################

# 4. Se importa el archivo .fam obtenido usando plink y que posteriomente se uso para crear la hoja de parámetros para ejecutar el software molcoanc.

famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'nSNPs_IND.fam')) %>% 
  select(fam) %>%
  mutate(id = 521:971) %>%
  rename(Variety = fam)

# 5. Se unen en un solo conjuntos de datos los individuos mejorados y no mejorados.

Pob_IND_3 <- Pob_IND_2 %>%
  left_join(y = famsnps_IND, by = 'Variety') # Se unen al conjunto de datos anterior (famsnps_IND) debido a que aquí esta la identificación numérica como esta en el pedigrí.

Pob_IND_4 <- Pob_IND %>%
  left_join(y = famsnps_IND, by = 'Variety') %>% # Se unen al conjunto de datos famsnps_IND debido a que aquí esta la identificación numérica como esta en el pedigrí.
  bind_rows(Pob_IND_3) %>% # Se une por filas al conjunto de datos de individuos no mejorados anterior Pob_IND_3.
  select(-Variety) %>%
  relocate(
    Fen_escalado,
    .after = id
    )

# 6. Se crea un conjunto de datos donde estaran los fenotipos de los individuos con pedigrí simulado mediante el software molcoanc, y se une posteriormente con el conjunto de datos anterior.

Pob_IND_5 <- tibble(
  id = seq(from = 1, to = 520, by = 1),
  Fen_escalado = rep(x = NA, times = 520)
  ) %>%
  bind_rows(Pob_IND_4) %>%
  arrange(id)

########################################
# Uso del paquete BGLR para el pedigrí 2
########################################

dir.create('../Datos/Datos_IND/Den_10.000/mod_BGLR/Ped_2') # Se crea una carpeta donde se guardaran los resultados del pedigríe 2.

## 1. Subpoblación con 148 individuos genotipados

# a) Se preparan los datos de entrada ----

mH_IND_1 <- readRDS(here('Datos', 'Datos_IND', 'Den_10.000', 'mH', 'Ped_2', 'mH_1', 'mH_1.RDS')) # Se carga la matriz H de los 148 individuos genotipados de la población IND.

Fen_IND <- Pob_IND_5 %>%
  pull(Fen_escalado) # Se extrae del conjunto de datos de fenotipos el fenotipo de interes en forma de vector.

# b) Se configura el predictor lineal ----

ETA = list(list(K = mH_IND_1, model = 'RKHS'))

# c) Se ajusta el modelo ----

dir.create('../Datos/Datos_IND/Den_10.000/mod_BGLR/Ped_2/mod_BGLR_1/') # Se crea una carpeta para guardar los resultados del modelo anteriormente ajustado para 148 indiviuos genotipados.

mod_IND_1 <- BGLR(y = Fen_IND, ETA = ETA, nIter = 50000, burnIn = 10000, saveAt = '../Repo_TFM/Datos/Datos_IND/Den_10.000/mod_BGLR/Ped_2/mod_BGLR_1/ssgblup_')

save(mod_IND_1, file = '../Repo_TFM/Datos/Datos_IND/Den_10.000/mod_BGLR/Ped_2/mod_BGLR_1/mod_BGLR_1.RData')

## 2. Subpoblación con 298 individuos genotipados

# a) Se preparan los datos de entrada ----

mH_IND_2 <- readRDS(here('Datos', 'Datos_IND', 'Den_10.000', 'mH', 'Ped_2', 'mH_2', 'mH_2.RDS')) # Se carga la matriz H de los 298 individuos genotipados de la población IND.

Fen_IND <- Pob_IND_5 %>%
  pull(Fen_escalado) # Se extrae del conjunto de datos de fenotipos el fenotipo de interes en forma de vector.

# b) Se configura el predictor lineal ----

ETA = list(list(K = mH_IND_2, model = 'RKHS'))

# c) Se ajusta el modelo ----

dir.create('../Datos/Datos_IND/Den_10.000/mod_BGLR/Ped_2/mod_BGLR_2/') # Se crea una carpeta para guardar los resultados del modelo anteriormente ajustado para 298 indiviuos genotipados.

mod_IND_2 <- BGLR(y = Fen_IND, ETA = ETA, nIter = 50000, burnIn = 10000, saveAt = '../Repo_TFM/Datos/Datos_IND/Den_10.000/mod_BGLR/Ped_2/mod_BGLR_2/ssgblup_')

save(mod_IND_2, file = '../Repo_TFM/Datos/Datos_IND/Den_10.000/mod_BGLR/Ped_2/mod_BGLR_2/mod_BGLR_2.RData')

## 3. Subpoblación con 451 individuos genotipados

# a) Se preparan los datos de entrada ----

mH_IND_3 <- readRDS(here('Datos', 'Datos_IND', 'Den_10.000', 'mH', 'Ped_2', 'mH_3', 'mH_3.RDS')) # Se carga la matriz H de los 451 individuos genotipados de la población IND.

Fen_IND <- Pob_IND_5 %>%
  pull(Fen_escalado) # Se extrae del conjunto de datos de fenotipos el fenotipo de interes en forma de vector.

# b) Se configura el predictor lineal ----

ETA = list(list(K = mH_IND_3, model = 'RKHS'))

# c) Se ajusta el modelo ----

dir.create('../Datos/Datos_IND/Den_10.000/mod_BGLR/Ped_2/mod_BGLR_3/') # Se crea una carpeta para guardar los resultados del modelo anteriormente ajustado para 298 indiviuos genotipados.

mod_IND_3 <- BGLR(y = Fen_IND, ETA = ETA, nIter = 50000, burnIn = 10000, saveAt = '../Repo_TFM/Datos/Datos_IND/Den_10.000/mod_BGLR/Ped_2/mod_BGLR_3/ssgblup_')

save(mod_IND_3, file = '../Repo_TFM/Datos/Datos_IND/Den_10.000/mod_BGLR/Ped_2/mod_BGLR_3/mod_BGLR_3.RData')

########################################################
# Pedigrí 3: 1210 individuos simulados en 7 generaciones
########################################################

# 4. Se importa el archivo .fam obtenido usando plink y que posteriomente se uso para crear la hoja de parámetros para ejecutar el software molcoanc.

famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'nSNPs_IND.fam')) %>% 
  select(fam) %>%
  mutate(id = 1211:1661) %>%
  rename(Variety = fam)

# 5. Se unen en un solo conjuntos de datos los individuos mejorados y no mejorados.

Pob_IND_3 <- Pob_IND_2 %>%
  left_join(y = famsnps_IND, by = 'Variety') # Se unen al conjunto de datos anterior (famsnps_IND) debido a que aquí esta la identificación numérica como esta en el pedigrí.

Pob_IND_4 <- Pob_IND %>%
  left_join(y = famsnps_IND, by = 'Variety') %>% # Se unen al conjunto de datos famsnps_IND debido a que aquí esta la identificación numérica como esta en el pedigrí.
  bind_rows(Pob_IND_3) %>% # Se une por filas al conjunto de datos de individuos no mejorados anterior Pob_IND_3.
  select(-Variety) %>%
  relocate(
    Fen_escalado,
    .after = id
    )

# 6. Se crea un conjunto de datos donde estaran los fenotipos de los individuos con pedigrí simulado mediante el software molcoanc, y se une posteriormente con el conjunto de datos anterior.

Pob_IND_5 <- tibble(
  id = seq(from = 1, to = 1210, by = 1),
  Fen_escalado = rep(x = NA, times = 1210)
  ) %>%
  bind_rows(Pob_IND_4) %>%
  arrange(id)

########################################
# Uso del paquete BGLR para el pedigrí 3
########################################

dir.create('../Datos/Datos_IND/Den_10.000/mod_BGLR/Ped_3') # Se crea una carpeta donde se guardaran los resultados del pedigríe 3.

## 1. Subpoblación con 148 individuos genotipados

# a) Se preparan los datos de entrada ----

mH_IND_1 <- readRDS(here('Datos', 'Datos_IND', 'Den_10.000', 'mH', 'Ped_3', 'mH_1', 'mH_1.RDS')) # Se carga la matriz H de los 148 individuos genotipados de la población IND.

Fen_IND <- Pob_IND_5 %>%
  pull(Fen_escalado) # Se extrae del conjunto de datos de fenotipos el fenotipo de interes en forma de vector.

# b) Se configura el predictor lineal ----

ETA = list(list(K = mH_IND_1, model = 'RKHS'))

# c) Se ajusta el modelo ----

dir.create('../Datos/Datos_IND/Den_10.000/mod_BGLR/Ped_3/mod_BGLR_1/') # Se crea una carpeta para guardar los resultados del modelo anteriormente ajustado para 148 indiviuos genotipados.

mod_IND_1 <- BGLR(y = Fen_IND, ETA = ETA, nIter = 50000, burnIn = 10000, saveAt = '../Repo_TFM/Datos/Datos_IND/Den_10.000/mod_BGLR/Ped_3/mod_BGLR_1/ssgblup_')

save(mod_IND_1, file = '../Repo_TFM/Datos/Datos_IND/Den_10.000/mod_BGLR/Ped_3/mod_BGLR_1/mod_BGLR_1.RData')

## 2. Subpoblación con 298 individuos genotipados

# a) Se preparan los datos de entrada ----

mH_IND_2 <- readRDS(here('Datos', 'Datos_IND', 'Den_10.000', 'mH', 'Ped_3', 'mH_2', 'mH_2.RDS')) # Se carga la matriz H de los 298 individuos genotipados de la población IND.

Fen_IND <- Pob_IND_5 %>%
  pull(Fen_escalado) # Se extrae del conjunto de datos de fenotipos el fenotipo de interes en forma de vector.

# b) Se configura el predictor lineal ----

ETA = list(list(K = mH_IND_2, model = 'RKHS'))

# c) Se ajusta el modelo ----

dir.create('../Datos/Datos_IND/Den_10.000/mod_BGLR/Ped_3/mod_BGLR_2/') # Se crea una carpeta para guardar los resultados del modelo anteriormente ajustado para 298 indiviuos genotipados.

mod_IND_2 <- BGLR(y = Fen_IND, ETA = ETA, nIter = 50000, burnIn = 10000, saveAt = '../Repo_TFM/Datos/Datos_IND/Den_10.000/mod_BGLR/Ped_3/mod_BGLR_2/ssgblup_')

save(mod_IND_2, file = '../Repo_TFM/Datos/Datos_IND/Den_10.000/mod_BGLR/Ped_3/mod_BGLR_2/mod_BGLR_2.RData')

## 3. Subpoblación con 451 individuos genotipados

# a) Se preparan los datos de entrada ----

mH_IND_3 <- readRDS(here('Datos', 'Datos_IND', 'Den_10.000', 'mH', 'Ped_3', 'mH_3', 'mH_3.RDS')) # Se carga la matriz H de los 451 individuos genotipados de la población IND.

Fen_IND <- Pob_IND_5 %>%
  pull(Fen_escalado) # Se extrae del conjunto de datos de fenotipos el fenotipo de interes en forma de vector.

# b) Se configura el predictor lineal ----

ETA = list(list(K = mH_IND_3, model = 'RKHS'))

# c) Se ajusta el modelo ----

dir.create('../Datos/Datos_IND/Den_10.000/mod_BGLR/Ped_3/mod_BGLR_3/') # Se crea una carpeta para guardar los resultados del modelo anteriormente ajustado para 298 indiviuos genotipados.

mod_IND_3 <- BGLR(y = Fen_IND, ETA = ETA, nIter = 50000, burnIn = 10000, saveAt = '../Repo_TFM/Datos/Datos_IND/Den_10.000/mod_BGLR/Ped_3/mod_BGLR_3/ssgblup_')

save(mod_IND_3, file = '../Repo_TFM/Datos/Datos_IND/Den_10.000/mod_BGLR/Ped_3/mod_BGLR_3/mod_BGLR_3.RData')

#######################################################
# Pedigrí 4: 300 individuos simulados en 3 generaciones
#######################################################

# 4. Se importa el archivo .fam obtenido usando plink y que posteriomente se uso para crear la hoja de parámetros para ejecutar el software molcoanc.

famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'nSNPs_IND.fam')) %>% 
  select(fam) %>%
  mutate(id = 301:751) %>%
  rename(Variety = fam)

# 5. Se unen en un solo conjuntos de datos los individuos mejorados y no mejorados.

Pob_IND_3 <- Pob_IND_2 %>%
  left_join(y = famsnps_IND, by = 'Variety') # Se unen al conjunto de datos anterior (famsnps_IND) debido a que aquí esta la identificación numérica como esta en el pedigrí.

Pob_IND_4 <- Pob_IND %>%
  left_join(y = famsnps_IND, by = 'Variety') %>% # Se unen al conjunto de datos famsnps_IND debido a que aquí esta la identificación numérica como esta en el pedigrí.
  bind_rows(Pob_IND_3) %>% # Se une por filas al conjunto de datos de individuos no mejorados anterior Pob_IND_3.
  select(-Variety) %>%
  relocate(
    Fen_escalado,
    .after = id
    )

# 6. Se crea un conjunto de datos donde estaran los fenotipos de los individuos con pedigrí simulado mediante el software molcoanc, y se une posteriormente con el conjunto de datos anterior.

Pob_IND_5 <- tibble(
  id = seq(from = 1, to = 300, by = 1),
  Fen_escalado = rep(x = NA, times = 300)
  ) %>%
  bind_rows(Pob_IND_4) %>%
  arrange(id)

########################################
# Uso del paquete BGLR para el pedigrí 4
########################################

dir.create('../Datos/Datos_IND/Den_10.000/mod_BGLR/Ped_4') # Se crea una carpeta donde se guardaran los resultados del pedigríe 4.

## 1. Subpoblación con 148 individuos genotipados

# a) Se preparan los datos de entrada ----

mH_IND_1 <- readRDS(here('Datos', 'Datos_IND', 'Den_10.000', 'mH', 'Ped_4', 'mH_1', 'mH_1.RDS')) # Se carga la matriz H de los 148 individuos genotipados de la población IND.

Fen_IND <- Pob_IND_5 %>%
  pull(Fen_escalado) # Se extrae del conjunto de datos de fenotipos el fenotipo de interes en forma de vector.

# b) Se configura el predictor lineal ----

ETA = list(list(K = mH_IND_1, model = 'RKHS'))

# c) Se ajusta el modelo ----

dir.create('../Datos/Datos_IND/Den_10.000/mod_BGLR/Ped_4/mod_BGLR_1/') # Se crea una carpeta para guardar los resultados del modelo anteriormente ajustado para 148 indiviuos genotipados.

mod_IND_1 <- BGLR(y = Fen_IND, ETA = ETA, nIter = 50000, burnIn = 10000, saveAt = '../Repo_TFM/Datos/Datos_IND/Den_10.000/mod_BGLR/Ped_4/mod_BGLR_1/ssgblup_')

save(mod_IND_1, file = '../Repo_TFM/Datos/Datos_IND/Den_10.000/mod_BGLR/Ped_4/mod_BGLR_1/mod_BGLR_1.RData')

## 2. Subpoblación con 298 individuos genotipados

# a) Se preparan los datos de entrada ----

mH_IND_2 <- readRDS(here('Datos', 'Datos_IND', 'Den_10.000', 'mH', 'Ped_4', 'mH_2', 'mH_2.RDS')) # Se carga la matriz H de los 298 individuos genotipados de la población IND.

Fen_IND <- Pob_IND_5 %>%
  pull(Fen_escalado) # Se extrae del conjunto de datos de fenotipos el fenotipo de interes en forma de vector.

# b) Se configura el predictor lineal ----

ETA = list(list(K = mH_IND_2, model = 'RKHS'))

# c) Se ajusta el modelo ----

dir.create('../Repo_TFM/Datos/Datos_IND/Den_10.000/mod_BGLR/Ped_4/mod_BGLR_2/') # Se crea una carpeta para guardar los resultados del modelo anteriormente ajustado para 298 indiviuos genotipados.

mod_IND_2 <- BGLR(y = Fen_IND, ETA = ETA, nIter = 50000, burnIn = 10000, saveAt = '../Repo_TFM/Datos/Datos_IND/Den_10.000/mod_BGLR/Ped_4/mod_BGLR_2/ssgblup_')

save(mod_IND_2, file = '../Repo_TFM/Datos/Datos_IND/Den_10.000/mod_BGLR/Ped_4/mod_BGLR_2/mod_BGLR_2.RData')

## 3. Subpoblación con 451 individuos genotipados

# a) Se preparan los datos de entrada ----

mH_IND_3 <- readRDS(here('Datos', 'Datos_IND', 'Den_10.000', 'mH', 'Ped_4', 'mH_3', 'mH_3.RDS')) # Se carga la matriz H de los 451 individuos genotipados de la población IND.

Fen_IND <- Pob_IND_5 %>%
  pull(Fen_escalado) # Se extrae del conjunto de datos de fenotipos el fenotipo de interes en forma de vector.

# b) Se configura el predictor lineal ----

ETA = list(list(K = mH_IND_3, model = 'RKHS'))

# c) Se ajusta el modelo ----

dir.create('../Datos/Datos_IND/Den_10.000/mod_BGLR/Ped_4/mod_BGLR_3/') # Se crea una carpeta para guardar los resultados del modelo anteriormente ajustado para 298 indiviuos genotipados.

mod_IND_3 <- BGLR(y = Fen_IND, ETA = ETA, nIter = 50000, burnIn = 10000, saveAt = '../Repo_TFM/Datos/Datos_IND/Den_10.000/mod_BGLR/Ped_4/mod_BGLR_3/ssgblup_')

save(mod_IND_3, file = '../Repo_TFM/Datos/Datos_IND/Den_10.000/mod_BGLR/Ped_4/mod_BGLR_3/mod_BGLR_3.RData')

########################################################
# Pedigrí 5: 1530 individuos simulados en 9 generaciones
########################################################

# 4. Se importa el archivo .fam obtenido usando plink y que posteriomente se uso para crear la hoja de parámetros para ejecutar el software molcoanc.

famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'nSNPs_IND.fam')) %>% 
  select(fam) %>%
  mutate(id = 1531:1981) %>%
  rename(Variety = fam)

# 5. Se unen en un solo conjuntos de datos los individuos mejorados y no mejorados.

Pob_IND_3 <- Pob_IND_2 %>%
  left_join(y = famsnps_IND, by = 'Variety') # Se unen al conjunto de datos anterior (famsnps_IND) debido a que aquí esta la identificación numérica como esta en el pedigrí.

Pob_IND_4 <- Pob_IND %>%
  left_join(y = famsnps_IND, by = 'Variety') %>% # Se unen al conjunto de datos famsnps_IND debido a que aquí esta la identificación numérica como esta en el pedigrí.
  bind_rows(Pob_IND_3) %>% # Se une por filas al conjunto de datos de individuos no mejorados anterior Pob_IND_3.
  select(-Variety) %>%
  relocate(
    Fen_escalado,
    .after = id
    )

# 6. Se crea un conjunto de datos donde estaran los fenotipos de los individuos con pedigrí simulado mediante el software molcoanc, y se une posteriormente con el conjunto de datos anterior.

Pob_IND_5 <- tibble(
  id = seq(from = 1, to = 1530, by = 1),
  Fen_escalado = rep(x = NA, times = 1530)
  ) %>%
  bind_rows(Pob_IND_4) %>%
  arrange(id)

########################################
# Uso del paquete BGLR para el pedigrí 5
########################################

dir.create('../Datos/Datos_IND/Den_10.000/mod_BGLR/Ped_5') # Se crea una carpeta donde se guardaran los resultados del pedigríe 4.

## 1. Subpoblación con 148 individuos genotipados

# a) Se preparan los datos de entrada ----

mH_IND_1 <- readRDS(here('Datos', 'Datos_IND', 'Den_10.000', 'mH', 'Ped_5', 'mH_1', 'mH_1.RDS')) # Se carga la matriz H de los 148 individuos genotipados de la población IND.

Fen_IND <- Pob_IND_5 %>%
  pull(Fen_escalado) # Se extrae del conjunto de datos de fenotipos el fenotipo de interes en forma de vector.

# b) Se configura el predictor lineal ----

ETA = list(list(K = mH_IND_1, model = 'RKHS'))

# c) Se ajusta el modelo ----

dir.create('../Datos/Datos_IND/Den_10.000/mod_BGLR/Ped_5/mod_BGLR_1/') # Se crea una carpeta para guardar los resultados del modelo anteriormente ajustado para 148 indiviuos genotipados.

mod_IND_1 <- BGLR(y = Fen_IND, ETA = ETA, nIter = 50000, burnIn = 10000, saveAt = '../Repo_TFM/Datos/Datos_IND/Den_10.000/mod_BGLR/Ped_5/mod_BGLR_1/ssgblup_')

save(mod_IND_1, file = '../Repo_TFM/Datos/Datos_IND/Den_10.000/mod_BGLR/Ped_5/mod_BGLR_1/mod_BGLR_1.RData')

## 2. Subpoblación con 298 individuos genotipados

# a) Se preparan los datos de entrada ----

mH_IND_2 <- readRDS(here('Datos', 'Datos_IND', 'Den_10.000', 'mH', 'Ped_5', 'mH_2', 'mH_2.RDS')) # Se carga la matriz H de los 298 individuos genotipados de la población IND.

Fen_IND <- Pob_IND_5 %>%
  pull(Fen_escalado) # Se extrae del conjunto de datos de fenotipos el fenotipo de interes en forma de vector.

# b) Se configura el predictor lineal ----

ETA = list(list(K = mH_IND_2, model = 'RKHS'))

# c) Se ajusta el modelo ----

dir.create('../Datos/Datos_IND/Den_10.000/mod_BGLR/Ped_5/mod_BGLR_2/') # Se crea una carpeta para guardar los resultados del modelo anteriormente ajustado para 148 indiviuos genotipados.

mod_IND_2 <- BGLR(y = Fen_IND, ETA = ETA, nIter = 50000, burnIn = 10000, saveAt = '../Repo_TFM/Datos/Datos_IND/Den_10.000/mod_BGLR/Ped_5/mod_BGLR_2/ssgblup_')

save(mod_IND_2, file = '../Repo_TFM/Datos/Datos_IND/Den_10.000/mod_BGLR/Ped_5/mod_BGLR_2/mod_BGLR_2.RData')

## 3. Subpoblación con 451 individuos genotipados

# a) Se preparan los datos de entrada ----

mH_IND_3 <- readRDS(here('Datos', 'Datos_IND', 'Den_10.000', 'mH', 'Ped_5', 'mH_3', 'mH_3.RDS')) # Se carga la matriz H de los 451 individuos genotipados de la población IND.

Fen_IND <- Pob_IND_5 %>%
  pull(Fen_escalado) # Se extrae del conjunto de datos de fenotipos el fenotipo de interes en forma de vector.

# b) Se configura el predictor lineal ----

ETA = list(list(K = mH_IND_3, model = 'RKHS'))

# c) Se ajusta el modelo ----

dir.create('../Datos/Datos_IND/Den_10.000/mod_BGLR/Ped_5/mod_BGLR_3/') # Se crea una carpeta para guardar los resultados del modelo anteriormente ajustado para 148 indiviuos genotipados.

mod_IND_3 <- BGLR(y = Fen_IND, ETA = ETA, nIter = 50000, burnIn = 10000, saveAt = '../Repo_TFM/Datos/Datos_IND/Den_10.000/mod_BGLR/Ped_5/mod_BGLR_3/ssgblup_')

save(mod_IND_3, file = '../Repo_TFM/Datos/Datos_IND/Den_10.000/mod_BGLR/Ped_5/mod_BGLR_3/mod_BGLR_3.RData')

#### Población de arroz IND (1.000 SNPs) ----

dir.create('../Datos/Datos_IND/Den_1.000/mod_BGLR') # Se crea una carpeta donde se guardaran los resultados de los modelos que se ajustaran para las distintas subpoblaciones de individuos genotipados con distintos pedigríes, con una desnidad de SNPs de 1.000.

# 1. Se importan las bases de datos de fenotipos y de linea mejorada.

lin_mej <- read_delim(here('Datos', 'iris_pedigree.csv'), delim = ',')
Fenotipos <- read_delim(here('Datos', 'all.phenotypes.csv'), delim = ',')

#### Población de arroz IND ----

# 2. Se crea un conjunto de datos que contiene solo los individuos mejorados.

Pob_mej <- lin_mej %>%
  filter(Status_with_Pedigree.plus.knowledge == 'I') %>% # Conjunto de datos solo con los individuos mejorados (los que se clasificaron como "I").
  select(X3K_DNA_IRIS_UNIQUE_ID) %>%
  rename(Variety = X3K_DNA_IRIS_UNIQUE_ID)

escalado <- function(x) { # Función usada para escalar el fenotipo.
  (x - mean(x, na.rm = TRUE)) / sd(x, na.rm = TRUE)
  }

Pob_IND <- Fenotipos %>%
  filter(SNPsubsp == 'IND') %>% # Conjunto de datos solo con la especie IND.
  mutate(
    Variety_2 = Variety,
    Fen_escalado = escalado(Time.to.flowering..from.sowing)
    ) %>%
  separate(
    col = Variety,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  ' '
  ) %>%
  unite(
    col = Variety,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  separate(
    col = Variety,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  '-'
  ) %>%
  unite(
    col = Variety,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  separate(
    col = Variety_2,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  ' '
  ) %>%
  unite(
    col = Variety_2,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  inner_join(y = Pob_mej, by = 'Variety') %>%
  select(Variety_2, Fen_escalado) %>% # Se creo el conjunto de datos con los individuos mejorados de la población indica.
  mutate(Fen_escalado = NA) %>% # Los fenotipos de estos individuos se deben colocar como NAs al formar parte de la población de validación cruzada, y al ser los individuos que se quieren predecir.
  rename(Variety = Variety_2)

# 3. Se crea un conjunto de datos que no contiene los individuos mejorados.

Pob_IND_2 <- Fenotipos %>%
  filter(SNPsubsp == 'IND') %>% # Conjunto de datos solo con la especie IND.
  mutate(
    Variety_2 = Variety,
    Fen_escalado = escalado(Time.to.flowering..from.sowing)
    ) %>%
  separate(
    col = Variety,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  ' '
  ) %>%
  unite(
    col = Variety,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  separate(
    col = Variety,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  '-'
  ) %>%
  unite(
    col = Variety,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  separate(
    col = Variety_2,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  ' '
  ) %>%
  unite(
    col = Variety_2,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  anti_join(Pob_mej, by = 'Variety') %>%
  select(Variety_2, Fen_escalado) %>% # Se creo el conjunto de datos con los individuos no mejorados de la población indica.
  rename(Variety = Variety_2)

#########################################################
# Pedigrí 1: 2000 individuos simulados en 10 generaciones
#########################################################

# 4. Se importa el archivo .fam obtenido usando plink y que posteriomente se uso para crear la hoja de parámetros para ejecutar el software molcoanc.

famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'nSNPs_IND.fam')) %>% 
  select(fam) %>%
  mutate(id = 2001:2451) %>%
  rename(Variety = fam)

# 5. Se unen en un solo conjuntos de datos los individuos mejorados y no mejorados.

Pob_IND_3 <- Pob_IND_2 %>%
  left_join(y = famsnps_IND, by = 'Variety') # Se unen al conjunto de datos anterior (famsnps_IND) debido a que aquí esta la identificación numérica como esta en el pedigrí.

Pob_IND_4 <- Pob_IND %>%
  left_join(y = famsnps_IND, by = 'Variety') %>% # Se unen al conjunto de datos famsnps_IND debido a que aquí esta la identificación numérica como esta en el pedigrí.
  bind_rows(Pob_IND_3) %>% # Se une por filas al conjunto de datos de individuos no mejorados anterior Pob_IND_3.
  select(-Variety) %>%
  relocate(
    Fen_escalado,
    .after = id
    )

# 6. Se crea un conjunto de datos donde estaran los fenotipos de los individuos con pedigrí simulado mediante el software molcoanc, y se une posteriormente con el conjunto de datos anterior.

Pob_IND_5 <- tibble(
  id = seq(from = 1, to = 2000, by = 1),
  Fen_escalado = rep(x = NA, times = 2000)
  ) %>%
  bind_rows(Pob_IND_4) %>%
  arrange(id)

########################################
# Uso del paquete BGLR para el pedigrí 1
########################################

dir.create('../Datos/Datos_IND/Den_1.000/mod_BGLR_d/Ped_1') # Se crea una carpeta donde se guardaran los resultados del pedigríe 1.

## 1. Subpoblación con 148 individuos genotipados

# a) Se preparan los datos de entrada ----

mH_IND_1 <- readRDS(here('Datos', 'Datos_IND', 'Den_1.000', 'mH', 'Ped_1', 'mH_1', 'mH_1.RDS')) # Se carga la matriz H de los 148 individuos genotipados de la población IND.

Fen_IND <- Pob_IND_5 %>%
  pull(Fen_escalado) # Se extrae del conjunto de datos de fenotipos el fenotipo de interes en forma de vector.

# b) Se configura el predictor lineal ----

ETA = list(list(K = mH_IND_1, model = 'RKHS'))

# c) Se ajusta el modelo ----

dir.create('../Datos/Datos_IND/Den_1.000/mod_BGLR/Ped_1/mod_BGLR_1/') # Se crea una carpeta para guardar los resultados del modelo anteriormente ajustado para 148 indiviuos genotipados.

mod_IND_1 <- BGLR(y = Fen_IND, ETA = ETA, nIter = 50000, burnIn = 10000, saveAt = '../Repo_TFM/Datos/Datos_IND/Den_1.000/mod_BGLR/Ped_1/mod_BGLR_1/ssgblup_')

save(mod_IND_1, file = '../Repo_TFM/Datos/Datos_IND/Den_1.000/mod_BGLR/Ped_1/mod_BGLR_1/mod_BGLR_1.RData')

## 2. Subpoblación con 298 individuos genotipados

# a) Se preparan los datos de entrada ----

mH_IND_2 <- readRDS(here('Datos', 'Datos_IND', 'Den_1.000', 'mH', 'Ped_1', 'mH_2', 'mH_2.RDS')) # Se carga la matriz H de los 298 individuos genotipados de la población IND.

Fen_IND <- Pob_IND_5 %>%
  pull(Fen_escalado) # Se extrae del conjunto de datos de fenotipos el fenotipo de interes en forma de vector.

# b) Se configura el predictor lineal ----

ETA = list(list(K = mH_IND_2, model = 'RKHS'))

# c) Se ajusta el modelo ----

dir.create('../Datos/Datos_IND/Den_1.000/mod_BGLR/Ped_1/mod_BGLR_2/') # Se crea una carpeta para guardar los resultados del modelo anteriormente ajustado para 298 indiviuos genotipados.

mod_IND_2 <- BGLR(y = Fen_IND, ETA = ETA, nIter = 50000, burnIn = 10000, saveAt = '../Repo_TFM/Datos/Datos_IND/Den_1.000/mod_BGLR/Ped_1/mod_BGLR_2/ssgblup_')

save(mod_IND_2, file = '../Repo_TFM/Datos/Datos_IND/Den_1.000/mod_BGLR/Ped_1/mod_BGLR_2/mod_BGLR_2.RData')

## 3. Subpoblación con 451 individuos genotipados

# a) Se preparan los datos de entrada ----

mH_IND_3 <- readRDS(here('Datos', 'Datos_IND', 'Den_1.000', 'mH', 'Ped_1', 'mH_3', 'mH_3.RDS')) # Se carga la matriz H de los 451 individuos genotipados de la población IND.

Fen_IND <- Pob_IND_5 %>%
  pull(Fen_escalado) # Se extrae del conjunto de datos de fenotipos el fenotipo de interes en forma de vector.

# b) Se configura el predictor lineal ----

ETA = list(list(K = mH_IND_3, model = 'RKHS'))

# c) Se ajusta el modelo ----

dir.create('../Datos/Datos_IND/Den_1.000/mod_BGLR/Ped_1/mod_BGLR_3/') # Se crea una carpeta para guardar los resultados del modelo anteriormente ajustado para 298 indiviuos genotipados.

mod_IND_3 <- BGLR(y = Fen_IND, ETA = ETA, nIter = 50000, burnIn = 10000, saveAt = '../Repo_TFM/Datos/Datos_IND/Den_1.000/mod_BGLR/Ped_1/mod_BGLR_3/ssgblup_')

save(mod_IND_3, file = '../Repo_TFM/Datos/Datos_IND/Den_1.000/mod_BGLR/Ped_1/mod_BGLR_3/mod_BGLR_3.RData')

#######################################################
# Pedigrí 2: 520 individuos simulados en 4 generaciones
#######################################################

# 4. Se importa el archivo .fam obtenido usando plink y que posteriomente se uso para crear la hoja de parámetros para ejecutar el software molcoanc.

famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'nSNPs_IND.fam')) %>% 
  select(fam) %>%
  mutate(id = 521:971) %>%
  rename(Variety = fam)

# 5. Se unen en un solo conjuntos de datos los individuos mejorados y no mejorados.

Pob_IND_3 <- Pob_IND_2 %>%
  left_join(y = famsnps_IND, by = 'Variety') # Se unen al conjunto de datos anterior (famsnps_IND) debido a que aquí esta la identificación numérica como esta en el pedigrí.

Pob_IND_4 <- Pob_IND %>%
  left_join(y = famsnps_IND, by = 'Variety') %>% # Se unen al conjunto de datos famsnps_IND debido a que aquí esta la identificación numérica como esta en el pedigrí.
  bind_rows(Pob_IND_3) %>% # Se une por filas al conjunto de datos de individuos no mejorados anterior Pob_IND_3.
  select(-Variety) %>%
  relocate(
    Fen_escalado,
    .after = id
    )

# 6. Se crea un conjunto de datos donde estaran los fenotipos de los individuos con pedigrí simulado mediante el software molcoanc, y se une posteriormente con el conjunto de datos anterior.

Pob_IND_5 <- tibble(
  id = seq(from = 1, to = 520, by = 1),
  Fen_escalado = rep(x = NA, times = 520)
  ) %>%
  bind_rows(Pob_IND_4) %>%
  arrange(id)

########################################
# Uso del paquete BGLR para el pedigrí 2
########################################

dir.create('../Datos/Datos_IND/Den_1.000/mod_BGLR/Ped_2') # Se crea una carpeta donde se guardaran los resultados del pedigríe 2.

## 1. Subpoblación con 148 individuos genotipados

# a) Se preparan los datos de entrada ----

mH_IND_1 <- readRDS(here('Datos', 'Datos_IND', 'Den_1.000', 'mH', 'Ped_2', 'mH_1', 'mH_1.RDS')) # Se carga la matriz H de los 148 individuos genotipados de la población IND.

Fen_IND <- Pob_IND_5 %>%
  pull(Fen_escalado) # Se extrae del conjunto de datos de fenotipos el fenotipo de interes en forma de vector.

# b) Se configura el predictor lineal ----

ETA = list(list(K = mH_IND_1, model = 'RKHS'))

# c) Se ajusta el modelo ----

dir.create('../Datos/Datos_IND/Den_1.000/mod_BGLR/Ped_2/mod_BGLR_1/') # Se crea una carpeta para guardar los resultados del modelo anteriormente ajustado para 148 indiviuos genotipados.

mod_IND_1 <- BGLR(y = Fen_IND, ETA = ETA, nIter = 50000, burnIn = 10000, saveAt = '../Repo_TFM/Datos/Datos_IND/Den_1.000/mod_BGLR/Ped_2/mod_BGLR_1/ssgblup_')

save(mod_IND_1, file = '../Repo_TFM/Datos/Datos_IND/Den_1.000/mod_BGLR/Ped_2/mod_BGLR_1/mod_BGLR_1.RData')

## 2. Subpoblación con 298 individuos genotipados

# a) Se preparan los datos de entrada ----

mH_IND_2 <- readRDS(here('Datos', 'Datos_IND', 'Den_1.000', 'mH', 'Ped_2', 'mH_2', 'mH_2.RDS')) # Se carga la matriz H de los 298 individuos genotipados de la población IND.

Fen_IND <- Pob_IND_5 %>%
  pull(Fen_escalado) # Se extrae del conjunto de datos de fenotipos el fenotipo de interes en forma de vector.

# b) Se configura el predictor lineal ----

ETA = list(list(K = mH_IND_2, model = 'RKHS'))

# c) Se ajusta el modelo ----

dir.create('../Datos/Datos_IND/Den_1.000/mod_BGLR/Ped_2/mod_BGLR_2/') # Se crea una carpeta para guardar los resultados del modelo anteriormente ajustado para 298 indiviuos genotipados.

mod_IND_2 <- BGLR(y = Fen_IND, ETA = ETA, nIter = 50000, burnIn = 10000, saveAt = '../Repo_TFM/Datos/Datos_IND/Den_1.000/mod_BGLR/Ped_2/mod_BGLR_2/ssgblup_')

save(mod_IND_2, file = '../Repo_TFM/Datos/Datos_IND/Den_1.000/mod_BGLR/Ped_2/mod_BGLR_2/mod_BGLR_2.RData')

## 3. Subpoblación con 451 individuos genotipados

# a) Se preparan los datos de entrada ----

mH_IND_3 <- readRDS(here('Datos', 'Datos_IND', 'Den_1.000', 'mH', 'Ped_2', 'mH_3', 'mH_3.RDS')) # Se carga la matriz H de los 451 individuos genotipados de la población IND.

Fen_IND <- Pob_IND_5 %>%
  pull(Fen_escalado) # Se extrae del conjunto de datos de fenotipos el fenotipo de interes en forma de vector.

# b) Se configura el predictor lineal ----

ETA = list(list(K = mH_IND_3, model = 'RKHS'))

# c) Se ajusta el modelo ----

dir.create('../Datos/Datos_IND/Den_1.000/mod_BGLR/Ped_2/mod_BGLR_3/') # Se crea una carpeta para guardar los resultados del modelo anteriormente ajustado para 298 indiviuos genotipados.

mod_IND_3 <- BGLR(y = Fen_IND, ETA = ETA, nIter = 50000, burnIn = 10000, saveAt = '../Repo_TFM/Datos/Datos_IND/Den_1.000/mod_BGLR/Ped_2/mod_BGLR_3/ssgblup_')

save(mod_IND_3, file = '../Repo_TFM/Datos/Datos_IND/Den_1.000/mod_BGLR/Ped_2/mod_BGLR_3/mod_BGLR_3.RData')

########################################################
# Pedigrí 3: 1210 individuos simulados en 7 generaciones
########################################################

# 4. Se importa el archivo .fam obtenido usando plink y que posteriomente se uso para crear la hoja de parámetros para ejecutar el software molcoanc.

famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'nSNPs_IND.fam')) %>% 
  select(fam) %>%
  mutate(id = 1211:1661) %>%
  rename(Variety = fam)

# 5. Se unen en un solo conjuntos de datos los individuos mejorados y no mejorados.

Pob_IND_3 <- Pob_IND_2 %>%
  left_join(y = famsnps_IND, by = 'Variety') # Se unen al conjunto de datos anterior (famsnps_IND) debido a que aquí esta la identificación numérica como esta en el pedigrí.

Pob_IND_4 <- Pob_IND %>%
  left_join(y = famsnps_IND, by = 'Variety') %>% # Se unen al conjunto de datos famsnps_IND debido a que aquí esta la identificación numérica como esta en el pedigrí.
  bind_rows(Pob_IND_3) %>% # Se une por filas al conjunto de datos de individuos no mejorados anterior Pob_IND_3.
  select(-Variety) %>%
  relocate(
    Fen_escalado,
    .after = id
    )

# 6. Se crea un conjunto de datos donde estaran los fenotipos de los individuos con pedigrí simulado mediante el software molcoanc, y se une posteriormente con el conjunto de datos anterior.

Pob_IND_5 <- tibble(
  id = seq(from = 1, to = 1210, by = 1),
  Fen_escalado = rep(x = NA, times = 1210)
  ) %>%
  bind_rows(Pob_IND_4) %>%
  arrange(id)

########################################
# Uso del paquete BGLR para el pedigrí 3
########################################

dir.create('../Datos/Datos_IND/Den_1.000/mod_BGLR/Ped_3') # Se crea una carpeta donde se guardaran los resultados del pedigríe 3.

## 1. Subpoblación con 148 individuos genotipados

# a) Se preparan los datos de entrada ----

mH_IND_1 <- readRDS(here('Datos', 'Datos_IND', 'Den_1.000', 'mH', 'Ped_3', 'mH_1', 'mH_1.RDS')) # Se carga la matriz H de los 148 individuos genotipados de la población IND.

Fen_IND <- Pob_IND_5 %>%
  pull(Fen_escalado) # Se extrae del conjunto de datos de fenotipos el fenotipo de interes en forma de vector.

# b) Se configura el predictor lineal ----

ETA = list(list(K = mH_IND_1, model = 'RKHS'))

# c) Se ajusta el modelo ----

dir.create('../Datos/Datos_IND/Den_1.000/mod_BGLR/Ped_3/mod_BGLR_1/') # Se crea una carpeta para guardar los resultados del modelo anteriormente ajustado para 148 indiviuos genotipados.

mod_IND_1 <- BGLR(y = Fen_IND, ETA = ETA, nIter = 50000, burnIn = 10000, saveAt = '../Repo_TFM/Datos/Datos_IND/Den_1.000/mod_BGLR/Ped_3/mod_BGLR_1/ssgblup_')

save(mod_IND_1, file = '../Repo_TFM/Datos/Datos_IND/Den_1.000/mod_BGLR/Ped_3/mod_BGLR_1/mod_BGLR_1.RData')

## 2. Subpoblación con 298 individuos genotipados

# a) Se preparan los datos de entrada ----

mH_IND_2 <- readRDS(here('Datos', 'Datos_IND', 'Den_1.000', 'mH', 'Ped_3', 'mH_2', 'mH_2.RDS')) # Se carga la matriz H de los 298 individuos genotipados de la población IND.

Fen_IND <- Pob_IND_5 %>%
  pull(Fen_escalado) # Se extrae del conjunto de datos de fenotipos el fenotipo de interes en forma de vector.

# b) Se configura el predictor lineal ----

ETA = list(list(K = mH_IND_2, model = 'RKHS'))

# c) Se ajusta el modelo ----

dir.create('../Datos/Datos_IND/Den_1.000/mod_BGLR/Ped_3/mod_BGLR_2/') # Se crea una carpeta para guardar los resultados del modelo anteriormente ajustado para 298 indiviuos genotipados.

mod_IND_2 <- BGLR(y = Fen_IND, ETA = ETA, nIter = 50000, burnIn = 10000, saveAt = '../Repo_TFM/Datos/Datos_IND/Den_1.000/mod_BGLR/Ped_3/mod_BGLR_2/ssgblup_')

save(mod_IND_2, file = '../Repo_TFM/Datos/Datos_IND/Den_1.000/mod_BGLR/Ped_3/mod_BGLR_2/mod_BGLR_2.RData')

## 3. Subpoblación con 451 individuos genotipados

# a) Se preparan los datos de entrada ----

mH_IND_3 <- readRDS(here('Datos', 'Datos_IND', 'Den_1.000', 'mH', 'Ped_3', 'mH_3', 'mH_3.RDS')) # Se carga la matriz H de los 451 individuos genotipados de la población IND.

Fen_IND <- Pob_IND_5 %>%
  pull(Fen_escalado) # Se extrae del conjunto de datos de fenotipos el fenotipo de interes en forma de vector.

# b) Se configura el predictor lineal ----

ETA = list(list(K = mH_IND_3, model = 'RKHS'))

# c) Se ajusta el modelo ----

dir.create('../Datos/Datos_IND/Den_1.000/mod_BGLR/Ped_3/mod_BGLR_3/') # Se crea una carpeta para guardar los resultados del modelo anteriormente ajustado para 298 indiviuos genotipados.

mod_IND_3 <- BGLR(y = Fen_IND, ETA = ETA, nIter = 50000, burnIn = 10000, saveAt = '../Repo_TFM/Datos/Datos_IND/Den_1.000/mod_BGLR/Ped_3/mod_BGLR_3/ssgblup_')

save(mod_IND_3, file = '../Repo_TFM/Datos/Datos_IND/Den_1.000/mod_BGLR/Ped_3/mod_BGLR_3/mod_BGLR_3.RData')

#######################################################
# Pedigrí 4: 300 individuos simulados en 3 generaciones
#######################################################

# 4. Se importa el archivo .fam obtenido usando plink y que posteriomente se uso para crear la hoja de parámetros para ejecutar el software molcoanc.

famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'nSNPs_IND.fam')) %>% 
  select(fam) %>%
  mutate(id = 301:751) %>%
  rename(Variety = fam)

# 5. Se unen en un solo conjuntos de datos los individuos mejorados y no mejorados.

Pob_IND_3 <- Pob_IND_2 %>%
  left_join(y = famsnps_IND, by = 'Variety') # Se unen al conjunto de datos anterior (famsnps_IND) debido a que aquí esta la identificación numérica como esta en el pedigrí.

Pob_IND_4 <- Pob_IND %>%
  left_join(y = famsnps_IND, by = 'Variety') %>% # Se unen al conjunto de datos famsnps_IND debido a que aquí esta la identificación numérica como esta en el pedigrí.
  bind_rows(Pob_IND_3) %>% # Se une por filas al conjunto de datos de individuos no mejorados anterior Pob_IND_3.
  select(-Variety) %>%
  relocate(
    Fen_escalado,
    .after = id
    )

# 6. Se crea un conjunto de datos donde estaran los fenotipos de los individuos con pedigrí simulado mediante el software molcoanc, y se une posteriormente con el conjunto de datos anterior.

Pob_IND_5 <- tibble(
  id = seq(from = 1, to = 300, by = 1),
  Fen_escalado = rep(x = NA, times = 300)
  ) %>%
  bind_rows(Pob_IND_4) %>%
  arrange(id)

########################################
# Uso del paquete BGLR para el pedigrí 4
########################################

dir.create('../Datos/Datos_IND/Den_1.000/mod_BGLR/Ped_4') # Se crea una carpeta donde se guardaran los resultados del pedigríe 4.

## 1. Subpoblación con 148 individuos genotipados

# a) Se preparan los datos de entrada ----

mH_IND_1 <- readRDS(here('Datos', 'Datos_IND', 'Den_1.000', 'mH', 'Ped_4', 'mH_1', 'mH_1.RDS')) # Se carga la matriz H de los 148 individuos genotipados de la población IND.

Fen_IND <- Pob_IND_5 %>%
  pull(Fen_escalado) # Se extrae del conjunto de datos de fenotipos el fenotipo de interes en forma de vector.

# b) Se configura el predictor lineal ----

ETA = list(list(K = mH_IND_1, model = 'RKHS'))

# c) Se ajusta el modelo ----

dir.create('../Datos/Datos_IND/Den_1.000/mod_BGLR/Ped_4/mod_BGLR_1/') # Se crea una carpeta para guardar los resultados del modelo anteriormente ajustado para 148 indiviuos genotipados.

mod_IND_1 <- BGLR(y = Fen_IND, ETA = ETA, nIter = 50000, burnIn = 10000, saveAt = '../Repo_TFM/Datos/Datos_IND/Den_1.000/mod_BGLR/Ped_4/mod_BGLR_1/ssgblup_')

save(mod_IND_1, file = '../Repo_TFM/Datos/Datos_IND/Den_1.000/mod_BGLR/Ped_4/mod_BGLR_1/mod_BGLR_1.RData')

## 2. Subpoblación con 298 individuos genotipados

# a) Se preparan los datos de entrada ----

mH_IND_2 <- readRDS(here('Datos', 'Datos_IND', 'Den_1.000', 'mH', 'Ped_4', 'mH_2', 'mH_2.RDS')) # Se carga la matriz H de los 298 individuos genotipados de la población IND.

Fen_IND <- Pob_IND_5 %>%
  pull(Fen_escalado) # Se extrae del conjunto de datos de fenotipos el fenotipo de interes en forma de vector.

# b) Se configura el predictor lineal ----

ETA = list(list(K = mH_IND_2, model = 'RKHS'))

# c) Se ajusta el modelo ----

dir.create('../Datos/Datos_IND/Den_1.000/mod_BGLR/Ped_4/mod_BGLR_2/') # Se crea una carpeta para guardar los resultados del modelo anteriormente ajustado para 298 indiviuos genotipados.

mod_IND_2 <- BGLR(y = Fen_IND, ETA = ETA, nIter = 50000, burnIn = 10000, saveAt = '../Repo_TFM/Datos/Datos_IND/Den_1.000/mod_BGLR/Ped_4/mod_BGLR_2/ssgblup_')

save(mod_IND_2, file = '../Repo_TFM/Datos/Datos_IND/Den_1.000/mod_BGLR/Ped_4/mod_BGLR_2/mod_BGLR_2.RData')

## 3. Subpoblación con 451 individuos genotipados

# a) Se preparan los datos de entrada ----

mH_IND_3 <- readRDS(here('Datos', 'Datos_IND', 'Den_1.000', 'mH', 'Ped_4', 'mH_3', 'mH_3.RDS')) # Se carga la matriz H de los 451 individuos genotipados de la población IND.

Fen_IND <- Pob_IND_5 %>%
  pull(Fen_escalado) # Se extrae del conjunto de datos de fenotipos el fenotipo de interes en forma de vector.

# b) Se configura el predictor lineal ----

ETA = list(list(K = mH_IND_3, model = 'RKHS'))

# c) Se ajusta el modelo ----

dir.create('../Datos/Datos_IND/Den_1.000/mod_BGLR/Ped_4/mod_BGLR_3/') # Se crea una carpeta para guardar los resultados del modelo anteriormente ajustado para 298 indiviuos genotipados.

mod_IND_3 <- BGLR(y = Fen_IND, ETA = ETA, nIter = 50000, burnIn = 10000, saveAt = '../Repo_TFM/Datos/Datos_IND/Den_1.000/mod_BGLR/Ped_4/mod_BGLR_3/ssgblup_')

save(mod_IND_3, file = '../Repo_TFM/Datos/Datos_IND/Den_1.000/mod_BGLR/Ped_4/mod_BGLR_3/mod_BGLR_3.RData')

########################################################
# Pedigrí 5: 1530 individuos simulados en 9 generaciones
########################################################

# 4. Se importa el archivo .fam obtenido usando plink y que posteriomente se uso para crear la hoja de parámetros para ejecutar el software molcoanc.

famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'nSNPs_IND.fam')) %>% 
  select(fam) %>%
  mutate(id = 1531:1981) %>%
  rename(Variety = fam)

# 5. Se unen en un solo conjuntos de datos los individuos mejorados y no mejorados.

Pob_IND_3 <- Pob_IND_2 %>%
  left_join(y = famsnps_IND, by = 'Variety') # Se unen al conjunto de datos anterior (famsnps_IND) debido a que aquí esta la identificación numérica como esta en el pedigrí.

Pob_IND_4 <- Pob_IND %>%
  left_join(y = famsnps_IND, by = 'Variety') %>% # Se unen al conjunto de datos famsnps_IND debido a que aquí esta la identificación numérica como esta en el pedigrí.
  bind_rows(Pob_IND_3) %>% # Se une por filas al conjunto de datos de individuos no mejorados anterior Pob_IND_3.
  select(-Variety) %>%
  relocate(
    Fen_escalado,
    .after = id
    )

# 6. Se crea un conjunto de datos donde estaran los fenotipos de los individuos con pedigrí simulado mediante el software molcoanc, y se une posteriormente con el conjunto de datos anterior.

Pob_IND_5 <- tibble(
  id = seq(from = 1, to = 1530, by = 1),
  Fen_escalado = rep(x = NA, times = 1530)
  ) %>%
  bind_rows(Pob_IND_4) %>%
  arrange(id)

########################################
# Uso del paquete BGLR para el pedigrí 5
########################################

dir.create('../Datos/Datos_IND/Den_1.000/mod_BGLR/Ped_5') # Se crea una carpeta donde se guardaran los resultados del pedigríe 4.

## 1. Subpoblación con 148 individuos genotipados

# a) Se preparan los datos de entrada ----

mH_IND_1 <- readRDS(here('Datos', 'Datos_IND', 'Den_1.000', 'mH', 'Ped_5', 'mH_1', 'mH_1.RDS')) # Se carga la matriz H de los 148 individuos genotipados de la población IND.

Fen_IND <- Pob_IND_5 %>%
  pull(Fen_escalado) # Se extrae del conjunto de datos de fenotipos el fenotipo de interes en forma de vector.

# b) Se configura el predictor lineal ----

ETA = list(list(K = mH_IND_1, model = 'RKHS'))

# c) Se ajusta el modelo ----

dir.create('../Datos/Datos_IND/Den_1.000/mod_BGLR/Ped_5/mod_BGLR_1/') # Se crea una carpeta para guardar los resultados del modelo anteriormente ajustado para 148 indiviuos genotipados.

mod_IND_1 <- BGLR(y = Fen_IND, ETA = ETA, nIter = 50000, burnIn = 10000, saveAt = '../Repo_TFM/Datos/Datos_IND/Den_1.000/mod_BGLR/Ped_5/mod_BGLR_1/ssgblup_')

save(mod_IND_1, file = '../Repo_TFM/Datos/Datos_IND/Den_1.000/mod_BGLR/Ped_5/mod_BGLR_1/mod_BGLR_1.RData')

## 2. Subpoblación con 298 individuos genotipados

# a) Se preparan los datos de entrada ----

mH_IND_2 <- readRDS(here('Datos', 'Datos_IND', 'Den_1.000', 'mH', 'Ped_5', 'mH_2', 'mH_2.RDS')) # Se carga la matriz H de los 298 individuos genotipados de la población IND.

Fen_IND <- Pob_IND_5 %>%
  pull(Fen_escalado) # Se extrae del conjunto de datos de fenotipos el fenotipo de interes en forma de vector.

# b) Se configura el predictor lineal ----

ETA = list(list(K = mH_IND_2, model = 'RKHS'))

# c) Se ajusta el modelo ----

dir.create('../Datos/Datos_IND/Den_1.000/mod_BGLR/Ped_5/mod_BGLR_2/') # Se crea una carpeta para guardar los resultados del modelo anteriormente ajustado para 148 indiviuos genotipados.

mod_IND_2 <- BGLR(y = Fen_IND, ETA = ETA, nIter = 50000, burnIn = 10000, saveAt = '../Repo_TFM/Datos/Datos_IND/Den_1.000/mod_BGLR/Ped_5/mod_BGLR_2/ssgblup_')

save(mod_IND_2, file = '../Repo_TFM/Datos/Datos_IND/Den_1.000/mod_BGLR/Ped_5/mod_BGLR_2/mod_BGLR_2.RData')

## 3. Subpoblación con 451 individuos genotipados

# a) Se preparan los datos de entrada ----

mH_IND_3 <- readRDS(here('Datos', 'Datos_IND', 'Den_1.000', 'mH', 'Ped_5', 'mH_3', 'mH_3.RDS')) # Se carga la matriz H de los 451 individuos genotipados de la población IND.

Fen_IND <- Pob_IND_5 %>%
  pull(Fen_escalado) # Se extrae del conjunto de datos de fenotipos el fenotipo de interes en forma de vector.

# b) Se configura el predictor lineal ----

ETA = list(list(K = mH_IND_3, model = 'RKHS'))

# c) Se ajusta el modelo ----

dir.create('../Datos/Datos_IND/Den_1.000/mod_BGLR/Ped_5/mod_BGLR_3/') # Se crea una carpeta para guardar los resultados del modelo anteriormente ajustado para 148 indiviuos genotipados.

mod_IND_3 <- BGLR(y = Fen_IND, ETA = ETA, nIter = 50000, burnIn = 10000, saveAt = '../Repo_TFM/Datos/Datos_IND/Den_1.000/mod_BGLR/Ped_5/mod_BGLR_3/ssgblup_')

save(mod_IND_3, file = '../Repo_TFM/Datos/Datos_IND/Den_1.000/mod_BGLR/Ped_5/mod_BGLR_3/mod_BGLR_3.RData')
```

# 20. A continuación se analizan los resultados obtenidos al correr los datos con el paquete de R BGLR  para los distintos pedigríes y diferentes densidades de SNPs.

```{r Resultados con el paquete BGLR para los distintos pedigríes y diferentes densidades de SNPs}

# 1. Se importan las bases de datos de feotipos y de linea mejorada.

lin_mej <- read_delim(here('Datos', 'iris_pedigree.csv'), delim = ',')
Fenotipos <- read_delim(here('Datos', 'all.phenotypes.csv'), delim = ',')

#### Población de arroz IND (10.000 SNPs) ----

#########################################################
# Pedigrí 1: 2000 individuos simulados en 10 generaciones
#########################################################

# 2. Se importa el archivo .fam obtenido usando plink y que posteriomente se uso para crear la hoja de parámetros para ejecutar el software molcoanc.

famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'nSNPs_IND.fam')) %>% 
  select(fam) %>%
  mutate(id = 2001:2451) %>%
  rename(Variety = fam)

# 3. Se crea un conjunto de datos que contiene solo los individuos mejorados.

Pob_mej <- lin_mej %>%
  filter(Status_with_Pedigree.plus.knowledge == 'I') %>% # Conjunto de datos solo con los individuos mejorados (los que se clasificaron como "I").
  select(X3K_DNA_IRIS_UNIQUE_ID) %>%
  rename(Variety = X3K_DNA_IRIS_UNIQUE_ID)

escalado <- function(x) { # Función usada para escalar el fenotipo.
  (x - mean(x, na.rm = TRUE)) / sd(x, na.rm = TRUE)
  }

Pob_IND <- Fenotipos %>%
  filter(SNPsubsp == 'IND') %>% # Conjunto de datos solo con la especie IND.
  mutate(
    Variety_2 = Variety,
    Fen_escalado = escalado(Time.to.flowering..from.sowing)
    ) %>%
  separate(
    col = Variety,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  ' '
  ) %>%
  unite(
    col = Variety,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  separate(
    col = Variety,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  '-'
  ) %>%
  unite(
    col = Variety,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  separate(
    col = Variety_2,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  ' '
  ) %>%
  unite(
    col = Variety_2,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  inner_join(y = Pob_mej, by = 'Variety') %>%
  select(Variety_2, Fen_escalado) %>% # Se creo el conjunto de datos con los individuos mejorados de la población indica.
  rename(Variety = Variety_2)

Pob_IND_2 <- Pob_IND %>%
  left_join(y = famsnps_IND, by = 'Variety') # Se unen al conjunto de datos famsnps_IND debido a que aquí esta la identificación numérica como esta en el pedigrí.

## 1. Subpoblación con 148 individuos genotipados

load(here('Datos', 'Datos_IND', 'Den_10.000', 'mod_BGLR', 'Ped_1', 'mod_BGLR_1', 'mod_BGLR_1.RData'))

Pred_IND_1 <- mod_IND_1$yHat %>%
  as_tibble() %>%
  mutate(Subpoblación = '148') %>%
  rowid_to_column(var = 'id') %>%
  right_join(y = Pob_IND_2, by = 'id')  %>%
  rename(
    'Fenotipo_predicho' = value,
    'Fenotipo_observado' = Fen_escalado
    )

## 2. Subpoblación con 298 individuos genotipados

load(here('Datos', 'Datos_IND', 'Den_10.000', 'mod_BGLR', 'Ped_1', 'mod_BGLR_2', 'mod_BGLR_2.RData'))

Pred_IND_2 <- mod_IND_2$yHat %>%
  as_tibble() %>%
  mutate(Subpoblación = '298') %>%
  rowid_to_column(var = 'id') %>%
  right_join(y = Pob_IND_2, by = 'id')  %>%
  rename(
    'Fenotipo_predicho' = value,
    'Fenotipo_observado' = Fen_escalado
    )

## 3. Subpoblación con 451 individuos genotipados

load(here('Datos', 'Datos_IND', 'Den_10.000', 'mod_BGLR', 'Ped_1', 'mod_BGLR_3', 'mod_BGLR_3.RData'))

Pred_IND_3 <- mod_IND_3$yHat %>%
  as_tibble() %>%
  mutate(Subpoblación = '451') %>%
  rowid_to_column(var = 'id') %>%
  right_join(y = Pob_IND_2, by = 'id')  %>%
  rename(
    'Fenotipo_predicho' = value,
    'Fenotipo_observado' = Fen_escalado
    )

## 4. Subpoblación con ningún individuo genotipado

load(here('Datos', 'Datos_IND', 'Den_100.000_b', 'mod_BGLR', 'Ped_1', 'mod_BGLR_4', 'mod_BGLR_4.RData'))

Pred_IND_4 <- mod_IND_4$yHat %>%
  as_tibble() %>%
  mutate(Subpoblación = '0') %>%
  rowid_to_column(var = 'id') %>%
  right_join(y = Pob_IND_2, by = 'id')  %>%
  rename(
    'Fenotipo_predicho' = value,
    'Fenotipo_observado' = Fen_escalado
    )

# 4. Se unen todos los datos anteriores de las distintas subpoblaciones de individuos genotipados en un solo conjunto de datos.

Pred_IND_a <- bind_rows(Pred_IND_1, Pred_IND_2, Pred_IND_3, Pred_IND_4) %>%
  arrange(id) %>%
  relocate(
    Variety,
    .after = id
    ) %>%
  relocate(
    Fenotipo_predicho,
    .after = Fenotipo_observado
    ) %>%
  mutate(Pedigrí = '5')

#######################################################
# Gráfico de dispersión de los resultados del pedigrí 1
#######################################################

Graf_disp_IND <- function(Subpoblación) {
  Pred_IND_a %>%
    filter(.data$Subpoblación == .env$Subpoblación) %>%
    ggplot() +
    aes(x = Fenotipo_observado, y = Fenotipo_predicho) +
    geom_point(size = 4.4, colour = 'cyan', alpha = 0.6) +
    geom_smooth(color = 'cyan', fill = 'cyan', method = 'lm', se = TRUE) +
    stat_cor(p.accuracy = 0.001, colour = 'gray34', label.x = -1.5, label.y = -1.5) +
    geom_rug(colour = 'gray') +
    scale_x_continuous(labels = label_number(accuracy = 0.01)) +
    scale_y_continuous(labels = label_number(accuracy = 0.01)) +
    ggtitle(glue('Individuos genotipados: {Subpoblación}')) +
    labs(x = 'Fenotipo observado', y = 'Fenotipo predicho') +
    theme_bw() +
    theme(
      axis.text = element_text(size = 14),
      axis.title = element_text(size = 15, face = 'bold'),
      plot.title = element_text(size = 11, face = 'bold'),
      legend.position = 'none'
      )
  }

Subpoblación <- c('0', '148', '298', '451')
Graf <- map(Subpoblación, Graf_disp_IND)
(Graf[[1]] | Graf[[2]] | Graf[[3]] | Graf[[4]]) #+
  #plot_annotation(title = 'Pedigrí tres') # Aquí se coloco pedigrí tres pero en realidad es el pedigrí cinco.

#######################################################
# Pedigrí 2: 520 individuos simulados en 4 generaciones
#######################################################

# 2. Se importa el archivo .fam obtenido usando plink y que posteriomente se uso para crear la hoja de parámetros para ejecutar el software molcoanc.

famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'nSNPs_IND.fam')) %>% 
  select(fam) %>%
  mutate(id = 521:971) %>%
  rename(Variety = fam)

# 3. Se crea un conjunto de datos que contiene solo los individuos mejorados.

Pob_mej <- lin_mej %>%
  filter(Status_with_Pedigree.plus.knowledge == 'I') %>% # Conjunto de datos solo con los individuos mejorados (los que se clasificaron como "I").
  select(X3K_DNA_IRIS_UNIQUE_ID) %>%
  rename(Variety = X3K_DNA_IRIS_UNIQUE_ID)

escalado <- function(x) { # Función usada para escalar el fenotipo.
  (x - mean(x, na.rm = TRUE)) / sd(x, na.rm = TRUE)
  }

Pob_IND <- Fenotipos %>%
  filter(SNPsubsp == 'IND') %>% # Conjunto de datos solo con la especie IND.
  mutate(
    Variety_2 = Variety,
    Fen_escalado = escalado(Time.to.flowering..from.sowing)
    ) %>%
  separate(
    col = Variety,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  ' '
  ) %>%
  unite(
    col = Variety,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  separate(
    col = Variety,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  '-'
  ) %>%
  unite(
    col = Variety,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  separate(
    col = Variety_2,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  ' '
  ) %>%
  unite(
    col = Variety_2,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  inner_join(y = Pob_mej, by = 'Variety') %>%
  select(Variety_2, Fen_escalado) %>% # Se creo el conjunto de datos con los individuos mejorados de la población indica.
  rename(Variety = Variety_2)

Pob_IND_2 <- Pob_IND %>%
  left_join(y = famsnps_IND, by = 'Variety') # Se unen al conjunto de datos famsnps_IND debido a que aquí esta la identificación numérica como esta en el pedigrí.

## 1. Subpoblación con 148 individuos genotipados

load(here('Datos', 'Datos_IND', 'Den_10.000', 'mod_BGLR', 'Ped_2', 'mod_BGLR_1', 'mod_BGLR_1.RData'))

Pred_IND_5 <- mod_IND_1$yHat %>%
  as_tibble() %>%
  mutate(Subpoblación = '148') %>%
  rowid_to_column(var = 'id') %>%
  right_join(y = Pob_IND_2, by = 'id')  %>%
  rename(
    'Fenotipo_predicho' = value,
    'Fenotipo_observado' = Fen_escalado
    )

## 2. Subpoblación con 298 individuos genotipados

load(here('Datos', 'Datos_IND', 'Den_10.000', 'mod_BGLR', 'Ped_2', 'mod_BGLR_2', 'mod_BGLR_2.RData'))

Pred_IND_6 <- mod_IND_2$yHat %>%
  as_tibble() %>%
  mutate(Subpoblación = '298') %>%
  rowid_to_column(var = 'id') %>%
  right_join(y = Pob_IND_2, by = 'id')  %>%
  rename(
    'Fenotipo_predicho' = value,
    'Fenotipo_observado' = Fen_escalado
    )

## 3. Subpoblación con 451 individuos genotipados

load(here('Datos', 'Datos_IND', 'Den_10.000', 'mod_BGLR', 'Ped_2', 'mod_BGLR_3', 'mod_BGLR_3.RData'))

Pred_IND_7 <- mod_IND_3$yHat %>%
  as_tibble() %>%
  mutate(Subpoblación = '451') %>%
  rowid_to_column(var = 'id') %>%
  right_join(y = Pob_IND_2, by = 'id')  %>%
  rename(
    'Fenotipo_predicho' = value,
    'Fenotipo_observado' = Fen_escalado
    )

## 4. Subpoblación con ningún individuo genotipado

load(here('Datos', 'Datos_IND', 'Den_100.000_b', 'mod_BGLR', 'Ped_2', 'mod_BGLR_4', 'mod_BGLR_4.RData'))

Pred_IND_8 <- mod_IND_4$yHat %>%
  as_tibble() %>%
  mutate(Subpoblación = '0') %>%
  rowid_to_column(var = 'id') %>%
  right_join(y = Pob_IND_2, by = 'id')  %>%
  rename(
    'Fenotipo_predicho' = value,
    'Fenotipo_observado' = Fen_escalado
    )

# 4. Se unen todos los datos anteriores de las distintas subpoblaciones de individuos genotipados en un solo conjunto de datos.

Pred_IND_b <- bind_rows(Pred_IND_5, Pred_IND_6, Pred_IND_7, Pred_IND_8) %>%
  arrange(id) %>%
  relocate(
    Variety,
    .after = id
  ) %>%
  relocate(
    Fenotipo_predicho,
    .after = Fenotipo_observado
  ) %>%
  mutate(Pedigrí = '2')

#######################################################
# Gráfico de dispersión de los resultados del pedigrí 2
#######################################################

Graf_disp_IND <- function(Subpoblación) {
  Pred_IND_b %>%
    filter(.data$Subpoblación == .env$Subpoblación) %>%
    ggplot() +
    aes(x = Fenotipo_observado, y = Fenotipo_predicho) +
    geom_point(size = 4.4, colour = 'cyan', alpha = 0.6) +
    geom_smooth(color = 'cyan', fill = 'cyan', method = 'lm', se = TRUE) +
    stat_cor(p.accuracy = 0.001, colour = 'gray34', label.x = -1.5, label.y = -1.5) +
    geom_rug(colour = 'gray') +
    scale_x_continuous(labels = label_number(accuracy = 0.01)) +
    scale_y_continuous(labels = label_number(accuracy = 0.01)) +
    ggtitle(glue('Individuos genotipados: {Subpoblación}')) +
    labs(x = 'Fenotipo observado', y = 'Fenotipo predicho') +
    theme_bw() +
    theme(
      axis.text = element_text(size = 14),
      axis.title = element_text(size = 15, face = 'bold'),
      plot.title = element_text(size = 11, face = 'bold'),
      legend.position = 'none'
      )
  }

Subpoblación <- c('0', '148', '298', '451')
Graf <- map(Subpoblación, Graf_disp_IND)
(Graf[[1]] | Graf[[2]] | Graf[[3]] | Graf[[4]]) +
  plot_annotation(title = 'Pedigrí dos')

########################################################
# Pedigrí 3: 1210 individuos simulados en 7 generaciones
########################################################

# 2. Se importa el archivo .fam obtenido usando plink y que posteriomente se uso para crear la hoja de parámetros para ejecutar el software molcoanc.

famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'nSNPs_IND.fam')) %>% 
  select(fam) %>%
  mutate(id = 1211:1661) %>%
  rename(Variety = fam)

# 3. Se crea un conjunto de datos que contiene solo los individuos mejorados.

Pob_mej <- lin_mej %>%
  filter(Status_with_Pedigree.plus.knowledge == 'I') %>% # Conjunto de datos solo con los individuos mejorados (los que se clasificaron como "I").
  select(X3K_DNA_IRIS_UNIQUE_ID) %>%
  rename(Variety = X3K_DNA_IRIS_UNIQUE_ID)

escalado <- function(x) { # Función usada para escalar el fenotipo.
  (x - mean(x, na.rm = TRUE)) / sd(x, na.rm = TRUE)
  }

Pob_IND <- Fenotipos %>%
  filter(SNPsubsp == 'IND') %>% # Conjunto de datos solo con la especie IND.
  mutate(
    Variety_2 = Variety,
    Fen_escalado = escalado(Time.to.flowering..from.sowing)
    ) %>%
  separate(
    col = Variety,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  ' '
  ) %>%
  unite(
    col = Variety,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  separate(
    col = Variety,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  '-'
  ) %>%
  unite(
    col = Variety,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  separate(
    col = Variety_2,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  ' '
  ) %>%
  unite(
    col = Variety_2,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  inner_join(y = Pob_mej, by = 'Variety') %>%
  select(Variety_2, Fen_escalado) %>% # Se creo el conjunto de datos con los individuos mejorados de la población indica.
  rename(Variety = Variety_2)

Pob_IND_2 <- Pob_IND %>%
  left_join(y = famsnps_IND, by = 'Variety') # Se unen al conjunto de datos famsnps_IND debido a que aquí esta la identificación numérica como esta en el pedigrí.

## 1. Subpoblación con 148 individuos genotipados

load(here('Datos', 'Datos_IND', 'Den_10.000', 'mod_BGLR', 'Ped_3', 'mod_BGLR_1', 'mod_BGLR_1.RData'))

Pred_IND_9 <- mod_IND_1$yHat %>%
  as_tibble() %>%
  mutate(Subpoblación = '148') %>%
  rowid_to_column(var = 'id') %>%
  right_join(y = Pob_IND_2, by = 'id')  %>%
  rename(
    'Fenotipo_predicho' = value,
    'Fenotipo_observado' = Fen_escalado
    )

## 2. Subpoblación con 298 individuos genotipados

load(here('Datos', 'Datos_IND', 'Den_10.000', 'mod_BGLR', 'Ped_3', 'mod_BGLR_2', 'mod_BGLR_2.RData'))

Pred_IND_10 <- mod_IND_2$yHat %>%
  as_tibble() %>%
  mutate(Subpoblación = '298') %>%
  rowid_to_column(var = 'id') %>%
  right_join(y = Pob_IND_2, by = 'id')  %>%
  rename(
    'Fenotipo_predicho' = value,
    'Fenotipo_observado' = Fen_escalado
    )

## 3. Subpoblación con 451 individuos genotipados

load(here('Datos', 'Datos_IND', 'Den_10.000', 'mod_BGLR', 'Ped_3', 'mod_BGLR_3', 'mod_BGLR_3.RData'))

Pred_IND_11 <- mod_IND_3$yHat %>%
  as_tibble() %>%
  mutate(Subpoblación = '451') %>%
  rowid_to_column(var = 'id') %>%
  right_join(y = Pob_IND_2, by = 'id')  %>%
  rename(
    'Fenotipo_predicho' = value,
    'Fenotipo_observado' = Fen_escalado
    )

## 4. Subpoblación con ningún individuo genotipado

load(here('Datos', 'Datos_IND', 'Den_100.000_b', 'mod_BGLR', 'Ped_3', 'mod_BGLR_4', 'mod_BGLR_4.RData'))

Pred_IND_12 <- mod_IND_4$yHat %>%
  as_tibble() %>%
  mutate(Subpoblación = '0') %>%
  rowid_to_column(var = 'id') %>%
  right_join(y = Pob_IND_2, by = 'id')  %>%
  rename(
    'Fenotipo_predicho' = value,
    'Fenotipo_observado' = Fen_escalado
    )

# 4. Se unen todos los datos anteriores de las distintas subpoblaciones de individuos. genotipados en un solo conjunto de datos

Pred_IND_c <- bind_rows(Pred_IND_9, Pred_IND_10, Pred_IND_11, Pred_IND_12) %>%
  arrange(id) %>%
  relocate(
    Variety,
    .after = id
  ) %>%
  relocate(
    Fenotipo_predicho,
    .after = Fenotipo_observado
  ) %>%
  mutate(Pedigrí = '3')

#######################################################
# Gráfico de dispersión de los resultados del pedigrí 3
#######################################################

Graf_disp_IND <- function(Subpoblación) {
  Pred_IND_c %>%
    filter(.data$Subpoblación == .env$Subpoblación) %>%
    ggplot() +
    aes(x = Fenotipo_observado, y = Fenotipo_predicho) +
    geom_point(size = 4.4, colour = 'cyan', alpha = 0.6) +
    geom_smooth(color = 'cyan', fill = 'cyan', method = 'lm', se = TRUE) +
    stat_cor(p.accuracy = 0.001, colour = 'gray34', label.x = -1.5, label.y = -1.5) +
    geom_rug(colour = 'gray') +
    scale_x_continuous(labels = label_number(accuracy = 0.01)) +
    scale_y_continuous(labels = label_number(accuracy = 0.01)) +
    ggtitle(glue('Individuos genotipados: {Subpoblación}')) +
    labs(x = 'Fenotipo observado', y = 'Fenotipo predicho') +
    theme_bw() +
    theme(
      axis.text = element_text(size = 14),
      axis.title = element_text(size = 15, face = 'bold'),
      plot.title = element_text(size = 11, face = 'bold'),
      legend.position = 'none'
      )
  }

Subpoblación <- c('0', '148', '298', '451')
Graf <- map(Subpoblación, Graf_disp_IND)
(Graf[[1]] | Graf[[2]] | Graf[[3]] | Graf[[4]]) +
  plot_annotation(title = 'Pedigrí dos') # Aquí se coloco pedigrí dos pero en realidad es el pedigrí tres.

#######################################################
# Pedigrí 4: 300 individuos simulados en 3 generaciones
#######################################################

# 2. Se importa el archivo .fam obtenido usando plink y que posteriomente se uso para crear la hoja de parámetros para ejecutar el software molcoanc.

famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'nSNPs_IND.fam')) %>% 
  select(fam) %>%
  mutate(id = 301:751) %>%
  rename(Variety = fam)

# 3. Se crea un conjunto de datos que contiene solo los individuos mejorados.

Pob_mej <- lin_mej %>%
  filter(Status_with_Pedigree.plus.knowledge == 'I') %>% # Conjunto de datos solo con los individuos mejorados (los que se clasificaron como "I").
  select(X3K_DNA_IRIS_UNIQUE_ID) %>%
  rename(Variety = X3K_DNA_IRIS_UNIQUE_ID)

escalado <- function(x) { # Función usada para escalar el fenotipo.
  (x - mean(x, na.rm = TRUE)) / sd(x, na.rm = TRUE)
  }

Pob_IND <- Fenotipos %>%
  filter(SNPsubsp == 'IND') %>% # Conjunto de datos solo con la especie IND.
  mutate(
    Variety_2 = Variety,
    Fen_escalado = escalado(Time.to.flowering..from.sowing)
    ) %>%
  separate(
    col = Variety,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  ' '
  ) %>%
  unite(
    col = Variety,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  separate(
    col = Variety,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  '-'
  ) %>%
  unite(
    col = Variety,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  separate(
    col = Variety_2,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  ' '
  ) %>%
  unite(
    col = Variety_2,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  inner_join(y = Pob_mej, by = 'Variety') %>%
  select(Variety_2, Fen_escalado) %>% # Se creo el conjunto de datos con los individuos mejorados de la población indica.
  rename(Variety = Variety_2)

Pob_IND_2 <- Pob_IND %>%
  left_join(y = famsnps_IND, by = 'Variety') # Se unen al conjunto de datos famsnps_IND debido a que aquí esta la identificación numérica como esta en el pedigrí.

## 1. Subpoblación con 148 individuos genotipados

load(here('Datos', 'Datos_IND', 'Den_10.000', 'mod_BGLR', 'Ped_4', 'mod_BGLR_1', 'mod_BGLR_1.RData'))

Pred_IND_13 <- mod_IND_1$yHat %>%
  as_tibble() %>%
  mutate(Subpoblación = '148') %>%
  rowid_to_column(var = 'id') %>%
  right_join(y = Pob_IND_2, by = 'id')  %>%
  rename(
    'Fenotipo_predicho' = value,
    'Fenotipo_observado' = Fen_escalado
    )

## 2. Subpoblación con 298 individuos genotipados

load(here('Datos', 'Datos_IND', 'Den_10.000', 'mod_BGLR', 'Ped_4', 'mod_BGLR_2', 'mod_BGLR_2.RData'))

Pred_IND_14 <- mod_IND_2$yHat %>%
  as_tibble() %>%
  mutate(Subpoblación = '298') %>%
  rowid_to_column(var = 'id') %>%
  right_join(y = Pob_IND_2, by = 'id')  %>%
  rename(
    'Fenotipo_predicho' = value,
    'Fenotipo_observado' = Fen_escalado
    )

## 3. Subpoblación con 451 individuos genotipados

load(here('Datos', 'Datos_IND', 'Den_10.000', 'mod_BGLR', 'Ped_4', 'mod_BGLR_3', 'mod_BGLR_3.RData'))

Pred_IND_15 <- mod_IND_3$yHat %>%
  as_tibble() %>%
  mutate(Subpoblación = '451') %>%
  rowid_to_column(var = 'id') %>%
  right_join(y = Pob_IND_2, by = 'id')  %>%
  rename(
    'Fenotipo_predicho' = value,
    'Fenotipo_observado' = Fen_escalado
    )

## 4. Subpoblación con ningún individuo genotipado

load(here('Datos', 'Datos_IND', 'Den_100.000_b', 'mod_BGLR', 'Ped_4', 'mod_BGLR_4', 'mod_BGLR_4.RData'))

Pred_IND_16 <- mod_IND_4$yHat %>%
  as_tibble() %>%
  mutate(Subpoblación = '0') %>%
  rowid_to_column(var = 'id') %>%
  right_join(y = Pob_IND_2, by = 'id')  %>%
  rename(
    'Fenotipo_predicho' = value,
    'Fenotipo_observado' = Fen_escalado
    )

# 4. Se unen todos los datos anteriores de las distintas subpoblaciones de individuos. genotipados en un solo conjunto de datos

Pred_IND_d <- bind_rows(Pred_IND_13, Pred_IND_14, Pred_IND_15, Pred_IND_16) %>%
  arrange(id) %>%
  relocate(
    Variety,
    .after = id
  ) %>%
  relocate(
    Fenotipo_predicho,
    .after = Fenotipo_observado
  ) %>%
  mutate(Pedigrí = '1')

#######################################################
# Gráfico de dispersión de los resultados del pedigrí 4
#######################################################

Graf_disp_IND <- function(Subpoblación) {
  Pred_IND_d %>%
    filter(.data$Subpoblación == .env$Subpoblación) %>%
    ggplot() +
    aes(x = Fenotipo_observado, y = Fenotipo_predicho) +
    geom_point(size = 4.4, colour = 'cyan', alpha = 0.6) +
    geom_smooth(color = 'cyan', fill = 'cyan', method = 'lm', se = TRUE) +
    stat_cor(p.accuracy = 0.001, colour = 'gray34', label.x = -1.5, label.y = -1.5) +
    geom_rug(colour = 'gray') +
    scale_x_continuous(labels = label_number(accuracy = 0.01)) +
    scale_y_continuous(labels = label_number(accuracy = 0.01)) +
    ggtitle(glue('Individuos genotipados: {Subpoblación}')) +
    labs(x = 'Fenotipo observado', y = 'Fenotipo predicho') +
    theme_bw() +
    theme(
      axis.text = element_text(size = 14),
      axis.title = element_text(size = 15, face = 'bold'),
      plot.title = element_text(size = 11, face = 'bold'),
      legend.position = 'none'
      )
  }

Subpoblación <- c('0', '148', '298', '451')
Graf <- map(Subpoblación, Graf_disp_IND)
(Graf[[1]] | Graf[[2]] | Graf[[3]] | Graf[[4]]) +
  plot_annotation(title = 'Pedigrí uno')

########################################################
# Pedigrí 5: 1530 individuos simulados en 9 generaciones
########################################################

# 2. Se importa el archivo .fam obtenido usando plink y que posteriomente se uso para crear la hoja de parámetros para ejecutar el software molcoanc.

famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'nSNPs_IND.fam')) %>% 
  select(fam) %>%
  mutate(id = 1531:1981) %>%
  rename(Variety = fam)

# 3. Se crea un conjunto de datos que contiene solo los individuos mejorados.

Pob_mej <- lin_mej %>%
  filter(Status_with_Pedigree.plus.knowledge == 'I') %>% # Conjunto de datos solo con los individuos mejorados (los que se clasificaron como "I").
  select(X3K_DNA_IRIS_UNIQUE_ID) %>%
  rename(Variety = X3K_DNA_IRIS_UNIQUE_ID)

escalado <- function(x) { # Función usada para escalar el fenotipo.
  (x - mean(x, na.rm = TRUE)) / sd(x, na.rm = TRUE)
}

Pob_IND <- Fenotipos %>%
  filter(SNPsubsp == 'IND') %>% # Conjunto de datos solo con la especie IND.
  mutate(
    Variety_2 = Variety,
    Fen_escalado = escalado(Time.to.flowering..from.sowing)
    ) %>%
  separate(
    col = Variety,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  ' '
  ) %>%
  unite(
    col = Variety,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  separate(
    col = Variety,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  '-'
  ) %>%
  unite(
    col = Variety,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  separate(
    col = Variety_2,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  ' '
  ) %>%
  unite(
    col = Variety_2,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  inner_join(y = Pob_mej, by = 'Variety') %>%
  select(Variety_2, Fen_escalado) %>% # Se creo el conjunto de datos con los individuos mejorados de la población indica.
  rename(Variety = Variety_2)

Pob_IND_2 <- Pob_IND %>%
  left_join(y = famsnps_IND, by = 'Variety') # Se unen al conjunto de datos famsnps_IND debido a que aquí esta la identificación numérica como esta en el pedigrí.

## 1. Subpoblación con 148 individuos genotipados

load(here('Datos', 'Datos_IND', 'Den_10.000', 'mod_BGLR', 'Ped_5', 'mod_BGLR_1', 'mod_BGLR_1.RData'))

Pred_IND_17 <- mod_IND_1$yHat %>%
  as_tibble() %>%
  mutate(Subpoblación = '148') %>%
  rowid_to_column(var = 'id') %>%
  right_join(y = Pob_IND_2, by = 'id')  %>%
  rename(
    'Fenotipo_predicho' = value,
    'Fenotipo_observado' = Fen_escalado
    )

## 2. Subpoblación con 298 individuos genotipados

load(here('Datos', 'Datos_IND', 'Den_10.000', 'mod_BGLR', 'Ped_5', 'mod_BGLR_2', 'mod_BGLR_2.RData'))

Pred_IND_18 <- mod_IND_2$yHat %>%
  as_tibble() %>%
  mutate(Subpoblación = '298') %>%
  rowid_to_column(var = 'id') %>%
  right_join(y = Pob_IND_2, by = 'id')  %>%
  rename(
    'Fenotipo_predicho' = value,
    'Fenotipo_observado' = Fen_escalado
    )

## 3. Subpoblación con 451 individuos genotipados

load(here('Datos', 'Datos_IND', 'Den_10.000', 'mod_BGLR', 'Ped_5', 'mod_BGLR_3', 'mod_BGLR_3.RData'))

Pred_IND_19 <- mod_IND_3$yHat %>%
  as_tibble() %>%
  mutate(Subpoblación = '451') %>%
  rowid_to_column(var = 'id') %>%
  right_join(y = Pob_IND_2, by = 'id')  %>%
  rename(
    'Fenotipo_predicho' = value,
    'Fenotipo_observado' = Fen_escalado
    )

## 4. Subpoblación con ningún individuo genotipado

load(here('Datos', 'Datos_IND', 'Den_100.000_b', 'mod_BGLR', 'Ped_5', 'mod_BGLR_4', 'mod_BGLR_4.RData'))

Pred_IND_20 <- mod_IND_4$yHat %>%
  as_tibble() %>%
  mutate(Subpoblación = '0') %>%
  rowid_to_column(var = 'id') %>%
  right_join(y = Pob_IND_2, by = 'id')  %>%
  rename(
    'Fenotipo_predicho' = value,
    'Fenotipo_observado' = Fen_escalado
    )

# 4. Se unen todos los datos anteriores de las distintas subpoblaciones de individuos. genotipados en un solo conjunto de datos

Pred_IND_e <- bind_rows(Pred_IND_17, Pred_IND_18, Pred_IND_19, Pred_IND_20) %>%
  arrange(id) %>%
  relocate(
    Variety,
    .after = id
  ) %>%
  relocate(
    Fenotipo_predicho,
    .after = Fenotipo_observado
  ) %>%
  mutate(Pedigrí = '4')

#######################################################
# Gráfico de dispersión de los resultados del pedigrí 5
#######################################################

Graf_disp_IND <- function(Subpoblación) {
  Pred_IND_e %>%
    filter(.data$Subpoblación == .env$Subpoblación) %>%
    ggplot() +
    aes(x = Fenotipo_observado, y = Fenotipo_predicho) +
    geom_point(size = 4.4, colour = 'cyan', alpha = 0.6) +
    geom_smooth(color = 'cyan', fill = 'cyan', method = 'lm', se = TRUE) +
    stat_cor(p.accuracy = 0.001, colour = 'gray34', label.x = -1.5, label.y = -1.5) +
    geom_rug(colour = 'gray') +
    scale_x_continuous(labels = label_number(accuracy = 0.01)) +
    scale_y_continuous(labels = label_number(accuracy = 0.01)) +
    ggtitle(glue('Individuos genotipados: {Subpoblación}')) +
    labs(x = 'Fenotipo observado', y = 'Fenotipo predicho') +
    theme_bw() +
    theme(
      axis.text = element_text(size = 14),
      axis.title = element_text(size = 15, face = 'bold'),
      plot.title = element_text(size = 11, face = 'bold'),
      legend.position = 'none'
      )
  }

Subpoblación <- c('0', '148', '298', '451')
Graf <- map(Subpoblación, Graf_disp_IND)
(Graf[[1]] | Graf[[2]] | Graf[[3]] | Graf[[4]]) +
  plot_annotation(title = 'Pedigrí cuatro')

#### Población de arroz IND (1.000 SNPs) ----

#########################################################
# Pedigrí 1: 2000 individuos simulados en 10 generaciones
#########################################################

# 2. Se importa el archivo .fam obtenido usando plink y que posteriomente se uso para crear la hoja de parámetros para ejecutar el software molcoanc.

famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'nSNPs_IND.fam')) %>% 
  select(fam) %>%
  mutate(id = 2001:2451) %>%
  rename(Variety = fam)

# 3. Se crea un conjunto de datos que contiene solo los individuos mejorados.

Pob_mej <- lin_mej %>%
  filter(Status_with_Pedigree.plus.knowledge == 'I') %>% # Conjunto de datos solo con los individuos mejorados (los que se clasificaron como "I").
  select(X3K_DNA_IRIS_UNIQUE_ID) %>%
  rename(Variety = X3K_DNA_IRIS_UNIQUE_ID)

escalado <- function(x) { # Función usada para escalar el fenotipo.
  (x - mean(x, na.rm = TRUE)) / sd(x, na.rm = TRUE)
  }

Pob_IND <- Fenotipos %>%
  filter(SNPsubsp == 'IND') %>% # Conjunto de datos solo con la especie IND.
  mutate(
    Variety_2 = Variety,
    Fen_escalado = escalado(Time.to.flowering..from.sowing)
    ) %>%
  separate(
    col = Variety,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  ' '
  ) %>%
  unite(
    col = Variety,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  separate(
    col = Variety,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  '-'
  ) %>%
  unite(
    col = Variety,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  separate(
    col = Variety_2,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  ' '
  ) %>%
  unite(
    col = Variety_2,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  inner_join(y = Pob_mej, by = 'Variety') %>%
  select(Variety_2, Fen_escalado) %>% # Se creo el conjunto de datos con los individuos mejorados de la población indica.
  rename(Variety = Variety_2)

Pob_IND_2 <- Pob_IND %>%
  left_join(y = famsnps_IND, by = 'Variety') # Se unen al conjunto de datos famsnps_IND debido a que aquí esta la identificación numérica como esta en el pedigrí.

## 1. Subpoblación con 148 individuos genotipados

load(here('Datos', 'Datos_IND', 'Den_1.000', 'mod_BGLR', 'Ped_1', 'mod_BGLR_1', 'mod_BGLR_1.RData'))

Pred_IND_1 <- mod_IND_1$yHat %>%
  as_tibble() %>%
  mutate(Subpoblación = '148') %>%
  rowid_to_column(var = 'id') %>%
  right_join(y = Pob_IND_2, by = 'id')  %>%
  rename(
    'Fenotipo_predicho' = value,
    'Fenotipo_observado' = Fen_escalado
    )

## 2. Subpoblación con 298 individuos genotipados

load(here('Datos', 'Datos_IND', 'Den_1.000', 'mod_BGLR', 'Ped_1', 'mod_BGLR_2', 'mod_BGLR_2.RData'))

Pred_IND_2 <- mod_IND_2$yHat %>%
  as_tibble() %>%
  mutate(Subpoblación = '298') %>%
  rowid_to_column(var = 'id') %>%
  right_join(y = Pob_IND_2, by = 'id')  %>%
  rename(
    'Fenotipo_predicho' = value,
    'Fenotipo_observado' = Fen_escalado
    )

## 3. Subpoblación con 451 individuos genotipados

load(here('Datos', 'Datos_IND', 'Den_1.000', 'mod_BGLR', 'Ped_1', 'mod_BGLR_3', 'mod_BGLR_3.RData'))

Pred_IND_3 <- mod_IND_3$yHat %>%
  as_tibble() %>%
  mutate(Subpoblación = '451') %>%
  rowid_to_column(var = 'id') %>%
  right_join(y = Pob_IND_2, by = 'id')  %>%
  rename(
    'Fenotipo_predicho' = value,
    'Fenotipo_observado' = Fen_escalado
    )

## 4. Subpoblación con ningún individuo genotipado

load(here('Datos', 'Datos_IND', 'Den_100.000_b', 'mod_BGLR', 'Ped_1', 'mod_BGLR_4', 'mod_BGLR_4.RData'))

Pred_IND_4 <- mod_IND_4$yHat %>%
  as_tibble() %>%
  mutate(Subpoblación = '0') %>%
  rowid_to_column(var = 'id') %>%
  right_join(y = Pob_IND_2, by = 'id')  %>%
  rename(
    'Fenotipo_predicho' = value,
    'Fenotipo_observado' = Fen_escalado
    )


# 4. Se unen todos los datos anteriores de las distintas subpoblaciones de individuos. genotipados en un solo conjunto de datos

Pred_IND_a <- bind_rows(Pred_IND_1, Pred_IND_2, Pred_IND_3, Pred_IND_4) %>%
  arrange(id) %>%
  relocate(
    Variety,
    .after = id
    ) %>%
  relocate(
    Fenotipo_predicho,
    .after = Fenotipo_observado
    ) %>%
  mutate(Pedigrí = '5')

#######################################################
# Gráfico de dispersión de los resultados del pedigrí 1
#######################################################

Graf_disp_IND <- function(Subpoblación) {
  Pred_IND_a %>%
    filter(.data$Subpoblación == .env$Subpoblación) %>%
    ggplot() +
    aes(x = Fenotipo_observado, y = Fenotipo_predicho) +
    geom_point(size = 4.4, colour = 'red', alpha = 0.6) +
    geom_smooth(color = 'red', fill = 'red', method = 'lm', se = TRUE) +
    stat_cor(p.accuracy = 0.001, colour = 'gray34', label.x = -1.5, label.y = -1.5) +
    geom_rug(colour = 'gray') +
    scale_x_continuous(labels = label_number(accuracy = 0.01)) +
    scale_y_continuous(labels = label_number(accuracy = 0.01)) +
    ggtitle(glue('Individuos genotipados: {Subpoblación}')) +
    labs(x = 'Fenotipo observado', y = 'Fenotipo predicho') +
    theme_bw() +
    theme(
      axis.text = element_text(size = 14),
      axis.title = element_text(size = 15, face = 'bold'),
      plot.title = element_text(size = 11, face = 'bold'),
      legend.position = 'none'
      )
  }

Subpoblación <- c('0', '148', '298', '451')
Graf <- map(Subpoblación, Graf_disp_IND)
(Graf[[1]] | Graf[[2]] | Graf[[3]] | Graf[[4]]) +
  plot_annotation(title = 'Pedigrí tres') # Aquí se coloco pedigrí tres pero en realidad es el pedigrí cinco.

#######################################################
# Pedigrí 2: 520 individuos simulados en 4 generaciones
#######################################################

# 2. Se importa el archivo .fam obtenido usando plink y que posteriomente se uso para crear la hoja de parámetros para ejecutar el software molcoanc.

famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'nSNPs_IND.fam')) %>% 
  select(fam) %>%
  mutate(id = 521:971) %>%
  rename(Variety = fam)

# 3. Se crea un conjunto de datos que contiene solo los individuos mejorados.

Pob_mej <- lin_mej %>%
  filter(Status_with_Pedigree.plus.knowledge == 'I') %>% # Conjunto de datos solo con los individuos mejorados (los que se clasificaron como "I").
  select(X3K_DNA_IRIS_UNIQUE_ID) %>%
  rename(Variety = X3K_DNA_IRIS_UNIQUE_ID)

escalado <- function(x) { # Función usada para escalar el fenotipo.
  (x - mean(x, na.rm = TRUE)) / sd(x, na.rm = TRUE)
  }

Pob_IND <- Fenotipos %>%
  filter(SNPsubsp == 'IND') %>% # Conjunto de datos solo con la especie IND.
  mutate(
    Variety_2 = Variety,
    Fen_escalado = escalado(Time.to.flowering..from.sowing)
    ) %>%
  separate(
    col = Variety,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  ' '
  ) %>%
  unite(
    col = Variety,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  separate(
    col = Variety,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  '-'
  ) %>%
  unite(
    col = Variety,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  separate(
    col = Variety_2,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  ' '
  ) %>%
  unite(
    col = Variety_2,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  inner_join(y = Pob_mej, by = 'Variety') %>%
  select(Variety_2, Fen_escalado) %>% # Se creo el conjunto de datos con los individuos mejorados de la población indica.
  rename(Variety = Variety_2)

Pob_IND_2 <- Pob_IND %>%
  left_join(y = famsnps_IND, by = 'Variety') # Se unen al conjunto de datos famsnps_IND debido a que aquí esta la identificación numérica como esta en el pedigrí.

## 1. Subpoblación con 148 individuos genotipados

load(here('Datos', 'Datos_IND', 'Den_1.000', 'mod_BGLR', 'Ped_2', 'mod_BGLR_1', 'mod_BGLR_1.RData'))

Pred_IND_5 <- mod_IND_1$yHat %>%
  as_tibble() %>%
  mutate(Subpoblación = '148') %>%
  rowid_to_column(var = 'id') %>%
  right_join(y = Pob_IND_2, by = 'id')  %>%
  rename(
    'Fenotipo_predicho' = value,
    'Fenotipo_observado' = Fen_escalado
    )

## 2. Subpoblación con 298 individuos genotipados

load(here('Datos', 'Datos_IND', 'Den_1.000', 'mod_BGLR', 'Ped_2', 'mod_BGLR_2', 'mod_BGLR_2.RData'))

Pred_IND_6 <- mod_IND_2$yHat %>%
  as_tibble() %>%
  mutate(Subpoblación = '298') %>%
  rowid_to_column(var = 'id') %>%
  right_join(y = Pob_IND_2, by = 'id')  %>%
  rename(
    'Fenotipo_predicho' = value,
    'Fenotipo_observado' = Fen_escalado
    )

## 3. Subpoblación con 451 individuos genotipados

load(here('Datos', 'Datos_IND', 'Den_1.000', 'mod_BGLR', 'Ped_2', 'mod_BGLR_3', 'mod_BGLR_3.RData'))

Pred_IND_7 <- mod_IND_3$yHat %>%
  as_tibble() %>%
  mutate(Subpoblación = '451') %>%
  rowid_to_column(var = 'id') %>%
  right_join(y = Pob_IND_2, by = 'id')  %>%
  rename(
    'Fenotipo_predicho' = value,
    'Fenotipo_observado' = Fen_escalado
    )

## 4. Subpoblación con ningún individuo genotipado

load(here('Datos', 'Datos_IND', 'Den_100.000_b', 'mod_BGLR', 'Ped_2', 'mod_BGLR_4', 'mod_BGLR_4.RData'))

Pred_IND_8 <- mod_IND_4$yHat %>%
  as_tibble() %>%
  mutate(Subpoblación = '0') %>%
  rowid_to_column(var = 'id') %>%
  right_join(y = Pob_IND_2, by = 'id')  %>%
  rename(
    'Fenotipo_predicho' = value,
    'Fenotipo_observado' = Fen_escalado
    )

# 4. Se unen todos los datos anteriores de las distintas subpoblaciones de individuos genotipados en un solo conjunto de datos.

Pred_IND_b <- bind_rows(Pred_IND_5, Pred_IND_6, Pred_IND_7, Pred_IND_8) %>%
  arrange(id) %>%
  relocate(
    Variety,
    .after = id
  ) %>%
  relocate(
    Fenotipo_predicho,
    .after = Fenotipo_observado
  ) %>%
  mutate(Pedigrí = '2')


#######################################################
# Gráfico de dispersión de los resultados del pedigrí 2
#######################################################

Graf_disp_IND <- function(Subpoblación) {
  Pred_IND_b %>%
    filter(.data$Subpoblación == .env$Subpoblación) %>%
    ggplot() +
    aes(x = Fenotipo_observado, y = Fenotipo_predicho) +
    geom_point(size = 4.4, colour = 'red', alpha = 0.6) +
    geom_smooth(color = 'red', fill = 'red', method = 'lm', se = TRUE) +
    stat_cor(p.accuracy = 0.001, colour = 'gray34', label.x = -1.5, label.y = -1.5) +
    geom_rug(colour = 'gray') +
    scale_x_continuous(labels = label_number(accuracy = 0.01)) +
    scale_y_continuous(labels = label_number(accuracy = 0.01)) +
    ggtitle(glue('Individuos genotipados: {Subpoblación}')) +
    labs(x = 'Fenotipo observado', y = 'Fenotipo predicho') +
    theme_bw() +
    theme(
      axis.text = element_text(size = 14),
      axis.title = element_text(size = 15, face = 'bold'),
      plot.title = element_text(size = 11, face = 'bold'),
      legend.position = 'none'
      )
  }

Subpoblación <- c('0', '148', '298', '451')
Graf <- map(Subpoblación, Graf_disp_IND)
(Graf[[1]] | Graf[[2]] | Graf[[3]] | Graf[[4]]) +
  plot_annotation(title = 'Pedigrí dos')

########################################################
# Pedigrí 3: 1210 individuos simulados en 7 generaciones
########################################################

# 2. Se importa el archivo .fam obtenido usando plink y que posteriomente se uso para crear la hoja de parámetros para ejecutar el software molcoanc.

famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'nSNPs_IND.fam')) %>% 
  select(fam) %>%
  mutate(id = 1211:1661) %>%
  rename(Variety = fam)

# 3. Se crea un conjunto de datos que contiene solo los individuos mejorados.

Pob_mej <- lin_mej %>%
  filter(Status_with_Pedigree.plus.knowledge == 'I') %>% # Conjunto de datos solo con los individuos mejorados (los que se clasificaron como "I").
  select(X3K_DNA_IRIS_UNIQUE_ID) %>%
  rename(Variety = X3K_DNA_IRIS_UNIQUE_ID)

escalado <- function(x) { # Función usada para escalar el fenotipo.
  (x - mean(x, na.rm = TRUE)) / sd(x, na.rm = TRUE)
  }

Pob_IND <- Fenotipos %>%
  filter(SNPsubsp == 'IND') %>% # Conjunto de datos solo con la especie IND.
  mutate(
    Variety_2 = Variety,
    Fen_escalado = escalado(Time.to.flowering..from.sowing)
    ) %>%
  separate(
    col = Variety,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  ' '
  ) %>%
  unite(
    col = Variety,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  separate(
    col = Variety,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  '-'
  ) %>%
  unite(
    col = Variety,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  separate(
    col = Variety_2,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  ' '
  ) %>%
  unite(
    col = Variety_2,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  inner_join(y = Pob_mej, by = 'Variety') %>%
  select(Variety_2, Fen_escalado) %>% # Se creo el conjunto de datos con los individuos mejorados de la población indica.
  rename(Variety = Variety_2)

Pob_IND_2 <- Pob_IND %>%
  left_join(y = famsnps_IND, by = 'Variety') # Se unen al conjunto de datos famsnps_IND debido a que aquí esta la identificación numérica como esta en el pedigrí.

## 1. Subpoblación con 148 individuos genotipados

load(here('Datos', 'Datos_IND', 'Den_1.000', 'mod_BGLR', 'Ped_3', 'mod_BGLR_1', 'mod_BGLR_1.RData'))

Pred_IND_9 <- mod_IND_1$yHat %>%
  as_tibble() %>%
  mutate(Subpoblación = '148') %>%
  rowid_to_column(var = 'id') %>%
  right_join(y = Pob_IND_2, by = 'id')  %>%
  rename(
    'Fenotipo_predicho' = value,
    'Fenotipo_observado' = Fen_escalado
    )

## 2. Subpoblación con 298 individuos genotipados

load(here('Datos', 'Datos_IND', 'Den_1.000', 'mod_BGLR', 'Ped_3', 'mod_BGLR_2', 'mod_BGLR_2.RData'))

Pred_IND_10 <- mod_IND_2$yHat %>%
  as_tibble() %>%
  mutate(Subpoblación = '298') %>%
  rowid_to_column(var = 'id') %>%
  right_join(y = Pob_IND_2, by = 'id')  %>%
  rename(
    'Fenotipo_predicho' = value,
    'Fenotipo_observado' = Fen_escalado
    )

## 3. Subpoblación con 451 individuos genotipados

load(here('Datos', 'Datos_IND', 'Den_1.000', 'mod_BGLR', 'Ped_3', 'mod_BGLR_3', 'mod_BGLR_3.RData'))

Pred_IND_11 <- mod_IND_3$yHat %>%
  as_tibble() %>%
  mutate(Subpoblación = '451') %>%
  rowid_to_column(var = 'id') %>%
  right_join(y = Pob_IND_2, by = 'id')  %>%
  rename(
    'Fenotipo_predicho' = value,
    'Fenotipo_observado' = Fen_escalado
    )

## 4. Subpoblación con ningún individuo genotipado

load(here('Datos', 'Datos_IND', 'Den_100.000_b', 'mod_BGLR', 'Ped_3', 'mod_BGLR_4', 'mod_BGLR_4.RData'))

Pred_IND_12 <- mod_IND_4$yHat %>%
  as_tibble() %>%
  mutate(Subpoblación = '0') %>%
  rowid_to_column(var = 'id') %>%
  right_join(y = Pob_IND_2, by = 'id')  %>%
  rename(
    'Fenotipo_predicho' = value,
    'Fenotipo_observado' = Fen_escalado
    )

# 4. Se unen todos los datos anteriores de las distintas subpoblaciones de individuos. genotipados en un solo conjunto de datos

Pred_IND_c <- bind_rows(Pred_IND_9, Pred_IND_10, Pred_IND_11, Pred_IND_12) %>%
  arrange(id) %>%
  relocate(
    Variety,
    .after = id
  ) %>%
  relocate(
    Fenotipo_predicho,
    .after = Fenotipo_observado
  ) %>%
  mutate(Pedigrí = '3')

#######################################################
# Gráfico de dispersión de los resultados del pedigrí 3
#######################################################

Graf_disp_IND <- function(Subpoblación) {
  Pred_IND_c %>%
    filter(.data$Subpoblación == .env$Subpoblación) %>%
    ggplot() +
    aes(x = Fenotipo_observado, y = Fenotipo_predicho) +
    geom_point(size = 4.4, colour = 'red', alpha = 0.6) +
    geom_smooth(color = 'red', fill = 'red', method = 'lm', se = TRUE) +
    stat_cor(p.accuracy = 0.001, colour = 'gray34', label.x = -1.5, label.y = -1.5) +
    geom_rug(colour = 'gray') +
    scale_x_continuous(labels = label_number(accuracy = 0.01)) +
    scale_y_continuous(labels = label_number(accuracy = 0.01)) +
    ggtitle(glue('Individuos genotipados: {Subpoblación}')) +
    labs(x = 'Fenotipo observado', y = 'Fenotipo predicho') +
    theme_bw() +
    theme(
      axis.text = element_text(size = 14),
      axis.title = element_text(size = 15, face = 'bold'),
      plot.title = element_text(size = 11, face = 'bold'),
      legend.position = 'none'
      )
  }

Subpoblación <- c('0', '148', '298', '451')
Graf <- map(Subpoblación, Graf_disp_IND)
(Graf[[1]] | Graf[[2]] | Graf[[3]] | Graf[[4]]) +
  plot_annotation(title = 'Pedigrí dos') # Aquí se coloco pedigrí dos pero en realidad es el pedigrí tres.

#######################################################
# Pedigrí 4: 300 individuos simulados en 3 generaciones
#######################################################

# 2. Se importa el archivo .fam obtenido usando plink y que posteriomente se uso para crear la hoja de parámetros para ejecutar el software molcoanc.

famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'nSNPs_IND.fam')) %>% 
  select(fam) %>%
  mutate(id = 301:751) %>%
  rename(Variety = fam)

# 3. Se crea un conjunto de datos que contiene solo los individuos mejorados.

Pob_mej <- lin_mej %>%
  filter(Status_with_Pedigree.plus.knowledge == 'I') %>% # Conjunto de datos solo con los individuos mejorados (los que se clasificaron como "I").
  select(X3K_DNA_IRIS_UNIQUE_ID) %>%
  rename(Variety = X3K_DNA_IRIS_UNIQUE_ID)

escalado <- function(x) { # Función usada para escalar el fenotipo.
  (x - mean(x, na.rm = TRUE)) / sd(x, na.rm = TRUE)
  }

Pob_IND <- Fenotipos %>%
  filter(SNPsubsp == 'IND') %>% # Conjunto de datos solo con la especie IND.
  mutate(
    Variety_2 = Variety,
    Fen_escalado = escalado(Time.to.flowering..from.sowing)
    ) %>%
  separate(
    col = Variety,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  ' '
  ) %>%
  unite(
    col = Variety,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  separate(
    col = Variety,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  '-'
  ) %>%
  unite(
    col = Variety,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  separate(
    col = Variety_2,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  ' '
  ) %>%
  unite(
    col = Variety_2,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  inner_join(y = Pob_mej, by = 'Variety') %>%
  select(Variety_2, Fen_escalado) %>% # Se creo el conjunto de datos con los individuos mejorados de la población indica.
  rename(Variety = Variety_2)

Pob_IND_2 <- Pob_IND %>%
  left_join(y = famsnps_IND, by = 'Variety') # Se unen al conjunto de datos famsnps_IND debido a que aquí esta la identificación numérica como esta en el pedigrí.

## 1. Subpoblación con 148 individuos genotipados

load(here('Datos', 'Datos_IND', 'Den_1.000', 'mod_BGLR', 'Ped_4', 'mod_BGLR_1', 'mod_BGLR_1.RData'))

Pred_IND_13 <- mod_IND_1$yHat %>%
  as_tibble() %>%
  mutate(Subpoblación = '148') %>%
  rowid_to_column(var = 'id') %>%
  right_join(y = Pob_IND_2, by = 'id')  %>%
  rename(
    'Fenotipo_predicho' = value,
    'Fenotipo_observado' = Fen_escalado
    )

## 2. Subpoblación con 298 individuos genotipados

load(here('Datos', 'Datos_IND', 'Den_1.000', 'mod_BGLR', 'Ped_4', 'mod_BGLR_2', 'mod_BGLR_2.RData'))

Pred_IND_14 <- mod_IND_2$yHat %>%
  as_tibble() %>%
  mutate(Subpoblación = '298') %>%
  rowid_to_column(var = 'id') %>%
  right_join(y = Pob_IND_2, by = 'id')  %>%
  rename(
    'Fenotipo_predicho' = value,
    'Fenotipo_observado' = Fen_escalado
    )

## 3. Subpoblación con 451 individuos genotipados

load(here('Datos', 'Datos_IND', 'Den_1.000', 'mod_BGLR', 'Ped_4', 'mod_BGLR_3', 'mod_BGLR_3.RData'))

Pred_IND_15 <- mod_IND_3$yHat %>%
  as_tibble() %>%
  mutate(Subpoblación = '451') %>%
  rowid_to_column(var = 'id') %>%
  right_join(y = Pob_IND_2, by = 'id')  %>%
  rename(
    'Fenotipo_predicho' = value,
    'Fenotipo_observado' = Fen_escalado
    )

## 4. Subpoblación con ningún individuo genotipado

load(here('Datos', 'Datos_IND', 'Den_100.000_b', 'mod_BGLR', 'Ped_4', 'mod_BGLR_4', 'mod_BGLR_4.RData'))

Pred_IND_16 <- mod_IND_4$yHat %>%
  as_tibble() %>%
  mutate(Subpoblación = '0') %>%
  rowid_to_column(var = 'id') %>%
  right_join(y = Pob_IND_2, by = 'id')  %>%
  rename(
    'Fenotipo_predicho' = value,
    'Fenotipo_observado' = Fen_escalado
    )

# 4. Se unen todos los datos anteriores de las distintas subpoblaciones de individuos. genotipados en un solo conjunto de datos

Pred_IND_d <- bind_rows(Pred_IND_13, Pred_IND_14, Pred_IND_15, Pred_IND_16) %>%
  arrange(id) %>%
  relocate(
    Variety,
    .after = id
  ) %>%
  relocate(
    Fenotipo_predicho,
    .after = Fenotipo_observado
  ) %>%
  mutate(Pedigrí = '1')

#######################################################
# Gráfico de dispersión de los resultados del pedigrí 4
#######################################################

Graf_disp_IND <- function(Subpoblación) {
  Pred_IND_d %>%
    filter(.data$Subpoblación == .env$Subpoblación) %>%
    ggplot() +
    aes(x = Fenotipo_observado, y = Fenotipo_predicho) +
    geom_point(size = 4.4, colour = 'red', alpha = 0.6) +
    geom_smooth(color = 'red', fill = 'red', method = 'lm', se = TRUE) +
    stat_cor(p.accuracy = 0.001, colour = 'gray34', label.x = -1.5, label.y = -1.5) +
    geom_rug(colour = 'gray') +
    scale_x_continuous(labels = label_number(accuracy = 0.01)) +
    scale_y_continuous(labels = label_number(accuracy = 0.01)) +
    ggtitle(glue('Individuos genotipados: {Subpoblación}')) +
    labs(x = 'Fenotipo observado', y = 'Fenotipo predicho') +
    theme_bw() +
    theme(
      axis.text = element_text(size = 14),
      axis.title = element_text(size = 15, face = 'bold'),
      plot.title = element_text(size = 11, face = 'bold'),
      legend.position = 'none'
      )
  }

Subpoblación <- c('0', '148', '298', '451')
Graf <- map(Subpoblación, Graf_disp_IND)
(Graf[[1]] | Graf[[2]] | Graf[[3]] | Graf[[4]]) +
  plot_annotation(title = 'Pedigrí uno')

########################################################
# Pedigrí 5: 1530 individuos simulados en 9 generaciones
########################################################

# 2. Se importa el archivo .fam obtenido usando plink y que posteriomente se uso para crear la hoja de parámetros para ejecutar el software molcoanc.

famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'nSNPs_IND.fam')) %>% 
  select(fam) %>%
  mutate(id = 1531:1981) %>%
  rename(Variety = fam)

# 3. Se crea un conjunto de datos que contiene solo los individuos mejorados.

Pob_mej <- lin_mej %>%
  filter(Status_with_Pedigree.plus.knowledge == 'I') %>% # Conjunto de datos solo con los individuos mejorados (los que se clasificaron como "I").
  select(X3K_DNA_IRIS_UNIQUE_ID) %>%
  rename(Variety = X3K_DNA_IRIS_UNIQUE_ID)

escalado <- function(x) { # Función usada para escalar el fenotipo.
  (x - mean(x, na.rm = TRUE)) / sd(x, na.rm = TRUE)
}

Pob_IND <- Fenotipos %>%
  filter(SNPsubsp == 'IND') %>% # Conjunto de datos solo con la especie IND.
  mutate(
    Variety_2 = Variety,
    Fen_escalado = escalado(Time.to.flowering..from.sowing)
    ) %>%
  separate(
    col = Variety,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  ' '
  ) %>%
  unite(
    col = Variety,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  separate(
    col = Variety,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  '-'
  ) %>%
  unite(
    col = Variety,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  separate(
    col = Variety_2,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  ' '
  ) %>%
  unite(
    col = Variety_2,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  inner_join(y = Pob_mej, by = 'Variety') %>%
  select(Variety_2, Fen_escalado) %>% # Se creo el conjunto de datos con los individuos mejorados de la población indica.
  rename(Variety = Variety_2)

Pob_IND_2 <- Pob_IND %>%
  left_join(y = famsnps_IND, by = 'Variety') # Se unen al conjunto de datos famsnps_IND debido a que aquí esta la identificación numérica como esta en el pedigrí.

## 1. Subpoblación con 148 individuos genotipados

load(here('Datos', 'Datos_IND', 'Den_1.000', 'mod_BGLR', 'Ped_5', 'mod_BGLR_1', 'mod_BGLR_1.RData'))

Pred_IND_17 <- mod_IND_1$yHat %>%
  as_tibble() %>%
  mutate(Subpoblación = '148') %>%
  rowid_to_column(var = 'id') %>%
  right_join(y = Pob_IND_2, by = 'id')  %>%
  rename(
    'Fenotipo_predicho' = value,
    'Fenotipo_observado' = Fen_escalado
    )

## 2. Subpoblación con 298 individuos genotipados

load(here('Datos', 'Datos_IND', 'Den_1.000', 'mod_BGLR', 'Ped_5', 'mod_BGLR_2', 'mod_BGLR_2.RData'))

Pred_IND_18 <- mod_IND_2$yHat %>%
  as_tibble() %>%
  mutate(Subpoblación = '298') %>%
  rowid_to_column(var = 'id') %>%
  right_join(y = Pob_IND_2, by = 'id')  %>%
  rename(
    'Fenotipo_predicho' = value,
    'Fenotipo_observado' = Fen_escalado
    )

## 3. Subpoblación con 451 individuos genotipados

load(here('Datos', 'Datos_IND', 'Den_1.000', 'mod_BGLR', 'Ped_5', 'mod_BGLR_3', 'mod_BGLR_3.RData'))

Pred_IND_19 <- mod_IND_3$yHat %>%
  as_tibble() %>%
  mutate(Subpoblación = '451') %>%
  rowid_to_column(var = 'id') %>%
  right_join(y = Pob_IND_2, by = 'id')  %>%
  rename(
    'Fenotipo_predicho' = value,
    'Fenotipo_observado' = Fen_escalado
    )

## 4. Subpoblación con ningún individuo genotipado

load(here('Datos', 'Datos_IND', 'Den_100.000_b', 'mod_BGLR', 'Ped_5', 'mod_BGLR_4', 'mod_BGLR_4.RData'))

Pred_IND_20 <- mod_IND_4$yHat %>%
  as_tibble() %>%
  mutate(Subpoblación = '0') %>%
  rowid_to_column(var = 'id') %>%
  right_join(y = Pob_IND_2, by = 'id')  %>%
  rename(
    'Fenotipo_predicho' = value,
    'Fenotipo_observado' = Fen_escalado
    )

# 4. Se unen todos los datos anteriores de las distintas subpoblaciones de individuos. genotipados en un solo conjunto de datos

Pred_IND_e <- bind_rows(Pred_IND_17, Pred_IND_18, Pred_IND_19, Pred_IND_20) %>%
  arrange(id) %>%
  relocate(
    Variety,
    .after = id
  ) %>%
  relocate(
    Fenotipo_predicho,
    .after = Fenotipo_observado
  ) %>%
  mutate(Pedigrí = '4')

#######################################################
# Gráfico de dispersión de los resultados del pedigrí 5
#######################################################

Graf_disp_IND <- function(Subpoblación) {
  Pred_IND_e %>%
    filter(.data$Subpoblación == .env$Subpoblación) %>%
    ggplot() +
    aes(x = Fenotipo_observado, y = Fenotipo_predicho) +
    geom_point(size = 4.4, colour = 'red', alpha = 0.6) +
    geom_smooth(color = 'red', fill = 'red', method = 'lm', se = TRUE) +
    stat_cor(p.accuracy = 0.001, colour = 'gray34', label.x = -1.5, label.y = -1.5) +
    geom_rug(colour = 'gray') +
    scale_x_continuous(labels = label_number(accuracy = 0.01)) +
    scale_y_continuous(labels = label_number(accuracy = 0.01)) +
    ggtitle(glue('Individuos genotipados: {Subpoblación}')) +
    labs(x = 'Fenotipo observado', y = 'Fenotipo predicho') +
    theme_bw() +
    theme(
      axis.text = element_text(size = 14),
      axis.title = element_text(size = 15, face = 'bold'),
      plot.title = element_text(size = 11, face = 'bold'),
      legend.position = 'none'
      )
  }


Subpoblación <- c('0', '148', '298', '451')
Graf <- map(Subpoblación, Graf_disp_IND)
(Graf[[1]] | Graf[[2]] | Graf[[3]] | Graf[[4]]) +
  plot_annotation(title = 'Pedigrí cuatro')
```

# 21. A continuación se organizan los conjuntos de datos para ajustar los modelos usando el programa BLUPf90.

```{r Organización de conjuntos de datos para el BLUPf90}

#######################################################################
################ Densidad del marcador de 100.000 SNPs ################
#######################################################################

dir.create('../Datos/Datos_IND/Den_100.000_b/mod_BLUPf90') # Se crea el directorio donde se guardaran los conjuntos de datos para el análisis usando el programa BLUPf90.

#########################################################
# Pedigrí 1: 2000 individuos simulados en 10 generaciones
#########################################################

dir.create('../Datos/Datos_IND/Den_100.000_b/mod_BLUPf90/Ped_1') # Se crea el directorio donde se guardara los distintos conjuntos de datos donde se haga uso del pedigrí 1.

## 1. Subpoblación con 148 individuos genotipados

dir.create('../Datos/Datos_IND/Den_100.000_b/mod_BLUPf90/Ped_1/148_ind') # Se crea el directorio donde se guardara los distintos conjuntos de datos donde se haga uso de los 148 individuos genotipados.

#### Conjunto de datos del pedigrí ----

ped_1 <- read_delim(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'Molcoanc_12', 'geneal_IND.csv'), delim = '\t')

ped_1 %>%
  write_delim(here('Datos', 'Datos_IND', 'Den_100.000_b', 'mod_BLUPf90', 'Ped_1', '148_ind', 'Ped_1.txt'), delim = ' ', col_names = FALSE)

#### Conjunto de datos de genotipos ----

famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'nSNPs_IND.fam')) %>% # Se importa el archivo .fam obtenido usando plink y que posteriomente se uso para crear la hoja de parámetros para ejecutar el software molcoanc.
  select(fam) %>%
  mutate(id = 2001:2451)

ped_IND_148 <- read_delim(here('Datos', 'Datos_IND', 'Den_100.000', 'mG', 'mG_2', 'subpob_IND.txt'), delim = '\t', col_names = FALSE) %>% # Se importa el conjunto de datos donde esta la identificación de los 148 individuos genotipados.
  select(X1) %>%
  rename(fam = X1) %>%
  right_join(x = famsnps_IND, by = 'fam') %>%
  select(-fam)

bimsnps_IND <- read_bim(here('Datos', 'Datos_IND', 'Den_100.000', 'mG', 'mG_2', 'frec_0.05_IND.bim'))
famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Den_100.000', 'mG', 'mG_2', 'frec_0.05_IND.fam'))
bedsnps_IND <- BEDMatrix(here('Datos', 'Datos_IND', 'Den_100.000', 'mG', 'mG_2', 'frec_0.05_IND.bed'), n = length(famsnps_IND$id), p = length(bimsnps_IND$id), simple_names = FALSE)
snps_IND <- as.matrix(bedsnps_IND) # Se importa la matriz de SNPs para los 148 individuos genotipados.

Geno_148 <- snps_IND %>%
  as_tibble() %>%
  bind_cols(ped_IND_148) %>%
  relocate(
    id,
    .before = V1
    ) %>%
  unite(
    'snps',
    V1:V100662,
    sep = '',
    remove = TRUE
    )

Geno_148 %>%
  write_delim(here('Datos', 'Datos_IND', 'Den_100.000_b', 'mod_BLUPf90', 'Ped_1', '148_ind', 'Geno_148.txt'), delim = ' ', col_names = FALSE)

#### Conjunto de datos del fenotipo ----

lin_mej <- read_delim(here('Datos', 'iris_pedigree.csv'), delim = ',') # Se importan las bases de datos de fenotipos y de linea mejorada.
Fenotipos <- read_delim(here('Datos', 'all.phenotypes.csv'), delim = ',')

Pob_mej <- lin_mej %>%
  filter(Status_with_Pedigree.plus.knowledge == 'I') %>% # Conjunto de datos solo con los individuos mejorados (los que se clasificaron como "I").
  select(X3K_DNA_IRIS_UNIQUE_ID) %>%
  rename(Variety = X3K_DNA_IRIS_UNIQUE_ID)

escalado <- function(x) { # Función usada para escalar el fenotipo.
  (x - mean(x, na.rm = TRUE)) / sd(x, na.rm = TRUE)
  }

Pob_IND <- Fenotipos %>%
  filter(SNPsubsp == 'IND') %>% # Conjunto de datos solo con la especie IND.
  mutate(
    Variety_2 = Variety,
    Fen_escalado = escalado(Time.to.flowering..from.sowing)
    ) %>%
  separate(
    col = Variety,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  ' '
  ) %>%
  unite(
    col = Variety,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  separate(
    col = Variety,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  '-'
  ) %>%
  unite(
    col = Variety,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  separate(
    col = Variety_2,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  ' '
  ) %>%
  unite(
    col = Variety_2,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  inner_join(y = Pob_mej, by = 'Variety') %>%
  select(Variety_2, Fen_escalado) %>% # Se creo el conjunto de datos con los individuos mejorados de la población indica.
  mutate(Fen_escalado = NA) %>% # Los fenotipos de estos individuos se deben colocar como NAs al formar parte de la población de validación cruzada, y al ser los individuos que se quieren predecir.
  rename(Variety = Variety_2)

Pob_IND_2 <- Fenotipos %>%
  filter(SNPsubsp == 'IND') %>% # Conjunto de datos solo con la especie IND.
  mutate(
    Variety_2 = Variety,
    Fen_escalado = escalado(Time.to.flowering..from.sowing)
    ) %>%
  separate(
    col = Variety,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  ' '
  ) %>%
  unite(
    col = Variety,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  separate(
    col = Variety,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  '-'
  ) %>%
  unite(
    col = Variety,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  separate(
    col = Variety_2,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  ' '
  ) %>%
  unite(
    col = Variety_2,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  anti_join(Pob_mej, by = 'Variety') %>%
  select(Variety_2, Fen_escalado) %>% # Se creo el conjunto de datos con los individuos no mejorados de la población indica.
  rename(Variety = Variety_2)

famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'nSNPs_IND.fam')) %>% # Se importa el archivo .fam obtenido usando plink y que posteriomente se uso para crear la hoja de parámetros para ejecutar el software molcoanc.
  select(fam) %>%
  mutate(id = 2001:2451) %>%
  rename(Variety = fam)

Pob_IND_3 <- Pob_IND_2 %>%
  left_join(y = famsnps_IND, by = 'Variety') # Se unen al conjunto de datos anterior (famsnps_IND) debido a que aquí esta la identificación numérica como esta en el pedigrí.

Pob_IND_4 <- Pob_IND %>%
  left_join(y = famsnps_IND, by = 'Variety') %>% # Se unen al conjunto de datos famsnps_IND debido a que aquí esta la identificación numérica como esta en el pedigrí.
  bind_rows(Pob_IND_3) %>% # Se une por filas al conjunto de datos de individuos no mejorados anterior Pob_IND_3.
  select(-Variety) %>%
  relocate(
    Fen_escalado,
    .after = id
    )

Pob_IND_5 <- tibble(
  id = seq(from = 1, to = 2000, by = 1),
  Fen_escalado = rep(x = NA, times = 2000)
  ) %>% # # Se crea un conjunto de datos donde estaran los fenotipos de los individuos con pedigrí simulado mediante el software molcoanc.
  bind_rows(Pob_IND_4) %>% # Se une por filas al conjunto de datos de individuos anterior Pob_IND_4.
  arrange(id) %>%
  mutate(Fen_escalado = replace_na(Fen_escalado, 0))

Pob_IND_5 %>%
  write_delim(here('Datos', 'Datos_IND', 'Den_100.000_b', 'mod_BLUPf90', 'Ped_1', '148_ind', 'Fenotipo.txt'), delim = ' ', col_names = FALSE)

#### Conjunto de datos de  referencia cruzada (relaciona el id especificado en los archivos de pedigrí y de fenotipos con el id en el archivo de marcador) ----

Ref_cruz <- Geno_148 %>%
  select(id) %>%
  mutate(id_2 = id)

Ref_cruz %>%
  write_delim(here('Datos', 'Datos_IND', 'Den_100.000_b', 'mod_BLUPf90', 'Ped_1', '148_ind', 'Geno_148_RF.txt'), delim = ' ', col_names = FALSE)

## 2. Subpoblación con 298 individuos genotipados

dir.create('../Datos/Datos_IND/Den_100.000_b/mod_BLUPf90/Ped_1/298_ind') # Se crea el directorio donde se guardara los distintos conjuntos de datos donde se haga uso de los 298 individuos genotipados.

#### Conjunto de datos del pedigrí ----

ped_1 %>%
  write_delim(here('Datos', 'Datos_IND', 'Den_100.000_b', 'mod_BLUPf90', 'Ped_1', '298_ind', 'Ped_1.txt'), delim = ' ', col_names = FALSE)

#### Conjunto de datos de genotipos ----

famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'nSNPs_IND.fam')) %>% # Se importa el archivo .fam obtenido usando plink y que posteriomente se uso para crear la hoja de parámetros para ejecutar el software molcoanc.
  select(fam) %>%
  mutate(id = 2001:2451)

ped_IND_298 <- read_delim(here('Datos', 'Datos_IND', 'Den_100.000', 'mG', 'mG_5', 'subpob_IND.txt'), delim = '\t', col_names = FALSE) %>% # Se importa el conjunto de datos donde esta la identificación de los 298 individuos genotipados.
  select(X1) %>%
  rename(fam = X1) %>%
  right_join(x = famsnps_IND, by = 'fam') %>%
  select(-fam)

bimsnps_IND <- read_bim(here('Datos', 'Datos_IND', 'Den_100.000', 'mG', 'mG_5', 'frec_0.05_IND.bim'))
famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Den_100.000', 'mG', 'mG_5', 'frec_0.05_IND.fam'))
bedsnps_IND <- BEDMatrix(here('Datos', 'Datos_IND', 'Den_100.000', 'mG', 'mG_5', 'frec_0.05_IND.bed'), n = length(famsnps_IND$id), p = length(bimsnps_IND$id), simple_names = FALSE)
snps_IND <- as.matrix(bedsnps_IND) # Se importa la matriz de SNPs para los 298 individuos genotipados.

Geno_298 <- snps_IND %>%
  as_tibble() %>%
  bind_cols(ped_IND_298) %>%
  relocate(
    id,
    .before = V1
    ) %>%
  unite(
    'snps',
    V1:V101394,
    sep = '',
    remove = TRUE
    )

Geno_298 %>%
  write_delim(here('Datos', 'Datos_IND', 'Den_100.000_b', 'mod_BLUPf90', 'Ped_1', '298_ind', 'Geno_298.txt'), delim = ' ', col_names = FALSE)

#### Conjunto de datos del fenotipo ----

Pob_IND_5 %>%
  write_delim(here('Datos', 'Datos_IND', 'Den_100.000_b', 'mod_BLUPf90', 'Ped_1', '298_ind', 'Fenotipo.txt'), delim = ' ', col_names = FALSE)

#### Conjunto de datos de  referencia cruzada (relaciona el id especificado en los archivos de pedigrí y de fenotipos con el id en el archivo de marcador) ----

Ref_cruz <- Geno_298 %>%
  select(id) %>%
  mutate(id_2 = id)

Ref_cruz %>%
  write_delim(here('Datos', 'Datos_IND', 'Den_100.000_b', 'mod_BLUPf90', 'Ped_1', '298_ind', 'Geno_298_RF.txt'), delim = ' ', col_names = FALSE)


## 3. Subpoblación con 451 individuos genotipados

dir.create('../Datos/Datos_IND/Den_100.000_b/mod_BLUPf90/Ped_1/451_ind') # Se crea el directorio donde se guardara los distintos conjuntos de datos donde se haga uso de los 451 individuos genotipados.

#### Conjunto de datos del pedigrí ----

ped_1 %>%
  write_delim(here('Datos', 'Datos_IND', 'Den_100.000_b', 'mod_BLUPf90', 'Ped_1', '451_ind', 'Ped_1.txt'), delim = ' ', col_names = FALSE)

#### Conjunto de datos de genotipos ----

famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'nSNPs_IND.fam')) %>% # Se importa el archivo .fam obtenido usando plink y que posteriomente se uso para crear la hoja de parámetros para ejecutar el software molcoanc.
  select(fam) %>%
  mutate(id = 2001:2451)

ped_IND_451 <- read_delim(here('Datos', 'Datos_IND', 'Den_100.000', 'mG', 'mG_8', 'subpob_IND.txt'), delim = '\t', col_names = FALSE) %>% # Se importa el conjunto de datos donde esta la identificación de los 451 individuos genotipados.
  select(X1) %>%
  rename(fam = X1) %>%
  right_join(x = famsnps_IND, by = 'fam') %>%
  select(-fam)

bimsnps_IND <- read_bim(here('Datos', 'Datos_IND', 'Den_100.000', 'mG', 'mG_8', 'frec_0.05_IND.bim'))
famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Den_100.000', 'mG', 'mG_8', 'frec_0.05_IND.fam'))
bedsnps_IND <- BEDMatrix(here('Datos', 'Datos_IND', 'Den_100.000', 'mG', 'mG_8', 'frec_0.05_IND.bed'), n = length(famsnps_IND$id), p = length(bimsnps_IND$id), simple_names = FALSE)
snps_IND <- as.matrix(bedsnps_IND) # Se importa la matriz de SNPs para los 451 individuos genotipados.

Geno_451 <- snps_IND %>%
  as_tibble() %>%
  bind_cols(ped_IND_451) %>%
  relocate(
    id,
    .before = V1
    ) %>%
  unite(
    'snps',
    V1:V100231,
    sep = '',
    remove = TRUE
    )

Geno_451 %>%
  write_delim(here('Datos', 'Datos_IND', 'Den_100.000_b', 'mod_BLUPf90', 'Ped_1', '451_ind', 'Geno_451.txt'), delim = ' ', col_names = FALSE)

#### Conjunto de datos del fenotipo ----

Pob_IND_5 %>%
  write_delim(here('Datos', 'Datos_IND', 'Den_100.000_b', 'mod_BLUPf90', 'Ped_1', '451_ind', 'Fenotipo.txt'), delim = ' ', col_names = FALSE)

#### Conjunto de datos de  referencia cruzada (relaciona el id especificado en los archivos de pedigrí y de fenotipos con el id en el archivo de marcador) ----

Ref_cruz <- Geno_451 %>%
  select(id) %>%
  mutate(id_2 = id)

Ref_cruz %>%
  write_delim(here('Datos', 'Datos_IND', 'Den_100.000_b', 'mod_BLUPf90', 'Ped_1', '451_ind', 'Geno_451_RF.txt'), delim = ' ', col_names = FALSE)

#######################################################
# Pedigrí 2: 520 individuos simulados en 4 generaciones
#######################################################

dir.create('../Datos/Datos_IND/Den_100.000_b/mod_BLUPf90/Ped_2') # Se crea el directorio donde se guardara los distintos conjuntos de datos donde se haga uso del pedigrí 2.

## 1. Subpoblación con 148 individuos genotipados

dir.create('../Datos/Datos_IND/Den_100.000_b/mod_BLUPf90/Ped_2/148_ind') # Se crea el directorio donde se guardara los distintos conjuntos de datos donde se haga uso de los 148 individuos genotipados.

#### Conjunto de datos del pedigrí ----

ped_2 <- read_delim(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'Molcoanc_13', 'geneal_IND.csv'), delim = ' ')

ped_2 %>%
  write_delim(here('Datos', 'Datos_IND', 'Den_100.000_b', 'mod_BLUPf90', 'Ped_2', '148_ind', 'Ped_2.txt'), delim = ' ', col_names = FALSE)

#### Conjunto de datos de genotipos ----

famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'nSNPs_IND.fam')) %>% # Se importa el archivo .fam obtenido usando plink y que posteriomente se uso para crear la hoja de parámetros para ejecutar el software molcoanc.
  select(fam) %>%
  mutate(id = 521:971)

ped_IND_148 <- read_delim(here('Datos', 'Datos_IND', 'Den_100.000', 'mG', 'mG_2', 'subpob_IND.txt'), delim = '\t', col_names = FALSE) %>% # Se importa el conjunto de datos donde esta la identificación de los 148 individuos genotipados.
  select(X1) %>%
  rename(fam = X1) %>%
  right_join(x = famsnps_IND, by = 'fam') %>%
  select(-fam)

bimsnps_IND <- read_bim(here('Datos', 'Datos_IND', 'Den_100.000', 'mG', 'mG_2', 'frec_0.05_IND.bim'))
famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Den_100.000', 'mG', 'mG_2', 'frec_0.05_IND.fam'))
bedsnps_IND <- BEDMatrix(here('Datos', 'Datos_IND', 'Den_100.000', 'mG', 'mG_2', 'frec_0.05_IND.bed'), n = length(famsnps_IND$id), p = length(bimsnps_IND$id), simple_names = FALSE)
snps_IND <- as.matrix(bedsnps_IND) # Se importa la matriz de SNPs para los 148 individuos genotipados.

Geno_148 <- snps_IND %>%
  as_tibble() %>%
  bind_cols(ped_IND_148) %>%
  relocate(
    id,
    .before = V1
    ) %>%
  unite(
    'snps',
    V1:V100662,
    sep = '',
    remove = TRUE
    )

Geno_148 %>%
  write_delim(here('Datos', 'Datos_IND', 'Den_100.000_b', 'mod_BLUPf90', 'Ped_2', '148_ind', 'Geno_148.txt'), delim = ' ', col_names = FALSE)

#### Conjunto de datos del fenotipo ----

lin_mej <- read_delim(here('Datos', 'iris_pedigree.csv'), delim = ',') # Se importan las bases de datos de fenotipos y de linea mejorada.
Fenotipos <- read_delim(here('Datos', 'all.phenotypes.csv'), delim = ',')

Pob_mej <- lin_mej %>%
  filter(Status_with_Pedigree.plus.knowledge == 'I') %>% # Conjunto de datos solo con los individuos mejorados (los que se clasificaron como "I").
  select(X3K_DNA_IRIS_UNIQUE_ID) %>%
  rename(Variety = X3K_DNA_IRIS_UNIQUE_ID)

escalado <- function(x) { # Función usada para escalar el fenotipo.
  (x - mean(x, na.rm = TRUE)) / sd(x, na.rm = TRUE)
  }

Pob_IND <- Fenotipos %>%
  filter(SNPsubsp == 'IND') %>% # Conjunto de datos solo con la especie IND.
  mutate(
    Variety_2 = Variety,
    Fen_escalado = escalado(Time.to.flowering..from.sowing)
    ) %>%
  separate(
    col = Variety,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  ' '
  ) %>%
  unite(
    col = Variety,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  separate(
    col = Variety,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  '-'
  ) %>%
  unite(
    col = Variety,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  separate(
    col = Variety_2,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  ' '
  ) %>%
  unite(
    col = Variety_2,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  inner_join(y = Pob_mej, by = 'Variety') %>%
  select(Variety_2, Fen_escalado) %>% # Se creo el conjunto de datos con los individuos mejorados de la población indica.
  mutate(Fen_escalado = NA) %>% # Los fenotipos de estos individuos se deben colocar como NAs al formar parte de la población de validación cruzada, y al ser los individuos que se quieren predecir.
  rename(Variety = Variety_2)

Pob_IND_2 <- Fenotipos %>%
  filter(SNPsubsp == 'IND') %>% # Conjunto de datos solo con la especie IND.
  mutate(
    Variety_2 = Variety,
    Fen_escalado = escalado(Time.to.flowering..from.sowing)
    ) %>%
  separate(
    col = Variety,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  ' '
  ) %>%
  unite(
    col = Variety,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  separate(
    col = Variety,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  '-'
  ) %>%
  unite(
    col = Variety,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  separate(
    col = Variety_2,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  ' '
  ) %>%
  unite(
    col = Variety_2,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  anti_join(Pob_mej, by = 'Variety') %>%
  select(Variety_2, Fen_escalado) %>% # Se creo el conjunto de datos con los individuos no mejorados de la población indica.
  rename(Variety = Variety_2)

famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'nSNPs_IND.fam')) %>% # Se importa el archivo .fam obtenido usando plink y que posteriomente se uso para crear la hoja de parámetros para ejecutar el software molcoanc.
  select(fam) %>%
  mutate(id = 521:971) %>%
  rename(Variety = fam)

Pob_IND_3 <- Pob_IND_2 %>%
  left_join(y = famsnps_IND, by = 'Variety') # Se unen al conjunto de datos anterior (famsnps_IND) debido a que aquí esta la identificación numérica como esta en el pedigrí.

Pob_IND_4 <- Pob_IND %>%
  left_join(y = famsnps_IND, by = 'Variety') %>% # Se unen al conjunto de datos famsnps_IND debido a que aquí esta la identificación numérica como esta en el pedigrí.
  bind_rows(Pob_IND_3) %>% # Se une por filas al conjunto de datos de individuos no mejorados anterior Pob_IND_3.
  select(-Variety) %>%
  relocate(
    Fen_escalado,
    .after = id
    )

Pob_IND_5 <- tibble(
  id = seq(from = 1, to = 520, by = 1),
  Fen_escalado = rep(x = NA, times = 520)
  ) %>% # # Se crea un conjunto de datos donde estaran los fenotipos de los individuos con pedigrí simulado mediante el software molcoanc.
  bind_rows(Pob_IND_4) %>% # Se une por filas al conjunto de datos de individuos anterior Pob_IND_4.
  arrange(id) %>%
  mutate(Fen_escalado = replace_na(Fen_escalado, 0))

Pob_IND_5 %>%
  write_delim(here('Datos', 'Datos_IND', 'Den_100.000_b', 'mod_BLUPf90', 'Ped_2', '148_ind', 'Fenotipo.txt'), delim = ' ', col_names = FALSE)

#### Conjunto de datos de  referencia cruzada (relaciona el id especificado en los archivos de pedigrí y de fenotipos con el id en el archivo de marcador) ----

Ref_cruz <- Geno_148 %>%
  select(id) %>%
  mutate(id_2 = id)

Ref_cruz %>%
  write_delim(here('Datos', 'Datos_IND', 'Den_100.000_b', 'mod_BLUPf90', 'Ped_2', '148_ind', 'Geno_148_RF.txt'), delim = ' ', col_names = FALSE)

## 2. Subpoblación con 298 individuos genotipados

dir.create('../Datos/Datos_IND/Den_100.000_b/mod_BLUPf90/Ped_2/298_ind') # Se crea el directorio donde se guardara los distintos conjuntos de datos donde se haga uso de los 298 individuos genotipados.

#### Conjunto de datos del pedigrí ----

ped_2 %>%
  write_delim(here('Datos', 'Datos_IND', 'Den_100.000_b', 'mod_BLUPf90', 'Ped_2', '298_ind', 'Ped_2.txt'), delim = ' ', col_names = FALSE)

#### Conjunto de datos de genotipos ----

famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'nSNPs_IND.fam')) %>% # Se importa el archivo .fam obtenido usando plink y que posteriomente se uso para crear la hoja de parámetros para ejecutar el software molcoanc.
  select(fam) %>%
  mutate(id = 521:971)

ped_IND_298 <- read_delim(here('Datos', 'Datos_IND', 'Den_100.000', 'mG', 'mG_5', 'subpob_IND.txt'), delim = '\t', col_names = FALSE) %>% # Se importa el conjunto de datos donde esta la identificación de los 298 individuos genotipados.
  select(X1) %>%
  rename(fam = X1) %>%
  right_join(x = famsnps_IND, by = 'fam') %>%
  select(-fam)

bimsnps_IND <- read_bim(here('Datos', 'Datos_IND', 'Den_100.000', 'mG', 'mG_5', 'frec_0.05_IND.bim'))
famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Den_100.000', 'mG', 'mG_5', 'frec_0.05_IND.fam'))
bedsnps_IND <- BEDMatrix(here('Datos', 'Datos_IND', 'Den_100.000', 'mG', 'mG_5', 'frec_0.05_IND.bed'), n = length(famsnps_IND$id), p = length(bimsnps_IND$id), simple_names = FALSE)
snps_IND <- as.matrix(bedsnps_IND) # Se importa la matriz de SNPs para los 298 individuos genotipados.

Geno_298 <- snps_IND %>%
  as_tibble() %>%
  bind_cols(ped_IND_298) %>%
  relocate(
    id,
    .before = V1
    ) %>%
  unite(
    'snps',
    V1:V101394,
    sep = '',
    remove = TRUE
    )

Geno_298 %>%
  write_delim(here('Datos', 'Datos_IND', 'Den_100.000_b', 'mod_BLUPf90', 'Ped_2', '298_ind', 'Geno_298.txt'), delim = ' ', col_names = FALSE)

#### Conjunto de datos del fenotipo ----

Pob_IND_5 %>%
  write_delim(here('Datos', 'Datos_IND', 'Den_100.000_b', 'mod_BLUPf90', 'Ped_2', '298_ind', 'Fenotipo.txt'), delim = ' ', col_names = FALSE)

#### Conjunto de datos de  referencia cruzada (relaciona el id especificado en los archivos de pedigrí y de fenotipos con el id en el archivo de marcador) ----

Ref_cruz <- Geno_298 %>%
  select(id) %>%
  mutate(id_2 = id)

Ref_cruz %>%
  write_delim(here('Datos', 'Datos_IND', 'Den_100.000_b', 'mod_BLUPf90', 'Ped_2', '298_ind', 'Geno_298_RF.txt'), delim = ' ', col_names = FALSE)

## 3. Subpoblación con 451 individuos genotipados

dir.create('../Datos/Datos_IND/Den_100.000_b/mod_BLUPf90/Ped_2/451_ind') # Se crea el directorio donde se guardara los distintos conjuntos de datos donde se haga uso de los 451 individuos genotipados.

#### Conjunto de datos del pedigrí ----

ped_2 %>%
  write_delim(here('Datos', 'Datos_IND', 'Den_100.000_b', 'mod_BLUPf90', 'Ped_2', '451_ind', 'Ped_2.txt'), delim = ' ', col_names = FALSE)

#### Conjunto de datos de genotipos ----

famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'nSNPs_IND.fam')) %>% # Se importa el archivo .fam obtenido usando plink y que posteriomente se uso para crear la hoja de parámetros para ejecutar el software molcoanc.
  select(fam) %>%
  mutate(id = 521:971)

ped_IND_451 <- read_delim(here('Datos', 'Datos_IND', 'Den_100.000', 'mG', 'mG_8', 'subpob_IND.txt'), delim = '\t', col_names = FALSE) %>% # Se importa el conjunto de datos donde esta la identificación de los 451 individuos genotipados.
  select(X1) %>%
  rename(fam = X1) %>%
  right_join(x = famsnps_IND, by = 'fam') %>%
  select(-fam)

bimsnps_IND <- read_bim(here('Datos', 'Datos_IND', 'Den_100.000', 'mG', 'mG_8', 'frec_0.05_IND.bim'))
famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Den_100.000', 'mG', 'mG_8', 'frec_0.05_IND.fam'))
bedsnps_IND <- BEDMatrix(here('Datos', 'Datos_IND', 'Den_100.000', 'mG', 'mG_8', 'frec_0.05_IND.bed'), n = length(famsnps_IND$id), p = length(bimsnps_IND$id), simple_names = FALSE)
snps_IND <- as.matrix(bedsnps_IND) # Se importa la matriz de SNPs para los 451 individuos genotipados.

Geno_451 <- snps_IND %>%
  as_tibble() %>%
  bind_cols(ped_IND_451) %>%
  relocate(
    id,
    .before = V1
    ) %>%
  unite(
    'snps',
    V1:V100231,
    sep = '',
    remove = TRUE
    )

Geno_451 %>%
  write_delim(here('Datos', 'Datos_IND', 'Den_100.000_b', 'mod_BLUPf90', 'Ped_2', '451_ind', 'Geno_451.txt'), delim = ' ', col_names = FALSE)

#### Conjunto de datos del fenotipo ----

Pob_IND_5 %>%
  write_delim(here('Datos', 'Datos_IND', 'Den_100.000_b', 'mod_BLUPf90', 'Ped_2', '451_ind', 'Fenotipo.txt'), delim = ' ', col_names = FALSE)

#### Conjunto de datos de  referencia cruzada (relaciona el id especificado en los archivos de pedigrí y de fenotipos con el id en el archivo de marcador) ----

Ref_cruz <- Geno_451 %>%
  select(id) %>%
  mutate(id_2 = id)

Ref_cruz %>%
  write_delim(here('Datos', 'Datos_IND', 'Den_100.000_b', 'mod_BLUPf90', 'Ped_2', '451_ind', 'Geno_451_RF.txt'), delim = ' ', col_names = FALSE)

########################################################
# Pedigrí 3: 1210 individuos simulados en 7 generaciones
########################################################

dir.create('../Datos/Datos_IND/Den_100.000_b/mod_BLUPf90/Ped_3') # Se crea el directorio donde se guardara los distintos conjuntos de datos donde se haga uso del pedigrí 3.

## 1. Subpoblación con 148 individuos genotipados

dir.create('../Datos/Datos_IND/Den_100.000_b/mod_BLUPf90/Ped_3/148_ind') # Se crea el directorio donde se guardara los distintos conjuntos de datos donde se haga uso de los 148 individuos genotipados.

#### Conjunto de datos del pedigrí ----

ped_3 <- read_delim(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'Molcoanc_14', 'geneal_IND.csv'), delim = ' ')

ped_3 %>%
  write_delim(here('Datos', 'Datos_IND', 'Den_100.000_b', 'mod_BLUPf90', 'Ped_3', '148_ind', 'Ped_3.txt'), delim = ' ', col_names = FALSE)

#### Conjunto de datos de genotipos ----

famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'nSNPs_IND.fam')) %>% # Se importa el archivo .fam obtenido usando plink y que posteriomente se uso para crear la hoja de parámetros para ejecutar el software molcoanc.
  select(fam) %>%
  mutate(id = 1211:1661)

ped_IND_148 <- read_delim(here('Datos', 'Datos_IND', 'Den_100.000', 'mG', 'mG_2', 'subpob_IND.txt'), delim = '\t', col_names = FALSE) %>% # Se importa el conjunto de datos donde esta la identificación de los 148 individuos genotipados.
  select(X1) %>%
  rename(fam = X1) %>%
  right_join(x = famsnps_IND, by = 'fam') %>%
  select(-fam)

bimsnps_IND <- read_bim(here('Datos', 'Datos_IND', 'Den_100.000', 'mG', 'mG_2', 'frec_0.05_IND.bim'))
famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Den_100.000', 'mG', 'mG_2', 'frec_0.05_IND.fam'))
bedsnps_IND <- BEDMatrix(here('Datos', 'Datos_IND', 'Den_100.000', 'mG', 'mG_2', 'frec_0.05_IND.bed'), n = length(famsnps_IND$id), p = length(bimsnps_IND$id), simple_names = FALSE)
snps_IND <- as.matrix(bedsnps_IND) # Se importa la matriz de SNPs para los 148 individuos genotipados.

Geno_148 <- snps_IND %>%
  as_tibble() %>%
  bind_cols(ped_IND_148) %>%
  relocate(
    id,
    .before = V1
    ) %>%
  unite(
    'snps',
    V1:V100662,
    sep = '',
    remove = TRUE
    )

Geno_148 %>%
  write_delim(here('Datos', 'Datos_IND', 'Den_100.000_b', 'mod_BLUPf90', 'Ped_3', '148_ind', 'Geno_148.txt'), delim = ' ', col_names = FALSE)

#### Conjunto de datos del fenotipo ----

lin_mej <- read_delim(here('Datos', 'iris_pedigree.csv'), delim = ',') # Se importan las bases de datos de fenotipos y de linea mejorada.
Fenotipos <- read_delim(here('Datos', 'all.phenotypes.csv'), delim = ',')

Pob_mej <- lin_mej %>%
  filter(Status_with_Pedigree.plus.knowledge == 'I') %>% # Conjunto de datos solo con los individuos mejorados (los que se clasificaron como "I").
  select(X3K_DNA_IRIS_UNIQUE_ID) %>%
  rename(Variety = X3K_DNA_IRIS_UNIQUE_ID)

escalado <- function(x) { # Función usada para escalar el fenotipo.
  (x - mean(x, na.rm = TRUE)) / sd(x, na.rm = TRUE)
  }

Pob_IND <- Fenotipos %>%
  filter(SNPsubsp == 'IND') %>% # Conjunto de datos solo con la especie IND.
  mutate(
    Variety_2 = Variety,
    Fen_escalado = escalado(Time.to.flowering..from.sowing)
    ) %>%
  separate(
    col = Variety,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  ' '
  ) %>%
  unite(
    col = Variety,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  separate(
    col = Variety,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  '-'
  ) %>%
  unite(
    col = Variety,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  separate(
    col = Variety_2,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  ' '
  ) %>%
  unite(
    col = Variety_2,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  inner_join(y = Pob_mej, by = 'Variety') %>%
  select(Variety_2, Fen_escalado) %>% # Se creo el conjunto de datos con los individuos mejorados de la población indica.
  mutate(Fen_escalado = NA) %>% # Los fenotipos de estos individuos se deben colocar como NAs al formar parte de la población de validación cruzada, y al ser los individuos que se quieren predecir.
  rename(Variety = Variety_2)

Pob_IND_2 <- Fenotipos %>%
  filter(SNPsubsp == 'IND') %>% # Conjunto de datos solo con la especie IND.
  mutate(
    Variety_2 = Variety,
    Fen_escalado = escalado(Time.to.flowering..from.sowing)
    ) %>%
  separate(
    col = Variety,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  ' '
  ) %>%
  unite(
    col = Variety,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  separate(
    col = Variety,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  '-'
  ) %>%
  unite(
    col = Variety,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  separate(
    col = Variety_2,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  ' '
  ) %>%
  unite(
    col = Variety_2,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  anti_join(Pob_mej, by = 'Variety') %>%
  select(Variety_2, Fen_escalado) %>% # Se creo el conjunto de datos con los individuos no mejorados de la población indica.
  rename(Variety = Variety_2)

famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'nSNPs_IND.fam')) %>% # Se importa el archivo .fam obtenido usando plink y que posteriomente se uso para crear la hoja de parámetros para ejecutar el software molcoanc.
  select(fam) %>%
  mutate(id = 1211:1661) %>%
  rename(Variety = fam)

Pob_IND_3 <- Pob_IND_2 %>%
  left_join(y = famsnps_IND, by = 'Variety') # Se unen al conjunto de datos anterior (famsnps_IND) debido a que aquí esta la identificación numérica como esta en el pedigrí.

Pob_IND_4 <- Pob_IND %>%
  left_join(y = famsnps_IND, by = 'Variety') %>% # Se unen al conjunto de datos famsnps_IND debido a que aquí esta la identificación numérica como esta en el pedigrí.
  bind_rows(Pob_IND_3) %>% # Se une por filas al conjunto de datos de individuos no mejorados anterior Pob_IND_3.
  select(-Variety) %>%
  relocate(
    Fen_escalado,
    .after = id
    )

Pob_IND_5 <- tibble(
  id = seq(from = 1, to = 1210, by = 1),
  Fen_escalado = rep(x = NA, times = 1210)
  ) %>% # # Se crea un conjunto de datos donde estaran los fenotipos de los individuos con pedigrí simulado mediante el software molcoanc.
  bind_rows(Pob_IND_4) %>% # Se une por filas al conjunto de datos de individuos anterior Pob_IND_4.
  arrange(id) %>%
  mutate(Fen_escalado = replace_na(Fen_escalado, 0))

Pob_IND_5 %>%
  write_delim(here('Datos', 'Datos_IND', 'Den_100.000_b', 'mod_BLUPf90', 'Ped_3', '148_ind', 'Fenotipo.txt'), delim = ' ', col_names = FALSE)

#### Conjunto de datos de  referencia cruzada (relaciona el id especificado en los archivos de pedigrí y de fenotipos con el id en el archivo de marcador) ----

Ref_cruz <- Geno_148 %>%
  select(id) %>%
  mutate(id_2 = id)

Ref_cruz %>%
  write_delim(here('Datos', 'Datos_IND', 'Den_100.000_b', 'mod_BLUPf90', 'Ped_3', '148_ind', 'Geno_148_RF.txt'), delim = ' ', col_names = FALSE)

## 2. Subpoblación con 298 individuos genotipados

dir.create('../Datos/Datos_IND/Den_100.000_b/mod_BLUPf90/Ped_3/298_ind') # Se crea el directorio donde se guardara los distintos conjuntos de datos donde se haga uso de los 298 individuos genotipados.

#### Conjunto de datos del pedigrí ----

ped_3 %>%
  write_delim(here('Datos', 'Datos_IND', 'Den_100.000_b', 'mod_BLUPf90', 'Ped_3', '298_ind', 'Ped_3.txt'), delim = ' ', col_names = FALSE)

#### Conjunto de datos de genotipos ----

famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'nSNPs_IND.fam')) %>% # Se importa el archivo .fam obtenido usando plink y que posteriomente se uso para crear la hoja de parámetros para ejecutar el software molcoanc.
  select(fam) %>%
  mutate(id = 1211:1661)

ped_IND_298 <- read_delim(here('Datos', 'Datos_IND', 'Den_100.000', 'mG', 'mG_5', 'subpob_IND.txt'), delim = '\t', col_names = FALSE) %>% # Se importa el conjunto de datos donde esta la identificación de los 298 individuos genotipados.
  select(X1) %>%
  rename(fam = X1) %>%
  right_join(x = famsnps_IND, by = 'fam') %>%
  select(-fam)

bimsnps_IND <- read_bim(here('Datos', 'Datos_IND', 'Den_100.000', 'mG', 'mG_5', 'frec_0.05_IND.bim'))
famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Den_100.000', 'mG', 'mG_5', 'frec_0.05_IND.fam'))
bedsnps_IND <- BEDMatrix(here('Datos', 'Datos_IND', 'Den_100.000', 'mG', 'mG_5', 'frec_0.05_IND.bed'), n = length(famsnps_IND$id), p = length(bimsnps_IND$id), simple_names = FALSE)
snps_IND <- as.matrix(bedsnps_IND) # Se importa la matriz de SNPs para los 298 individuos genotipados.

Geno_298 <- snps_IND %>%
  as_tibble() %>%
  bind_cols(ped_IND_298) %>%
  relocate(
    id,
    .before = V1
    ) %>%
  unite(
    'snps',
    V1:V101394,
    sep = '',
    remove = TRUE
    )

Geno_298 %>%
  write_delim(here('Datos', 'Datos_IND', 'Den_100.000_b', 'mod_BLUPf90', 'Ped_3', '298_ind', 'Geno_298.txt'), delim = ' ', col_names = FALSE)

#### Conjunto de datos del fenotipo ----

Pob_IND_5 %>%
  write_delim(here('Datos', 'Datos_IND', 'Den_100.000_b', 'mod_BLUPf90', 'Ped_3', '298_ind', 'Fenotipo.txt'), delim = ' ', col_names = FALSE)

#### Conjunto de datos de  referencia cruzada (relaciona el id especificado en los archivos de pedigrí y de fenotipos con el id en el archivo de marcador) ----

Ref_cruz <- Geno_298 %>%
  select(id) %>%
  mutate(id_2 = id)

Ref_cruz %>%
  write_delim(here('Datos', 'Datos_IND', 'Den_100.000_b', 'mod_BLUPf90', 'Ped_3', '298_ind', 'Geno_298_RF.txt'), delim = ' ', col_names = FALSE)

## 3. Subpoblación con 451 individuos genotipados

dir.create('../Datos/Datos_IND/Den_100.000_b/mod_BLUPf90/Ped_3/451_ind') # Se crea el directorio donde se guardara los distintos conjuntos de datos donde se haga uso de los 451 individuos genotipados.

#### Conjunto de datos del pedigrí ----

ped_3 %>%
  write_delim(here('Datos', 'Datos_IND', 'Den_100.000_b', 'mod_BLUPf90', 'Ped_3', '451_ind', 'Ped_3.txt'), delim = ' ', col_names = FALSE)

#### Conjunto de datos de genotipos ----

famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'nSNPs_IND.fam')) %>% # Se importa el archivo .fam obtenido usando plink y que posteriomente se uso para crear la hoja de parámetros para ejecutar el software molcoanc.
  select(fam) %>%
  mutate(id = 1211:1661)

ped_IND_451 <- read_delim(here('Datos', 'Datos_IND', 'Den_100.000', 'mG', 'mG_8', 'subpob_IND.txt'), delim = '\t', col_names = FALSE) %>% # Se importa el conjunto de datos donde esta la identificación de los 451 individuos genotipados.
  select(X1) %>%
  rename(fam = X1) %>%
  right_join(x = famsnps_IND, by = 'fam') %>%
  select(-fam)

bimsnps_IND <- read_bim(here('Datos', 'Datos_IND', 'Den_100.000', 'mG', 'mG_8', 'frec_0.05_IND.bim'))
famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Den_100.000', 'mG', 'mG_8', 'frec_0.05_IND.fam'))
bedsnps_IND <- BEDMatrix(here('Datos', 'Datos_IND', 'Den_100.000', 'mG', 'mG_8', 'frec_0.05_IND.bed'), n = length(famsnps_IND$id), p = length(bimsnps_IND$id), simple_names = FALSE)
snps_IND <- as.matrix(bedsnps_IND) # Se importa la matriz de SNPs para los 451 individuos genotipados.

Geno_451 <- snps_IND %>%
  as_tibble() %>%
  bind_cols(ped_IND_451) %>%
  relocate(
    id,
    .before = V1
    ) %>%
  unite(
    'snps',
    V1:V100231,
    sep = '',
    remove = TRUE
    )

Geno_451 %>%
  write_delim(here('Datos', 'Datos_IND', 'Den_100.000_b', 'mod_BLUPf90', 'Ped_3', '451_ind', 'Geno_451.txt'), delim = ' ', col_names = FALSE)

#### Conjunto de datos del fenotipo ----

Pob_IND_5 %>%
  write_delim(here('Datos', 'Datos_IND', 'Den_100.000_b', 'mod_BLUPf90', 'Ped_3', '451_ind', 'Fenotipo.txt'), delim = ' ', col_names = FALSE)

#### Conjunto de datos de  referencia cruzada (relaciona el id especificado en los archivos de pedigrí y de fenotipos con el id en el archivo de marcador) ----

Ref_cruz <- Geno_451 %>%
  select(id) %>%
  mutate(id_2 = id)

Ref_cruz %>%
  write_delim(here('Datos', 'Datos_IND', 'Den_100.000_b', 'mod_BLUPf90', 'Ped_3', '451_ind', 'Geno_451_RF.txt'), delim = ' ', col_names = FALSE)

#######################################################
# Pedigrí 4: 300 individuos simulados en 3 generaciones
#######################################################

dir.create('../Datos/Datos_IND/Den_100.000_b/mod_BLUPf90/Ped_4') # Se crea el directorio donde se guardara los distintos conjuntos de datos donde se haga uso del pedigrí 4.

## 1. Subpoblación con 148 individuos genotipados

dir.create('../Datos/Datos_IND/Den_100.000_b/mod_BLUPf90/Ped_4/148_ind') # Se crea el directorio donde se guardara los distintos conjuntos de datos donde se haga uso de los 148 individuos genotipados.

#### Conjunto de datos del pedigrí ----

ped_4 <- read_delim(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'Molcoanc_15', 'geneal_IND.csv'), delim = ' ')

ped_4 %>%
  write_delim(here('Datos', 'Datos_IND', 'Den_100.000_b', 'mod_BLUPf90', 'Ped_4', '148_ind', 'Ped_4.txt'), delim = ' ', col_names = FALSE)

#### Conjunto de datos de genotipos ----

famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'nSNPs_IND.fam')) %>% # Se importa el archivo .fam obtenido usando plink y que posteriomente se uso para crear la hoja de parámetros para ejecutar el software molcoanc.
  select(fam) %>%
  mutate(id = 301:751)

ped_IND_148 <- read_delim(here('Datos', 'Datos_IND', 'Den_100.000', 'mG', 'mG_2', 'subpob_IND.txt'), delim = '\t', col_names = FALSE) %>% # Se importa el conjunto de datos donde esta la identificación de los 148 individuos genotipados.
  select(X1) %>%
  rename(fam = X1) %>%
  right_join(x = famsnps_IND, by = 'fam') %>%
  select(-fam)

bimsnps_IND <- read_bim(here('Datos', 'Datos_IND', 'Den_100.000', 'mG', 'mG_2', 'frec_0.05_IND.bim'))
famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Den_100.000', 'mG', 'mG_2', 'frec_0.05_IND.fam'))
bedsnps_IND <- BEDMatrix(here('Datos', 'Datos_IND', 'Den_100.000', 'mG', 'mG_2', 'frec_0.05_IND.bed'), n = length(famsnps_IND$id), p = length(bimsnps_IND$id), simple_names = FALSE)
snps_IND <- as.matrix(bedsnps_IND) # Se importa la matriz de SNPs para los 148 individuos genotipados.

Geno_148 <- snps_IND %>%
  as_tibble() %>%
  bind_cols(ped_IND_148) %>%
  relocate(
    id,
    .before = V1
    ) %>%
  unite(
    'snps',
    V1:V100662,
    sep = '',
    remove = TRUE
    )

Geno_148 %>%
  write_delim(here('Datos', 'Datos_IND', 'Den_100.000_b', 'mod_BLUPf90', 'Ped_4', '148_ind', 'Geno_148.txt'), delim = ' ', col_names = FALSE)

#### Conjunto de datos del fenotipo ----

lin_mej <- read_delim(here('Datos', 'iris_pedigree.csv'), delim = ',') # Se importan las bases de datos de fenotipos y de linea mejorada.
Fenotipos <- read_delim(here('Datos', 'all.phenotypes.csv'), delim = ',')

Pob_mej <- lin_mej %>%
  filter(Status_with_Pedigree.plus.knowledge == 'I') %>% # Conjunto de datos solo con los individuos mejorados (los que se clasificaron como "I").
  select(X3K_DNA_IRIS_UNIQUE_ID) %>%
  rename(Variety = X3K_DNA_IRIS_UNIQUE_ID)

escalado <- function(x) { # Función usada para escalar el fenotipo.
  (x - mean(x, na.rm = TRUE)) / sd(x, na.rm = TRUE)
  }

Pob_IND <- Fenotipos %>%
  filter(SNPsubsp == 'IND') %>% # Conjunto de datos solo con la especie IND.
  mutate(
    Variety_2 = Variety,
    Fen_escalado = escalado(Time.to.flowering..from.sowing)
    ) %>%
  separate(
    col = Variety,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  ' '
  ) %>%
  unite(
    col = Variety,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  separate(
    col = Variety,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  '-'
  ) %>%
  unite(
    col = Variety,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  separate(
    col = Variety_2,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  ' '
  ) %>%
  unite(
    col = Variety_2,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  inner_join(y = Pob_mej, by = 'Variety') %>%
  select(Variety_2, Fen_escalado) %>% # Se creo el conjunto de datos con los individuos mejorados de la población indica.
  mutate(Fen_escalado = NA) %>% # Los fenotipos de estos individuos se deben colocar como NAs al formar parte de la población de validación cruzada, y al ser los individuos que se quieren predecir.
  rename(Variety = Variety_2)

Pob_IND_2 <- Fenotipos %>%
  filter(SNPsubsp == 'IND') %>% # Conjunto de datos solo con la especie IND.
  mutate(
    Variety_2 = Variety,
    Fen_escalado = escalado(Time.to.flowering..from.sowing)
    ) %>%
  separate(
    col = Variety,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  ' '
  ) %>%
  unite(
    col = Variety,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  separate(
    col = Variety,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  '-'
  ) %>%
  unite(
    col = Variety,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  separate(
    col = Variety_2,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  ' '
  ) %>%
  unite(
    col = Variety_2,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  anti_join(Pob_mej, by = 'Variety') %>%
  select(Variety_2, Fen_escalado) %>% # Se creo el conjunto de datos con los individuos no mejorados de la población indica.
  rename(Variety = Variety_2)

famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'nSNPs_IND.fam')) %>% # Se importa el archivo .fam obtenido usando plink y que posteriomente se uso para crear la hoja de parámetros para ejecutar el software molcoanc.
  select(fam) %>%
  mutate(id = 301:751) %>%
  rename(Variety = fam)

Pob_IND_3 <- Pob_IND_2 %>%
  left_join(y = famsnps_IND, by = 'Variety') # Se unen al conjunto de datos anterior (famsnps_IND) debido a que aquí esta la identificación numérica como esta en el pedigrí.

Pob_IND_4 <- Pob_IND %>%
  left_join(y = famsnps_IND, by = 'Variety') %>% # Se unen al conjunto de datos famsnps_IND debido a que aquí esta la identificación numérica como esta en el pedigrí.
  bind_rows(Pob_IND_3) %>% # Se une por filas al conjunto de datos de individuos no mejorados anterior Pob_IND_3.
  select(-Variety) %>%
  relocate(
    Fen_escalado,
    .after = id
    )

Pob_IND_5 <- tibble(
  id = seq(from = 1, to = 300, by = 1),
  Fen_escalado = rep(x = NA, times = 300)
  ) %>% # # Se crea un conjunto de datos donde estaran los fenotipos de los individuos con pedigrí simulado mediante el software molcoanc.
  bind_rows(Pob_IND_4) %>% # Se une por filas al conjunto de datos de individuos anterior Pob_IND_4.
  arrange(id) %>%
  mutate(Fen_escalado = replace_na(Fen_escalado, 0))

Pob_IND_5 %>%
  write_delim(here('Datos', 'Datos_IND', 'Den_100.000_b', 'mod_BLUPf90', 'Ped_4', '148_ind', 'Fenotipo.txt'), delim = ' ', col_names = FALSE)

#### Conjunto de datos de  referencia cruzada (relaciona el id especificado en los archivos de pedigrí y de fenotipos con el id en el archivo de marcador) ----

Ref_cruz <- Geno_148 %>%
  select(id) %>%
  mutate(id_2 = id)

Ref_cruz %>%
  write_delim(here('Datos', 'Datos_IND', 'Den_100.000_b', 'mod_BLUPf90', 'Ped_4', '148_ind', 'Geno_148_RF.txt'), delim = ' ', col_names = FALSE)

## 2. Subpoblación con 298 individuos genotipados

dir.create('../Datos/Datos_IND/Den_100.000_b/mod_BLUPf90/Ped_4/298_ind') # Se crea el directorio donde se guardara los distintos conjuntos de datos donde se haga uso de los 298 individuos genotipados.

#### Conjunto de datos del pedigrí ----

ped_4 %>%
  write_delim(here('Datos', 'Datos_IND', 'Den_100.000_b', 'mod_BLUPf90', 'Ped_4', '298_ind', 'Ped_4.txt'), delim = ' ', col_names = FALSE)

#### Conjunto de datos de genotipos ----

famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'nSNPs_IND.fam')) %>% # Se importa el archivo .fam obtenido usando plink y que posteriomente se uso para crear la hoja de parámetros para ejecutar el software molcoanc.
  select(fam) %>%
  mutate(id = 301:751)

ped_IND_298 <- read_delim(here('Datos', 'Datos_IND', 'Den_100.000', 'mG', 'mG_5', 'subpob_IND.txt'), delim = '\t', col_names = FALSE) %>% # Se importa el conjunto de datos donde esta la identificación de los 298 individuos genotipados.
  select(X1) %>%
  rename(fam = X1) %>%
  right_join(x = famsnps_IND, by = 'fam') %>%
  select(-fam)

bimsnps_IND <- read_bim(here('Datos', 'Datos_IND', 'Den_100.000', 'mG', 'mG_5', 'frec_0.05_IND.bim'))
famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Den_100.000', 'mG', 'mG_5', 'frec_0.05_IND.fam'))
bedsnps_IND <- BEDMatrix(here('Datos', 'Datos_IND', 'Den_100.000', 'mG', 'mG_5', 'frec_0.05_IND.bed'), n = length(famsnps_IND$id), p = length(bimsnps_IND$id), simple_names = FALSE)
snps_IND <- as.matrix(bedsnps_IND) # Se importa la matriz de SNPs para los 298 individuos genotipados.

Geno_298 <- snps_IND %>%
  as_tibble() %>%
  bind_cols(ped_IND_298) %>%
  relocate(
    id,
    .before = V1
    ) %>%
  unite(
    'snps',
    V1:V101394,
    sep = '',
    remove = TRUE
    )

Geno_298 %>%
  write_delim(here('Datos', 'Datos_IND', 'Den_100.000_b', 'mod_BLUPf90', 'Ped_4', '298_ind', 'Geno_298.txt'), delim = ' ', col_names = FALSE)

#### Conjunto de datos del fenotipo ----

Pob_IND_5 %>%
  write_delim(here('Datos', 'Datos_IND', 'Den_100.000_b', 'mod_BLUPf90', 'Ped_4', '298_ind', 'Fenotipo.txt'), delim = ' ', col_names = FALSE)

#### Conjunto de datos de  referencia cruzada (relaciona el id especificado en los archivos de pedigrí y de fenotipos con el id en el archivo de marcador) ----

Ref_cruz <- Geno_298 %>%
  select(id) %>%
  mutate(id_2 = id)

Ref_cruz %>%
  write_delim(here('Datos', 'Datos_IND', 'Den_100.000_b', 'mod_BLUPf90', 'Ped_4', '298_ind', 'Geno_298_RF.txt'), delim = ' ', col_names = FALSE)

## 3. Subpoblación con 451 individuos genotipados

dir.create('../Datos/Datos_IND/Den_100.000_b/mod_BLUPf90/Ped_4/451_ind') # Se crea el directorio donde se guardara los distintos conjuntos de datos donde se haga uso de los 451 individuos genotipados.

#### Conjunto de datos del pedigrí ----

ped_4 %>%
  write_delim(here('Datos', 'Datos_IND', 'Den_100.000_b', 'mod_BLUPf90', 'Ped_4', '451_ind', 'Ped_4.txt'), delim = ' ', col_names = FALSE)

#### Conjunto de datos de genotipos ----

famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'nSNPs_IND.fam')) %>% # Se importa el archivo .fam obtenido usando plink y que posteriomente se uso para crear la hoja de parámetros para ejecutar el software molcoanc.
  select(fam) %>%
  mutate(id = 301:751)

ped_IND_451 <- read_delim(here('Datos', 'Datos_IND', 'Den_100.000', 'mG', 'mG_8', 'subpob_IND.txt'), delim = '\t', col_names = FALSE) %>% # Se importa el conjunto de datos donde esta la identificación de los 451 individuos genotipados.
  select(X1) %>%
  rename(fam = X1) %>%
  right_join(x = famsnps_IND, by = 'fam') %>%
  select(-fam)

bimsnps_IND <- read_bim(here('Datos', 'Datos_IND', 'Den_100.000', 'mG', 'mG_8', 'frec_0.05_IND.bim'))
famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Den_100.000', 'mG', 'mG_8', 'frec_0.05_IND.fam'))
bedsnps_IND <- BEDMatrix(here('Datos', 'Datos_IND', 'Den_100.000', 'mG', 'mG_8', 'frec_0.05_IND.bed'), n = length(famsnps_IND$id), p = length(bimsnps_IND$id), simple_names = FALSE)
snps_IND <- as.matrix(bedsnps_IND) # Se importa la matriz de SNPs para los 451 individuos genotipados.

Geno_451 <- snps_IND %>%
  as_tibble() %>%
  bind_cols(ped_IND_451) %>%
  relocate(
    id,
    .before = V1
    ) %>%
  unite(
    'snps',
    V1:V100231,
    sep = '',
    remove = TRUE
    )

Geno_451 %>%
  write_delim(here('Datos', 'Datos_IND', 'Den_100.000_b', 'mod_BLUPf90', 'Ped_4', '451_ind', 'Geno_451.txt'), delim = ' ', col_names = FALSE)

#### Conjunto de datos del fenotipo ----

Pob_IND_5 %>%
  write_delim(here('Datos', 'Datos_IND', 'Den_100.000_b', 'mod_BLUPf90', 'Ped_4', '451_ind', 'Fenotipo.txt'), delim = ' ', col_names = FALSE)

#### Conjunto de datos de  referencia cruzada (relaciona el id especificado en los archivos de pedigrí y de fenotipos con el id en el archivo de marcador) ----

Ref_cruz <- Geno_451 %>%
  select(id) %>%
  mutate(id_2 = id)

Ref_cruz %>%
  write_delim(here('Datos', 'Datos_IND', 'Den_100.000_b', 'mod_BLUPf90', 'Ped_4', '451_ind', 'Geno_451_RF.txt'), delim = ' ', col_names = FALSE)

########################################################
# Pedigrí 5: 1530 individuos simulados en 9 generaciones
########################################################

dir.create('../Datos/Datos_IND/Den_100.000_b/mod_BLUPf90/Ped_5') # Se crea el directorio donde se guardara los distintos conjuntos de datos donde se haga uso del pedigrí 5.

## 1. Subpoblación con 148 individuos genotipados

dir.create('../Datos/Datos_IND/Den_100.000_b/mod_BLUPf90/Ped_5/148_ind') # Se crea el directorio donde se guardara los distintos conjuntos de datos donde se haga uso de los 148 individuos genotipados.

#### Conjunto de datos del pedigrí ----

ped_5 <- read_delim(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'Molcoanc_16', 'geneal_IND.csv'), delim = ' ')

ped_5 %>%
  write_delim(here('Datos', 'Datos_IND', 'Den_100.000_b', 'mod_BLUPf90', 'Ped_5', '148_ind', 'Ped_5.txt'), delim = ' ', col_names = FALSE)

#### Conjunto de datos de genotipos ----

famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'nSNPs_IND.fam')) %>% # Se importa el archivo .fam obtenido usando plink y que posteriomente se uso para crear la hoja de parámetros para ejecutar el software molcoanc.
  select(fam) %>%
  mutate(id = 1531:1981)

ped_IND_148 <- read_delim(here('Datos', 'Datos_IND', 'Den_100.000', 'mG', 'mG_2', 'subpob_IND.txt'), delim = '\t', col_names = FALSE) %>% # Se importa el conjunto de datos donde esta la identificación de los 148 individuos genotipados.
  select(X1) %>%
  rename(fam = X1) %>%
  right_join(x = famsnps_IND, by = 'fam') %>%
  select(-fam)

bimsnps_IND <- read_bim(here('Datos', 'Datos_IND', 'Den_100.000', 'mG', 'mG_2', 'frec_0.05_IND.bim'))
famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Den_100.000', 'mG', 'mG_2', 'frec_0.05_IND.fam'))
bedsnps_IND <- BEDMatrix(here('Datos', 'Datos_IND', 'Den_100.000', 'mG', 'mG_2', 'frec_0.05_IND.bed'), n = length(famsnps_IND$id), p = length(bimsnps_IND$id), simple_names = FALSE)
snps_IND <- as.matrix(bedsnps_IND) # Se importa la matriz de SNPs para los 148 individuos genotipados.

Geno_148 <- snps_IND %>%
  as_tibble() %>%
  bind_cols(ped_IND_148) %>%
  relocate(
    id,
    .before = V1
    ) %>%
  unite(
    'snps',
    V1:V100662,
    sep = '',
    remove = TRUE
    )

Geno_148 %>%
  write_delim(here('Datos', 'Datos_IND', 'Den_100.000_b', 'mod_BLUPf90', 'Ped_5', '148_ind', 'Geno_148.txt'), delim = ' ', col_names = FALSE)

#### Conjunto de datos del fenotipo ----

lin_mej <- read_delim(here('Datos', 'iris_pedigree.csv'), delim = ',') # Se importan las bases de datos de fenotipos y de linea mejorada.
Fenotipos <- read_delim(here('Datos', 'all.phenotypes.csv'), delim = ',')

Pob_mej <- lin_mej %>%
  filter(Status_with_Pedigree.plus.knowledge == 'I') %>% # Conjunto de datos solo con los individuos mejorados (los que se clasificaron como "I").
  select(X3K_DNA_IRIS_UNIQUE_ID) %>%
  rename(Variety = X3K_DNA_IRIS_UNIQUE_ID)

escalado <- function(x) { # Función usada para escalar el fenotipo.
  (x - mean(x, na.rm = TRUE)) / sd(x, na.rm = TRUE)
  }

Pob_IND <- Fenotipos %>%
  filter(SNPsubsp == 'IND') %>% # Conjunto de datos solo con la especie IND.
  mutate(
    Variety_2 = Variety,
    Fen_escalado = escalado(Time.to.flowering..from.sowing)
    ) %>%
  separate(
    col = Variety,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  ' '
  ) %>%
  unite(
    col = Variety,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  separate(
    col = Variety,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  '-'
  ) %>%
  unite(
    col = Variety,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  separate(
    col = Variety_2,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  ' '
  ) %>%
  unite(
    col = Variety_2,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  inner_join(y = Pob_mej, by = 'Variety') %>%
  select(Variety_2, Fen_escalado) %>% # Se creo el conjunto de datos con los individuos mejorados de la población indica.
  mutate(Fen_escalado = NA) %>% # Los fenotipos de estos individuos se deben colocar como NAs al formar parte de la población de validación cruzada, y al ser los individuos que se quieren predecir.
  rename(Variety = Variety_2)

Pob_IND_2 <- Fenotipos %>%
  filter(SNPsubsp == 'IND') %>% # Conjunto de datos solo con la especie IND.
  mutate(
    Variety_2 = Variety,
    Fen_escalado = escalado(Time.to.flowering..from.sowing)
    ) %>%
  separate(
    col = Variety,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  ' '
  ) %>%
  unite(
    col = Variety,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  separate(
    col = Variety,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  '-'
  ) %>%
  unite(
    col = Variety,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  separate(
    col = Variety_2,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  ' '
  ) %>%
  unite(
    col = Variety_2,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  anti_join(Pob_mej, by = 'Variety') %>%
  select(Variety_2, Fen_escalado) %>% # Se creo el conjunto de datos con los individuos no mejorados de la población indica.
  rename(Variety = Variety_2)

famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'nSNPs_IND.fam')) %>% # Se importa el archivo .fam obtenido usando plink y que posteriomente se uso para crear la hoja de parámetros para ejecutar el software molcoanc.
  select(fam) %>%
  mutate(id = 1531:1981) %>%
  rename(Variety = fam)

Pob_IND_3 <- Pob_IND_2 %>%
  left_join(y = famsnps_IND, by = 'Variety') # Se unen al conjunto de datos anterior (famsnps_IND) debido a que aquí esta la identificación numérica como esta en el pedigrí.

Pob_IND_4 <- Pob_IND %>%
  left_join(y = famsnps_IND, by = 'Variety') %>% # Se unen al conjunto de datos famsnps_IND debido a que aquí esta la identificación numérica como esta en el pedigrí.
  bind_rows(Pob_IND_3) %>% # Se une por filas al conjunto de datos de individuos no mejorados anterior Pob_IND_3.
  select(-Variety) %>%
  relocate(
    Fen_escalado,
    .after = id
    )

Pob_IND_5 <- tibble(
  id = seq(from = 1, to = 1530, by = 1),
  Fen_escalado = rep(x = NA, times = 1530)
  ) %>% # # Se crea un conjunto de datos donde estaran los fenotipos de los individuos con pedigrí simulado mediante el software molcoanc.
  bind_rows(Pob_IND_4) %>% # Se une por filas al conjunto de datos de individuos anterior Pob_IND_4.
  arrange(id) %>%
  mutate(Fen_escalado = replace_na(Fen_escalado, 0))

Pob_IND_5 %>%
  write_delim(here('Datos', 'Datos_IND', 'Den_100.000_b', 'mod_BLUPf90', 'Ped_5', '148_ind', 'Fenotipo.txt'), delim = ' ', col_names = FALSE)

#### Conjunto de datos de  referencia cruzada (relaciona el id especificado en los archivos de pedigrí y de fenotipos con el id en el archivo de marcador) ----

Ref_cruz <- Geno_148 %>%
  select(id) %>%
  mutate(id_2 = id)

Ref_cruz %>%
  write_delim(here('Datos', 'Datos_IND', 'Den_100.000_b', 'mod_BLUPf90', 'Ped_5', '148_ind', 'Geno_148_RF.txt'), delim = ' ', col_names = FALSE)

## 2. Subpoblación con 298 individuos genotipados

dir.create('../Datos/Datos_IND/Den_100.000_b/mod_BLUPf90/Ped_5/298_ind') # Se crea el directorio donde se guardara los distintos conjuntos de datos donde se haga uso de los 298 individuos genotipados.

#### Conjunto de datos del pedigrí ----

ped_5 %>%
  write_delim(here('Datos', 'Datos_IND', 'Den_100.000_b', 'mod_BLUPf90', 'Ped_5', '298_ind', 'Ped_5.txt'), delim = ' ', col_names = FALSE)

#### Conjunto de datos de genotipos ----

famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'nSNPs_IND.fam')) %>% # Se importa el archivo .fam obtenido usando plink y que posteriomente se uso para crear la hoja de parámetros para ejecutar el software molcoanc.
  select(fam) %>%
  mutate(id = 1531:1981)

ped_IND_298 <- read_delim(here('Datos', 'Datos_IND', 'Den_100.000', 'mG', 'mG_5', 'subpob_IND.txt'), delim = '\t', col_names = FALSE) %>% # Se importa el conjunto de datos donde esta la identificación de los 298 individuos genotipados.
  select(X1) %>%
  rename(fam = X1) %>%
  right_join(x = famsnps_IND, by = 'fam') %>%
  select(-fam)

bimsnps_IND <- read_bim(here('Datos', 'Datos_IND', 'Den_100.000', 'mG', 'mG_5', 'frec_0.05_IND.bim'))
famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Den_100.000', 'mG', 'mG_5', 'frec_0.05_IND.fam'))
bedsnps_IND <- BEDMatrix(here('Datos', 'Datos_IND', 'Den_100.000', 'mG', 'mG_5', 'frec_0.05_IND.bed'), n = length(famsnps_IND$id), p = length(bimsnps_IND$id), simple_names = FALSE)
snps_IND <- as.matrix(bedsnps_IND) # Se importa la matriz de SNPs para los 298 individuos genotipados.

Geno_298 <- snps_IND %>%
  as_tibble() %>%
  bind_cols(ped_IND_298) %>%
  relocate(
    id,
    .before = V1
    ) %>%
  unite(
    'snps',
    V1:V101394,
    sep = '',
    remove = TRUE
    )

Geno_298 %>%
  write_delim(here('Datos', 'Datos_IND', 'Den_100.000_b', 'mod_BLUPf90', 'Ped_5', '298_ind', 'Geno_298.txt'), delim = ' ', col_names = FALSE)

#### Conjunto de datos del fenotipo ----

Pob_IND_5 %>%
  write_delim(here('Datos', 'Datos_IND', 'Den_100.000_b', 'mod_BLUPf90', 'Ped_5', '298_ind', 'Fenotipo.txt'), delim = ' ', col_names = FALSE)

#### Conjunto de datos de  referencia cruzada (relaciona el id especificado en los archivos de pedigrí y de fenotipos con el id en el archivo de marcador) ----

Ref_cruz <- Geno_298 %>%
  select(id) %>%
  mutate(id_2 = id)

Ref_cruz %>%
  write_delim(here('Datos', 'Datos_IND', 'Den_100.000_b', 'mod_BLUPf90', 'Ped_5', '298_ind', 'Geno_298_RF.txt'), delim = ' ', col_names = FALSE)

## 3. Subpoblación con 451 individuos genotipados

dir.create('../Datos/Datos_IND/Den_100.000_b/mod_BLUPf90/Ped_5/451_ind') # Se crea el directorio donde se guardara los distintos conjuntos de datos donde se haga uso de los 451 individuos genotipados.

#### Conjunto de datos del pedigrí ----

ped_5 %>%
  write_delim(here('Datos', 'Datos_IND', 'Den_100.000_b', 'mod_BLUPf90', 'Ped_5', '451_ind', 'Ped_5.txt'), delim = ' ', col_names = FALSE)

#### Conjunto de datos de genotipos ----

famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'nSNPs_IND.fam')) %>% # Se importa el archivo .fam obtenido usando plink y que posteriomente se uso para crear la hoja de parámetros para ejecutar el software molcoanc.
  select(fam) %>%
  mutate(id = 1531:1981)

ped_IND_451 <- read_delim(here('Datos', 'Datos_IND', 'Den_100.000', 'mG', 'mG_8', 'subpob_IND.txt'), delim = '\t', col_names = FALSE) %>% # Se importa el conjunto de datos donde esta la identificación de los 451 individuos genotipados.
  select(X1) %>%
  rename(fam = X1) %>%
  right_join(x = famsnps_IND, by = 'fam') %>%
  select(-fam)

bimsnps_IND <- read_bim(here('Datos', 'Datos_IND', 'Den_100.000', 'mG', 'mG_8', 'frec_0.05_IND.bim'))
famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Den_100.000', 'mG', 'mG_8', 'frec_0.05_IND.fam'))
bedsnps_IND <- BEDMatrix(here('Datos', 'Datos_IND', 'Den_100.000', 'mG', 'mG_8', 'frec_0.05_IND.bed'), n = length(famsnps_IND$id), p = length(bimsnps_IND$id), simple_names = FALSE)
snps_IND <- as.matrix(bedsnps_IND) # Se importa la matriz de SNPs para los 451 individuos genotipados.

Geno_451 <- snps_IND %>%
  as_tibble() %>%
  bind_cols(ped_IND_451) %>%
  relocate(
    id,
    .before = V1
    ) %>%
  unite(
    'snps',
    V1:V100231,
    sep = '',
    remove = TRUE
    )

Geno_451 %>%
  write_delim(here('Datos', 'Datos_IND', 'Den_100.000_b', 'mod_BLUPf90', 'Ped_5', '451_ind', 'Geno_451.txt'), delim = ' ', col_names = FALSE)

#### Conjunto de datos del fenotipo ----

Pob_IND_5 %>%
  write_delim(here('Datos', 'Datos_IND', 'Den_100.000_b', 'mod_BLUPf90', 'Ped_5', '451_ind', 'Fenotipo.txt'), delim = ' ', col_names = FALSE)

#### Conjunto de datos de  referencia cruzada (relaciona el id especificado en los archivos de pedigrí y de fenotipos con el id en el archivo de marcador) ----

Ref_cruz <- Geno_451 %>%
  select(id) %>%
  mutate(id_2 = id)

Ref_cruz %>%
  write_delim(here('Datos', 'Datos_IND', 'Den_100.000_b', 'mod_BLUPf90', 'Ped_5', '451_ind', 'Geno_451_RF.txt'), delim = ' ', col_names = FALSE)

#####################################################################
############### Densidad del marcador de 10.000 SNPs ################
#####################################################################

dir.create('../Datos/Datos_IND/Den_10.000/mod_BLUPf90') # Se crea el directorio donde se guardaran los conjuntos de datos para el análisis usando el programa BLUPf90.

#########################################################
# Pedigrí 1: 2000 individuos simulados en 10 generaciones
#########################################################

dir.create('../Datos/Datos_IND/Den_10.000/mod_BLUPf90/Ped_1') # Se crea el directorio donde se guardara los distintos conjuntos de datos donde se haga uso del pedigrí 1.

## 1. Subpoblación con 148 individuos genotipados

dir.create('../Datos/Datos_IND/Den_10.000/mod_BLUPf90/Ped_1/148_ind') # Se crea el directorio donde se guardara los distintos conjuntos de datos donde se haga uso de los 148 individuos genotipados.

#### Conjunto de datos del pedigrí ----

ped_1 <- read_delim(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'Molcoanc_12', 'geneal_IND.csv'), delim = ' ')

ped_1 %>%
  write_delim(here('Datos', 'Datos_IND', 'Den_10.000', 'mod_BLUPf90', 'Ped_1', '148_ind', 'Ped_1.txt'), delim = ' ', col_names = FALSE)

#### Conjunto de datos de genotipos ----

famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'nSNPs_IND.fam')) %>% # Se importa el archivo .fam obtenido usando plink y que posteriomente se uso para crear la hoja de parámetros para ejecutar el software molcoanc.
  select(fam) %>%
  mutate(id = 2001:2451)

ped_IND_148 <- read_delim(here('Datos', 'Datos_IND', 'Den_100.000', 'mG', 'mG_2', 'subpob_IND.txt'), delim = '\t', col_names = FALSE) %>% # Se importa el conjunto de datos donde esta la identificación de los 148 individuos genotipados.
  select(X1) %>%
  rename(fam = X1) %>%
  right_join(x = famsnps_IND, by = 'fam') %>%
  select(-fam)

bimsnps_IND <- read_bim(here('Datos', 'Datos_IND', 'Den_10.000', 'mG', 'mG_1', 'nSNPs_IND.bim'))
famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Den_10.000', 'mG', 'mG_1', 'nSNPs_IND.fam'))
bedsnps_IND <- BEDMatrix(here('Datos', 'Datos_IND', 'Den_10.000', 'mG', 'mG_1', 'nSNPs_IND.bed'), n = length(famsnps_IND$id), p = length(bimsnps_IND$id), simple_names = FALSE)
snps_IND <- as.matrix(bedsnps_IND) # Se importa la matriz de SNPs para los 148 individuos genotipados.

Geno_148 <- snps_IND %>%
  as_tibble() %>%
  bind_cols(ped_IND_148) %>%
  relocate(
    id,
    .before = V1
    ) %>%
  unite(
    'snps',
    V1:V10098,
    sep = '',
    remove = TRUE
    )

Geno_148 %>%
  write_delim(here('Datos', 'Datos_IND', 'Den_10.000', 'mod_BLUPf90', 'Ped_1', '148_ind', 'Geno_148.txt'), delim = ' ', col_names = FALSE)

#### Conjunto de datos del fenotipo ----

lin_mej <- read_delim(here('Datos', 'iris_pedigree.csv'), delim = ',') # Se importan las bases de datos de fenotipos y de linea mejorada.
Fenotipos <- read_delim(here('Datos', 'all.phenotypes.csv'), delim = ',')

Pob_mej <- lin_mej %>%
  filter(Status_with_Pedigree.plus.knowledge == 'I') %>% # Conjunto de datos solo con los individuos mejorados (los que se clasificaron como "I").
  select(X3K_DNA_IRIS_UNIQUE_ID) %>%
  rename(Variety = X3K_DNA_IRIS_UNIQUE_ID)

escalado <- function(x) { # Función usada para escalar el fenotipo.
  (x - mean(x, na.rm = TRUE)) / sd(x, na.rm = TRUE)
  }

Pob_IND <- Fenotipos %>%
  filter(SNPsubsp == 'IND') %>% # Conjunto de datos solo con la especie IND.
  mutate(
    Variety_2 = Variety,
    Fen_escalado = escalado(Time.to.flowering..from.sowing)
    ) %>%
  separate(
    col = Variety,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  ' '
  ) %>%
  unite(
    col = Variety,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  separate(
    col = Variety,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  '-'
  ) %>%
  unite(
    col = Variety,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  separate(
    col = Variety_2,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  ' '
  ) %>%
  unite(
    col = Variety_2,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  inner_join(y = Pob_mej, by = 'Variety') %>%
  select(Variety_2, Fen_escalado) %>% # Se creo el conjunto de datos con los individuos mejorados de la población indica.
  mutate(Fen_escalado = NA) %>% # Los fenotipos de estos individuos se deben colocar como NAs al formar parte de la población de validación cruzada, y al ser los individuos que se quieren predecir.
  rename(Variety = Variety_2)

Pob_IND_2 <- Fenotipos %>%
  filter(SNPsubsp == 'IND') %>% # Conjunto de datos solo con la especie IND.
  mutate(
    Variety_2 = Variety,
    Fen_escalado = escalado(Time.to.flowering..from.sowing)
    ) %>%
  separate(
    col = Variety,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  ' '
  ) %>%
  unite(
    col = Variety,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  separate(
    col = Variety,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  '-'
  ) %>%
  unite(
    col = Variety,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  separate(
    col = Variety_2,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  ' '
  ) %>%
  unite(
    col = Variety_2,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  anti_join(Pob_mej, by = 'Variety') %>%
  select(Variety_2, Fen_escalado) %>% # Se creo el conjunto de datos con los individuos no mejorados de la población indica.
  rename(Variety = Variety_2)

famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'nSNPs_IND.fam')) %>% # Se importa el archivo .fam obtenido usando plink y que posteriomente se uso para crear la hoja de parámetros para ejecutar el software molcoanc.
  select(fam) %>%
  mutate(id = 2001:2451) %>%
  rename(Variety = fam)

Pob_IND_3 <- Pob_IND_2 %>%
  left_join(y = famsnps_IND, by = 'Variety') # Se unen al conjunto de datos anterior (famsnps_IND) debido a que aquí esta la identificación numérica como esta en el pedigrí.

Pob_IND_4 <- Pob_IND %>%
  left_join(y = famsnps_IND, by = 'Variety') %>% # Se unen al conjunto de datos famsnps_IND debido a que aquí esta la identificación numérica como esta en el pedigrí.
  bind_rows(Pob_IND_3) %>% # Se une por filas al conjunto de datos de individuos no mejorados anterior Pob_IND_3.
  select(-Variety) %>%
  relocate(
    Fen_escalado,
    .after = id
    )

Pob_IND_5 <- tibble(
  id = seq(from = 1, to = 2000, by = 1),
  Fen_escalado = rep(x = NA, times = 2000)
  ) %>% # # Se crea un conjunto de datos donde estaran los fenotipos de los individuos con pedigrí simulado mediante el software molcoanc.
  bind_rows(Pob_IND_4) %>% # Se une por filas al conjunto de datos de individuos anterior Pob_IND_4.
  arrange(id) %>%
  mutate(Fen_escalado = replace_na(Fen_escalado, 0))

Pob_IND_5 %>%
  write_delim(here('Datos', 'Datos_IND', 'Den_10.000', 'mod_BLUPf90', 'Ped_1', '148_ind', 'Fenotipo.txt'), delim = ' ', col_names = FALSE)

#### Conjunto de datos de  referencia cruzada (relaciona el id especificado en los archivos de pedigrí y de fenotipos con el id en el archivo de marcador) ----

Ref_cruz <- Geno_148 %>%
  select(id) %>%
  mutate(id_2 = id)

Ref_cruz %>%
  write_delim(here('Datos', 'Datos_IND', 'Den_10.000', 'mod_BLUPf90', 'Ped_1', '148_ind', 'Geno_148_RF.txt'), delim = ' ', col_names = FALSE)


## 2. Subpoblación con 298 individuos genotipados

dir.create('../Datos/Datos_IND/Den_10.000/mod_BLUPf90/Ped_1/298_ind') # Se crea el directorio donde se guardara los distintos conjuntos de datos donde se haga uso de los 298 individuos genotipados.

#### Conjunto de datos del pedigrí ----

ped_1 %>%
  write_delim(here('Datos', 'Datos_IND', 'Den_10.000', 'mod_BLUPf90', 'Ped_1', '298_ind', 'Ped_1.txt'), delim = ' ', col_names = FALSE)

#### Conjunto de datos de genotipos ----

famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'nSNPs_IND.fam')) %>% # Se importa el archivo .fam obtenido usando plink y que posteriomente se uso para crear la hoja de parámetros para ejecutar el software molcoanc.
  select(fam) %>%
  mutate(id = 2001:2451)

ped_IND_298 <- read_delim(here('Datos', 'Datos_IND', 'Den_100.000', 'mG', 'mG_5', 'subpob_IND.txt'), delim = '\t', col_names = FALSE) %>% # Se importa el conjunto de datos donde esta la identificación de los 298 individuos genotipados.
  select(X1) %>%
  rename(fam = X1) %>%
  right_join(x = famsnps_IND, by = 'fam') %>%
  select(-fam)

bimsnps_IND <- read_bim(here('Datos', 'Datos_IND', 'Den_10.000', 'mG', 'mG_2', 'nSNPs_IND.bim'))
famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Den_10.000', 'mG', 'mG_2', 'nSNPs_IND.fam'))
bedsnps_IND <- BEDMatrix(here('Datos', 'Datos_IND', 'Den_10.000', 'mG', 'mG_2', 'nSNPs_IND.bed'), n = length(famsnps_IND$id), p = length(bimsnps_IND$id), simple_names = FALSE)
snps_IND <- as.matrix(bedsnps_IND) # Se importa la matriz de SNPs para los 298 individuos genotipados.

Geno_298 <- snps_IND %>%
  as_tibble() %>%
  bind_cols(ped_IND_298) %>%
  relocate(
    id,
    .before = V1
    ) %>%
  unite(
    'snps',
    V1:V9946,
    sep = '',
    remove = TRUE
    )

Geno_298 %>%
  write_delim(here('Datos', 'Datos_IND', 'Den_10.000', 'mod_BLUPf90', 'Ped_1', '298_ind', 'Geno_298.txt'), delim = ' ', col_names = FALSE)

#### Conjunto de datos del fenotipo ----

Pob_IND_5 %>%
  write_delim(here('Datos', 'Datos_IND', 'Den_10.000', 'mod_BLUPf90', 'Ped_1', '298_ind', 'Fenotipo.txt'), delim = ' ', col_names = FALSE)

#### Conjunto de datos de  referencia cruzada (relaciona el id especificado en los archivos de pedigrí y de fenotipos con el id en el archivo de marcador) ----

Ref_cruz <- Geno_298 %>%
  select(id) %>%
  mutate(id_2 = id)

Ref_cruz %>%
  write_delim(here('Datos', 'Datos_IND', 'Den_10.000', 'mod_BLUPf90', 'Ped_1', '298_ind', 'Geno_298_RF.txt'), delim = ' ', col_names = FALSE)

## 3. Subpoblación con 451 individuos genotipados

dir.create('../Datos/Datos_IND/Den_10.000/mod_BLUPf90/Ped_1/451_ind') # Se crea el directorio donde se guardara los distintos conjuntos de datos donde se haga uso de los 451 individuos genotipados.

#### Conjunto de datos del pedigrí ----

ped_1 %>%
  write_delim(here('Datos', 'Datos_IND', 'Den_10.000', 'mod_BLUPf90', 'Ped_1', '451_ind', 'Ped_1.txt'), delim = ' ', col_names = FALSE)

#### Conjunto de datos de genotipos ----

famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'nSNPs_IND.fam')) %>% # Se importa el archivo .fam obtenido usando plink y que posteriomente se uso para crear la hoja de parámetros para ejecutar el software molcoanc.
  select(fam) %>%
  mutate(id = 2001:2451)

ped_IND_451 <- read_delim(here('Datos', 'Datos_IND', 'Den_100.000', 'mG', 'mG_8', 'subpob_IND.txt'), delim = '\t', col_names = FALSE) %>% # Se importa el conjunto de datos donde esta la identificación de los 451 individuos genotipados.
  select(X1) %>%
  rename(fam = X1) %>%
  right_join(x = famsnps_IND, by = 'fam') %>%
  select(-fam)

bimsnps_IND <- read_bim(here('Datos', 'Datos_IND', 'Den_10.000', 'mG', 'mG_3', 'nSNPs_IND.bim'))
famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Den_10.000', 'mG', 'mG_3', 'nSNPs_IND.fam'))
bedsnps_IND <- BEDMatrix(here('Datos', 'Datos_IND', 'Den_10.000', 'mG', 'mG_3', 'nSNPs_IND.bed'), n = length(famsnps_IND$id), p = length(bimsnps_IND$id), simple_names = FALSE)
snps_IND <- as.matrix(bedsnps_IND) # Se importa la matriz de SNPs para los 451 individuos genotipados.

Geno_451 <- snps_IND %>%
  as_tibble() %>%
  bind_cols(ped_IND_451) %>%
  relocate(
    id,
    .before = V1
    ) %>%
  unite(
    'snps',
    V1:V9843,
    sep = '',
    remove = TRUE
    )

Geno_451 %>%
  write_delim(here('Datos', 'Datos_IND', 'Den_10.000', 'mod_BLUPf90', 'Ped_1', '451_ind', 'Geno_451.txt'), delim = ' ', col_names = FALSE)

#### Conjunto de datos del fenotipo ----

Pob_IND_5 %>%
  write_delim(here('Datos', 'Datos_IND', 'Den_10.000', 'mod_BLUPf90', 'Ped_1', '451_ind', 'Fenotipo.txt'), delim = ' ', col_names = FALSE)

#### Conjunto de datos de  referencia cruzada (relaciona el id especificado en los archivos de pedigrí y de fenotipos con el id en el archivo de marcador) ----

Ref_cruz <- Geno_451 %>%
  select(id) %>%
  mutate(id_2 = id)

Ref_cruz %>%
  write_delim(here('Datos', 'Datos_IND', 'Den_10.000', 'mod_BLUPf90', 'Ped_1', '451_ind', 'Geno_451_RF.txt'), delim = ' ', col_names = FALSE)

#######################################################
# Pedigrí 2: 520 individuos simulados en 4 generaciones
#######################################################

dir.create('../Datos/Datos_IND/Den_10.000/mod_BLUPf90/Ped_2') # Se crea el directorio donde se guardara los distintos conjuntos de datos donde se haga uso del pedigrí 2.

## 1. Subpoblación con 148 individuos genotipados

dir.create('../Datos/Datos_IND/Den_10.000/mod_BLUPf90/Ped_2/148_ind') # Se crea el directorio donde se guardara los distintos conjuntos de datos donde se haga uso de los 148 individuos genotipados.

#### Conjunto de datos del pedigrí ----

ped_2 <- read_delim(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'Molcoanc_13', 'geneal_IND.csv'), delim = ' ')

ped_2 %>%
  write_delim(here('Datos', 'Datos_IND', 'Den_10.000', 'mod_BLUPf90', 'Ped_2', '148_ind', 'Ped_2.txt'), delim = ' ', col_names = FALSE)

#### Conjunto de datos de genotipos ----

famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'nSNPs_IND.fam')) %>% # Se importa el archivo .fam obtenido usando plink y que posteriomente se uso para crear la hoja de parámetros para ejecutar el software molcoanc.
  select(fam) %>%
  mutate(id = 521:971)

ped_IND_148 <- read_delim(here('Datos', 'Datos_IND', 'Den_100.000', 'mG', 'mG_2', 'subpob_IND.txt'), delim = '\t', col_names = FALSE) %>% # Se importa el conjunto de datos donde esta la identificación de los 148 individuos genotipados.
  select(X1) %>%
  rename(fam = X1) %>%
  right_join(x = famsnps_IND, by = 'fam') %>%
  select(-fam)

bimsnps_IND <- read_bim(here('Datos', 'Datos_IND', 'Den_10.000', 'mG', 'mG_1', 'nSNPs_IND.bim'))
famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Den_10.000', 'mG', 'mG_1', 'nSNPs_IND.fam'))
bedsnps_IND <- BEDMatrix(here('Datos', 'Datos_IND', 'Den_10.000', 'mG', 'mG_1', 'nSNPs_IND.bed'), n = length(famsnps_IND$id), p = length(bimsnps_IND$id), simple_names = FALSE)
snps_IND <- as.matrix(bedsnps_IND) # Se importa la matriz de SNPs para los 148 individuos genotipados.

Geno_148 <- snps_IND %>%
  as_tibble() %>%
  bind_cols(ped_IND_148) %>%
  relocate(
    id,
    .before = V1
    ) %>%
  unite(
    'snps',
    V1:V10098,
    sep = '',
    remove = TRUE
    )

Geno_148 %>%
  write_delim(here('Datos', 'Datos_IND', 'Den_10.000', 'mod_BLUPf90', 'Ped_2', '148_ind', 'Geno_148.txt'), delim = ' ', col_names = FALSE)

#### Conjunto de datos del fenotipo ----

lin_mej <- read_delim(here('Datos', 'iris_pedigree.csv'), delim = ',') # Se importan las bases de datos de fenotipos y de linea mejorada.
Fenotipos <- read_delim(here('Datos', 'all.phenotypes.csv'), delim = ',')

Pob_mej <- lin_mej %>%
  filter(Status_with_Pedigree.plus.knowledge == 'I') %>% # Conjunto de datos solo con los individuos mejorados (los que se clasificaron como "I").
  select(X3K_DNA_IRIS_UNIQUE_ID) %>%
  rename(Variety = X3K_DNA_IRIS_UNIQUE_ID)

escalado <- function(x) { # Función usada para escalar el fenotipo.
  (x - mean(x, na.rm = TRUE)) / sd(x, na.rm = TRUE)
  }

Pob_IND <- Fenotipos %>%
  filter(SNPsubsp == 'IND') %>% # Conjunto de datos solo con la especie IND.
  mutate(
    Variety_2 = Variety,
    Fen_escalado = escalado(Time.to.flowering..from.sowing)
    ) %>%
  separate(
    col = Variety,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  ' '
  ) %>%
  unite(
    col = Variety,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  separate(
    col = Variety,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  '-'
  ) %>%
  unite(
    col = Variety,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  separate(
    col = Variety_2,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  ' '
  ) %>%
  unite(
    col = Variety_2,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  inner_join(y = Pob_mej, by = 'Variety') %>%
  select(Variety_2, Fen_escalado) %>% # Se creo el conjunto de datos con los individuos mejorados de la población indica.
  mutate(Fen_escalado = NA) %>% # Los fenotipos de estos individuos se deben colocar como NAs al formar parte de la población de validación cruzada, y al ser los individuos que se quieren predecir.
  rename(Variety = Variety_2)

Pob_IND_2 <- Fenotipos %>%
  filter(SNPsubsp == 'IND') %>% # Conjunto de datos solo con la especie IND.
  mutate(
    Variety_2 = Variety,
    Fen_escalado = escalado(Time.to.flowering..from.sowing)
    ) %>%
  separate(
    col = Variety,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  ' '
  ) %>%
  unite(
    col = Variety,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  separate(
    col = Variety,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  '-'
  ) %>%
  unite(
    col = Variety,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  separate(
    col = Variety_2,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  ' '
  ) %>%
  unite(
    col = Variety_2,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  anti_join(Pob_mej, by = 'Variety') %>%
  select(Variety_2, Fen_escalado) %>% # Se creo el conjunto de datos con los individuos no mejorados de la población indica.
  rename(Variety = Variety_2)

famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'nSNPs_IND.fam')) %>% # Se importa el archivo .fam obtenido usando plink y que posteriomente se uso para crear la hoja de parámetros para ejecutar el software molcoanc.
  select(fam) %>%
  mutate(id = 521:971) %>%
  rename(Variety = fam)

Pob_IND_3 <- Pob_IND_2 %>%
  left_join(y = famsnps_IND, by = 'Variety') # Se unen al conjunto de datos anterior (famsnps_IND) debido a que aquí esta la identificación numérica como esta en el pedigrí.

Pob_IND_4 <- Pob_IND %>%
  left_join(y = famsnps_IND, by = 'Variety') %>% # Se unen al conjunto de datos famsnps_IND debido a que aquí esta la identificación numérica como esta en el pedigrí.
  bind_rows(Pob_IND_3) %>% # Se une por filas al conjunto de datos de individuos no mejorados anterior Pob_IND_3.
  select(-Variety) %>%
  relocate(
    Fen_escalado,
    .after = id
    )

Pob_IND_5 <- tibble(
  id = seq(from = 1, to = 520, by = 1),
  Fen_escalado = rep(x = NA, times = 520)
  ) %>% # # Se crea un conjunto de datos donde estaran los fenotipos de los individuos con pedigrí simulado mediante el software molcoanc.
  bind_rows(Pob_IND_4) %>% # Se une por filas al conjunto de datos de individuos anterior Pob_IND_4.
  arrange(id) %>%
  mutate(Fen_escalado = replace_na(Fen_escalado, 0))

Pob_IND_5 %>%
  write_delim(here('Datos', 'Datos_IND', 'Den_10.000', 'mod_BLUPf90', 'Ped_2', '148_ind', 'Fenotipo.txt'), delim = ' ', col_names = FALSE)

#### Conjunto de datos de  referencia cruzada (relaciona el id especificado en los archivos de pedigrí y de fenotipos con el id en el archivo de marcador) ----

Ref_cruz <- Geno_148 %>%
  select(id) %>%
  mutate(id_2 = id)

Ref_cruz %>%
  write_delim(here('Datos', 'Datos_IND', 'Den_10.000', 'mod_BLUPf90', 'Ped_2', '148_ind', 'Geno_148_RF.txt'), delim = ' ', col_names = FALSE)

## 2. Subpoblación con 298 individuos genotipados

dir.create('../Datos/Datos_IND/Den_10.000/mod_BLUPf90/Ped_2/298_ind') # Se crea el directorio donde se guardara los distintos conjuntos de datos donde se haga uso de los 298 individuos genotipados.

#### Conjunto de datos del pedigrí ----

ped_2 %>%
  write_delim(here('Datos', 'Datos_IND', 'Den_10.000', 'mod_BLUPf90', 'Ped_2', '298_ind', 'Ped_2.txt'), delim = ' ', col_names = FALSE)

#### Conjunto de datos de genotipos ----

famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'nSNPs_IND.fam')) %>% # Se importa el archivo .fam obtenido usando plink y que posteriomente se uso para crear la hoja de parámetros para ejecutar el software molcoanc.
  select(fam) %>%
  mutate(id = 521:971)

ped_IND_298 <- read_delim(here('Datos', 'Datos_IND', 'Den_100.000', 'mG', 'mG_5', 'subpob_IND.txt'), delim = '\t', col_names = FALSE) %>% # Se importa el conjunto de datos donde esta la identificación de los 298 individuos genotipados.
  select(X1) %>%
  rename(fam = X1) %>%
  right_join(x = famsnps_IND, by = 'fam') %>%
  select(-fam)

bimsnps_IND <- read_bim(here('Datos', 'Datos_IND', 'Den_10.000', 'mG', 'mG_2', 'nSNPs_IND.bim'))
famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Den_10.000', 'mG', 'mG_2', 'nSNPs_IND.fam'))
bedsnps_IND <- BEDMatrix(here('Datos', 'Datos_IND', 'Den_10.000', 'mG', 'mG_2', 'nSNPs_IND.bed'), n = length(famsnps_IND$id), p = length(bimsnps_IND$id), simple_names = FALSE)
snps_IND <- as.matrix(bedsnps_IND) # Se importa la matriz de SNPs para los 298 individuos genotipados.

Geno_298 <- snps_IND %>%
  as_tibble() %>%
  bind_cols(ped_IND_298) %>%
  relocate(
    id,
    .before = V1
    ) %>%
  unite(
    'snps',
    V1:V9946,
    sep = '',
    remove = TRUE
    )

Geno_298 %>%
  write_delim(here('Datos', 'Datos_IND', 'Den_10.000', 'mod_BLUPf90', 'Ped_2', '298_ind', 'Geno_298.txt'), delim = ' ', col_names = FALSE)

#### Conjunto de datos del fenotipo ----

Pob_IND_5 %>%
  write_delim(here('Datos', 'Datos_IND', 'Den_10.000', 'mod_BLUPf90', 'Ped_2', '298_ind', 'Fenotipo.txt'), delim = ' ', col_names = FALSE)

#### Conjunto de datos de  referencia cruzada (relaciona el id especificado en los archivos de pedigrí y de fenotipos con el id en el archivo de marcador) ----

Ref_cruz <- Geno_298 %>%
  select(id) %>%
  mutate(id_2 = id)

Ref_cruz %>%
  write_delim(here('Datos', 'Datos_IND', 'Den_10.000', 'mod_BLUPf90', 'Ped_2', '298_ind', 'Geno_298_RF.txt'), delim = ' ', col_names = FALSE)

## 3. Subpoblación con 451 individuos genotipados

dir.create('../Datos/Datos_IND/Den_10.000/mod_BLUPf90/Ped_2/451_ind') # Se crea el directorio donde se guardara los distintos conjuntos de datos donde se haga uso de los 451 individuos genotipados.

#### Conjunto de datos del pedigrí ----

ped_2 %>%
  write_delim(here('Datos', 'Datos_IND', 'Den_10.000', 'mod_BLUPf90', 'Ped_2', '451_ind', 'Ped_2.txt'), delim = ' ', col_names = FALSE)

#### Conjunto de datos de genotipos ----

famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'nSNPs_IND.fam')) %>% # Se importa el archivo .fam obtenido usando plink y que posteriomente se uso para crear la hoja de parámetros para ejecutar el software molcoanc.
  select(fam) %>%
  mutate(id = 521:971)

ped_IND_451 <- read_delim(here('Datos', 'Datos_IND', 'Den_100.000', 'mG', 'mG_8', 'subpob_IND.txt'), delim = '\t', col_names = FALSE) %>% # Se importa el conjunto de datos donde esta la identificación de los 451 individuos genotipados.
  select(X1) %>%
  rename(fam = X1) %>%
  right_join(x = famsnps_IND, by = 'fam') %>%
  select(-fam)

bimsnps_IND <- read_bim(here('Datos', 'Datos_IND', 'Den_10.000', 'mG', 'mG_3', 'nSNPs_IND.bim'))
famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Den_10.000', 'mG', 'mG_3', 'nSNPs_IND.fam'))
bedsnps_IND <- BEDMatrix(here('Datos', 'Datos_IND', 'Den_10.000', 'mG', 'mG_3', 'nSNPs_IND.bed'), n = length(famsnps_IND$id), p = length(bimsnps_IND$id), simple_names = FALSE)
snps_IND <- as.matrix(bedsnps_IND) # Se importa la matriz de SNPs para los 451 individuos genotipados.

Geno_451 <- snps_IND %>%
  as_tibble() %>%
  bind_cols(ped_IND_451) %>%
  relocate(
    id,
    .before = V1
    ) %>%
  unite(
    'snps',
    V1:V9843,
    sep = '',
    remove = TRUE
    )

Geno_451 %>%
  write_delim(here('Datos', 'Datos_IND', 'Den_10.000', 'mod_BLUPf90', 'Ped_2', '451_ind', 'Geno_451.txt'), delim = ' ', col_names = FALSE)

#### Conjunto de datos del fenotipo ----

Pob_IND_5 %>%
  write_delim(here('Datos', 'Datos_IND', 'Den_10.000', 'mod_BLUPf90', 'Ped_2', '451_ind', 'Fenotipo.txt'), delim = ' ', col_names = FALSE)

#### Conjunto de datos de  referencia cruzada (relaciona el id especificado en los archivos de pedigrí y de fenotipos con el id en el archivo de marcador) ----

Ref_cruz <- Geno_451 %>%
  select(id) %>%
  mutate(id_2 = id)

Ref_cruz %>%
  write_delim(here('Datos', 'Datos_IND', 'Den_10.000', 'mod_BLUPf90', 'Ped_2', '451_ind', 'Geno_451_RF.txt'), delim = ' ', col_names = FALSE)


########################################################
# Pedigrí 3: 1210 individuos simulados en 7 generaciones
########################################################

dir.create('../Datos/Datos_IND/Den_10.000/mod_BLUPf90/Ped_3') # Se crea el directorio donde se guardara los distintos conjuntos de datos donde se haga uso del pedigrí 3.

## 1. Subpoblación con 148 individuos genotipados

dir.create('../Datos/Datos_IND/Den_10.000/mod_BLUPf90/Ped_3/148_ind') # Se crea el directorio donde se guardara los distintos conjuntos de datos donde se haga uso de los 148 individuos genotipados.

#### Conjunto de datos del pedigrí ----

ped_3 <- read_delim(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'Molcoanc_14', 'geneal_IND.csv'), delim = ' ')

ped_3 %>%
  write_delim(here('Datos', 'Datos_IND', 'Den_10.000', 'mod_BLUPf90', 'Ped_3', '148_ind', 'Ped_3.txt'), delim = ' ', col_names = FALSE)

#### Conjunto de datos de genotipos ----

famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'nSNPs_IND.fam')) %>% # Se importa el archivo .fam obtenido usando plink y que posteriomente se uso para crear la hoja de parámetros para ejecutar el software molcoanc.
  select(fam) %>%
  mutate(id = 1211:1661)

ped_IND_148 <- read_delim(here('Datos', 'Datos_IND', 'Den_100.000', 'mG', 'mG_2', 'subpob_IND.txt'), delim = '\t', col_names = FALSE) %>% # Se importa el conjunto de datos donde esta la identificación de los 148 individuos genotipados.
  select(X1) %>%
  rename(fam = X1) %>%
  right_join(x = famsnps_IND, by = 'fam') %>%
  select(-fam)

bimsnps_IND <- read_bim(here('Datos', 'Datos_IND', 'Den_10.000', 'mG', 'mG_1', 'nSNPs_IND.bim'))
famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Den_10.000', 'mG', 'mG_1', 'nSNPs_IND.fam'))
bedsnps_IND <- BEDMatrix(here('Datos', 'Datos_IND', 'Den_10.000', 'mG', 'mG_1', 'nSNPs_IND.bed'), n = length(famsnps_IND$id), p = length(bimsnps_IND$id), simple_names = FALSE)
snps_IND <- as.matrix(bedsnps_IND) # Se importa la matriz de SNPs para los 148 individuos genotipados.

Geno_148 <- snps_IND %>%
  as_tibble() %>%
  bind_cols(ped_IND_148) %>%
  relocate(
    id,
    .before = V1
    ) %>%
  unite(
    'snps',
    V1:V10098,
    sep = '',
    remove = TRUE
    )

Geno_148 %>%
  write_delim(here('Datos', 'Datos_IND', 'Den_10.000', 'mod_BLUPf90', 'Ped_3', '148_ind', 'Geno_148.txt'), delim = ' ', col_names = FALSE)

#### Conjunto de datos del fenotipo ----

lin_mej <- read_delim(here('Datos', 'iris_pedigree.csv'), delim = ',') # Se importan las bases de datos de fenotipos y de linea mejorada.
Fenotipos <- read_delim(here('Datos', 'all.phenotypes.csv'), delim = ',')

Pob_mej <- lin_mej %>%
  filter(Status_with_Pedigree.plus.knowledge == 'I') %>% # Conjunto de datos solo con los individuos mejorados (los que se clasificaron como "I").
  select(X3K_DNA_IRIS_UNIQUE_ID) %>%
  rename(Variety = X3K_DNA_IRIS_UNIQUE_ID)

escalado <- function(x) { # Función usada para escalar el fenotipo.
  (x - mean(x, na.rm = TRUE)) / sd(x, na.rm = TRUE)
  }

Pob_IND <- Fenotipos %>%
  filter(SNPsubsp == 'IND') %>% # Conjunto de datos solo con la especie IND.
  mutate(
    Variety_2 = Variety,
    Fen_escalado = escalado(Time.to.flowering..from.sowing)
    ) %>%
  separate(
    col = Variety,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  ' '
  ) %>%
  unite(
    col = Variety,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  separate(
    col = Variety,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  '-'
  ) %>%
  unite(
    col = Variety,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  separate(
    col = Variety_2,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  ' '
  ) %>%
  unite(
    col = Variety_2,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  inner_join(y = Pob_mej, by = 'Variety') %>%
  select(Variety_2, Fen_escalado) %>% # Se creo el conjunto de datos con los individuos mejorados de la población indica.
  mutate(Fen_escalado = NA) %>% # Los fenotipos de estos individuos se deben colocar como NAs al formar parte de la población de validación cruzada, y al ser los individuos que se quieren predecir.
  rename(Variety = Variety_2)

Pob_IND_2 <- Fenotipos %>%
  filter(SNPsubsp == 'IND') %>% # Conjunto de datos solo con la especie IND.
  mutate(
    Variety_2 = Variety,
    Fen_escalado = escalado(Time.to.flowering..from.sowing)
    ) %>%
  separate(
    col = Variety,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  ' '
  ) %>%
  unite(
    col = Variety,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  separate(
    col = Variety,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  '-'
  ) %>%
  unite(
    col = Variety,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  separate(
    col = Variety_2,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  ' '
  ) %>%
  unite(
    col = Variety_2,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  anti_join(Pob_mej, by = 'Variety') %>%
  select(Variety_2, Fen_escalado) %>% # Se creo el conjunto de datos con los individuos no mejorados de la población indica.
  rename(Variety = Variety_2)

famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'nSNPs_IND.fam')) %>% # Se importa el archivo .fam obtenido usando plink y que posteriomente se uso para crear la hoja de parámetros para ejecutar el software molcoanc.
  select(fam) %>%
  mutate(id = 1211:1661) %>%
  rename(Variety = fam)

Pob_IND_3 <- Pob_IND_2 %>%
  left_join(y = famsnps_IND, by = 'Variety') # Se unen al conjunto de datos anterior (famsnps_IND) debido a que aquí esta la identificación numérica como esta en el pedigrí.

Pob_IND_4 <- Pob_IND %>%
  left_join(y = famsnps_IND, by = 'Variety') %>% # Se unen al conjunto de datos famsnps_IND debido a que aquí esta la identificación numérica como esta en el pedigrí.
  bind_rows(Pob_IND_3) %>% # Se une por filas al conjunto de datos de individuos no mejorados anterior Pob_IND_3.
  select(-Variety) %>%
  relocate(
    Fen_escalado,
    .after = id
    )

Pob_IND_5 <- tibble(
  id = seq(from = 1, to = 1210, by = 1),
  Fen_escalado = rep(x = NA, times = 1210)
  ) %>% # # Se crea un conjunto de datos donde estaran los fenotipos de los individuos con pedigrí simulado mediante el software molcoanc.
  bind_rows(Pob_IND_4) %>% # Se une por filas al conjunto de datos de individuos anterior Pob_IND_4.
  arrange(id) %>%
  mutate(Fen_escalado = replace_na(Fen_escalado, 0))

Pob_IND_5 %>%
  write_delim(here('Datos', 'Datos_IND', 'Den_10.000', 'mod_BLUPf90', 'Ped_3', '148_ind', 'Fenotipo.txt'), delim = ' ', col_names = FALSE)

#### Conjunto de datos de  referencia cruzada (relaciona el id especificado en los archivos de pedigrí y de fenotipos con el id en el archivo de marcador) ----

Ref_cruz <- Geno_148 %>%
  select(id) %>%
  mutate(id_2 = id)

Ref_cruz %>%
  write_delim(here('Datos', 'Datos_IND', 'Den_10.000', 'mod_BLUPf90', 'Ped_3', '148_ind', 'Geno_148_RF.txt'), delim = ' ', col_names = FALSE)

## 2. Subpoblación con 298 individuos genotipados

dir.create('../Datos/Datos_IND/Den_10.000/mod_BLUPf90/Ped_3/298_ind') # Se crea el directorio donde se guardara los distintos conjuntos de datos donde se haga uso de los 298 individuos genotipados.

#### Conjunto de datos del pedigrí ----

ped_3 %>%
  write_delim(here('Datos', 'Datos_IND', 'Den_10.000', 'mod_BLUPf90', 'Ped_3', '298_ind', 'Ped_3.txt'), delim = ' ', col_names = FALSE)

#### Conjunto de datos de genotipos ----

famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'nSNPs_IND.fam')) %>% # Se importa el archivo .fam obtenido usando plink y que posteriomente se uso para crear la hoja de parámetros para ejecutar el software molcoanc.
  select(fam) %>%
  mutate(id = 1211:1661)

ped_IND_298 <- read_delim(here('Datos', 'Datos_IND', 'Den_100.000', 'mG', 'mG_5', 'subpob_IND.txt'), delim = '\t', col_names = FALSE) %>% # Se importa el conjunto de datos donde esta la identificación de los 298 individuos genotipados.
  select(X1) %>%
  rename(fam = X1) %>%
  right_join(x = famsnps_IND, by = 'fam') %>%
  select(-fam)

bimsnps_IND <- read_bim(here('Datos', 'Datos_IND', 'Den_10.000', 'mG', 'mG_2', 'nSNPs_IND.bim'))
famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Den_10.000', 'mG', 'mG_2', 'nSNPs_IND.fam'))
bedsnps_IND <- BEDMatrix(here('Datos', 'Datos_IND', 'Den_10.000', 'mG', 'mG_2', 'nSNPs_IND.bed'), n = length(famsnps_IND$id), p = length(bimsnps_IND$id), simple_names = FALSE)
snps_IND <- as.matrix(bedsnps_IND) # Se importa la matriz de SNPs para los 298 individuos genotipados.

Geno_298 <- snps_IND %>%
  as_tibble() %>%
  bind_cols(ped_IND_298) %>%
  relocate(
    id,
    .before = V1
    ) %>%
  unite(
    'snps',
    V1:V9946,
    sep = '',
    remove = TRUE
    )

Geno_298 %>%
  write_delim(here('Datos', 'Datos_IND', 'Den_10.000', 'mod_BLUPf90', 'Ped_3', '298_ind', 'Geno_298.txt'), delim = ' ', col_names = FALSE)

#### Conjunto de datos del fenotipo ----

Pob_IND_5 %>%
  write_delim(here('Datos', 'Datos_IND', 'Den_10.000', 'mod_BLUPf90', 'Ped_3', '298_ind', 'Fenotipo.txt'), delim = ' ', col_names = FALSE)

#### Conjunto de datos de  referencia cruzada (relaciona el id especificado en los archivos de pedigrí y de fenotipos con el id en el archivo de marcador) ----

Ref_cruz <- Geno_298 %>%
  select(id) %>%
  mutate(id_2 = id)

Ref_cruz %>%
  write_delim(here('Datos', 'Datos_IND', 'Den_10.000', 'mod_BLUPf90', 'Ped_3', '298_ind', 'Geno_298_RF.txt'), delim = ' ', col_names = FALSE)

## 3. Subpoblación con 451 individuos genotipados

dir.create('../Datos/Datos_IND/Den_10.000/mod_BLUPf90/Ped_3/451_ind') # Se crea el directorio donde se guardara los distintos conjuntos de datos donde se haga uso de los 451 individuos genotipados.

#### Conjunto de datos del pedigrí ----

ped_3 %>%
  write_delim(here('Datos', 'Datos_IND', 'Den_10.000', 'mod_BLUPf90', 'Ped_3', '451_ind', 'Ped_3.txt'), delim = ' ', col_names = FALSE)

#### Conjunto de datos de genotipos ----

famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'nSNPs_IND.fam')) %>% # Se importa el archivo .fam obtenido usando plink y que posteriomente se uso para crear la hoja de parámetros para ejecutar el software molcoanc.
  select(fam) %>%
  mutate(id = 1211:1661)

ped_IND_451 <- read_delim(here('Datos', 'Datos_IND', 'Den_100.000', 'mG', 'mG_8', 'subpob_IND.txt'), delim = '\t', col_names = FALSE) %>% # Se importa el conjunto de datos donde esta la identificación de los 451 individuos genotipados.
  select(X1) %>%
  rename(fam = X1) %>%
  right_join(x = famsnps_IND, by = 'fam') %>%
  select(-fam)

bimsnps_IND <- read_bim(here('Datos', 'Datos_IND', 'Den_10.000', 'mG', 'mG_3', 'nSNPs_IND.bim'))
famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Den_10.000', 'mG', 'mG_3', 'nSNPs_IND.fam'))
bedsnps_IND <- BEDMatrix(here('Datos', 'Datos_IND', 'Den_10.000', 'mG', 'mG_3', 'nSNPs_IND.bed'), n = length(famsnps_IND$id), p = length(bimsnps_IND$id), simple_names = FALSE)
snps_IND <- as.matrix(bedsnps_IND) # Se importa la matriz de SNPs para los 451 individuos genotipados.

Geno_451 <- snps_IND %>%
  as_tibble() %>%
  bind_cols(ped_IND_451) %>%
  relocate(
    id,
    .before = V1
    ) %>%
  unite(
    'snps',
    V1:V9843,
    sep = '',
    remove = TRUE
    )

Geno_451 %>%
  write_delim(here('Datos', 'Datos_IND', 'Den_10.000', 'mod_BLUPf90', 'Ped_3', '451_ind', 'Geno_451.txt'), delim = ' ', col_names = FALSE)

#### Conjunto de datos del fenotipo ----

Pob_IND_5 %>%
  write_delim(here('Datos', 'Datos_IND', 'Den_10.000', 'mod_BLUPf90', 'Ped_3', '451_ind', 'Fenotipo.txt'), delim = ' ', col_names = FALSE)

#### Conjunto de datos de  referencia cruzada (relaciona el id especificado en los archivos de pedigrí y de fenotipos con el id en el archivo de marcador) ----

Ref_cruz <- Geno_451 %>%
  select(id) %>%
  mutate(id_2 = id)

Ref_cruz %>%
  write_delim(here('Datos', 'Datos_IND', 'Den_10.000', 'mod_BLUPf90', 'Ped_3', '451_ind', 'Geno_451_RF.txt'), delim = ' ', col_names = FALSE)

#######################################################
# Pedigrí 4: 300 individuos simulados en 3 generaciones
#######################################################

dir.create('../Datos/Datos_IND/Den_10.000/mod_BLUPf90/Ped_4') # Se crea el directorio donde se guardara los distintos conjuntos de datos donde se haga uso del pedigrí 4.

## 1. Subpoblación con 148 individuos genotipados

dir.create('../Datos/Datos_IND/Den_10.000/mod_BLUPf90/Ped_4/148_ind') # Se crea el directorio donde se guardara los distintos conjuntos de datos donde se haga uso de los 148 individuos genotipados.

#### Conjunto de datos del pedigrí ----

ped_4 <- read_delim(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'Molcoanc_15', 'geneal_IND.csv'), delim = ' ')

ped_4 %>%
  write_delim(here('Datos', 'Datos_IND', 'Den_10.000', 'mod_BLUPf90', 'Ped_4', '148_ind', 'Ped_4.txt'), delim = ' ', col_names = FALSE)

#### Conjunto de datos de genotipos ----

famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'nSNPs_IND.fam')) %>% # Se importa el archivo .fam obtenido usando plink y que posteriomente se uso para crear la hoja de parámetros para ejecutar el software molcoanc.
  select(fam) %>%
  mutate(id = 301:751)

ped_IND_148 <- read_delim(here('Datos', 'Datos_IND', 'Den_100.000', 'mG', 'mG_2', 'subpob_IND.txt'), delim = '\t', col_names = FALSE) %>% # Se importa el conjunto de datos donde esta la identificación de los 148 individuos genotipados.
  select(X1) %>%
  rename(fam = X1) %>%
  right_join(x = famsnps_IND, by = 'fam') %>%
  select(-fam)

bimsnps_IND <- read_bim(here('Datos', 'Datos_IND', 'Den_10.000', 'mG', 'mG_1', 'nSNPs_IND.bim'))
famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Den_10.000', 'mG', 'mG_1', 'nSNPs_IND.fam'))
bedsnps_IND <- BEDMatrix(here('Datos', 'Datos_IND', 'Den_10.000', 'mG', 'mG_1', 'nSNPs_IND.bed'), n = length(famsnps_IND$id), p = length(bimsnps_IND$id), simple_names = FALSE)
snps_IND <- as.matrix(bedsnps_IND) # Se importa la matriz de SNPs para los 148 individuos genotipados.

Geno_148 <- snps_IND %>%
  as_tibble() %>%
  bind_cols(ped_IND_148) %>%
  relocate(
    id,
    .before = V1
    ) %>%
  unite(
    'snps',
    V1:V10098,
    sep = '',
    remove = TRUE
    )

Geno_148 %>%
  write_delim(here('Datos', 'Datos_IND', 'Den_10.000', 'mod_BLUPf90', 'Ped_4', '148_ind', 'Geno_148.txt'), delim = ' ', col_names = FALSE)

#### Conjunto de datos del fenotipo ----

lin_mej <- read_delim(here('Datos', 'iris_pedigree.csv'), delim = ',') # Se importan las bases de datos de fenotipos y de linea mejorada.
Fenotipos <- read_delim(here('Datos', 'all.phenotypes.csv'), delim = ',')

Pob_mej <- lin_mej %>%
  filter(Status_with_Pedigree.plus.knowledge == 'I') %>% # Conjunto de datos solo con los individuos mejorados (los que se clasificaron como "I").
  select(X3K_DNA_IRIS_UNIQUE_ID) %>%
  rename(Variety = X3K_DNA_IRIS_UNIQUE_ID)

escalado <- function(x) { # Función usada para escalar el fenotipo.
  (x - mean(x, na.rm = TRUE)) / sd(x, na.rm = TRUE)
  }

Pob_IND <- Fenotipos %>%
  filter(SNPsubsp == 'IND') %>% # Conjunto de datos solo con la especie IND.
  mutate(
    Variety_2 = Variety,
    Fen_escalado = escalado(Time.to.flowering..from.sowing)
    ) %>%
  separate(
    col = Variety,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  ' '
  ) %>%
  unite(
    col = Variety,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  separate(
    col = Variety,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  '-'
  ) %>%
  unite(
    col = Variety,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  separate(
    col = Variety_2,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  ' '
  ) %>%
  unite(
    col = Variety_2,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  inner_join(y = Pob_mej, by = 'Variety') %>%
  select(Variety_2, Fen_escalado) %>% # Se creo el conjunto de datos con los individuos mejorados de la población indica.
  mutate(Fen_escalado = NA) %>% # Los fenotipos de estos individuos se deben colocar como NAs al formar parte de la población de validación cruzada, y al ser los individuos que se quieren predecir.
  rename(Variety = Variety_2)

Pob_IND_2 <- Fenotipos %>%
  filter(SNPsubsp == 'IND') %>% # Conjunto de datos solo con la especie IND.
  mutate(
    Variety_2 = Variety,
    Fen_escalado = escalado(Time.to.flowering..from.sowing)
    ) %>%
  separate(
    col = Variety,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  ' '
  ) %>%
  unite(
    col = Variety,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  separate(
    col = Variety,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  '-'
  ) %>%
  unite(
    col = Variety,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  separate(
    col = Variety_2,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  ' '
  ) %>%
  unite(
    col = Variety_2,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  anti_join(Pob_mej, by = 'Variety') %>%
  select(Variety_2, Fen_escalado) %>% # Se creo el conjunto de datos con los individuos no mejorados de la población indica.
  rename(Variety = Variety_2)

famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'nSNPs_IND.fam')) %>% # Se importa el archivo .fam obtenido usando plink y que posteriomente se uso para crear la hoja de parámetros para ejecutar el software molcoanc.
  select(fam) %>%
  mutate(id = 301:751) %>%
  rename(Variety = fam)

Pob_IND_3 <- Pob_IND_2 %>%
  left_join(y = famsnps_IND, by = 'Variety') # Se unen al conjunto de datos anterior (famsnps_IND) debido a que aquí esta la identificación numérica como esta en el pedigrí.

Pob_IND_4 <- Pob_IND %>%
  left_join(y = famsnps_IND, by = 'Variety') %>% # Se unen al conjunto de datos famsnps_IND debido a que aquí esta la identificación numérica como esta en el pedigrí.
  bind_rows(Pob_IND_3) %>% # Se une por filas al conjunto de datos de individuos no mejorados anterior Pob_IND_3.
  select(-Variety) %>%
  relocate(
    Fen_escalado,
    .after = id
    )

Pob_IND_5 <- tibble(
  id = seq(from = 1, to = 300, by = 1),
  Fen_escalado = rep(x = NA, times = 300)
  ) %>% # # Se crea un conjunto de datos donde estaran los fenotipos de los individuos con pedigrí simulado mediante el software molcoanc.
  bind_rows(Pob_IND_4) %>% # Se une por filas al conjunto de datos de individuos anterior Pob_IND_4.
  arrange(id) %>%
  mutate(Fen_escalado = replace_na(Fen_escalado, 0))

Pob_IND_5 %>%
  write_delim(here('Datos', 'Datos_IND', 'Den_10.000', 'mod_BLUPf90', 'Ped_4', '148_ind', 'Fenotipo.txt'), delim = ' ', col_names = FALSE)

#### Conjunto de datos de  referencia cruzada (relaciona el id especificado en los archivos de pedigrí y de fenotipos con el id en el archivo de marcador) ----

Ref_cruz <- Geno_148 %>%
  select(id) %>%
  mutate(id_2 = id)

Ref_cruz %>%
  write_delim(here('Datos', 'Datos_IND', 'Den_10.000', 'mod_BLUPf90', 'Ped_4', '148_ind', 'Geno_148_RF.txt'), delim = ' ', col_names = FALSE)

## 2. Subpoblación con 298 individuos genotipados

dir.create('../Datos/Datos_IND/Den_10.000/mod_BLUPf90/Ped_4/298_ind') # Se crea el directorio donde se guardara los distintos conjuntos de datos donde se haga uso de los 298 individuos genotipados.

#### Conjunto de datos del pedigrí ----

ped_4 %>%
  write_delim(here('Datos', 'Datos_IND', 'Den_10.000', 'mod_BLUPf90', 'Ped_4', '298_ind', 'Ped_4.txt'), delim = ' ', col_names = FALSE)

#### Conjunto de datos de genotipos ----

famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'nSNPs_IND.fam')) %>% # Se importa el archivo .fam obtenido usando plink y que posteriomente se uso para crear la hoja de parámetros para ejecutar el software molcoanc.
  select(fam) %>%
  mutate(id = 301:751)

ped_IND_298 <- read_delim(here('Datos', 'Datos_IND', 'Den_100.000', 'mG', 'mG_5', 'subpob_IND.txt'), delim = '\t', col_names = FALSE) %>% # Se importa el conjunto de datos donde esta la identificación de los 298 individuos genotipados.
  select(X1) %>%
  rename(fam = X1) %>%
  right_join(x = famsnps_IND, by = 'fam') %>%
  select(-fam)

bimsnps_IND <- read_bim(here('Datos', 'Datos_IND', 'Den_10.000', 'mG', 'mG_2', 'nSNPs_IND.bim'))
famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Den_10.000', 'mG', 'mG_2', 'nSNPs_IND.fam'))
bedsnps_IND <- BEDMatrix(here('Datos', 'Datos_IND', 'Den_10.000', 'mG', 'mG_2', 'nSNPs_IND.bed'), n = length(famsnps_IND$id), p = length(bimsnps_IND$id), simple_names = FALSE)
snps_IND <- as.matrix(bedsnps_IND) # Se importa la matriz de SNPs para los 298 individuos genotipados.

Geno_298 <- snps_IND %>%
  as_tibble() %>%
  bind_cols(ped_IND_298) %>%
  relocate(
    id,
    .before = V1
    ) %>%
  unite(
    'snps',
    V1:V9946,
    sep = '',
    remove = TRUE
    )

Geno_298 %>%
  write_delim(here('Datos', 'Datos_IND', 'Den_10.000', 'mod_BLUPf90', 'Ped_4', '298_ind', 'Geno_298.txt'), delim = ' ', col_names = FALSE)

#### Conjunto de datos del fenotipo ----

Pob_IND_5 %>%
  write_delim(here('Datos', 'Datos_IND', 'Den_10.000', 'mod_BLUPf90', 'Ped_4', '298_ind', 'Fenotipo.txt'), delim = ' ', col_names = FALSE)

#### Conjunto de datos de  referencia cruzada (relaciona el id especificado en los archivos de pedigrí y de fenotipos con el id en el archivo de marcador) ----

Ref_cruz <- Geno_298 %>%
  select(id) %>%
  mutate(id_2 = id)

Ref_cruz %>%
  write_delim(here('Datos', 'Datos_IND', 'Den_10.000', 'mod_BLUPf90', 'Ped_4', '298_ind', 'Geno_298_RF.txt'), delim = ' ', col_names = FALSE)

## 3. Subpoblación con 451 individuos genotipados

dir.create('../Datos/Datos_IND/Den_10.000/mod_BLUPf90/Ped_4/451_ind') # Se crea el directorio donde se guardara los distintos conjuntos de datos donde se haga uso de los 451 individuos genotipados.

#### Conjunto de datos del pedigrí ----

ped_4 %>%
  write_delim(here('Datos', 'Datos_IND', 'Den_10.000', 'mod_BLUPf90', 'Ped_4', '451_ind', 'Ped_4.txt'), delim = ' ', col_names = FALSE)

#### Conjunto de datos de genotipos ----

famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'nSNPs_IND.fam')) %>% # Se importa el archivo .fam obtenido usando plink y que posteriomente se uso para crear la hoja de parámetros para ejecutar el software molcoanc.
  select(fam) %>%
  mutate(id = 301:751)

ped_IND_451 <- read_delim(here('Datos', 'Datos_IND', 'Den_100.000', 'mG', 'mG_8', 'subpob_IND.txt'), delim = '\t', col_names = FALSE) %>% # Se importa el conjunto de datos donde esta la identificación de los 451 individuos genotipados.
  select(X1) %>%
  rename(fam = X1) %>%
  right_join(x = famsnps_IND, by = 'fam') %>%
  select(-fam)

bimsnps_IND <- read_bim(here('Datos', 'Datos_IND', 'Den_10.000', 'mG', 'mG_3', 'nSNPs_IND.bim'))
famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Den_10.000', 'mG', 'mG_3', 'nSNPs_IND.fam'))
bedsnps_IND <- BEDMatrix(here('Datos', 'Datos_IND', 'Den_10.000', 'mG', 'mG_3', 'nSNPs_IND.bed'), n = length(famsnps_IND$id), p = length(bimsnps_IND$id), simple_names = FALSE)
snps_IND <- as.matrix(bedsnps_IND) # Se importa la matriz de SNPs para los 451 individuos genotipados.

Geno_451 <- snps_IND %>%
  as_tibble() %>%
  bind_cols(ped_IND_451) %>%
  relocate(
    id,
    .before = V1
    ) %>%
  unite(
    'snps',
    V1:V9843,
    sep = '',
    remove = TRUE
    )

Geno_451 %>%
  write_delim(here('Datos', 'Datos_IND', 'Den_10.000', 'mod_BLUPf90', 'Ped_4', '451_ind', 'Geno_451.txt'), delim = ' ', col_names = FALSE)

#### Conjunto de datos del fenotipo ----

Pob_IND_5 %>%
  write_delim(here('Datos', 'Datos_IND', 'Den_10.000', 'mod_BLUPf90', 'Ped_4', '451_ind', 'Fenotipo.txt'), delim = ' ', col_names = FALSE)

#### Conjunto de datos de  referencia cruzada (relaciona el id especificado en los archivos de pedigrí y de fenotipos con el id en el archivo de marcador) ----

Ref_cruz <- Geno_451 %>%
  select(id) %>%
  mutate(id_2 = id)

Ref_cruz %>%
  write_delim(here('Datos', 'Datos_IND', 'Den_10.000', 'mod_BLUPf90', 'Ped_4', '451_ind', 'Geno_451_RF.txt'), delim = ' ', col_names = FALSE)

########################################################
# Pedigrí 5: 1530 individuos simulados en 9 generaciones
########################################################

dir.create('../Datos/Datos_IND/Den_10.000/mod_BLUPf90/Ped_5') # Se crea el directorio donde se guardara los distintos conjuntos de datos donde se haga uso del pedigrí 5.

## 1. Subpoblación con 148 individuos genotipados

dir.create('../Datos/Datos_IND/Den_10.000/mod_BLUPf90/Ped_5/148_ind') # Se crea el directorio donde se guardara los distintos conjuntos de datos donde se haga uso de los 148 individuos genotipados.

#### Conjunto de datos del pedigrí ----

ped_5 <- read_delim(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'Molcoanc_16', 'geneal_IND.csv'), delim = ' ')

ped_5 %>%
  write_delim(here('Datos', 'Datos_IND', 'Den_10.000', 'mod_BLUPf90', 'Ped_5', '148_ind', 'Ped_5.txt'), delim = ' ', col_names = FALSE)

#### Conjunto de datos de genotipos ----

famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'nSNPs_IND.fam')) %>% # Se importa el archivo .fam obtenido usando plink y que posteriomente se uso para crear la hoja de parámetros para ejecutar el software molcoanc.
  select(fam) %>%
  mutate(id = 1531:1981)

ped_IND_148 <- read_delim(here('Datos', 'Datos_IND', 'Den_100.000', 'mG', 'mG_2', 'subpob_IND.txt'), delim = '\t', col_names = FALSE) %>% # Se importa el conjunto de datos donde esta la identificación de los 148 individuos genotipados.
  select(X1) %>%
  rename(fam = X1) %>%
  right_join(x = famsnps_IND, by = 'fam') %>%
  select(-fam)

bimsnps_IND <- read_bim(here('Datos', 'Datos_IND', 'Den_10.000', 'mG', 'mG_1', 'nSNPs_IND.bim'))
famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Den_10.000', 'mG', 'mG_1', 'nSNPs_IND.fam'))
bedsnps_IND <- BEDMatrix(here('Datos', 'Datos_IND', 'Den_10.000', 'mG', 'mG_1', 'nSNPs_IND.bed'), n = length(famsnps_IND$id), p = length(bimsnps_IND$id), simple_names = FALSE)
snps_IND <- as.matrix(bedsnps_IND) # Se importa la matriz de SNPs para los 148 individuos genotipados.

Geno_148 <- snps_IND %>%
  as_tibble() %>%
  bind_cols(ped_IND_148) %>%
  relocate(
    id,
    .before = V1
    ) %>%
  unite(
    'snps',
    V1:V10098,
    sep = '',
    remove = TRUE
    )

Geno_148 %>%
  write_delim(here('Datos', 'Datos_IND', 'Den_10.000', 'mod_BLUPf90', 'Ped_5', '148_ind', 'Geno_148.txt'), delim = ' ', col_names = FALSE)

#### Conjunto de datos del fenotipo ----

lin_mej <- read_delim(here('Datos', 'iris_pedigree.csv'), delim = ',') # Se importan las bases de datos de fenotipos y de linea mejorada.
Fenotipos <- read_delim(here('Datos', 'all.phenotypes.csv'), delim = ',')

Pob_mej <- lin_mej %>%
  filter(Status_with_Pedigree.plus.knowledge == 'I') %>% # Conjunto de datos solo con los individuos mejorados (los que se clasificaron como "I").
  select(X3K_DNA_IRIS_UNIQUE_ID) %>%
  rename(Variety = X3K_DNA_IRIS_UNIQUE_ID)

escalado <- function(x) { # Función usada para escalar el fenotipo.
  (x - mean(x, na.rm = TRUE)) / sd(x, na.rm = TRUE)
  }

Pob_IND <- Fenotipos %>%
  filter(SNPsubsp == 'IND') %>% # Conjunto de datos solo con la especie IND.
  mutate(
    Variety_2 = Variety,
    Fen_escalado = escalado(Time.to.flowering..from.sowing)
    ) %>%
  separate(
    col = Variety,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  ' '
  ) %>%
  unite(
    col = Variety,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  separate(
    col = Variety,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  '-'
  ) %>%
  unite(
    col = Variety,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  separate(
    col = Variety_2,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  ' '
  ) %>%
  unite(
    col = Variety_2,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  inner_join(y = Pob_mej, by = 'Variety') %>%
  select(Variety_2, Fen_escalado) %>% # Se creo el conjunto de datos con los individuos mejorados de la población indica.
  mutate(Fen_escalado = NA) %>% # Los fenotipos de estos individuos se deben colocar como NAs al formar parte de la población de validación cruzada, y al ser los individuos que se quieren predecir.
  rename(Variety = Variety_2)

Pob_IND_2 <- Fenotipos %>%
  filter(SNPsubsp == 'IND') %>% # Conjunto de datos solo con la especie IND.
  mutate(
    Variety_2 = Variety,
    Fen_escalado = escalado(Time.to.flowering..from.sowing)
    ) %>%
  separate(
    col = Variety,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  ' '
  ) %>%
  unite(
    col = Variety,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  separate(
    col = Variety,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  '-'
  ) %>%
  unite(
    col = Variety,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  separate(
    col = Variety_2,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  ' '
  ) %>%
  unite(
    col = Variety_2,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  anti_join(Pob_mej, by = 'Variety') %>%
  select(Variety_2, Fen_escalado) %>% # Se creo el conjunto de datos con los individuos no mejorados de la población indica.
  rename(Variety = Variety_2)

famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'nSNPs_IND.fam')) %>% # Se importa el archivo .fam obtenido usando plink y que posteriomente se uso para crear la hoja de parámetros para ejecutar el software molcoanc.
  select(fam) %>%
  mutate(id = 1531:1981) %>%
  rename(Variety = fam)

Pob_IND_3 <- Pob_IND_2 %>%
  left_join(y = famsnps_IND, by = 'Variety') # Se unen al conjunto de datos anterior (famsnps_IND) debido a que aquí esta la identificación numérica como esta en el pedigrí.

Pob_IND_4 <- Pob_IND %>%
  left_join(y = famsnps_IND, by = 'Variety') %>% # Se unen al conjunto de datos famsnps_IND debido a que aquí esta la identificación numérica como esta en el pedigrí.
  bind_rows(Pob_IND_3) %>% # Se une por filas al conjunto de datos de individuos no mejorados anterior Pob_IND_3.
  select(-Variety) %>%
  relocate(
    Fen_escalado,
    .after = id
    )

Pob_IND_5 <- tibble(
  id = seq(from = 1, to = 1530, by = 1),
  Fen_escalado = rep(x = NA, times = 1530)
  ) %>% # # Se crea un conjunto de datos donde estaran los fenotipos de los individuos con pedigrí simulado mediante el software molcoanc.
  bind_rows(Pob_IND_4) %>% # Se une por filas al conjunto de datos de individuos anterior Pob_IND_4.
  arrange(id) %>%
  mutate(Fen_escalado = replace_na(Fen_escalado, 0))

Pob_IND_5 %>%
  write_delim(here('Datos', 'Datos_IND', 'Den_10.000', 'mod_BLUPf90', 'Ped_5', '148_ind', 'Fenotipo.txt'), delim = ' ', col_names = FALSE)

#### Conjunto de datos de  referencia cruzada (relaciona el id especificado en los archivos de pedigrí y de fenotipos con el id en el archivo de marcador) ----

Ref_cruz <- Geno_148 %>%
  select(id) %>%
  mutate(id_2 = id)

Ref_cruz %>%
  write_delim(here('Datos', 'Datos_IND', 'Den_10.000', 'mod_BLUPf90', 'Ped_5', '148_ind', 'Geno_148_RF.txt'), delim = ' ', col_names = FALSE)

## 2. Subpoblación con 298 individuos genotipados

dir.create('../Datos/Datos_IND/Den_10.000/mod_BLUPf90/Ped_5/298_ind') # Se crea el directorio donde se guardara los distintos conjuntos de datos donde se haga uso de los 298 individuos genotipados.

#### Conjunto de datos del pedigrí ----

ped_5 %>%
  write_delim(here('Datos', 'Datos_IND', 'Den_10.000', 'mod_BLUPf90', 'Ped_5', '298_ind', 'Ped_5.txt'), delim = ' ', col_names = FALSE)

#### Conjunto de datos de genotipos ----

famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'nSNPs_IND.fam')) %>% # Se importa el archivo .fam obtenido usando plink y que posteriomente se uso para crear la hoja de parámetros para ejecutar el software molcoanc.
  select(fam) %>%
  mutate(id = 1531:1981)

ped_IND_298 <- read_delim(here('Datos', 'Datos_IND', 'Den_100.000', 'mG', 'mG_5', 'subpob_IND.txt'), delim = '\t', col_names = FALSE) %>% # Se importa el conjunto de datos donde esta la identificación de los 298 individuos genotipados.
  select(X1) %>%
  rename(fam = X1) %>%
  right_join(x = famsnps_IND, by = 'fam') %>%
  select(-fam)

bimsnps_IND <- read_bim(here('Datos', 'Datos_IND', 'Den_10.000', 'mG', 'mG_2', 'nSNPs_IND.bim'))
famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Den_10.000', 'mG', 'mG_2', 'nSNPs_IND.fam'))
bedsnps_IND <- BEDMatrix(here('Datos', 'Datos_IND', 'Den_10.000', 'mG', 'mG_2', 'nSNPs_IND.bed'), n = length(famsnps_IND$id), p = length(bimsnps_IND$id), simple_names = FALSE)
snps_IND <- as.matrix(bedsnps_IND) # Se importa la matriz de SNPs para los 298 individuos genotipados.

Geno_298 <- snps_IND %>%
  as_tibble() %>%
  bind_cols(ped_IND_298) %>%
  relocate(
    id,
    .before = V1
    ) %>%
  unite(
    'snps',
    V1:V9946,
    sep = '',
    remove = TRUE
    )

Geno_298 %>%
  write_delim(here('Datos', 'Datos_IND', 'Den_10.000', 'mod_BLUPf90', 'Ped_5', '298_ind', 'Geno_298.txt'), delim = ' ', col_names = FALSE)

#### Conjunto de datos del fenotipo ----

Pob_IND_5 %>%
  write_delim(here('Datos', 'Datos_IND', 'Den_10.000', 'mod_BLUPf90', 'Ped_5', '298_ind', 'Fenotipo.txt'), delim = ' ', col_names = FALSE)

#### Conjunto de datos de  referencia cruzada (relaciona el id especificado en los archivos de pedigrí y de fenotipos con el id en el archivo de marcador) ----

Ref_cruz <- Geno_298 %>%
  select(id) %>%
  mutate(id_2 = id)

Ref_cruz %>%
  write_delim(here('Datos', 'Datos_IND', 'Den_10.000', 'mod_BLUPf90', 'Ped_5', '298_ind', 'Geno_298_RF.txt'), delim = ' ', col_names = FALSE)

## 3. Subpoblación con 451 individuos genotipados

dir.create('../Datos/Datos_IND/Den_10.000/mod_BLUPf90/Ped_5/451_ind') # Se crea el directorio donde se guardara los distintos conjuntos de datos donde se haga uso de los 451 individuos genotipados.

#### Conjunto de datos del pedigrí ----

ped_5 %>%
  write_delim(here('Datos', 'Datos_IND', 'Den_10.000', 'mod_BLUPf90', 'Ped_5', '451_ind', 'Ped_5.txt'), delim = ' ', col_names = FALSE)

#### Conjunto de datos de genotipos ----

famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'nSNPs_IND.fam')) %>% # Se importa el archivo .fam obtenido usando plink y que posteriomente se uso para crear la hoja de parámetros para ejecutar el software molcoanc.
  select(fam) %>%
  mutate(id = 1531:1981)

ped_IND_451 <- read_delim(here('Datos', 'Datos_IND', 'Den_100.000', 'mG', 'mG_8', 'subpob_IND.txt'), delim = '\t', col_names = FALSE) %>% # Se importa el conjunto de datos donde esta la identificación de los 451 individuos genotipados.
  select(X1) %>%
  rename(fam = X1) %>%
  right_join(x = famsnps_IND, by = 'fam') %>%
  select(-fam)

bimsnps_IND <- read_bim(here('Datos', 'Datos_IND', 'Den_10.000', 'mG', 'mG_3', 'nSNPs_IND.bim'))
famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Den_10.000', 'mG', 'mG_3', 'nSNPs_IND.fam'))
bedsnps_IND <- BEDMatrix(here('Datos', 'Datos_IND', 'Den_10.000', 'mG', 'mG_3', 'nSNPs_IND.bed'), n = length(famsnps_IND$id), p = length(bimsnps_IND$id), simple_names = FALSE)
snps_IND <- as.matrix(bedsnps_IND) # Se importa la matriz de SNPs para los 451 individuos genotipados.

Geno_451 <- snps_IND %>%
  as_tibble() %>%
  bind_cols(ped_IND_451) %>%
  relocate(
    id,
    .before = V1
    ) %>%
  unite(
    'snps',
    V1:V9843,
    sep = '',
    remove = TRUE
    )

Geno_451 %>%
  write_delim(here('Datos', 'Datos_IND', 'Den_10.000', 'mod_BLUPf90', 'Ped_5', '451_ind', 'Geno_451.txt'), delim = ' ', col_names = FALSE)

#### Conjunto de datos del fenotipo ----

Pob_IND_5 %>%
  write_delim(here('Datos', 'Datos_IND', 'Den_10.000', 'mod_BLUPf90', 'Ped_5', '451_ind', 'Fenotipo.txt'), delim = ' ', col_names = FALSE)

#### Conjunto de datos de  referencia cruzada (relaciona el id especificado en los archivos de pedigrí y de fenotipos con el id en el archivo de marcador) ----

Ref_cruz <- Geno_451 %>%
  select(id) %>%
  mutate(id_2 = id)

Ref_cruz %>%
  write_delim(here('Datos', 'Datos_IND', 'Den_10.000', 'mod_BLUPf90', 'Ped_5', '451_ind', 'Geno_451_RF.txt'), delim = ' ', col_names = FALSE)

###################################################################
############## Densidad del marcador de 1.000 SNPs ################
###################################################################

dir.create('../Datos/Datos_IND/Den_1.000/mod_BLUPf90') # Se crea el directorio donde se guardaran los conjuntos de datos para el análisis usando el programa BLUPf90.

#########################################################
# Pedigrí 1: 2000 individuos simulados en 10 generaciones
#########################################################

dir.create('../Datos/Datos_IND/Den_1.000/mod_BLUPf90/Ped_1') # Se crea el directorio donde se guardara los distintos conjuntos de datos donde se haga uso del pedigrí 1.

## 1. Subpoblación con 148 individuos genotipados

dir.create('../Datos/Datos_IND/Den_1.000/mod_BLUPf90/Ped_1/148_ind') # Se crea el directorio donde se guardara los distintos conjuntos de datos donde se haga uso de los 148 individuos genotipados.

#### Conjunto de datos del pedigrí ----

ped_1 <- read_delim(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'Molcoanc_12', 'geneal_IND.csv'), delim = ' ')

ped_1 %>%
  write_delim(here('Datos', 'Datos_IND', 'Den_1.000', 'mod_BLUPf90', 'Ped_1', '148_ind', 'Ped_1.txt'), delim = ' ', col_names = FALSE)

#### Conjunto de datos de genotipos ----

famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'nSNPs_IND.fam')) %>% # Se importa el archivo .fam obtenido usando plink y que posteriomente se uso para crear la hoja de parámetros para ejecutar el software molcoanc.
  select(fam) %>%
  mutate(id = 2001:2451)

ped_IND_148 <- read_delim(here('Datos', 'Datos_IND', 'Den_100.000', 'mG', 'mG_2', 'subpob_IND.txt'), delim = '\t', col_names = FALSE) %>% # Se importa el conjunto de datos donde esta la identificación de los 148 individuos genotipados.
  select(X1) %>%
  rename(fam = X1) %>%
  right_join(x = famsnps_IND, by = 'fam') %>%
  select(-fam)

bimsnps_IND <- read_bim(here('Datos', 'Datos_IND', 'Den_1.000', 'mG', 'mG_1', 'nSNPs_IND.bim'))
famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Den_1.000', 'mG', 'mG_1', 'nSNPs_IND.fam'))
bedsnps_IND <- BEDMatrix(here('Datos', 'Datos_IND', 'Den_1.000', 'mG', 'mG_1', 'nSNPs_IND.bed'), n = length(famsnps_IND$id), p = length(bimsnps_IND$id), simple_names = FALSE)
snps_IND <- as.matrix(bedsnps_IND) # Se importa la matriz de SNPs para los 148 individuos genotipados.

Geno_148 <- snps_IND %>%
  as_tibble() %>%
  bind_cols(ped_IND_148) %>%
  relocate(
    id,
    .before = V1
    ) %>%
  unite(
    'snps',
    V1:V1037,
    sep = '',
    remove = TRUE
    )

Geno_148 %>%
  write_delim(here('Datos', 'Datos_IND', 'Den_1.000', 'mod_BLUPf90', 'Ped_1', '148_ind', 'Geno_148.txt'), delim = ' ', col_names = FALSE)

#### Conjunto de datos del fenotipo ----

lin_mej <- read_delim(here('Datos', 'iris_pedigree.csv'), delim = ',') # Se importan las bases de datos de fenotipos y de linea mejorada.
Fenotipos <- read_delim(here('Datos', 'all.phenotypes.csv'), delim = ',')

Pob_mej <- lin_mej %>%
  filter(Status_with_Pedigree.plus.knowledge == 'I') %>% # Conjunto de datos solo con los individuos mejorados (los que se clasificaron como "I").
  select(X3K_DNA_IRIS_UNIQUE_ID) %>%
  rename(Variety = X3K_DNA_IRIS_UNIQUE_ID)

escalado <- function(x) { # Función usada para escalar el fenotipo.
  (x - mean(x, na.rm = TRUE)) / sd(x, na.rm = TRUE)
  }

Pob_IND <- Fenotipos %>%
  filter(SNPsubsp == 'IND') %>% # Conjunto de datos solo con la especie IND.
  mutate(
    Variety_2 = Variety,
    Fen_escalado = escalado(Time.to.flowering..from.sowing)
    ) %>%
  separate(
    col = Variety,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  ' '
  ) %>%
  unite(
    col = Variety,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  separate(
    col = Variety,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  '-'
  ) %>%
  unite(
    col = Variety,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  separate(
    col = Variety_2,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  ' '
  ) %>%
  unite(
    col = Variety_2,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  inner_join(y = Pob_mej, by = 'Variety') %>%
  select(Variety_2, Fen_escalado) %>% # Se creo el conjunto de datos con los individuos mejorados de la población indica.
  mutate(Fen_escalado = NA) %>% # Los fenotipos de estos individuos se deben colocar como NAs al formar parte de la población de validación cruzada, y al ser los individuos que se quieren predecir.
  rename(Variety = Variety_2)

Pob_IND_2 <- Fenotipos %>%
  filter(SNPsubsp == 'IND') %>% # Conjunto de datos solo con la especie IND.
  mutate(
    Variety_2 = Variety,
    Fen_escalado = escalado(Time.to.flowering..from.sowing)
    ) %>%
  separate(
    col = Variety,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  ' '
  ) %>%
  unite(
    col = Variety,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  separate(
    col = Variety,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  '-'
  ) %>%
  unite(
    col = Variety,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  separate(
    col = Variety_2,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  ' '
  ) %>%
  unite(
    col = Variety_2,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  anti_join(Pob_mej, by = 'Variety') %>%
  select(Variety_2, Fen_escalado) %>% # Se creo el conjunto de datos con los individuos no mejorados de la población indica.
  rename(Variety = Variety_2)

famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'nSNPs_IND.fam')) %>% # Se importa el archivo .fam obtenido usando plink y que posteriomente se uso para crear la hoja de parámetros para ejecutar el software molcoanc.
  select(fam) %>%
  mutate(id = 2001:2451) %>%
  rename(Variety = fam)

Pob_IND_3 <- Pob_IND_2 %>%
  left_join(y = famsnps_IND, by = 'Variety') # Se unen al conjunto de datos anterior (famsnps_IND) debido a que aquí esta la identificación numérica como esta en el pedigrí.

Pob_IND_4 <- Pob_IND %>%
  left_join(y = famsnps_IND, by = 'Variety') %>% # Se unen al conjunto de datos famsnps_IND debido a que aquí esta la identificación numérica como esta en el pedigrí.
  bind_rows(Pob_IND_3) %>% # Se une por filas al conjunto de datos de individuos no mejorados anterior Pob_IND_3.
  select(-Variety) %>%
  relocate(
    Fen_escalado,
    .after = id
    )

Pob_IND_5 <- tibble(
  id = seq(from = 1, to = 2000, by = 1),
  Fen_escalado = rep(x = NA, times = 2000)
  ) %>% # # Se crea un conjunto de datos donde estaran los fenotipos de los individuos con pedigrí simulado mediante el software molcoanc.
  bind_rows(Pob_IND_4) %>% # Se une por filas al conjunto de datos de individuos anterior Pob_IND_4.
  arrange(id) %>%
  mutate(Fen_escalado = replace_na(Fen_escalado, 0))

Pob_IND_5 %>%
  write_delim(here('Datos', 'Datos_IND', 'Den_1.000', 'mod_BLUPf90', 'Ped_1', '148_ind', 'Fenotipo.txt'), delim = ' ', col_names = FALSE)

#### Conjunto de datos de  referencia cruzada (relaciona el id especificado en los archivos de pedigrí y de fenotipos con el id en el archivo de marcador) ----

Ref_cruz <- Geno_148 %>%
  select(id) %>%
  mutate(id_2 = id)

Ref_cruz %>%
  write_delim(here('Datos', 'Datos_IND', 'Den_1.000', 'mod_BLUPf90', 'Ped_1', '148_ind', 'Geno_148_RF.txt'), delim = ' ', col_names = FALSE)

## 2. Subpoblación con 298 individuos genotipados

dir.create('../Datos/Datos_IND/Den_1.000/mod_BLUPf90/Ped_1/298_ind') # Se crea el directorio donde se guardara los distintos conjuntos de datos donde se haga uso de los 298 individuos genotipados.

#### Conjunto de datos del pedigrí ----

ped_1 %>%
  write_delim(here('Datos', 'Datos_IND', 'Den_1.000', 'mod_BLUPf90', 'Ped_1', '298_ind', 'Ped_1.txt'), delim = ' ', col_names = FALSE)

#### Conjunto de datos de genotipos ----

famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'nSNPs_IND.fam')) %>% # Se importa el archivo .fam obtenido usando plink y que posteriomente se uso para crear la hoja de parámetros para ejecutar el software molcoanc.
  select(fam) %>%
  mutate(id = 2001:2451)

ped_IND_298 <- read_delim(here('Datos', 'Datos_IND', 'Den_100.000', 'mG', 'mG_5', 'subpob_IND.txt'), delim = '\t', col_names = FALSE) %>% # Se importa el conjunto de datos donde esta la identificación de los 298 individuos genotipados.
  select(X1) %>%
  rename(fam = X1) %>%
  right_join(x = famsnps_IND, by = 'fam') %>%
  select(-fam)

bimsnps_IND <- read_bim(here('Datos', 'Datos_IND', 'Den_1.000', 'mG', 'mG_2', 'nSNPs_IND.bim'))
famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Den_1.000', 'mG', 'mG_2', 'nSNPs_IND.fam'))
bedsnps_IND <- BEDMatrix(here('Datos', 'Datos_IND', 'Den_1.000', 'mG', 'mG_2', 'nSNPs_IND.bed'), n = length(famsnps_IND$id), p = length(bimsnps_IND$id), simple_names = FALSE)
snps_IND <- as.matrix(bedsnps_IND) # Se importa la matriz de SNPs para los 298 individuos genotipados.

Geno_298 <- snps_IND %>%
  as_tibble() %>%
  bind_cols(ped_IND_298) %>%
  relocate(
    id,
    .before = V1
    ) %>%
  unite(
    'snps',
    V1:V986,
    sep = '',
    remove = TRUE
    )

Geno_298 %>%
  write_delim(here('Datos', 'Datos_IND', 'Den_1.000', 'mod_BLUPf90', 'Ped_1', '298_ind', 'Geno_298.txt'), delim = ' ', col_names = FALSE)

#### Conjunto de datos del fenotipo ----

Pob_IND_5 %>%
  write_delim(here('Datos', 'Datos_IND', 'Den_1.000', 'mod_BLUPf90', 'Ped_1', '298_ind', 'Fenotipo.txt'), delim = ' ', col_names = FALSE)

## 3. Subpoblación con 451 individuos genotipados

dir.create('../Datos/Datos_IND/Den_1.000/mod_BLUPf90/Ped_1/451_ind') # Se crea el directorio donde se guardara los distintos conjuntos de datos donde se haga uso de los 451 individuos genotipados.

#### Conjunto de datos del pedigrí ----

ped_1 %>%
  write_delim(here('Datos', 'Datos_IND', 'Den_1.000', 'mod_BLUPf90', 'Ped_1', '451_ind', 'Ped_1.txt'), delim = ' ', col_names = FALSE)

#### Conjunto de datos de genotipos ----

famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'nSNPs_IND.fam')) %>% # Se importa el archivo .fam obtenido usando plink y que posteriomente se uso para crear la hoja de parámetros para ejecutar el software molcoanc.
  select(fam) %>%
  mutate(id = 2001:2451)

ped_IND_451 <- read_delim(here('Datos', 'Datos_IND', 'Den_100.000', 'mG', 'mG_8', 'subpob_IND.txt'), delim = '\t', col_names = FALSE) %>% # Se importa el conjunto de datos donde esta la identificación de los 451 individuos genotipados.
  select(X1) %>%
  rename(fam = X1) %>%
  right_join(x = famsnps_IND, by = 'fam') %>%
  select(-fam)

bimsnps_IND <- read_bim(here('Datos', 'Datos_IND', 'Den_1.000', 'mG', 'mG_3', 'nSNPs_IND.bim'))
famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Den_1.000', 'mG', 'mG_3', 'nSNPs_IND.fam'))
bedsnps_IND <- BEDMatrix(here('Datos', 'Datos_IND', 'Den_1.000', 'mG', 'mG_3', 'nSNPs_IND.bed'), n = length(famsnps_IND$id), p = length(bimsnps_IND$id), simple_names = FALSE)
snps_IND <- as.matrix(bedsnps_IND) # Se importa la matriz de SNPs para los 451 individuos genotipados.

Geno_451 <- snps_IND %>%
  as_tibble() %>%
  bind_cols(ped_IND_451) %>%
  relocate(
    id,
    .before = V1
    ) %>%
  unite(
    'snps',
    V1:V960,
    sep = '',
    remove = TRUE
    )

Geno_451 %>%
  write_delim(here('Datos', 'Datos_IND', 'Den_1.000', 'mod_BLUPf90', 'Ped_1', '451_ind', 'Geno_451.txt'), delim = ' ', col_names = FALSE)

#### Conjunto de datos del fenotipo ----

Pob_IND_5 %>%
  write_delim(here('Datos', 'Datos_IND', 'Den_1.000', 'mod_BLUPf90', 'Ped_1', '451_ind', 'Fenotipo.txt'), delim = ' ', col_names = FALSE)

#### Conjunto de datos de  referencia cruzada (relaciona el id especificado en los archivos de pedigrí y de fenotipos con el id en el archivo de marcador) ----

Ref_cruz <- Geno_451 %>%
  select(id) %>%
  mutate(id_2 = id)

Ref_cruz %>%
  write_delim(here('Datos', 'Datos_IND', 'Den_1.000', 'mod_BLUPf90', 'Ped_1', '451_ind', 'Geno_451_RF.txt'), delim = ' ', col_names = FALSE)

#######################################################
# Pedigrí 2: 520 individuos simulados en 4 generaciones
#######################################################

dir.create('../Datos/Datos_IND/Den_1.000/mod_BLUPf90/Ped_2') # Se crea el directorio donde se guardara los distintos conjuntos de datos donde se haga uso del pedigrí 2.

## 1. Subpoblación con 148 individuos genotipados

dir.create('../Datos/Datos_IND/Den_1.000/mod_BLUPf90/Ped_2/148_ind') # Se crea el directorio donde se guardara los distintos conjuntos de datos donde se haga uso de los 148 individuos genotipados.

#### Conjunto de datos del pedigrí ----

ped_2 <- read_delim(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'Molcoanc_13', 'geneal_IND.csv'), delim = ' ')

ped_2 %>%
  write_delim(here('Datos', 'Datos_IND', 'Den_1.000', 'mod_BLUPf90', 'Ped_2', '148_ind', 'Ped_2.txt'), delim = ' ', col_names = FALSE)

#### Conjunto de datos de genotipos ----

famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'nSNPs_IND.fam')) %>% # Se importa el archivo .fam obtenido usando plink y que posteriomente se uso para crear la hoja de parámetros para ejecutar el software molcoanc.
  select(fam) %>%
  mutate(id = 521:971)

ped_IND_148 <- read_delim(here('Datos', 'Datos_IND', 'Den_100.000', 'mG', 'mG_2', 'subpob_IND.txt'), delim = '\t', col_names = FALSE) %>% # Se importa el conjunto de datos donde esta la identificación de los 148 individuos genotipados.
  select(X1) %>%
  rename(fam = X1) %>%
  right_join(x = famsnps_IND, by = 'fam') %>%
  select(-fam)

bimsnps_IND <- read_bim(here('Datos', 'Datos_IND', 'Den_1.000', 'mG', 'mG_1', 'nSNPs_IND.bim'))
famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Den_1.000', 'mG', 'mG_1', 'nSNPs_IND.fam'))
bedsnps_IND <- BEDMatrix(here('Datos', 'Datos_IND', 'Den_1.000', 'mG', 'mG_1', 'nSNPs_IND.bed'), n = length(famsnps_IND$id), p = length(bimsnps_IND$id), simple_names = FALSE)
snps_IND <- as.matrix(bedsnps_IND) # Se importa la matriz de SNPs para los 148 individuos genotipados.

Geno_148 <- snps_IND %>%
  as_tibble() %>%
  bind_cols(ped_IND_148) %>%
  relocate(
    id,
    .before = V1
    ) %>%
  unite(
    'snps',
    V1:V1037,
    sep = '',
    remove = TRUE
    )
Geno_148 %>%
  write_delim(here('Datos', 'Datos_IND', 'Den_1.000', 'mod_BLUPf90', 'Ped_2', '148_ind', 'Geno_148.txt'), delim = ' ', col_names = FALSE)

#### Conjunto de datos del fenotipo ----

lin_mej <- read_delim(here('Datos', 'iris_pedigree.csv'), delim = ',') # Se importan las bases de datos de fenotipos y de linea mejorada.
Fenotipos <- read_delim(here('Datos', 'all.phenotypes.csv'), delim = ',')

Pob_mej <- lin_mej %>%
  filter(Status_with_Pedigree.plus.knowledge == 'I') %>% # Conjunto de datos solo con los individuos mejorados (los que se clasificaron como "I").
  select(X3K_DNA_IRIS_UNIQUE_ID) %>%
  rename(Variety = X3K_DNA_IRIS_UNIQUE_ID)

escalado <- function(x) { # Función usada para escalar el fenotipo.
  (x - mean(x, na.rm = TRUE)) / sd(x, na.rm = TRUE)
  }

Pob_IND <- Fenotipos %>%
  filter(SNPsubsp == 'IND') %>% # Conjunto de datos solo con la especie IND.
  mutate(
    Variety_2 = Variety,
    Fen_escalado = escalado(Time.to.flowering..from.sowing)
    ) %>%
  separate(
    col = Variety,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  ' '
  ) %>%
  unite(
    col = Variety,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  separate(
    col = Variety,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  '-'
  ) %>%
  unite(
    col = Variety,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  separate(
    col = Variety_2,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  ' '
  ) %>%
  unite(
    col = Variety_2,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  inner_join(y = Pob_mej, by = 'Variety') %>%
  select(Variety_2, Fen_escalado) %>% # Se creo el conjunto de datos con los individuos mejorados de la población indica.
  mutate(Fen_escalado = NA) %>% # Los fenotipos de estos individuos se deben colocar como NAs al formar parte de la población de validación cruzada, y al ser los individuos que se quieren predecir.
  rename(Variety = Variety_2)

Pob_IND_2 <- Fenotipos %>%
  filter(SNPsubsp == 'IND') %>% # Conjunto de datos solo con la especie IND.
  mutate(
    Variety_2 = Variety,
    Fen_escalado = escalado(Time.to.flowering..from.sowing)
    ) %>%
  separate(
    col = Variety,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  ' '
  ) %>%
  unite(
    col = Variety,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  separate(
    col = Variety,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  '-'
  ) %>%
  unite(
    col = Variety,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  separate(
    col = Variety_2,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  ' '
  ) %>%
  unite(
    col = Variety_2,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  anti_join(Pob_mej, by = 'Variety') %>%
  select(Variety_2, Fen_escalado) %>% # Se creo el conjunto de datos con los individuos no mejorados de la población indica.
  rename(Variety = Variety_2)

famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'nSNPs_IND.fam')) %>% # Se importa el archivo .fam obtenido usando plink y que posteriomente se uso para crear la hoja de parámetros para ejecutar el software molcoanc.
  select(fam) %>%
  mutate(id = 521:971) %>%
  rename(Variety = fam)

Pob_IND_3 <- Pob_IND_2 %>%
  left_join(y = famsnps_IND, by = 'Variety') # Se unen al conjunto de datos anterior (famsnps_IND) debido a que aquí esta la identificación numérica como esta en el pedigrí.

Pob_IND_4 <- Pob_IND %>%
  left_join(y = famsnps_IND, by = 'Variety') %>% # Se unen al conjunto de datos famsnps_IND debido a que aquí esta la identificación numérica como esta en el pedigrí.
  bind_rows(Pob_IND_3) %>% # Se une por filas al conjunto de datos de individuos no mejorados anterior Pob_IND_3.
  select(-Variety) %>%
  relocate(
    Fen_escalado,
    .after = id
    )

Pob_IND_5 <- tibble(
  id = seq(from = 1, to = 520, by = 1),
  Fen_escalado = rep(x = NA, times = 520)
  ) %>% # # Se crea un conjunto de datos donde estaran los fenotipos de los individuos con pedigrí simulado mediante el software molcoanc.
  bind_rows(Pob_IND_4) %>% # Se une por filas al conjunto de datos de individuos anterior Pob_IND_4.
  arrange(id) %>%
  mutate(Fen_escalado = replace_na(Fen_escalado, 0))

Pob_IND_5 %>%
  write_delim(here('Datos', 'Datos_IND', 'Den_1.000', 'mod_BLUPf90', 'Ped_2', '148_ind', 'Fenotipo.txt'), delim = ' ', col_names = FALSE)

#### Conjunto de datos de  referencia cruzada (relaciona el id especificado en los archivos de pedigrí y de fenotipos con el id en el archivo de marcador) ----

Ref_cruz <- Geno_148 %>%
  select(id) %>%
  mutate(id_2 = id)

Ref_cruz %>%
  write_delim(here('Datos', 'Datos_IND', 'Den_1.000', 'mod_BLUPf90', 'Ped_2', '148_ind', 'Geno_148_RF.txt'), delim = ' ', col_names = FALSE)

## 2. Subpoblación con 298 individuos genotipados

dir.create('../Datos/Datos_IND/Den_1.000/mod_BLUPf90/Ped_2/298_ind') # Se crea el directorio donde se guardara los distintos conjuntos de datos donde se haga uso de los 298 individuos genotipados.

#### Conjunto de datos del pedigrí ----

ped_2 %>%
  write_delim(here('Datos', 'Datos_IND', 'Den_1.000', 'mod_BLUPf90', 'Ped_2', '298_ind', 'Ped_2.txt'), delim = ' ', col_names = FALSE)

#### Conjunto de datos de genotipos ----

famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'nSNPs_IND.fam')) %>% # Se importa el archivo .fam obtenido usando plink y que posteriomente se uso para crear la hoja de parámetros para ejecutar el software molcoanc.
  select(fam) %>%
  mutate(id = 521:971)

ped_IND_298 <- read_delim(here('Datos', 'Datos_IND', 'Den_100.000', 'mG', 'mG_5', 'subpob_IND.txt'), delim = '\t', col_names = FALSE) %>% # Se importa el conjunto de datos donde esta la identificación de los 298 individuos genotipados.
  select(X1) %>%
  rename(fam = X1) %>%
  right_join(x = famsnps_IND, by = 'fam') %>%
  select(-fam)

bimsnps_IND <- read_bim(here('Datos', 'Datos_IND', 'Den_1.000', 'mG', 'mG_2', 'nSNPs_IND.bim'))
famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Den_1.000', 'mG', 'mG_2', 'nSNPs_IND.fam'))
bedsnps_IND <- BEDMatrix(here('Datos', 'Datos_IND', 'Den_1.000', 'mG', 'mG_2', 'nSNPs_IND.bed'), n = length(famsnps_IND$id), p = length(bimsnps_IND$id), simple_names = FALSE)
snps_IND <- as.matrix(bedsnps_IND) # Se importa la matriz de SNPs para los 298 individuos genotipados.

Geno_298 <- snps_IND %>%
  as_tibble() %>%
  bind_cols(ped_IND_298) %>%
  relocate(
    id,
    .before = V1
    ) %>%
  unite(
    'snps',
    V1:V986,
    sep = '',
    remove = TRUE
    )

Geno_298 %>%
  write_delim(here('Datos', 'Datos_IND', 'Den_1.000', 'mod_BLUPf90', 'Ped_2', '298_ind', 'Geno_298.txt'), delim = ' ', col_names = FALSE)

#### Conjunto de datos del fenotipo ----

Pob_IND_5 %>%
  write_delim(here('Datos', 'Datos_IND', 'Den_1.000', 'mod_BLUPf90', 'Ped_2', '298_ind', 'Fenotipo.txt'), delim = ' ', col_names = FALSE)

#### Conjunto de datos de  referencia cruzada (relaciona el id especificado en los archivos de pedigrí y de fenotipos con el id en el archivo de marcador) ----

Ref_cruz <- Geno_298 %>%
  select(id) %>%
  mutate(id_2 = id)

Ref_cruz %>%
  write_delim(here('Datos', 'Datos_IND', 'Den_1.000', 'mod_BLUPf90', 'Ped_2', '298_ind', 'Geno_298_RF.txt'), delim = ' ', col_names = FALSE)

## 3. Subpoblación con 451 individuos genotipados

dir.create('../Datos/Datos_IND/Den_1.000/mod_BLUPf90/Ped_2/451_ind') # Se crea el directorio donde se guardara los distintos conjuntos de datos donde se haga uso de los 451 individuos genotipados.

#### Conjunto de datos del pedigrí ----

ped_2 %>%
  write_delim(here('Datos', 'Datos_IND', 'Den_1.000', 'mod_BLUPf90', 'Ped_2', '451_ind', 'Ped_2.txt'), delim = ' ', col_names = FALSE)

#### Conjunto de datos de genotipos ----

famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'nSNPs_IND.fam')) %>% # Se importa el archivo .fam obtenido usando plink y que posteriomente se uso para crear la hoja de parámetros para ejecutar el software molcoanc.
  select(fam) %>%
  mutate(id = 521:971)

ped_IND_451 <- read_delim(here('Datos', 'Datos_IND', 'Den_100.000', 'mG', 'mG_8', 'subpob_IND.txt'), delim = '\t', col_names = FALSE) %>% # Se importa el conjunto de datos donde esta la identificación de los 451 individuos genotipados.
  select(X1) %>%
  rename(fam = X1) %>%
  right_join(x = famsnps_IND, by = 'fam') %>%
  select(-fam)

bimsnps_IND <- read_bim(here('Datos', 'Datos_IND', 'Den_1.000', 'mG', 'mG_3', 'nSNPs_IND.bim'))
famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Den_1.000', 'mG', 'mG_3', 'nSNPs_IND.fam'))
bedsnps_IND <- BEDMatrix(here('Datos', 'Datos_IND', 'Den_1.000', 'mG', 'mG_3', 'nSNPs_IND.bed'), n = length(famsnps_IND$id), p = length(bimsnps_IND$id), simple_names = FALSE)
snps_IND <- as.matrix(bedsnps_IND) # Se importa la matriz de SNPs para los 451 individuos genotipados.

Geno_451 <- snps_IND %>%
  as_tibble() %>%
  bind_cols(ped_IND_451) %>%
  relocate(
    id,
    .before = V1
    ) %>%
  unite(
    'snps',
    V1:V960,
    sep = '',
    remove = TRUE
    )

Geno_451 %>%
  write_delim(here('Datos', 'Datos_IND', 'Den_1.000', 'mod_BLUPf90', 'Ped_2', '451_ind', 'Geno_451.txt'), delim = ' ', col_names = FALSE)

#### Conjunto de datos del fenotipo ----

Pob_IND_5 %>%
  write_delim(here('Datos', 'Datos_IND', 'Den_1.000', 'mod_BLUPf90', 'Ped_2', '451_ind', 'Fenotipo.txt'), delim = ' ', col_names = FALSE)

#### Conjunto de datos de  referencia cruzada (relaciona el id especificado en los archivos de pedigrí y de fenotipos con el id en el archivo de marcador) ----

Ref_cruz <- Geno_451 %>%
  select(id) %>%
  mutate(id_2 = id)

Ref_cruz %>%
  write_delim(here('Datos', 'Datos_IND', 'Den_1.000', 'mod_BLUPf90', 'Ped_2', '451_ind', 'Geno_451_RF.txt'), delim = ' ', col_names = FALSE)

########################################################
# Pedigrí 3: 1210 individuos simulados en 7 generaciones
########################################################

dir.create('../Datos/Datos_IND/Den_1.000/mod_BLUPf90/Ped_3') # Se crea el directorio donde se guardara los distintos conjuntos de datos donde se haga uso del pedigrí 3.

## 1. Subpoblación con 148 individuos genotipados

dir.create('../Datos/Datos_IND/Den_1.000/mod_BLUPf90/Ped_3/148_ind') # Se crea el directorio donde se guardara los distintos conjuntos de datos donde se haga uso de los 148 individuos genotipados.

#### Conjunto de datos del pedigrí ----

ped_3 <- read_delim(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'Molcoanc_14', 'geneal_IND.csv'), delim = ' ')

ped_3 %>%
  write_delim(here('Datos', 'Datos_IND', 'Den_1.000', 'mod_BLUPf90', 'Ped_3', '148_ind', 'Ped_3.txt'), delim = ' ', col_names = FALSE)

#### Conjunto de datos de genotipos ----

famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'nSNPs_IND.fam')) %>% # Se importa el archivo .fam obtenido usando plink y que posteriomente se uso para crear la hoja de parámetros para ejecutar el software molcoanc.
  select(fam) %>%
  mutate(id = 1211:1661)

ped_IND_148 <- read_delim(here('Datos', 'Datos_IND', 'Den_100.000', 'mG', 'mG_2', 'subpob_IND.txt'), delim = '\t', col_names = FALSE) %>% # Se importa el conjunto de datos donde esta la identificación de los 148 individuos genotipados.
  select(X1) %>%
  rename(fam = X1) %>%
  right_join(x = famsnps_IND, by = 'fam') %>%
  select(-fam)

bimsnps_IND <- read_bim(here('Datos', 'Datos_IND', 'Den_1.000', 'mG', 'mG_1', 'nSNPs_IND.bim'))
famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Den_1.000', 'mG', 'mG_1', 'nSNPs_IND.fam'))
bedsnps_IND <- BEDMatrix(here('Datos', 'Datos_IND', 'Den_1.000', 'mG', 'mG_1', 'nSNPs_IND.bed'), n = length(famsnps_IND$id), p = length(bimsnps_IND$id), simple_names = FALSE)
snps_IND <- as.matrix(bedsnps_IND) # Se importa la matriz de SNPs para los 148 individuos genotipados.

Geno_148 <- snps_IND %>%
  as_tibble() %>%
  bind_cols(ped_IND_148) %>%
  relocate(
    id,
    .before = V1
    ) %>%
  unite(
    'snps',
    V1:V1037,
    sep = '',
    remove = TRUE
    )

Geno_148 %>%
  write_delim(here('Datos', 'Datos_IND', 'Den_1.000', 'mod_BLUPf90', 'Ped_3', '148_ind', 'Geno_148.txt'), delim = ' ', col_names = FALSE)

#### Conjunto de datos del fenotipo ----

lin_mej <- read_delim(here('Datos', 'iris_pedigree.csv'), delim = ',') # Se importan las bases de datos de fenotipos y de linea mejorada.
Fenotipos <- read_delim(here('Datos', 'all.phenotypes.csv'), delim = ',')

Pob_mej <- lin_mej %>%
  filter(Status_with_Pedigree.plus.knowledge == 'I') %>% # Conjunto de datos solo con los individuos mejorados (los que se clasificaron como "I").
  select(X3K_DNA_IRIS_UNIQUE_ID) %>%
  rename(Variety = X3K_DNA_IRIS_UNIQUE_ID)

escalado <- function(x) { # Función usada para escalar el fenotipo.
  (x - mean(x, na.rm = TRUE)) / sd(x, na.rm = TRUE)
  }

Pob_IND <- Fenotipos %>%
  filter(SNPsubsp == 'IND') %>% # Conjunto de datos solo con la especie IND.
  mutate(
    Variety_2 = Variety,
    Fen_escalado = escalado(Time.to.flowering..from.sowing)
    ) %>%
  separate(
    col = Variety,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  ' '
  ) %>%
  unite(
    col = Variety,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  separate(
    col = Variety,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  '-'
  ) %>%
  unite(
    col = Variety,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  separate(
    col = Variety_2,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  ' '
  ) %>%
  unite(
    col = Variety_2,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  inner_join(y = Pob_mej, by = 'Variety') %>%
  select(Variety_2, Fen_escalado) %>% # Se creo el conjunto de datos con los individuos mejorados de la población indica.
  mutate(Fen_escalado = NA) %>% # Los fenotipos de estos individuos se deben colocar como NAs al formar parte de la población de validación cruzada, y al ser los individuos que se quieren predecir.
  rename(Variety = Variety_2)

Pob_IND_2 <- Fenotipos %>%
  filter(SNPsubsp == 'IND') %>% # Conjunto de datos solo con la especie IND.
  mutate(
    Variety_2 = Variety,
    Fen_escalado = escalado(Time.to.flowering..from.sowing)
    ) %>%
  separate(
    col = Variety,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  ' '
  ) %>%
  unite(
    col = Variety,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  separate(
    col = Variety,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  '-'
  ) %>%
  unite(
    col = Variety,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  separate(
    col = Variety_2,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  ' '
  ) %>%
  unite(
    col = Variety_2,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  anti_join(Pob_mej, by = 'Variety') %>%
  select(Variety_2, Fen_escalado) %>% # Se creo el conjunto de datos con los individuos no mejorados de la población indica.
  rename(Variety = Variety_2)

famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'nSNPs_IND.fam')) %>% # Se importa el archivo .fam obtenido usando plink y que posteriomente se uso para crear la hoja de parámetros para ejecutar el software molcoanc.
  select(fam) %>%
  mutate(id = 1211:1661) %>%
  rename(Variety = fam)

Pob_IND_3 <- Pob_IND_2 %>%
  left_join(y = famsnps_IND, by = 'Variety') # Se unen al conjunto de datos anterior (famsnps_IND) debido a que aquí esta la identificación numérica como esta en el pedigrí.

Pob_IND_4 <- Pob_IND %>%
  left_join(y = famsnps_IND, by = 'Variety') %>% # Se unen al conjunto de datos famsnps_IND debido a que aquí esta la identificación numérica como esta en el pedigrí.
  bind_rows(Pob_IND_3) %>% # Se une por filas al conjunto de datos de individuos no mejorados anterior Pob_IND_3.
  select(-Variety) %>%
  relocate(
    Fen_escalado,
    .after = id
    )

Pob_IND_5 <- tibble(
  id = seq(from = 1, to = 1210, by = 1),
  Fen_escalado = rep(x = NA, times = 1210)
  ) %>% # # Se crea un conjunto de datos donde estaran los fenotipos de los individuos con pedigrí simulado mediante el software molcoanc.
  bind_rows(Pob_IND_4) %>% # Se une por filas al conjunto de datos de individuos anterior Pob_IND_4.
  arrange(id) %>%
  mutate(Fen_escalado = replace_na(Fen_escalado, 0))

Pob_IND_5 %>%
  write_delim(here('Datos', 'Datos_IND', 'Den_1.000', 'mod_BLUPf90', 'Ped_3', '148_ind', 'Fenotipo.txt'), delim = ' ', col_names = FALSE)

#### Conjunto de datos de  referencia cruzada (relaciona el id especificado en los archivos de pedigrí y de fenotipos con el id en el archivo de marcador) ----

Ref_cruz <- Geno_148 %>%
  select(id) %>%
  mutate(id_2 = id)

Ref_cruz %>%
  write_delim(here('Datos', 'Datos_IND', 'Den_1.000', 'mod_BLUPf90', 'Ped_3', '148_ind', 'Geno_148_RF.txt'), delim = ' ', col_names = FALSE)

## 2. Subpoblación con 298 individuos genotipados

dir.create('../Datos/Datos_IND/Den_1.000/mod_BLUPf90/Ped_3/298_ind') # Se crea el directorio donde se guardara los distintos conjuntos de datos donde se haga uso de los 298 individuos genotipados.

#### Conjunto de datos del pedigrí ----

ped_3 %>%
  write_delim(here('Datos', 'Datos_IND', 'Den_1.000', 'mod_BLUPf90', 'Ped_3', '298_ind', 'Ped_3.txt'), delim = ' ', col_names = FALSE)

#### Conjunto de datos de genotipos ----

famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'nSNPs_IND.fam')) %>% # Se importa el archivo .fam obtenido usando plink y que posteriomente se uso para crear la hoja de parámetros para ejecutar el software molcoanc.
  select(fam) %>%
  mutate(id = 1211:1661)

ped_IND_298 <- read_delim(here('Datos', 'Datos_IND', 'Den_100.000', 'mG', 'mG_5', 'subpob_IND.txt'), delim = '\t', col_names = FALSE) %>% # Se importa el conjunto de datos donde esta la identificación de los 298 individuos genotipados.
  select(X1) %>%
  rename(fam = X1) %>%
  right_join(x = famsnps_IND, by = 'fam') %>%
  select(-fam)

bimsnps_IND <- read_bim(here('Datos', 'Datos_IND', 'Den_1.000', 'mG', 'mG_2', 'nSNPs_IND.bim'))
famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Den_1.000', 'mG', 'mG_2', 'nSNPs_IND.fam'))
bedsnps_IND <- BEDMatrix(here('Datos', 'Datos_IND', 'Den_1.000', 'mG', 'mG_2', 'nSNPs_IND.bed'), n = length(famsnps_IND$id), p = length(bimsnps_IND$id), simple_names = FALSE)
snps_IND <- as.matrix(bedsnps_IND) # Se importa la matriz de SNPs para los 298 individuos genotipados.

Geno_298 <- snps_IND %>%
  as_tibble() %>%
  bind_cols(ped_IND_298) %>%
  relocate(
    id,
    .before = V1
    ) %>%
  unite(
    'snps',
    V1:V986,
    sep = '',
    remove = TRUE
    )

Geno_298 %>%
  write_delim(here('Datos', 'Datos_IND', 'Den_1.000', 'mod_BLUPf90', 'Ped_3', '298_ind', 'Geno_298.txt'), delim = ' ', col_names = FALSE)

#### Conjunto de datos del fenotipo ----

Pob_IND_5 %>%
  write_delim(here('Datos', 'Datos_IND', 'Den_1.000', 'mod_BLUPf90', 'Ped_3', '298_ind', 'Fenotipo.txt'), delim = ' ', col_names = FALSE)

#### Conjunto de datos de  referencia cruzada (relaciona el id especificado en los archivos de pedigrí y de fenotipos con el id en el archivo de marcador) ----

Ref_cruz <- Geno_298 %>%
  select(id) %>%
  mutate(id_2 = id)

Ref_cruz %>%
  write_delim(here('Datos', 'Datos_IND', 'Den_1.000', 'mod_BLUPf90', 'Ped_3', '298_ind', 'Geno_298_RF.txt'), delim = ' ', col_names = FALSE)

## 3. Subpoblación con 451 individuos genotipados

dir.create('../Datos/Datos_IND/Den_1.000/mod_BLUPf90/Ped_3/451_ind') # Se crea el directorio donde se guardara los distintos conjuntos de datos donde se haga uso de los 451 individuos genotipados.

#### Conjunto de datos del pedigrí ----

ped_3 %>%
  write_delim(here('Datos', 'Datos_IND', 'Den_1.000', 'mod_BLUPf90', 'Ped_3', '451_ind', 'Ped_3.txt'), delim = ' ', col_names = FALSE)

#### Conjunto de datos de genotipos ----

famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'nSNPs_IND.fam')) %>% # Se importa el archivo .fam obtenido usando plink y que posteriomente se uso para crear la hoja de parámetros para ejecutar el software molcoanc.
  select(fam) %>%
  mutate(id = 1211:1661)

ped_IND_451 <- read_delim(here('Datos', 'Datos_IND', 'Den_100.000', 'mG', 'mG_8', 'subpob_IND.txt'), delim = '\t', col_names = FALSE) %>% # Se importa el conjunto de datos donde esta la identificación de los 451 individuos genotipados.
  select(X1) %>%
  rename(fam = X1) %>%
  right_join(x = famsnps_IND, by = 'fam') %>%
  select(-fam)

bimsnps_IND <- read_bim(here('Datos', 'Datos_IND', 'Den_1.000', 'mG', 'mG_3', 'nSNPs_IND.bim'))
famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Den_1.000', 'mG', 'mG_3', 'nSNPs_IND.fam'))
bedsnps_IND <- BEDMatrix(here('Datos', 'Datos_IND', 'Den_1.000', 'mG', 'mG_3', 'nSNPs_IND.bed'), n = length(famsnps_IND$id), p = length(bimsnps_IND$id), simple_names = FALSE)
snps_IND <- as.matrix(bedsnps_IND) # Se importa la matriz de SNPs para los 451 individuos genotipados.

Geno_451 <- snps_IND %>%
  as_tibble() %>%
  bind_cols(ped_IND_451) %>%
  relocate(
    id,
    .before = V1
    ) %>%
  unite(
    'snps',
    V1:V960,
    sep = '',
    remove = TRUE
    )

Geno_451 %>%
  write_delim(here('Datos', 'Datos_IND', 'Den_1.000', 'mod_BLUPf90', 'Ped_3', '451_ind', 'Geno_451.txt'), delim = ' ', col_names = FALSE)

#### Conjunto de datos del fenotipo ----

Pob_IND_5 %>%
  write_delim(here('Datos', 'Datos_IND', 'Den_1.000', 'mod_BLUPf90', 'Ped_3', '451_ind', 'Fenotipo.txt'), delim = ' ', col_names = FALSE)

#### Conjunto de datos de  referencia cruzada (relaciona el id especificado en los archivos de pedigrí y de fenotipos con el id en el archivo de marcador) ----

Ref_cruz <- Geno_451 %>%
  select(id) %>%
  mutate(id_2 = id)

Ref_cruz %>%
  write_delim(here('Datos', 'Datos_IND', 'Den_1.000', 'mod_BLUPf90', 'Ped_3', '451_ind', 'Geno_451_RF.txt'), delim = ' ', col_names = FALSE)

#######################################################
# Pedigrí 4: 300 individuos simulados en 3 generaciones
#######################################################

dir.create('../Datos/Datos_IND/Den_1.000/mod_BLUPf90/Ped_4') # Se crea el directorio donde se guardara los distintos conjuntos de datos donde se haga uso del pedigrí 4.

## 1. Subpoblación con 148 individuos genotipados

dir.create('../Datos/Datos_IND/Den_1.000/mod_BLUPf90/Ped_4/148_ind') # Se crea el directorio donde se guardara los distintos conjuntos de datos donde se haga uso de los 148 individuos genotipados.

#### Conjunto de datos del pedigrí ----

ped_4 <- read_delim(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'Molcoanc_15', 'geneal_IND.csv'), delim = ' ')

ped_4 %>%
  write_delim(here('Datos', 'Datos_IND', 'Den_1.000', 'mod_BLUPf90', 'Ped_4', '148_ind', 'Ped_4.txt'), delim = ' ', col_names = FALSE)

#### Conjunto de datos de genotipos ----

famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'nSNPs_IND.fam')) %>% # Se importa el archivo .fam obtenido usando plink y que posteriomente se uso para crear la hoja de parámetros para ejecutar el software molcoanc.
  select(fam) %>%
  mutate(id = 301:751)

ped_IND_148 <- read_delim(here('Datos', 'Datos_IND', 'Den_100.000', 'mG', 'mG_2', 'subpob_IND.txt'), delim = '\t', col_names = FALSE) %>% # Se importa el conjunto de datos donde esta la identificación de los 148 individuos genotipados.
  select(X1) %>%
  rename(fam = X1) %>%
  right_join(x = famsnps_IND, by = 'fam') %>%
  select(-fam)

bimsnps_IND <- read_bim(here('Datos', 'Datos_IND', 'Den_1.000', 'mG', 'mG_1', 'nSNPs_IND.bim'))
famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Den_1.000', 'mG', 'mG_1', 'nSNPs_IND.fam'))
bedsnps_IND <- BEDMatrix(here('Datos', 'Datos_IND', 'Den_1.000', 'mG', 'mG_1', 'nSNPs_IND.bed'), n = length(famsnps_IND$id), p = length(bimsnps_IND$id), simple_names = FALSE)
snps_IND <- as.matrix(bedsnps_IND) # Se importa la matriz de SNPs para los 148 individuos genotipados.

Geno_148 <- snps_IND %>%
  as_tibble() %>%
  bind_cols(ped_IND_148) %>%
  relocate(
    id,
    .before = V1
    ) %>%
  unite(
    'snps',
    V1:V1037,
    sep = '',
    remove = TRUE
    )

Geno_148 %>%
  write_delim(here('Datos', 'Datos_IND', 'Den_1.000', 'mod_BLUPf90', 'Ped_4', '148_ind', 'Geno_148.txt'), delim = ' ', col_names = FALSE)

#### Conjunto de datos del fenotipo ----

lin_mej <- read_delim(here('Datos', 'iris_pedigree.csv'), delim = ',') # Se importan las bases de datos de fenotipos y de linea mejorada.
Fenotipos <- read_delim(here('Datos', 'all.phenotypes.csv'), delim = ',')

Pob_mej <- lin_mej %>%
  filter(Status_with_Pedigree.plus.knowledge == 'I') %>% # Conjunto de datos solo con los individuos mejorados (los que se clasificaron como "I").
  select(X3K_DNA_IRIS_UNIQUE_ID) %>%
  rename(Variety = X3K_DNA_IRIS_UNIQUE_ID)

escalado <- function(x) { # Función usada para escalar el fenotipo.
  (x - mean(x, na.rm = TRUE)) / sd(x, na.rm = TRUE)
  }

Pob_IND <- Fenotipos %>%
  filter(SNPsubsp == 'IND') %>% # Conjunto de datos solo con la especie IND.
  mutate(
    Variety_2 = Variety,
    Fen_escalado = escalado(Time.to.flowering..from.sowing)
    ) %>%
  separate(
    col = Variety,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  ' '
  ) %>%
  unite(
    col = Variety,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  separate(
    col = Variety,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  '-'
  ) %>%
  unite(
    col = Variety,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  separate(
    col = Variety_2,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  ' '
  ) %>%
  unite(
    col = Variety_2,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  inner_join(y = Pob_mej, by = 'Variety') %>%
  select(Variety_2, Fen_escalado) %>% # Se creo el conjunto de datos con los individuos mejorados de la población indica.
  mutate(Fen_escalado = NA) %>% # Los fenotipos de estos individuos se deben colocar como NAs al formar parte de la población de validación cruzada, y al ser los individuos que se quieren predecir.
  rename(Variety = Variety_2)

Pob_IND_2 <- Fenotipos %>%
  filter(SNPsubsp == 'IND') %>% # Conjunto de datos solo con la especie IND.
  mutate(
    Variety_2 = Variety,
    Fen_escalado = escalado(Time.to.flowering..from.sowing)
    ) %>%
  separate(
    col = Variety,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  ' '
  ) %>%
  unite(
    col = Variety,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  separate(
    col = Variety,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  '-'
  ) %>%
  unite(
    col = Variety,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  separate(
    col = Variety_2,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  ' '
  ) %>%
  unite(
    col = Variety_2,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  anti_join(Pob_mej, by = 'Variety') %>%
  select(Variety_2, Fen_escalado) %>% # Se creo el conjunto de datos con los individuos no mejorados de la población indica.
  rename(Variety = Variety_2)

famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'nSNPs_IND.fam')) %>% # Se importa el archivo .fam obtenido usando plink y que posteriomente se uso para crear la hoja de parámetros para ejecutar el software molcoanc.
  select(fam) %>%
  mutate(id = 301:751) %>%
  rename(Variety = fam)

Pob_IND_3 <- Pob_IND_2 %>%
  left_join(y = famsnps_IND, by = 'Variety') # Se unen al conjunto de datos anterior (famsnps_IND) debido a que aquí esta la identificación numérica como esta en el pedigrí.

Pob_IND_4 <- Pob_IND %>%
  left_join(y = famsnps_IND, by = 'Variety') %>% # Se unen al conjunto de datos famsnps_IND debido a que aquí esta la identificación numérica como esta en el pedigrí.
  bind_rows(Pob_IND_3) %>% # Se une por filas al conjunto de datos de individuos no mejorados anterior Pob_IND_3.
  select(-Variety) %>%
  relocate(
    Fen_escalado,
    .after = id
    )

Pob_IND_5 <- tibble(
  id = seq(from = 1, to = 300, by = 1),
  Fen_escalado = rep(x = NA, times = 300)
  ) %>% # # Se crea un conjunto de datos donde estaran los fenotipos de los individuos con pedigrí simulado mediante el software molcoanc.
  bind_rows(Pob_IND_4) %>% # Se une por filas al conjunto de datos de individuos anterior Pob_IND_4.
  arrange(id) %>%
  mutate(Fen_escalado = replace_na(Fen_escalado, 0))

Pob_IND_5 %>%
  write_delim(here('Datos', 'Datos_IND', 'Den_1.000', 'mod_BLUPf90', 'Ped_4', '148_ind', 'Fenotipo.txt'), delim = ' ', col_names = FALSE)

#### Conjunto de datos de  referencia cruzada (relaciona el id especificado en los archivos de pedigrí y de fenotipos con el id en el archivo de marcador) ----

Ref_cruz <- Geno_148 %>%
  select(id) %>%
  mutate(id_2 = id)

Ref_cruz %>%
  write_delim(here('Datos', 'Datos_IND', 'Den_1.000', 'mod_BLUPf90', 'Ped_4', '148_ind', 'Geno_148_RF.txt'), delim = ' ', col_names = FALSE)

## 2. Subpoblación con 298 individuos genotipados

dir.create('../Datos/Datos_IND/Den_1.000/mod_BLUPf90/Ped_4/298_ind') # Se crea el directorio donde se guardara los distintos conjuntos de datos donde se haga uso de los 298 individuos genotipados.

#### Conjunto de datos del pedigrí ----

ped_4 %>%
  write_delim(here('Datos', 'Datos_IND', 'Den_1.000', 'mod_BLUPf90', 'Ped_4', '298_ind', 'Ped_4.txt'), delim = ' ', col_names = FALSE)

#### Conjunto de datos de genotipos ----

famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'nSNPs_IND.fam')) %>% # Se importa el archivo .fam obtenido usando plink y que posteriomente se uso para crear la hoja de parámetros para ejecutar el software molcoanc.
  select(fam) %>%
  mutate(id = 301:751)

ped_IND_298 <- read_delim(here('Datos', 'Datos_IND', 'Den_100.000', 'mG', 'mG_5', 'subpob_IND.txt'), delim = '\t', col_names = FALSE) %>% # Se importa el conjunto de datos donde esta la identificación de los 298 individuos genotipados.
  select(X1) %>%
  rename(fam = X1) %>%
  right_join(x = famsnps_IND, by = 'fam') %>%
  select(-fam)

bimsnps_IND <- read_bim(here('Datos', 'Datos_IND', 'Den_1.000', 'mG', 'mG_2', 'nSNPs_IND.bim'))
famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Den_1.000', 'mG', 'mG_2', 'nSNPs_IND.fam'))
bedsnps_IND <- BEDMatrix(here('Datos', 'Datos_IND', 'Den_1.000', 'mG', 'mG_2', 'nSNPs_IND.bed'), n = length(famsnps_IND$id), p = length(bimsnps_IND$id), simple_names = FALSE)
snps_IND <- as.matrix(bedsnps_IND) # Se importa la matriz de SNPs para los 298 individuos genotipados.

Geno_298 <- snps_IND %>%
  as_tibble() %>%
  bind_cols(ped_IND_298) %>%
  relocate(
    id,
    .before = V1
    ) %>%
  unite(
    'snps',
    V1:V986,
    sep = '',
    remove = TRUE
    )

Geno_298 %>%
  write_delim(here('Datos', 'Datos_IND', 'Den_1.000', 'mod_BLUPf90', 'Ped_4', '298_ind', 'Geno_298.txt'), delim = ' ', col_names = FALSE)

#### Conjunto de datos del fenotipo ----

Pob_IND_5 %>%
  write_delim(here('Datos', 'Datos_IND', 'Den_1.000', 'mod_BLUPf90', 'Ped_4', '298_ind', 'Fenotipo.txt'), delim = ' ', col_names = FALSE)

#### Conjunto de datos de  referencia cruzada (relaciona el id especificado en los archivos de pedigrí y de fenotipos con el id en el archivo de marcador) ----

Ref_cruz <- Geno_298 %>%
  select(id) %>%
  mutate(id_2 = id)

Ref_cruz %>%
  write_delim(here('Datos', 'Datos_IND', 'Den_1.000', 'mod_BLUPf90', 'Ped_4', '298_ind', 'Geno_298_RF.txt'), delim = ' ', col_names = FALSE)

## 3. Subpoblación con 451 individuos genotipados

dir.create('../Datos/Datos_IND/Den_1.000/mod_BLUPf90/Ped_4/451_ind') # Se crea el directorio donde se guardara los distintos conjuntos de datos donde se haga uso de los 451 individuos genotipados.

#### Conjunto de datos del pedigrí ----

ped_4 %>%
  write_delim(here('Datos', 'Datos_IND', 'Den_1.000', 'mod_BLUPf90', 'Ped_4', '451_ind', 'Ped_4.txt'), delim = ' ', col_names = FALSE)

#### Conjunto de datos de genotipos ----

famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'nSNPs_IND.fam')) %>% # Se importa el archivo .fam obtenido usando plink y que posteriomente se uso para crear la hoja de parámetros para ejecutar el software molcoanc.
  select(fam) %>%
  mutate(id = 301:751)

ped_IND_451 <- read_delim(here('Datos', 'Datos_IND', 'Den_100.000', 'mG', 'mG_8', 'subpob_IND.txt'), delim = '\t', col_names = FALSE) %>% # Se importa el conjunto de datos donde esta la identificación de los 451 individuos genotipados.
  select(X1) %>%
  rename(fam = X1) %>%
  right_join(x = famsnps_IND, by = 'fam') %>%
  select(-fam)

bimsnps_IND <- read_bim(here('Datos', 'Datos_IND', 'Den_1.000', 'mG', 'mG_3', 'nSNPs_IND.bim'))
famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Den_1.000', 'mG', 'mG_3', 'nSNPs_IND.fam'))
bedsnps_IND <- BEDMatrix(here('Datos', 'Datos_IND', 'Den_1.000', 'mG', 'mG_3', 'nSNPs_IND.bed'), n = length(famsnps_IND$id), p = length(bimsnps_IND$id), simple_names = FALSE)
snps_IND <- as.matrix(bedsnps_IND) # Se importa la matriz de SNPs para los 451 individuos genotipados.

Geno_451 <- snps_IND %>%
  as_tibble() %>%
  bind_cols(ped_IND_451) %>%
  relocate(
    id,
    .before = V1
    ) %>%
  unite(
    'snps',
    V1:V960,
    sep = '',
    remove = TRUE
    )

Geno_451 %>%
  write_delim(here('Datos', 'Datos_IND', 'Den_1.000', 'mod_BLUPf90', 'Ped_4', '451_ind', 'Geno_451.txt'), delim = ' ', col_names = FALSE)

#### Conjunto de datos del fenotipo ----

Pob_IND_5 %>%
  write_delim(here('Datos', 'Datos_IND', 'Den_1.000', 'mod_BLUPf90', 'Ped_4', '451_ind', 'Fenotipo.txt'), delim = ' ', col_names = FALSE)

#### Conjunto de datos de  referencia cruzada (relaciona el id especificado en los archivos de pedigrí y de fenotipos con el id en el archivo de marcador) ----

Ref_cruz <- Geno_451 %>%
  select(id) %>%
  mutate(id_2 = id)

Ref_cruz %>%
  write_delim(here('Datos', 'Datos_IND', 'Den_1.000', 'mod_BLUPf90', 'Ped_4', '451_ind', 'Geno_451_RF.txt'), delim = ' ', col_names = FALSE)

########################################################
# Pedigrí 5: 1530 individuos simulados en 9 generaciones
########################################################

dir.create('../Datos/Datos_IND/Den_1.000/mod_BLUPf90/Ped_5') # Se crea el directorio donde se guardara los distintos conjuntos de datos donde se haga uso del pedigrí 5.

## 1. Subpoblación con 148 individuos genotipados

dir.create('../Datos/Datos_IND/Den_1.000/mod_BLUPf90/Ped_5/148_ind') # Se crea el directorio donde se guardara los distintos conjuntos de datos donde se haga uso de los 148 individuos genotipados.

#### Conjunto de datos del pedigrí ----

ped_5 <- read_delim(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'Molcoanc_16', 'geneal_IND.csv'), delim = ' ')

ped_5 %>%
  write_delim(here('Datos', 'Datos_IND', 'Den_1.000', 'mod_BLUPf90', 'Ped_5', '148_ind', 'Ped_5.txt'), delim = ' ', col_names = FALSE)

#### Conjunto de datos de genotipos ----

famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'nSNPs_IND.fam')) %>% # Se importa el archivo .fam obtenido usando plink y que posteriomente se uso para crear la hoja de parámetros para ejecutar el software molcoanc.
  select(fam) %>%
  mutate(id = 1531:1981)

ped_IND_148 <- read_delim(here('Datos', 'Datos_IND', 'Den_100.000', 'mG', 'mG_2', 'subpob_IND.txt'), delim = '\t', col_names = FALSE) %>% # Se importa el conjunto de datos donde esta la identificación de los 148 individuos genotipados.
  select(X1) %>%
  rename(fam = X1) %>%
  right_join(x = famsnps_IND, by = 'fam') %>%
  select(-fam)

bimsnps_IND <- read_bim(here('Datos', 'Datos_IND', 'Den_1.000', 'mG', 'mG_1', 'nSNPs_IND.bim'))
famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Den_1.000', 'mG', 'mG_1', 'nSNPs_IND.fam'))
bedsnps_IND <- BEDMatrix(here('Datos', 'Datos_IND', 'Den_1.000', 'mG', 'mG_1', 'nSNPs_IND.bed'), n = length(famsnps_IND$id), p = length(bimsnps_IND$id), simple_names = FALSE)
snps_IND <- as.matrix(bedsnps_IND) # Se importa la matriz de SNPs para los 148 individuos genotipados.

Geno_148 <- snps_IND %>%
  as_tibble() %>%
  bind_cols(ped_IND_148) %>%
  relocate(
    id,
    .before = V1
    ) %>%
  unite(
    'snps',
    V1:V1037,
    sep = '',
    remove = TRUE
    )

Geno_148 %>%
  write_delim(here('Datos', 'Datos_IND', 'Den_1.000', 'mod_BLUPf90', 'Ped_5', '148_ind', 'Geno_148.txt'), delim = ' ', col_names = FALSE)

#### Conjunto de datos del fenotipo ----

lin_mej <- read_delim(here('Datos', 'iris_pedigree.csv'), delim = ',') # Se importan las bases de datos de fenotipos y de linea mejorada.
Fenotipos <- read_delim(here('Datos', 'all.phenotypes.csv'), delim = ',')

Pob_mej <- lin_mej %>%
  filter(Status_with_Pedigree.plus.knowledge == 'I') %>% # Conjunto de datos solo con los individuos mejorados (los que se clasificaron como "I").
  select(X3K_DNA_IRIS_UNIQUE_ID) %>%
  rename(Variety = X3K_DNA_IRIS_UNIQUE_ID)

escalado <- function(x) { # Función usada para escalar el fenotipo.
  (x - mean(x, na.rm = TRUE)) / sd(x, na.rm = TRUE)
  }

Pob_IND <- Fenotipos %>%
  filter(SNPsubsp == 'IND') %>% # Conjunto de datos solo con la especie IND.
  mutate(
    Variety_2 = Variety,
    Fen_escalado = escalado(Time.to.flowering..from.sowing)
    ) %>%
  separate(
    col = Variety,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  ' '
  ) %>%
  unite(
    col = Variety,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  separate(
    col = Variety,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  '-'
  ) %>%
  unite(
    col = Variety,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  separate(
    col = Variety_2,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  ' '
  ) %>%
  unite(
    col = Variety_2,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  inner_join(y = Pob_mej, by = 'Variety') %>%
  select(Variety_2, Fen_escalado) %>% # Se creo el conjunto de datos con los individuos mejorados de la población indica.
  mutate(Fen_escalado = NA) %>% # Los fenotipos de estos individuos se deben colocar como NAs al formar parte de la población de validación cruzada, y al ser los individuos que se quieren predecir.
  rename(Variety = Variety_2)

Pob_IND_2 <- Fenotipos %>%
  filter(SNPsubsp == 'IND') %>% # Conjunto de datos solo con la especie IND.
  mutate(
    Variety_2 = Variety,
    Fen_escalado = escalado(Time.to.flowering..from.sowing)
    ) %>%
  separate(
    col = Variety,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  ' '
  ) %>%
  unite(
    col = Variety,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  separate(
    col = Variety,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  '-'
  ) %>%
  unite(
    col = Variety,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  separate(
    col = Variety_2,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  ' '
  ) %>%
  unite(
    col = Variety_2,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  anti_join(Pob_mej, by = 'Variety') %>%
  select(Variety_2, Fen_escalado) %>% # Se creo el conjunto de datos con los individuos no mejorados de la población indica.
  rename(Variety = Variety_2)

famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'nSNPs_IND.fam')) %>% # Se importa el archivo .fam obtenido usando plink y que posteriomente se uso para crear la hoja de parámetros para ejecutar el software molcoanc.
  select(fam) %>%
  mutate(id = 1531:1981) %>%
  rename(Variety = fam)

Pob_IND_3 <- Pob_IND_2 %>%
  left_join(y = famsnps_IND, by = 'Variety') # Se unen al conjunto de datos anterior (famsnps_IND) debido a que aquí esta la identificación numérica como esta en el pedigrí.

Pob_IND_4 <- Pob_IND %>%
  left_join(y = famsnps_IND, by = 'Variety') %>% # Se unen al conjunto de datos famsnps_IND debido a que aquí esta la identificación numérica como esta en el pedigrí.
  bind_rows(Pob_IND_3) %>% # Se une por filas al conjunto de datos de individuos no mejorados anterior Pob_IND_3.
  select(-Variety) %>%
  relocate(
    Fen_escalado,
    .after = id
    )

Pob_IND_5 <- tibble(
  id = seq(from = 1, to = 1530, by = 1),
  Fen_escalado = rep(x = NA, times = 1530)
  ) %>% # # Se crea un conjunto de datos donde estaran los fenotipos de los individuos con pedigrí simulado mediante el software molcoanc.
  bind_rows(Pob_IND_4) %>% # Se une por filas al conjunto de datos de individuos anterior Pob_IND_4.
  arrange(id) %>%
  mutate(Fen_escalado = replace_na(Fen_escalado, 0))

Pob_IND_5 %>%
  write_delim(here('Datos', 'Datos_IND', 'Den_1.000', 'mod_BLUPf90', 'Ped_5', '148_ind', 'Fenotipo.txt'), delim = ' ', col_names = FALSE)

#### Conjunto de datos de  referencia cruzada (relaciona el id especificado en los archivos de pedigrí y de fenotipos con el id en el archivo de marcador) ----

Ref_cruz <- Geno_148 %>%
  select(id) %>%
  mutate(id_2 = id)

Ref_cruz %>%
  write_delim(here('Datos', 'Datos_IND', 'Den_1.000', 'mod_BLUPf90', 'Ped_5', '148_ind', 'Geno_148_RF.txt'), delim = ' ', col_names = FALSE)

## 2. Subpoblación con 298 individuos genotipados

dir.create('../Datos/Datos_IND/Den_1.000/mod_BLUPf90/Ped_5/298_ind') # Se crea el directorio donde se guardara los distintos conjuntos de datos donde se haga uso de los 298 individuos genotipados.

#### Conjunto de datos del pedigrí ----

ped_5 %>%
  write_delim(here('Datos', 'Datos_IND', 'Den_1.000', 'mod_BLUPf90', 'Ped_5', '298_ind', 'Ped_5.txt'), delim = ' ', col_names = FALSE)

#### Conjunto de datos de genotipos ----

famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'nSNPs_IND.fam')) %>% # Se importa el archivo .fam obtenido usando plink y que posteriomente se uso para crear la hoja de parámetros para ejecutar el software molcoanc.
  select(fam) %>%
  mutate(id = 1531:1981)

ped_IND_298 <- read_delim(here('Datos', 'Datos_IND', 'Den_100.000', 'mG', 'mG_5', 'subpob_IND.txt'), delim = '\t', col_names = FALSE) %>% # Se importa el conjunto de datos donde esta la identificación de los 298 individuos genotipados.
  select(X1) %>%
  rename(fam = X1) %>%
  right_join(x = famsnps_IND, by = 'fam') %>%
  select(-fam)

bimsnps_IND <- read_bim(here('Datos', 'Datos_IND', 'Den_1.000', 'mG', 'mG_2', 'nSNPs_IND.bim'))
famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Den_1.000', 'mG', 'mG_2', 'nSNPs_IND.fam'))
bedsnps_IND <- BEDMatrix(here('Datos', 'Datos_IND', 'Den_1.000', 'mG', 'mG_2', 'nSNPs_IND.bed'), n = length(famsnps_IND$id), p = length(bimsnps_IND$id), simple_names = FALSE)
snps_IND <- as.matrix(bedsnps_IND) # Se importa la matriz de SNPs para los 298 individuos genotipados.

Geno_298 <- snps_IND %>%
  as_tibble() %>%
  bind_cols(ped_IND_298) %>%
  relocate(
    id,
    .before = V1
    ) %>%
  unite(
    'snps',
    V1:V986,
    sep = '',
    remove = TRUE
    )

Geno_298 %>%
  write_delim(here('Datos', 'Datos_IND', 'Den_1.000', 'mod_BLUPf90', 'Ped_5', '298_ind', 'Geno_298.txt'), delim = ' ', col_names = FALSE)

#### Conjunto de datos del fenotipo ----

Pob_IND_5 %>%
  write_delim(here('Datos', 'Datos_IND', 'Den_1.000', 'mod_BLUPf90', 'Ped_5', '298_ind', 'Fenotipo.txt'), delim = ' ', col_names = FALSE)

#### Conjunto de datos de  referencia cruzada (relaciona el id especificado en los archivos de pedigrí y de fenotipos con el id en el archivo de marcador) ----

Ref_cruz <- Geno_298 %>%
  select(id) %>%
  mutate(id_2 = id)

Ref_cruz %>%
  write_delim(here('Datos', 'Datos_IND', 'Den_1.000', 'mod_BLUPf90', 'Ped_5', '298_ind', 'Geno_298_RF.txt'), delim = ' ', col_names = FALSE)

## 3. Subpoblación con 451 individuos genotipados

dir.create('../Datos/Datos_IND/Den_1.000/mod_BLUPf90/Ped_5/451_ind') # Se crea el directorio donde se guardara los distintos conjuntos de datos donde se haga uso de los 451 individuos genotipados.

#### Conjunto de datos del pedigrí ----

ped_5 %>%
  write_delim(here('Datos', 'Datos_IND', 'Den_1.000', 'mod_BLUPf90', 'Ped_5', '451_ind', 'Ped_5.txt'), delim = ' ', col_names = FALSE)

#### Conjunto de datos de genotipos ----

famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'nSNPs_IND.fam')) %>% # Se importa el archivo .fam obtenido usando plink y que posteriomente se uso para crear la hoja de parámetros para ejecutar el software molcoanc.
  select(fam) %>%
  mutate(id = 1531:1981)

ped_IND_451 <- read_delim(here('Datos', 'Datos_IND', 'Den_100.000', 'mG', 'mG_8', 'subpob_IND.txt'), delim = '\t', col_names = FALSE) %>% # Se importa el conjunto de datos donde esta la identificación de los 451 individuos genotipados.
  select(X1) %>%
  rename(fam = X1) %>%
  right_join(x = famsnps_IND, by = 'fam') %>%
  select(-fam)

bimsnps_IND <- read_bim(here('Datos', 'Datos_IND', 'Den_1.000', 'mG', 'mG_3', 'nSNPs_IND.bim'))
famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Den_1.000', 'mG', 'mG_3', 'nSNPs_IND.fam'))
bedsnps_IND <- BEDMatrix(here('Datos', 'Datos_IND', 'Den_1.000', 'mG', 'mG_3', 'nSNPs_IND.bed'), n = length(famsnps_IND$id), p = length(bimsnps_IND$id), simple_names = FALSE)
snps_IND <- as.matrix(bedsnps_IND) # Se importa la matriz de SNPs para los 451 individuos genotipados.

Geno_451 <- snps_IND %>%
  as_tibble() %>%
  bind_cols(ped_IND_451) %>%
  relocate(
    id,
    .before = V1
    ) %>%
  unite(
    'snps',
    V1:V960,
    sep = '',
    remove = TRUE
    )

Geno_451 %>%
  write_delim(here('Datos', 'Datos_IND', 'Den_1.000', 'mod_BLUPf90', 'Ped_5', '451_ind', 'Geno_451.txt'), delim = ' ', col_names = FALSE)

#### Conjunto de datos del fenotipo ----

Pob_IND_5 %>%
  write_delim(here('Datos', 'Datos_IND', 'Den_1.000', 'mod_BLUPf90', 'Ped_5', '451_ind', 'Fenotipo.txt'), delim = ' ', col_names = FALSE)

#### Conjunto de datos de  referencia cruzada (relaciona el id especificado en los archivos de pedigrí y de fenotipos con el id en el archivo de marcador) ----

Ref_cruz <- Geno_451 %>%
  select(id) %>%
  mutate(id_2 = id)

Ref_cruz %>%
  write_delim(here('Datos', 'Datos_IND', 'Den_1.000', 'mod_BLUPf90', 'Ped_5', '451_ind', 'Geno_451_RF.txt'), delim = ' ', col_names = FALSE)
```

# 22. A continuación se realiza la predicción usando el paquete de R lme4GS para distintos pedigríes y diferentes densidades de SNPs.

```{r Ajuste de modelos con lme4GS para distintos pedigríes y diferentes densidades de SNPs}

#### Población de arroz IND (100.000 SNPs) ----

dir.create('../Datos/Datos_IND/Den_100.000_b/mod_lme4GS') # Se crea una carpeta donde se guardaran los resultados de los modelos que se ajustaran para las distintas subpoblaciones de individuos genotipados con distintos pedigríes, con una desnidad de SNPs de 100.000.

# 1. Se importan las bases de datos de fenotipos y de linea mejorada.

lin_mej <- read_delim(here('Datos', 'iris_pedigree.csv'), delim = ',')
Fenotipos <- read_delim(here('Datos', 'all.phenotypes.csv'), delim = ',')

#### Población de arroz IND ----

# 2. Se crea un conjunto de datos que contiene solo los individuos mejorados.

Pob_mej <- lin_mej %>%
  filter(Status_with_Pedigree.plus.knowledge == 'I') %>% # Conjunto de datos solo con los individuos mejorados (los que se clasificaron como "I").
  select(X3K_DNA_IRIS_UNIQUE_ID) %>%
  rename(Variety = X3K_DNA_IRIS_UNIQUE_ID)

escalado <- function(x) { # Función usada para escalar el fenotipo.
  (x - mean(x, na.rm = TRUE)) / sd(x, na.rm = TRUE)
  }

Pob_IND <- Fenotipos %>%
  filter(SNPsubsp == 'IND') %>% # Conjunto de datos solo con la especie IND.
  mutate(
    Variety_2 = Variety,
    Fen_escalado = escalado(Time.to.flowering..from.sowing)
    ) %>%
  separate(
    col = Variety,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  ' '
  ) %>%
  unite(
    col = Variety,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  separate(
    col = Variety,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  '-'
  ) %>%
  unite(
    col = Variety,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  separate(
    col = Variety_2,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  ' '
  ) %>%
  unite(
    col = Variety_2,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  inner_join(y = Pob_mej, by = 'Variety') %>%
  select(Variety_2, Fen_escalado) %>% # Se creo el conjunto de datos con los individuos mejorados de la población indica.
  mutate(Fen_escalado = NA) %>% # Los fenotipos de estos individuos se deben colocar como NAs al formar parte de la población de validación cruzada, y al ser los individuos que se quieren predecir.
  rename(Variety = Variety_2)

# 3. Se crea un conjunto de datos que no contiene los individuos mejorados.

Pob_IND_2 <- Fenotipos %>%
  filter(SNPsubsp == 'IND') %>% # Conjunto de datos solo con la especie IND.
  mutate(
    Variety_2 = Variety,
    Fen_escalado = escalado(Time.to.flowering..from.sowing)
    ) %>%
  separate(
    col = Variety,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  ' '
  ) %>%
  unite(
    col = Variety,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  separate(
    col = Variety,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  '-'
  ) %>%
  unite(
    col = Variety,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  separate(
    col = Variety_2,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  ' '
  ) %>%
  unite(
    col = Variety_2,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  anti_join(Pob_mej, by = 'Variety') %>%
  select(Variety_2, Fen_escalado) %>% # Se creo el conjunto de datos con los individuos no mejorados de la población indica.
  rename(Variety = Variety_2)

#########################################################
# Pedigrí 1: 2000 individuos simulados en 10 generaciones
#########################################################

# 4. Se importa el archivo .fam obtenido usando plink y que posteriomente se uso para crear la hoja de parámetros para ejecutar el software molcoanc.

famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'nSNPs_IND.fam')) %>% 
  select(fam) %>%
  mutate(id = 2001:2451) %>%
  rename(Variety = fam)

# 5. Se unen en un solo conjuntos de datos los individuos mejorados y no mejorados.

Pob_IND_3 <- Pob_IND_2 %>%
  left_join(y = famsnps_IND, by = 'Variety') # Se unen al conjunto de datos anterior (famsnps_IND) debido a que aquí esta la identificación numérica como esta en el pedigrí.

Pob_IND_4 <- Pob_IND %>%
  left_join(y = famsnps_IND, by = 'Variety') %>% # Se unen al conjunto de datos famsnps_IND debido a que aquí esta la identificación numérica como esta en el pedigrí.
  bind_rows(Pob_IND_3) %>% # Se une por filas al conjunto de datos de individuos no mejorados anterior Pob_IND_3.
  select(-Variety) %>%
  relocate(
    Fen_escalado,
    .after = id
    )

# 6. Se crea un conjunto de datos donde estaran los fenotipos de los individuos con pedigrí simulado mediante el software molcoanc, y se une posteriormente con el conjunto de datos anterior.

Pob_IND_5 <- tibble(
  id = seq(from = 1, to = 2000, by = 1),
  Fen_escalado = rep(x = NA, times = 2000)
  ) %>%
  bind_rows(Pob_IND_4) %>%
  arrange(id)

##########################################
# Uso del paquete lme4GS para el pedigrí 1
##########################################

dir.create('../Datos/Datos_IND/Den_100.000_b/mod_lme4GS/Ped_1') # Se crea una carpeta donde se guardaran los resultados del pedigríe 1.

## 1. Subpoblación con 148 individuos genotipados

# a) Se preparan los datos de entrada ----

mH_IND_1 <- readRDS(here('Datos', 'Datos_IND', 'Den_100.000_b', 'mH', 'Ped_1', 'mH_1', 'mH_1.RDS')) %>% # Se carga la matriz H de los 148 individuos genotipados de la población IND.
  as.matrix()

Fen_IND <- Pob_IND_5 # Se carga el conjunto de datos donde estan los fenotipos y la identificación de los individuos.

Fen_IND$id <- rownames(mH_IND_1)

# b) Se ajusta el modelo ----

dir.create('../Datos/Datos_IND/Den_100.000_b/mod_lme4GS/Ped_1/mod_lme4GS_1/') # Se crea una carpeta para guardar los resultados del modelo anteriormente ajustado para 148 indiviuos genotipados.

mod_IND_1 <- lmerUvcov(formula = Fen_escalado ~ (1 | id), data = Fen_IND, Uvcov = list(id = list(K = mH_IND_1))) # Con la función lmerUvcov, se ajusta el modelo lineal mixto con una matriz de varianza-covarianza proporcionada (aquí la matriz H). Esta función toma como entrada una fórmula para especificar la respuesta (Fen_escalado), los efectos fijos (aquí no los hay) y los efectos aleatorios (los individuos), un data.frame y una lista (Uvcov) para especificar la matriz de varianza-covarianza para los efectos aleatorios.

save(mod_IND_1, file = '../Datos/Datos_IND/Den_100.000_b/mod_lme4GS/Ped_1/mod_lme4GS_1/mod_lme4GS_1.RData')

## 2. Subpoblación con 298 individuos genotipados

# a) Se preparan los datos de entrada ----

mH_IND_2 <- readRDS(here('Datos', 'Datos_IND', 'Den_100.000_b', 'mH', 'Ped_1', 'mH_2', 'mH_2.RDS')) %>% # Se carga la matriz H de los 298 individuos genotipados de la población IND.
  as.matrix()

Fen_IND <- Pob_IND_5 # Se carga el conjunto de datos donde estan los fenotipos y la identificación de los individuos.

Fen_IND$id <- rownames(mH_IND_2)

# b) Se ajusta el modelo ----

dir.create('../Datos/Datos_IND/Den_100.000_b/mod_lme4GS/Ped_1/mod_lme4GS_2/') # Se crea una carpeta para guardar los resultados del modelo anteriormente ajustado para 298 indiviuos genotipados.

mod_IND_2 <- lmerUvcov(formula = Fen_escalado ~ (1 | id), data = Fen_IND, Uvcov = list(id = list(K = mH_IND_2)))

save(mod_IND_2, file = '../Datos/Datos_IND/Den_100.000_b/mod_lme4GS/Ped_1/mod_lme4GS_2/mod_lme4GS_2.RData')

## 3. Subpoblación con 451 individuos genotipados

# a) Se preparan los datos de entrada ----

mH_IND_3 <- readRDS(here('Datos', 'Datos_IND', 'Den_100.000_b', 'mH', 'Ped_1', 'mH_3', 'mH_3.RDS')) %>% # Se carga la matriz H de los 451 individuos genotipados de la población IND.
  as.matrix()

Fen_IND <- Pob_IND_5 # Se carga el conjunto de datos donde estan los fenotipos y la identificación de los individuos.

Fen_IND$id <- rownames(mH_IND_3)

# b) Se ajusta el modelo ----

dir.create('../Datos/Datos_IND/Den_100.000_b/mod_lme4GS/Ped_1/mod_lme4GS_3/') # Se crea una carpeta para guardar los resultados del modelo anteriormente ajustado para 298 indiviuos genotipados.

mod_IND_3 <- lmerUvcov(formula = Fen_escalado ~ (1 | id), data = Fen_IND, Uvcov = list(id = list(K = mH_IND_3)))

save(mod_IND_3, file = '../Datos/Datos_IND/Den_100.000_b/mod_lme4GS/Ped_1/mod_lme4GS_3/mod_lme4GS_3.RData')

## 4. Subpoblación con ningún individuo genotipado

# a) Se preparan los datos de entrada ----

mA_IND <- readRDS(here('Datos', 'Datos_IND', 'Den_100.000_b', 'mH', 'Ped_1', 'mA', 'mA.RDS')) %>% # Se carga la matriz A de los individuos de la población IND.
  as.matrix()

Fen_IND <- Pob_IND_5 # Se carga el conjunto de datos donde estan los fenotipos y la identificación de los individuos.

Fen_IND$id <- rownames(mA_IND)

# b) Se ajusta el modelo ----

dir.create('../Datos/Datos_IND/Den_100.000_b/mod_lme4GS/Ped_1/mod_lme4GS_4/') # Se crea una carpeta para guardar los resultados del modelo anteriormente ajustado para 298 indiviuos genotipados.

mod_IND_4 <- lmerUvcov(formula = Fen_escalado ~ (1 | id), data = Fen_IND, Uvcov = list(id = list(K = mA_IND)))

save(mod_IND_4, file = '../Datos/Datos_IND/Den_100.000_b/mod_lme4GS/Ped_1/mod_lme4GS_4/mod_lme4GS_4.RData')

########################################################
# Pedigrí 3: 1210 individuos simulados en 7 generaciones
########################################################

# 4. Se importa el archivo .fam obtenido usando plink y que posteriomente se uso para crear la hoja de parámetros para ejecutar el software molcoanc.

famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'nSNPs_IND.fam')) %>% 
  select(fam) %>%
  mutate(id = 1211:1661) %>%
  rename(Variety = fam)

# 5. Se unen en un solo conjuntos de datos los individuos mejorados y no mejorados.

Pob_IND_3 <- Pob_IND_2 %>%
  left_join(y = famsnps_IND, by = 'Variety') # Se unen al conjunto de datos anterior (famsnps_IND) debido a que aquí esta la identificación numérica como esta en el pedigrí.

Pob_IND_4 <- Pob_IND %>%
  left_join(y = famsnps_IND, by = 'Variety') %>% # Se unen al conjunto de datos famsnps_IND debido a que aquí esta la identificación numérica como esta en el pedigrí.
  bind_rows(Pob_IND_3) %>% # Se une por filas al conjunto de datos de individuos no mejorados anterior Pob_IND_3.
  select(-Variety) %>%
  relocate(
    Fen_escalado,
    .after = id
    )

# 6. Se crea un conjunto de datos donde estaran los fenotipos de los individuos con pedigrí simulado mediante el software molcoanc, y se une posteriormente con el conjunto de datos anterior.

Pob_IND_5 <- tibble(
  id = seq(from = 1, to = 1210, by = 1),
  Fen_escalado = rep(x = NA, times = 1210)
  ) %>%
  bind_rows(Pob_IND_4) %>%
  arrange(id)

##########################################
# Uso del paquete lme4GS para el pedigrí 3
##########################################

dir.create('../Datos/Datos_IND/Den_100.000_b/mod_lme4GS/Ped_3') # Se crea una carpeta donde se guardaran los resultados del pedigríe 3.

## 1. Subpoblación con 148 individuos genotipados

# a) Se preparan los datos de entrada ----

mH_IND_1 <- readRDS(here('Datos', 'Datos_IND', 'Den_100.000_b', 'mH', 'Ped_3', 'mH_1', 'mH_1.RDS')) %>% # Se carga la matriz H de los 148 individuos genotipados de la población IND.
  as.matrix()

Fen_IND <- Pob_IND_5 # Se carga el conjunto de datos donde estan los fenotipos y la identificación de los individuos.

Fen_IND$id <- rownames(mH_IND_1)

# b) Se ajusta el modelo ----

dir.create('../Datos/Datos_IND/Den_100.000_b/mod_lme4GS/Ped_3/mod_lme4GS_1/') # Se crea una carpeta para guardar los resultados del modelo anteriormente ajustado para 148 indiviuos genotipados.

mod_IND_1 <- lmerUvcov(formula = Fen_escalado ~ (1 | id), data = Fen_IND, Uvcov = list(id = list(K = mH_IND_1)))

save(mod_IND_1, file = '../Datos/Datos_IND/Den_100.000_b/mod_lme4GS/Ped_3/mod_lme4GS_1/mod_lme4GS_1.RData')

## 2. Subpoblación con 298 individuos genotipados

# a) Se preparan los datos de entrada ----

mH_IND_2 <- readRDS(here('Datos', 'Datos_IND', 'Den_100.000_b', 'mH', 'Ped_3', 'mH_2', 'mH_2.RDS')) %>% # Se carga la matriz H de los 298 individuos genotipados de la población IND.
  as.matrix()

Fen_IND <- Pob_IND_5 # Se carga el conjunto de datos donde estan los fenotipos y la identificación de los individuos.

Fen_IND$id <- rownames(mH_IND_2)

# b) Se ajusta el modelo ----

dir.create('../Datos/Datos_IND/Den_100.000_b/mod_lme4GS/Ped_3/mod_lme4GS_2/') # Se crea una carpeta para guardar los resultados del modelo anteriormente ajustado para 298 indiviuos genotipados.

mod_IND_2 <- lmerUvcov(formula = Fen_escalado ~ (1 | id), data = Fen_IND, Uvcov = list(id = list(K = mH_IND_2)))

save(mod_IND_2, file = '../Datos/Datos_IND/Den_100.000_b/mod_lme4GS/Ped_3/mod_lme4GS_2/mod_lme4GS_2.RData')

## 3. Subpoblación con 451 individuos genotipados

# a) Se preparan los datos de entrada ----

mH_IND_3 <- readRDS(here('Datos', 'Datos_IND', 'Den_100.000_b', 'mH', 'Ped_3', 'mH_3', 'mH_3.RDS')) %>% # Se carga la matriz H de los 451 individuos genotipados de la población IND.
  as.matrix()

Fen_IND <- Pob_IND_5 # Se carga el conjunto de datos donde estan los fenotipos y la identificación de los individuos.

Fen_IND$id <- rownames(mH_IND_3)

# b) Se ajusta el modelo ----

dir.create('../Datos/Datos_IND/Den_100.000_b/mod_lme4GS/Ped_3/mod_lme4GS_3/') # Se crea una carpeta para guardar los resultados del modelo anteriormente ajustado para 298 indiviuos genotipados.

mod_IND_3 <- lmerUvcov(formula = Fen_escalado ~ (1 | id), data = Fen_IND, Uvcov = list(id = list(K = mH_IND_3)))

save(mod_IND_3, file = '../Datos/Datos_IND/Den_100.000_b/mod_lme4GS/Ped_3/mod_lme4GS_3/mod_lme4GS_3.RData')

## 4. Subpoblación con ningún individuo genotipado

# a) Se preparan los datos de entrada ----

mA_IND <- readRDS(here('Datos', 'Datos_IND', 'Den_100.000_b', 'mH', 'Ped_3', 'mA', 'mA.RDS')) %>% # Se carga la matriz A de los individuos de la población IND.
  as.matrix()

Fen_IND <- Pob_IND_5 # Se carga el conjunto de datos donde estan los fenotipos y la identificación de los individuos.

Fen_IND$id <- rownames(mA_IND)

# b) Se ajusta el modelo ----

dir.create('../Datos/Datos_IND/Den_100.000_b/mod_lme4GS/Ped_3/mod_lme4GS_4/') # Se crea una carpeta para guardar los resultados del modelo anteriormente ajustado para 298 indiviuos genotipados.

mod_IND_4 <- lmerUvcov(formula = Fen_escalado ~ (1 | id), data = Fen_IND, Uvcov = list(id = list(K = mA_IND)))

save(mod_IND_4, file = '../Datos/Datos_IND/Den_100.000_b/mod_lme4GS/Ped_3/mod_lme4GS_4/mod_lme4GS_4.RData')

#######################################################
# Pedigrí 4: 300 individuos simulados en 3 generaciones
#######################################################

# 4. Se importa el archivo .fam obtenido usando plink y que posteriomente se uso para crear la hoja de parámetros para ejecutar el software molcoanc.

famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'nSNPs_IND.fam')) %>% 
  select(fam) %>%
  mutate(id = 301:751) %>%
  rename(Variety = fam)

# 5. Se unen en un solo conjuntos de datos los individuos mejorados y no mejorados.

Pob_IND_3 <- Pob_IND_2 %>%
  left_join(y = famsnps_IND, by = 'Variety') # Se unen al conjunto de datos anterior (famsnps_IND) debido a que aquí esta la identificación numérica como esta en el pedigrí.

Pob_IND_4 <- Pob_IND %>%
  left_join(y = famsnps_IND, by = 'Variety') %>% # Se unen al conjunto de datos famsnps_IND debido a que aquí esta la identificación numérica como esta en el pedigrí.
  bind_rows(Pob_IND_3) %>% # Se une por filas al conjunto de datos de individuos no mejorados anterior Pob_IND_3.
  select(-Variety) %>%
  relocate(
    Fen_escalado,
    .after = id
    )

# 6. Se crea un conjunto de datos donde estaran los fenotipos de los individuos con pedigrí simulado mediante el software molcoanc, y se une posteriormente con el conjunto de datos anterior.

Pob_IND_5 <- tibble(
  id = seq(from = 1, to = 300, by = 1),
  Fen_escalado = rep(x = NA, times = 300)
  ) %>%
  bind_rows(Pob_IND_4) %>%
  arrange(id)

##########################################
# Uso del paquete lme4GS para el pedigrí 4
##########################################

dir.create('../Datos/Datos_IND/Den_100.000_b/mod_lme4GS/Ped_4') # Se crea una carpeta donde se guardaran los resultados del pedigríe 4.

## 1. Subpoblación con 148 individuos genotipados

# a) Se preparan los datos de entrada ----

mH_IND_1 <- readRDS(here('Datos', 'Datos_IND', 'Den_100.000_b', 'mH', 'Ped_4', 'mH_1', 'mH_1.RDS')) %>% # Se carga la matriz H de los 148 individuos genotipados de la población IND.
  as.matrix()

Fen_IND <- Pob_IND_5 # Se carga el conjunto de datos donde estan los fenotipos y la identificación de los individuos.

Fen_IND$id <- rownames(mH_IND_1)

# b) Se ajusta el modelo ----

dir.create('../Datos/Datos_IND/Den_100.000_b/mod_lme4GS/Ped_4/mod_lme4GS_1/') # Se crea una carpeta para guardar los resultados del modelo anteriormente ajustado para 148 indiviuos genotipados.

mod_IND_1 <- lmerUvcov(formula = Fen_escalado ~ (1 | id), data = Fen_IND, Uvcov = list(id = list(K = mH_IND_1)))

save(mod_IND_1, file = '../Datos/Datos_IND/Den_100.000_b/mod_lme4GS/Ped_4/mod_lme4GS_1/mod_lme4GS_1.RData')

## 2. Subpoblación con 298 individuos genotipados

# a) Se preparan los datos de entrada ----

mH_IND_2 <- readRDS(here('Datos', 'Datos_IND', 'Den_100.000_b', 'mH', 'Ped_4', 'mH_2', 'mH_2.RDS')) %>% # Se carga la matriz H de los 298 individuos genotipados de la población IND.
  as.matrix()

Fen_IND <- Pob_IND_5 # Se carga el conjunto de datos donde estan los fenotipos y la identificación de los individuos.

Fen_IND$id <- rownames(mH_IND_2)

# b) Se ajusta el modelo ----

dir.create('../Datos/Datos_IND/Den_100.000_b/mod_lme4GS/Ped_4/mod_lme4GS_2/') # Se crea una carpeta para guardar los resultados del modelo anteriormente ajustado para 298 indiviuos genotipados.

mod_IND_2 <- lmerUvcov(formula = Fen_escalado ~ (1 | id), data = Fen_IND, Uvcov = list(id = list(K = mH_IND_2)))

save(mod_IND_2, file = '../Datos/Datos_IND/Den_100.000_b/mod_lme4GS/Ped_4/mod_lme4GS_2/mod_lme4GS_2.RData')

## 3. Subpoblación con 451 individuos genotipados

# a) Se preparan los datos de entrada ----

mH_IND_3 <- readRDS(here('Datos', 'Datos_IND', 'Den_100.000_b', 'mH', 'Ped_4', 'mH_3', 'mH_3.RDS')) %>% # Se carga la matriz H de los 451 individuos genotipados de la población IND.
  as.matrix()

Fen_IND <- Pob_IND_5 # Se carga el conjunto de datos donde estan los fenotipos y la identificación de los individuos.

Fen_IND$id <- rownames(mH_IND_3)

# b) Se ajusta el modelo ----

dir.create('../Datos/Datos_IND/Den_100.000_b/mod_lme4GS/Ped_4/mod_lme4GS_3/') # Se crea una carpeta para guardar los resultados del modelo anteriormente ajustado para 298 indiviuos genotipados.

mod_IND_3 <- lmerUvcov(formula = Fen_escalado ~ (1 | id), data = Fen_IND, Uvcov = list(id = list(K = mH_IND_3)))

save(mod_IND_3, file = '../Datos/Datos_IND/Den_100.000_b/mod_lme4GS/Ped_4/mod_lme4GS_3/mod_lme4GS_3.RData')

## 4. Subpoblación con ningún individuo genotipado

# a) Se preparan los datos de entrada ----

mA_IND <- readRDS(here('Datos', 'Datos_IND', 'Den_100.000_b', 'mH', 'Ped_4', 'mA', 'mA.RDS')) %>% # Se carga la matriz A de los individuos de la población IND.
  as.matrix()

Fen_IND <- Pob_IND_5 # Se carga el conjunto de datos donde estan los fenotipos y la identificación de los individuos.

Fen_IND$id <- rownames(mA_IND)

# b) Se ajusta el modelo ----

dir.create('../Datos/Datos_IND/Den_100.000_b/mod_lme4GS/Ped_4/mod_lme4GS_4/') # Se crea una carpeta para guardar los resultados del modelo anteriormente ajustado para 298 indiviuos genotipados.

mod_IND_4 <- lmerUvcov(formula = Fen_escalado ~ (1 | id), data = Fen_IND, Uvcov = list(id = list(K = mA_IND)))

save(mod_IND_4, file = '../Datos/Datos_IND/Den_100.000_b/mod_lme4GS/Ped_4/mod_lme4GS_4/mod_lme4GS_4.RData')

#### Población de arroz IND (10.000 SNPs) ----

dir.create('../Datos/Datos_IND/Den_10.000/mod_lme4GS') # Se crea una carpeta donde se guardaran los resultados de los modelos que se ajustaran para las distintas subpoblaciones de individuos genotipados con distintos pedigríes, con una desnidad de SNPs de 10.000.

# 1. Se importan las bases de datos de fenotipos y de linea mejorada.

lin_mej <- read_delim(here('Datos', 'iris_pedigree.csv'), delim = ',')
Fenotipos <- read_delim(here('Datos', 'all.phenotypes.csv'), delim = ',')

#### Población de arroz IND ----

# 2. Se crea un conjunto de datos que contiene solo los individuos mejorados.

Pob_mej <- lin_mej %>%
  filter(Status_with_Pedigree.plus.knowledge == 'I') %>% # Conjunto de datos solo con los individuos mejorados (los que se clasificaron como "I").
  select(X3K_DNA_IRIS_UNIQUE_ID) %>%
  rename(Variety = X3K_DNA_IRIS_UNIQUE_ID)

escalado <- function(x) { # Función usada para escalar el fenotipo.
  (x - mean(x, na.rm = TRUE)) / sd(x, na.rm = TRUE)
  }

Pob_IND <- Fenotipos %>%
  filter(SNPsubsp == 'IND') %>% # Conjunto de datos solo con la especie IND.
  mutate(
    Variety_2 = Variety,
    Fen_escalado = escalado(Time.to.flowering..from.sowing)
    ) %>%
  separate(
    col = Variety,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  ' '
  ) %>%
  unite(
    col = Variety,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  separate(
    col = Variety,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  '-'
  ) %>%
  unite(
    col = Variety,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  separate(
    col = Variety_2,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  ' '
  ) %>%
  unite(
    col = Variety_2,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  inner_join(y = Pob_mej, by = 'Variety') %>%
  select(Variety_2, Fen_escalado) %>% # Se creo el conjunto de datos con los individuos mejorados de la población indica.
  mutate(Fen_escalado = NA) %>% # Los fenotipos de estos individuos se deben colocar como NAs al formar parte de la población de validación cruzada, y al ser los individuos que se quieren predecir.
  rename(Variety = Variety_2)

# 3. Se crea un conjunto de datos que no contiene los individuos mejorados.

Pob_IND_2 <- Fenotipos %>%
  filter(SNPsubsp == 'IND') %>% # Conjunto de datos solo con la especie IND.
  mutate(
    Variety_2 = Variety,
    Fen_escalado = escalado(Time.to.flowering..from.sowing)
    ) %>%
  separate(
    col = Variety,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  ' '
  ) %>%
  unite(
    col = Variety,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  separate(
    col = Variety,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  '-'
  ) %>%
  unite(
    col = Variety,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  separate(
    col = Variety_2,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  ' '
  ) %>%
  unite(
    col = Variety_2,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  anti_join(Pob_mej, by = 'Variety') %>%
  select(Variety_2, Fen_escalado) %>% # Se creo el conjunto de datos con los individuos no mejorados de la población indica.
  rename(Variety = Variety_2)

#########################################################
# Pedigrí 1: 2000 individuos simulados en 10 generaciones
#########################################################

# 4. Se importa el archivo .fam obtenido usando plink y que posteriomente se uso para crear la hoja de parámetros para ejecutar el software molcoanc.

famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'nSNPs_IND.fam')) %>% 
  select(fam) %>%
  mutate(id = 2001:2451) %>%
  rename(Variety = fam)

# 5. Se unen en un solo conjuntos de datos los individuos mejorados y no mejorados.

Pob_IND_3 <- Pob_IND_2 %>%
  left_join(y = famsnps_IND, by = 'Variety') # Se unen al conjunto de datos anterior (famsnps_IND) debido a que aquí esta la identificación numérica como esta en el pedigrí.

Pob_IND_4 <- Pob_IND %>%
  left_join(y = famsnps_IND, by = 'Variety') %>% # Se unen al conjunto de datos famsnps_IND debido a que aquí esta la identificación numérica como esta en el pedigrí.
  bind_rows(Pob_IND_3) %>% # Se une por filas al conjunto de datos de individuos no mejorados anterior Pob_IND_3.
  select(-Variety) %>%
  relocate(
    Fen_escalado,
    .after = id
    )

# 6. Se crea un conjunto de datos donde estaran los fenotipos de los individuos con pedigrí simulado mediante el software molcoanc, y se une posteriormente con el conjunto de datos anterior.

Pob_IND_5 <- tibble(
  id = seq(from = 1, to = 2000, by = 1),
  Fen_escalado = rep(x = NA, times = 2000)
  ) %>%
  bind_rows(Pob_IND_4) %>%
  arrange(id)

##########################################
# Uso del paquete lme4GS para el pedigrí 1
##########################################

dir.create('../Datos/Datos_IND/Den_10.000/mod_lme4GS/Ped_1') # Se crea una carpeta donde se guardaran los resultados del pedigríe 1.

## 1. Subpoblación con 148 individuos genotipados

# a) Se preparan los datos de entrada ----

mH_IND_1 <- readRDS(here('Datos', 'Datos_IND', 'Den_10.000', 'mH', 'Ped_1', 'mH_1', 'mH_1.RDS')) %>% # Se carga la matriz H de los 148 individuos genotipados de la población IND.
  as.matrix()

Fen_IND <- Pob_IND_5 # Se carga el conjunto de datos donde estan los fenotipos y la identificación de los individuos.

Fen_IND$id <- rownames(mH_IND_1)

# b) Se ajusta el modelo ----

dir.create('../Datos/Datos_IND/Den_10.000/mod_lme4GS/Ped_1/mod_lme4GS_1/') # Se crea una carpeta para guardar los resultados del modelo anteriormente ajustado para 148 indiviuos genotipados.

mod_IND_1 <- lmerUvcov(formula = Fen_escalado ~ (1 | id), data = Fen_IND, Uvcov = list(id = list(K = mH_IND_1)))

save(mod_IND_1, file = '../Datos/Datos_IND/Den_10.000/mod_lme4GS/Ped_1/mod_lme4GS_1/mod_lme4GS_1.RData')

## 2. Subpoblación con 298 individuos genotipados

# a) Se preparan los datos de entrada ----

mH_IND_2 <- readRDS(here('Datos', 'Datos_IND', 'Den_10.000', 'mH', 'Ped_1', 'mH_2', 'mH_2.RDS')) %>% # Se carga la matriz H de los 298 individuos genotipados de la población IND.
  as.matrix()

Fen_IND <- Pob_IND_5 # Se carga el conjunto de datos donde estan los fenotipos y la identificación de los individuos.

Fen_IND$id <- rownames(mH_IND_2)

# b) Se ajusta el modelo ----

dir.create('../Datos/Datos_IND/Den_10.000/mod_lme4GS/Ped_1/mod_lme4GS_2/') # Se crea una carpeta para guardar los resultados del modelo anteriormente ajustado para 298 indiviuos genotipados.

mod_IND_2 <- lmerUvcov(formula = Fen_escalado ~ (1 | id), data = Fen_IND, Uvcov = list(id = list(K = mH_IND_2)))

save(mod_IND_2, file = '../Datos/Datos_IND/Den_10.000/mod_lme4GS/Ped_1/mod_lme4GS_2/mod_lme4GS_2.RData')

## 3. Subpoblación con 451 individuos genotipados

# a) Se preparan los datos de entrada ----

mH_IND_3 <- readRDS(here('Datos', 'Datos_IND', 'Den_10.000', 'mH', 'Ped_1', 'mH_3', 'mH_3.RDS')) %>% # Se carga la matriz H de los 451 individuos genotipados de la población IND.
  as.matrix()

Fen_IND <- Pob_IND_5 # Se carga el conjunto de datos donde estan los fenotipos y la identificación de los individuos.

Fen_IND$id <- rownames(mH_IND_3)

# b) Se ajusta el modelo ----

dir.create('../Datos/Datos_IND/Den_10.000/mod_lme4GS/Ped_1/mod_lme4GS_3/') # Se crea una carpeta para guardar los resultados del modelo anteriormente ajustado para 298 indiviuos genotipados.

mod_IND_3 <- lmerUvcov(formula = Fen_escalado ~ (1 | id), data = Fen_IND, Uvcov = list(id = list(K = mH_IND_3)))

save(mod_IND_3, file = '../Datos/Datos_IND/Den_10.000/mod_lme4GS/Ped_1/mod_lme4GS_3/mod_lme4GS_3.RData')

## 4. Subpoblación con ningún individuo genotipado

# a) Se preparan los datos de entrada ----

mA_IND <- readRDS(here('Datos', 'Datos_IND', 'Den_100.000_b', 'mH', 'Ped_1', 'mA', 'mA.RDS')) %>% # Se carga la matriz A de los individuos de la población IND.
  as.matrix()

Fen_IND <- Pob_IND_5 # Se carga el conjunto de datos donde estan los fenotipos y la identificación de los individuos.

Fen_IND$id <- rownames(mA_IND)

# b) Se ajusta el modelo ----

dir.create('../Datos/Datos_IND/Den_10.000/mod_lme4GS/Ped_1/mod_lme4GS_4/') # Se crea una carpeta para guardar los resultados del modelo anteriormente ajustado para 298 indiviuos genotipados.

mod_IND_4 <- lmerUvcov(formula = Fen_escalado ~ (1 | id), data = Fen_IND, Uvcov = list(id = list(K = mA_IND)))

save(mod_IND_4, file = '../Datos/Datos_IND/Den_10.000/mod_lme4GS/Ped_1/mod_lme4GS_4/mod_lme4GS_4.RData')

########################################################
# Pedigrí 3: 1210 individuos simulados en 7 generaciones
########################################################

# 4. Se importa el archivo .fam obtenido usando plink y que posteriomente se uso para crear la hoja de parámetros para ejecutar el software molcoanc.

famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'nSNPs_IND.fam')) %>% 
  select(fam) %>%
  mutate(id = 1211:1661) %>%
  rename(Variety = fam)

# 5. Se unen en un solo conjuntos de datos los individuos mejorados y no mejorados.

Pob_IND_3 <- Pob_IND_2 %>%
  left_join(y = famsnps_IND, by = 'Variety') # Se unen al conjunto de datos anterior (famsnps_IND) debido a que aquí esta la identificación numérica como esta en el pedigrí.

Pob_IND_4 <- Pob_IND %>%
  left_join(y = famsnps_IND, by = 'Variety') %>% # Se unen al conjunto de datos famsnps_IND debido a que aquí esta la identificación numérica como esta en el pedigrí.
  bind_rows(Pob_IND_3) %>% # Se une por filas al conjunto de datos de individuos no mejorados anterior Pob_IND_3.
  select(-Variety) %>%
  relocate(
    Fen_escalado,
    .after = id
    )

# 6. Se crea un conjunto de datos donde estaran los fenotipos de los individuos con pedigrí simulado mediante el software molcoanc, y se une posteriormente con el conjunto de datos anterior.

Pob_IND_5 <- tibble(
  id = seq(from = 1, to = 1210, by = 1),
  Fen_escalado = rep(x = NA, times = 1210)
  ) %>%
  bind_rows(Pob_IND_4) %>%
  arrange(id)

##########################################
# Uso del paquete lme4GS para el pedigrí 3
##########################################

dir.create('../Datos/Datos_IND/Den_10.000/mod_lme4GS/Ped_3') # Se crea una carpeta donde se guardaran los resultados del pedigríe 3.

## 1. Subpoblación con 148 individuos genotipados

# a) Se preparan los datos de entrada ----

mH_IND_1 <- readRDS(here('Datos', 'Datos_IND', 'Den_10.000', 'mH', 'Ped_3', 'mH_1', 'mH_1.RDS')) %>% # Se carga la matriz H de los 148 individuos genotipados de la población IND.
  as.matrix()

Fen_IND <- Pob_IND_5 # Se carga el conjunto de datos donde estan los fenotipos y la identificación de los individuos.

Fen_IND$id <- rownames(mH_IND_1)

# b) Se ajusta el modelo ----

dir.create('../Datos/Datos_IND/Den_10.000/mod_lme4GS/Ped_3/mod_lme4GS_1/') # Se crea una carpeta para guardar los resultados del modelo anteriormente ajustado para 148 indiviuos genotipados.

mod_IND_1 <- lmerUvcov(formula = Fen_escalado ~ (1 | id), data = Fen_IND, Uvcov = list(id = list(K = mH_IND_1))) # Con la función lmerUvcov, se ajusta el modelo lineal mixto con una matriz de varianza-covarianza proporcionada (aquí la matriz H). Esta función toma como entrada una fórmula para especificar la respuesta (Fen_escalado), los efectos fijos (aquí no los hay) y los efectos aleatorios (los individuos), un data.frame y una lista (Uvcov) para especificar la matriz de varianza-covarianza para los efectos aleatorios.

save(mod_IND_1, file = '../Datos/Datos_IND/Den_10.000/mod_lme4GS/Ped_3/mod_lme4GS_1/mod_lme4GS_1.RData')

## 2. Subpoblación con 298 individuos genotipados

# a) Se preparan los datos de entrada ----

mH_IND_2 <- readRDS(here('Datos', 'Datos_IND', 'Den_10.000', 'mH', 'Ped_3', 'mH_2', 'mH_2.RDS')) %>% # Se carga la matriz H de los 298 individuos genotipados de la población IND.
  as.matrix()

Fen_IND <- Pob_IND_5 # Se carga el conjunto de datos donde estan los fenotipos y la identificación de los individuos.

Fen_IND$id <- rownames(mH_IND_2)

# b) Se ajusta el modelo ----

dir.create('../Datos/Datos_IND/Den_10.000/mod_lme4GS/Ped_3/mod_lme4GS_2/') # Se crea una carpeta para guardar los resultados del modelo anteriormente ajustado para 298 indiviuos genotipados.

mod_IND_2 <- lmerUvcov(formula = Fen_escalado ~ (1 | id), data = Fen_IND, Uvcov = list(id = list(K = mH_IND_2)))

save(mod_IND_2, file = '../Datos/Datos_IND/Den_10.000/mod_lme4GS/Ped_3/mod_lme4GS_2/mod_lme4GS_2.RData')

## 3. Subpoblación con 451 individuos genotipados

# a) Se preparan los datos de entrada ----

mH_IND_3 <- readRDS(here('Datos', 'Datos_IND', 'Den_10.000', 'mH', 'Ped_3', 'mH_3', 'mH_3.RDS')) %>% # Se carga la matriz H de los 451 individuos genotipados de la población IND.
  as.matrix()

Fen_IND <- Pob_IND_5 # Se carga el conjunto de datos donde estan los fenotipos y la identificación de los individuos.

Fen_IND$id <- rownames(mH_IND_3)

# b) Se ajusta el modelo ----

dir.create('../Datos/Datos_IND/Den_10.000/mod_lme4GS/Ped_3/mod_lme4GS_3/') # Se crea una carpeta para guardar los resultados del modelo anteriormente ajustado para 298 indiviuos genotipados.

mod_IND_3 <- lmerUvcov(formula = Fen_escalado ~ (1 | id), data = Fen_IND, Uvcov = list(id = list(K = mH_IND_3)))

save(mod_IND_3, file = '../Datos/Datos_IND/Den_10.000/mod_lme4GS/Ped_3/mod_lme4GS_3/mod_lme4GS_3.RData')

## 4. Subpoblación con ningún individuo genotipado

# a) Se preparan los datos de entrada ----

mA_IND <- readRDS(here('Datos', 'Datos_IND', 'Den_100.000_b', 'mH', 'Ped_3', 'mA', 'mA.RDS')) %>% # Se carga la matriz A de los individuos de la población IND.
  as.matrix()

Fen_IND <- Pob_IND_5 # Se carga el conjunto de datos donde estan los fenotipos y la identificación de los individuos.

Fen_IND$id <- rownames(mA_IND)

# b) Se ajusta el modelo ----

dir.create('../Datos/Datos_IND/Den_10.000/mod_lme4GS/Ped_3/mod_lme4GS_4/') # Se crea una carpeta para guardar los resultados del modelo anteriormente ajustado para 298 indiviuos genotipados.

mod_IND_4 <- lmerUvcov(formula = Fen_escalado ~ (1 | id), data = Fen_IND, Uvcov = list(id = list(K = mA_IND)))

save(mod_IND_4, file = '../Datos/Datos_IND/Den_10.000/mod_lme4GS/Ped_3/mod_lme4GS_4/mod_lme4GS_4.RData')

#######################################################
# Pedigrí 4: 300 individuos simulados en 3 generaciones
#######################################################

# 4. Se importa el archivo .fam obtenido usando plink y que posteriomente se uso para crear la hoja de parámetros para ejecutar el software molcoanc.

famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'nSNPs_IND.fam')) %>% 
  select(fam) %>%
  mutate(id = 301:751) %>%
  rename(Variety = fam)

# 5. Se unen en un solo conjuntos de datos los individuos mejorados y no mejorados.

Pob_IND_3 <- Pob_IND_2 %>%
  left_join(y = famsnps_IND, by = 'Variety') # Se unen al conjunto de datos anterior (famsnps_IND) debido a que aquí esta la identificación numérica como esta en el pedigrí.

Pob_IND_4 <- Pob_IND %>%
  left_join(y = famsnps_IND, by = 'Variety') %>% # Se unen al conjunto de datos famsnps_IND debido a que aquí esta la identificación numérica como esta en el pedigrí.
  bind_rows(Pob_IND_3) %>% # Se une por filas al conjunto de datos de individuos no mejorados anterior Pob_IND_3.
  select(-Variety) %>%
  relocate(
    Fen_escalado,
    .after = id
    )

# 6. Se crea un conjunto de datos donde estaran los fenotipos de los individuos con pedigrí simulado mediante el software molcoanc, y se une posteriormente con el conjunto de datos anterior.

Pob_IND_5 <- tibble(
  id = seq(from = 1, to = 300, by = 1),
  Fen_escalado = rep(x = NA, times = 300)
  ) %>%
  bind_rows(Pob_IND_4) %>%
  arrange(id)

##########################################
# Uso del paquete lme4GS para el pedigrí 4
##########################################

dir.create('../Datos/Datos_IND/Den_10.000/mod_lme4GS/Ped_4') # Se crea una carpeta donde se guardaran los resultados del pedigríe 4.

## 1. Subpoblación con 148 individuos genotipados

# a) Se preparan los datos de entrada ----

mH_IND_1 <- readRDS(here('Datos', 'Datos_IND', 'Den_10.000', 'mH', 'Ped_4', 'mH_1', 'mH_1.RDS')) %>% # Se carga la matriz H de los 148 individuos genotipados de la población IND.
  as.matrix()

Fen_IND <- Pob_IND_5 # Se carga el conjunto de datos donde estan los fenotipos y la identificación de los individuos.

Fen_IND$id <- rownames(mH_IND_1)

# b) Se ajusta el modelo ----

dir.create('../Datos/Datos_IND/Den_10.000/mod_lme4GS/Ped_4/mod_lme4GS_1/') # Se crea una carpeta para guardar los resultados del modelo anteriormente ajustado para 148 indiviuos genotipados.

mod_IND_1 <- lmerUvcov(formula = Fen_escalado ~ (1 | id), data = Fen_IND, Uvcov = list(id = list(K = mH_IND_1)))

save(mod_IND_1, file = '../Datos/Datos_IND/Den_10.000/mod_lme4GS/Ped_4/mod_lme4GS_1/mod_lme4GS_1.RData')

## 2. Subpoblación con 298 individuos genotipados

# a) Se preparan los datos de entrada ----

mH_IND_2 <- readRDS(here('Datos', 'Datos_IND', 'Den_10.000', 'mH', 'Ped_4', 'mH_2', 'mH_2.RDS')) %>% # Se carga la matriz H de los 298 individuos genotipados de la población IND.
  as.matrix()

Fen_IND <- Pob_IND_5 # Se carga el conjunto de datos donde estan los fenotipos y la identificación de los individuos.

Fen_IND$id <- rownames(mH_IND_2)

# b) Se ajusta el modelo ----

dir.create('../Datos/Datos_IND/Den_10.000/mod_lme4GS/Ped_4/mod_lme4GS_2/') # Se crea una carpeta para guardar los resultados del modelo anteriormente ajustado para 298 indiviuos genotipados.

mod_IND_2 <- lmerUvcov(formula = Fen_escalado ~ (1 | id), data = Fen_IND, Uvcov = list(id = list(K = mH_IND_2)))

save(mod_IND_2, file = '../Datos/Datos_IND/Den_10.000/mod_lme4GS/Ped_4/mod_lme4GS_2/mod_lme4GS_2.RData')

## 3. Subpoblación con 451 individuos genotipados

# a) Se preparan los datos de entrada ----

mH_IND_3 <- readRDS(here('Datos', 'Datos_IND', 'Den_10.000', 'mH', 'Ped_4', 'mH_3', 'mH_3.RDS')) %>% # Se carga la matriz H de los 451 individuos genotipados de la población IND.
  as.matrix()

Fen_IND <- Pob_IND_5 # Se carga el conjunto de datos donde estan los fenotipos y la identificación de los individuos.

Fen_IND$id <- rownames(mH_IND_3)

# b) Se ajusta el modelo ----

dir.create('../Datos/Datos_IND/Den_10.000/mod_lme4GS/Ped_4/mod_lme4GS_3/') # Se crea una carpeta para guardar los resultados del modelo anteriormente ajustado para 298 indiviuos genotipados.

mod_IND_3 <- lmerUvcov(formula = Fen_escalado ~ (1 | id), data = Fen_IND, Uvcov = list(id = list(K = mH_IND_3)))

save(mod_IND_3, file = '../Datos/Datos_IND/Den_10.000/mod_lme4GS/Ped_4/mod_lme4GS_3/mod_lme4GS_3.RData')

## 4. Subpoblación con ningún individuo genotipado

# a) Se preparan los datos de entrada ----

mA_IND <- readRDS(here('Datos', 'Datos_IND', 'Den_100.000_b', 'mH', 'Ped_4', 'mA', 'mA.RDS')) %>% # Se carga la matriz A de los individuos de la población IND.
  as.matrix()

Fen_IND <- Pob_IND_5 # Se carga el conjunto de datos donde estan los fenotipos y la identificación de los individuos.

Fen_IND$id <- rownames(mA_IND)

# b) Se ajusta el modelo ----

dir.create('../Datos/Datos_IND/Den_10.000/mod_lme4GS/Ped_4/mod_lme4GS_4/') # Se crea una carpeta para guardar los resultados del modelo anteriormente ajustado para 298 indiviuos genotipados.

mod_IND_4 <- lmerUvcov(formula = Fen_escalado ~ (1 | id), data = Fen_IND, Uvcov = list(id = list(K = mA_IND)))

save(mod_IND_4, file = '../Datos/Datos_IND/Den_10.000/mod_lme4GS/Ped_4/mod_lme4GS_4/mod_lme4GS_4.RData')

#### Población de arroz IND (1.000 SNPs) ----

dir.create('../Datos/Datos_IND/Den_1.000/mod_lme4GS') # Se crea una carpeta donde se guardaran los resultados de los modelos que se ajustaran para las distintas subpoblaciones de individuos genotipados con distintos pedigríes, con una desnidad de SNPs de 1.000.

# 1. Se importan las bases de datos de fenotipos y de linea mejorada.

lin_mej <- read_delim(here('Datos', 'iris_pedigree.csv'), delim = ',')
Fenotipos <- read_delim(here('Datos', 'all.phenotypes.csv'), delim = ',')

#### Población de arroz IND ----

# 2. Se crea un conjunto de datos que contiene solo los individuos mejorados.

Pob_mej <- lin_mej %>%
  filter(Status_with_Pedigree.plus.knowledge == 'I') %>% # Conjunto de datos solo con los individuos mejorados (los que se clasificaron como "I").
  select(X3K_DNA_IRIS_UNIQUE_ID) %>%
  rename(Variety = X3K_DNA_IRIS_UNIQUE_ID)

escalado <- function(x) { # Función usada para escalar el fenotipo.
  (x - mean(x, na.rm = TRUE)) / sd(x, na.rm = TRUE)
  }

Pob_IND <- Fenotipos %>%
  filter(SNPsubsp == 'IND') %>% # Conjunto de datos solo con la especie IND.
  mutate(
    Variety_2 = Variety,
    Fen_escalado = escalado(Time.to.flowering..from.sowing)
    ) %>%
  separate(
    col = Variety,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  ' '
  ) %>%
  unite(
    col = Variety,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  separate(
    col = Variety,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  '-'
  ) %>%
  unite(
    col = Variety,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  separate(
    col = Variety_2,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  ' '
  ) %>%
  unite(
    col = Variety_2,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  inner_join(y = Pob_mej, by = 'Variety') %>%
  select(Variety_2, Fen_escalado) %>% # Se creo el conjunto de datos con los individuos mejorados de la población indica.
  mutate(Fen_escalado = NA) %>% # Los fenotipos de estos individuos se deben colocar como NAs al formar parte de la población de validación cruzada, y al ser los individuos que se quieren predecir.
  rename(Variety = Variety_2)

# 3. Se crea un conjunto de datos que no contiene los individuos mejorados.

Pob_IND_2 <- Fenotipos %>%
  filter(SNPsubsp == 'IND') %>% # Conjunto de datos solo con la especie IND.
  mutate(
    Variety_2 = Variety,
    Fen_escalado = escalado(Time.to.flowering..from.sowing)
    ) %>%
  separate(
    col = Variety,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  ' '
  ) %>%
  unite(
    col = Variety,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  separate(
    col = Variety,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  '-'
  ) %>%
  unite(
    col = Variety,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  separate(
    col = Variety_2,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  ' '
  ) %>%
  unite(
    col = Variety_2,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  anti_join(Pob_mej, by = 'Variety') %>%
  select(Variety_2, Fen_escalado) %>% # Se creo el conjunto de datos con los individuos no mejorados de la población indica.
  rename(Variety = Variety_2)

#########################################################
# Pedigrí 1: 2000 individuos simulados en 10 generaciones
#########################################################

# 4. Se importa el archivo .fam obtenido usando plink y que posteriomente se uso para crear la hoja de parámetros para ejecutar el software molcoanc.

famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'nSNPs_IND.fam')) %>% 
  select(fam) %>%
  mutate(id = 2001:2451) %>%
  rename(Variety = fam)

# 5. Se unen en un solo conjuntos de datos los individuos mejorados y no mejorados.

Pob_IND_3 <- Pob_IND_2 %>%
  left_join(y = famsnps_IND, by = 'Variety') # Se unen al conjunto de datos anterior (famsnps_IND) debido a que aquí esta la identificación numérica como esta en el pedigrí.

Pob_IND_4 <- Pob_IND %>%
  left_join(y = famsnps_IND, by = 'Variety') %>% # Se unen al conjunto de datos famsnps_IND debido a que aquí esta la identificación numérica como esta en el pedigrí.
  bind_rows(Pob_IND_3) %>% # Se une por filas al conjunto de datos de individuos no mejorados anterior Pob_IND_3.
  select(-Variety) %>%
  relocate(
    Fen_escalado,
    .after = id
    )

# 6. Se crea un conjunto de datos donde estaran los fenotipos de los individuos con pedigrí simulado mediante el software molcoanc, y se une posteriormente con el conjunto de datos anterior.

Pob_IND_5 <- tibble(
  id = seq(from = 1, to = 2000, by = 1),
  Fen_escalado = rep(x = NA, times = 2000)
  ) %>%
  bind_rows(Pob_IND_4) %>%
  arrange(id)

##########################################
# Uso del paquete lme4GS para el pedigrí 1
##########################################

dir.create('../Datos/Datos_IND/Den_1.000/mod_lme4GS/Ped_1') # Se crea una carpeta donde se guardaran los resultados del pedigríe 1.

## 1. Subpoblación con 148 individuos genotipados

# a) Se preparan los datos de entrada ----

mH_IND_1 <- readRDS(here('Datos', 'Datos_IND', 'Den_1.000', 'mH', 'Ped_1', 'mH_1', 'mH_1.RDS')) %>% # Se carga la matriz H de los 148 individuos genotipados de la población IND.
  as.matrix()

Fen_IND <- Pob_IND_5 # Se carga el conjunto de datos donde estan los fenotipos y la identificación de los individuos.

Fen_IND$id <- rownames(mH_IND_1)

# b) Se ajusta el modelo ----

dir.create('../Datos/Datos_IND/Den_1.000/mod_lme4GS/Ped_1/mod_lme4GS_1/') # Se crea una carpeta para guardar los resultados del modelo anteriormente ajustado para 148 indiviuos genotipados.

mod_IND_1 <- lmerUvcov(formula = Fen_escalado ~ (1 | id), data = Fen_IND, Uvcov = list(id = list(K = mH_IND_1)))

save(mod_IND_1, file = '../Datos/Datos_IND/Den_1.000/mod_lme4GS/Ped_1/mod_lme4GS_1/mod_lme4GS_1.RData')

## 2. Subpoblación con 298 individuos genotipados

# a) Se preparan los datos de entrada ----

mH_IND_2 <- readRDS(here('Datos', 'Datos_IND', 'Den_1.000', 'mH', 'Ped_1', 'mH_2', 'mH_2.RDS')) %>% # Se carga la matriz H de los 298 individuos genotipados de la población IND.
  as.matrix()

Fen_IND <- Pob_IND_5 # Se carga el conjunto de datos donde estan los fenotipos y la identificación de los individuos.

Fen_IND$id <- rownames(mH_IND_2)

# b) Se ajusta el modelo ----

dir.create('../Datos/Datos_IND/Den_1.000/mod_lme4GS/Ped_1/mod_lme4GS_2/') # Se crea una carpeta para guardar los resultados del modelo anteriormente ajustado para 298 indiviuos genotipados.

mod_IND_2 <- lmerUvcov(formula = Fen_escalado ~ (1 | id), data = Fen_IND, Uvcov = list(id = list(K = mH_IND_2)))

save(mod_IND_2, file = '../Datos/Datos_IND/Den_1.000/mod_lme4GS/Ped_1/mod_lme4GS_2/mod_lme4GS_2.RData')

## 3. Subpoblación con 451 individuos genotipados

# a) Se preparan los datos de entrada ----

mH_IND_3 <- readRDS(here('Datos', 'Datos_IND', 'Den_1.000', 'mH', 'Ped_1', 'mH_3', 'mH_3.RDS')) %>% # Se carga la matriz H de los 451 individuos genotipados de la población IND.
  as.matrix()

Fen_IND <- Pob_IND_5 # Se carga el conjunto de datos donde estan los fenotipos y la identificación de los individuos.

Fen_IND$id <- rownames(mH_IND_3)

# b) Se ajusta el modelo ----

dir.create('../Datos/Datos_IND/Den_1.000/mod_lme4GS/Ped_1/mod_lme4GS_3/') # Se crea una carpeta para guardar los resultados del modelo anteriormente ajustado para 298 indiviuos genotipados.

mod_IND_3 <- lmerUvcov(formula = Fen_escalado ~ (1 | id), data = Fen_IND, Uvcov = list(id = list(K = mH_IND_3)))

save(mod_IND_3, file = '../Datos/Datos_IND/Den_1.000/mod_lme4GS/Ped_1/mod_lme4GS_3/mod_lme4GS_3.RData')

## 4. Subpoblación con ningún individuo genotipado

# a) Se preparan los datos de entrada ----

mA_IND <- readRDS(here('Datos', 'Datos_IND', 'Den_100.000_b', 'mH', 'Ped_1', 'mA', 'mA.RDS')) %>% # Se carga la matriz A de los individuos de la población IND.
  as.matrix()

Fen_IND <- Pob_IND_5 # Se carga el conjunto de datos donde estan los fenotipos y la identificación de los individuos.

Fen_IND$id <- rownames(mA_IND)

# b) Se ajusta el modelo ----

dir.create('../Datos/Datos_IND/Den_1.000/mod_lme4GS/Ped_1/mod_lme4GS_4/') # Se crea una carpeta para guardar los resultados del modelo anteriormente ajustado para 298 indiviuos genotipados.

mod_IND_4 <- lmerUvcov(formula = Fen_escalado ~ (1 | id), data = Fen_IND, Uvcov = list(id = list(K = mA_IND)))

save(mod_IND_4, file = '../Datos/Datos_IND/Den_1.000/mod_lme4GS/Ped_1/mod_lme4GS_4/mod_lme4GS_4.RData')

########################################################
# Pedigrí 3: 1210 individuos simulados en 7 generaciones
########################################################

# 4. Se importa el archivo .fam obtenido usando plink y que posteriomente se uso para crear la hoja de parámetros para ejecutar el software molcoanc.

famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'nSNPs_IND.fam')) %>% 
  select(fam) %>%
  mutate(id = 1211:1661) %>%
  rename(Variety = fam)

# 5. Se unen en un solo conjuntos de datos los individuos mejorados y no mejorados.

Pob_IND_3 <- Pob_IND_2 %>%
  left_join(y = famsnps_IND, by = 'Variety') # Se unen al conjunto de datos anterior (famsnps_IND) debido a que aquí esta la identificación numérica como esta en el pedigrí.

Pob_IND_4 <- Pob_IND %>%
  left_join(y = famsnps_IND, by = 'Variety') %>% # Se unen al conjunto de datos famsnps_IND debido a que aquí esta la identificación numérica como esta en el pedigrí.
  bind_rows(Pob_IND_3) %>% # Se une por filas al conjunto de datos de individuos no mejorados anterior Pob_IND_3.
  select(-Variety) %>%
  relocate(
    Fen_escalado,
    .after = id
    )

# 6. Se crea un conjunto de datos donde estaran los fenotipos de los individuos con pedigrí simulado mediante el software molcoanc, y se une posteriormente con el conjunto de datos anterior.

Pob_IND_5 <- tibble(
  id = seq(from = 1, to = 1210, by = 1),
  Fen_escalado = rep(x = NA, times = 1210)
  ) %>%
  bind_rows(Pob_IND_4) %>%
  arrange(id)

##########################################
# Uso del paquete lme4GS para el pedigrí 3
##########################################

dir.create('../Datos/Datos_IND/Den_1.000/mod_lme4GS/Ped_3') # Se crea una carpeta donde se guardaran los resultados del pedigríe 3.

## 1. Subpoblación con 148 individuos genotipados

# a) Se preparan los datos de entrada ----

mH_IND_1 <- readRDS(here('Datos', 'Datos_IND', 'Den_1.000', 'mH', 'Ped_3', 'mH_1', 'mH_1.RDS')) %>% # Se carga la matriz H de los 148 individuos genotipados de la población IND.
  as.matrix()

Fen_IND <- Pob_IND_5 # Se carga el conjunto de datos donde estan los fenotipos y la identificación de los individuos.

Fen_IND$id <- rownames(mH_IND_1)

# b) Se ajusta el modelo ----

dir.create('../Datos/Datos_IND/Den_1.000/mod_lme4GS/Ped_3/mod_lme4GS_1/') # Se crea una carpeta para guardar los resultados del modelo anteriormente ajustado para 148 indiviuos genotipados.

mod_IND_1 <- lmerUvcov(formula = Fen_escalado ~ (1 | id), data = Fen_IND, Uvcov = list(id = list(K = mH_IND_1)))

save(mod_IND_1, file = '../Datos/Datos_IND/Den_1.000/mod_lme4GS/Ped_3/mod_lme4GS_1/mod_lme4GS_1.RData')

## 2. Subpoblación con 298 individuos genotipados

# a) Se preparan los datos de entrada ----

mH_IND_2 <- readRDS(here('Datos', 'Datos_IND', 'Den_1.000', 'mH', 'Ped_3', 'mH_2', 'mH_2.RDS')) %>% # Se carga la matriz H de los 298 individuos genotipados de la población IND.
  as.matrix()

Fen_IND <- Pob_IND_5 # Se carga el conjunto de datos donde estan los fenotipos y la identificación de los individuos.

Fen_IND$id <- rownames(mH_IND_2)

# b) Se ajusta el modelo ----

dir.create('../Datos/Datos_IND/Den_1.000/mod_lme4GS/Ped_3/mod_lme4GS_2/') # Se crea una carpeta para guardar los resultados del modelo anteriormente ajustado para 298 indiviuos genotipados.

mod_IND_2 <- lmerUvcov(formula = Fen_escalado ~ (1 | id), data = Fen_IND, Uvcov = list(id = list(K = mH_IND_2)))

save(mod_IND_2, file = '../Datos/Datos_IND/Den_1.000/mod_lme4GS/Ped_3/mod_lme4GS_2/mod_lme4GS_2.RData')

## 3. Subpoblación con 451 individuos genotipados

# a) Se preparan los datos de entrada ----

mH_IND_3 <- readRDS(here('Datos', 'Datos_IND', 'Den_1.000', 'mH', 'Ped_3', 'mH_3', 'mH_3.RDS')) %>% # Se carga la matriz H de los 451 individuos genotipados de la población IND.
  as.matrix()

Fen_IND <- Pob_IND_5 # Se carga el conjunto de datos donde estan los fenotipos y la identificación de los individuos.

Fen_IND$id <- rownames(mH_IND_3)

# b) Se ajusta el modelo ----

dir.create('../Datos/Datos_IND/Den_1.000/mod_lme4GS/Ped_3/mod_lme4GS_3/') # Se crea una carpeta para guardar los resultados del modelo anteriormente ajustado para 298 indiviuos genotipados.

mod_IND_3 <- lmerUvcov(formula = Fen_escalado ~ (1 | id), data = Fen_IND, Uvcov = list(id = list(K = mH_IND_3)))

save(mod_IND_3, file = '../Datos/Datos_IND/Den_1.000/mod_lme4GS/Ped_3/mod_lme4GS_3/mod_lme4GS_3.RData')

## 4. Subpoblación con ningún individuo genotipado

# a) Se preparan los datos de entrada ----

mA_IND <- readRDS(here('Datos', 'Datos_IND', 'Den_100.000_b', 'mH', 'Ped_3', 'mA', 'mA.RDS')) %>% # Se carga la matriz A de los individuos de la población IND.
  as.matrix()

Fen_IND <- Pob_IND_5 # Se carga el conjunto de datos donde estan los fenotipos y la identificación de los individuos.

Fen_IND$id <- rownames(mA_IND)

# b) Se ajusta el modelo ----

dir.create('../Datos/Datos_IND/Den_1.000/mod_lme4GS/Ped_3/mod_lme4GS_4/') # Se crea una carpeta para guardar los resultados del modelo anteriormente ajustado para 298 indiviuos genotipados.

mod_IND_4 <- lmerUvcov(formula = Fen_escalado ~ (1 | id), data = Fen_IND, Uvcov = list(id = list(K = mA_IND)))

save(mod_IND_4, file = '../Datos/Datos_IND/Den_1.000/mod_lme4GS/Ped_3/mod_lme4GS_4/mod_lme4GS_4.RData')

#######################################################
# Pedigrí 4: 300 individuos simulados en 3 generaciones
#######################################################

# 4. Se importa el archivo .fam obtenido usando plink y que posteriomente se uso para crear la hoja de parámetros para ejecutar el software molcoanc.

famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'nSNPs_IND.fam')) %>% 
  select(fam) %>%
  mutate(id = 301:751) %>%
  rename(Variety = fam)

# 5. Se unen en un solo conjuntos de datos los individuos mejorados y no mejorados.

Pob_IND_3 <- Pob_IND_2 %>%
  left_join(y = famsnps_IND, by = 'Variety') # Se unen al conjunto de datos anterior (famsnps_IND) debido a que aquí esta la identificación numérica como esta en el pedigrí.

Pob_IND_4 <- Pob_IND %>%
  left_join(y = famsnps_IND, by = 'Variety') %>% # Se unen al conjunto de datos famsnps_IND debido a que aquí esta la identificación numérica como esta en el pedigrí.
  bind_rows(Pob_IND_3) %>% # Se une por filas al conjunto de datos de individuos no mejorados anterior Pob_IND_3.
  select(-Variety) %>%
  relocate(
    Fen_escalado,
    .after = id
    )

# 6. Se crea un conjunto de datos donde estaran los fenotipos de los individuos con pedigrí simulado mediante el software molcoanc, y se une posteriormente con el conjunto de datos anterior.

Pob_IND_5 <- tibble(
  id = seq(from = 1, to = 300, by = 1),
  Fen_escalado = rep(x = NA, times = 300)
  ) %>%
  bind_rows(Pob_IND_4) %>%
  arrange(id)

##########################################
# Uso del paquete lme4GS para el pedigrí 4
##########################################

dir.create('../Datos/Datos_IND/Den_1.000/mod_lme4GS/Ped_4') # Se crea una carpeta donde se guardaran los resultados del pedigríe 4.

## 1. Subpoblación con 148 individuos genotipados

# a) Se preparan los datos de entrada ----

mH_IND_1 <- readRDS(here('Datos', 'Datos_IND', 'Den_1.000', 'mH', 'Ped_4', 'mH_1', 'mH_1.RDS')) %>% # Se carga la matriz H de los 148 individuos genotipados de la población IND.
  as.matrix()

Fen_IND <- Pob_IND_5 # Se carga el conjunto de datos donde estan los fenotipos y la identificación de los individuos.

Fen_IND$id <- rownames(mH_IND_1)

# b) Se ajusta el modelo ----

dir.create('../Datos/Datos_IND/Den_1.000/mod_lme4GS/Ped_4/mod_lme4GS_1/') # Se crea una carpeta para guardar los resultados del modelo anteriormente ajustado para 148 indiviuos genotipados.

mod_IND_1 <- lmerUvcov(formula = Fen_escalado ~ (1 | id), data = Fen_IND, Uvcov = list(id = list(K = mH_IND_1)))

save(mod_IND_1, file = '../Datos/Datos_IND/Den_1.000/mod_lme4GS/Ped_4/mod_lme4GS_1/mod_lme4GS_1.RData')

## 2. Subpoblación con 298 individuos genotipados

# a) Se preparan los datos de entrada ----

mH_IND_2 <- readRDS(here('Datos', 'Datos_IND', 'Den_1.000', 'mH', 'Ped_4', 'mH_2', 'mH_2.RDS')) %>% # Se carga la matriz H de los 298 individuos genotipados de la población IND.
  as.matrix()

Fen_IND <- Pob_IND_5 # Se carga el conjunto de datos donde estan los fenotipos y la identificación de los individuos.

Fen_IND$id <- rownames(mH_IND_2)

# b) Se ajusta el modelo ----

dir.create('../Datos/Datos_IND/Den_1.000/mod_lme4GS/Ped_4/mod_lme4GS_2/') # Se crea una carpeta para guardar los resultados del modelo anteriormente ajustado para 298 indiviuos genotipados.

mod_IND_2 <- lmerUvcov(formula = Fen_escalado ~ (1 | id), data = Fen_IND, Uvcov = list(id = list(K = mH_IND_2)))

save(mod_IND_2, file = '../Datos/Datos_IND/Den_1.000/mod_lme4GS/Ped_4/mod_lme4GS_2/mod_lme4GS_2.RData')

## 3. Subpoblación con 451 individuos genotipados

# a) Se preparan los datos de entrada ----

mH_IND_3 <- readRDS(here('Datos', 'Datos_IND', 'Den_1.000', 'mH', 'Ped_4', 'mH_3', 'mH_3.RDS')) %>% # Se carga la matriz H de los 451 individuos genotipados de la población IND.
  as.matrix()

Fen_IND <- Pob_IND_5 # Se carga el conjunto de datos donde estan los fenotipos y la identificación de los individuos.

Fen_IND$id <- rownames(mH_IND_3)

# b) Se ajusta el modelo ----

dir.create('../Datos/Datos_IND/Den_1.000/mod_lme4GS/Ped_4/mod_lme4GS_3/') # Se crea una carpeta para guardar los resultados del modelo anteriormente ajustado para 298 indiviuos genotipados.

mod_IND_3 <- lmerUvcov(formula = Fen_escalado ~ (1 | id), data = Fen_IND, Uvcov = list(id = list(K = mH_IND_3)))

save(mod_IND_3, file = '../Datos/Datos_IND/Den_1.000/mod_lme4GS/Ped_4/mod_lme4GS_3/mod_lme4GS_3.RData')

## 4. Subpoblación con ningún individuo genotipado

# a) Se preparan los datos de entrada ----

mA_IND <- readRDS(here('Datos', 'Datos_IND', 'Den_100.000_b', 'mH', 'Ped_4', 'mA', 'mA.RDS')) %>% # Se carga la matriz A de los individuos de la población IND.
  as.matrix()

Fen_IND <- Pob_IND_5 # Se carga el conjunto de datos donde estan los fenotipos y la identificación de los individuos.

Fen_IND$id <- rownames(mA_IND)

# b) Se ajusta el modelo ----

dir.create('../Datos/Datos_IND/Den_1.000/mod_lme4GS/Ped_4/mod_lme4GS_4/') # Se crea una carpeta para guardar los resultados del modelo anteriormente ajustado para 298 indiviuos genotipados.

mod_IND_4 <- lmerUvcov(formula = Fen_escalado ~ (1 | id), data = Fen_IND, Uvcov = list(id = list(K = mA_IND)))

save(mod_IND_4, file = '../Datos/Datos_IND/Den_1.000/mod_lme4GS/Ped_4/mod_lme4GS_4/mod_lme4GS_4.RData')
```

# 23. A continuación se analizan los resultados obtenidos al correr los datos con el paquete de R lme4GS para distintos pedigríes y diferentes densidades de SNPs.

```{r Resultados con el paquete lme4GS para los distintos pedigríes y densidades de SNPs}

# 1. Se importan las bases de datos de feotipos y de linea mejorada.

lin_mej <- read_delim(here('Datos', 'iris_pedigree.csv'), delim = ',')
Fenotipos <- read_delim(here('Datos', 'all.phenotypes.csv'), delim = ',')

#### Población de arroz IND (100.000 SNPs) ----

#########################################################
# Pedigrí 1: 2000 individuos simulados en 10 generaciones
#########################################################

# 2. Se importa el archivo .fam obtenido usando plink y que posteriomente se uso para crear la hoja de parámetros para ejecutar el software molcoanc.

famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'nSNPs_IND.fam')) %>% 
  select(fam) %>%
  mutate(id = 2001:2451) %>%
  rename(Variety = fam)

# 3. Se crea un conjunto de datos que contiene solo los individuos mejorados.

Pob_mej <- lin_mej %>%
  filter(Status_with_Pedigree.plus.knowledge == 'I') %>% # Conjunto de datos solo con los individuos mejorados (los que se clasificaron como "I").
  select(X3K_DNA_IRIS_UNIQUE_ID) %>%
  rename(Variety = X3K_DNA_IRIS_UNIQUE_ID)

escalado <- function(x) { # Función usada para escalar el fenotipo.
  (x - mean(x, na.rm = TRUE)) / sd(x, na.rm = TRUE)
  }

Pob_IND <- Fenotipos %>%
  filter(SNPsubsp == 'IND') %>% # Conjunto de datos solo con la especie IND.
  mutate(
    Variety_2 = Variety,
    Fen_escalado = escalado(Time.to.flowering..from.sowing)
    ) %>%
  separate(
    col = Variety,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  ' '
  ) %>%
  unite(
    col = Variety,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  separate(
    col = Variety,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  '-'
  ) %>%
  unite(
    col = Variety,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  separate(
    col = Variety_2,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  ' '
  ) %>%
  unite(
    col = Variety_2,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  inner_join(y = Pob_mej, by = 'Variety') %>%
  select(Variety_2, Fen_escalado) %>% # Se creo el conjunto de datos con los individuos mejorados de la población indica.
  rename(Variety = Variety_2)

Pob_IND_2 <- Pob_IND %>%
  left_join(y = famsnps_IND, by = 'Variety') # Se unen al conjunto de datos famsnps_IND debido a que aquí esta la identificación numérica como esta en el pedigrí.

## 1. Subpoblación con 148 individuos genotipados

load(here('Datos', 'Datos_IND', 'Den_100.000_b', 'mod_lme4GS', 'Ped_1', 'mod_lme4GS_1', 'mod_lme4GS_1.RData'))

blup_IND_1 <- ranefUvcovNew(mod_IND_1, Uvcov = list(id = list(K = mH_IND_1)))
blup_IND_1 <- blup_IND_1$id[, 1] # Con la función ranefUvcovNew() obtengo el blup para los niveles de efectos aleatorios (aquí los individuos) con la matriz de varianza-covarianza especificada (la matriz H).

Pred_IND_1 <- fixef(mod_IND_1)[1] + blup_IND_1 # De esta forma obtengo los fenotipos predichos para los individuos con valores NA (aquí 2082 individuos).

Pob_IND_NA <- Pob_IND_5 %>% # Aquí, de la población total en Pob_IND_5 del pedigrí 1, me quedo solo con los 2082 individuos con valores NA. 
  filter(is.na(Fen_escalado))

Pred_IND_1 <- Pred_IND_1 %>% # Del vector anterior de fenotipos predichos, sol me quedo con los que pertenecen a las variedades mejoradas.
  as_tibble() %>%
  bind_cols(Pob_IND_NA) %>%
  filter(id %in% c(2001, 2005, 2013, 2014, 2016, 2017, 2018, 2019, 2020, 2021, 2022, 2023, 2030, 2062, 2076, 2101, 2116, 2127, 2128, 2129, 2130, 2133, 2134, 2135, 2137, 2170, 2179, 2180, 2202, 2210, 2249, 2263, 2264, 2281, 2308, 2327, 2328, 2365, 2368, 2369, 2370, 2372, 2374, 2375, 2376, 2424, 2437, 2446)) %>% # Estos serían los individuos que pertenecen a las variedades mejoradas.
  select(value, id) %>%
  inner_join(y = Pob_IND_2, by = 'id')  %>%
  mutate(Subpoblación = '148') %>%
  rename(
    'Fenotipo_predicho' = value,
    'Fenotipo_observado' = Fen_escalado
    )

## 2. Subpoblación con 298 individuos genotipados

load(here('Datos', 'Datos_IND', 'Den_100.000_b', 'mod_lme4GS', 'Ped_1', 'mod_lme4GS_2', 'mod_lme4GS_2.RData'))

blup_IND_2 <- ranefUvcovNew(mod_IND_2, Uvcov = list(id = list(K = mH_IND_2)))
blup_IND_2 <- blup_IND_2$id[, 1]

Pred_IND_2 <- fixef(mod_IND_2)[1] + blup_IND_2

Pob_IND_NA <- Pob_IND_5 %>% 
  filter(is.na(Fen_escalado))

Pred_IND_2 <- Pred_IND_2 %>%
  as_tibble() %>%
  bind_cols(Pob_IND_NA) %>%
  filter(id %in% c(2001, 2005, 2013, 2014, 2016, 2017, 2018, 2019, 2020, 2021, 2022, 2023, 2030, 2062, 2076, 2101, 2116, 2127, 2128, 2129, 2130, 2133, 2134, 2135, 2137, 2170, 2179, 2180, 2202, 2210, 2249, 2263, 2264, 2281, 2308, 2327, 2328, 2365, 2368, 2369, 2370, 2372, 2374, 2375, 2376, 2424, 2437, 2446)) %>% # Estos serían los individuos que pertenecen a las variedades mejoradas.
  select(value, id) %>%
  inner_join(y = Pob_IND_2, by = 'id')  %>%
  mutate(Subpoblación = '298') %>%
  rename(
    'Fenotipo_predicho' = value,
    'Fenotipo_observado' = Fen_escalado
    )

## 3. Subpoblación con 451 individuos genotipados

load(here('Datos', 'Datos_IND', 'Den_100.000_b', 'mod_lme4GS', 'Ped_1', 'mod_lme4GS_3', 'mod_lme4GS_3.RData'))

blup_IND_3 <- ranefUvcovNew(mod_IND_3, Uvcov = list(id = list(K = mH_IND_3)))
blup_IND_3 <- blup_IND_3$id[, 1]

Pred_IND_3 <- fixef(mod_IND_3)[1] + blup_IND_3

Pob_IND_NA <- Pob_IND_5 %>% 
  filter(is.na(Fen_escalado))

Pred_IND_3 <- Pred_IND_3 %>%
  as_tibble() %>%
  bind_cols(Pob_IND_NA) %>%
  filter(id %in% c(2001, 2005, 2013, 2014, 2016, 2017, 2018, 2019, 2020, 2021, 2022, 2023, 2030, 2062, 2076, 2101, 2116, 2127, 2128, 2129, 2130, 2133, 2134, 2135, 2137, 2170, 2179, 2180, 2202, 2210, 2249, 2263, 2264, 2281, 2308, 2327, 2328, 2365, 2368, 2369, 2370, 2372, 2374, 2375, 2376, 2424, 2437, 2446)) %>% # Estos serían los individuos que pertenecen a las variedades mejoradas.
  select(value, id) %>%
  inner_join(y = Pob_IND_2, by = 'id')  %>%
  mutate(Subpoblación = '451') %>%
  rename(
    'Fenotipo_predicho' = value,
    'Fenotipo_observado' = Fen_escalado
    )

## 4. Subpoblación con ningún individuo genotipado

load(here('Datos', 'Datos_IND', 'Den_100.000_b', 'mod_lme4GS', 'Ped_1', 'mod_lme4GS_4', 'mod_lme4GS_4.RData'))

blup_IND_4 <- ranefUvcovNew(mod_IND_4, Uvcov = list(id = list(K = mA_IND)))
blup_IND_4 <- blup_IND_4$id[, 1]

Pred_IND_4 <- fixef(mod_IND_4)[1] + blup_IND_4

Pob_IND_NA <- Pob_IND_5 %>% 
  filter(is.na(Fen_escalado))

Pred_IND_4 <- Pred_IND_4 %>%
  as_tibble() %>%
  bind_cols(Pob_IND_NA) %>%
  filter(id %in% c(2001, 2005, 2013, 2014, 2016, 2017, 2018, 2019, 2020, 2021, 2022, 2023, 2030, 2062, 2076, 2101, 2116, 2127, 2128, 2129, 2130, 2133, 2134, 2135, 2137, 2170, 2179, 2180, 2202, 2210, 2249, 2263, 2264, 2281, 2308, 2327, 2328, 2365, 2368, 2369, 2370, 2372, 2374, 2375, 2376, 2424, 2437, 2446)) %>% # Estos serían los individuos que pertenecen a las variedades mejoradas.
  select(value, id) %>%
  inner_join(y = Pob_IND_2, by = 'id')  %>%
  mutate(Subpoblación = '0') %>%
  rename(
    'Fenotipo_predicho' = value,
    'Fenotipo_observado' = Fen_escalado
    )

# 4. Se unen todos los datos anteriores de las distintas subpoblaciones de individuos genotipados en un solo conjunto de datos.

Pred_IND_a <- bind_rows(Pred_IND_1, Pred_IND_2, Pred_IND_3, Pred_IND_4) %>%
  arrange(id) %>%
  relocate(
    Variety,
    .after = id
    ) %>%
  relocate(
    Fenotipo_predicho,
    .after = Fenotipo_observado
    ) %>%
  mutate(Pedigrí = '5')

#######################################################
# Gráfico de dispersión de los resultados del pedigrí 1
#######################################################

Graf_disp_IND <- function(Subpoblación) {
  Pred_IND_a %>%
    filter(.data$Subpoblación == .env$Subpoblación) %>%
    ggplot() +
    aes(x = Fenotipo_observado, y = Fenotipo_predicho) +
    geom_point(size = 4.4, colour = 'yellow', alpha = 0.6) +
    geom_smooth(color = 'yellow', fill = 'yellow', method = 'lm', se = TRUE) +
    stat_cor(p.accuracy = 0.001, colour = 'gray34', label.x = -1.5, label.y = -1.5) +
    geom_rug(colour = 'gray') +
    scale_x_continuous(labels = label_number(accuracy = 0.01)) +
    scale_y_continuous(labels = label_number(accuracy = 0.01)) +
    ggtitle(glue('Individuos genotipados: {Subpoblación}')) +
    labs(x = 'Fenotipo observado', y = 'Fenotipo predicho') +
    theme_bw() +
    theme(
      axis.text = element_text(size = 14),
      axis.title = element_text(size = 15, face = 'bold'),
      plot.title = element_text(size = 11, face = 'bold'),
      legend.position = 'none'
      )
  }

Subpoblación <- c('0', '148', '298', '451')
Graf <- map(Subpoblación, Graf_disp_IND)
(Graf[[1]] | Graf[[2]] | Graf[[3]] | Graf[[4]]) +
  plot_annotation(title = 'Pedigrí tres') # Aquí se coloco pedigrí tres pero en realidad es el pedigrí cinco.

##############################################################
# (co)varianza y heredabilidad de los resultados del pedigrí 1
##############################################################

summary(mod_IND_4) # Aquí se oberva el resultado resumido del modelo, donde la varianza aditiva es igual a 0.5651 y la varianza ambiental es de 0.1258.

cv_mod_IND_4 <- VarCorr(mod_IND_4)
comp_varianza_4 <- as.data.frame(cv_mod_IND_4)$vcov
h2_4 <- comp_varianza_4[1] / sum(comp_varianza_4[1:2]) # La heredabilidad fue igual a 0.82.

########################################################
# Pedigrí 3: 1210 individuos simulados en 7 generaciones
########################################################

# 2. Se importa el archivo .fam obtenido usando plink y que posteriomente se uso para crear la hoja de parámetros para ejecutar el software molcoanc.

famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'nSNPs_IND.fam')) %>% 
  select(fam) %>%
  mutate(id = 1211:1661) %>%
  rename(Variety = fam)

# 3. Se crea un conjunto de datos que contiene solo los individuos mejorados.

Pob_mej <- lin_mej %>%
  filter(Status_with_Pedigree.plus.knowledge == 'I') %>% # Conjunto de datos solo con los individuos mejorados (los que se clasificaron como "I").
  select(X3K_DNA_IRIS_UNIQUE_ID) %>%
  rename(Variety = X3K_DNA_IRIS_UNIQUE_ID)

escalado <- function(x) { # Función usada para escalar el fenotipo.
  (x - mean(x, na.rm = TRUE)) / sd(x, na.rm = TRUE)
  }

Pob_IND <- Fenotipos %>%
  filter(SNPsubsp == 'IND') %>% # Conjunto de datos solo con la especie IND.
  mutate(
    Variety_2 = Variety,
    Fen_escalado = escalado(Time.to.flowering..from.sowing)
    ) %>%
  separate(
    col = Variety,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  ' '
  ) %>%
  unite(
    col = Variety,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  separate(
    col = Variety,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  '-'
  ) %>%
  unite(
    col = Variety,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  separate(
    col = Variety_2,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  ' '
  ) %>%
  unite(
    col = Variety_2,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  inner_join(y = Pob_mej, by = 'Variety') %>%
  select(Variety_2, Fen_escalado) %>% # Se creo el conjunto de datos con los individuos mejorados de la población indica.
  rename(Variety = Variety_2)

Pob_IND_2 <- Pob_IND %>%
  left_join(y = famsnps_IND, by = 'Variety') # Se unen al conjunto de datos famsnps_IND debido a que aquí esta la identificación numérica como esta en el pedigrí.

## 1. Subpoblación con 148 individuos genotipados

load(here('Datos', 'Datos_IND', 'Den_100.000_b', 'mod_lme4GS', 'Ped_3', 'mod_lme4GS_1', 'mod_lme4GS_1.RData'))

blup_IND_1 <- ranefUvcovNew(mod_IND_1, Uvcov = list(id = list(K = mH_IND_1)))
blup_IND_1 <- blup_IND_1$id[, 1] # Con la función ranefUvcovNew() obtengo el blup para los niveles de efectos aleatorios (aquí los individuos) con la matriz de varianza-covarianza especificada (la matriz H).

Pred_IND_9 <- fixef(mod_IND_1)[1] + blup_IND_1 # De esta forma obtengo los fenotipos predichos para los individuos con valores NA (aquí 2082 individuos).

Pob_IND_NA <- Pob_IND_5 %>% # Aquí, de la población total de Pob_IND_5 del pedigrí 3, me quedo solo con los 1292 individuos con valores NA. 
  filter(is.na(Fen_escalado))

Pred_IND_9 <- Pred_IND_9 %>% # Del vector anterior de fenotipos predichos, solo me quedo con los que pertenecen a las variedades mejoradas.
  as_tibble() %>%
  bind_cols(Pob_IND_NA) %>%
  filter(id %in% c(1211, 1215, 1223, 1224, 1226, 1227, 1228, 1229, 1230, 1231, 1232, 1233, 1240, 1272, 1286, 1311, 1326, 1337, 1338, 1339, 1340, 1343, 1344, 1345, 1347, 1380, 1389, 1390, 1412, 1420, 1459, 1473, 1474, 1491, 1518, 1537, 1538, 1575, 1578, 1579, 1580, 1582, 1584, 1585, 1586, 1634, 1647, 1656)) %>% # Estos serían los individuos que pertenecen a las variedades mejoradas.
  select(value, id) %>%
  inner_join(y = Pob_IND_2, by = 'id')  %>%
  mutate(Subpoblación = '148') %>%
  rename(
    'Fenotipo_predicho' = value,
    'Fenotipo_observado' = Fen_escalado
    )

## 2. Subpoblación con 298 individuos genotipados

load(here('Datos', 'Datos_IND', 'Den_100.000_b', 'mod_lme4GS', 'Ped_3', 'mod_lme4GS_2', 'mod_lme4GS_2.RData'))

blup_IND_2 <- ranefUvcovNew(mod_IND_2, Uvcov = list(id = list(K = mH_IND_2)))
blup_IND_2 <- blup_IND_2$id[, 1]

Pred_IND_10 <- fixef(mod_IND_2)[1] + blup_IND_2

Pob_IND_NA <- Pob_IND_5 %>% 
  filter(is.na(Fen_escalado))

Pred_IND_10 <- Pred_IND_10 %>%
  as_tibble() %>%
  bind_cols(Pob_IND_NA) %>%
  filter(id %in% c(1211, 1215, 1223, 1224, 1226, 1227, 1228, 1229, 1230, 1231, 1232, 1233, 1240, 1272, 1286, 1311, 1326, 1337, 1338, 1339, 1340, 1343, 1344, 1345, 1347, 1380, 1389, 1390, 1412, 1420, 1459, 1473, 1474, 1491, 1518, 1537, 1538, 1575, 1578, 1579, 1580, 1582, 1584, 1585, 1586, 1634, 1647, 1656)) %>% # Estos serían los individuos que pertenecen a las variedades mejoradas.
  select(value, id) %>%
  inner_join(y = Pob_IND_2, by = 'id')  %>%
  mutate(Subpoblación = '298') %>%
  rename(
    'Fenotipo_predicho' = value,
    'Fenotipo_observado' = Fen_escalado
    )

## 3. Subpoblación con 451 individuos genotipados

load(here('Datos', 'Datos_IND', 'Den_100.000_b', 'mod_lme4GS', 'Ped_3', 'mod_lme4GS_3', 'mod_lme4GS_3.RData'))

blup_IND_3 <- ranefUvcovNew(mod_IND_3, Uvcov = list(id = list(K = mH_IND_3)))
blup_IND_3 <- blup_IND_3$id[, 1]

Pred_IND_11 <- fixef(mod_IND_3)[1] + blup_IND_3

Pob_IND_NA <- Pob_IND_5 %>% 
  filter(is.na(Fen_escalado))

Pred_IND_11 <- Pred_IND_11 %>%
  as_tibble() %>%
  bind_cols(Pob_IND_NA) %>%
  filter(id %in% c(1211, 1215, 1223, 1224, 1226, 1227, 1228, 1229, 1230, 1231, 1232, 1233, 1240, 1272, 1286, 1311, 1326, 1337, 1338, 1339, 1340, 1343, 1344, 1345, 1347, 1380, 1389, 1390, 1412, 1420, 1459, 1473, 1474, 1491, 1518, 1537, 1538, 1575, 1578, 1579, 1580, 1582, 1584, 1585, 1586, 1634, 1647, 1656)) %>% # Estos serían los individuos que pertenecen a las variedades mejoradas.
  select(value, id) %>%
  inner_join(y = Pob_IND_2, by = 'id')  %>%
  mutate(Subpoblación = '451') %>%
  rename(
    'Fenotipo_predicho' = value,
    'Fenotipo_observado' = Fen_escalado
    )

## 4. Subpoblación con ningún individuo genotipado

load(here('Datos', 'Datos_IND', 'Den_100.000_b', 'mod_lme4GS', 'Ped_3', 'mod_lme4GS_4', 'mod_lme4GS_4.RData'))

blup_IND_4 <- ranefUvcovNew(mod_IND_4, Uvcov = list(id = list(K = mA_IND)))
blup_IND_4 <- blup_IND_4$id[, 1]

Pred_IND_12 <- fixef(mod_IND_4)[1] + blup_IND_4

Pob_IND_NA <- Pob_IND_5 %>% 
  filter(is.na(Fen_escalado))

Pred_IND_12 <- Pred_IND_12 %>%
  as_tibble() %>%
  bind_cols(Pob_IND_NA) %>%
  filter(id %in% c(1211, 1215, 1223, 1224, 1226, 1227, 1228, 1229, 1230, 1231, 1232, 1233, 1240, 1272, 1286, 1311, 1326, 1337, 1338, 1339, 1340, 1343, 1344, 1345, 1347, 1380, 1389, 1390, 1412, 1420, 1459, 1473, 1474, 1491, 1518, 1537, 1538, 1575, 1578, 1579, 1580, 1582, 1584, 1585, 1586, 1634, 1647, 1656)) %>% # Estos serían los individuos que pertenecen a las variedades mejoradas.
  select(value, id) %>%
  inner_join(y = Pob_IND_2, by = 'id')  %>%
  mutate(Subpoblación = '0') %>%
  rename(
    'Fenotipo_predicho' = value,
    'Fenotipo_observado' = Fen_escalado
    )

# 4. Se unen todos los datos anteriores de las distintas subpoblaciones de individuos. genotipados en un solo conjunto de datos

Pred_IND_c <- bind_rows(Pred_IND_9, Pred_IND_10, Pred_IND_11, Pred_IND_12) %>%
  arrange(id) %>%
  relocate(
    Variety,
    .after = id
  ) %>%
  relocate(
    Fenotipo_predicho,
    .after = Fenotipo_observado
  ) %>%
  mutate(Pedigrí = '3')

#######################################################
# Gráfico de dispersión de los resultados del pedigrí 3
#######################################################

Graf_disp_IND <- function(Subpoblación) {
  Pred_IND_c %>%
    filter(.data$Subpoblación == .env$Subpoblación) %>%
    ggplot() +
    aes(x = Fenotipo_observado, y = Fenotipo_predicho) +
    geom_point(size = 4.4, colour = 'yellow', alpha = 0.6) +
    geom_smooth(color = 'yellow', fill = 'yellow', method = 'lm', se = TRUE) +
    stat_cor(p.accuracy = 0.001, colour = 'gray34', label.x = -1.5, label.y = -1.5) +
    geom_rug(colour = 'gray') +
    scale_x_continuous(labels = label_number(accuracy = 0.01)) +
    scale_y_continuous(labels = label_number(accuracy = 0.01)) +
    ggtitle(glue('Individuos genotipados: {Subpoblación}')) +
    labs(x = 'Fenotipo observado', y = 'Fenotipo predicho') +
    theme_bw() +
    theme(
      axis.text = element_text(size = 14),
      axis.title = element_text(size = 15, face = 'bold'),
      plot.title = element_text(size = 11, face = 'bold'),
      legend.position = 'none'
      )
  }

Subpoblación <- c('0', '148', '298', '451')
Graf <- map(Subpoblación, Graf_disp_IND)
(Graf[[1]] | Graf[[2]] | Graf[[3]] | Graf[[4]]) +
  plot_annotation(title = 'Pedigrí dos') # Aquí se coloco pedigrí dos pero en realidad es el pedigrí tres.

##############################################################
# (co)varianza y heredabilidad de los resultados del pedigrí 3
##############################################################

summary(mod_IND_4) # Aquí se oberva el resultado resumido del modelo, donde la varianza aditiva es igual a 0.4569 y la varianza ambiental es de 0.1695.

cv_mod_IND_4 <- VarCorr(mod_IND_4)
comp_varianza_4 <- as.data.frame(cv_mod_IND_4)$vcov
h2_4 <- comp_varianza_4[1] / sum(comp_varianza_4[1:2]) # La heredabilidad fue igual a 0.73.

#######################################################
# Pedigrí 4: 300 individuos simulados en 3 generaciones
#######################################################

# 2. Se importa el archivo .fam obtenido usando plink y que posteriomente se uso para crear la hoja de parámetros para ejecutar el software molcoanc.

famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'nSNPs_IND.fam')) %>% 
  select(fam) %>%
  mutate(id = 301:751) %>%
  rename(Variety = fam)

# 3. Se crea un conjunto de datos que contiene solo los individuos mejorados.

Pob_mej <- lin_mej %>%
  filter(Status_with_Pedigree.plus.knowledge == 'I') %>% # Conjunto de datos solo con los individuos mejorados (los que se clasificaron como "I").
  select(X3K_DNA_IRIS_UNIQUE_ID) %>%
  rename(Variety = X3K_DNA_IRIS_UNIQUE_ID)

escalado <- function(x) { # Función usada para escalar el fenotipo.
  (x - mean(x, na.rm = TRUE)) / sd(x, na.rm = TRUE)
  }

Pob_IND <- Fenotipos %>%
  filter(SNPsubsp == 'IND') %>% # Conjunto de datos solo con la especie IND.
  mutate(
    Variety_2 = Variety,
    Fen_escalado = escalado(Time.to.flowering..from.sowing)
    ) %>%
  separate(
    col = Variety,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  ' '
  ) %>%
  unite(
    col = Variety,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  separate(
    col = Variety,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  '-'
  ) %>%
  unite(
    col = Variety,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  separate(
    col = Variety_2,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  ' '
  ) %>%
  unite(
    col = Variety_2,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  inner_join(y = Pob_mej, by = 'Variety') %>%
  select(Variety_2, Fen_escalado) %>% # Se creo el conjunto de datos con los individuos mejorados de la población indica.
  rename(Variety = Variety_2)

Pob_IND_2 <- Pob_IND %>%
  left_join(y = famsnps_IND, by = 'Variety') # Se unen al conjunto de datos famsnps_IND debido a que aquí esta la identificación numérica como esta en el pedigrí.

## 1. Subpoblación con 148 individuos genotipados

load(here('Datos', 'Datos_IND', 'Den_100.000_b', 'mod_lme4GS', 'Ped_4', 'mod_lme4GS_1', 'mod_lme4GS_1.RData'))

blup_IND_1 <- ranefUvcovNew(mod_IND_1, Uvcov = list(id = list(K = mH_IND_1)))
blup_IND_1 <- blup_IND_1$id[, 1] # Con la función ranefUvcovNew() obtengo el blup para los niveles de efectos aleatorios (aquí los individuos) con la matriz de varianza-covarianza especificada (la matriz H).

Pred_IND_13 <- fixef(mod_IND_1)[1] + blup_IND_1 # De esta forma obtengo los fenotipos predichos para los individuos con valores NA (aquí 382 individuos).

Pob_IND_NA <- Pob_IND_5 %>% # Aquí, de la población total de Pob_IND_5 del pedigrí 4, me quedo solo con los 382 individuos con valores NA. 
  filter(is.na(Fen_escalado))

Pred_IND_13 <- Pred_IND_13 %>% # Del vector anterior de fenotipos predichos, solo me quedo con los que pertenecen a las variedades mejoradas.
  as_tibble() %>%
  bind_cols(Pob_IND_NA) %>%
  filter(id %in% c(301, 305, 313, 314, 316, 317, 318, 319, 320, 321, 322, 323, 330, 362, 376, 401, 416, 427, 428, 429, 430, 433, 434, 435, 437, 470, 479, 480, 502, 510, 549, 563, 564, 581, 608, 627, 628, 665, 668, 669, 670, 672, 674, 675, 676, 724, 737, 746)) %>% # Estos serían los individuos que pertenecen a las variedades mejoradas.
  select(value, id) %>%
  inner_join(y = Pob_IND_2, by = 'id')  %>%
  mutate(Subpoblación = '148') %>%
  rename(
    'Fenotipo_predicho' = value,
    'Fenotipo_observado' = Fen_escalado
    )
## 2. Subpoblación con 298 individuos genotipados

load(here('Datos', 'Datos_IND', 'Den_100.000_b', 'mod_lme4GS', 'Ped_4', 'mod_lme4GS_2', 'mod_lme4GS_2.RData'))

blup_IND_2 <- ranefUvcovNew(mod_IND_2, Uvcov = list(id = list(K = mH_IND_2)))
blup_IND_2 <- blup_IND_2$id[, 1]

Pred_IND_14 <- fixef(mod_IND_2)[1] + blup_IND_2

Pob_IND_NA <- Pob_IND_5 %>% 
  filter(is.na(Fen_escalado))

Pred_IND_14 <- Pred_IND_14 %>%
  as_tibble() %>%
  bind_cols(Pob_IND_NA) %>%
  filter(id %in% c(301, 305, 313, 314, 316, 317, 318, 319, 320, 321, 322, 323, 330, 362, 376, 401, 416, 427, 428, 429, 430, 433, 434, 435, 437, 470, 479, 480, 502, 510, 549, 563, 564, 581, 608, 627, 628, 665, 668, 669, 670, 672, 674, 675, 676, 724, 737, 746)) %>% # Estos serían los individuos que pertenecen a las variedades mejoradas.
  select(value, id) %>%
  inner_join(y = Pob_IND_2, by = 'id')  %>%
  mutate(Subpoblación = '298') %>%
  rename(
    'Fenotipo_predicho' = value,
    'Fenotipo_observado' = Fen_escalado
    )

## 3. Subpoblación con 451 individuos genotipados

load(here('Datos', 'Datos_IND', 'Den_100.000_b', 'mod_lme4GS', 'Ped_4', 'mod_lme4GS_3', 'mod_lme4GS_3.RData'))

blup_IND_3 <- ranefUvcovNew(mod_IND_3, Uvcov = list(id = list(K = mH_IND_3)))
blup_IND_3 <- blup_IND_3$id[, 1]

Pred_IND_15 <- fixef(mod_IND_3)[1] + blup_IND_3

Pob_IND_NA <- Pob_IND_5 %>% 
  filter(is.na(Fen_escalado))

Pred_IND_15 <- Pred_IND_15 %>%
  as_tibble() %>%
  bind_cols(Pob_IND_NA) %>%
  filter(id %in% c(301, 305, 313, 314, 316, 317, 318, 319, 320, 321, 322, 323, 330, 362, 376, 401, 416, 427, 428, 429, 430, 433, 434, 435, 437, 470, 479, 480, 502, 510, 549, 563, 564, 581, 608, 627, 628, 665, 668, 669, 670, 672, 674, 675, 676, 724, 737, 746)) %>% # Estos serían los individuos que pertenecen a las variedades mejoradas.
  select(value, id) %>%
  inner_join(y = Pob_IND_2, by = 'id')  %>%
  mutate(Subpoblación = '451') %>%
  rename(
    'Fenotipo_predicho' = value,
    'Fenotipo_observado' = Fen_escalado
    )

## 4. Subpoblación con ningún individuo genotipado

load(here('Datos', 'Datos_IND', 'Den_100.000_b', 'mod_lme4GS', 'Ped_4', 'mod_lme4GS_4', 'mod_lme4GS_4.RData'))

blup_IND_4 <- ranefUvcovNew(mod_IND_4, Uvcov = list(id = list(K = mA_IND)))
blup_IND_4 <- blup_IND_4$id[, 1]

Pred_IND_16 <- fixef(mod_IND_4)[1] + blup_IND_4

Pob_IND_NA <- Pob_IND_5 %>% 
  filter(is.na(Fen_escalado))

Pred_IND_16 <- Pred_IND_16 %>%
  as_tibble() %>%
  bind_cols(Pob_IND_NA) %>%
  filter(id %in% c(301, 305, 313, 314, 316, 317, 318, 319, 320, 321, 322, 323, 330, 362, 376, 401, 416, 427, 428, 429, 430, 433, 434, 435, 437, 470, 479, 480, 502, 510, 549, 563, 564, 581, 608, 627, 628, 665, 668, 669, 670, 672, 674, 675, 676, 724, 737, 746)) %>% # Estos serían los individuos que pertenecen a las variedades mejoradas.
  select(value, id) %>%
  inner_join(y = Pob_IND_2, by = 'id')  %>%
  mutate(Subpoblación = '0') %>%
  rename(
    'Fenotipo_predicho' = value,
    'Fenotipo_observado' = Fen_escalado
    )

# 4. Se unen todos los datos anteriores de las distintas subpoblaciones de individuos. genotipados en un solo conjunto de datos

Pred_IND_d <- bind_rows(Pred_IND_13, Pred_IND_14, Pred_IND_15, Pred_IND_16) %>%
  arrange(id) %>%
  relocate(
    Variety,
    .after = id
  ) %>%
  relocate(
    Fenotipo_predicho,
    .after = Fenotipo_observado
  ) %>%
  mutate(Pedigrí = '1')

#######################################################
# Gráfico de dispersión de los resultados del pedigrí 4
#######################################################

Graf_disp_IND <- function(Subpoblación) {
  Pred_IND_d %>%
    filter(.data$Subpoblación == .env$Subpoblación) %>%
    ggplot() +
    aes(x = Fenotipo_observado, y = Fenotipo_predicho) +
    geom_point(size = 4.4, colour = 'yellow', alpha = 0.6) +
    geom_smooth(color = 'yellow', fill = 'yellow', method = 'lm', se = TRUE) +
    stat_cor(p.accuracy = 0.001, colour = 'gray34', label.x = -1.5, label.y = -1.5) +
    geom_rug(colour = 'gray') +
    scale_x_continuous(labels = label_number(accuracy = 0.01)) +
    scale_y_continuous(labels = label_number(accuracy = 0.01)) +
    ggtitle(glue('Individuos genotipados: {Subpoblación}')) +
    labs(x = 'Fenotipo observado', y = 'Fenotipo predicho') +
    theme_bw() +
    theme(
      axis.text = element_text(size = 14),
      axis.title = element_text(size = 15, face = 'bold'),
      plot.title = element_text(size = 11, face = 'bold'),
      legend.position = 'none'
      )
  }

Subpoblación <- c('0', '148', '298', '451')
Graf <- map(Subpoblación, Graf_disp_IND)
(Graf[[1]] | Graf[[2]] | Graf[[3]] | Graf[[4]]) +
  plot_annotation(title = 'Pedigrí uno')

##############################################################
# (co)varianza y heredabilidad de los resultados del pedigrí 3
##############################################################

summary(mod_IND_4) # Aquí se oberva el resultado resumido del modelo, donde la varianza aditiva es igual a 0.4882 y la varianza ambiental es de 0.1131.

cv_mod_IND_4 <- VarCorr(mod_IND_4)
comp_varianza_4 <- as.data.frame(cv_mod_IND_4)$vcov
h2_4 <- comp_varianza_4[1] / sum(comp_varianza_4[1:2]) # La heredabilidad fue igual a 0.81.

#### Población de arroz IND (10.000 SNPs) ----

#########################################################
# Pedigrí 1: 2000 individuos simulados en 10 generaciones
#########################################################

# 2. Se importa el archivo .fam obtenido usando plink y que posteriomente se uso para crear la hoja de parámetros para ejecutar el software molcoanc.

famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'nSNPs_IND.fam')) %>% 
  select(fam) %>%
  mutate(id = 2001:2451) %>%
  rename(Variety = fam)

# 3. Se crea un conjunto de datos que contiene solo los individuos mejorados.

Pob_mej <- lin_mej %>%
  filter(Status_with_Pedigree.plus.knowledge == 'I') %>% # Conjunto de datos solo con los individuos mejorados (los que se clasificaron como "I").
  select(X3K_DNA_IRIS_UNIQUE_ID) %>%
  rename(Variety = X3K_DNA_IRIS_UNIQUE_ID)

escalado <- function(x) { # Función usada para escalar el fenotipo.
  (x - mean(x, na.rm = TRUE)) / sd(x, na.rm = TRUE)
  }

Pob_IND <- Fenotipos %>%
  filter(SNPsubsp == 'IND') %>% # Conjunto de datos solo con la especie IND.
  mutate(
    Variety_2 = Variety,
    Fen_escalado = escalado(Time.to.flowering..from.sowing)
    ) %>%
  separate(
    col = Variety,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  ' '
  ) %>%
  unite(
    col = Variety,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  separate(
    col = Variety,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  '-'
  ) %>%
  unite(
    col = Variety,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  separate(
    col = Variety_2,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  ' '
  ) %>%
  unite(
    col = Variety_2,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  inner_join(y = Pob_mej, by = 'Variety') %>%
  select(Variety_2, Fen_escalado) %>% # Se creo el conjunto de datos con los individuos mejorados de la población indica.
  rename(Variety = Variety_2)

Pob_IND_2 <- Pob_IND %>%
  left_join(y = famsnps_IND, by = 'Variety') # Se unen al conjunto de datos famsnps_IND debido a que aquí esta la identificación numérica como esta en el pedigrí.

## 1. Subpoblación con 148 individuos genotipados

load(here('Datos', 'Datos_IND', 'Den_10.000', 'mod_lme4GS', 'Ped_1', 'mod_lme4GS_1', 'mod_lme4GS_1.RData'))

blup_IND_1 <- ranefUvcovNew(mod_IND_1, Uvcov = list(id = list(K = mH_IND_1)))
blup_IND_1 <- blup_IND_1$id[, 1] # Con la función ranefUvcovNew() obtengo el blup para los niveles de efectos aleatorios (aquí los individuos) con la matriz de varianza-covarianza especificada (la matriz H).

Pred_IND_1 <- fixef(mod_IND_1)[1] + blup_IND_1 # De esta forma obtengo los fenotipos predichos para los individuos con valores NA (aquí 2082 individuos).

Pob_IND_NA <- Pob_IND_5 %>% # Aquí, de la población total en Pob_IND_5 del pedigrí 1, me quedo solo con los 2082 individuos con valores NA. 
  filter(is.na(Fen_escalado))

Pred_IND_1 <- Pred_IND_1 %>% # Del vector anterior de fenotipos predichos, sol me quedo con los que pertenecen a las variedades mejoradas.
  as_tibble() %>%
  bind_cols(Pob_IND_NA) %>%
  filter(id %in% c(2001, 2005, 2013, 2014, 2016, 2017, 2018, 2019, 2020, 2021, 2022, 2023, 2030, 2062, 2076, 2101, 2116, 2127, 2128, 2129, 2130, 2133, 2134, 2135, 2137, 2170, 2179, 2180, 2202, 2210, 2249, 2263, 2264, 2281, 2308, 2327, 2328, 2365, 2368, 2369, 2370, 2372, 2374, 2375, 2376, 2424, 2437, 2446)) %>% # Estos serían los individuos que pertenecen a las variedades mejoradas.
  select(value, id) %>%
  inner_join(y = Pob_IND_2, by = 'id')  %>%
  mutate(Subpoblación = '148') %>%
  rename(
    'Fenotipo_predicho' = value,
    'Fenotipo_observado' = Fen_escalado
    )

## 2. Subpoblación con 298 individuos genotipados

load(here('Datos', 'Datos_IND', 'Den_10.000', 'mod_lme4GS', 'Ped_1', 'mod_lme4GS_2', 'mod_lme4GS_2.RData'))

blup_IND_2 <- ranefUvcovNew(mod_IND_2, Uvcov = list(id = list(K = mH_IND_2)))
blup_IND_2 <- blup_IND_2$id[, 1]

Pred_IND_2 <- fixef(mod_IND_2)[1] + blup_IND_2

Pob_IND_NA <- Pob_IND_5 %>% 
  filter(is.na(Fen_escalado))

Pred_IND_2 <- Pred_IND_2 %>%
  as_tibble() %>%
  bind_cols(Pob_IND_NA) %>%
  filter(id %in% c(2001, 2005, 2013, 2014, 2016, 2017, 2018, 2019, 2020, 2021, 2022, 2023, 2030, 2062, 2076, 2101, 2116, 2127, 2128, 2129, 2130, 2133, 2134, 2135, 2137, 2170, 2179, 2180, 2202, 2210, 2249, 2263, 2264, 2281, 2308, 2327, 2328, 2365, 2368, 2369, 2370, 2372, 2374, 2375, 2376, 2424, 2437, 2446)) %>% # Estos serían los individuos que pertenecen a las variedades mejoradas.
  select(value, id) %>%
  inner_join(y = Pob_IND_2, by = 'id')  %>%
  mutate(Subpoblación = '298') %>%
  rename(
    'Fenotipo_predicho' = value,
    'Fenotipo_observado' = Fen_escalado
    )

## 3. Subpoblación con 451 individuos genotipados

load(here('Datos', 'Datos_IND', 'Den_10.000', 'mod_lme4GS', 'Ped_1', 'mod_lme4GS_3', 'mod_lme4GS_3.RData'))

blup_IND_3 <- ranefUvcovNew(mod_IND_3, Uvcov = list(id = list(K = mH_IND_3)))
blup_IND_3 <- blup_IND_3$id[, 1]

Pred_IND_3 <- fixef(mod_IND_3)[1] + blup_IND_3

Pob_IND_NA <- Pob_IND_5 %>% 
  filter(is.na(Fen_escalado))

Pred_IND_3 <- Pred_IND_3 %>%
  as_tibble() %>%
  bind_cols(Pob_IND_NA) %>%
  filter(id %in% c(2001, 2005, 2013, 2014, 2016, 2017, 2018, 2019, 2020, 2021, 2022, 2023, 2030, 2062, 2076, 2101, 2116, 2127, 2128, 2129, 2130, 2133, 2134, 2135, 2137, 2170, 2179, 2180, 2202, 2210, 2249, 2263, 2264, 2281, 2308, 2327, 2328, 2365, 2368, 2369, 2370, 2372, 2374, 2375, 2376, 2424, 2437, 2446)) %>% # Estos serían los individuos que pertenecen a las variedades mejoradas.
  select(value, id) %>%
  inner_join(y = Pob_IND_2, by = 'id')  %>%
  mutate(Subpoblación = '451') %>%
  rename(
    'Fenotipo_predicho' = value,
    'Fenotipo_observado' = Fen_escalado
    )

## 4. Subpoblación con ningún individuo genotipado

load(here('Datos', 'Datos_IND', 'Den_10.000', 'mod_lme4GS', 'Ped_1', 'mod_lme4GS_4', 'mod_lme4GS_4.RData'))

blup_IND_4 <- ranefUvcovNew(mod_IND_4, Uvcov = list(id = list(K = mA_IND)))
blup_IND_4 <- blup_IND_4$id[, 1]

Pred_IND_4 <- fixef(mod_IND_4)[1] + blup_IND_4

Pob_IND_NA <- Pob_IND_5 %>% 
  filter(is.na(Fen_escalado))

Pred_IND_4 <- Pred_IND_4 %>%
  as_tibble() %>%
  bind_cols(Pob_IND_NA) %>%
  filter(id %in% c(2001, 2005, 2013, 2014, 2016, 2017, 2018, 2019, 2020, 2021, 2022, 2023, 2030, 2062, 2076, 2101, 2116, 2127, 2128, 2129, 2130, 2133, 2134, 2135, 2137, 2170, 2179, 2180, 2202, 2210, 2249, 2263, 2264, 2281, 2308, 2327, 2328, 2365, 2368, 2369, 2370, 2372, 2374, 2375, 2376, 2424, 2437, 2446)) %>% # Estos serían los individuos que pertenecen a las variedades mejoradas.
  select(value, id) %>%
  inner_join(y = Pob_IND_2, by = 'id')  %>%
  mutate(Subpoblación = '0') %>%
  rename(
    'Fenotipo_predicho' = value,
    'Fenotipo_observado' = Fen_escalado
    )

# 4. Se unen todos los datos anteriores de las distintas subpoblaciones de individuos genotipados en un solo conjunto de datos.

Pred_IND_a <- bind_rows(Pred_IND_1, Pred_IND_2, Pred_IND_3, Pred_IND_4) %>%
  arrange(id) %>%
  relocate(
    Variety,
    .after = id
    ) %>%
  relocate(
    Fenotipo_predicho,
    .after = Fenotipo_observado
    ) %>%
  mutate(Pedigrí = '5')

Graf_disp_IND <- function(Subpoblación) {
  Pred_IND_a %>%
    filter(.data$Subpoblación == .env$Subpoblación) %>%
    ggplot() +
    aes(x = Fenotipo_observado, y = Fenotipo_predicho) +
    geom_point(size = 4.4, colour = 'cyan', alpha = 0.6) +
    geom_smooth(color = 'cyan', fill = 'cyan', method = 'lm', se = TRUE) +
    stat_cor(p.accuracy = 0.001, colour = 'gray34', label.x = -1.5, label.y = -1.5) +
    geom_rug(colour = 'gray') +
    scale_x_continuous(labels = label_number(accuracy = 0.01)) +
    scale_y_continuous(labels = label_number(accuracy = 0.01)) +
    ggtitle(glue('Individuos genotipados: {Subpoblación}')) +
    labs(x = 'Fenotipo observado', y = 'Fenotipo predicho') +
    theme_bw() +
    theme(
      axis.text = element_text(size = 14),
      axis.title = element_text(size = 15, face = 'bold'),
      plot.title = element_text(size = 11, face = 'bold'),
      legend.position = 'none'
      )
  }

Subpoblación <- c('0', '148', '298', '451')
Graf <- map(Subpoblación, Graf_disp_IND)
(Graf[[1]] | Graf[[2]] | Graf[[3]] | Graf[[4]]) +
  plot_annotation(title = 'Pedigrí tres') # Aquí se coloco pedigrí tres pero en realidad es el pedigrí cinco.

##############################################################
# (co)varianza y heredabilidad de los resultados del pedigrí 3
##############################################################

summary(mod_IND_4) # Aquí se oberva el resultado resumido del modelo, donde la varianza aditiva es igual a 0.5651 y la varianza ambiental es de 0.1258.

cv_mod_IND_4 <- VarCorr(mod_IND_4)
comp_varianza_4 <- as.data.frame(cv_mod_IND_4)$vcov
h2_4 <- comp_varianza_4[1] / sum(comp_varianza_4[1:2]) # La heredabilidad fue igual a 0.82.

########################################################
# Pedigrí 3: 1210 individuos simulados en 7 generaciones
########################################################

# 2. Se importa el archivo .fam obtenido usando plink y que posteriomente se uso para crear la hoja de parámetros para ejecutar el software molcoanc.

famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'nSNPs_IND.fam')) %>% 
  select(fam) %>%
  mutate(id = 1211:1661) %>%
  rename(Variety = fam)

# 3. Se crea un conjunto de datos que contiene solo los individuos mejorados.

Pob_mej <- lin_mej %>%
  filter(Status_with_Pedigree.plus.knowledge == 'I') %>% # Conjunto de datos solo con los individuos mejorados (los que se clasificaron como "I").
  select(X3K_DNA_IRIS_UNIQUE_ID) %>%
  rename(Variety = X3K_DNA_IRIS_UNIQUE_ID)

escalado <- function(x) { # Función usada para escalar el fenotipo.
  (x - mean(x, na.rm = TRUE)) / sd(x, na.rm = TRUE)
  }

Pob_IND <- Fenotipos %>%
  filter(SNPsubsp == 'IND') %>% # Conjunto de datos solo con la especie IND.
  mutate(
    Variety_2 = Variety,
    Fen_escalado = escalado(Time.to.flowering..from.sowing)
    ) %>%
  separate(
    col = Variety,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  ' '
  ) %>%
  unite(
    col = Variety,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  separate(
    col = Variety,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  '-'
  ) %>%
  unite(
    col = Variety,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  separate(
    col = Variety_2,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  ' '
  ) %>%
  unite(
    col = Variety_2,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  inner_join(y = Pob_mej, by = 'Variety') %>%
  select(Variety_2, Fen_escalado) %>% # Se creo el conjunto de datos con los individuos mejorados de la población indica.
  rename(Variety = Variety_2)

Pob_IND_2 <- Pob_IND %>%
  left_join(y = famsnps_IND, by = 'Variety') # Se unen al conjunto de datos famsnps_IND debido a que aquí esta la identificación numérica como esta en el pedigrí.

## 1. Subpoblación con 148 individuos genotipados

load(here('Datos', 'Datos_IND', 'Den_10.000', 'mod_lme4GS', 'Ped_3', 'mod_lme4GS_1', 'mod_lme4GS_1.RData'))

blup_IND_1 <- ranefUvcovNew(mod_IND_1, Uvcov = list(id = list(K = mH_IND_1)))
blup_IND_1 <- blup_IND_1$id[, 1] # Con la función ranefUvcovNew() obtengo el blup para los niveles de efectos aleatorios (aquí los individuos) con la matriz de varianza-covarianza especificada (la matriz H).

Pred_IND_9 <- fixef(mod_IND_1)[1] + blup_IND_1 # De esta forma obtengo los fenotipos predichos para los individuos con valores NA (aquí 2082 individuos).

Pob_IND_NA <- Pob_IND_5 %>% # Aquí, de la población total de Pob_IND_5 del pedigrí 3, me quedo solo con los 1292 individuos con valores NA. 
  filter(is.na(Fen_escalado))

Pred_IND_9 <- Pred_IND_9 %>% # Del vector anterior de fenotipos predichos, solo me quedo con los que pertenecen a las variedades mejoradas.
  as_tibble() %>%
  bind_cols(Pob_IND_NA) %>%
  filter(id %in% c(1211, 1215, 1223, 1224, 1226, 1227, 1228, 1229, 1230, 1231, 1232, 1233, 1240, 1272, 1286, 1311, 1326, 1337, 1338, 1339, 1340, 1343, 1344, 1345, 1347, 1380, 1389, 1390, 1412, 1420, 1459, 1473, 1474, 1491, 1518, 1537, 1538, 1575, 1578, 1579, 1580, 1582, 1584, 1585, 1586, 1634, 1647, 1656)) %>% # Estos serían los individuos que pertenecen a las variedades mejoradas.
  select(value, id) %>%
  inner_join(y = Pob_IND_2, by = 'id')  %>%
  mutate(Subpoblación = '148') %>%
  rename(
    'Fenotipo_predicho' = value,
    'Fenotipo_observado' = Fen_escalado
    )

## 2. Subpoblación con 298 individuos genotipados

load(here('Datos', 'Datos_IND', 'Den_10.000', 'mod_lme4GS', 'Ped_3', 'mod_lme4GS_2', 'mod_lme4GS_2.RData'))

blup_IND_2 <- ranefUvcovNew(mod_IND_2, Uvcov = list(id = list(K = mH_IND_2)))
blup_IND_2 <- blup_IND_2$id[, 1]

Pred_IND_10 <- fixef(mod_IND_2)[1] + blup_IND_2

Pob_IND_NA <- Pob_IND_5 %>% 
  filter(is.na(Fen_escalado))

Pred_IND_10 <- Pred_IND_10 %>%
  as_tibble() %>%
  bind_cols(Pob_IND_NA) %>%
  filter(id %in% c(1211, 1215, 1223, 1224, 1226, 1227, 1228, 1229, 1230, 1231, 1232, 1233, 1240, 1272, 1286, 1311, 1326, 1337, 1338, 1339, 1340, 1343, 1344, 1345, 1347, 1380, 1389, 1390, 1412, 1420, 1459, 1473, 1474, 1491, 1518, 1537, 1538, 1575, 1578, 1579, 1580, 1582, 1584, 1585, 1586, 1634, 1647, 1656)) %>% # Estos serían los individuos que pertenecen a las variedades mejoradas.
  select(value, id) %>%
  inner_join(y = Pob_IND_2, by = 'id')  %>%
  mutate(Subpoblación = '298') %>%
  rename(
    'Fenotipo_predicho' = value,
    'Fenotipo_observado' = Fen_escalado
    )

## 3. Subpoblación con 451 individuos genotipados

load(here('Datos', 'Datos_IND', 'Den_10.000', 'mod_lme4GS', 'Ped_3', 'mod_lme4GS_3', 'mod_lme4GS_3.RData'))

blup_IND_3 <- ranefUvcovNew(mod_IND_3, Uvcov = list(id = list(K = mH_IND_3)))
blup_IND_3 <- blup_IND_3$id[, 1]

Pred_IND_11 <- fixef(mod_IND_3)[1] + blup_IND_3

Pob_IND_NA <- Pob_IND_5 %>% 
  filter(is.na(Fen_escalado))

Pred_IND_11 <- Pred_IND_11 %>%
  as_tibble() %>%
  bind_cols(Pob_IND_NA) %>%
  filter(id %in% c(1211, 1215, 1223, 1224, 1226, 1227, 1228, 1229, 1230, 1231, 1232, 1233, 1240, 1272, 1286, 1311, 1326, 1337, 1338, 1339, 1340, 1343, 1344, 1345, 1347, 1380, 1389, 1390, 1412, 1420, 1459, 1473, 1474, 1491, 1518, 1537, 1538, 1575, 1578, 1579, 1580, 1582, 1584, 1585, 1586, 1634, 1647, 1656)) %>% # Estos serían los individuos que pertenecen a las variedades mejoradas.
  select(value, id) %>%
  inner_join(y = Pob_IND_2, by = 'id')  %>%
  mutate(Subpoblación = '451') %>%
  rename(
    'Fenotipo_predicho' = value,
    'Fenotipo_observado' = Fen_escalado
    )

## 4. Subpoblación con ningún individuo genotipado

load(here('Datos', 'Datos_IND', 'Den_10.000', 'mod_lme4GS', 'Ped_3', 'mod_lme4GS_4', 'mod_lme4GS_4.RData'))

blup_IND_4 <- ranefUvcovNew(mod_IND_4, Uvcov = list(id = list(K = mA_IND)))
blup_IND_4 <- blup_IND_4$id[, 1]

Pred_IND_12 <- fixef(mod_IND_4)[1] + blup_IND_4

Pob_IND_NA <- Pob_IND_5 %>% 
  filter(is.na(Fen_escalado))

Pred_IND_12 <- Pred_IND_12 %>%
  as_tibble() %>%
  bind_cols(Pob_IND_NA) %>%
  filter(id %in% c(1211, 1215, 1223, 1224, 1226, 1227, 1228, 1229, 1230, 1231, 1232, 1233, 1240, 1272, 1286, 1311, 1326, 1337, 1338, 1339, 1340, 1343, 1344, 1345, 1347, 1380, 1389, 1390, 1412, 1420, 1459, 1473, 1474, 1491, 1518, 1537, 1538, 1575, 1578, 1579, 1580, 1582, 1584, 1585, 1586, 1634, 1647, 1656)) %>% # Estos serían los individuos que pertenecen a las variedades mejoradas.
  select(value, id) %>%
  inner_join(y = Pob_IND_2, by = 'id')  %>%
  mutate(Subpoblación = '0') %>%
  rename(
    'Fenotipo_predicho' = value,
    'Fenotipo_observado' = Fen_escalado
    )

# 4. Se unen todos los datos anteriores de las distintas subpoblaciones de individuos. genotipados en un solo conjunto de datos

Pred_IND_c <- bind_rows(Pred_IND_9, Pred_IND_10, Pred_IND_11, Pred_IND_12) %>%
  arrange(id) %>%
  relocate(
    Variety,
    .after = id
  ) %>%
  relocate(
    Fenotipo_predicho,
    .after = Fenotipo_observado
  ) %>%
  mutate(Pedigrí = '3')

#######################################################
# Gráfico de dispersión de los resultados del pedigrí 3
#######################################################

Graf_disp_IND <- function(Subpoblación) {
  Pred_IND_c %>%
    filter(.data$Subpoblación == .env$Subpoblación) %>%
    ggplot() +
    aes(x = Fenotipo_observado, y = Fenotipo_predicho) +
    geom_point(size = 4.4, colour = 'cyan', alpha = 0.6) +
    geom_smooth(color = 'cyan', fill = 'cyan', method = 'lm', se = TRUE) +
    stat_cor(p.accuracy = 0.001, colour = 'gray34', label.x = -1.5, label.y = -1.5) +
    geom_rug(colour = 'gray') +
    scale_x_continuous(labels = label_number(accuracy = 0.01)) +
    scale_y_continuous(labels = label_number(accuracy = 0.01)) +
    ggtitle(glue('Individuos genotipados: {Subpoblación}')) +
    labs(x = 'Fenotipo observado', y = 'Fenotipo predicho') +
    theme_bw() +
    theme(
      axis.text = element_text(size = 14),
      axis.title = element_text(size = 15, face = 'bold'),
      plot.title = element_text(size = 11, face = 'bold'),
      legend.position = 'none'
      )
  }

Subpoblación <- c('0', '148', '298', '451')
Graf <- map(Subpoblación, Graf_disp_IND)
(Graf[[1]] | Graf[[2]] | Graf[[3]] | Graf[[4]]) +
  plot_annotation(title = 'Pedigrí dos') # Aquí se coloco pedigrí dos pero en realidad es el pedigrí tres.

##############################################################
# (co)varianza y heredabilidad de los resultados del pedigrí 3
##############################################################

summary(mod_IND_4) # Aquí se oberva el resultado resumido del modelo, donde la varianza aditiva es igual a 0.4569 y la varianza ambiental es de 0.1695.

cv_mod_IND_4 <- VarCorr(mod_IND_4)
comp_varianza_4 <- as.data.frame(cv_mod_IND_4)$vcov
h2_4 <- comp_varianza_4[1] / sum(comp_varianza_4[1:2]) # La heredabilidad fue igual a 0.73.

#######################################################
# Pedigrí 4: 300 individuos simulados en 3 generaciones
#######################################################

# 2. Se importa el archivo .fam obtenido usando plink y que posteriomente se uso para crear la hoja de parámetros para ejecutar el software molcoanc.

famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'nSNPs_IND.fam')) %>% 
  select(fam) %>%
  mutate(id = 301:751) %>%
  rename(Variety = fam)

# 3. Se crea un conjunto de datos que contiene solo los individuos mejorados.

Pob_mej <- lin_mej %>%
  filter(Status_with_Pedigree.plus.knowledge == 'I') %>% # Conjunto de datos solo con los individuos mejorados (los que se clasificaron como "I").
  select(X3K_DNA_IRIS_UNIQUE_ID) %>%
  rename(Variety = X3K_DNA_IRIS_UNIQUE_ID)

escalado <- function(x) { # Función usada para escalar el fenotipo.
  (x - mean(x, na.rm = TRUE)) / sd(x, na.rm = TRUE)
  }

Pob_IND <- Fenotipos %>%
  filter(SNPsubsp == 'IND') %>% # Conjunto de datos solo con la especie IND.
  mutate(
    Variety_2 = Variety,
    Fen_escalado = escalado(Time.to.flowering..from.sowing)
    ) %>%
  separate(
    col = Variety,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  ' '
  ) %>%
  unite(
    col = Variety,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  separate(
    col = Variety,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  '-'
  ) %>%
  unite(
    col = Variety,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  separate(
    col = Variety_2,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  ' '
  ) %>%
  unite(
    col = Variety_2,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  inner_join(y = Pob_mej, by = 'Variety') %>%
  select(Variety_2, Fen_escalado) %>% # Se creo el conjunto de datos con los individuos mejorados de la población indica.
  rename(Variety = Variety_2)

Pob_IND_2 <- Pob_IND %>%
  left_join(y = famsnps_IND, by = 'Variety') # Se unen al conjunto de datos famsnps_IND debido a que aquí esta la identificación numérica como esta en el pedigrí.

## 1. Subpoblación con 148 individuos genotipados

load(here('Datos', 'Datos_IND', 'Den_10.000', 'mod_lme4GS', 'Ped_4', 'mod_lme4GS_1', 'mod_lme4GS_1.RData'))

blup_IND_1 <- ranefUvcovNew(mod_IND_1, Uvcov = list(id = list(K = mH_IND_1)))
blup_IND_1 <- blup_IND_1$id[, 1] # Con la función ranefUvcovNew() obtengo el blup para los niveles de efectos aleatorios (aquí los individuos) con la matriz de varianza-covarianza especificada (la matriz H).

Pred_IND_13 <- fixef(mod_IND_1)[1] + blup_IND_1 # De esta forma obtengo los fenotipos predichos para los individuos con valores NA (aquí 382 individuos).

Pob_IND_NA <- Pob_IND_5 %>% # Aquí, de la población total de Pob_IND_5 del pedigrí 4, me quedo solo con los 382 individuos con valores NA. 
  filter(is.na(Fen_escalado))

Pred_IND_13 <- Pred_IND_13 %>% # Del vector anterior de fenotipos predichos, solo me quedo con los que pertenecen a las variedades mejoradas.
  as_tibble() %>%
  bind_cols(Pob_IND_NA) %>%
  filter(id %in% c(301, 305, 313, 314, 316, 317, 318, 319, 320, 321, 322, 323, 330, 362, 376, 401, 416, 427, 428, 429, 430, 433, 434, 435, 437, 470, 479, 480, 502, 510, 549, 563, 564, 581, 608, 627, 628, 665, 668, 669, 670, 672, 674, 675, 676, 724, 737, 746)) %>% # Estos serían los individuos que pertenecen a las variedades mejoradas.
  select(value, id) %>%
  inner_join(y = Pob_IND_2, by = 'id')  %>%
  mutate(Subpoblación = '148') %>%
  rename(
    'Fenotipo_predicho' = value,
    'Fenotipo_observado' = Fen_escalado
    )

## 2. Subpoblación con 298 individuos genotipados

load(here('Datos', 'Datos_IND', 'Den_10.000', 'mod_lme4GS', 'Ped_4', 'mod_lme4GS_2', 'mod_lme4GS_2.RData'))

blup_IND_2 <- ranefUvcovNew(mod_IND_2, Uvcov = list(id = list(K = mH_IND_2)))
blup_IND_2 <- blup_IND_2$id[, 1]

Pred_IND_14 <- fixef(mod_IND_2)[1] + blup_IND_2

Pob_IND_NA <- Pob_IND_5 %>% 
  filter(is.na(Fen_escalado))

Pred_IND_14 <- Pred_IND_14 %>%
  as_tibble() %>%
  bind_cols(Pob_IND_NA) %>%
  filter(id %in% c(301, 305, 313, 314, 316, 317, 318, 319, 320, 321, 322, 323, 330, 362, 376, 401, 416, 427, 428, 429, 430, 433, 434, 435, 437, 470, 479, 480, 502, 510, 549, 563, 564, 581, 608, 627, 628, 665, 668, 669, 670, 672, 674, 675, 676, 724, 737, 746)) %>% # Estos serían los individuos que pertenecen a las variedades mejoradas.
  select(value, id) %>%
  inner_join(y = Pob_IND_2, by = 'id')  %>%
  mutate(Subpoblación = '298') %>%
  rename(
    'Fenotipo_predicho' = value,
    'Fenotipo_observado' = Fen_escalado
    )

## 3. Subpoblación con 451 individuos genotipados

load(here('Datos', 'Datos_IND', 'Den_10.000', 'mod_lme4GS', 'Ped_4', 'mod_lme4GS_3', 'mod_lme4GS_3.RData'))

blup_IND_3 <- ranefUvcovNew(mod_IND_3, Uvcov = list(id = list(K = mH_IND_3)))
blup_IND_3 <- blup_IND_3$id[, 1]

Pred_IND_15 <- fixef(mod_IND_3)[1] + blup_IND_3

Pob_IND_NA <- Pob_IND_5 %>% 
  filter(is.na(Fen_escalado))

Pred_IND_15 <- Pred_IND_15 %>%
  as_tibble() %>%
  bind_cols(Pob_IND_NA) %>%
  filter(id %in% c(301, 305, 313, 314, 316, 317, 318, 319, 320, 321, 322, 323, 330, 362, 376, 401, 416, 427, 428, 429, 430, 433, 434, 435, 437, 470, 479, 480, 502, 510, 549, 563, 564, 581, 608, 627, 628, 665, 668, 669, 670, 672, 674, 675, 676, 724, 737, 746)) %>% # Estos serían los individuos que pertenecen a las variedades mejoradas.
  select(value, id) %>%
  inner_join(y = Pob_IND_2, by = 'id')  %>%
  mutate(Subpoblación = '451') %>%
  rename(
    'Fenotipo_predicho' = value,
    'Fenotipo_observado' = Fen_escalado
    )

## 4. Subpoblación con ningún individuo genotipado

load(here('Datos', 'Datos_IND', 'Den_10.000', 'mod_lme4GS', 'Ped_4', 'mod_lme4GS_4', 'mod_lme4GS_4.RData'))

blup_IND_4 <- ranefUvcovNew(mod_IND_4, Uvcov = list(id = list(K = mA_IND)))
blup_IND_4 <- blup_IND_4$id[, 1]

Pred_IND_16 <- fixef(mod_IND_4)[1] + blup_IND_4

Pob_IND_NA <- Pob_IND_5 %>% 
  filter(is.na(Fen_escalado))

Pred_IND_16 <- Pred_IND_16 %>%
  as_tibble() %>%
  bind_cols(Pob_IND_NA) %>%
  filter(id %in% c(301, 305, 313, 314, 316, 317, 318, 319, 320, 321, 322, 323, 330, 362, 376, 401, 416, 427, 428, 429, 430, 433, 434, 435, 437, 470, 479, 480, 502, 510, 549, 563, 564, 581, 608, 627, 628, 665, 668, 669, 670, 672, 674, 675, 676, 724, 737, 746)) %>% # Estos serían los individuos que pertenecen a las variedades mejoradas.
  select(value, id) %>%
  inner_join(y = Pob_IND_2, by = 'id')  %>%
  mutate(Subpoblación = '0') %>%
  rename(
    'Fenotipo_predicho' = value,
    'Fenotipo_observado' = Fen_escalado
    )

# 4. Se unen todos los datos anteriores de las distintas subpoblaciones de individuos. genotipados en un solo conjunto de datos

Pred_IND_d <- bind_rows(Pred_IND_13, Pred_IND_14, Pred_IND_15, Pred_IND_16) %>%
  arrange(id) %>%
  relocate(
    Variety,
    .after = id
  ) %>%
  relocate(
    Fenotipo_predicho,
    .after = Fenotipo_observado
  ) %>%
  mutate(Pedigrí = '1')

#######################################################
# Gráfico de dispersión de los resultados del pedigrí 4
#######################################################

Graf_disp_IND <- function(Subpoblación) {
  Pred_IND_d %>%
    filter(.data$Subpoblación == .env$Subpoblación) %>%
    ggplot() +
    aes(x = Fenotipo_observado, y = Fenotipo_predicho) +
    geom_point(size = 4.4, colour = 'cyan', alpha = 0.6) +
    geom_smooth(color = 'cyan', fill = 'cyan', method = 'lm', se = TRUE) +
    stat_cor(p.accuracy = 0.001, colour = 'gray34', label.x = -1.5, label.y = -1.5) +
    geom_rug(colour = 'gray') +
    scale_x_continuous(labels = label_number(accuracy = 0.01)) +
    scale_y_continuous(labels = label_number(accuracy = 0.01)) +
    ggtitle(glue('Individuos genotipados: {Subpoblación}')) +
    labs(x = 'Fenotipo observado', y = 'Fenotipo predicho') +
    theme_bw() +
    theme(
      axis.text = element_text(size = 14),
      axis.title = element_text(size = 15, face = 'bold'),
      plot.title = element_text(size = 11, face = 'bold'),
      legend.position = 'none'
      )
  }

Subpoblación <- c('0', '148', '298', '451')
Graf <- map(Subpoblación, Graf_disp_IND)
(Graf[[1]] | Graf[[2]] | Graf[[3]] | Graf[[4]]) +
  plot_annotation(title = 'Pedigrí uno')

##############################################################
# (co)varianza y heredabilidad de los resultados del pedigrí 3
##############################################################

summary(mod_IND_4) # Aquí se oberva el resultado resumido del modelo, donde la varianza aditiva es igual a 0.4882 y la varianza ambiental es de 0.1131.

cv_mod_IND_4 <- VarCorr(mod_IND_4)
comp_varianza_4 <- as.data.frame(cv_mod_IND_4)$vcov
h2_4 <- comp_varianza_4[1] / sum(comp_varianza_4[1:2]) # La heredabilidad fue igual a 0.81.

#### Población de arroz IND (1.000 SNPs) ----

#########################################################
# Pedigrí 1: 2000 individuos simulados en 10 generaciones
#########################################################

# 2. Se importa el archivo .fam obtenido usando plink y que posteriomente se uso para crear la hoja de parámetros para ejecutar el software molcoanc.

famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'nSNPs_IND.fam')) %>% 
  select(fam) %>%
  mutate(id = 2001:2451) %>%
  rename(Variety = fam)

# 3. Se crea un conjunto de datos que contiene solo los individuos mejorados.

Pob_mej <- lin_mej %>%
  filter(Status_with_Pedigree.plus.knowledge == 'I') %>% # Conjunto de datos solo con los individuos mejorados (los que se clasificaron como "I").
  select(X3K_DNA_IRIS_UNIQUE_ID) %>%
  rename(Variety = X3K_DNA_IRIS_UNIQUE_ID)

escalado <- function(x) { # Función usada para escalar el fenotipo.
  (x - mean(x, na.rm = TRUE)) / sd(x, na.rm = TRUE)
  }

Pob_IND <- Fenotipos %>%
  filter(SNPsubsp == 'IND') %>% # Conjunto de datos solo con la especie IND.
  mutate(
    Variety_2 = Variety,
    Fen_escalado = escalado(Time.to.flowering..from.sowing)
    ) %>%
  separate(
    col = Variety,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  ' '
  ) %>%
  unite(
    col = Variety,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  separate(
    col = Variety,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  '-'
  ) %>%
  unite(
    col = Variety,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  separate(
    col = Variety_2,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  ' '
  ) %>%
  unite(
    col = Variety_2,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  inner_join(y = Pob_mej, by = 'Variety') %>%
  select(Variety_2, Fen_escalado) %>% # Se creo el conjunto de datos con los individuos mejorados de la población indica.
  rename(Variety = Variety_2)

Pob_IND_2 <- Pob_IND %>%
  left_join(y = famsnps_IND, by = 'Variety') # Se unen al conjunto de datos famsnps_IND debido a que aquí esta la identificación numérica como esta en el pedigrí.

## 1. Subpoblación con 148 individuos genotipados

load(here('Datos', 'Datos_IND', 'Den_1.000', 'mod_lme4GS', 'Ped_1', 'mod_lme4GS_1', 'mod_lme4GS_1.RData'))

blup_IND_1 <- ranefUvcovNew(mod_IND_1, Uvcov = list(id = list(K = mH_IND_1)))
blup_IND_1 <- blup_IND_1$id[, 1] # Con la función ranefUvcovNew() obtengo el blup para los niveles de efectos aleatorios (aquí los individuos) con la matriz de varianza-covarianza especificada (la matriz H).

Pred_IND_1 <- fixef(mod_IND_1)[1] + blup_IND_1 # De esta forma obtengo los fenotipos predichos para los individuos con valores NA (aquí 2082 individuos).

Pob_IND_NA <- Pob_IND_5 %>% # Aquí, de la población total en Pob_IND_5 del pedigrí 1, me quedo solo con los 2082 individuos con valores NA. 
  filter(is.na(Fen_escalado))

Pred_IND_1 <- Pred_IND_1 %>% # Del vector anterior de fenotipos predichos, sol me quedo con los que pertenecen a las variedades mejoradas.
  as_tibble() %>%
  bind_cols(Pob_IND_NA) %>%
  filter(id %in% c(2001, 2005, 2013, 2014, 2016, 2017, 2018, 2019, 2020, 2021, 2022, 2023, 2030, 2062, 2076, 2101, 2116, 2127, 2128, 2129, 2130, 2133, 2134, 2135, 2137, 2170, 2179, 2180, 2202, 2210, 2249, 2263, 2264, 2281, 2308, 2327, 2328, 2365, 2368, 2369, 2370, 2372, 2374, 2375, 2376, 2424, 2437, 2446)) %>% # Estos serían los individuos que pertenecen a las variedades mejoradas.
  select(value, id) %>%
  inner_join(y = Pob_IND_2, by = 'id')  %>%
  mutate(Subpoblación = '148') %>%
  rename(
    'Fenotipo_predicho' = value,
    'Fenotipo_observado' = Fen_escalado
    )

## 2. Subpoblación con 298 individuos genotipados

load(here('Datos', 'Datos_IND', 'Den_1.000', 'mod_lme4GS', 'Ped_1', 'mod_lme4GS_2', 'mod_lme4GS_2.RData'))

blup_IND_2 <- ranefUvcovNew(mod_IND_2, Uvcov = list(id = list(K = mH_IND_2)))
blup_IND_2 <- blup_IND_2$id[, 1]

Pred_IND_2 <- fixef(mod_IND_2)[1] + blup_IND_2

Pob_IND_NA <- Pob_IND_5 %>% 
  filter(is.na(Fen_escalado))

Pred_IND_2 <- Pred_IND_2 %>%
  as_tibble() %>%
  bind_cols(Pob_IND_NA) %>%
  filter(id %in% c(2001, 2005, 2013, 2014, 2016, 2017, 2018, 2019, 2020, 2021, 2022, 2023, 2030, 2062, 2076, 2101, 2116, 2127, 2128, 2129, 2130, 2133, 2134, 2135, 2137, 2170, 2179, 2180, 2202, 2210, 2249, 2263, 2264, 2281, 2308, 2327, 2328, 2365, 2368, 2369, 2370, 2372, 2374, 2375, 2376, 2424, 2437, 2446)) %>% # Estos serían los individuos que pertenecen a las variedades mejoradas.
  select(value, id) %>%
  inner_join(y = Pob_IND_2, by = 'id')  %>%
  mutate(Subpoblación = '298') %>%
  rename(
    'Fenotipo_predicho' = value,
    'Fenotipo_observado' = Fen_escalado
    )

## 3. Subpoblación con 451 individuos genotipados

load(here('Datos', 'Datos_IND', 'Den_1.000', 'mod_lme4GS', 'Ped_1', 'mod_lme4GS_3', 'mod_lme4GS_3.RData'))

blup_IND_3 <- ranefUvcovNew(mod_IND_3, Uvcov = list(id = list(K = mH_IND_3)))
blup_IND_3 <- blup_IND_3$id[, 1]

Pred_IND_3 <- fixef(mod_IND_3)[1] + blup_IND_3

Pob_IND_NA <- Pob_IND_5 %>% 
  filter(is.na(Fen_escalado))

Pred_IND_3 <- Pred_IND_3 %>%
  as_tibble() %>%
  bind_cols(Pob_IND_NA) %>%
  filter(id %in% c(2001, 2005, 2013, 2014, 2016, 2017, 2018, 2019, 2020, 2021, 2022, 2023, 2030, 2062, 2076, 2101, 2116, 2127, 2128, 2129, 2130, 2133, 2134, 2135, 2137, 2170, 2179, 2180, 2202, 2210, 2249, 2263, 2264, 2281, 2308, 2327, 2328, 2365, 2368, 2369, 2370, 2372, 2374, 2375, 2376, 2424, 2437, 2446)) %>% # Estos serían los individuos que pertenecen a las variedades mejoradas.
  select(value, id) %>%
  inner_join(y = Pob_IND_2, by = 'id')  %>%
  mutate(Subpoblación = '451') %>%
  rename(
    'Fenotipo_predicho' = value,
    'Fenotipo_observado' = Fen_escalado
    )

## 4. Subpoblación con ningún individuo genotipado

load(here('Datos', 'Datos_IND', 'Den_1.000', 'mod_lme4GS', 'Ped_1', 'mod_lme4GS_4', 'mod_lme4GS_4.RData'))

blup_IND_4 <- ranefUvcovNew(mod_IND_4, Uvcov = list(id = list(K = mA_IND)))
blup_IND_4 <- blup_IND_4$id[, 1]

Pred_IND_4 <- fixef(mod_IND_4)[1] + blup_IND_4

Pob_IND_NA <- Pob_IND_5 %>% 
  filter(is.na(Fen_escalado))

Pred_IND_4 <- Pred_IND_4 %>%
  as_tibble() %>%
  bind_cols(Pob_IND_NA) %>%
  filter(id %in% c(2001, 2005, 2013, 2014, 2016, 2017, 2018, 2019, 2020, 2021, 2022, 2023, 2030, 2062, 2076, 2101, 2116, 2127, 2128, 2129, 2130, 2133, 2134, 2135, 2137, 2170, 2179, 2180, 2202, 2210, 2249, 2263, 2264, 2281, 2308, 2327, 2328, 2365, 2368, 2369, 2370, 2372, 2374, 2375, 2376, 2424, 2437, 2446)) %>% # Estos serían los individuos que pertenecen a las variedades mejoradas.
  select(value, id) %>%
  inner_join(y = Pob_IND_2, by = 'id')  %>%
  mutate(Subpoblación = '0') %>%
  rename(
    'Fenotipo_predicho' = value,
    'Fenotipo_observado' = Fen_escalado
    )

# 4. Se unen todos los datos anteriores de las distintas subpoblaciones de individuos genotipados en un solo conjunto de datos.

Pred_IND_a <- bind_rows(Pred_IND_1, Pred_IND_2, Pred_IND_3, Pred_IND_4) %>%
  arrange(id) %>%
  relocate(
    Variety,
    .after = id
    ) %>%
  relocate(
    Fenotipo_predicho,
    .after = Fenotipo_observado
    ) %>%
  mutate(Pedigrí = '5')

#######################################################
# Gráfico de dispersión de los resultados del pedigrí 1
#######################################################

Graf_disp_IND <- function(Subpoblación) {
  Pred_IND_a %>%
    filter(.data$Subpoblación == .env$Subpoblación) %>%
    ggplot() +
    aes(x = Fenotipo_observado, y = Fenotipo_predicho) +
    geom_point(size = 4.4, colour = 'red', alpha = 0.6) +
    geom_smooth(color = 'red', fill = 'red', method = 'lm', se = TRUE) +
    stat_cor(p.accuracy = 0.001, colour = 'gray34', label.x = -1.5, label.y = -1.5) +
    geom_rug(colour = 'gray') +
    scale_x_continuous(labels = label_number(accuracy = 0.01)) +
    scale_y_continuous(labels = label_number(accuracy = 0.01)) +
    ggtitle(glue('Individuos genotipados: {Subpoblación}')) +
    labs(x = 'Fenotipo observado', y = 'Fenotipo predicho') +
    theme_bw() +
    theme(
      axis.text = element_text(size = 14),
      axis.title = element_text(size = 15, face = 'bold'),
      plot.title = element_text(size = 11, face = 'bold'),
      legend.position = 'none'
      )
  }

Subpoblación <- c('0', '148', '298', '451')
Graf <- map(Subpoblación, Graf_disp_IND)
(Graf[[1]] | Graf[[2]] | Graf[[3]] | Graf[[4]]) +
  plot_annotation(title = 'Pedigrí tres') # Aquí se coloco pedigrí tres pero en realidad es el pedigrí cinco.

##############################################################
# (co)varianza y heredabilidad de los resultados del pedigrí 3
##############################################################

summary(mod_IND_4) # Aquí se oberva el resultado resumido del modelo, donde la varianza aditiva es igual a 0.5651 y la varianza ambiental es de 0.1695.

cv_mod_IND_4 <- VarCorr(mod_IND_4)
comp_varianza_4 <- as.data.frame(cv_mod_IND_4)$vcov
h2_4 <- comp_varianza_4[1] / sum(comp_varianza_4[1:2]) # La heredabilidad fue igual a 0.73.

########################################################
# Pedigrí 3: 1210 individuos simulados en 7 generaciones
########################################################

# 2. Se importa el archivo .fam obtenido usando plink y que posteriomente se uso para crear la hoja de parámetros para ejecutar el software molcoanc.

famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'nSNPs_IND.fam')) %>% 
  select(fam) %>%
  mutate(id = 1211:1661) %>%
  rename(Variety = fam)

# 3. Se crea un conjunto de datos que contiene solo los individuos mejorados.

Pob_mej <- lin_mej %>%
  filter(Status_with_Pedigree.plus.knowledge == 'I') %>% # Conjunto de datos solo con los individuos mejorados (los que se clasificaron como "I").
  select(X3K_DNA_IRIS_UNIQUE_ID) %>%
  rename(Variety = X3K_DNA_IRIS_UNIQUE_ID)

escalado <- function(x) { # Función usada para escalar el fenotipo.
  (x - mean(x, na.rm = TRUE)) / sd(x, na.rm = TRUE)
  }

Pob_IND <- Fenotipos %>%
  filter(SNPsubsp == 'IND') %>% # Conjunto de datos solo con la especie IND.
  mutate(
    Variety_2 = Variety,
    Fen_escalado = escalado(Time.to.flowering..from.sowing)
    ) %>%
  separate(
    col = Variety,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  ' '
  ) %>%
  unite(
    col = Variety,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  separate(
    col = Variety,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  '-'
  ) %>%
  unite(
    col = Variety,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  separate(
    col = Variety_2,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  ' '
  ) %>%
  unite(
    col = Variety_2,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  inner_join(y = Pob_mej, by = 'Variety') %>%
  select(Variety_2, Fen_escalado) %>% # Se creo el conjunto de datos con los individuos mejorados de la población indica.
  rename(Variety = Variety_2)

Pob_IND_2 <- Pob_IND %>%
  left_join(y = famsnps_IND, by = 'Variety') # Se unen al conjunto de datos famsnps_IND debido a que aquí esta la identificación numérica como esta en el pedigrí.

## 1. Subpoblación con 148 individuos genotipados

load(here('Datos', 'Datos_IND', 'Den_1.000', 'mod_lme4GS', 'Ped_3', 'mod_lme4GS_1', 'mod_lme4GS_1.RData'))

blup_IND_1 <- ranefUvcovNew(mod_IND_1, Uvcov = list(id = list(K = mH_IND_1)))
blup_IND_1 <- blup_IND_1$id[, 1] # Con la función ranefUvcovNew() obtengo el blup para los niveles de efectos aleatorios (aquí los individuos) con la matriz de varianza-covarianza especificada (la matriz H).

Pred_IND_9 <- fixef(mod_IND_1)[1] + blup_IND_1 # De esta forma obtengo los fenotipos predichos para los individuos con valores NA (aquí 2082 individuos).

Pob_IND_NA <- Pob_IND_5 %>% # Aquí, de la población total de Pob_IND_5 del pedigrí 3, me quedo solo con los 1292 individuos con valores NA. 
  filter(is.na(Fen_escalado))

Pred_IND_9 <- Pred_IND_9 %>% # Del vector anterior de fenotipos predichos, solo me quedo con los que pertenecen a las variedades mejoradas.
  as_tibble() %>%
  bind_cols(Pob_IND_NA) %>%
  filter(id %in% c(1211, 1215, 1223, 1224, 1226, 1227, 1228, 1229, 1230, 1231, 1232, 1233, 1240, 1272, 1286, 1311, 1326, 1337, 1338, 1339, 1340, 1343, 1344, 1345, 1347, 1380, 1389, 1390, 1412, 1420, 1459, 1473, 1474, 1491, 1518, 1537, 1538, 1575, 1578, 1579, 1580, 1582, 1584, 1585, 1586, 1634, 1647, 1656)) %>% # Estos serían los individuos que pertenecen a las variedades mejoradas.
  select(value, id) %>%
  inner_join(y = Pob_IND_2, by = 'id')  %>%
  mutate(Subpoblación = '148') %>%
  rename(
    'Fenotipo_predicho' = value,
    'Fenotipo_observado' = Fen_escalado
    )

## 2. Subpoblación con 298 individuos genotipados

load(here('Datos', 'Datos_IND', 'Den_1.000', 'mod_lme4GS', 'Ped_3', 'mod_lme4GS_2', 'mod_lme4GS_2.RData'))

blup_IND_2 <- ranefUvcovNew(mod_IND_2, Uvcov = list(id = list(K = mH_IND_2)))
blup_IND_2 <- blup_IND_2$id[, 1]

Pred_IND_10 <- fixef(mod_IND_2)[1] + blup_IND_2

Pob_IND_NA <- Pob_IND_5 %>% 
  filter(is.na(Fen_escalado))

Pred_IND_10 <- Pred_IND_10 %>%
  as_tibble() %>%
  bind_cols(Pob_IND_NA) %>%
  filter(id %in% c(1211, 1215, 1223, 1224, 1226, 1227, 1228, 1229, 1230, 1231, 1232, 1233, 1240, 1272, 1286, 1311, 1326, 1337, 1338, 1339, 1340, 1343, 1344, 1345, 1347, 1380, 1389, 1390, 1412, 1420, 1459, 1473, 1474, 1491, 1518, 1537, 1538, 1575, 1578, 1579, 1580, 1582, 1584, 1585, 1586, 1634, 1647, 1656)) %>% # Estos serían los individuos que pertenecen a las variedades mejoradas.
  select(value, id) %>%
  inner_join(y = Pob_IND_2, by = 'id')  %>%
  mutate(Subpoblación = '298') %>%
  rename(
    'Fenotipo_predicho' = value,
    'Fenotipo_observado' = Fen_escalado
    )

## 3. Subpoblación con 451 individuos genotipados

load(here('Datos', 'Datos_IND', 'Den_1.000', 'mod_lme4GS', 'Ped_3', 'mod_lme4GS_3', 'mod_lme4GS_3.RData'))

blup_IND_3 <- ranefUvcovNew(mod_IND_3, Uvcov = list(id = list(K = mH_IND_3)))
blup_IND_3 <- blup_IND_3$id[, 1]

Pred_IND_11 <- fixef(mod_IND_3)[1] + blup_IND_3

Pob_IND_NA <- Pob_IND_5 %>% 
  filter(is.na(Fen_escalado))

Pred_IND_11 <- Pred_IND_11 %>%
  as_tibble() %>%
  bind_cols(Pob_IND_NA) %>%
  filter(id %in% c(1211, 1215, 1223, 1224, 1226, 1227, 1228, 1229, 1230, 1231, 1232, 1233, 1240, 1272, 1286, 1311, 1326, 1337, 1338, 1339, 1340, 1343, 1344, 1345, 1347, 1380, 1389, 1390, 1412, 1420, 1459, 1473, 1474, 1491, 1518, 1537, 1538, 1575, 1578, 1579, 1580, 1582, 1584, 1585, 1586, 1634, 1647, 1656)) %>% # Estos serían los individuos que pertenecen a las variedades mejoradas.
  select(value, id) %>%
  inner_join(y = Pob_IND_2, by = 'id')  %>%
  mutate(Subpoblación = '451') %>%
  rename(
    'Fenotipo_predicho' = value,
    'Fenotipo_observado' = Fen_escalado
    )

## 4. Subpoblación con ningún individuo genotipado

load(here('Datos', 'Datos_IND', 'Den_1.000', 'mod_lme4GS', 'Ped_3', 'mod_lme4GS_4', 'mod_lme4GS_4.RData'))

blup_IND_4 <- ranefUvcovNew(mod_IND_4, Uvcov = list(id = list(K = mA_IND)))
blup_IND_4 <- blup_IND_4$id[, 1]

Pred_IND_12 <- fixef(mod_IND_4)[1] + blup_IND_4

Pob_IND_NA <- Pob_IND_5 %>% 
  filter(is.na(Fen_escalado))

Pred_IND_12 <- Pred_IND_12 %>%
  as_tibble() %>%
  bind_cols(Pob_IND_NA) %>%
  filter(id %in% c(1211, 1215, 1223, 1224, 1226, 1227, 1228, 1229, 1230, 1231, 1232, 1233, 1240, 1272, 1286, 1311, 1326, 1337, 1338, 1339, 1340, 1343, 1344, 1345, 1347, 1380, 1389, 1390, 1412, 1420, 1459, 1473, 1474, 1491, 1518, 1537, 1538, 1575, 1578, 1579, 1580, 1582, 1584, 1585, 1586, 1634, 1647, 1656)) %>% # Estos serían los individuos que pertenecen a las variedades mejoradas.
  select(value, id) %>%
  inner_join(y = Pob_IND_2, by = 'id')  %>%
  mutate(Subpoblación = '0') %>%
  rename(
    'Fenotipo_predicho' = value,
    'Fenotipo_observado' = Fen_escalado
    )

# 4. Se unen todos los datos anteriores de las distintas subpoblaciones de individuos. genotipados en un solo conjunto de datos

Pred_IND_c <- bind_rows(Pred_IND_9, Pred_IND_10, Pred_IND_11, Pred_IND_12) %>%
  arrange(id) %>%
  relocate(
    Variety,
    .after = id
  ) %>%
  relocate(
    Fenotipo_predicho,
    .after = Fenotipo_observado
  ) %>%
  mutate(Pedigrí = '3')

#######################################################
# Gráfico de dispersión de los resultados del pedigrí 3
#######################################################

Graf_disp_IND <- function(Subpoblación) {
  Pred_IND_c %>%
    filter(.data$Subpoblación == .env$Subpoblación) %>%
    ggplot() +
    aes(x = Fenotipo_observado, y = Fenotipo_predicho) +
    geom_point(size = 4.4, colour = 'red', alpha = 0.6) +
    geom_smooth(color = 'red', fill = 'red', method = 'lm', se = TRUE) +
    stat_cor(p.accuracy = 0.001, colour = 'gray34', label.x = -1.5, label.y = -1.5) +
    geom_rug(colour = 'gray') +
    scale_x_continuous(labels = label_number(accuracy = 0.01)) +
    scale_y_continuous(labels = label_number(accuracy = 0.01)) +
    ggtitle(glue('Individuos genotipados: {Subpoblación}')) +
    labs(x = 'Fenotipo observado', y = 'Fenotipo predicho') +
    theme_bw() +
    theme(
      axis.text = element_text(size = 14),
      axis.title = element_text(size = 15, face = 'bold'),
      plot.title = element_text(size = 11, face = 'bold'),
      legend.position = 'none'
      )
  }

Subpoblación <- c('0', '148', '298', '451')
Graf <- map(Subpoblación, Graf_disp_IND)
(Graf[[1]] | Graf[[2]] | Graf[[3]] | Graf[[4]]) +
  plot_annotation(title = 'Pedigrí dos') # Aquí se coloco pedigrí dos pero en realidad es el pedigrí tres.

##############################################################
# (co)varianza y heredabilidad de los resultados del pedigrí 3
##############################################################

summary(mod_IND_4) # Aquí se oberva el resultado resumido del modelo, donde la varianza aditiva es igual a 0.4569 y la varianza ambiental es de 0.1695.

cv_mod_IND_4 <- VarCorr(mod_IND_4)
comp_varianza_4 <- as.data.frame(cv_mod_IND_4)$vcov
h2_4 <- comp_varianza_4[1] / sum(comp_varianza_4[1:2]) # La heredabilidad fue igual a 0.73.

#######################################################
# Pedigrí 4: 300 individuos simulados en 3 generaciones
#######################################################

# 2. Se importa el archivo .fam obtenido usando plink y que posteriomente se uso para crear la hoja de parámetros para ejecutar el software molcoanc.

famsnps_IND <- read_fam(here('Datos', 'Datos_IND', 'Soft_Molcoanc', 'nSNPs_IND.fam')) %>% 
  select(fam) %>%
  mutate(id = 301:751) %>%
  rename(Variety = fam)

# 3. Se crea un conjunto de datos que contiene solo los individuos mejorados.

Pob_mej <- lin_mej %>%
  filter(Status_with_Pedigree.plus.knowledge == 'I') %>% # Conjunto de datos solo con los individuos mejorados (los que se clasificaron como "I").
  select(X3K_DNA_IRIS_UNIQUE_ID) %>%
  rename(Variety = X3K_DNA_IRIS_UNIQUE_ID)

escalado <- function(x) { # Función usada para escalar el fenotipo.
  (x - mean(x, na.rm = TRUE)) / sd(x, na.rm = TRUE)
  }

Pob_IND <- Fenotipos %>%
  filter(SNPsubsp == 'IND') %>% # Conjunto de datos solo con la especie IND.
  mutate(
    Variety_2 = Variety,
    Fen_escalado = escalado(Time.to.flowering..from.sowing)
    ) %>%
  separate(
    col = Variety,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  ' '
  ) %>%
  unite(
    col = Variety,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  separate(
    col = Variety,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  '-'
  ) %>%
  unite(
    col = Variety,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  separate(
    col = Variety_2,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  ' '
  ) %>%
  unite(
    col = Variety_2,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  inner_join(y = Pob_mej, by = 'Variety') %>%
  select(Variety_2, Fen_escalado) %>% # Se creo el conjunto de datos con los individuos mejorados de la población indica.
  rename(Variety = Variety_2)

Pob_IND_2 <- Pob_IND %>%
  left_join(y = famsnps_IND, by = 'Variety') # Se unen al conjunto de datos famsnps_IND debido a que aquí esta la identificación numérica como esta en el pedigrí.

## 1. Subpoblación con 148 individuos genotipados

load(here('Datos', 'Datos_IND', 'Den_1.000', 'mod_lme4GS', 'Ped_4', 'mod_lme4GS_1', 'mod_lme4GS_1.RData'))

blup_IND_1 <- ranefUvcovNew(mod_IND_1, Uvcov = list(id = list(K = mH_IND_1)))
blup_IND_1 <- blup_IND_1$id[, 1] # Con la función ranefUvcovNew() obtengo el blup para los niveles de efectos aleatorios (aquí los individuos) con la matriz de varianza-covarianza especificada (la matriz H).

Pred_IND_13 <- fixef(mod_IND_1)[1] + blup_IND_1 # De esta forma obtengo los fenotipos predichos para los individuos con valores NA (aquí 382 individuos).

Pob_IND_NA <- Pob_IND_5 %>% # Aquí, de la población total de Pob_IND_5 del pedigrí 4, me quedo solo con los 382 individuos con valores NA. 
  filter(is.na(Fen_escalado))

Pred_IND_13 <- Pred_IND_13 %>% # Del vector anterior de fenotipos predichos, solo me quedo con los que pertenecen a las variedades mejoradas.
  as_tibble() %>%
  bind_cols(Pob_IND_NA) %>%
  filter(id %in% c(301, 305, 313, 314, 316, 317, 318, 319, 320, 321, 322, 323, 330, 362, 376, 401, 416, 427, 428, 429, 430, 433, 434, 435, 437, 470, 479, 480, 502, 510, 549, 563, 564, 581, 608, 627, 628, 665, 668, 669, 670, 672, 674, 675, 676, 724, 737, 746)) %>% # Estos serían los individuos que pertenecen a las variedades mejoradas.
  select(value, id) %>%
  inner_join(y = Pob_IND_2, by = 'id')  %>%
  mutate(Subpoblación = '148') %>%
  rename(
    'Fenotipo_predicho' = value,
    'Fenotipo_observado' = Fen_escalado
    )

## 2. Subpoblación con 298 individuos genotipados

load(here('Datos', 'Datos_IND', 'Den_1.000', 'mod_lme4GS', 'Ped_4', 'mod_lme4GS_2', 'mod_lme4GS_2.RData'))

blup_IND_2 <- ranefUvcovNew(mod_IND_2, Uvcov = list(id = list(K = mH_IND_2)))
blup_IND_2 <- blup_IND_2$id[, 1]

Pred_IND_14 <- fixef(mod_IND_2)[1] + blup_IND_2

Pob_IND_NA <- Pob_IND_5 %>% 
  filter(is.na(Fen_escalado))

Pred_IND_14 <- Pred_IND_14 %>%
  as_tibble() %>%
  bind_cols(Pob_IND_NA) %>%
  filter(id %in% c(301, 305, 313, 314, 316, 317, 318, 319, 320, 321, 322, 323, 330, 362, 376, 401, 416, 427, 428, 429, 430, 433, 434, 435, 437, 470, 479, 480, 502, 510, 549, 563, 564, 581, 608, 627, 628, 665, 668, 669, 670, 672, 674, 675, 676, 724, 737, 746)) %>% # Estos serían los individuos que pertenecen a las variedades mejoradas.
  select(value, id) %>%
  inner_join(y = Pob_IND_2, by = 'id')  %>%
  mutate(Subpoblación = '298') %>%
  rename(
    'Fenotipo_predicho' = value,
    'Fenotipo_observado' = Fen_escalado
    )

## 3. Subpoblación con 451 individuos genotipados

load(here('Datos', 'Datos_IND', 'Den_1.000', 'mod_lme4GS', 'Ped_4', 'mod_lme4GS_3', 'mod_lme4GS_3.RData'))

blup_IND_3 <- ranefUvcovNew(mod_IND_3, Uvcov = list(id = list(K = mH_IND_3)))
blup_IND_3 <- blup_IND_3$id[, 1]

Pred_IND_15 <- fixef(mod_IND_3)[1] + blup_IND_3

Pob_IND_NA <- Pob_IND_5 %>% 
  filter(is.na(Fen_escalado))

Pred_IND_15 <- Pred_IND_15 %>%
  as_tibble() %>%
  bind_cols(Pob_IND_NA) %>%
  filter(id %in% c(301, 305, 313, 314, 316, 317, 318, 319, 320, 321, 322, 323, 330, 362, 376, 401, 416, 427, 428, 429, 430, 433, 434, 435, 437, 470, 479, 480, 502, 510, 549, 563, 564, 581, 608, 627, 628, 665, 668, 669, 670, 672, 674, 675, 676, 724, 737, 746)) %>% # Estos serían los individuos que pertenecen a las variedades mejoradas.
  select(value, id) %>%
  inner_join(y = Pob_IND_2, by = 'id')  %>%
  mutate(Subpoblación = '451') %>%
  rename(
    'Fenotipo_predicho' = value,
    'Fenotipo_observado' = Fen_escalado
    )

## 4. Subpoblación con ningún individuo genotipado

load(here('Datos', 'Datos_IND', 'Den_1.000', 'mod_lme4GS', 'Ped_4', 'mod_lme4GS_4', 'mod_lme4GS_4.RData'))

blup_IND_4 <- ranefUvcovNew(mod_IND_4, Uvcov = list(id = list(K = mA_IND)))
blup_IND_4 <- blup_IND_4$id[, 1]

Pred_IND_16 <- fixef(mod_IND_4)[1] + blup_IND_4

Pob_IND_NA <- Pob_IND_5 %>% 
  filter(is.na(Fen_escalado))

Pred_IND_16 <- Pred_IND_16 %>%
  as_tibble() %>%
  bind_cols(Pob_IND_NA) %>%
  filter(id %in% c(301, 305, 313, 314, 316, 317, 318, 319, 320, 321, 322, 323, 330, 362, 376, 401, 416, 427, 428, 429, 430, 433, 434, 435, 437, 470, 479, 480, 502, 510, 549, 563, 564, 581, 608, 627, 628, 665, 668, 669, 670, 672, 674, 675, 676, 724, 737, 746)) %>% # Estos serían los individuos que pertenecen a las variedades mejoradas.
  select(value, id) %>%
  inner_join(y = Pob_IND_2, by = 'id')  %>%
  mutate(Subpoblación = '0') %>%
  rename(
    'Fenotipo_predicho' = value,
    'Fenotipo_observado' = Fen_escalado
    )

# 4. Se unen todos los datos anteriores de las distintas subpoblaciones de individuos. genotipados en un solo conjunto de datos

Pred_IND_d <- bind_rows(Pred_IND_13, Pred_IND_14, Pred_IND_15, Pred_IND_16) %>%
  arrange(id) %>%
  relocate(
    Variety,
    .after = id
  ) %>%
  relocate(
    Fenotipo_predicho,
    .after = Fenotipo_observado
  ) %>%
  mutate(Pedigrí = '1')

#######################################################
# Gráfico de dispersión de los resultados del pedigrí 4
#######################################################

Graf_disp_IND <- function(Subpoblación) {
  Pred_IND_d %>%
    filter(.data$Subpoblación == .env$Subpoblación) %>%
    ggplot() +
    aes(x = Fenotipo_observado, y = Fenotipo_predicho) +
    geom_point(size = 4.4, colour = 'red', alpha = 0.6) +
    geom_smooth(color = 'red', fill = 'red', method = 'lm', se = TRUE) +
    stat_cor(p.accuracy = 0.001, colour = 'gray34', label.x = -1.5, label.y = -1.5) +
    geom_rug(colour = 'gray') +
    scale_x_continuous(labels = label_number(accuracy = 0.01)) +
    scale_y_continuous(labels = label_number(accuracy = 0.01)) +
    ggtitle(glue('Individuos genotipados: {Subpoblación}')) +
    labs(x = 'Fenotipo observado', y = 'Fenotipo predicho') +
    theme_bw() +
    theme(
      axis.text = element_text(size = 14),
      axis.title = element_text(size = 15, face = 'bold'),
      plot.title = element_text(size = 11, face = 'bold'),
      legend.position = 'none'
      )
  }

Subpoblación <- c('0', '148', '298', '451')
Graf <- map(Subpoblación, Graf_disp_IND)
(Graf[[1]] | Graf[[2]] | Graf[[3]] | Graf[[4]]) +
  plot_annotation(title = 'Pedigrí uno')

##############################################################
# (co)varianza y heredabilidad de los resultados del pedigrí 3
##############################################################

summary(mod_IND_4) # Aquí se oberva el resultado resumido del modelo, donde la varianza aditiva es igual a 0.4882 y la varianza ambiental es de 0.1131.

cv_mod_IND_4 <- VarCorr(mod_IND_4)
comp_varianza_4 <- as.data.frame(cv_mod_IND_4)$vcov
h2_4 <- comp_varianza_4[1] / sum(comp_varianza_4[1:2]) # La heredabilidad fue igual a 0.82.

#### Resultado total de los métodos RKHS y reml ----

Resultados_corr <- tribble(
  ~'Pedigrí', ~'0', ~'148', ~'298', ~'451', ~'Densidad', ~'Método',
  '1', NA, 0.54, 0.53, 0.58, '100.000', 'RKHS',
  '1', NA, 0.53, 0.52, 0.58, '100.000', 'reml',
  '1', NA, 0.54, 0.52, 0.58, '10.000', 'RKHS',
  '1', NA, 0.53, 0.51, 0.58, '10.000', 'reml',
  '1', NA, 0.52, 0.43, 0.49, '1.000', 'RKHS',
  '1', NA, 0.51, 0.42, 0.50, '1.000', 'reml',
  '2', NA, 0.55, 0.55, 0.58, '100.000', 'RKHS',
  '2', NA, 0.55, 0.55, 0.58, '100.000', 'reml',
  '2', NA, 0.55, 0.53, 0.58, '10.000', 'RKHS',
  '2', NA, 0.55, 0.54, 0.58, '10.000', 'reml',
  '2', NA, 0.55, 0.46, 0.49, '1.000', 'RKHS',
  '2', NA, 0.54, 0.46, 0.50, '1.000', 'reml',
  '3', NA, 0.47, 0.52, 0.58, '100.000', 'RKHS',
  '3', NA, 0.47, 0.53, 0.58, '100.000', 'reml',
  '3', NA, 0.46, 0.52, 0.58, '10.000', 'RKHS',
  '3', NA, 0.46, 0.51, 0.58, '10.000', 'reml',
  '3', NA, 0.46, 0.44, 0.49, '1.000', 'RKHS',
  '3', NA, 0.46, 0.44, 0.50, '1.000', 'reml',
  '1', 0.54, NA, NA, NA, '0', 'RKHS',
  '1', 0.54, NA, NA, NA, '0', 'reml',
  '2', 0.53, NA, NA, NA, '0', 'RKHS',
  '2', 0.53, NA, NA, NA, '0', 'reml',
  '3', 0.54, NA, NA, NA, '0', 'RKHS',
  '3', 0.54, NA, NA, NA, '0', 'reml'
  ) %>%
  pivot_longer(
    cols = c('0', '148', '298', '451'),
    names_to = 'Individuos genotipados',
    values_to = 'Precisión'
  ) %>%
  na.omit()

Resultado_1 <- Resultados_corr %>% # Resultados con el pedigrí 3, con 451 y 0 individuos genotipados, con los dos métodos, y distintas densidades de SNP.
  filter(Pedigrí == 3) %>%
  arrange('Individuos genotipados') %>%
  slice(3, 6, 9, 12, 15, 18, 19, 20) %>%
  ggplot(data = ., aes(x = Densidad, y = Precisión, label = Precisión, colour = Método)) +
  geom_point(size = 4.8, alpha = 0.4) +
  scale_color_manual(values = c('yellow', 'cyan')) +
  scale_fill_manual(values = c('yellow', 'cyan')) +
  scale_y_continuous(limits = c(0.25, 0.75)) +
  facet_wrap(~ Método) +
  labs(x = 'Densidad del marcador', y = 'Precisión de la predicción (r)', title = 'Pedigrí tres y 451 individuos genotipados.') +
  theme_bw() +
  theme(
    legend.position = 'none',
    axis.text.y = element_text(face = 'bold', size = 14),
    axis.text.x = element_text(face = 'bold', size = 10),
    axis.title = element_text(face = 'bold', size = 15),
    plot.title = element_text(size = 12.4, face = 'bold'),
    strip.background = element_rect(colour = 'black', fill = 'white'),
    strip.text = element_text(size = 13, colour = 'black', face = 'bold')
    ) +
  geom_label_repel(
    size = 5.4,
    colour = 'black',
    box.padding = 0.7,
    direction = 'y', vjust = 0.4
    )

Resultado_2 <- Resultados_corr %>% # Resultados con el pedigrí 3, con 298 y 0 individuos genotipados, con los dos métodos, y distintas densidades de SNP.
  filter(Pedigrí == 3) %>%
  arrange('Individuos genotipados') %>%
  slice(2, 5, 8, 11, 14, 17, 19, 20) %>%
  ggplot(data = ., aes(x = Densidad, y = Precisión, label = Precisión, colour = Método)) +
  geom_point(size = 4.8, alpha = 0.4) +
  scale_color_manual(values = c('yellow', 'cyan')) +
  scale_fill_manual(values = c('yellow', 'cyan')) +
  scale_y_continuous(limits = c(0.25, 0.75)) +
  facet_wrap(~ Método) +
  scale_y_continuous(limits = c(0.25, 0.75)) +
  labs(x = 'Densidad del marcador', y = 'Precisión de la predicción (r)', title = 'Pedigrí tres y 298 individuos genotipados.') +
  theme_bw() +
  theme(
    legend.position = 'none',
    axis.text.y = element_text(face = 'bold', size = 14),
    axis.text.x = element_text(face = 'bold', size = 10),
    axis.title = element_text(face = 'bold', size = 15),
    plot.title = element_text(size = 12.4, face = 'bold'),
    strip.background = element_rect(colour = 'black', fill = 'white'),
    strip.text = element_text(size = 13, colour = 'black', face = 'bold')
    ) +
  geom_label_repel(
    size = 5.4,
    colour = 'black',
    box.padding = 0.7,
    direction = 'y', vjust = 0.4
    )

Resultado_3 <- Resultados_corr %>% # Resultados con el pedigrí 3, con 148 y 0 individuos genotipados, con los dos métodos, y distintas densidades de SNP.
  filter(Pedigrí == 3) %>%
  arrange('Individuos genotipados') %>%
  slice(1, 4, 7, 10, 13, 16, 19, 20) %>%
  ggplot(data = ., aes(x = Densidad, y = Precisión, label = Precisión, colour = Método)) +
  geom_point(size = 4.4, alpha = 0.4) +
  scale_color_manual(values = c('yellow', 'cyan')) +
  scale_fill_manual(values = c('yellow', 'cyan')) +
  scale_y_continuous(limits = c(0.25, 0.75)) +
  facet_wrap(~ Método) +
  scale_y_continuous(limits = c(0.25, 0.75)) +
  labs(x = 'Densidad del marcador', y = 'Precisión de la predicción (r)', title = 'Pedigrí tres y 148 individuos genotipados.') +
  theme_bw() +
  theme(
    legend.position = 'none',
    axis.text.y = element_text(face = 'bold', size = 14),
    axis.text.x = element_text(face = 'bold', size = 10),
    axis.title = element_text(face = 'bold', size = 15),
    plot.title = element_text(size = 12.4, face = 'bold'),
    strip.background = element_rect(colour = 'black', fill = 'white'),
    strip.text = element_text(size = 13, colour = 'black', face = 'bold')
    ) +
  geom_label_repel(
    size = 5.4,
    colour = 'black',
    box.padding = 0.7,
    direction = 'y', vjust = 0.4
    )

Resultado_3 | Resultado_2 | Resultado_1

Resultado_4 <- Resultados_corr %>% # Resultados con el pedigrí 2, con 451 y 0 individuos genotipados, con los dos métodos, y distintas densidades de SNP.
  filter(Pedigrí == 2) %>%
  slice(3, 6, 9, 12, 15, 18, 19, 20) %>%
  ggplot(data = ., aes(x = Densidad, y = Precisión, label = Precisión, colour = Método)) +
  geom_point(size = 4.8, alpha = 0.4) +
  scale_color_manual(values = c('yellow', 'cyan')) +
  scale_fill_manual(values = c('yellow', 'cyan')) +
  scale_y_continuous(limits = c(0.25, 0.75)) +
  facet_wrap(~ Método) +
  labs(x = 'Densidad del marcador', y = 'Precisión de la predicción (r)', title = 'Pedigrí dos y 451 individuos genotipados.') +
  theme_bw() +
  theme(
    legend.position = 'none',
    axis.text.y = element_text(face = 'bold', size = 14),
    axis.text.x = element_text(face = 'bold', size = 10),
    axis.title = element_text(face = 'bold', size = 15),
    plot.title = element_text(size = 12.4, face = 'bold'),
    strip.background = element_rect(colour = 'black', fill = 'white'),
    strip.text = element_text(size = 13, colour = 'black', face = 'bold')
    ) +
  geom_label_repel(
    size = 5.4,
    colour = 'black',
    box.padding = 0.7,
    direction = 'y', vjust = 0.4
    )

Resultado_5 <- Resultados_corr %>% # Resultados con el pedigrí 2, con 298 y 0 individuos genotipados, con los dos métodos, y distintas densidades de SNP.
  filter(Pedigrí == 2) %>%
  arrange('Individuos genotipados') %>%
  slice(2, 5, 8, 11, 14, 17, 19, 20) %>%
  ggplot(data = ., aes(x = Densidad, y = Precisión, label = Precisión, colour = Método)) +
  geom_point(size = 4.8, alpha = 0.4) +
  scale_color_manual(values = c('yellow', 'cyan')) +
  scale_fill_manual(values = c('yellow', 'cyan')) +
  scale_y_continuous(limits = c(0.25, 0.75)) +
  facet_wrap(~ Método) +
  scale_y_continuous(limits = c(0.25, 0.75)) +
  labs(x = 'Densidad del marcador', y = 'Precisión de la predicción (r)', title = 'Pedigrí dos y 298 individuos genotipados.') +
  theme_bw() +
  theme(
    legend.position = 'none',
    axis.text.y = element_text(face = 'bold', size = 14),
    axis.text.x = element_text(face = 'bold', size = 10),
    axis.title = element_text(face = 'bold', size = 15),
    plot.title = element_text(size = 12.4, face = 'bold'),
    strip.background = element_rect(colour = 'black', fill = 'white'),
    strip.text = element_text(size = 13, colour = 'black', face = 'bold')
    ) +
  geom_label_repel(
    size = 5.4,
    colour = 'black',
    box.padding = 0.7,
    direction = 'y', vjust = 0.4
    )

Resultado_6 <- Resultados_corr %>% # Resultados con el pedigrí 2, con 148 y 0 individuos genotipados, con los dos métodos, y distintas densidades de SNP.
  filter(Pedigrí == 2) %>%
  arrange('Individuos genotipados') %>%
  slice(1, 4, 7, 10, 13, 16, 19, 20) %>%
  ggplot(data = ., aes(x = Densidad, y = Precisión, label = Precisión, colour = Método)) +
  geom_point(size = 4.4, alpha = 0.4) +
  scale_color_manual(values = c('yellow', 'cyan')) +
  scale_fill_manual(values = c('yellow', 'cyan')) +
  scale_y_continuous(limits = c(0.25, 0.75)) +
  facet_wrap(~ Método) +
  scale_y_continuous(limits = c(0.25, 0.75)) +
  labs(x = 'Densidad del marcador', y = 'Precisión de la predicción (r)', title = 'Pedigrí dos y 148 individuos genotipados.') +
  theme_bw() +
  theme(
    legend.position = 'none',
    axis.text.y = element_text(face = 'bold', size = 14),
    axis.text.x = element_text(face = 'bold', size = 10),
    axis.title = element_text(face = 'bold', size = 15),
    plot.title = element_text(size = 12.4, face = 'bold'),
    strip.background = element_rect(colour = 'black', fill = 'white'),
    strip.text = element_text(size = 13, colour = 'black', face = 'bold')
    ) +
  geom_label_repel(
    size = 5.4,
    colour = 'black',
    box.padding = 0.7,
    direction = 'y', vjust = 0.4
    )

Resultado_6 | Resultado_5 | Resultado_4

Resultado_7 <- Resultados_corr %>% # Resultados con el pedigrí 1, con 451 y 0 individuos genotipados, con los dos métodos, y distintas densidades de SNP.
  filter(Pedigrí == 1) %>%
  arrange('Individuos genotipados') %>%
  slice(3, 6, 9, 12, 15, 18, 19, 20) %>%
  ggplot(data = ., aes(x = Densidad, y = Precisión, label = Precisión, colour = Método)) +
  geom_point(size = 4.8, alpha = 0.4) +
  scale_color_manual(values = c('yellow', 'cyan')) +
  scale_fill_manual(values = c('yellow', 'cyan')) +
  scale_y_continuous(limits = c(0.25, 0.75)) +
  facet_wrap(~ Método) +
  labs(x = 'Densidad del marcador', y = 'Precisión de la predicción (r)', title = 'Pedigrí uno y 451 individuos genotipados.') +
  theme_bw() +
  theme(
    legend.position = 'none',
    axis.text.y = element_text(face = 'bold', size = 14),
    axis.text.x = element_text(face = 'bold', size = 10),
    axis.title = element_text(face = 'bold', size = 15),
    plot.title = element_text(size = 12.4, face = 'bold'),
    strip.background = element_rect(colour = 'black', fill = 'white'),
    strip.text = element_text(size = 13, colour = 'black', face = 'bold')
    ) +
  geom_label_repel(
    size = 5.4,
    colour = 'black',
    box.padding = 0.7,
    direction = 'y', vjust = 0.4
    )

Resultado_8 <- Resultados_corr %>% # Resultados con el pedigrí 1, con 298 y 0 individuos genotipados, con los dos métodos, y distintas densidades de SNP.
  filter(Pedigrí == 1) %>%
  arrange('Individuos genotipados') %>%
  slice(2, 5, 8, 11, 14, 17, 19, 20) %>%
  ggplot(data = ., aes(x = Densidad, y = Precisión, label = Precisión, colour = Método)) +
  geom_point(size = 4.8, alpha = 0.4) +
  scale_color_manual(values = c('yellow', 'cyan')) +
  scale_fill_manual(values = c('yellow', 'cyan')) +
  scale_y_continuous(limits = c(0.25, 0.75)) +
  facet_wrap(~ Método) +
  scale_y_continuous(limits = c(0.25, 0.75)) +
  labs(x = 'Densidad del marcador', y = 'Precisión de la predicción (r)', title = 'Pedigrí uno y 298 individuos genotipados.') +
  theme_bw() +
  theme(
    legend.position = 'none',
    axis.text.y = element_text(face = 'bold', size = 14),
    axis.text.x = element_text(face = 'bold', size = 10),
    axis.title = element_text(face = 'bold', size = 15),
    plot.title = element_text(size = 12.4, face = 'bold'),
    strip.background = element_rect(colour = 'black', fill = 'white'),
    strip.text = element_text(size = 13, colour = 'black', face = 'bold')
    ) +
  geom_label_repel(
    size = 5.4,
    colour = 'black',
    box.padding = 0.7,
    direction = 'y', vjust = 0.4
    )

Resultado_9 <- Resultados_corr %>% # Resultados con el pedigrí 1, con 148 y 0 individuos genotipados, con los dos métodos, y distintas densidades de SNP.
  filter(Pedigrí == 1) %>%
  arrange('Individuos genotipados') %>%
  slice(1, 4, 7, 10, 13, 16, 19, 20) %>%
  ggplot(data = ., aes(x = Densidad, y = Precisión, label = Precisión, colour = Método)) +
  geom_point(size = 4.4, alpha = 0.4) +
  scale_color_manual(values = c('yellow', 'cyan')) +
  scale_fill_manual(values = c('yellow', 'cyan')) +
  scale_y_continuous(limits = c(0.25, 0.75)) +
  facet_wrap(~ Método) +
  scale_y_continuous(limits = c(0.25, 0.75)) +
  labs(x = 'Densidad del marcador', y = 'Precisión de la predicción (r)', title = 'Pedigrí uno y 148 individuos genotipados.') +
  theme_bw() +
  theme(
    legend.position = 'none',
    axis.text.y = element_text(face = 'bold', size = 14),
    axis.text.x = element_text(face = 'bold', size = 10),
    axis.title = element_text(face = 'bold', size = 15),
    plot.title = element_text(size = 12.4, face = 'bold'),
    strip.background = element_rect(colour = 'black', fill = 'white'),
    strip.text = element_text(size = 13, colour = 'black', face = 'bold')
    ) +
  geom_label_repel(
    size = 5.4,
    colour = 'black',
    box.padding = 0.7,
    direction = 'y', vjust = 0.4
    )

Resultado_9 | Resultado_8 | Resultado_7
```

# 24. A continuación se usa el módulo SeqBreed escrito en Python, especificando mediante numerales dentro de los comentarios (<!-- -->) que se hizo.

<!--
1. El modulo SeqBreed requiere que el archivo de genotipos este en formato variant call (VCF), por lo que a continuación se paso de formato plink a VCF siguiendo las instrucciones del tutorial de Genomics Boot Camp (https://www.youtube.com/watch?v=EJDknrHAkXs) y lo que se indica en plink (https://www.cog-genomics.org/plink/1.9/input#vcf).
-->

```{r Paso de formato plink a formato variant call}

dir.create('../Datos/Datos_IND/SeqBreed') # Se crea una carpeta donde se guardaran los archivos generados a partir del uso del módulo SeqBreed. 

dir.create('../Datos/Datos_IND/SeqBreed/plink') # Se crea una carpeta donde se guardaran los archivos resultantes de usar plink. 

# Se extrae del archivo de genotipos (snps.bed) solo los individuos que hacen parte de la población IND ---
plink('--bfile snps --keep Datos_IND/Ind_IND.txt --make-bed --out Datos_IND/SeqBreed/plink/Ind_IND')

# Se filtra el archivo de genotipos anterior (Ind_IND.bed) para eliminar los SNPs con MAF < 5% ----
plink('--bfile Datos_IND/SeqBreed/plink/Ind_IND --maf 0.05 --make-bed --out Datos_IND/SeqBreed/plink/frec_0.05_IND') # De este procedimiento, quedan 100231 SNPs de 451 individuos.

# Se obtuvo un archivo con solo 1.000 SNPs (archivo de prueba) para usar y ver si el anáisis inicial con el módulo SeqBreed no saca algún error ----
#plink('--bfile Datos_IND/SeqBreed/plink/frec_0.05_IND --thin 0.009976953 --make-bed --out Datos_IND/SeqBreed/plink/nSPNs_IND') # De este procedimiento, quedan 965 SNPs de 451 individuos.

# Se pasa el archivo de genotipos de formato plink a VCF ----
plink('--bfile Datos_IND/SeqBreed/plink/frec_0.05_IND --recode vcf --keep-allele-order --out Datos_IND/SeqBreed/plink/vcf_IND') # Nota: por lo general, al pasar a un formato VCF, plink genera dos columnas (A1 y A2) donde estaran los alelos. De forma predeterminada, plink coloca el alelo más frecuente en la población (o alelo de referencia) en la columna A2, incluso cuando pueden ser los menos frecuentes. Una opción para evitar esto si se quiere mantener el estado de referencia intacto o mantener la configuración original de los alelos A1 y A2 consistio en usar la instrucción --keep-allele-order (más información aquí https://www.cog-genomics.org/plink/1.9/data#ax_allele).
```

<!--
2. Para usar el módulo SeqBreed que esta escrito en Python desde R, usare el paquete reticulate de R. Luego, como se observa en el fragmento a continuación, uso el entorno conda (indicando la ruta donde reside la carpeta de Python) como la versión de Python que quiero usar. Para ver como usar Python en R, me base en estos dos tutoriales https://medium.com/save-the-data/how-to-use-python-in-r-with-reticulate-and-conda-36685534f06a y (https://anderfernandez.com/blog/reticulate-usar-python-en-r/).

Para instalar el módulo SeqBreed, clone el repositorio ejecutando "git clone https://github.com/miguelperezenciso/SeqBreed.git". Luego dentro de la carpeta clonada mediante el uso de la terminal ejecute "pip3 install --user SeqBreed-**0.1-py3-none-any**.whl", siendo la instalacción satisfactoria: Successfully installed SeqBreed-0.1. Luego, para saber si el módulo fue instalado se uso "python -m pip show SeqBreed", lo cual mostró información sobre el módulo, por lo cual si está instalado (puesto que si no mostrara nada el módulo no se encontraría instalado). También existe siguiente opción:

$ python -c "import os"
$ echo $?
0 # Si da cero al escribir en la terminal, significa que si esta instalado el módulo. Si da uno, es que no esta instalado.
-->

```{r Carga del paquete reticulate para usar Python en R y de otros paquetes de interés}

pacman::p_load(reticulate, dplyr, qqman, here, readr, tibble, tidyr, ggplot2, ggrepel, genio, BEDMatrix)

use_condaenv(conda = '/home/leo/anaconda3/bin/python') # Se uso el entorno conda (indicando la ruta donde reside la carpeta de Python), como la versión de Python que se quiere usar.

conda_install(packages = c('scipy', 'numpy', 'pandas', 'os', 'sys', 'gzip', 'pepinillo', 'matplotlib', 'scikit-learn', 'statsmodels', 'marinero', 'cython')) # Se instalaron los paquetes de Python necesarios para correr el módulo SeqBreed.
```

<!--
3. Como se observa a continuación, para indicarle al fragmento de Rmarkdown que use Python en vez de R debi abrir el fragmento usando {python} en lugar de {r}. Luego se cargan los módulos necesarios para el análisis. 
-->

```{python Carga de módulos de Python}

# Se cargan algunos módulos de Python necesarios para el análisis:
import sys
import os
#'os' in sys.modules # Se usa sys.modules para saber si el modulo "os" esta instalado.
import pickle

# Para acceder al módulo SeqBreed, se debe incluir lo siguiente:
from SeqBreed import genome as gg
from SeqBreed.selection import selection as sel
```

<!--
4. A continuación, se indica la ubicación donde se encuentran los archivos de entrada necesarios para usar el módulo SeqBreed, y se indica también la ubicación del directorio de trabajo (la carpeta SeqBreed).
-->

```{python Directorios de trabajo y de archivos}

dir_trabajo = os.getcwd()
print(dir_trabajo) # Aquí se puede observar que el directorio de trabajo raíz es la carpeta en la que opera el código de Python.

os.chdir('/home/leo/Escritorio/github/Repo_TFM/Datos/Datos_IND') # Con el método os.chdir() del módulo os, se cambia el directorio de trabajo raíz por el que se indica aquí.

dir_ar = os.getcwd() + '/SeqBreed/plink' # Se indica aquí la ubicación donde se encuentran los archivos de entrada (el archivo en formato VCF).
dir_tr = os.getcwd() + '/SeqBreed' # Se indica aquí la ubicación del que sera mi directorio de trabajo.
```

<!--
5. Usando el comando gg.GFounder(), se genera a continuación un archivo que contiene el genotipo y la posición de los SNPs de la población base de IND.
-->

```{python Creación del archivo con la posición de los SNPs de la población base}

vcf_IND = dir_ar + '/vcf_IND.vcf'
print(vcf_IND) # Se indica aquí el nombre del archivo en formato VCF (el cual se encuentra en el objeto dir_ar anteriormente especificado), con el fin de que a continuación el comando gg.GFounder() realice el análisis sobre este archivo.

SNPs_pos = 'SNPs_pos' # Se indica aquí el nombre del archivo que contendra la información sobre la posición de los SNPs.

# Se genera el archivo que contiene la posición de los SNPs (llamado SNPs_pos), generando de esta forma los genotipos de la población base:
os.chdir(dir_tr) # Se indica aquí el cambio hacia el directorio de trabajo, porque si no fuera así el archivo generado a continuación se guardaria en el directorio de trabajo raíz (dentro de la carpeta de Codigo). 
Gen_Pob_base = gg.GFounder(vcfFile = vcf_IND, snpFile = SNPs_pos)

pickle.dump(Gen_Pob_base, open('Gen_Pob_base', 'wb')) # El archivo generado anteriormente (Gen_Pob_base) se guarda aquí como un "archivo pickle", esto es, un archivo donde se almacena el resultado para que sea utilizado más adelante. wb hace referncia a que con "w" se escribira en el archivo Gen_Pob_base, y "b" se refiere a modo binario.
```

<!--
6. A continuación se genera un objeto usando el comando gg.Genome(), el cual contendra el nombre de los cromosomas y otras característica del genoma de interés.
-->

```{python Creación del objeto con caracteristicas del genoma}

os.chdir(dir_tr) # Se indica aquí el cambio hacia el directorio de trabajo, que es donde estan los archivos anteriormente generados y guardados.

SNPs_pos = 'SNPs_pos' # Se crea el objeto "SNPs_pos", que corresponde al archivo generado anteriormente con la posición de los SNPs.

Gen_Pob_base = pickle.load(open('Gen_Pob_base', 'rb')) # Se carga el archivo generado anteriormente "Gen_pob_base", que corresponde al genotipo de la población base. rb hace referencia a que se cargara el archivo en modo lectura ("r"), y en modo binario ("b").

Gen_caracteristicas = gg.Genome(snpFile = SNPs_pos, mapFile = None, ploidy = Gen_Pob_base.ploidy,  XChr = 'X', YChr = 'Y', MTChr = 'MT')

Gen_caracteristicas.print()
```

<!--
7. Se realiza a continuación un GWAS.
-->

```{r Se hace un GWAS usando GCTA}

dir.create('../Datos/Datos_IND/SeqBreed/GWAS') # Se crea una carpeta donde se guardaran los archivos resultantes al hacer un GWAS. 

# Se usa plink para incluir solo los genotipos de los autosomas y crear una matriz de parentesco molecular a partir del fichero de marcadores ----

setwd('/home/leo/Escritorio/github/Repo_TFM/Datos/') # Se selecciona la carpeta donde estan los datos.

plink <- function(PLINKopciones = '') system(paste('/home/leo/Escritorio/github/Repo_TFM/plink', PLINKopciones)) # Se escribe una función que permite ejecutar plink en R de forma sencilla.

plink('--bfile Datos_IND/SeqBreed/plink/frec_0.05_IND --autosome --make-grm-bin --out Datos_IND/SeqBreed/GWAS/gwas_IND') # Nota: no debe haber una estructura familiar (parecido entre parientes) debido a que se pueden generar asociaciones falsas en el GWAS. Se debe corregir por tanto. Una forma es introducir la información de pedigrí, o usando la información de los marcadores de los cuales se genera una matriz de parentesco molecular (esto se estima usado la información molecular, esto es, de los autosomas).

# Se crea el archivo de datos que contendra el fenotipo (tiempo de floración) que se analizara mediante el GWAS ----

Fenotipos <- read_delim(here('Datos', 'all.phenotypes.csv'), delim = ',') # Se importa el archivo de fenotipos.

Fen_IND <- Fenotipos %>%
  filter(SNPsubsp == 'IND') %>% # Conjunto de datos solo con la especie IND.
  separate(
    col = Variety,
    into =  c('Columna_1', 'Columna_2'),
    sep  =  ' '
  ) %>%
  unite(
    col = Variety,
    sep = '_',
    Columna_1:Columna_2
  ) %>%
  select(Variety, Time.to.flowering..from.sowing) %>% # Se seleccionaron las columnas que contienen la información sobre el nombre de la variedad y la medida fenotípica.
  mutate(id = Variety) %>% # Se creo una columna de "id".
  relocate(
    Time.to.flowering..from.sowing,
    .after = id
    ) %>%
  write_tsv(here('Datos', 'Datos_IND', 'SeqBreed', 'GWAS', 'Feno_IND.txt'), col_names = FALSE)

# Se usa GCTA para hacer el GWAS y así identificar que regiones genómicas estan asociadas con el fenotipo tiempo de floración ----

setwd('/home/leo/Escritorio/github/Repo_TFM/Datos/') # Se selecciona la carpeta donde estan los datos.

gcta <- function(GCTAopciones = '') system(paste('/home/leo/Escritorio/github/Repo_TFM/gcta', GCTAopciones)) # Se escribe una función que permite ejecutar gcta en R de forma sencilla.

gcta('--mlma --bfile Datos_IND/SeqBreed/plink/frec_0.05_IND --pheno Datos_IND/SeqBreed/GWAS/Feno_IND.txt --out Datos_IND/SeqBreed/GWAS/gwas_IND_LD') # Aquí, se utiliza la función MLMA del programa GCTA para hacer el GWAS. En caso de que se deseara corregir por la matriz de parentesco molecular creada anteriormente usando plink, se usa la función --grm: --grm Datos_IND/SeqBreed/GWAS/gwas_IND.

# Se visualiza los resultados del GWAS anterior mendiante un gráfico de Manhattan, usando como referencia lo presentado aquí https://www.r-graph-gallery.com/101_Manhattan_plot.html y aquí https://slowkow.com/notes/ggplot2-qqplot/ ----

res_GWAS <- read_delim(here('Datos', 'Datos_IND', 'SeqBreed', 'GWAS', 'gwas_IND_LD.mlma')) # Se importa el archivo con los resultados del GWAS.

manhattan(x = res_GWAS, chr = 'Chr', bp = 'bp', snp = 'SNP', p = 'p', suggestiveline = FALSE, genomewideline = FALSE) # Se visualiza los resultados usando la función manhattan() del paquete qqman.

qq(res_GWAS$p)

# Se visualiza los resultados mediante ggplot2 ----

# 1. se calcula la posición acumulada de los SNPs:

vis_GWAS <- res_GWAS %>%
  
  group_by(Chr) %>%
  summarise(Tam_cromosoma = max(bp)) %>% # se calcula el tamaño de los cromosomas.
  
  mutate(Total = cumsum(Tam_cromosoma) - Tam_cromosoma) %>%
  select(-Tam_cromosoma) %>% # Se calcula la posición acumulada de cada cromosoma.
  
  left_join(res_GWAS, ., by = c('Chr' = 'Chr')) %>% # Se adiciona la información anterior al conjunto de datos inicial "res_GWAS".
  
  arrange(Chr, bp) %>%
  mutate(bp_total = bp + Total) # Se adiciona la posición acumulada de cada SNP.

# 2. Se prepara el eje x, debido a que no se quiere mostrar la posición acumulada de los SNPs o bp, sino mostrar el nombre del cromosoma:

eje_x <- vis_GWAS %>%
  group_by(Chr) %>%
  summarise(centro = (max(bp_total) + min(bp_total)) / 2)

# 3. Se hace el gráfico a continuación:

Graf_Manhattan <- ggplot(data = vis_GWAS, aes(x = bp_total, y = -log10(p))) +
  geom_point(aes(colour = as.factor(Chr)), alpha = 0.2, size = 2.4) +
  scale_colour_manual(values = c('cyan', 'green', 'red', 'yellow', 'cyan', 'green', 'red', 'yellow', 'cyan', 'green', 'red', 'yellow')) +
  scale_x_continuous( label = eje_x$Chr, breaks= eje_x$centro ) +
  labs(title = 'A', x = 'Cromosoma', y = '-log10(p)') +
  theme_bw() +
  theme(
    legend.position = 'none',
    axis.text = element_text(size = 14),
    axis.title = element_text(size = 15, face = 'bold'),
    plot.title = element_text(size = 13, face = 'bold')
    ) # Nota: 

gg_qqplot <- function(ps, ci = 0.95) {
  n  <- length(ps)
  df <- data.frame(
    observed = -log10(sort(ps)),
    expected = -log10(ppoints(n)),
    clower   = -log10(qbeta(p = (1 - ci) / 2, shape1 = 1:n, shape2 = n:1)),
    cupper   = -log10(qbeta(p = (1 + ci) / 2, shape1 = 1:n, shape2 = n:1))
  )
  log10Pe <- expression(paste('Expected -log'[10], plain(P)))
  log10Po <- expression(paste('Observed -log'[10], plain(P)))
  ggplot(df) +
    geom_ribbon(
      mapping = aes(x = expected, ymin = clower, ymax = cupper),
      alpha = 0.2, fill = 'yellow'
    ) +
    geom_abline(intercept = 0, slope = 1, alpha = 1.0, size = 1.0) +
    geom_point(aes(expected, observed), colour = 'yellow', alpha = 0.5, size = 2.6) +
    xlab(log10Pe) +
    ylab(log10Po)
  }

Graf_qq <- gg_qqplot(res_GWAS$p) +
  labs(title = 'B', x = '-log10(P) esperado', y = '-log10(P) observado') +
  theme_bw() +
  theme(
    axis.text = element_text(size = 14),
    axis.title = element_text(size = 15, face = 'bold'),
    plot.title = element_text(size = 13, face = 'bold')
    )

Graf_Manhattan | Graf_qq
```

<!--
8. En base al GWAS anterior, se crea a continuación el archivo de QTNs, seleccionando 50 de ellos proporcional a la varianza aditiva explicada.
-->

```{r Se crea el archivo de QTNs}

res_GWAS <- read_delim(here('Datos', 'Datos_IND', 'SeqBreed', 'GWAS', 'gwas_IND_LD.mlma')) # Se importa el archivo con los resultados del GWAS.

# Se muestrearan los QTLs (o QTNs) proporcional a la varianza aditiva explicada (va=2*p*(1-p)*a^2): 

va_GWAS <- res_GWAS %>%
  mutate(
    va = (2)*(Freq)*(1-Freq)*(b)^2, # Aqui se calcula la varianza aditiva explicada por cada locus, en base a la frecuencia alelica (Freq) y el efecto (b).
    cum_va = cumsum(va)
    ) %>%
  pull(cum_va) %>%
  as.matrix()

# Se crea a continuación una instrucción que muestrea de forma aleatoria 50 QTLs (o QTNs) proporconal a la varianza aditiva calculada anteriormente:

nSNPs <- nrow(va_GWAS) # Se indica aquí el número de SNPs, que corresponde al número de filas en "va_GWAS".
nQTLs <- 50 # Se indica aquí la cantidad de QTLs (o QTNs) que se consideraran.
pos <- vector(mode = 'integer', length = nQTLs) # Se crea un objeto (un vector) que contiene ceros con una longitud igual al número de QTLs que se desean seleccionar.

for (iq in seq(nQTLs)) {
  x = runif(n = 1, min = 0, max = va_GWAS[nSNPs]) # Se indica aquí generar un solo número (n = 1) de forma aleatoria dentro del intervalo 0 a 4.223640.
  pos[iq] = 1 + length(va_GWAS[va_GWAS <= x]) # Se llena el objeto anterior "pos", indicando la posición dentro del objeto "va_GWAS" cuyos valores son menor o igual al número anterior generado de forma aleatoria.
  }

# Se seleccionan los QTLs (o QTNs) según la posiciones muestreadas anteriomente: 

QTNs <- res_GWAS %>%
  slice(pos) %>% # Del conjunto de datos resultante al hacer el GWAS, se seleccionan los 50 QTNs elegidos anteriormente.
  select(Chr, bp, b) %>% # Se seleccionan las columnas del cromosoma, posición en pares de bases y efecto.
  arrange(Chr, bp) %>%
  mutate(
    dom = 0.0,
    Chr = as.factor(Chr)
    ) %>% # Se crea una nueva columna con efecto igual a 0 para el efecto dominante.
  write_delim(here('Datos', 'Datos_IND', 'SeqBreed', 'QTNs.txt'), delim = ' ', col_names = FALSE) # Este sería el archivo de QTNs.

# Se visualizan los QTNs anteriormente seleccionados:

res_GWAS %>%
  mutate(Chr = as.factor(Chr)) %>%
  ggplot(data = ., aes(x = Chr, y = bp, label = SNP)) +
  geom_point(colour = 'cyan', fill = 'cyan', alpha = 0.4, size = 1.4) +
  #geom_point(data = QTNs, aes(x = Chr, y = bp), colour = 'black', fill = 'white', alpha = 0.6, size = 3.0) +
  labs(x = 'Cromosomas', y = 'Posición (pb)') +
  theme_bw() +
  theme(
    axis.text = element_text(size = 14, face = 'bold'),
    axis.title = element_text(size = 15, face = 'bold')
    ) +
  geom_label_repel(
    size = 5.4,
    colour = 'black',
    box.padding = 0.7
    )
```

<!--
9. A continuación, se especifica la posición de los QTNs, sus efectos y la heredabilidad asumida. Luego se calcula las varianzas aditivas y dominantes por locus suponiendo equilibrio.
-->

```{python Se genera el archivo de QTNs que se usara en el SeqBreed}

os.chdir(dir_tr) # Se indica aquí el cambio hacia el directorio de trabajo, que es donde estan los archivos anteriormente generados y guardados.

QTNs = 'QTNs.txt' # Se crea el objeto "QTNs", que corresponde al archivo generado anteriormente con el cromosoma, la prosición y el efecto de los 50 QTNs seleccionados.

QTN = gg.QTNs(h2 = [0.7], genome = Gen_caracteristicas, qtnFile = QTNs) # Se especifica la posición de los QTNs, sus efectos y se asume una heredabilidad de 0.7.

QTN.get_var(Gen_caracteristicas, Gen_Pob_base) # Se calcula las varianzas aditivas y dominantes para cada locus.
QTN.print(Gen_caracteristicas) # Aquí se observa el cromosoma, su posición, la fecuencia alelica, el efecto aditivo, el efecto dominante, la varianza aditiva y la varianza dominante.
QTN.plot() # Aquí se observa la varianza en función de la frecuencia y la distribución de la varianza para los efectos aditivos y dominantes.
```

<!--
10. Se generan varios pedigríes especificando el número de individuos de la generación 0 (o población base) que se quisieran cruzar y el número de hijos en la generación 2 que cada individuo por autofecundación tendría.
-->

```{r Generación del pedigrí}

###########
# Pedigrí 1
###########

dir.create('../Datos/Datos_IND/SeqBreed/Pedigri_1') # Se crea el directorio de trabajo donde se guardaran los archivos y resultados que obtengan del primer pedigrí.

# Población fundadora (F0) ----

Pob_fun <- tibble(
  id = 1:451,
  Prog1 = rep(x = 0, times = 451),
  Prog2 = rep(x = 0, times = 451)#,
  #Gen = 0
  ) # 451 individuos hacen parte de la población fundadora (estos serían todos los individuos IND).

# Generación F1 ----

fun_F1 <- function(x){
  Pob_fun %>%
    select(id) %>%
    sample_n(2) %>%
    mutate(Relacion = c('Prog1', 'Prog2')) %>%
    pivot_wider(
      names_from = Relacion,
      values_from = id
    )
  }

F1 <- replicate(n = 40, fun_F1(), simplify = FALSE) # Con replicate se indicaria el número de cruces por cada pareja.

F1 <- plyr::ldply(F1, tibble) %>% # Con la función ldply() indico que los elementos de la lista anterior los devuelva como un conjunto de datos.
  mutate(
    id = 452:491#,
    #Gen = 1
    ) # En la F1 se tendria un total de 40 individuos como resultado de los 40 cruces en la F0.
  
# Generación F2 ----

F2 <- F1 %>%
  select(id) %>%
  dplyr::rename(Prog1 = id) %>%
  mutate(Prog2 = Prog1) %>%
  mutate(count = 20) %>% # Se indica aquí la frecuencia con la que se debe repetir una fila (al ser 20, cada fila se repetiria 20 veces, sin embargo también es posible indica por ejemplo c(2, 3), es decir, la fila 1 repetedia 2 veces y la fila 2 repetida 3 veces).
  uncount(count) %>%
  mutate(
    id = 492:1291#,
    #Gen = 2
  ) # Este correspondería a 20 descencientes para cada uno de los 40 individuos (id) de la F1, dando un total de 800 individuos.

# Generación F3 ----

F3 <- F2 %>%
  select(id) %>%
  dplyr::rename(Prog1 = id) %>%
  mutate(
    Prog2 = Prog1,
    id = 1292:2091#,
    #Gen = 3
    )# Este correspondería a un solo descenciente para cada uno de los 800 individuos (id) de la F2, dando un total de 800 individuos.

# Población total ----

Ped_1 <- bind_rows(Pob_fun, F1, F2, F3) %>% # Aquí se juntan todas las generaciones anteriores (F0, F1, F2 y F3).
  write_delim(here('Datos', 'Datos_IND', 'SeqBreed', 'Pedigri_1', 'Pedigri_1.txt'), delim = ' ', col_names = FALSE) # Se guarda el archivo que contiene el pedigrí 1.

###########
# Pedigrí 2
###########

dir.create('../Datos/Datos_IND/SeqBreed/Pedigri_2') # Se crea el directorio de trabajo donde se guardaran los archivos y resultados que obtengan del segundo pedigrí.

# Generación F1 ----

F1_2 <- replicate(n = 20, fun_F1(), simplify = FALSE) # Con replicate se indicaria el número de cruces por cada pareja.

F1_2 <- plyr::ldply(F1_2, tibble) %>% # Con la función ldply() indico que los elementos de la lista anterior los devuelva como un conjunto de datos.
  mutate(
    id = 452:471#,
    #Gen = 1
    ) # En la F1 se tendria un total de 20 individuos como resultado de los 20 cruces en la F0.
  
# Generación F2 ----

F2_2 <- F1_2 %>%
  select(id) %>%
  dplyr::rename(Prog1 = id) %>%
  mutate(Prog2 = Prog1) %>%
  mutate(count = 40) %>%
  uncount(count) %>%
  mutate(
    id = 472:1271#,
    #Gen = 2
  ) # Este correspondería a 40 descencientes para cada uno de los 20 individuos (id) de la F1, dando un total de 800 individuos.

# Generación F3 ----

F3_2 <- F2_2 %>%
  select(id) %>%
  dplyr::rename(Prog1 = id) %>%
  mutate(
    Prog2 = Prog1,
    id = 1272:2071#,
    #Gen = 3
    )# Este correspondería a un solo descenciente para cada uno de los 800 individuos (id) de la F2, dando un total de 800 individuos.

# Población total ----

Ped_2 <- bind_rows(Pob_fun, F1_2, F2_2, F3_2) %>% # Aquí se juntan todas las generaciones anteriores (F0, F1, F2 y F3).
  write_delim(here('Datos', 'Datos_IND', 'SeqBreed', 'Pedigri_2', 'Pedigri_2.txt'), delim = ' ', col_names = FALSE) # Se guarda el archivo que contiene el pedigrí 2.

###########
# Pedigrí 3
###########

dir.create('../Datos/Datos_IND/SeqBreed/Pedigri_3') # Se crea el directorio de trabajo donde se guardaran los archivos y resultados que obtengan del segundo pedigrí.

# Generación F1 ----

F1_3 <- replicate(n = 10, fun_F1(), simplify = FALSE) # Con replicate se indicaria el número de cruces por cada pareja.

F1_3 <- plyr::ldply(F1_3, tibble) %>% # Con la función ldply() indico que los elementos de la lista anterior los devuelva como un conjunto de datos.
  mutate(
    id = 452:461#,
    #Gen = 1
    ) # En la F1 se tendria un total de 10 individuos como resultado de los 10 cruces en la F0.
  
# Generación F2 ----

F2_3 <- F1_3 %>%
  select(id) %>%
  dplyr::rename(Prog1 = id) %>%
  mutate(Prog2 = Prog1) %>%
  mutate(count = 80) %>%
  uncount(count) %>%
  mutate(
    id = 462:1261#,
    #Gen = 2
  ) # Este correspondería a 80 descencientes para cada uno de los 10 individuos (id) de la F1, dando un total de 800 individuos.

# Generación F3 ----

F3_3 <- F2_3 %>%
  select(id) %>%
  dplyr::rename(Prog1 = id) %>%
  mutate(
    Prog2 = Prog1,
    id = 1262:2061#,
    #Gen = 3
    )# Este correspondería a un solo descenciente para cada uno de los 800 individuos (id) de la F2, dando un total de 800 individuos.

# Población total ----

Ped_3 <- bind_rows(Pob_fun, F1_3, F2_3, F3_3) %>% # Aquí se juntan todas las generaciones anteriores (F0, F1, F2 y F3).
  write_delim(here('Datos', 'Datos_IND', 'SeqBreed', 'Pedigri_3', 'Pedigri_3.txt'), delim = ' ', col_names = FALSE) # Se guarda el archivo que contiene el pedigrí 1.

###########
# Pedigrí 4
###########

dir.create('../Datos/Datos_IND/SeqBreed/Pedigri_4') # Se crea el directorio de trabajo donde se guardaran los archivos y resultados que obtengan del segundo pedigrí.

# Generación F1 ----

F1_4 <- replicate(n = 80, fun_F1(), simplify = FALSE) # Con replicate se indicaria el número de cruces por cada pareja.

F1_4 <- plyr::ldply(F1_4, tibble) %>% # Con la función ldply() indico que los elementos de la lista anterior los devuelva como un conjunto de datos.
  mutate(
    id = 452:531#,
    #Gen = 1
    ) # En la F1 se tendria un total de 80 individuos como resultado de los 80 cruces en la F0.
  
# Generación F2 ----

F2_4 <- F1_4 %>%
  select(id) %>%
  dplyr::rename(Prog1 = id) %>%
  mutate(Prog2 = Prog1) %>%
  mutate(count = 10) %>%
  uncount(count) %>%
  mutate(
    id = 532:1331#,
    #Gen = 2
  ) # Este correspondería a 10 descencientes para cada uno de los 80 individuos (id) de la F1, dando un total de 800 individuos.

# Generación F3 ----

F3_4 <- F2_4 %>%
  select(id) %>%
  dplyr::rename(Prog1 = id) %>%
  mutate(
    Prog2 = Prog1,
    id = 1332:2131#,
    #Gen = 3
    )# Este correspondería a un solo descenciente para cada uno de los 800 individuos (id) de la F2, dando un total de 800 individuos.

# Población total ----

Ped_4 <- bind_rows(Pob_fun, F1_4, F2_4, F3_4) %>% # Aquí se juntan todas las generaciones anteriores (F0, F1, F2 y F3).
  write_delim(here('Datos', 'Datos_IND', 'SeqBreed', 'Pedigri_4', 'Pedigri_4.txt'), delim = ' ', col_names = FALSE) # Se guarda el archivo que contiene el pedigrí 4.
```

<!--
11. 
-->

```{python}

os.chdir(dir_tr) # Se indica aquí el cambio hacia el directorio de trabajo, que es donde estan los archivos de pedigríes.

Gen_Pob_base = pickle.load(open('Gen_Pob_base', 'rb')) # Se carga el archivo generado anteriormente "Gen_pob_base", que corresponde al genotipo de la población base.

###########
# Pedigrí 1
###########

Pedigri_1 = 'Pedigri_1/Pedigri_1.txt' # Se crea el objeto "Pedigri_1", que corresponde al pedigrí 1 generado anteriormente.

Pob_1 = gg.Population(Gen_caracteristicas, pedFile = Pedigri_1, generation = None, qtns = QTN, gfounders = Gen_Pob_base)
#print('No. of individuals is ' + str(len(pop.inds)))

pickle.dump(Pob, open('Pob_1', 'wb'))

###########
# Pedigrí 2
###########

Pedigri_2 = 'Pedigri_2/Pedigri_2.txt' # Se crea el objeto "Pedigri_2", que corresponde al pedigrí 2 generado anteriormente.

Pob_2 = gg.Population(Gen_caracteristicas, pedFile = Pedigri_2, generation = None, qtns = QTN, gfounders = Gen_Pob_base)
#print('No. of individuals is ' + str(len(pop.inds)))

pickle.dump(Pob, open('Pob_2', 'wb'))

###########
# Pedigrí 3
###########

Pedigri_3 = 'Pedigri_3/Pedigri_3.txt' # Se crea el objeto "Pedigri_2", que corresponde al pedigrí 2 generado anteriormente.

Pob_3 = gg.Population(Gen_caracteristicas, pedFile = Pedigri_3, generation = None, qtns = QTN, gfounders = Gen_Pob_base)
#print('No. of individuals is ' + str(len(pop.inds)))

pickle.dump(Pob, open('Pob_3', 'wb'))

###########
# Pedigrí 4
###########

Pedigri_4 = 'Pedigri_4/Pedigri_4.txt' # Se crea el objeto "Pedigri_2", que corresponde al pedigrí 2 generado anteriormente.

Pob_4 = gg.Population(Gen_caracteristicas, pedFile = Pedigri_4, generation = None, qtns = QTN, gfounders = Gen_Pob_base)
#print('No. of individuals is ' + str(len(pop.inds)))

pickle.dump(Pob, open('Pob_4', 'wb'))
```

<!--
12. Se crea a continuación tres archivos de texto indicando la densidad de SNPs (100.000, 10.000 y 1.000).
-->

```{r Densidades de SNPs en SeqBreed}

# Densidad de 100.000 SNPs ----

chip_100.000 <- read_table(here('Datos', 'Datos_IND', 'SeqBreed', 'plink', 'frec_0.05_IND.bim'), col_names = FALSE) %>%
  select(X1, X4) %>%
  write_tsv(here('Datos', 'Datos_IND', 'SeqBreed', 'chip_3.txt'), col_names = FALSE) # Este conjunto de datos se usara luego para indicar la densidad del chip en 100.000 SNPs. La primera columna es el cromosoma y la segunda columna es la posición del SNP.

# Densidad de 10.000 SNPs ----

chip_10.000 <- read_table(here('Datos', 'Datos_IND', 'Den_10.000', 'mG', 'mG_3', 'nSNPs_IND.bim'), col_names = FALSE) %>%
  select(X1, X4) %>%
  write_tsv(here('Datos', 'Datos_IND', 'SeqBreed', 'chip_2.txt'), col_names = FALSE) # Este conjunto de datos se usara luego para indicar la densidad del chip en 10.000 SNPs. La primera columna es el cromosoma y la segunda columna es la posición del SNP.

# Densidad de 10.000 SNPs ----

chip_1.000 <- read_table(here('Datos', 'Datos_IND', 'Den_1.000', 'mG', 'mG_3', 'nSNPs_IND.bim'), col_names = FALSE) %>%
  select(X1, X4) %>%
  write_tsv(here('Datos', 'Datos_IND', 'SeqBreed', 'chip_1.txt'), col_names = FALSE) # Este conjunto de datos se usara luego para indicar la densidad del chip en 1.000 SNPs. La primera columna es el cromosoma y la segunda columna es la posición del SNP.
```

<!--
13.
-->

```{python}

os.chdir(dir_tr) # Se indica aquí el cambio hacia el directorio de trabajo, que es donde estan los archivos de SNPs.

# 1. Se genera a continuación el objeto "chip", ya que este variara en el análisis de acuerdo a 1.000, 10.000 y 100.000 SNPs ----

SNPs_pos = 'SNPs_pos' # Se crea el objeto "SNPs_pos", que corresponde al archivo generado en pasos atras con la posición de los SNPs.

den_chips = [dir_tr + '/chip_1.txt', dir_tr + '/chip_2.txt', dir_tr + '/chip_3.txt', SNPs_pos] # Se crea aquí una lista con las distintas densidades de SNPs (1.000, 10.000 y 100.000 SNPs).

chips = []
for file in den_chips:
    chip = gg.Chip(chipFile = file, genome = Gen_caracteristicas, name = file+'_chip')
    chips.append(chip) # Se genera aquí el objeto "chip" a partir de la lista anterior de posiciones predefinidas.

for chip in chips:
    chip.print(Gen_caracteristicas) # Se imprime lo anterior para ver si se genero el objeto "chip" bien, y si lo genero bien ya que se observa la información correcta de densidad de SNPs para cada chip (chip_1 = 960, chip_2 = 9843 y chip_3 = 100231).

# 2. 

#Pob_1 = pickle.load(open('Pob_1', 'rb')) # Se carga el archivo generado en pasos atras "Pob_1", que corresponde a... del pedigrí 1.

#print('Num. de individuos es '+str(len(Pob_1.inds))) # Se prueba si carga bien indicando el número de individuos en el pedigrí que es de 2091.
```

